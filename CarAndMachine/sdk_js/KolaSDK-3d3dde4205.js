!function(){class t{constructor(){this.id="",this.showCount=0,this.clickCount=0}}class e{constructor(){this.showCounts=null,this.showTimes=null,this.startShowTimes=null}}class s{constructor(t,e,s){this.forbitCountries_=t,this.forbitProvinces_=e,this.forbitCities_=s}get forbitCountries(){return this.forbitCountries_}get forbitProvinces(){return this.forbitProvinces_}get forbitCities(){return this.forbitCities_}get hasFilterInfo(){return this.forbitCountries&&this.forbitCountries.length>0||this.forbitProvinces&&this.forbitProvinces.length>0||this.forbitCities&&this.forbitCities.length>0}IsInAry(t,e){if(!t||!e)return!1;if(0==(t=t.trim()).length)return!1;for(let s=0;s<e.length;s++){const i=e[s];if(i&&t.includes(i))return!0}return!1}IsInForbitArea(t,e,s){return!!(this.IsInAry(t,this.forbitCountries)||t&&t.length>0&&"中国"!=t&&this.IsInAry("海外",this.forbitCountries)||this.IsInAry(e,this.forbitProvinces)||this.IsInAry(s,this.forbitCities))}}class i{constructor(){this.setting=null,this.version=null,this.shareConfigs=[],this.adConfig={inuseNames:[],cfgList:[]},this.appConfigs=[],this.forbitTimeRange=null,this.shareAreaForbit=null,this.payAreaForbit=null,this.wdlbAreaForbit=null}Get(t,e=0){if(null==this.setting)return e;let s=null,i=this.setting[this.version];return i&&(s=i[t]),null==s&&(s=this.setting[t]),null==s?e:s}IsInForbitTime(t){if(null==this.forbitTimeRange||4!=this.forbitTimeRange.length)return!0;let e=this.forbitTimeRange[0],s=this.forbitTimeRange[1],i=this.forbitTimeRange[2],n=this.forbitTimeRange[3],l=new Date(Date.now());l.setHours(e,s);let o=new Date(Date.now());o.setHours(i,n);let r=t.getTime(),a=l.getTime(),h=o.getTime();return r>=a&&r<=h}get hasAnyAreaForbitInfo(){return!(null==this.shareAreaForbit||!this.shareAreaForbit.hasFilterInfo)||!(null==this.payAreaForbit||!this.payAreaForbit.hasFilterInfo)||!(null==this.wdlbAreaForbit||!this.wdlbAreaForbit.hasFilterInfo)}ParseData(t){this.setting=t;let e=this.setting[this.version];if(e)for(let t in e)this.setting[t]=e[t];let i=this.Get("share",[]);for(let t=i.length-1;t>=0;t--)0==i[t].inuse&&i.splice(t,1);if(this.shareConfigs=i,this.isShowAppstore){this.appConfigs=this.Get("apps",[]);for(let t=this.appConfigs.length-1;t>=0;t--)0==this.appConfigs[t].inuse&&this.appConfigs.splice(t,1)}else this.appConfigs=[];let n=this.Get("noShareFilters",null);n&&(this.shareAreaForbit=new s(n.countries?n.countries.split("|"):[],n.provinces?n.provinces.split("|"):[],n.cities?n.cities.split("|"):[]));let l=this.Get("noChargeFilters",null);l&&(this.payAreaForbit=new s(l.countries?l.countries.split("|"):[],l.provinces?l.provinces.split("|"):[],l.cities?l.cities.split("|"):[]));let o=this.Get("noGiftFilters",null);o&&(this.wdlbAreaForbit=new s(o.countries?o.countries.split("|"):[],o.provinces?o.provinces.split("|"):[],o.cities?o.cities.split("|"):[])),this.forbitTimeRange=this.Get("forbitTimeRange",null);let r=this.Get("ad",null);if(r){let t=(t,e)=>{if(null==t)return null;for(let s=0;s<t.length;s++){const i=t[s];if(i.name==e)return i}};if(r.cfgList=[],r.inuseNames)for(let e=0;e<r.inuseNames.length;e++){const s=r.inuseNames[e];let i=t(r.otherConfigs,s),n=null!=t(r.cfgList,s);i&&!n&&r.cfgList.push(i)}0==r.cfgList.length&&r.cfgList.push({name:r.name,appId:r.appId,bannerIds:r.bannerIds,videoIds:r.videoIds,videoDurations:r.videoDurations,screenId:r.screenId,nativeIds:r.nativeIds,blockIds:r.blockIds,appboxIds:r.appboxIds,gameBannerIds:r.gameBannerIds}),this.adConfig=r}}Request(t,e,s,i,n){let l=e+t.gameId+"/remote_setting.json";l+="?time="+Date.now(),t.httpGet(l,t=>{try{let e=JSON.parse(t);1==n&&this.ParseData(e),s&&s(e)}catch(t){i&&i(t)}},t=>{i&&i(t)})}}window.KolaSDK=new class{constructor(){this.MaxLevelTime=1800,this.abTestData=null,this.appConfigs=null,this.logDbName=null,this.gameId=null,this.channel=null,this.userId=null,this.platformName=null,this.deviceModel=null,this.sysInfo=null,this.logUrl=null,this.remoteSettingUrl=null,this.remoteSetting=new i}OnHide(){if(this.Logout_(),this.levelStartTime>0){let t=Date.now();this.levelTotalTime=t-this.levelStartTime}this.OnNativeAdHide_(),this.OnAppAnalysHide_()}OnShow(t){this.Login_(t),this.levelStartTime>0&&(this.levelStartTime=Date.now())}Initialize(t,e,s,i=null,n=null,l=null,o=null,r=null){this.logDbName=null!=n?n:"kgameslog",this.gameId=s+"_"+this.ToPlatformName(t),this.platformName=e,this.deviceModel=i,this.logUrl=l,this.remoteSettingUrl=o,this.sysInfo=r,this.levelTotalTime=0,this.levelStartTime=0,this.levelStartIndex=null,this.lastLoginTime=null,this.HttpTimeout=15e3,this.sceneAllAdDatas=null,this.adLoadCount=0,this.sceneAllAppDatas=null}LoadRemoteSetting(t,e,s){this.remoteSetting.Request(this,this.remoteSettingUrl,e=>{this.appConfigs=this.remoteSetting.appConfigs,t&&t(e)},e,s)}LogEvent(t,e=null,s=null,i=null){this.LogEvent_(t,e,s,i)}LogPay(t,e,s){let i={name:t.name,id:t.id,orderId:t.orderId,price:t.price,number:t.number,channel:e,platform:this.platformName},n=this.sysInfo;n&&(i.OS=n.OS,i.OAID=n.OAID,i.ANDROIDID=n.ANDROIDID,i.IDFA=n.IDFA,i.MAC=n.MAC,i.IMEI=n.IMEI),this.LogEvent("Pay",i,s)}LogStartLevel(t,e=null){this.levelStartTime>0&&console.warn("不要多次调用LogStartLevel，或者调用LogStartLevel之后必须调用LogFinishLevel结束关卡"),this.levelStartTime=Date.now(),this.levelTotalTime=0,this.levelStartIndex=t,this.LogEvent_("StartLevel",null,t,0,e?{property:e}:null)}LogFinishLevel(t,e){let s=this.levelStartTime,i=this.levelTotalTime;if(this.levelStartTime=0,this.levelTotalTime=0,s<=0)return void console.warn("调用LogFinishLevel之前，必须先调用LogStartLevel");if(this.levelStartIndex!=t)return void console.warn("LogStartLevel跟LogFinishLevel调用的levelIndex参数不一致！分别是：",this.levelStartIndex,t);let n=Math.ceil(.001*(i+Date.now()-s));n>this.MaxLevelTime?console.warn("LogFinishLevel失败！关卡时长超出限制，可以在this.MaxLevelTime中设置最大值！"):this.LogEvent("FinishLevel",{useTime:n,win:e},t)}LogUseItem(t,e,s,i){this.LogEvent("UseItem",{scene:t,itemId:s,value:i},e)}LogGetItem(t,e,s,i){this.LogEvent("GetItem",{scene:t,itemId:s,value:i},e)}LogShare(t,e,s,i,n,l=null,o=null){this.LogEvent("ShareTo",{scene:t,suc:e,id:i,sharerName:n,videoId:l,klVidelId:o},s,3)}LogPlayVideoAd(t,e,s){this.LogEvent("PlayVideoAd",{scene:t,finish:e},s)}OnNativeAdLoaded(){this.adLoadCount++}OnNativeAdShow(t,e){this.GetNativeAdData(t,e).showCount++}OnNativeAdClick(t,e){this.GetNativeAdData(t,e).clickCount++}OnAppIconShow(t,e,s){if(!this.appConfigs)return;let i=this.GetIndexOfApp(e),n=this.GetAllAppDatas(t)[i];n.showCounts[s]++,n.startShowTimes[s]=Date.now()}OnAppIconHide(t,e,s){if(!this.appConfigs)return;let i=this.GetIndexOfApp(e),n=this.GetAllAppDatas(t)[i],l=Date.now()-n.startShowTimes[s];l>86400||l<=0||(n.showTimes[s]+=.001*l,n.startShowTimes[s]=Date.now())}OnNavigateToApp(t,e,s,i){this.appConfigs&&this.LogEvent("NavigateToApp",{scene:t,name:s.name,appId:s.appId,result:e,adIconId:s.icons?s.icons[i].adIconId:s.adIconId,qrCode:null==s.appId})}ToPlatformName(t){switch(t){case 0:return"WeXin";case 1:return"Oppo";case 2:return"";case 4:return"VivoQucikGame";case 7:return"TouTiao";case 8:return"QQ";case 9:return"Baidu";case 10:return"H5_4399";case 11:return"Hago";case 12:return"UC";case 13:return"Bilibili";case 15:return"Meizu";case 16:return"Empty";case 17:return"Gamebox4399";case 29:return"Android";case 30:return"AndroidOppo"}}LogEvent_(t,e,s=null,i=null,n=null,l=null){let o=this.userId?this.userId:"Unknown";this.LogEvent__(this.logDbName,o,t,e,s,i,n,l)}LogEvent__(t,e,s,i,n=null,l=null,o=null,r=null){i||(i={}),1!=r&&(i.channelId=null!=this.channel?this.channel:"unknown",i.levelIndex=null!=n?""+n:"unknown");let a=JSON.stringify(i),h="";if(o)for(let t in o)h+=`&${t}=${JSON.stringify(o[t])}`;let u=this.abTestData,c=this.logUrl+t+"/track?APIVersion=0.6.0&game=";c+=this.gameId+"&type="+s+"&user="+e+(u?"&__topic__="+(u.isA?"A":"B"):"")+"&content="+a+h,console.log(c);let p=encodeURI(c);this.HttpGet(p,l)}HttpGet(t,e){this.httpGet(t,null,()=>{e&&e>0&&this.HttpGet(t,e-1)})}Login_(t){this.lastLoginTime=Date.now();let e={platform:this.platformName,deviceModel:this.deviceModel,fromAppId:t&&t.fromAppId?t.fromAppId:"Unknown"};t&&(e.scene=t.scene,e.from=t.__sharer_id,e.fromNickName=t.__sharer_name,e.fromShareId=t.__share_id,e.fromKlVideoId=t.__klvideo_id,e.fromShareTitle=t.__share_title,e.shareScene=t.__share_scene,e.channelId=t.channel),this.LogEvent("Login",e)}Logout_(){let t=Math.ceil((Date.now()-(this.lastLoginTime?this.lastLoginTime:Date.now()))/1e3);t>86400||t<=0||this.LogEvent("Logout",{total:t})}httpGet(t,e=null,s=null,i=null,n=null){try{let l=new XMLHttpRequest;l.timeout=this.HttpTimeout,l.open("GET",t,!0),l.setRequestHeader("Content-Type","text/plain;charset=UTF-8"),n&&Object.keys(n).forEach(t=>{let e=n[t];l.setRequestHeader(t,e)}),l.onreadystatechange=(t=>{4==l.readyState&&(200===l.status||0===l.status?e&&(e.call(i,l.responseText),e=null,s=null):s&&(s.call(i,l.responseText),e=null,s=null))}),l.ontimeout=function(t){s&&(s.call(i,t),e=null,s=null)},l.onerror=function(t){s&&(s.call(i,t),e=null,s=null)},l.send()}catch(t){s&&(s.call(i,t),e=null,s=null)}}httpPostJson(t,e,s=null,i=null,n=null,l=null){try{let o=new XMLHttpRequest;o.timeout=this.HttpTimeout,o.open("POST",t,!0),o.setRequestHeader("Content-Type","application/json;charset=utf-8"),l&&Object.keys(l).forEach(t=>{let e=l[t];o.setRequestHeader(t,e)}),o.onreadystatechange=(t=>{4==o.readyState&&(200===o.status||0===o.status?s&&(s.call(n,o.responseText),s=null,i=null):i&&(i.call(n,o.responseText),s=null,i=null))}),o.ontimeout=function(t){i&&(i.call(n,t),s=null,i=null)},o.onerror=function(t){i&&(i.call(n,t),s=null,i=null)},o.send(e)}catch(t){i&&(i.call(n,t),s=null,i=null)}}GetNativeAdData(e,s){this.sceneAllAdDatas||(this.sceneAllAdDatas=new Map);let i=this.sceneAllAdDatas.get(e);i||(i=new Array,this.sceneAllAdDatas.set(e,i));let n=null;for(let t=0;t<i.length;t++){const e=i[t];if(e.id==s){n=e;break}}return n||((n=new t).id=s,i.push(n)),n}OnNativeAdHide_(){if(!this.sceneAllAdDatas)return;if(this.sceneAllAdDatas.size<=0)return;let t={},e={};this.sceneAllAdDatas.forEach((s,i)=>{if(s.length<=0)return;let n={},l=0,o={},r=0;for(let t=0;t<s.length;t++){const e=s[t];e.showCount>0&&(n[e.id]=e.showCount,l++),e.clickCount>0&&(o[e.id]=e.clickCount,r++)}l>0&&(t[i]=n),r>0&&(e[i]=o)}),this.LogEvent_("KLAD",{},0,0,{ADLoadCount:this.adLoadCount,ADShowCount:t,ADClickCount:e},!0),this.adLoadCount=0,this.sceneAllAdDatas.clear()}GetIndexOfApp(t){return this.appConfigs.indexOf(t)}GetAllAppDatas(t){this.sceneAllAppDatas||(this.sceneAllAppDatas=new Map);let s=this.sceneAllAppDatas.get(t);if(!s){s=new Array(this.appConfigs.length);for(let t=0;t<this.appConfigs.length;++t){let i=this.appConfigs[t],n=new e,l=i.icons?i.icons.length:1;n.showCounts=new Array(l);for(let t=0;t<n.showCounts.length;t++)n.showCounts[t]=0;n.showTimes=new Array(l);for(let t=0;t<n.showTimes.length;t++)n.showTimes[t]=0;n.startShowTimes=new Array(l);for(let t=0;t<n.startShowTimes.length;t++)n.startShowTimes[t]=0;s[t]=n}this.sceneAllAppDatas.set(t,s)}return s}OnAppAnalysHide_(){if(!this.sceneAllAppDatas)return;if(this.sceneAllAppDatas.size<=0)return;let t={};this.sceneAllAppDatas.forEach((e,s)=>{if(e.length<=0)return;let i={},n=0;for(let t=0;t<e.length;t++){const s=e[t],l=this.appConfigs[t];for(let t=0;t<s.showCounts.length;t++)s.showCounts[t]>0&&(n++,i[l.icons?l.icons[t].adIconId:l.adIconId]=s.showCounts[t])}n>0&&(t[s]=i)}),this.LogEvent_("ADShow2",{},0,0,{ADShowCount:t},!0),this.sceneAllAppDatas.clear()}}}();