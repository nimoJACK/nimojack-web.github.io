!function(e,t){"use strict";class ExternalSkin{get source(){return this._source}set source(e){this._source=e,e?t.ILaya.loader.load(e,t.Loader.SPINE).then((e=>{!this._source||e&&!e.isCreateFromURL(this._source)||(this.templet=e)})):this.templet=null}set items(e){this._items=e}get items(){return this._items}get templet(){return this._templet}set templet(e){this.init(e)}init(e){this._templet=e,this._templet&&this.flush()}flush(){if(this.target&&this.target.templet&&this._items&&this._templet&&this._templet.skeletonData){if(null==this.target.templet._textures)return;for(let e=this._items.length-1;e>=0;e--){let t=this._items[e],i=t.attachment,s=t.slot,n=t.skin;if(i&&s&&n){let e=null,t=this._templet.skeletonData.skins;for(let s=t.length-1;s>=0;s--)if(t[s].name==n){let n=t[s].attachments;for(let t=n.length-1;t>=0&&(e=n[t][i],!e);t--);break}if(e){let t=e.region.page;this.target.templet._textures[t.name]=t.texture;let i=this.target.getSkeleton().findSlot(s);i&&i.setAttachment(e)}}}}}}class ExternalSkinItem{get skin(){return this._skin}set skin(e){this._skin=e}set slot(e){this._slot=e}get slot(){return this._slot}set attachment(e){this._attachment=e}get attachment(){return this._attachment}}class SpineTexture{constructor(e){this.realTexture=e}getImage(){var e,t,i,s;return{width:null!==(t=null===(e=this.realTexture)||void 0===e?void 0:e.sourceWidth)&&void 0!==t?t:16,height:null!==(s=null===(i=this.realTexture)||void 0===i?void 0:i.sourceHeight)&&void 0!==s?s:16}}setFilters(e,i){if(!this.realTexture)return;let s;s=i===window.spine.TextureFilter.Nearest?t.FilterMode.Point:t.FilterMode.Bilinear,this.realTexture.bitmap.filterMode=s}convertWrapMode(e){return e==window.spine.TextureWrap.ClampToEdge?t.WrapMode.Clamp:e==window.spine.TextureWrap.MirroredRepeat?t.WrapMode.Mirrored:t.WrapMode.Repeat}setWraps(e,t){if(!this.realTexture)return;let i=this.realTexture.bitmap;i.wrapModeU=this.convertWrapMode(e),i.wrapModeV=this.convertWrapMode(t)}}class SpineTemplet extends t.Resource{constructor(){super(),this._textures={}}get ns(){return this._ns}get basePath(){return this._basePath}getTexture(e){return this._textures[e]}_parse(e,i,s,n){let r;return this._basePath=t.URL.getPath(s),r=this.getRuntimeVersion(e).startsWith("4.")?this.parseAtlas4:this.parseAtlas3,r.call(this,i,n).then((t=>{let i=new this._ns.AtlasAttachmentLoader(t);if(e instanceof ArrayBuffer){let t=new this._ns.SkeletonBinary(i);this.skeletonData=t.readSkeletonData(new Uint8Array(e))}else{let t=new this._ns.SkeletonJson(i);this.skeletonData=t.readSkeletonData(e)}}))}getRuntimeVersion(e){return this._ns=window.spine,SpineTemplet.RuntimeVersion}parseAtlas3(e,i){let s=[];return new this._ns.TextureAtlas(e,(e=>(s.push({url:this._basePath+e}),new SpineTexture(null)))),t.ILaya.loader.load(s,null,null==i?void 0:i.createCallback()).then((t=>{let i=0;return new this._ns.TextureAtlas(e,(e=>{let s=t[i++];s&&s._addReference();let n=new SpineTexture(s);return this._textures[e]=n,n}))}))}parseAtlas4(e,i){let s=new this._ns.TextureAtlas(e);return t.ILaya.loader.load(s.pages.map((e=>this._basePath+e.name)),null,null==i?void 0:i.createCallback()).then((e=>{let t=0;for(let i of s.pages){let s=e[t++];s&&s._addReference();let n=new SpineTexture(s);this._textures[i.name]=n,i.setTexture(n)}return s}))}getAniNameByIndex(e){let t=this.skeletonData.animations[e];return t?t.name:null}getSkinIndexByName(e){let t,i=this.skeletonData.skins;for(let s=0,n=i.length;s<n;s++)if(t=i[s],t.name==e)return s;return-1}_disposeResource(){var e;for(let t in this._textures)null===(e=this._textures[t].realTexture)||void 0===e||e._removeReference()}}SpineTemplet.RuntimeVersion="3.8";const i=[0,1,2,2,3,0];class SpineSkeletonRenderer{constructor(e,t=!0){this.vertexEffect=null,this.tempColor=new window.spine.Color,this.tempColor2=new window.spine.Color,this.vertexSize=8,this.twoColorTint=!1,this.temp=new window.spine.Vector2,this.temp2=new window.spine.Vector2,this.temp3=new window.spine.Color,this.temp4=new window.spine.Color,this.twoColorTint=t,t&&(this.vertexSize+=4),this.templet=e,this.vertices=e.ns.Utils.newFloatArray(1024*this.vertexSize),this.renderable={vertices:null,numVertices:0,numFloats:0},this.clipper=new e.ns.SkeletonClipping}draw(e,s,n=-1,r=-1){let a=this.clipper,l=this.premultipliedAlpha,h=this.temp,o=this.temp2,u=this.temp3,p=this.temp4,m=this.renderable,d=null,_=null,c=e.drawOrder,S=null,k=e.color,g=!1;-1==n&&(g=!0);for(let e=0,x=c.length;e<x;e++){let x=a.isClipping()?2:8,f=c[e];if(n>=0&&n==f.data.index&&(g=!0),!g){a.clipEndWithSlot(f);continue}r>=0&&r==f.data.index&&(g=!1);let y,w=f.getAttachment(),A=null;if(w instanceof this.templet.ns.RegionAttachment){let e=w;m.vertices=this.vertices,m.numVertices=4,m.numFloats=x<<2,"4.1"==SpineTemplet.RuntimeVersion?e.computeWorldVertices(f,m.vertices,0,x):e.computeWorldVertices(f.bone,m.vertices,0,x),_=i,d=e.uvs,A="4.1"==SpineTemplet.RuntimeVersion?e.region.page.name:e.region.renderObject.page.name,y=this.templet.getTexture(A),S=e.color}else{if(!(w instanceof this.templet.ns.MeshAttachment)){if(w instanceof this.templet.ns.ClippingAttachment){let e=w;a.clipStart(f,e);continue}a.clipEndWithSlot(f);continue}{let e=w;m.vertices=this.vertices,m.numVertices=e.worldVerticesLength>>1,m.numFloats=m.numVertices*x,m.numFloats>m.vertices.length&&(m.vertices=this.vertices=this.templet.ns.Utils.newFloatArray(m.numFloats)),e.computeWorldVertices(f,0,e.worldVerticesLength,m.vertices,0,x),_=e.triangles,A="4.1"==SpineTemplet.RuntimeVersion?e.region.page.name:e.region.renderObject.page.name,y=this.templet.getTexture(A),d=e.uvs,S=e.color}}if(null!=y){let e=f.color,i=this.tempColor;i.r=k.r*e.r*S.r,i.g=k.g*e.g*S.g,i.b=k.b*e.b*S.b,i.a=k.a*e.a*S.a,l&&(i.r*=i.a,i.g*=i.a,i.b*=i.a);let n=f.data.blendMode;if(a.isClipping()){a.clipTriangles(m.vertices,m.numFloats,_,_.length,d,i,null,false);let e,r=new Float32Array(a.clippedVertices),l=a.clippedTriangles,c=[],S=[],k=16777215,g=1;if(null!=this.vertexEffect){let e=this.vertexEffect,t=r;for(let i=0,s=r.length;i<s;i+=8)h.x=t[i],h.y=t[i+1],u.set(t[i+2],t[i+3],t[i+4],t[i+5]),o.x=t[i+6],o.y=t[i+7],p.set(0,0,0,0),e.transform(h,o,u,p),t[i]=h.x,t[i+1]=h.y,t[i+2]=u.r,t[i+3]=u.g,t[i+4]=u.b,t[i+5]=u.a,t[i+6]=o.x,t[i+7]=o.y,c.push(t[i],-t[i+1]),k=(255*t[i+2]<<16)+(255*t[i+3]<<8)+t[i+4],g=t[i+5],S.push(t[i+6],t[i+7])}else{let e=0;for(;Number.isFinite(r[e+6])&&Number.isFinite(r[e+7]);)c.push(r[e]),c.push(-r[e+1]),k=(255*r[e+2]<<16)+(255*r[e+3]<<8)+255*r[e+4],g=r[e+5],S.push(r[e+6]),S.push(r[e+7]),e+=this.vertexSize}switch(n){case 1:e="light";break;case 2:e="multiply";break;case 3:e="screen";break;default:e="normal"}s.drawTriangles(y.realTexture,0,0,c,S,new Uint16Array(l),t.Matrix.EMPTY,g,k,e)}else{let e,r=m.vertices,a=[],l=[],c=16777215,S=1;if(null!=this.vertexEffect){let e=this.vertexEffect;for(let t=0,s=0,n=m.numFloats;t<n;t+=8,s+=2)h.x=r[t],h.y=r[t+1],o.x=d[s],o.y=d[s+1],u.setFromColor(i),p.set(0,0,0,0),e.transform(h,o,u,p),r[t]=h.x,r[t+1]=h.y,r[t+2]=u.r,r[t+3]=u.g,r[t+4]=u.b,r[t+5]=u.a,r[t+6]=o.x,r[t+7]=o.y,a.push(r[t],-r[t+1]),c=(255*r[t+2]<<16)+(255*r[t+3]<<8)+255*r[t+4],S=r[t+5],l.push(r[t+6],r[t+7])}else for(let e=2,t=0,s=m.numFloats;e<s;e+=8,t+=2)r[e]=i.r,r[e+1]=i.g,r[e+2]=i.b,r[e+3]=i.a,r[e+4]=d[t],r[e+5]=d[t+1],a.push(r[e-2],-r[e-1]),c=(255*r[e]<<16)+(255*r[e+1]<<8)+255*r[e+2],S=r[e+3],l.push(r[e+4],r[e+5]);switch(n){case 1:e="light";break;case 2:e="multiply";break;case 3:e="screen";break;default:e="normal"}s.drawTriangles(y.realTexture,0,0,a,l,new Uint16Array(_),t.Matrix.EMPTY,S,c,e)}}a.clipEndWithSlot(f)}a.clipEnd()}}class SpineSkeleton extends t.Sprite{constructor(){super(),this._currentPlayTime=0,this._pause=!0,this._currAniName=null,this._playbackRate=1,this._playAudio=!0,this._soundChannelArr=[],this.trackIndex=0,this._skinName="default",this._animationName="",this._loop=!0}get externalSkins(){return this._externalSkins}set externalSkins(e){if(e)for(let t=e.length-1;t>=0;t--)e[t].target=this;this._externalSkins=e}resetExternalSkin(){this._skeleton&&(this._skeleton=new this._templet.ns.Skeleton(this._templet.skeletonData),this._flushExtSkin())}get source(){return this._source}set source(e){this._source=e,e?t.ILaya.loader.load(e,t.Loader.SPINE).then((e=>{!this._source||e&&!e.isCreateFromURL(this._source)||(this.templet=e)})):this.templet=null}get skinName(){return this._skinName}set skinName(e){this._skinName=e,this._templet&&this.showSkinByName(e)}get animationName(){return this._animationName}set animationName(e){this._animationName=e,this._templet&&this.play(e,this._loop,!0)}get loop(){return this._loop}set loop(e){this._loop=e,this._templet&&this.play(this._animationName,this._loop,!0)}get templet(){return this._templet}set templet(e){this.init(e)}set currentTime(e){if(this._currAniName&&this._templet){if((e/=1e3)<this._playStart||this._playEnd&&e>this._playEnd||e>this._duration)throw new Error("AnimationPlayer: value must large than playStartTime,small than playEndTime.");this._state.update(e-this._currentPlayTime),this._currentPlayTime=e}}get playState(){return this._currAniName?this._pause?SpineSkeleton.PAUSED:SpineSkeleton.PLAYING:SpineSkeleton.STOPPED}init(e){if(this._templet&&(this.reset(),this.graphics.clear()),this._templet=e,!this._templet)return;this._templet._addReference(),this._skeleton=new e.ns.Skeleton(this._templet.skeletonData),this._stateData=new e.ns.AnimationStateData(this._skeleton.data),this._state=new e.ns.AnimationState(this._stateData),this._renerer=new SpineSkeletonRenderer(e,!1),this._timeKeeper=new e.ns.TimeKeeper;let i=this._templet.getSkinIndexByName(this._skinName);-1!=i&&this.showSkinByIndex(i),this._state.addListener({start:e=>{},interrupt:e=>{},end:e=>{},dispose:e=>{},complete:e=>{e.loop?this.event(t.Event.COMPLETE):(this._currAniName=null,this.event(t.Event.STOPPED))},event:(i,s)=>{let n={audioValue:s.data.audioPath,audioPath:s.data.audioPath,floatValue:s.floatValue,intValue:s.intValue,name:s.data.name,stringValue:s.stringValue,time:1e3*s.time,balance:s.balance,volume:s.volume};if(this.event(t.Event.LABEL,n),this._playAudio&&n.audioValue){let i=t.SoundManager.playSound(e.basePath+n.audioValue,1,t.Handler.create(this,this._onAniSoundStoped),null,(1e3*this._currentPlayTime-n.time)/1e3);t.SoundManager.playbackRate=this._playbackRate,i&&this._soundChannelArr.push(i)}}}),this._flushExtSkin(),this.event(t.Event.READY),t.LayaEnv.isPlaying&&this._animationName&&this.play(this._animationName,this._loop,!0)}play(e,t,i=!0,s=0,n=0,r=!0,a=!0){this._playAudio=a,n/=1e3;let l=e;if((s/=1e3)<0||n<0)throw new Error("SpineSkeleton: start and end must large than zero.");if(0!==n&&s>n)throw new Error("SpineSkeleton: start must less than end.");if("number"==typeof l&&(l=this.getAniNameByIndex(e)),i||this._pause||this._currAniName!=l){this._currAniName=l,this._state.setAnimation(this.trackIndex,l,t);let e=this._state.getCurrent(this.trackIndex);e.animationStart=s,n&&n<e.animationEnd&&(e.animationEnd=n);let i=e.animation.duration;this._duration=i,this._playStart=s,this._playEnd=n<=i?n:i,this._pause&&(this._pause=!1,this.timer.frameLoop(1,this,this._update,null,!0)),this._update()}}_update(){this._timeKeeper.update();let e=this._timeKeeper.delta*this._playbackRate,t=this._state.getCurrent(this.trackIndex);this._state.update(e),this._state.apply(this._skeleton);let i=t.animationLast;this._currentPlayTime=Math.max(0,i),this._state&&this._skeleton&&(this._skeleton.updateWorldTransform(),this.graphics.clear(),this._renerer.draw(this._skeleton,this.graphics,-1,-1))}_flushExtSkin(){if(null==this._skeleton)return;let e=this._externalSkins;if(e)for(let t=e.length-1;t>=0;t--)e[t].flush()}getAnimNum(){return this._templet.skeletonData.animations.length}getAniNameByIndex(e){return this._templet.getAniNameByIndex(e)}getSlotByName(e){return this._skeleton.findSlot(e)}playbackRate(e){this._playbackRate=e}showSkinByName(e){this.showSkinByIndex(this._templet.getSkinIndexByName(e))}showSkinByIndex(e){let t=this._skeleton.data.skins[e];this._skeleton.setSkin(t),this._skeleton.setSlotsToSetupPose()}stop(){this._pause||(this._pause=!0,this._currAniName=null,this.timer.clear(this,this._update),this._state.update(-this._currentPlayTime),this._currentPlayTime=0,this.event(t.Event.STOPPED),this._soundChannelArr.length>0&&this._onAniSoundStoped(!0))}paused(){if(!this._pause&&(this._pause=!0,this.timer.clear(this,this._update),this.event(t.Event.PAUSED),this._soundChannelArr.length>0))for(let e=this._soundChannelArr.length,t=0;t<e;t++){let e=this._soundChannelArr[t];e.isStopped||e.pause()}}resume(){if(this._pause&&(this._pause=!1,this.timer.frameLoop(1,this,this._update,null,!0),this._soundChannelArr.length>0))for(let e=this._soundChannelArr.length,t=0;t<e;t++){let e=this._soundChannelArr[t];e.audioBuffer&&e.resume()}}_onAniSoundStoped(e){for(let t=this._soundChannelArr.length,i=0;i<t;i++){let s=this._soundChannelArr[i];(s.isStopped||e)&&(!s.isStopped&&s.stop(),this._soundChannelArr.splice(i,1),t--,i--)}}reset(){this._templet._removeReference(1),this._templet=null,this._timeKeeper=null,this._skeleton=null,this._state.clearListeners(),this._state=null,this._renerer=null,this._currAniName=null,this._pause=!0,this.timer.clear(this,this._update),this._soundChannelArr.length>0&&this._onAniSoundStoped(!0)}destroy(e=!0){super.destroy(e),this._templet&&this.reset()}addAnimation(e,t=!1,i=0){i/=1e3;let s=e;"number"==typeof s&&(s=this.getAniNameByIndex(s)),this._currAniName=s,this._state.addAnimation(this.trackIndex,s,t,i)}setMix(e,t,i){i/=1e3;let s=e;"number"==typeof s&&(s=this.getAniNameByIndex(s));let n=t;"number"==typeof n&&(n=this.getAniNameByIndex(n)),this._stateData.setMix(s,n,i)}getBoneByName(e){return this._skeleton.findBone(e)}getSkeleton(){return this._skeleton}setSlotAttachment(e,t){this._skeleton.setAttachment(e,t)}}SpineSkeleton.STOPPED=0,SpineSkeleton.PAUSED=1,SpineSkeleton.PLAYING=2;t.Loader.registerLoader(["skel"],class{load(e){let i=t.Utils.replaceFileExtension(e.url,"atlas");return Promise.all([e.loader.fetch(e.url,"skel"==e.ext?"arraybuffer":"json",e.progress.createCallback()),e.loader.fetch(i,"text",e.progress.createCallback())]).then((t=>{if(!t[0]||!t[1])return null;let i=new SpineTemplet;return i._parse(t[0],t[1],e.url,e.progress).then((()=>i))}))}},t.Loader.SPINE);let s=t.ClassUtils.regClass;s("SpineSkeleton",SpineSkeleton),s("ExternalSkin",ExternalSkin),s("ExternalSkinItem",ExternalSkinItem),e.ExternalSkin=ExternalSkin,e.ExternalSkinItem=ExternalSkinItem,e.SpineSkeleton=SpineSkeleton,e.SpineSkeletonRenderer=SpineSkeletonRenderer,e.SpineTemplet=SpineTemplet,e.SpineTexture=SpineTexture}(window.Laya=window.Laya||{},Laya);
//# sourceMappingURL=laya.spine.js.map