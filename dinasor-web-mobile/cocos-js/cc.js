System.register([],(function(e,t){"use strict";return{execute:function(){e({BitMask:Qe,CCClass:jt,CacheMode:void 0,DebugMode:void 0,EAxisDirection:void 0,ERigidBodyType:void 0,Enum:Je,Eventify:Wl,ExtrapolationMode:void 0,HorizontalTextAlignment:void 0,InstanceMaterialType:void 0,KeyCode:void 0,NodeEventType:void 0,NodeSpace:void 0,Overflow:void 0,PipelineEventType:void 0,QuatInterpolationMode:void 0,RealInterpolationMode:void 0,SystemEventType:void 0,TangentWeightMode:void 0,TransformBit:void 0,VerticalTextAlignment:void 0,WorldNode3DToLocalNodeUI:IA,WorldNode3DToWorldNodeUI:PA,absMax:vn,absMaxComponent:mn,approx:$t,assert:z,assertID:J,bezier:vf,bezierByTime:Lf,ccenum:et,clamp:en,clamp01:tn,color:Jn,computeRatioByType:J0,createDefaultPipeline:ZD,debug:U,deserialize:Th,earcut:dW,enumerableProps:gn,equals:Zt,error:B,errorID:Y,find:YP,fragmentText:XF,getBaselineOffset:function(){return 0},getEnglishWordPartAtFirst:jF,getEnglishWordPartAtLast:qF,getError:Z,getPathFromRoot:function(e,t){for(var n=e,i="";null!==n&&n!==t;)i=n.name+"/"+i,n=n.parent;return i.slice(0,-1)},getSerializationMetadata:function(e){return e[Sc]},getWorldTransformUntilRoot:EJ,instantiate:kh,inverseLerp:pn,isDisplayStats:$,isEnglishWordPartAtFirst:function(e){return kF.test(e)},isEnglishWordPartAtLast:function(e){return UF.test(e)},isUnicodeCJK:GF,isUnicodeSpace:HF,isValid:sl,lerp:nn,log:L,logID:W,markAsWarning:void 0,mat4:Vn,murmurhash2_32_gc:po,nextPow2:_n,pingPong:dn,pseudoRandom:ln,pseudoRandomRange:un,pseudoRandomRangeInt:hn,quat:zn,randomRange:sn,randomRangeInt:cn,rect:Yn,removeProperty:void 0,repeat:fn,replaceProperty:void 0,safeMeasureText:VF,sampleAnimationCurve:Q0,setDefaultLogTimes:function(e){e>0&&(CT=e)},setDisplayStats:ee,size:qn,toDegree:on,toRadian:rn,tween:bve,tweenUtil:Ave,v2:An,v3:En,v4:In,warn:F,warnID:q});var n=2147483647;function i(e){return(e>0)-(e<0)}function r(e){var t,n;return t=(e>65535)<<4,t|=n=((e>>>=t)>255)<<3,t|=n=((e>>>=n)>15)<<2,(t|=n=((e>>>=n)>3)<<1)|(e>>>=n)>>1}function o(e){return 16843009*((e=(858993459&(e-=e>>>1&1431655765))+(e>>>2&858993459))+(e>>>4)&252645135)>>>24}function a(e){var t=32;return(e&=-e)&&t--,65535&e&&(t-=16),16711935&e&&(t-=8),252645135&e&&(t-=4),858993459&e&&(t-=2),1431655765&e&&(t-=1),t}function s(e){return--e,e|=e>>>1,e|=e>>>2,e|=e>>>4,e|=e>>>8,1+(e|=e>>>16)}var c=new Array(256);!function(e){for(var t=0;t<256;++t){var n=t,i=t,r=7;for(n>>>=1;n;n>>>=1)i<<=1,i|=1&n,--r;e[t]=i<<r&255}}(c);var l=Object.freeze({__proto__:null,INT_BITS:32,INT_MAX:n,INT_MIN:-2147483648,sign:i,abs:function(e){var t=e>>31;return(e^t)-t},min:function(e,t){return t^(e^t)&-(e<t)},max:function(e,t){return e^(e^t)&-(e<t)},isPow2:function(e){return!(e&e-1||!e)},log2:r,log10:function(e){return e>=1e9?9:e>=1e8?8:e>=1e7?7:e>=1e6?6:e>=1e5?5:e>=1e4?4:e>=1e3?3:e>=100?2:e>=10?1:0},popCount:o,countTrailingZeros:a,nextPow2:s,prevPow2:function(e){return e|=e>>>1,e|=e>>>2,e|=e>>>4,e|=e>>>8,(e|=e>>>16)-(e>>>1)},parity:function(e){return e^=e>>>16,e^=e>>>8,e^=e>>>4,27030>>>(e&=15)&1},reverse:function(e){return c[255&e]<<24|c[e>>>8&255]<<16|c[e>>>16&255]<<8|c[e>>>24&255]},interleave2:function(e,t){return(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e&=65535)|e<<8))|e<<4))|e<<2))|e<<1))|(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t&=65535)|t<<8))|t<<4))|t<<2))|t<<1))<<1},deinterleave2:function(e,t){return(e=65535&((e=16711935&((e=252645135&((e=858993459&((e=e>>>t&1431655765)|e>>>1))|e>>>2))|e>>>4))|e>>>16))<<16>>16},interleave3:function(e,t,n){return e=1227133513&((e=3272356035&((e=251719695&((e=4278190335&((e&=1023)|e<<16))|e<<8))|e<<4))|e<<2),(e|=(t=1227133513&((t=3272356035&((t=251719695&((t=4278190335&((t&=1023)|t<<16))|t<<8))|t<<4))|t<<2))<<1)|(n=1227133513&((n=3272356035&((n=251719695&((n=4278190335&((n&=1023)|n<<16))|n<<8))|n<<4))|n<<2))<<2},deinterleave3:function(e,t){return(e=1023&((e=4278190335&((e=251719695&((e=3272356035&((e=e>>>t&1227133513)|e>>>2))|e>>>4))|e>>>8))|e>>>16))<<22>>22},nextCombination:function(e){var t=e|e-1;return t+1|(~t&-~t)-1>>>a(e)+1}});function u(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function h(e,t,n){return t&&u(e.prototype,t),n&&u(e,n),e}function _(){return(_=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e}).apply(this,arguments)}function f(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,p(e,t)}function d(e){return(d=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function p(e,t){return(p=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function m(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}function v(e,t,n){return(v=m()?Reflect.construct:function(e,t,n){var i=[null];i.push.apply(i,t);var r=new(Function.bind.apply(e,i));return n&&p(r,n.prototype),r}).apply(null,arguments)}function g(e){var t="function"==typeof Map?new Map:void 0;return(g=function(e){if(null===e||(n=e,-1===Function.toString.call(n).indexOf("[native code]")))return e;var n;if("function"!=typeof e)throw new TypeError("Super expression must either be null or a function");if(void 0!==t){if(t.has(e))return t.get(e);t.set(e,i)}function i(){return v(e,arguments,d(this).constructor)}return i.prototype=Object.create(e.prototype,{constructor:{value:i,enumerable:!1,writable:!0,configurable:!0}}),p(i,e)})(e)}function y(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function x(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,i=new Array(t);n<t;n++)i[n]=e[n];return i}function S(e,t){var n;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(n=function(e,t){if(e){if("string"==typeof e)return x(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?x(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var i=0;return function(){return i>=e.length?{done:!0}:{done:!1,value:e[i++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}return(n=e[Symbol.iterator]()).next.bind(n)}function E(e,t,n,i){n&&Object.defineProperty(e,t,{enumerable:n.enumerable,configurable:n.configurable,writable:n.writable,value:n.initializer?n.initializer.call(i):void 0})}function T(e,t,n,i,r){var o={};return Object.keys(i).forEach((function(e){o[e]=i[e]})),o.enumerable=!!o.enumerable,o.configurable=!!o.configurable,("value"in o||o.initializer)&&(o.writable=!0),o=n.slice().reverse().reduce((function(n,i){return i(e,t,n)||n}),o),r&&void 0!==o.initializer&&(o.value=o.initializer?o.initializer.call(r):void 0,o.initializer=void 0),void 0===o.initializer&&(Object.defineProperty(e,t,o),o=null),o}e("bits",l);var C="undefined"==typeof window?global:window,b=e("cclegacy",{_global:C});b.internal={},C.CC_BUILD=!0,C.CC_TEST=!1,C.CC_EDITOR=false,C.CC_PREVIEW=!1,C.CC_DEV=!1,C.CC_DEBUG=!1,C.CC_JSB=!1,C.CC_BYTEDANCE=!1,C.CC_WECHAT=!1,C.CC_ALIPAY=!1,C.CC_XIAOMI=!1,C.CC_BAIDU=!1,C.CC_COCOSPLAY=!1,C.CC_HUAWEI=!1,C.CC_OPPO=!1,C.CC_VIVO=!1,C.CC_MINIGAME=!1,C.CC_RUNTIME_BASED=!1,C.CC_SUPPORT_JIT=!0;var A=e("VERSION","3.5.2");C.CocosEngine=b.ENGINE_VERSION=A,C.cc=b;var w="https://github.com/cocos-creator/engine/blob/develop/EngineErrorMap.md",I=null,P=console.log.bind(console),R=P,D=P,O=function(e,t){if(!e){for(var n=arguments.length,i=new Array(n>2?n-2:0),r=2;r<n;r++)i[r-2]=arguments[r];console.log("ASSERT: "+M.apply(void 0,[t].concat(i)))}},N=P;function M(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return b.js.formatStr.apply(null,[e].concat(n))}function L(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return P.apply(void 0,[e].concat(n))}function F(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return R.apply(void 0,[e].concat(n))}function B(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return D.apply(void 0,[e].concat(n))}function z(e,t){for(var n=arguments.length,i=new Array(n>2?n-2:0),r=2;r<n;r++)i[r-2]=arguments[r];return O.apply(void 0,[e,t].concat(i))}function U(){return N.apply(void 0,arguments)}function k(e){if(P=R=D=O=N=function(){},e!==K.NONE){if(e>K.ERROR){var t=function(e){if(b.game.canvas){if(!I){var t=document.createElement("Div");t.setAttribute("id","logInfoDiv"),t.setAttribute("width","200"),t.setAttribute("height",b.game.canvas.height);var n=t.style;n.zIndex="99999",n.position="absolute",n.top=n.left="0",(I=document.createElement("textarea")).setAttribute("rows","20"),I.setAttribute("cols","30"),I.setAttribute("disabled","true");var i=I.style;i.backgroundColor="transparent",i.borderBottom="1px solid #cccccc",i.borderTopWidth=i.borderLeftWidth=i.borderRightWidth="0px",i.borderTopStyle=i.borderLeftStyle=i.borderRightStyle="none",i.padding="0px",i.margin="0px",t.appendChild(I),b.game.canvas.parentNode.appendChild(t)}I.value=I.value+e+"\r\n",I.scrollTop=I.scrollHeight}};D=function(e){for(var n=arguments.length,i=new Array(n>1?n-1:0),r=1;r<n;r++)i[r-1]=arguments[r];t("ERROR :  "+M.apply(void 0,[e].concat(i)))},O=function(e,n){if(!e){for(var i=arguments.length,r=new Array(i>2?i-2:0),o=2;o<i;o++)r[o-2]=arguments[o];t("ASSERT: "+M.apply(void 0,[n].concat(r)))}},e!==K.ERROR_FOR_WEB_PAGE&&(R=function(e){for(var n=arguments.length,i=new Array(n>1?n-1:0),r=1;r<n;r++)i[r-1]=arguments[r];t("WARN :  "+M.apply(void 0,[e].concat(i)))}),e===K.INFO_FOR_WEB_PAGE&&(P=function(e){for(var n=arguments.length,i=new Array(n>1?n-1:0),r=1;r<n;r++)i[r-1]=arguments[r];t(M.apply(void 0,[e].concat(i)))})}else console&&(console.error||(console.error=console.log),console.warn||(console.warn=console.log),D=console.error.bind?console.error.bind(console):function(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return console.error.apply(console,[e].concat(n))},O=function(e,t){if(!e){for(var n=arguments.length,i=new Array(n>2?n-2:0),r=2;r<n;r++)i[r-2]=arguments[r];var o=M.apply(void 0,[t].concat(i));throw new Error(o)}});if(e!==K.ERROR&&(R=console.warn.bind?console.warn.bind(console):function(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return console.warn.apply(console,[e].concat(n))}),e<=K.INFO&&(P=console.log.bind?console.log.bind(console):function(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return console.log.apply(console,[e].concat(n))}),e<=K.VERBOSE&&"function"==typeof console.debug){var n=console.debug.bind(console);N=function(){return n.apply(void 0,arguments)}}}}function G(e){B(e.stack||e)}function H(e){return function(t){for(var n=e+" "+t+", please go to "+w+"#"+t+" to see details.",i=arguments.length,r=new Array(i>1?i-1:0),o=1;o<i;o++)r[o-1]=arguments[o];return 0===r.length?n:n+" Arguments: "+r.join(", ")}}var V=H("Log");function W(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];L(V.apply(void 0,[e].concat(n)))}var j=H("Warning");function q(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];F(j.apply(void 0,[e].concat(n)))}var X=H("Error");function Y(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];B(X.apply(void 0,[e].concat(n)))}var K,Q=H("Assert");function J(e,t){if(!e){for(var n=arguments.length,i=new Array(n>2?n-2:0),r=2;r<n;r++)i[r-2]=arguments[r];z(!1,Q.apply(void 0,[t].concat(i)))}}function Z(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return X.apply(void 0,[e].concat(n))}function $(){return!!b.profiler&&b.profiler.isShowingStats()}function ee(e){b.profiler&&(e?b.profiler.showStats():b.profiler.hideStats(),b.game.config.showFPS=!!e)}!function(e){e[e.NONE=0]="NONE",e[e.VERBOSE=1]="VERBOSE",e[e.INFO=2]="INFO",e[e.WARN=3]="WARN",e[e.ERROR=4]="ERROR",e[e.INFO_FOR_WEB_PAGE=5]="INFO_FOR_WEB_PAGE",e[e.WARN_FOR_WEB_PAGE=6]="WARN_FOR_WEB_PAGE",e[e.ERROR_FOR_WEB_PAGE=7]="ERROR_FOR_WEB_PAGE"}(K||(K=e("DebugMode",{})));var te=Object.freeze({__proto__:null,log:L,warn:F,error:B,assert:z,debug:U,_resetDebugSetting:k,_throw:G,logID:W,warnID:q,errorID:Y,assertID:J,get DebugMode(){return K},getError:Z,isDisplayStats:$,setDisplayStats:ee}),ne=function(){function e(e){this.i=0,this.array=e}var t=e.prototype;return t.remove=function(e){var t=this.array.indexOf(e);t>=0&&this.removeAt(t)},t.removeAt=function(e){this.array.splice(e,1),e<=this.i&&--this.i},t.fastRemove=function(e){var t=this.array.indexOf(e);t>=0&&this.fastRemoveAt(t)},t.fastRemoveAt=function(e){var t=this.array;t[e]=t[t.length-1],--t.length,e<=this.i&&--this.i},t.push=function(e){this.array.push(e)},h(e,[{key:"length",get:function(){return this.array.length},set:function(e){this.array.length=e,this.i>=e&&(this.i=e-1)}}]),e}();function ie(e,t){e.splice(t,1)}function re(e,t){var n=e.length;t<0||t>=n||(e[t]=e[n-1],e.length=n-1)}function oe(e,t){var n=e.indexOf(t);return n>=0&&(ie(e,n),!0)}function ae(e,t){return e.indexOf(t)>=0}var se=Object.freeze({__proto__:null,removeAt:ie,fastRemoveAt:re,remove:oe,fastRemove:function(e,t){var n=e.indexOf(t);n>=0&&(e[n]=e[e.length-1],--e.length)},removeIf:function(e,t){var n=e.findIndex(t);if(n>=0){var i=e[n];return ie(e,n),i}},verifyType:function(e,t){if(e&&e.length>0)for(var n,i=S(e);!(n=i()).done;)if(!(n.value instanceof t))return W(1300),!1;return!0},removeArray:function(e,t){for(var n=0,i=t.length;n<i;n++)oe(e,t[n])},appendObjectsAt:function(e,t,n){return e.splice.apply(e,[n,0].concat(t)),e},contains:ae,copy:function(e){for(var t=e.length,n=new Array(t),i=0;i<t;i+=1)n[i]=e[i];return n},MutableForwardIterator:ne}),ce=function(){function e(e){this.id=void 0,this.prefix=void 0,this.id=0|998*Math.random(),this.prefix=e?e+".":""}return e.prototype.getNewId=function(){return this.prefix+ ++this.id},e}();ce.global=new ce("global");var le=new ce("TmpCId."),ue="undefined"==typeof Symbol?"__aliases__":Symbol("[[Aliases]]"),he="__cid__";function _e(e){return"number"==typeof e||e instanceof Number}function fe(e){return"string"==typeof e||e instanceof String}function de(e){for(var t in e)return!1;return!0}var pe,me=(pe={value:void 0,enumerable:!1,writable:!1,configurable:!0},function(e,t,n,i,r){pe.value=n,pe.writable=i,pe.enumerable=r,Object.defineProperty(e,t,pe),pe.value=void 0}),ve=function(){var e={get:void 0,set:void 0,enumerable:!1};return function(t,n,i,r,o,a){void 0===o&&(o=!1),void 0===a&&(a=!1),"boolean"==typeof r&&(o=r,r=void 0),e.get=i,e.set=r,e.enumerable=o,e.configurable=a,Object.defineProperty(t,n,e),e.get=void 0,e.set=void 0}}(),ge=function(){var e={get:void 0,enumerable:!1,configurable:!1};return function(t,n,i,r,o){e.get=i,e.enumerable=r,e.configurable=o,Object.defineProperty(t,n,e),e.get=void 0}}(),ye=function(){var e={set:void 0,enumerable:!1,configurable:!1};return function(t,n,i,r,o){e.set=i,e.enumerable=r,e.configurable=o,Object.defineProperty(t,n,e),e.set=void 0}}();function xe(e){var t=Object.create(null);return e&&(t["."]=1,t["/"]=1,delete t["."],delete t["/"]),t}function Se(e){if("function"==typeof e){var t=e.prototype;if(t&&t.hasOwnProperty("__classname__")&&t.__classname__)return t.__classname__;var n="";if(e.name&&(n=e.name),e.toString){var i,r=e.toString();(i="["===r.charAt(0)?/\[\w+\s*(\w+)\]/.exec(r):/function\s*(\w+)/.exec(r))&&2===i.length&&(n=i[1])}return"Object"!==n?n:""}return e&&e.constructor?Se(e.constructor):""}function Ee(e,t,n,i){var r=/([^.]+)$/,o=r.exec(t)[0],a=r.exec(n)[0];function s(){return this[a]}i?ve(e,o,s,(function(e){this[a]=e})):ge(e,o,s)}function Te(e,t,n,i){for(var r in n)Ee(e,t+"."+r,n[r],i)}var Ce=/(%d)|(%s)/,be=/%s/;function Ae(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];if(0===arguments.length)return"";if(0===n.length)return""+e;var r="string"==typeof e&&Ce.test(e);if(r)for(var o,a=S(n);!(o=a()).done;){var s=o.value,c="number"==typeof s?Ce:be;if(c.test(e)){var l=""+s;e=e.replace(c,l)}else e+=" "+s}else for(var u,h=S(n);!(u=h()).done;){var _=u.value;e+=" "+_}return e}function we(){for(var e=arguments.length-1,t=new Array(e),n=0;n<e;++n)t[n]=arguments[n+1];return t}function Ie(e,t){for(;e;){var n=Object.getOwnPropertyDescriptor(e,t);if(n)return n;e=Object.getPrototypeOf(e)}return null}function Pe(e,t,n){var i=Ie(t,e);i&&Object.defineProperty(n,e,i)}function Re(e){e=e||{};for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];for(var r=0,o=n;r<o.length;r++){var a=o[r];if(a){if("object"!=typeof a){Y(5402,a);continue}for(var s in a)s in e||Pe(s,a,e)}}return e}function De(e){e=e||{};for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];for(var r=0,o=n;r<o.length;r++){var a=o[r];if(a){if("object"!=typeof a){Y(5403,a);continue}for(var s in a)Pe(s,a,e)}}return e}function Oe(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);return e.prototype=Object.create(t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),e}function Ne(e){var t=e.prototype,n=t&&Object.getPrototypeOf(t);return n&&n.constructor}function Me(e,t){if(e&&t){if("function"!=typeof e)return!1;if("function"!=typeof t)return!1;if(e===t)return!0;for(;;){if(!(e=Ne(e)))return!1;if(e===t)return!0}}return!1}function Le(e){for(var t=0,n=Object.keys(e);t<n.length;t++)delete e[n[t]]}var Fe=xe(!0),Be=xe(!0);function ze(e,t){return function(n,i){if(i.prototype.hasOwnProperty(e)&&delete t[i.prototype[e]],me(i.prototype,e,n),n){var r=t[n];r&&r!==i?B("A Class already exists with the same "+e+' : "'+n+'".'):t[n]=i}}}var Ue=ze("__cid__",Fe),ke=ze("__classname__",Be);function Ge(e,t){if(ke(e,t),!t.prototype.hasOwnProperty(he)){var n=e||le.getNewId();n&&Ue(n,t)}}function He(e,t){var n=Be[t],i=Fe[t],r=!0;if(n&&n!==e&&(B('"'+t+'" has already been set as name or alias of another class.'),r=!1),i&&i!==e&&(B('"'+t+'" has already been set as id or alias of another class.'),r=!1),r){var o=e[ue];o||(o=[],e[ue]=o),o.push(t),Be[t]=e,Fe[t]=e}}function Ve(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];for(var i=0,r=t;i<r.length;i++){var o=r[i],a=o.prototype,s=a.__cid__;s&&delete Fe[s];var c=a.__classname__;c&&delete Be[c];var l=a[ue];if(l)for(var u=0;u<l.length;++u){var h=l[u];delete Be[h],delete Fe[h]}}}function We(e){return Fe[e]}function je(e){return Be[e]}function qe(e,t){if(t=void 0===t||t,"function"==typeof e&&e.prototype.hasOwnProperty(he))return e.prototype.__cid__;if(e&&e.constructor){var n=e.constructor.prototype;if(n&&n.hasOwnProperty(he))return e.__cid__}return""}var Xe=function(){var e=t.prototype;function t(e,t){this.count=void 0,this._pool=void 0,this._cleanup=void 0;var n=void 0===t?e:t,i=void 0===t?null:e;this.count=0,this._pool=new Array(n),this._cleanup=i}return e.get=function(){return this._get()},e._get=function(){if(this.count>0){--this.count;var e=this._pool[this.count];return this._pool[this.count]=null,e}return null},e.put=function(e){var t=this._pool;if(this.count<t.length){if(this._cleanup&&!1===this._cleanup(e))return;t[this.count]=e,++this.count}},e.resize=function(e){e>=0&&(this._pool.length=e,this.count>e&&(this.count=e))},t}(),Ye=se,Ke={IDGenerator:ce,Pool:Xe,array:se,isNumber:_e,isString:fe,isEmptyObject:de,getPropertyDescriptor:Ie,addon:Re,mixin:De,extend:Oe,getSuper:Ne,isChildClassOf:Me,clear:Le,value:me,getset:ve,get:ge,set:ye,unregisterClass:Ve,getClassName:Se,setClassName:Ge,setClassAlias:He,getClassByName:je,get _registeredClassNames(){return _({},Be)},set _registeredClassNames(e){Le(Be),Object.assign(Be,e)},get _registeredClassIds(){return _({},Fe)},set _registeredClassIds(e){Le(Fe),Object.assign(Fe,e)},_getClassId:qe,_setClassId:Ue,_getClassById:We,obsolete:Ee,obsoletes:Te,formatStr:Ae,shiftArguments:we,createMap:xe};function Qe(e){if("__bitmask__"in e)return e;me(e,"__bitmask__",null,!0);for(var t=-1,n=Object.keys(e),i=0;i<n.length;i++){var r=n[i],o=e[r];if(-1===o)o=++t,e[r]=o;else if("number"==typeof o)t=o;else if("string"==typeof o&&Number.isInteger(parseFloat(r)))continue;var a=""+o;r!==a&&me(e,a,r)}return e}function Je(e){return"__enums__"in e?e:(me(e,"__enums__",null,!0),Je.update(e))}function Ze(e){e.hasOwnProperty("__enums__")}function $e(e){Ze(e);var t=e.__enums__||[];for(var n in t.length=0,e){var i=e[n];Number.isInteger(i)&&t.push({name:n,value:i})}return t.sort((function(e,t){return e.value-t.value})),e.__enums__=t,t}function et(e){"__enums__"in e||me(e,"__enums__",null,!0)}b.js=Ke,e("js",Object.freeze({__proto__:null,array:Ye,js:Ke,IDGenerator:ce,Pool:Xe,isNumber:_e,isString:fe,isEmptyObject:de,value:me,getset:ve,get:ge,set:ye,createMap:xe,getClassName:Se,obsolete:Ee,obsoletes:Te,formatStr:Ae,shiftArguments:we,getPropertyDescriptor:Ie,addon:Re,mixin:De,extend:Oe,getSuper:Ne,isChildClassOf:Me,clear:Le,_idToClass:Fe,_nameToClass:Be,_setClassId:Ue,setClassName:Ge,setClassAlias:He,unregisterClass:Ve,_getClassById:We,getClassByName:je,_getClassId:qe})),Qe.isBitMask=function(e){return e&&e.hasOwnProperty("__bitmask__")},Qe.getList=function(e){if(e.__bitmask__)return e.__bitmask__;var t=e.__bitmask__=[];for(var n in e){var i=e[n];Number.isInteger(i)&&t.push({name:n,value:i})}return t.sort((function(e,t){return e.value-t.value})),t},b.BitMask=Qe,Je.update=function(e){for(var t=-1,n=Object.keys(e),i=0;i<n.length;i++){var r=n[i],o=e[r];if(-1===o)o=++t,e[r]=o;else if("number"==typeof o)t=o;else if("string"==typeof o&&Number.isInteger(parseFloat(r)))continue;var a=""+o;r!==a&&me(e,a,r)}return Array.isArray(e.__enums__)&&$e(e),e},Je||(Je=e("Enum",{})),Je.isEnum=function(e){return e&&e.hasOwnProperty("__enums__")},Je.getList=function(e){return Ze(e),e.__enums__?e.__enums__:$e(e)},b.Enum=Je;var tt=e("ValueType",function(){function e(){}var t=e.prototype;return t.clone=function(){return Y(100,Se(this)+".clone"),this},t.equals=function(){return!1},t.set=function(){Y(100,Se(this)+".set")},t.toString=function(){return""},e}());Ge("cc.ValueType",tt),b.ValueType=tt;var nt=e("macro",{SUPPORT_TEXTURE_FORMATS:[".astc",".pkm",".pvr",".webp",".jpg",".jpeg",".bmp",".png"],KEY:{none:0,back:6,menu:18,backspace:8,tab:9,enter:13,shift:16,ctrl:17,alt:18,pause:19,capslock:20,escape:27,space:32,pageup:33,pagedown:34,end:35,home:36,left:37,up:38,right:39,down:40,select:41,insert:45,Delete:46,0:48,1:49,2:50,3:51,4:52,5:53,6:54,7:55,8:56,9:57,a:65,b:66,c:67,d:68,e:69,f:70,g:71,h:72,i:73,j:74,k:75,l:76,m:77,n:78,o:79,p:80,q:81,r:82,s:83,t:84,u:85,v:86,w:87,x:88,y:89,z:90,num0:96,num1:97,num2:98,num3:99,num4:100,num5:101,num6:102,num7:103,num8:104,num9:105,"*":106,"+":107,"-":109,numdel:110,"/":111,f1:112,f2:113,f3:114,f4:115,f5:116,f6:117,f7:118,f8:119,f9:120,f10:121,f11:122,f12:123,numlock:144,scrolllock:145,";":186,semicolon:186,equal:187,"=":187,",":188,comma:188,dash:189,".":190,period:190,forwardslash:191,grave:192,"[":219,openbracket:219,backslash:220,"]":221,closebracket:221,quote:222,dpadLeft:1e3,dpadRight:1001,dpadUp:1003,dpadDown:1004,dpadCenter:1005},RAD:Math.PI/180,DEG:180/Math.PI,REPEAT_FOREVER:Number.MAX_VALUE-1,FLT_EPSILON:1.192092896e-7,ORIENTATION_PORTRAIT:1,ORIENTATION_LANDSCAPE:2,ORIENTATION_AUTO:3,ENABLE_TILEDMAP_CULLING:!0,TOUCH_TIMEOUT:5e3,ENABLE_TRANSPARENT_CANVAS:!1,ENABLE_WEBGL_ANTIALIAS:!0,ENABLE_ANTIALIAS_FXAA:!1,ENABLE_BLOOM:!1,CLEANUP_IMAGE_CACHE:!1,ENABLE_MULTI_TOUCH:!0,MAX_LABEL_CANVAS_POOL_SIZE:20,ENABLE_WEBGL_HIGHP_STRUCT_VALUES:!1,BATCHER2D_MEM_INCREMENT:144});b.macro=nt;for(var it=/^(?:cc|dragonBones|sp|ccsg)\..+/,rt=new Array(123),ot=0;ot<123;++ot)rt[ot]=64;for(var at=0;at<64;++at)rt["ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charCodeAt(at)]=at;var st=rt;function ct(e,t,n){function i(e,t,n,i){var r=Object.getOwnPropertyDescriptor(e,t);if(r)r.get&&(e[n]=r.get),r.set&&i&&(e[i]=r.set);else{var o=e[n];ve(e,t,o,e[i])}}for(var r,o=e.prototype,a=0;a<t.length;a++){var s=(r=t[a])[0].toUpperCase()+r.slice(1);i(o,r,"get"+s,"set"+s)}for(r in n){var c=n[r];i(o,r,c[0],c[1])}}function lt(e,t,n,i){var r=e[t];r?Array.isArray(r)?i?(r.push(r[0]),r[0]=n):r.push(n):e[t]=i?[n,r]:[r,n]:e[t]=n}function ut(e,t){if("function"==typeof e.contains)return e.contains(t);if("function"==typeof e.compareDocumentPosition)return!!(16&e.compareDocumentPosition(t));var n=t.parentNode;if(n)do{if(n===e)return!0;n=n.parentNode}while(null!==n);return!1}function ht(e){return"object"==typeof window&&"function"==typeof Node?e instanceof Node:e&&"object"==typeof e&&"number"==typeof e.nodeType&&"string"==typeof e.nodeName}function _t(e,t,n){e&&setTimeout((function(){e(t,n)}),0)}function ft(e){return!(!e||e.constructor!==Object)&&de(e)}function dt(e,t,n){if(t>n){var i=t;t=n,n=i}return e<t?t:e<n?e:n}function pt(e){return e*nt.RAD}function mt(e){return e*nt.DEG}b.misc={BUILTIN_CLASSID_RE:it,BASE64_VALUES:st,propertyDefine:ct,pushToMap:lt,contains:ut,isDomNode:ht,callInNextTick:_t,isPlainEmptyObj_DEV:ft,clampf:dt,degreesToRadians:pt,radiansToDegrees:mt},e("misc",Object.freeze({__proto__:null,BUILTIN_CLASSID_RE:it,BASE64_VALUES:st,propertyDefine:ct,pushToMap:lt,contains:ut,isDomNode:ht,callInNextTick:_t,tryCatchFunctor_EDITOR:function(e){return Function("target","try {\n  target."+e+"();\n}\ncatch (e) {\n  cc._throw(e);\n}")},isPlainEmptyObj_DEV:ft,clampf:dt,degreesToRadians:pt,radiansToDegrees:mt}));var vt="$_$";function gt(e,t){var n=t?Object.create(t):{};return me(e,"__attrs__",n),n}function yt(e){if("function"!=typeof e)return gt(e,St(e.constructor));for(var t,n=b.Class.getInheritanceChain(e),i=n.length-1;i>=0;i--){var r=n[i];r.hasOwnProperty("__attrs__")&&r.__attrs__||gt(r,(t=n[i+1])&&t.__attrs__)}return gt(e,(t=n[0])&&t.__attrs__),e.__attrs__}function xt(e,t){var n=St(e),i=t+vt,r={};for(var o in n)o.startsWith(i)&&(r[o.slice(i.length)]=n[o]);return r}function St(e){return e.hasOwnProperty("__attrs__")&&e.__attrs__||yt(e)}function Et(e,t,n,i){St(e)[t+vt+n]=i}var Tt=function(){function e(e,t){this.name=void 0,this.default=void 0,this.name=e,this.default=t}return e.prototype.toString=function(){return this.name},e}(),Ct=e("CCInteger",new Tt("Integer",0));b.Integer=Ct,b.CCInteger=Ct;var bt=e("CCFloat",new Tt("Float",0));b.Float=bt,b.CCFloat=bt;var At=e("CCBoolean",new Tt("Boolean",!1));b.Boolean=At,b.CCBoolean=At;var wt=e("CCString",new Tt("String",""));function It(e,t){return function(n,i){var r='"'+Se(n)+"."+i+'"',o=xt(n,i),a=o.type;if(a===Ct||a===bt?a="Number":a!==wt&&a!==At||(a=""+a),a===e){if(o.hasOwnProperty("default")){var s=o.default;if(void 0!==s&&!Array.isArray(s)&&!ft(s)){var c=typeof s,l=e.toLowerCase();if(c===l)if("object"===l){if(!s||s instanceof o.ctor)return;q(3605,r,Se(o.ctor))}else"Number"!==e&&q(3606,t,r,e);else{if("function"===c)return;e===wt.default&&null==s?q(3607,r):q(3611,t,r,c)}delete o.type}}}else q(3604,r)}}b.String=wt,b.CCString=wt;var Pt=Object.freeze({__proto__:null,DELIMETER:vt,createAttrsSingle:gt,createAttrs:yt,attr:xt,getClassAttrs:St,setClassAttr:Et,PrimitiveType:Tt,CCInteger:Ct,CCFloat:bt,CCBoolean:At,CCString:wt,getTypeChecker_ET:It,getObjTypeChecker_ET:function(e){return function(t,n){It("Object","type")(t,n);var i=St(t)[n+vt+"default"],r=b.Class.getDefault(i);if(!Array.isArray(r)&&Me(e,b.ValueType)){var o=Se(e),a=Ae('No need to specify the "type" of "%s.%s" because %s is a child class of ValueType.',Se(t),n,o);i?L(a):q(3612,a,o,Se(t),n,o)}}}}),Rt={default:{},serializable:{},editorOnly:{},formerlySerializedAs:{}};function Dt(e,t,n,i){if(!e.get&&!e.set&&e.hasOwnProperty("default")){var r="_N$"+t;e.get=function(){return this[r]},e.set=function(e){var t=this[r];this[r]=e,n.call(this,t)};var o={};for(var a in i[r]=o,Rt){var s=Rt[a];e.hasOwnProperty(a)&&(o[a]=e[a],s.canUsedInGet||delete e[a])}}}function Ot(e,t,n,i){if(Array.isArray(t)){if(!(t.length>0))return Y(5508,n,i);e.type=t=t[0]}"function"==typeof t&&(t===String?e.type=b.String:t===Boolean?e.type=b.Boolean:t===Number&&(e.type=b.Float))}function Nt(e,t,n){var i=e?{_short:!0}:{_short:!0,default:t};return n&&(i.type=n),i}function Mt(e,t){if(!e||e.constructor!==Object){if(Array.isArray(e)&&e.length>0)return Nt(t,[],e);if("function"==typeof e){var n=e;return Nt(t,Me(n,b.ValueType)?new n:null,n)}return Nt(t,e instanceof Tt?e.default:e)}return null}var Lt,Ft=[];function Bt(){return Ft[Ft.length-1]}b._RF={push:function(e,t,n,i){void 0===n&&(n=t,t=""),Ft.push({uuid:t,script:n,module:e,exports:e.exports,beh:null,importMeta:i})},pop:function(){var e=Ft.pop(),t=e.module,n=t.exports;if(n===e.exports){for(var i in n)return;t.exports=n=e.cls}},peek:Bt},function(e){e[e.STANDALONE=1]="STANDALONE",e[e.IMPLICIT_VISIBLE=2]="IMPLICIT_VISIBLE",e[e.IMPLICIT_SERIALIZABLE=4]="IMPLICIT_SERIALIZABLE"}(Lt||(Lt={}));var zt=vt,Ut={datas:null,push:function(e){if(this.datas)this.datas.push(e);else{this.datas=[e];var t=this;setTimeout((function(){t.init()}),0)}},init:function(){var e=this.datas;if(e){for(var t=0;t<e.length;++t){var n=e[t],i=n.cls,r=n.props;"function"==typeof r&&(r=r());var o=Se(i);r?Wt(i,o,r,i.$super,n.mixins):Y(3633,o)}this.datas=null}}};function kt(e,t,n,i){!function(e,t){!function(e,t){e.indexOf(t)<0&&e.push(t)}(e.__props__,t)}(e,n),Yt(e,i,t,n)}function Gt(e,t,n,i){var r=i.get;i.set,r&&(Yt(e,i,t,n),Et(e,n,"serializable",!1))}function Ht(e){return"function"==typeof e?e():e}function Vt(e,t,n){for(var i in t)e.hasOwnProperty(i)||n&&!n(i)||Object.defineProperty(e,i,Ie(t,i))}function Wt(e,t,n,i,r){if(e.__props__=[],i&&i.__props__&&(e.__props__=i.__props__.slice()),r)for(var o=0;o<r.length;++o){var a=r[o];a.__props__&&(e.__props__=e.__props__.concat(a.__props__.filter((function(t){return e.__props__.indexOf(t)<0}))))}if(n)for(var s in function(e,t){for(var n in e){var i=e[n],r=Mt(i,!1);if(r&&(i=e[n]=r),i){var o=i.notify;o&&Dt(i,n,o,e),"type"in i&&Ot(i,i.type,t,n)}}}(n,t),n){var c=n[s];c.get||c.set?Gt(e,t,s,c):kt(e,t,s,c)}var l=St(e);e.__values__=e.__props__.filter((function(e){return!1!==l[e+zt+"serializable"]}))}function jt(e){var t=e.name,n=e.extends,i=e.mixins,r=function(e,t,n,i){var r=b.Component,o=Bt();if(o&&Me(t,r)){if(Me(o.cls,r))return Y(3615),null;e=e||o.script}var a=function(e,t,n,i){var r=i.ctor,o=[r],a=r;me(a,"__ctors__",o.length>0?o:null,!0);var s=a.prototype;if(t&&(a.$super=t),n){for(var c=n.length-1;c>=0;c--){var l=n[c];Vt(s,l.prototype),jt._isCCClass(l)&&Vt(St(a),St(l))}s.constructor=a}return Ge(e,a),a}(e,t,n,i);if(o)if(Me(t,r)){var s=o.uuid;s&&Ue(s,a),o.cls=a}else Me(o.cls,r)||(o.cls=a);return a}(t,n,i,e);t||(t=b.js.getClassName(r)),r._sealed=!0,n&&(n._sealed=!1);var o=e.properties;"function"==typeof o||n&&null===n.__props__||i&&i.some((function(e){return null===e.__props__}))?(Ut.push({cls:r,props:o,mixins:i}),r.__props__=r.__values__=null):Wt(r,t,o,n,e.mixins);var a=e.editor;return a&&Me(n,b.Component)&&b.Component._registerEditorProps(r,a),r}function qt(e){var t;return null==e||null===(t=e.hasOwnProperty)||void 0===t?void 0:t.call(e,"__values__")}jt._isCCClass=function(e){var t;return null==e||null===(t=e.hasOwnProperty)||void 0===t?void 0:t.call(e,"__ctors__")},jt.fastDefine=function(e,t,n){Ge(e,t);for(var i=t.__props__=t.__values__=Object.keys(n),r=St(t),o=0;o<i.length;o++){var a=i[o];r[a+zt+"visible"]=!1,r[a+zt+"default"]=n[a]}},jt.Attr=Pt,jt.attr=xt,jt.getInheritanceChain=function(e){for(var t=[];e=Ne(e);)e!==Object&&t.push(e);return t};var Xt={Integer:"Number",Float:"Number",Boolean:"Boolean",String:"String"};function Yt(e,t,n,i){var r=null,o="";function a(){return o=i+zt,r=St(e)}"type"in t&&void 0===t.type&&q(3660,i,n);var s=t.type;s&&(Xt[s]?(r||a())[o+"type"]=s:"Object"===s||("object"==typeof s?Je.isEnum(s)?((r||a())[o+"type"]="Enum",r[o+"enumList"]=Je.getList(s)):Qe.isBitMask(s)&&((r||a())[o+"type"]="BitMask",r[o+"bitmaskList"]=Qe.getList(s)):"function"==typeof s&&((r||a())[o+"type"]="Object",r[o+"ctor"]=s))),"default"in t&&((r||a())[o+"default"]=t.default);var c,l=function(e,n){if(e in t){var i=t[e];typeof i===n&&((r||a())[o+e]=i)}};t.editorOnly&&((r||a())[o+"editorOnly"]=!0),t.__internalFlags&Lt.STANDALONE?c=!0===t.serializable||0!=(t.__internalFlags&Lt.IMPLICIT_SERIALIZABLE):!1===t.serializable&&(c=!1),void 0!==c&&((r||a())[o+"serializable"]=c),l("formerlySerializedAs","string");var u=t.range;u&&Array.isArray(u)&&u.length>=2&&((r||a())[o+"min"]=u[0],r[o+"max"]=u[1],u.length>2&&(r[o+"step"]=u[2])),l("min","number"),l("max","number"),l("step","number")}jt.isArray=function(e){return e=Ht(e),Array.isArray(e)},jt.getDefault=Ht,jt.escapeForJS=function(e){return JSON.stringify(e).replace(/\u2028/g,"\\u2028").replace(/\u2029/g,"\\u2029")},jt.IDENTIFIER_RE=/^[A-Za-z_$][0-9A-Za-z_$]*$/,jt.getNewValueTypeCode=function(e){for(var t=Se(e),n=e.constructor,i="new "+t+"(",r=0;r<n.__props__.length;r++)i+=e[n.__props__[r]],r<n.__props__.length-1&&(i+=",");return i+")"},b.Class=jt;var Kt=Math.PI/180,Qt=180/Math.PI,Jt=e("EPSILON",1e-6);function Zt(e,t){return Math.abs(e-t)<=Jt*Math.max(1,Math.abs(e),Math.abs(t))}function $t(e,t,n){return n=n||Jt,Math.abs(e-t)<=n}function en(e,t,n){if(t>n){var i=t;t=n,n=i}return e<t?t:e>n?n:e}function tn(e){return e<0?0:e>1?1:e}function nn(e,t,n){return e+(t-e)*n}function rn(e){return e*Kt}function on(e){return e*Qt}var an=e("random",Math.random);function sn(e,t){return Math.random()*(t-e)+e}function cn(e,t){return Math.floor(sn(e,t))}function ln(e){return(e=(9301*e+49297)%233280)/233280}function un(e,t,n){return ln(e)*(n-t)+t}function hn(e,t,n){return Math.floor(un(e,t,n))}function _n(e){return--e,e|=e>>1,e|=e>>2,e|=e>>4,e|=e>>8,e|=e>>16,++e}function fn(e,t){return e-Math.floor(e/t)*t}function dn(e,t){return e=fn(e,2*t),t-Math.abs(e-t)}function pn(e,t,n){return(n-e)/(t-e)}function mn(e){return Math.abs(e.x)>Math.abs(e.y)?Math.abs(e.x)>Math.abs(e.z)?e.x:e.z:Math.abs(e.y)>Math.abs(e.z)?e.y:e.z}function vn(e,t){return Math.abs(e)>Math.abs(t)?e:t}function gn(e,t){t.forEach((function(t){Object.defineProperty(e,t,{enumerable:!0})}))}var yn=e("Vec3",function(e){function t(t,n,i){var r;return r=e.call(this)||this,t&&"object"==typeof t?(r.x=t.x,r.y=t.y,r.z=t.z):(r.x=t||0,r.y=n||0,r.z=i||0),r}f(t,e),t.zero=function(e){return e.x=0,e.y=0,e.z=0,e},t.clone=function(e){return new t(e.x,e.y,e.z)},t.copy=function(e,t){return e.x=t.x,e.y=t.y,e.z=t.z,e},t.set=function(e,t,n,i){return e.x=t,e.y=n,e.z=i,e},t.add=function(e,t,n){return e.x=t.x+n.x,e.y=t.y+n.y,e.z=t.z+n.z,e},t.subtract=function(e,t,n){return e.x=t.x-n.x,e.y=t.y-n.y,e.z=t.z-n.z,e},t.multiply=function(e,t,n){return e.x=t.x*n.x,e.y=t.y*n.y,e.z=t.z*n.z,e},t.divide=function(e,t,n){return e.x=t.x/n.x,e.y=t.y/n.y,e.z=t.z/n.z,e},t.ceil=function(e,t){return e.x=Math.ceil(t.x),e.y=Math.ceil(t.y),e.z=Math.ceil(t.z),e},t.floor=function(e,t){return e.x=Math.floor(t.x),e.y=Math.floor(t.y),e.z=Math.floor(t.z),e},t.min=function(e,t,n){return e.x=Math.min(t.x,n.x),e.y=Math.min(t.y,n.y),e.z=Math.min(t.z,n.z),e},t.max=function(e,t,n){return e.x=Math.max(t.x,n.x),e.y=Math.max(t.y,n.y),e.z=Math.max(t.z,n.z),e},t.round=function(e,t){return e.x=Math.round(t.x),e.y=Math.round(t.y),e.z=Math.round(t.z),e},t.multiplyScalar=function(e,t,n){return e.x=t.x*n,e.y=t.y*n,e.z=t.z*n,e},t.scaleAndAdd=function(e,t,n,i){return e.x=t.x+n.x*i,e.y=t.y+n.y*i,e.z=t.z+n.z*i,e},t.distance=function(e,t){var n=t.x-e.x,i=t.y-e.y,r=t.z-e.z;return Math.sqrt(n*n+i*i+r*r)},t.squaredDistance=function(e,t){var n=t.x-e.x,i=t.y-e.y,r=t.z-e.z;return n*n+i*i+r*r},t.len=function(e){var t=e.x,n=e.y,i=e.z;return Math.sqrt(t*t+n*n+i*i)},t.lengthSqr=function(e){var t=e.x,n=e.y,i=e.z;return t*t+n*n+i*i},t.negate=function(e,t){return e.x=-t.x,e.y=-t.y,e.z=-t.z,e},t.invert=function(e,t){return e.x=1/t.x,e.y=1/t.y,e.z=1/t.z,e},t.invertSafe=function(e,t){var n=t.x,i=t.y,r=t.z;return Math.abs(n)<Jt?e.x=0:e.x=1/n,Math.abs(i)<Jt?e.y=0:e.y=1/i,Math.abs(r)<Jt?e.z=0:e.z=1/r,e},t.normalize=function(e,t){var n=t.x,i=t.y,r=t.z,o=n*n+i*i+r*r;return o>0&&(o=1/Math.sqrt(o),e.x=n*o,e.y=i*o,e.z=r*o),e},t.dot=function(e,t){return e.x*t.x+e.y*t.y+e.z*t.z},t.cross=function(e,t,n){var i=t.x,r=t.y,o=t.z,a=n.x,s=n.y,c=n.z;return e.x=r*c-o*s,e.y=o*a-i*c,e.z=i*s-r*a,e},t.lerp=function(e,t,n,i){return e.x=t.x+i*(n.x-t.x),e.y=t.y+i*(n.y-t.y),e.z=t.z+i*(n.z-t.z),e},t.random=function(e,t){t=t||1;var n=2*an()*Math.PI,i=2*an()-1,r=Math.sqrt(1-i*i);return e.x=r*Math.cos(n)*t,e.y=r*Math.sin(n)*t,e.z=i*t,e},t.transformMat4=function(e,t,n){var i=t.x,r=t.y,o=t.z,a=n.m03*i+n.m07*r+n.m11*o+n.m15;return a=a?Math.abs(1/a):1,e.x=(n.m00*i+n.m04*r+n.m08*o+n.m12)*a,e.y=(n.m01*i+n.m05*r+n.m09*o+n.m13)*a,e.z=(n.m02*i+n.m06*r+n.m10*o+n.m14)*a,e},t.transformMat4Normal=function(e,t,n){var i=t.x,r=t.y,o=t.z,a=n.m03*i+n.m07*r+n.m11*o;return a=a?Math.abs(1/a):1,e.x=(n.m00*i+n.m04*r+n.m08*o)*a,e.y=(n.m01*i+n.m05*r+n.m09*o)*a,e.z=(n.m02*i+n.m06*r+n.m10*o)*a,e},t.transformMat3=function(e,t,n){var i=t.x,r=t.y,o=t.z;return e.x=i*n.m00+r*n.m03+o*n.m06,e.y=i*n.m01+r*n.m04+o*n.m07,e.z=i*n.m02+r*n.m05+o*n.m08,e},t.transformAffine=function(e,t,n){var i=t.x,r=t.y,o=t.z;return e.x=n.m00*i+n.m04*r+n.m08*o+n.m12,e.y=n.m01*i+n.m05*r+n.m09*o+n.m13,e.z=n.m02*i+n.m06*r+n.m10*o+n.m14,e},t.transformQuat=function(e,t,n){var i=n.w*t.x+n.y*t.z-n.z*t.y,r=n.w*t.y+n.z*t.x-n.x*t.z,o=n.w*t.z+n.x*t.y-n.y*t.x,a=-n.x*t.x-n.y*t.y-n.z*t.z;return e.x=i*n.w+a*-n.x+r*-n.z-o*-n.y,e.y=r*n.w+a*-n.y+o*-n.x-i*-n.z,e.z=o*n.w+a*-n.z+i*-n.y-r*-n.x,e},t.transformRTS=function(e,t,n,i,r){var o=t.x*r.x,a=t.y*r.y,s=t.z*r.z,c=n.w*o+n.y*s-n.z*a,l=n.w*a+n.z*o-n.x*s,u=n.w*s+n.x*a-n.y*o,h=-n.x*o-n.y*a-n.z*s;return e.x=c*n.w+h*-n.x+l*-n.z-u*-n.y+i.x,e.y=l*n.w+h*-n.y+u*-n.x-c*-n.z+i.y,e.z=u*n.w+h*-n.z+c*-n.y-l*-n.x+i.z,e},t.transformInverseRTS=function(e,t,n,i,r){var o=t.x-i.x,a=t.y-i.y,s=t.z-i.z,c=n.w*o-n.y*s+n.z*a,l=n.w*a-n.z*o+n.x*s,u=n.w*s-n.x*a+n.y*o,h=n.x*o+n.y*a+n.z*s;return e.x=(c*n.w+h*n.x+l*n.z-u*n.y)/r.x,e.y=(l*n.w+h*n.y+u*n.x-c*n.z)/r.y,e.z=(u*n.w+h*n.z+c*n.y-l*n.x)/r.z,e},t.rotateX=function(e,t,n,i){var r=t.x-n.x,o=t.y-n.y,a=t.z-n.z,s=Math.cos(i),c=Math.sin(i),l=r,u=o*s-a*c,h=o*c+a*s;return e.x=l+n.x,e.y=u+n.y,e.z=h+n.z,e},t.rotateY=function(e,t,n,i){var r=t.x-n.x,o=t.y-n.y,a=t.z-n.z,s=Math.cos(i),c=Math.sin(i),l=a*c+r*s,u=o,h=a*s-r*c;return e.x=l+n.x,e.y=u+n.y,e.z=h+n.z,e},t.rotateZ=function(e,t,n,i){var r=t.x-n.x,o=t.y-n.y,a=t.z-n.z,s=Math.cos(i),c=Math.sin(i),l=r*s-o*c,u=r*c+o*s,h=a;return e.x=l+n.x,e.y=u+n.y,e.z=h+n.z,e},t.toArray=function(e,t,n){return void 0===n&&(n=0),e[n+0]=t.x,e[n+1]=t.y,e[n+2]=t.z,e},t.fromArray=function(e,t,n){return void 0===n&&(n=0),e.x=t[n+0],e.y=t[n+1],e.z=t[n+2],e},t.strictEquals=function(e,t){return e.x===t.x&&e.y===t.y&&e.z===t.z},t.equals=function(e,t,n){void 0===n&&(n=Jt);var i=e.x,r=e.y,o=e.z,a=t.x,s=t.y,c=t.z;return Math.abs(i-a)<=n*Math.max(1,Math.abs(i),Math.abs(a))&&Math.abs(r-s)<=n*Math.max(1,Math.abs(r),Math.abs(s))&&Math.abs(o-c)<=n*Math.max(1,Math.abs(o),Math.abs(c))},t.angle=function(e,n){t.normalize(xn,e),t.normalize(Sn,n);var i=t.dot(xn,Sn);return i>1?0:i<-1?Math.PI:Math.acos(i)},t.projectOnPlane=function(e,n,i){return t.subtract(e,n,t.project(e,n,i))},t.project=function(e,n,i){var r=t.lengthSqr(i);return r<1e-6?t.set(e,0,0,0):t.multiplyScalar(e,i,t.dot(n,i)/r)};var n=t.prototype;return n.clone=function(){return new t(this.x,this.y,this.z)},n.set=function(e,t,n){return e&&"object"==typeof e?(this.x=e.x,this.y=e.y,this.z=e.z):(this.x=e||0,this.y=t||0,this.z=n||0),this},n.equals=function(e,t){return void 0===t&&(t=Jt),Math.abs(this.x-e.x)<=t*Math.max(1,Math.abs(this.x),Math.abs(e.x))&&Math.abs(this.y-e.y)<=t*Math.max(1,Math.abs(this.y),Math.abs(e.y))&&Math.abs(this.z-e.z)<=t*Math.max(1,Math.abs(this.z),Math.abs(e.z))},n.equals3f=function(e,t,n,i){return void 0===i&&(i=Jt),Math.abs(this.x-e)<=i*Math.max(1,Math.abs(this.x),Math.abs(e))&&Math.abs(this.y-t)<=i*Math.max(1,Math.abs(this.y),Math.abs(t))&&Math.abs(this.z-n)<=i*Math.max(1,Math.abs(this.z),Math.abs(n))},n.strictEquals=function(e){return this.x===e.x&&this.y===e.y&&this.z===e.z},n.strictEquals3f=function(e,t,n){return this.x===e&&this.y===t&&this.z===n},n.toString=function(){return"("+this.x.toFixed(2)+", "+this.y.toFixed(2)+", "+this.z.toFixed(2)+")"},n.lerp=function(e,t){return this.x+=t*(e.x-this.x),this.y+=t*(e.y-this.y),this.z+=t*(e.z-this.z),this},n.add=function(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this},n.add3f=function(e,t,n){return this.x+=e,this.y+=t,this.z+=n,this},n.subtract=function(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this},n.subtract3f=function(e,t,n){return this.x-=e,this.y-=t,this.z-=n,this},n.multiplyScalar=function(e){return"object"==typeof e&&console.warn("should use Vec3.multiply for vector * vector operation"),this.x*=e,this.y*=e,this.z*=e,this},n.multiply=function(e){return"object"!=typeof e&&console.warn("should use Vec3.scale for vector * scalar operation"),this.x*=e.x,this.y*=e.y,this.z*=e.z,this},n.multiply3f=function(e,t,n){return this.x*=e,this.y*=t,this.z*=n,this},n.divide=function(e){return this.x/=e.x,this.y/=e.y,this.z/=e.z,this},n.divide3f=function(e,t,n){return this.x/=e,this.y/=t,this.z/=n,this},n.negative=function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this},n.clampf=function(e,t){return this.x=en(this.x,e.x,t.x),this.y=en(this.y,e.y,t.y),this.z=en(this.z,e.z,t.z),this},n.dot=function(e){return this.x*e.x+this.y*e.y+this.z*e.z},n.cross=function(e){var t=this.x,n=this.y,i=this.z,r=e.x,o=e.y,a=e.z;return this.x=n*a-i*o,this.y=i*r-t*a,this.z=t*o-n*r,this},n.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},n.lengthSqr=function(){return this.x*this.x+this.y*this.y+this.z*this.z},n.normalize=function(){var e=this.x,t=this.y,n=this.z,i=e*e+t*t+n*n;return i>0&&(i=1/Math.sqrt(i),this.x=e*i,this.y=t*i,this.z=n*i),this},n.transformMat4=function(e){var t=this.x,n=this.y,i=this.z,r=e.m03*t+e.m07*n+e.m11*i+e.m15;return r=r?1/r:1,this.x=(e.m00*t+e.m04*n+e.m08*i+e.m12)*r,this.y=(e.m01*t+e.m05*n+e.m09*i+e.m13)*r,this.z=(e.m02*t+e.m06*n+e.m10*i+e.m14)*r,this},t}(tt));yn.UNIT_X=Object.freeze(new yn(1,0,0)),yn.UNIT_Y=Object.freeze(new yn(0,1,0)),yn.UNIT_Z=Object.freeze(new yn(0,0,1)),yn.RIGHT=Object.freeze(new yn(1,0,0)),yn.UP=Object.freeze(new yn(0,1,0)),yn.FORWARD=Object.freeze(new yn(0,0,-1)),yn.ZERO=Object.freeze(new yn(0,0,0)),yn.ONE=Object.freeze(new yn(1,1,1)),yn.NEG_ONE=Object.freeze(new yn(-1,-1,-1));var xn=new yn,Sn=new yn;function En(e,t,n){return new yn(e,t,n)}jt.fastDefine("cc.Vec3",yn,{x:0,y:0,z:0}),b.Vec3=yn,b.v3=En;var Tn=e("Vec2",function(e){function t(t,n){var i;return i=e.call(this)||this,t&&"object"==typeof t?(i.x=t.x,i.y=t.y):(i.x=t||0,i.y=n||0),i}f(t,e),t.clone=function(e){return new t(e.x,e.y)},t.copy=function(e,t){return e.x=t.x,e.y=t.y,e},t.set=function(e,t,n){return e.x=t,e.y=n,e},t.add=function(e,t,n){return e.x=t.x+n.x,e.y=t.y+n.y,e},t.subtract=function(e,t,n){return e.x=t.x-n.x,e.y=t.y-n.y,e},t.multiply=function(e,t,n){return e.x=t.x*n.x,e.y=t.y*n.y,e},t.divide=function(e,t,n){return e.x=t.x/n.x,e.y=t.y/n.y,e},t.ceil=function(e,t){return e.x=Math.ceil(t.x),e.y=Math.ceil(t.y),e},t.floor=function(e,t){return e.x=Math.floor(t.x),e.y=Math.floor(t.y),e},t.min=function(e,t,n){return e.x=Math.min(t.x,n.x),e.y=Math.min(t.y,n.y),e},t.max=function(e,t,n){return e.x=Math.max(t.x,n.x),e.y=Math.max(t.y,n.y),e},t.round=function(e,t){return e.x=Math.round(t.x),e.y=Math.round(t.y),e},t.multiplyScalar=function(e,t,n){return e.x=t.x*n,e.y=t.y*n,e},t.scaleAndAdd=function(e,t,n,i){return e.x=t.x+n.x*i,e.y=t.y+n.y*i,e},t.distance=function(e,t){var n=t.x-e.x,i=t.y-e.y;return Math.sqrt(n*n+i*i)},t.squaredDistance=function(e,t){var n=t.x-e.x,i=t.y-e.y;return n*n+i*i},t.len=function(e){var t=e.x,n=e.y;return Math.sqrt(t*t+n*n)},t.lengthSqr=function(e){var t=e.x,n=e.y;return t*t+n*n},t.negate=function(e,t){return e.x=-t.x,e.y=-t.y,e},t.inverse=function(e,t){return e.x=1/t.x,e.y=1/t.y,e},t.inverseSafe=function(e,t){var n=t.x,i=t.y;return Math.abs(n)<Jt?e.x=0:e.x=1/n,Math.abs(i)<Jt?e.y=0:e.y=1/i,e},t.normalize=function(e,t){var n=t.x,i=t.y,r=n*n+i*i;return r>0&&(r=1/Math.sqrt(r),e.x=n*r,e.y=i*r),e},t.dot=function(e,t){return e.x*t.x+e.y*t.y},t.cross=function(e,t,n){return e instanceof yn?(e.x=e.y=0,e.z=t.x*n.y-t.y*n.x,e):e.x*t.y-e.y*t.x},t.lerp=function(e,t,n,i){var r=t.x,o=t.y;return e.x=r+i*(n.x-r),e.y=o+i*(n.y-o),e},t.random=function(e,t){t=t||1;var n=2*an()*Math.PI;return e.x=Math.cos(n)*t,e.y=Math.sin(n)*t,e},t.transformMat3=function(e,t,n){var i=t.x,r=t.y;return e.x=n.m00*i+n.m03*r+n.m06,e.y=n.m01*i+n.m04*r+n.m07,e},t.transformMat4=function(e,t,n){var i=t.x,r=t.y;return e.x=n.m00*i+n.m04*r+n.m12,e.y=n.m01*i+n.m05*r+n.m13,e},t.str=function(e){return"Vec2("+e.x+", "+e.y+")"},t.toArray=function(e,t,n){return void 0===n&&(n=0),e[n+0]=t.x,e[n+1]=t.y,e},t.fromArray=function(e,t,n){return void 0===n&&(n=0),e.x=t[n+0],e.y=t[n+1],e},t.strictEquals=function(e,t){return e.x===t.x&&e.y===t.y},t.equals=function(e,t,n){return void 0===n&&(n=Jt),Math.abs(e.x-t.x)<=n*Math.max(1,Math.abs(e.x),Math.abs(t.x))&&Math.abs(e.y-t.y)<=n*Math.max(1,Math.abs(e.y),Math.abs(t.y))},t.angle=function(e,n){t.normalize(Cn,e),t.normalize(bn,n);var i=t.dot(Cn,bn);return i>1?0:i<-1?Math.PI:Math.acos(i)};var n=t.prototype;return n.clone=function(){return new t(this.x,this.y)},n.set=function(e,t){return e&&"object"==typeof e?(this.x=e.x,this.y=e.y):(this.x=e||0,this.y=t||0),this},n.equals=function(e,t){return void 0===t&&(t=Jt),Math.abs(this.x-e.x)<=t*Math.max(1,Math.abs(this.x),Math.abs(e.x))&&Math.abs(this.y-e.y)<=t*Math.max(1,Math.abs(this.y),Math.abs(e.y))},n.equals2f=function(e,t,n){return void 0===n&&(n=Jt),Math.abs(this.x-e)<=n*Math.max(1,Math.abs(this.x),Math.abs(e))&&Math.abs(this.y-t)<=n*Math.max(1,Math.abs(this.y),Math.abs(t))},n.strictEquals=function(e){return e&&this.x===e.x&&this.y===e.y},n.strictEquals2f=function(e,t){return this.x===e&&this.y===t},n.toString=function(){return"("+this.x.toFixed(2)+", "+this.y.toFixed(2)+")"},n.lerp=function(e,t){var n=this.x,i=this.y;return this.x=n+t*(e.x-n),this.y=i+t*(e.y-i),this},n.clampf=function(e,t){return this.x=en(this.x,e.x,t.x),this.y=en(this.y,e.y,t.y),this},n.add=function(e){return this.x+=e.x,this.y+=e.y,this},n.add2f=function(e,t){return this.x+=e,this.y+=t,this},n.subtract=function(e){return this.x-=e.x,this.y-=e.y,this},n.subtract2f=function(e,t){return this.x-=e,this.y-=t,this},n.multiplyScalar=function(e){return"object"==typeof e&&console.warn("should use Vec2.multiply for vector * vector operation"),this.x*=e,this.y*=e,this},n.multiply=function(e){return"object"!=typeof e&&console.warn("should use Vec2.scale for vector * scalar operation"),this.x*=e.x,this.y*=e.y,this},n.multiply2f=function(e,t){return this.x*=e,this.y*=t,this},n.divide=function(e){return this.x/=e.x,this.y/=e.y,this},n.divide2f=function(e,t){return this.x/=e,this.y/=t,this},n.negative=function(){return this.x=-this.x,this.y=-this.y,this},n.dot=function(e){return this.x*e.x+this.y*e.y},n.cross=function(e){return this.x*e.y-this.y*e.x},n.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y)},n.lengthSqr=function(){return this.x*this.x+this.y*this.y},n.normalize=function(){var e=this.x,t=this.y,n=e*e+t*t;return n>0&&(n=1/Math.sqrt(n),this.x*=n,this.y*=n),this},n.angle=function(e){var t=this.lengthSqr(),n=e.lengthSqr();if(0===t||0===n)return console.warn("Can't get angle between zero vector"),0;var i=this.dot(e)/Math.sqrt(t*n);return i=en(i,-1,1),Math.acos(i)},n.signAngle=function(e){var t=this.angle(e);return this.cross(e)<0?-t:t},n.rotate=function(e){var t=this.x,n=this.y,i=Math.sin(e),r=Math.cos(e);return this.x=r*t-i*n,this.y=i*t+r*n,this},n.project=function(e){var t=this.dot(e)/e.dot(e);return this.x=e.x*t,this.y=e.y*t,this},n.transformMat4=function(e){var t=this.x,n=this.y;return this.x=e.m00*t+e.m04*n+e.m12,this.y=e.m01*t+e.m05*n+e.m13,this},t}(tt));Tn.ZERO=Object.freeze(new Tn(0,0)),Tn.ONE=Object.freeze(new Tn(1,1)),Tn.NEG_ONE=Object.freeze(new Tn(-1,-1)),Tn.UNIT_X=Object.freeze(new Tn(1,0)),Tn.UNIT_Y=Object.freeze(new Tn(0,1));var Cn=new Tn,bn=new Tn;function An(e,t){return new Tn(e,t)}jt.fastDefine("cc.Vec2",Tn,{x:0,y:0}),b.Vec2=Tn,b.v2=An;var wn=e("Vec4",function(e){function t(t,n,i,r){var o;return o=e.call(this)||this,t&&"object"==typeof t?(o.x=t.x,o.y=t.y,o.z=t.z,o.w=t.w):(o.x=t||0,o.y=n||0,o.z=i||0,o.w=r||0),o}f(t,e),t.clone=function(e){return new t(e.x,e.y,e.z,e.w)},t.copy=function(e,t){return e.x=t.x,e.y=t.y,e.z=t.z,e.w=t.w,e},t.set=function(e,t,n,i,r){return e.x=t,e.y=n,e.z=i,e.w=r,e},t.add=function(e,t,n){return e.x=t.x+n.x,e.y=t.y+n.y,e.z=t.z+n.z,e.w=t.w+n.w,e},t.subtract=function(e,t,n){return e.x=t.x-n.x,e.y=t.y-n.y,e.z=t.z-n.z,e.w=t.w-n.w,e},t.multiply=function(e,t,n){return e.x=t.x*n.x,e.y=t.y*n.y,e.z=t.z*n.z,e.w=t.w*n.w,e},t.divide=function(e,t,n){return e.x=t.x/n.x,e.y=t.y/n.y,e.z=t.z/n.z,e.w=t.w/n.w,e},t.ceil=function(e,t){return e.x=Math.ceil(t.x),e.y=Math.ceil(t.y),e.z=Math.ceil(t.z),e.w=Math.ceil(t.w),e},t.floor=function(e,t){return e.x=Math.floor(t.x),e.y=Math.floor(t.y),e.z=Math.floor(t.z),e.w=Math.floor(t.w),e},t.min=function(e,t,n){return e.x=Math.min(t.x,n.x),e.y=Math.min(t.y,n.y),e.z=Math.min(t.z,n.z),e.w=Math.min(t.w,n.w),e},t.max=function(e,t,n){return e.x=Math.max(t.x,n.x),e.y=Math.max(t.y,n.y),e.z=Math.max(t.z,n.z),e.w=Math.max(t.w,n.w),e},t.round=function(e,t){return e.x=Math.round(t.x),e.y=Math.round(t.y),e.z=Math.round(t.z),e.w=Math.round(t.w),e},t.multiplyScalar=function(e,t,n){return e.x=t.x*n,e.y=t.y*n,e.z=t.z*n,e.w=t.w*n,e},t.scaleAndAdd=function(e,t,n,i){return e.x=t.x+n.x*i,e.y=t.y+n.y*i,e.z=t.z+n.z*i,e.w=t.w+n.w*i,e},t.distance=function(e,t){var n=t.x-e.x,i=t.y-e.y,r=t.z-e.z,o=t.w-e.w;return Math.sqrt(n*n+i*i+r*r+o*o)},t.squaredDistance=function(e,t){var n=t.x-e.x,i=t.y-e.y,r=t.z-e.z,o=t.w-e.w;return n*n+i*i+r*r+o*o},t.len=function(e){var t=e.x,n=e.y,i=e.z,r=e.w;return Math.sqrt(t*t+n*n+i*i+r*r)},t.lengthSqr=function(e){var t=e.x,n=e.y,i=e.z,r=e.w;return t*t+n*n+i*i+r*r},t.negate=function(e,t){return e.x=-t.x,e.y=-t.y,e.z=-t.z,e.w=-t.w,e},t.inverse=function(e,t){return e.x=1/t.x,e.y=1/t.y,e.z=1/t.z,e.w=1/t.w,e},t.inverseSafe=function(e,t){var n=t.x,i=t.y,r=t.z,o=t.w;return Math.abs(n)<Jt?e.x=0:e.x=1/n,Math.abs(i)<Jt?e.y=0:e.y=1/i,Math.abs(r)<Jt?e.z=0:e.z=1/r,Math.abs(o)<Jt?e.w=0:e.w=1/o,e},t.normalize=function(e,t){var n=t.x,i=t.y,r=t.z,o=t.w,a=n*n+i*i+r*r+o*o;return a>0&&(a=1/Math.sqrt(a),e.x=n*a,e.y=i*a,e.z=r*a,e.w=o*a),e},t.dot=function(e,t){return e.x*t.x+e.y*t.y+e.z*t.z+e.w*t.w},t.lerp=function(e,t,n,i){return e.x=t.x+i*(n.x-t.x),e.y=t.y+i*(n.y-t.y),e.z=t.z+i*(n.z-t.z),e.w=t.w+i*(n.w-t.w),e},t.random=function(e,t){t=t||1;var n=2*an()*Math.PI,i=2*an()-1,r=Math.sqrt(1-i*i);return e.x=r*Math.cos(n)*t,e.y=r*Math.sin(n)*t,e.z=i*t,e.w=0,e},t.transformMat4=function(e,t,n){var i=t.x,r=t.y,o=t.z,a=t.w;return e.x=n.m00*i+n.m04*r+n.m08*o+n.m12*a,e.y=n.m01*i+n.m05*r+n.m09*o+n.m13*a,e.z=n.m02*i+n.m06*r+n.m10*o+n.m14*a,e.w=n.m03*i+n.m07*r+n.m11*o+n.m15*a,e},t.transformAffine=function(e,t,n){var i=t.x,r=t.y,o=t.z,a=t.w;return e.x=n.m00*i+n.m04*r+n.m08*o+n.m12*a,e.y=n.m01*i+n.m05*r+n.m09*o+n.m13*a,e.z=n.m02*i+n.m06*r+n.m10*o+n.m14*a,e.w=t.w,e},t.transformQuat=function(e,t,n){var i=t.x,r=t.y,o=t.z,a=n.x,s=n.y,c=n.z,l=n.w,u=l*i+s*o-c*r,h=l*r+c*i-a*o,_=l*o+a*r-s*i,f=-a*i-s*r-c*o;return e.x=u*l+f*-a+h*-c-_*-s,e.y=h*l+f*-s+_*-a-u*-c,e.z=_*l+f*-c+u*-s-h*-a,e.w=t.w,e},t.toArray=function(e,t,n){return void 0===n&&(n=0),e[n+0]=t.x,e[n+1]=t.y,e[n+2]=t.z,e[n+3]=t.w,e},t.fromArray=function(e,t,n){return void 0===n&&(n=0),e.x=t[n+0],e.y=t[n+1],e.z=t[n+2],e.w=t[n+3],e},t.strictEquals=function(e,t){return e.x===t.x&&e.y===t.y&&e.z===t.z&&e.w===t.w},t.equals=function(e,t,n){return void 0===n&&(n=Jt),Math.abs(e.x-t.x)<=n*Math.max(1,Math.abs(e.x),Math.abs(t.x))&&Math.abs(e.y-t.y)<=n*Math.max(1,Math.abs(e.y),Math.abs(t.y))&&Math.abs(e.z-t.z)<=n*Math.max(1,Math.abs(e.z),Math.abs(t.z))&&Math.abs(e.w-t.w)<=n*Math.max(1,Math.abs(e.w),Math.abs(t.w))};var n=t.prototype;return n.clone=function(){return new t(this.x,this.y,this.z,this.w)},n.set=function(e,t,n,i){return e&&"object"==typeof e?(this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w):(this.x=e||0,this.y=t||0,this.z=n||0,this.w=i||0),this},n.equals=function(e,t){return void 0===t&&(t=Jt),Math.abs(this.x-e.x)<=t*Math.max(1,Math.abs(this.x),Math.abs(e.x))&&Math.abs(this.y-e.y)<=t*Math.max(1,Math.abs(this.y),Math.abs(e.y))&&Math.abs(this.z-e.z)<=t*Math.max(1,Math.abs(this.z),Math.abs(e.z))&&Math.abs(this.w-e.w)<=t*Math.max(1,Math.abs(this.w),Math.abs(e.w))},n.equals4f=function(e,t,n,i,r){return void 0===r&&(r=Jt),Math.abs(this.x-e)<=r*Math.max(1,Math.abs(this.x),Math.abs(e))&&Math.abs(this.y-t)<=r*Math.max(1,Math.abs(this.y),Math.abs(t))&&Math.abs(this.z-n)<=r*Math.max(1,Math.abs(this.z),Math.abs(n))&&Math.abs(this.w-i)<=r*Math.max(1,Math.abs(this.w),Math.abs(i))},n.strictEquals=function(e){return this.x===e.x&&this.y===e.y&&this.z===e.z&&this.w===e.w},n.strictEquals4f=function(e,t,n,i){return this.x===e&&this.y===t&&this.z===n&&this.w===i},n.lerp=function(e,t){var n=this.x,i=this.y,r=this.z,o=this.w;return this.x=n+t*(e.x-n),this.y=i+t*(e.y-i),this.z=r+t*(e.z-r),this.w=o+t*(e.w-o),this},n.toString=function(){return"("+this.x.toFixed(2)+", "+this.y.toFixed(2)+", "+this.z.toFixed(2)+", "+this.w.toFixed(2)+")"},n.clampf=function(e,t){return this.x=en(this.x,e.x,t.x),this.y=en(this.y,e.y,t.y),this.z=en(this.z,e.z,t.z),this.w=en(this.w,e.w,t.w),this},n.add=function(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this.w+=e.w,this},n.add4f=function(e,t,n,i){return this.x+=e,this.y+=t,this.z+=n,this.w+=i,this},n.subtract=function(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this.w-=e.w,this},n.subtract4f=function(e,t,n,i){return this.x-=e,this.y-=t,this.z-=n,this.w-=i,this},n.multiplyScalar=function(e){return"object"==typeof e&&console.warn("should use Vec4.multiply for vector * vector operation"),this.x*=e,this.y*=e,this.z*=e,this.w*=e,this},n.multiply=function(e){return"object"!=typeof e&&console.warn("should use Vec4.scale for vector * scalar operation"),this.x*=e.x,this.y*=e.y,this.z*=e.z,this.w*=e.w,this},n.multiply4f=function(e,t,n,i){return this.x*=e,this.y*=t,this.z*=n,this.w*=i,this},n.divide=function(e){return this.x/=e.x,this.y/=e.y,this.z/=e.z,this.w/=e.w,this},n.divide4f=function(e,t,n,i){return this.x/=e,this.y/=t,this.z/=n,this.w/=i,this},n.negative=function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this.w=-this.w,this},n.dot=function(e){return this.x*e.x+this.y*e.y+this.z*e.z+this.w*e.w},n.cross=function(e){var t=this.x,n=this.y,i=this.z,r=e.x,o=e.y,a=e.z;return this.x=n*a-i*o,this.y=i*r-t*a,this.z=t*o-n*r,this},n.length=function(){var e=this.x,t=this.y,n=this.z,i=this.w;return Math.sqrt(e*e+t*t+n*n+i*i)},n.lengthSqr=function(){var e=this.x,t=this.y,n=this.z,i=this.w;return e*e+t*t+n*n+i*i},n.normalize=function(){var e=this.x,t=this.y,n=this.z,i=this.w,r=e*e+t*t+n*n+i*i;return r>0&&(r=1/Math.sqrt(r),this.x=e*r,this.y=t*r,this.z=n*r,this.w=i*r),this},n.transformMat4=function(e){var t=this.x,n=this.y,i=this.z,r=this.w;return this.x=e.m00*t+e.m04*n+e.m08*i+e.m12*r,this.y=e.m01*t+e.m05*n+e.m09*i+e.m13*r,this.z=e.m02*t+e.m06*n+e.m10*i+e.m14*r,this.w=e.m03*t+e.m07*n+e.m11*i+e.m15*r,this},t}(tt));function In(e,t,n,i){return new wn(e,t,n,i)}wn.ZERO=Object.freeze(new wn(0,0,0,0)),wn.ONE=Object.freeze(new wn(1,1,1,1)),wn.NEG_ONE=Object.freeze(new wn(-1,-1,-1,-1)),jt.fastDefine("cc.Vec4",wn,{x:0,y:0,z:0,w:0}),b.Vec4=wn,b.v4=In;var Pn=e("Mat3",function(e){function t(t,n,i,r,o,a,s,c,l){var u;return void 0===t&&(t=1),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===o&&(o=1),void 0===a&&(a=0),void 0===s&&(s=0),void 0===c&&(c=0),void 0===l&&(l=1),u=e.call(this)||this,"object"==typeof t?(u.m00=t.m00,u.m01=t.m01,u.m02=t.m02,u.m03=t.m03,u.m04=t.m04,u.m05=t.m05,u.m06=t.m06,u.m07=t.m07,u.m08=t.m08):(u.m00=t,u.m01=n,u.m02=i,u.m03=r,u.m04=o,u.m05=a,u.m06=s,u.m07=c,u.m08=l),u}f(t,e),t.clone=function(e){return new t(e.m00,e.m01,e.m02,e.m03,e.m04,e.m05,e.m06,e.m07,e.m08)},t.copy=function(e,t){return e.m00=t.m00,e.m01=t.m01,e.m02=t.m02,e.m03=t.m03,e.m04=t.m04,e.m05=t.m05,e.m06=t.m06,e.m07=t.m07,e.m08=t.m08,e},t.set=function(e,t,n,i,r,o,a,s,c,l){return e.m00=t,e.m01=n,e.m02=i,e.m03=r,e.m04=o,e.m05=a,e.m06=s,e.m07=c,e.m08=l,e},t.identity=function(e){return e.m00=1,e.m01=0,e.m02=0,e.m03=0,e.m04=1,e.m05=0,e.m06=0,e.m07=0,e.m08=1,e},t.transpose=function(e,t){if(e===t){var n=t.m01,i=t.m02,r=t.m05;e.m01=t.m03,e.m02=t.m06,e.m03=n,e.m05=t.m07,e.m06=i,e.m07=r}else e.m00=t.m00,e.m01=t.m03,e.m02=t.m06,e.m03=t.m01,e.m04=t.m04,e.m05=t.m07,e.m06=t.m02,e.m07=t.m05,e.m08=t.m08;return e},t.invert=function(e,t){var n=t.m00,i=t.m01,r=t.m02,o=t.m03,a=t.m04,s=t.m05,c=t.m06,l=t.m07,u=t.m08,h=u*a-s*l,_=-u*o+s*c,f=l*o-a*c,d=n*h+i*_+r*f;return 0===d?(e.m00=0,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=0,e.m06=0,e.m07=0,e.m08=0,e):(d=1/d,e.m00=h*d,e.m01=(-u*i+r*l)*d,e.m02=(s*i-r*a)*d,e.m03=_*d,e.m04=(u*n-r*c)*d,e.m05=(-s*n+r*o)*d,e.m06=f*d,e.m07=(-l*n+i*c)*d,e.m08=(a*n-i*o)*d,e)},t.determinant=function(e){var t=e.m00,n=e.m01,i=e.m02,r=e.m03,o=e.m04,a=e.m05,s=e.m06,c=e.m07,l=e.m08;return t*(l*o-a*c)+n*(-l*r+a*s)+i*(c*r-o*s)},t.multiply=function(e,t,n){var i=t.m00,r=t.m01,o=t.m02,a=t.m03,s=t.m04,c=t.m05,l=t.m06,u=t.m07,h=t.m08,_=n.m00,f=n.m01,d=n.m02,p=n.m03,m=n.m04,v=n.m05,g=n.m06,y=n.m07,x=n.m08;return e.m00=_*i+f*a+d*l,e.m01=_*r+f*s+d*u,e.m02=_*o+f*c+d*h,e.m03=p*i+m*a+v*l,e.m04=p*r+m*s+v*u,e.m05=p*o+m*c+v*h,e.m06=g*i+y*a+x*l,e.m07=g*r+y*s+x*u,e.m08=g*o+y*c+x*h,e},t.multiplyMat4=function(e,t,n){var i=t.m00,r=t.m01,o=t.m02,a=t.m03,s=t.m04,c=t.m05,l=t.m06,u=t.m07,h=t.m08,_=n.m00,f=n.m01,d=n.m02,p=n.m04,m=n.m05,v=n.m06,g=n.m08,y=n.m09,x=n.m10;return e.m00=_*i+f*a+d*l,e.m01=_*r+f*s+d*u,e.m02=_*o+f*c+d*h,e.m03=p*i+m*a+v*l,e.m04=p*r+m*s+v*u,e.m05=p*o+m*c+v*h,e.m06=g*i+y*a+x*l,e.m07=g*r+y*s+x*u,e.m08=g*o+y*c+x*h,e},t.transform=function(e,t,n){var i=t.m00,r=t.m01,o=t.m02,a=t.m03,s=t.m04,c=t.m05,l=t.m06,u=t.m07,h=t.m08,_=n.x,f=n.y;return e.m00=i,e.m01=r,e.m02=o,e.m03=a,e.m04=s,e.m05=c,e.m06=_*i+f*a+l,e.m07=_*r+f*s+u,e.m08=_*o+f*c+h,e},t.scale=function(e,t,n){var i=n.x,r=n.y;return e.m00=i*t.m00,e.m01=i*t.m01,e.m02=i*t.m02,e.m03=r*t.m03,e.m04=r*t.m04,e.m05=r*t.m05,e.m06=t.m06,e.m07=t.m07,e.m08=t.m08,e},t.rotate=function(e,t,n){var i=t.m00,r=t.m01,o=t.m02,a=t.m03,s=t.m04,c=t.m05,l=t.m06,u=t.m07,h=t.m08,_=Math.sin(n),f=Math.cos(n);return e.m00=f*i+_*a,e.m01=f*r+_*s,e.m02=f*o+_*c,e.m03=f*a-_*i,e.m04=f*s-_*r,e.m05=f*c-_*o,e.m06=l,e.m07=u,e.m08=h,e},t.fromMat4=function(e,t){return e.m00=t.m00,e.m01=t.m01,e.m02=t.m02,e.m03=t.m04,e.m04=t.m05,e.m05=t.m06,e.m06=t.m08,e.m07=t.m09,e.m08=t.m10,e},t.fromViewUp=function(e,n,i){return yn.lengthSqr(n)<Jt*Jt?(t.identity(e),e):(i=i||yn.UNIT_Y,yn.normalize(Rn,yn.cross(Rn,i,n)),yn.lengthSqr(Rn)<Jt*Jt?(t.identity(e),e):(yn.cross(Dn,n,Rn),t.set(e,Rn.x,Rn.y,Rn.z,Dn.x,Dn.y,Dn.z,n.x,n.y,n.z),e))},t.fromTranslation=function(e,t){return e.m00=1,e.m01=0,e.m02=0,e.m03=0,e.m04=1,e.m05=0,e.m06=t.x,e.m07=t.y,e.m08=1,e},t.fromScaling=function(e,t){return e.m00=t.x,e.m01=0,e.m02=0,e.m03=0,e.m04=t.y,e.m05=0,e.m06=0,e.m07=0,e.m08=1,e},t.fromRotation=function(e,t){var n=Math.sin(t),i=Math.cos(t);return e.m00=i,e.m01=n,e.m02=0,e.m03=-n,e.m04=i,e.m05=0,e.m06=0,e.m07=0,e.m08=1,e},t.fromQuat=function(e,t){var n=t.x,i=t.y,r=t.z,o=t.w,a=n+n,s=i+i,c=r+r,l=n*a,u=i*a,h=i*s,_=r*a,f=r*s,d=r*c,p=o*a,m=o*s,v=o*c;return e.m00=1-h-d,e.m03=u-v,e.m06=_+m,e.m01=u+v,e.m04=1-l-d,e.m07=f-p,e.m02=_-m,e.m05=f+p,e.m08=1-l-h,e},t.inverseTransposeMat4=function(e,t){var n=t.m00,i=t.m01,r=t.m02,o=t.m03,a=t.m04,s=t.m05,c=t.m06,l=t.m07,u=t.m08,h=t.m09,_=t.m10,f=t.m11,d=t.m12,p=t.m13,m=t.m14,v=t.m15,g=n*s-i*a,y=n*c-r*a,x=n*l-o*a,S=i*c-r*s,E=i*l-o*s,T=r*l-o*c,C=u*p-h*d,b=u*m-_*d,A=u*v-f*d,w=h*m-_*p,I=h*v-f*p,P=_*v-f*m,R=g*P-y*I+x*w+S*A-E*b+T*C;return R?(R=1/R,e.m00=(s*P-c*I+l*w)*R,e.m01=(c*A-a*P-l*b)*R,e.m02=(a*I-s*A+l*C)*R,e.m03=(r*I-i*P-o*w)*R,e.m04=(n*P-r*A+o*b)*R,e.m05=(i*A-n*I-o*C)*R,e.m06=(p*T-m*E+v*S)*R,e.m07=(m*x-d*T-v*y)*R,e.m08=(d*E-p*x+v*g)*R,e):null},t.toArray=function(e,t,n){return void 0===n&&(n=0),e[n+0]=t.m00,e[n+1]=t.m01,e[n+2]=t.m02,e[n+3]=t.m03,e[n+4]=t.m04,e[n+5]=t.m05,e[n+6]=t.m06,e[n+7]=t.m07,e[n+8]=t.m08,e},t.fromArray=function(e,t,n){return void 0===n&&(n=0),e.m00=t[n+0],e.m01=t[n+1],e.m02=t[n+2],e.m03=t[n+3],e.m04=t[n+4],e.m05=t[n+5],e.m06=t[n+6],e.m07=t[n+7],e.m08=t[n+8],e},t.add=function(e,t,n){return e.m00=t.m00+n.m00,e.m01=t.m01+n.m01,e.m02=t.m02+n.m02,e.m03=t.m03+n.m03,e.m04=t.m04+n.m04,e.m05=t.m05+n.m05,e.m06=t.m06+n.m06,e.m07=t.m07+n.m07,e.m08=t.m08+n.m08,e},t.subtract=function(e,t,n){return e.m00=t.m00-n.m00,e.m01=t.m01-n.m01,e.m02=t.m02-n.m02,e.m03=t.m03-n.m03,e.m04=t.m04-n.m04,e.m05=t.m05-n.m05,e.m06=t.m06-n.m06,e.m07=t.m07-n.m07,e.m08=t.m08-n.m08,e},t.multiplyScalar=function(e,t,n){return e.m00=t.m00*n,e.m01=t.m01*n,e.m02=t.m02*n,e.m03=t.m03*n,e.m04=t.m04*n,e.m05=t.m05*n,e.m06=t.m06*n,e.m07=t.m07*n,e.m08=t.m08*n,e},t.multiplyScalarAndAdd=function(e,t,n,i){return e.m00=n.m00*i+t.m00,e.m01=n.m01*i+t.m01,e.m02=n.m02*i+t.m02,e.m03=n.m03*i+t.m03,e.m04=n.m04*i+t.m04,e.m05=n.m05*i+t.m05,e.m06=n.m06*i+t.m06,e.m07=n.m07*i+t.m07,e.m08=n.m08*i+t.m08,e},t.strictEquals=function(e,t){return e.m00===t.m00&&e.m01===t.m01&&e.m02===t.m02&&e.m03===t.m03&&e.m04===t.m04&&e.m05===t.m05&&e.m06===t.m06&&e.m07===t.m07&&e.m08===t.m08},t.equals=function(e,t,n){return void 0===n&&(n=Jt),Math.abs(e.m00-t.m00)<=n*Math.max(1,Math.abs(e.m00),Math.abs(t.m00))&&Math.abs(e.m01-t.m01)<=n*Math.max(1,Math.abs(e.m01),Math.abs(t.m01))&&Math.abs(e.m02-t.m02)<=n*Math.max(1,Math.abs(e.m02),Math.abs(t.m02))&&Math.abs(e.m03-t.m03)<=n*Math.max(1,Math.abs(e.m03),Math.abs(t.m03))&&Math.abs(e.m04-t.m04)<=n*Math.max(1,Math.abs(e.m04),Math.abs(t.m04))&&Math.abs(e.m05-t.m05)<=n*Math.max(1,Math.abs(e.m05),Math.abs(t.m05))&&Math.abs(e.m06-t.m06)<=n*Math.max(1,Math.abs(e.m06),Math.abs(t.m06))&&Math.abs(e.m07-t.m07)<=n*Math.max(1,Math.abs(e.m07),Math.abs(t.m07))&&Math.abs(e.m08-t.m08)<=n*Math.max(1,Math.abs(e.m08),Math.abs(t.m08))};var n=t.prototype;return n.clone=function(){var e=this;return new t(e.m00,e.m01,e.m02,e.m03,e.m04,e.m05,e.m06,e.m07,e.m08)},n.set=function(e,t,n,i,r,o,a,s,c){return void 0===e&&(e=1),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=1),void 0===o&&(o=0),void 0===a&&(a=0),void 0===s&&(s=0),void 0===c&&(c=1),"object"==typeof e?(this.m00=e.m00,this.m01=e.m01,this.m02=e.m02,this.m03=e.m03,this.m04=e.m04,this.m05=e.m05,this.m06=e.m06,this.m07=e.m07,this.m08=e.m08):(this.m00=e,this.m01=t,this.m02=n,this.m03=i,this.m04=r,this.m05=o,this.m06=a,this.m07=s,this.m08=c),this},n.equals=function(e,t){return void 0===t&&(t=Jt),Math.abs(this.m00-e.m00)<=t*Math.max(1,Math.abs(this.m00),Math.abs(e.m00))&&Math.abs(this.m01-e.m01)<=t*Math.max(1,Math.abs(this.m01),Math.abs(e.m01))&&Math.abs(this.m02-e.m02)<=t*Math.max(1,Math.abs(this.m02),Math.abs(e.m02))&&Math.abs(this.m03-e.m03)<=t*Math.max(1,Math.abs(this.m03),Math.abs(e.m03))&&Math.abs(this.m04-e.m04)<=t*Math.max(1,Math.abs(this.m04),Math.abs(e.m04))&&Math.abs(this.m05-e.m05)<=t*Math.max(1,Math.abs(this.m05),Math.abs(e.m05))&&Math.abs(this.m06-e.m06)<=t*Math.max(1,Math.abs(this.m06),Math.abs(e.m06))&&Math.abs(this.m07-e.m07)<=t*Math.max(1,Math.abs(this.m07),Math.abs(e.m07))&&Math.abs(this.m08-e.m08)<=t*Math.max(1,Math.abs(this.m08),Math.abs(e.m08))},n.strictEquals=function(e){return this.m00===e.m00&&this.m01===e.m01&&this.m02===e.m02&&this.m03===e.m03&&this.m04===e.m04&&this.m05===e.m05&&this.m06===e.m06&&this.m07===e.m07&&this.m08===e.m08},n.toString=function(){var e=this;return"[\n"+e.m00+", "+e.m01+", "+e.m02+",\n"+e.m03+",\n"+e.m04+", "+e.m05+",\n"+e.m06+", "+e.m07+",\n"+e.m08+"\n]"},n.identity=function(){return this.m00=1,this.m01=0,this.m02=0,this.m03=0,this.m04=1,this.m05=0,this.m06=0,this.m07=0,this.m08=1,this},n.transpose=function(){var e=this.m01,t=this.m02,n=this.m05;return this.m01=this.m03,this.m02=this.m06,this.m03=e,this.m05=this.m07,this.m06=t,this.m07=n,this},n.invert=function(){var e=this.m00,t=this.m01,n=this.m02,i=this.m03,r=this.m04,o=this.m05,a=this.m06,s=this.m07,c=this.m08,l=c*r-o*s,u=-c*i+o*a,h=s*i-r*a,_=e*l+t*u+n*h;return 0===_?(this.set(0,0,0,0,0,0,0,0,0),this):(_=1/_,this.m00=l*_,this.m01=(-c*t+n*s)*_,this.m02=(o*t-n*r)*_,this.m03=u*_,this.m04=(c*e-n*a)*_,this.m05=(-o*e+n*i)*_,this.m06=h*_,this.m07=(-s*e+t*a)*_,this.m08=(r*e-t*i)*_,this)},n.determinant=function(){var e=this.m00,t=this.m01,n=this.m02,i=this.m03,r=this.m04,o=this.m05,a=this.m06,s=this.m07,c=this.m08;return e*(c*r-o*s)+t*(-c*i+o*a)+n*(s*i-r*a)},n.add=function(e){return this.m00+=e.m00,this.m01+=e.m01,this.m02+=e.m02,this.m03+=e.m03,this.m04+=e.m04,this.m05+=e.m05,this.m06+=e.m06,this.m07+=e.m07,this.m08+=e.m08,this},n.subtract=function(e){return this.m00-=e.m00,this.m01-=e.m01,this.m02-=e.m02,this.m03-=e.m03,this.m04-=e.m04,this.m05-=e.m05,this.m06-=e.m06,this.m07-=e.m07,this.m08-=e.m08,this},n.multiply=function(e){var t=this.m00,n=this.m01,i=this.m02,r=this.m03,o=this.m04,a=this.m05,s=this.m06,c=this.m07,l=this.m08,u=e.m00,h=e.m01,_=e.m02,f=e.m03,d=e.m04,p=e.m05,m=e.m06,v=e.m07,g=e.m08;return this.m00=u*t+h*r+_*s,this.m01=u*n+h*o+_*c,this.m02=u*i+h*a+_*l,this.m03=f*t+d*r+p*s,this.m04=f*n+d*o+p*c,this.m05=f*i+d*a+p*l,this.m06=m*t+v*r+g*s,this.m07=m*n+v*o+g*c,this.m08=m*i+v*a+g*l,this},n.multiplyScalar=function(e){return this.m00*=e,this.m01*=e,this.m02*=e,this.m03*=e,this.m04*=e,this.m05*=e,this.m06*=e,this.m07*=e,this.m08*=e,this},n.scale=function(e){var t=e.x,n=e.y;return this.m00=t*this.m00,this.m01=t*this.m01,this.m02=t*this.m02,this.m03=n*this.m03,this.m04=n*this.m04,this.m05=n*this.m05,this.m06=this.m06,this.m07=this.m07,this.m08=this.m08,this},n.rotate=function(e){var t=this.m00,n=this.m01,i=this.m02,r=this.m03,o=this.m04,a=this.m05,s=this.m06,c=this.m07,l=this.m08,u=Math.sin(e),h=Math.cos(e);return this.m00=h*t+u*r,this.m01=h*n+u*o,this.m02=h*i+u*a,this.m03=h*r-u*t,this.m04=h*o-u*n,this.m05=h*a-u*i,this.m06=s,this.m07=c,this.m08=l,this},n.fromQuat=function(e){var t=e.x,n=e.y,i=e.z,r=e.w,o=t+t,a=n+n,s=i+i,c=t*o,l=n*o,u=n*a,h=i*o,_=i*a,f=i*s,d=r*o,p=r*a,m=r*s;return this.m00=1-u-f,this.m03=l-m,this.m06=h+p,this.m01=l+m,this.m04=1-c-f,this.m07=_-d,this.m02=h-p,this.m05=_+d,this.m08=1-c-u,this},t}(tt));Pn.IDENTITY=Object.freeze(new Pn);var Rn=new yn,Dn=new yn;jt.fastDefine("cc.Mat3",Pn,{m00:1,m01:0,m02:0,m03:0,m04:1,m05:0,m06:0,m07:0,m08:1}),b.Mat3=Pn;var On=e("Quat",function(e){function t(t,n,i,r){var o;return o=e.call(this)||this,t&&"object"==typeof t?(o.x=t.x,o.y=t.y,o.z=t.z,o.w=t.w):(o.x=t||0,o.y=n||0,o.z=i||0,o.w=null!=r?r:1),o}f(t,e),t.clone=function(e){return new t(e.x,e.y,e.z,e.w)},t.copy=function(e,t){return e.x=t.x,e.y=t.y,e.z=t.z,e.w=t.w,e},t.set=function(e,t,n,i,r){return e.x=t,e.y=n,e.z=i,e.w=r,e},t.identity=function(e){return e.x=0,e.y=0,e.z=0,e.w=1,e},t.rotationTo=function(e,n,i){var r=yn.dot(n,i);return r<-.999999?(yn.cross(Ln,yn.UNIT_X,n),Ln.length()<1e-6&&yn.cross(Ln,yn.UNIT_Y,n),yn.normalize(Ln,Ln),t.fromAxisAngle(e,Ln,Math.PI),e):r>.999999?(e.x=0,e.y=0,e.z=0,e.w=1,e):(yn.cross(Ln,n,i),e.x=Ln.x,e.y=Ln.y,e.z=Ln.z,e.w=1+r,t.normalize(e,e))},t.getAxisAngle=function(e,t){var n=2*Math.acos(t.w),i=Math.sin(n/2);return 0!==i?(e.x=t.x/i,e.y=t.y/i,e.z=t.z/i):(e.x=1,e.y=0,e.z=0),n},t.multiply=function(e,t,n){var i=t.x*n.w+t.w*n.x+t.y*n.z-t.z*n.y,r=t.y*n.w+t.w*n.y+t.z*n.x-t.x*n.z,o=t.z*n.w+t.w*n.z+t.x*n.y-t.y*n.x,a=t.w*n.w-t.x*n.x-t.y*n.y-t.z*n.z;return e.x=i,e.y=r,e.z=o,e.w=a,e},t.multiplyScalar=function(e,t,n){return e.x=t.x*n,e.y=t.y*n,e.z=t.z*n,e.w=t.w*n,e},t.scaleAndAdd=function(e,t,n,i){return e.x=t.x+n.x*i,e.y=t.y+n.y*i,e.z=t.z+n.z*i,e.w=t.w+n.w*i,e},t.rotateX=function(e,t,n){n*=.5;var i=Math.sin(n),r=Math.cos(n),o=t.x,a=t.y,s=t.z,c=t.w;return e.x=o*r+c*i,e.y=a*r+s*i,e.z=s*r-a*i,e.w=c*r-o*i,e},t.rotateY=function(e,t,n){n*=.5;var i=Math.sin(n),r=Math.cos(n),o=t.x,a=t.y,s=t.z,c=t.w;return e.x=o*r-s*i,e.y=a*r+c*i,e.z=s*r+o*i,e.w=c*r-a*i,e},t.rotateZ=function(e,t,n){n*=.5;var i=Math.sin(n),r=Math.cos(n),o=t.x,a=t.y,s=t.z,c=t.w;return e.x=o*r+a*i,e.y=a*r-o*i,e.z=s*r+c*i,e.w=c*r-s*i,e},t.rotateAround=function(e,n,i,r){return t.invert(Nn,n),yn.transformQuat(Ln,i,Nn),t.fromAxisAngle(Nn,Ln,r),t.multiply(e,n,Nn),e},t.rotateAroundLocal=function(e,n,i,r){return t.fromAxisAngle(Nn,i,r),t.multiply(e,n,Nn),e},t.calculateW=function(e,t){return e.x=t.x,e.y=t.y,e.z=t.z,e.w=Math.sqrt(Math.abs(1-t.x*t.x-t.y*t.y-t.z*t.z)),e},t.dot=function(e,t){return e.x*t.x+e.y*t.y+e.z*t.z+e.w*t.w},t.lerp=function(e,t,n,i){return e.x=t.x+i*(n.x-t.x),e.y=t.y+i*(n.y-t.y),e.z=t.z+i*(n.z-t.z),e.w=t.w+i*(n.w-t.w),e},t.slerp=function(e,t,n,i){var r=0,o=0,a=n.x,s=n.y,c=n.z,l=n.w,u=t.x*n.x+t.y*n.y+t.z*n.z+t.w*n.w;if(u<0&&(u=-u,a=-a,s=-s,c=-c,l=-l),1-u>1e-6){var h=Math.acos(u),_=Math.sin(h);r=Math.sin((1-i)*h)/_,o=Math.sin(i*h)/_}else r=1-i,o=i;return e.x=r*t.x+o*a,e.y=r*t.y+o*s,e.z=r*t.z+o*c,e.w=r*t.w+o*l,e},t.sqlerp=function(e,n,i,r,o,a){return t.slerp(Nn,n,o,a),t.slerp(Mn,i,r,a),t.slerp(e,Nn,Mn,2*a*(1-a)),e},t.invert=function(e,t){var n=t.x*t.x+t.y*t.y+t.z*t.z+t.w*t.w,i=n?1/n:0;return e.x=-t.x*i,e.y=-t.y*i,e.z=-t.z*i,e.w=t.w*i,e},t.conjugate=function(e,t){return e.x=-t.x,e.y=-t.y,e.z=-t.z,e.w=t.w,e},t.len=function(e){return Math.sqrt(e.x*e.x+e.y*e.y+e.z*e.z+e.w*e.w)},t.lengthSqr=function(e){return e.x*e.x+e.y*e.y+e.z*e.z+e.w*e.w},t.normalize=function(e,t){var n=t.x*t.x+t.y*t.y+t.z*t.z+t.w*t.w;return n>0&&(n=1/Math.sqrt(n),e.x=t.x*n,e.y=t.y*n,e.z=t.z*n,e.w=t.w*n),e},t.fromAxes=function(e,n,i,r){return Pn.set(Fn,n.x,n.y,n.z,i.x,i.y,i.z,r.x,r.y,r.z),t.normalize(e,t.fromMat3(e,Fn))},t.fromViewUp=function(e,n,i){return Pn.fromViewUp(Fn,n,i),t.normalize(e,t.fromMat3(e,Fn))},t.fromAxisAngle=function(e,t,n){n*=.5;var i=Math.sin(n);return e.x=i*t.x,e.y=i*t.y,e.z=i*t.z,e.w=Math.cos(n),e},t.fromMat3=function(e,t){var n=t.m00,i=t.m03,r=t.m06,o=t.m01,a=t.m04,s=t.m07,c=t.m02,l=t.m05,u=t.m08,h=n+a+u;if(h>0){var _=.5/Math.sqrt(h+1);e.w=.25/_,e.x=(l-s)*_,e.y=(r-c)*_,e.z=(o-i)*_}else if(n>a&&n>u){var f=2*Math.sqrt(1+n-a-u);e.w=(l-s)/f,e.x=.25*f,e.y=(i+o)/f,e.z=(r+c)/f}else if(a>u){var d=2*Math.sqrt(1+a-n-u);e.w=(r-c)/d,e.x=(i+o)/d,e.y=.25*d,e.z=(s+l)/d}else{var p=2*Math.sqrt(1+u-n-a);e.w=(o-i)/p,e.x=(r+c)/p,e.y=(s+l)/p,e.z=.25*p}return e},t.fromEuler=function(e,t,n,i){t*=Bn,n*=Bn,i*=Bn;var r=Math.sin(t),o=Math.cos(t),a=Math.sin(n),s=Math.cos(n),c=Math.sin(i),l=Math.cos(i);return e.x=r*s*l+o*a*c,e.y=o*a*l+r*s*c,e.z=o*s*c-r*a*l,e.w=o*s*l-r*a*c,e},t.fromAngleZ=function(e,t){return t*=Bn,e.x=e.y=0,e.z=Math.sin(t),e.w=Math.cos(t),e},t.toAxisX=function(e,t){var n=2*t.y,i=2*t.z;return e.x=1-n*t.y-i*t.z,e.y=n*t.x+i*t.w,e.z=i*t.x+n*t.w,e},t.toAxisY=function(e,t){var n=2*t.x,i=2*t.y,r=2*t.z;return e.x=i*t.x-r*t.w,e.y=1-n*t.x-r*t.z,e.z=r*t.y+n*t.w,e},t.toAxisZ=function(e,t){var n=2*t.x,i=2*t.y,r=2*t.z;return e.x=r*t.x-i*t.w,e.y=r*t.y-n*t.w,e.z=1-n*t.x-i*t.y,e},t.toEuler=function(e,t,n){var i=t.x,r=t.y,o=t.z,a=t.w,s=0,c=0,l=0,u=i*r+o*a;if(u>.499999)s=0,c=on(2*Math.atan2(i,a)),l=90;else if(u<-.499999)s=0,c=-on(2*Math.atan2(i,a)),l=-90;else{var h=i*i,_=r*r,f=o*o;s=on(Math.atan2(2*i*a-2*r*o,1-2*h-2*f)),c=on(Math.atan2(2*r*a-2*i*o,1-2*_-2*f)),l=on(Math.asin(2*u)),n&&(s=-180*Math.sign(s+1e-6)+s,c=-180*Math.sign(c+1e-6)+c,l=180*Math.sign(l+1e-6)-l)}return e.x=s,e.y=c,e.z=l,e},t.toArray=function(e,t,n){return void 0===n&&(n=0),e[n+0]=t.x,e[n+1]=t.y,e[n+2]=t.z,e[n+3]=t.w,e},t.fromArray=function(e,t,n){return void 0===n&&(n=0),e.x=t[n+0],e.y=t[n+1],e.z=t[n+2],e.w=t[n+3],e},t.strictEquals=function(e,t){return e.x===t.x&&e.y===t.y&&e.z===t.z&&e.w===t.w},t.equals=function(e,t,n){return void 0===n&&(n=Jt),Math.abs(e.x-t.x)<=n*Math.max(1,Math.abs(e.x),Math.abs(t.x))&&Math.abs(e.y-t.y)<=n*Math.max(1,Math.abs(e.y),Math.abs(t.y))&&Math.abs(e.z-t.z)<=n*Math.max(1,Math.abs(e.z),Math.abs(t.z))&&Math.abs(e.w-t.w)<=n*Math.max(1,Math.abs(e.w),Math.abs(t.w))};var n=t.prototype;return n.clone=function(){return new t(this.x,this.y,this.z,this.w)},n.set=function(e,t,n,i){return e&&"object"==typeof e?(this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w):(this.x=e||0,this.y=t||0,this.z=n||0,this.w=null!=i?i:1),this},n.equals=function(e,t){return void 0===t&&(t=Jt),Math.abs(this.x-e.x)<=t*Math.max(1,Math.abs(this.x),Math.abs(e.x))&&Math.abs(this.y-e.y)<=t*Math.max(1,Math.abs(this.y),Math.abs(e.y))&&Math.abs(this.z-e.z)<=t*Math.max(1,Math.abs(this.z),Math.abs(e.z))&&Math.abs(this.w-e.w)<=t*Math.max(1,Math.abs(this.w),Math.abs(e.w))},n.strictEquals=function(e){return e&&this.x===e.x&&this.y===e.y&&this.z===e.z&&this.w===e.w},n.getEulerAngles=function(e){return t.toEuler(e,this)},n.lerp=function(e,t){return this.x+=t*(e.x-this.x),this.y+=t*(e.y-this.y),this.z+=t*(e.z-this.z),this.w+=t*(e.w-this.w),this},n.slerp=function(e,n){return t.slerp(this,this,e,n)},n.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)},n.lengthSqr=function(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w},t}(tt));On.IDENTITY=Object.freeze(new On);var Nn=new On,Mn=new On,Ln=new yn,Fn=new Pn,Bn=.5*Math.PI/180;function zn(e,t,n,i){return void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=1),new On(e,t,n,i)}jt.fastDefine("cc.Quat",On,{x:0,y:0,z:0,w:1}),b.Quat=On,b.quat=zn;var Un=Object.freeze([Object.freeze([1,0,0,1]),Object.freeze([0,1,-1,0]),Object.freeze([-1,0,0,-1]),Object.freeze([0,-1,1,0])]),kn=e("Mat4",function(e){function t(t,n,i,r,o,a,s,c,l,u,h,_,f,d,p,m){var v;return void 0===t&&(t=1),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===o&&(o=0),void 0===a&&(a=1),void 0===s&&(s=0),void 0===c&&(c=0),void 0===l&&(l=0),void 0===u&&(u=0),void 0===h&&(h=1),void 0===_&&(_=0),void 0===f&&(f=0),void 0===d&&(d=0),void 0===p&&(p=0),void 0===m&&(m=1),(v=e.call(this)||this).m00=void 0,v.m01=void 0,v.m02=void 0,v.m03=void 0,v.m04=void 0,v.m05=void 0,v.m06=void 0,v.m07=void 0,v.m08=void 0,v.m09=void 0,v.m10=void 0,v.m11=void 0,v.m12=void 0,v.m13=void 0,v.m14=void 0,v.m15=void 0,"object"==typeof t?(v.m00=t.m00,v.m01=t.m01,v.m02=t.m02,v.m03=t.m03,v.m04=t.m04,v.m05=t.m05,v.m06=t.m06,v.m07=t.m07,v.m08=t.m08,v.m09=t.m09,v.m10=t.m10,v.m11=t.m11,v.m12=t.m12,v.m13=t.m13,v.m14=t.m14,v.m15=t.m15):(v.m00=t,v.m01=n,v.m02=i,v.m03=r,v.m04=o,v.m05=a,v.m06=s,v.m07=c,v.m08=l,v.m09=u,v.m10=h,v.m11=_,v.m12=f,v.m13=d,v.m14=p,v.m15=m),v}f(t,e),t.clone=function(e){return new t(e.m00,e.m01,e.m02,e.m03,e.m04,e.m05,e.m06,e.m07,e.m08,e.m09,e.m10,e.m11,e.m12,e.m13,e.m14,e.m15)},t.copy=function(e,t){return e.m00=t.m00,e.m01=t.m01,e.m02=t.m02,e.m03=t.m03,e.m04=t.m04,e.m05=t.m05,e.m06=t.m06,e.m07=t.m07,e.m08=t.m08,e.m09=t.m09,e.m10=t.m10,e.m11=t.m11,e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15,e},t.set=function(e,t,n,i,r,o,a,s,c,l,u,h,_,f,d,p,m){return e.m00=t,e.m01=n,e.m02=i,e.m03=r,e.m04=o,e.m05=a,e.m06=s,e.m07=c,e.m08=l,e.m09=u,e.m10=h,e.m11=_,e.m12=f,e.m13=d,e.m14=p,e.m15=m,e},t.identity=function(e){return e.m00=1,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=1,e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=1,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e},t.transpose=function(e,t){if(e===t){var n=t.m01,i=t.m02,r=t.m03,o=t.m06,a=t.m07,s=t.m11;e.m01=t.m04,e.m02=t.m08,e.m03=t.m12,e.m04=n,e.m06=t.m09,e.m07=t.m13,e.m08=i,e.m09=o,e.m11=t.m14,e.m12=r,e.m13=a,e.m14=s}else e.m00=t.m00,e.m01=t.m04,e.m02=t.m08,e.m03=t.m12,e.m04=t.m01,e.m05=t.m05,e.m06=t.m09,e.m07=t.m13,e.m08=t.m02,e.m09=t.m06,e.m10=t.m10,e.m11=t.m14,e.m12=t.m03,e.m13=t.m07,e.m14=t.m11,e.m15=t.m15;return e},t.invert=function(e,t){var n=t.m00,i=t.m01,r=t.m02,o=t.m03,a=t.m04,s=t.m05,c=t.m06,l=t.m07,u=t.m08,h=t.m09,_=t.m10,f=t.m11,d=t.m12,p=t.m13,m=t.m14,v=t.m15,g=n*s-i*a,y=n*c-r*a,x=n*l-o*a,S=i*c-r*s,E=i*l-o*s,T=r*l-o*c,C=u*p-h*d,b=u*m-_*d,A=u*v-f*d,w=h*m-_*p,I=h*v-f*p,P=_*v-f*m,R=g*P-y*I+x*w+S*A-E*b+T*C;return 0===R?(e.m00=0,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=0,e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=0,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=0,e):(R=1/R,e.m00=(s*P-c*I+l*w)*R,e.m01=(r*I-i*P-o*w)*R,e.m02=(p*T-m*E+v*S)*R,e.m03=(_*E-h*T-f*S)*R,e.m04=(c*A-a*P-l*b)*R,e.m05=(n*P-r*A+o*b)*R,e.m06=(m*x-d*T-v*y)*R,e.m07=(u*T-_*x+f*y)*R,e.m08=(a*I-s*A+l*C)*R,e.m09=(i*A-n*I-o*C)*R,e.m10=(d*E-p*x+v*g)*R,e.m11=(h*x-u*E-f*g)*R,e.m12=(s*b-a*w-c*C)*R,e.m13=(n*w-i*b+r*C)*R,e.m14=(p*y-d*S-m*g)*R,e.m15=(u*S-h*y+_*g)*R,e)},t.determinant=function(e){var t=e.m00,n=e.m01,i=e.m02,r=e.m03,o=e.m04,a=e.m05,s=e.m06,c=e.m07,l=e.m08,u=e.m09,h=e.m10,_=e.m11,f=e.m12,d=e.m13,p=e.m14,m=e.m15;return(t*a-n*o)*(h*m-_*p)-(t*s-i*o)*(u*m-_*d)+(t*c-r*o)*(u*p-h*d)+(n*s-i*a)*(l*m-_*f)-(n*c-r*a)*(l*p-h*f)+(i*c-r*s)*(l*d-u*f)},t.multiply=function(e,t,n){var i=t.m00,r=t.m01,o=t.m02,a=t.m03,s=t.m04,c=t.m05,l=t.m06,u=t.m07,h=t.m08,_=t.m09,f=t.m10,d=t.m11,p=t.m12,m=t.m13,v=t.m14,g=t.m15,y=n.m00,x=n.m01,S=n.m02,E=n.m03;return e.m00=y*i+x*s+S*h+E*p,e.m01=y*r+x*c+S*_+E*m,e.m02=y*o+x*l+S*f+E*v,e.m03=y*a+x*u+S*d+E*g,y=n.m04,x=n.m05,S=n.m06,E=n.m07,e.m04=y*i+x*s+S*h+E*p,e.m05=y*r+x*c+S*_+E*m,e.m06=y*o+x*l+S*f+E*v,e.m07=y*a+x*u+S*d+E*g,y=n.m08,x=n.m09,S=n.m10,E=n.m11,e.m08=y*i+x*s+S*h+E*p,e.m09=y*r+x*c+S*_+E*m,e.m10=y*o+x*l+S*f+E*v,e.m11=y*a+x*u+S*d+E*g,y=n.m12,x=n.m13,S=n.m14,E=n.m15,e.m12=y*i+x*s+S*h+E*p,e.m13=y*r+x*c+S*_+E*m,e.m14=y*o+x*l+S*f+E*v,e.m15=y*a+x*u+S*d+E*g,e},t.transform=function(e,t,n){var i=n.x,r=n.y,o=n.z;if(t===e)e.m12=t.m00*i+t.m04*r+t.m08*o+t.m12,e.m13=t.m01*i+t.m05*r+t.m09*o+t.m13,e.m14=t.m02*i+t.m06*r+t.m10*o+t.m14,e.m15=t.m03*i+t.m07*r+t.m11*o+t.m15;else{var a=t.m00,s=t.m01,c=t.m02,l=t.m03,u=t.m04,h=t.m05,_=t.m06,f=t.m07,d=t.m08,p=t.m09,m=t.m10,v=t.m11;t.m12,t.m13,t.m14,t.m15,e.m00=a,e.m01=s,e.m02=c,e.m03=l,e.m04=u,e.m05=h,e.m06=_,e.m07=f,e.m08=d,e.m09=p,e.m10=m,e.m11=v,e.m12=a*i+u*r+d*o+t.m12,e.m13=s*i+h*r+p*o+t.m13,e.m14=c*i+_*r+m*o+t.m14,e.m15=l*i+f*r+v*o+t.m15}return e},t.translate=function(e,t,n){return console.warn("function changed"),t===e?(e.m12+=n.x,e.m13+=n.y,e.m14+=n.z):(e.m00=t.m00,e.m01=t.m01,e.m02=t.m02,e.m03=t.m03,e.m04=t.m04,e.m05=t.m05,e.m06=t.m06,e.m07=t.m07,e.m08=t.m08,e.m09=t.m09,e.m10=t.m10,e.m11=t.m11,e.m12+=n.x,e.m13+=n.y,e.m14+=n.z,e.m15=t.m15),e},t.scale=function(e,t,n){var i=n.x,r=n.y,o=n.z;return e.m00=t.m00*i,e.m01=t.m01*i,e.m02=t.m02*i,e.m03=t.m03*i,e.m04=t.m04*r,e.m05=t.m05*r,e.m06=t.m06*r,e.m07=t.m07*r,e.m08=t.m08*o,e.m09=t.m09*o,e.m10=t.m10*o,e.m11=t.m11*o,e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15,e},t.rotate=function(e,t,n,i){var r=i.x,o=i.y,a=i.z,s=Math.sqrt(r*r+o*o+a*a);if(Math.abs(s)<Jt)return null;r*=s=1/s,o*=s,a*=s;var c=Math.sin(n),l=Math.cos(n),u=1-l,h=t.m00,_=t.m01,f=t.m02,d=t.m03,p=t.m04,m=t.m05,v=t.m06,g=t.m07,y=t.m08,x=t.m09,S=t.m10,E=t.m11,T=r*r*u+l,C=o*r*u+a*c,b=a*r*u-o*c,A=r*o*u-a*c,w=o*o*u+l,I=a*o*u+r*c,P=r*a*u+o*c,R=o*a*u-r*c,D=a*a*u+l;return e.m00=h*T+p*C+y*b,e.m01=_*T+m*C+x*b,e.m02=f*T+v*C+S*b,e.m03=d*T+g*C+E*b,e.m04=h*A+p*w+y*I,e.m05=_*A+m*w+x*I,e.m06=f*A+v*w+S*I,e.m07=d*A+g*w+E*I,e.m08=h*P+p*R+y*D,e.m09=_*P+m*R+x*D,e.m10=f*P+v*R+S*D,e.m11=d*P+g*R+E*D,t!==e&&(e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15),e},t.rotateX=function(e,t,n){var i=Math.sin(n),r=Math.cos(n),o=t.m04,a=t.m05,s=t.m06,c=t.m07,l=t.m08,u=t.m09,h=t.m10,_=t.m11;return t!==e&&(e.m00=t.m00,e.m01=t.m01,e.m02=t.m02,e.m03=t.m03,e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15),e.m04=o*r+l*i,e.m05=a*r+u*i,e.m06=s*r+h*i,e.m07=c*r+_*i,e.m08=l*r-o*i,e.m09=u*r-a*i,e.m10=h*r-s*i,e.m11=_*r-c*i,e},t.rotateY=function(e,t,n){var i=Math.sin(n),r=Math.cos(n),o=t.m00,a=t.m01,s=t.m02,c=t.m03,l=t.m08,u=t.m09,h=t.m10,_=t.m11;return t!==e&&(e.m04=t.m04,e.m05=t.m05,e.m06=t.m06,e.m07=t.m07,e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15),e.m00=o*r-l*i,e.m01=a*r-u*i,e.m02=s*r-h*i,e.m03=c*r-_*i,e.m08=o*i+l*r,e.m09=a*i+u*r,e.m10=s*i+h*r,e.m11=c*i+_*r,e},t.rotateZ=function(e,t,n){var i=Math.sin(n),r=Math.cos(n),o=t.m00,a=t.m01,s=t.m02,c=t.m03,l=t.m04,u=t.m05,h=t.m06,_=t.m07;return t!==e&&(e.m08=t.m08,e.m09=t.m09,e.m10=t.m10,e.m11=t.m11,e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15),e.m00=o*r+l*i,e.m01=a*r+u*i,e.m02=s*r+h*i,e.m03=c*r+_*i,e.m04=l*r-o*i,e.m05=u*r-a*i,e.m06=h*r-s*i,e.m07=_*r-c*i,e},t.fromTranslation=function(e,t){return e.m00=1,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=1,e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=1,e.m11=0,e.m12=t.x,e.m13=t.y,e.m14=t.z,e.m15=1,e},t.fromScaling=function(e,t){return e.m00=t.x,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=t.y,e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=t.z,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e},t.fromRotation=function(e,t,n){var i=n.x,r=n.y,o=n.z,a=Math.sqrt(i*i+r*r+o*o);if(Math.abs(a)<Jt)return null;i*=a=1/a,r*=a,o*=a;var s=Math.sin(t),c=Math.cos(t),l=1-c;return e.m00=i*i*l+c,e.m01=r*i*l+o*s,e.m02=o*i*l-r*s,e.m03=0,e.m04=i*r*l-o*s,e.m05=r*r*l+c,e.m06=o*r*l+i*s,e.m07=0,e.m08=i*o*l+r*s,e.m09=r*o*l-i*s,e.m10=o*o*l+c,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e},t.fromXRotation=function(e,t){var n=Math.sin(t),i=Math.cos(t);return e.m00=1,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=i,e.m06=n,e.m07=0,e.m08=0,e.m09=-n,e.m10=i,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e},t.fromYRotation=function(e,t){var n=Math.sin(t),i=Math.cos(t);return e.m00=i,e.m01=0,e.m02=-n,e.m03=0,e.m04=0,e.m05=1,e.m06=0,e.m07=0,e.m08=n,e.m09=0,e.m10=i,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e},t.fromZRotation=function(e,t){var n=Math.sin(t),i=Math.cos(t);return e.m00=i,e.m01=n,e.m02=0,e.m03=0,e.m04=-n,e.m05=i,e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=1,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e},t.fromRT=function(e,t,n){var i=t.x,r=t.y,o=t.z,a=t.w,s=i+i,c=r+r,l=o+o,u=i*s,h=i*c,_=i*l,f=r*c,d=r*l,p=o*l,m=a*s,v=a*c,g=a*l;return e.m00=1-(f+p),e.m01=h+g,e.m02=_-v,e.m03=0,e.m04=h-g,e.m05=1-(u+p),e.m06=d+m,e.m07=0,e.m08=_+v,e.m09=d-m,e.m10=1-(u+f),e.m11=0,e.m12=n.x,e.m13=n.y,e.m14=n.z,e.m15=1,e},t.getTranslation=function(e,t){return e.x=t.m12,e.y=t.m13,e.z=t.m14,e},t.getScaling=function(e,t){var n=Hn.m00=t.m00,i=Hn.m01=t.m01,r=Hn.m02=t.m02,o=Hn.m03=t.m04,a=Hn.m04=t.m05,s=Hn.m05=t.m06,c=Hn.m06=t.m08,l=Hn.m07=t.m09,u=Hn.m08=t.m10;return e.x=Math.sqrt(n*n+i*i+r*r),e.y=Math.sqrt(o*o+a*a+s*s),e.z=Math.sqrt(c*c+l*l+u*u),Pn.determinant(Hn)<0&&(e.x*=-1),e},t.getRotation=function(e,t){var n=t.m00+t.m05+t.m10,i=0;return n>0?(i=2*Math.sqrt(n+1),e.w=.25*i,e.x=(t.m06-t.m09)/i,e.y=(t.m08-t.m02)/i,e.z=(t.m01-t.m04)/i):t.m00>t.m05&&t.m00>t.m10?(i=2*Math.sqrt(1+t.m00-t.m05-t.m10),e.w=(t.m06-t.m09)/i,e.x=.25*i,e.y=(t.m01+t.m04)/i,e.z=(t.m08+t.m02)/i):t.m05>t.m10?(i=2*Math.sqrt(1+t.m05-t.m00-t.m10),e.w=(t.m08-t.m02)/i,e.x=(t.m01+t.m04)/i,e.y=.25*i,e.z=(t.m06+t.m09)/i):(i=2*Math.sqrt(1+t.m10-t.m00-t.m05),e.w=(t.m01-t.m04)/i,e.x=(t.m08+t.m02)/i,e.y=(t.m06+t.m09)/i,e.z=.25*i),e},t.toRTS=function(e,t,n,i){i.x=yn.set(Gn,e.m00,e.m01,e.m02).length(),Hn.m00=e.m00/i.x,Hn.m01=e.m01/i.x,Hn.m02=e.m02/i.x,i.y=yn.set(Gn,e.m04,e.m05,e.m06).length(),Hn.m03=e.m04/i.y,Hn.m04=e.m05/i.y,Hn.m05=e.m06/i.y,i.z=yn.set(Gn,e.m08,e.m09,e.m10).length(),Hn.m06=e.m08/i.z,Hn.m07=e.m09/i.z,Hn.m08=e.m10/i.z,Pn.determinant(Hn)<0&&(i.x*=-1,Hn.m00*=-1,Hn.m01*=-1,Hn.m02*=-1),On.fromMat3(t,Hn),yn.set(n,e.m12,e.m13,e.m14)},t.fromRTS=function(e,t,n,i){var r=t.x,o=t.y,a=t.z,s=t.w,c=r+r,l=o+o,u=a+a,h=r*c,_=r*l,f=r*u,d=o*l,p=o*u,m=a*u,v=s*c,g=s*l,y=s*u,x=i.x,S=i.y,E=i.z;return e.m00=(1-(d+m))*x,e.m01=(_+y)*x,e.m02=(f-g)*x,e.m03=0,e.m04=(_-y)*S,e.m05=(1-(h+m))*S,e.m06=(p+v)*S,e.m07=0,e.m08=(f+g)*E,e.m09=(p-v)*E,e.m10=(1-(h+d))*E,e.m11=0,e.m12=n.x,e.m13=n.y,e.m14=n.z,e.m15=1,e},t.fromRTSOrigin=function(e,t,n,i,r){var o=t.x,a=t.y,s=t.z,c=t.w,l=o+o,u=a+a,h=s+s,_=o*l,f=o*u,d=o*h,p=a*u,m=a*h,v=s*h,g=c*l,y=c*u,x=c*h,S=i.x,E=i.y,T=i.z,C=r.x,b=r.y,A=r.z;return e.m00=(1-(p+v))*S,e.m01=(f+x)*S,e.m02=(d-y)*S,e.m03=0,e.m04=(f-x)*E,e.m05=(1-(_+v))*E,e.m06=(m+g)*E,e.m07=0,e.m08=(d+y)*T,e.m09=(m-g)*T,e.m10=(1-(_+p))*T,e.m11=0,e.m12=n.x+C-(e.m00*C+e.m04*b+e.m08*A),e.m13=n.y+b-(e.m01*C+e.m05*b+e.m09*A),e.m14=n.z+A-(e.m02*C+e.m06*b+e.m10*A),e.m15=1,e},t.fromQuat=function(e,t){var n=t.x,i=t.y,r=t.z,o=t.w,a=n+n,s=i+i,c=r+r,l=n*a,u=i*a,h=i*s,_=r*a,f=r*s,d=r*c,p=o*a,m=o*s,v=o*c;return e.m00=1-h-d,e.m01=u+v,e.m02=_-m,e.m03=0,e.m04=u-v,e.m05=1-l-d,e.m06=f+p,e.m07=0,e.m08=_+m,e.m09=f-p,e.m10=1-l-h,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e},t.frustum=function(e,t,n,i,r,o,a){var s=1/(n-t),c=1/(r-i),l=1/(o-a);return e.m00=2*o*s,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=2*o*c,e.m06=0,e.m07=0,e.m08=(n+t)*s,e.m09=(r+i)*c,e.m10=(a+o)*l,e.m11=-1,e.m12=0,e.m13=0,e.m14=a*o*2*l,e.m15=0,e},t.perspective=function(e,t,n,i,r,o,a,s,c){void 0===o&&(o=!0),void 0===a&&(a=-1),void 0===s&&(s=1),void 0===c&&(c=0);var l=1/Math.tan(t/2),u=1/(i-r),h=o?l/n:l,_=(o?l:l*n)*s,f=Un[c];return e.m00=h*f[0],e.m01=h*f[1],e.m02=0,e.m03=0,e.m04=_*f[2],e.m05=_*f[3],e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=(r-a*i)*u,e.m11=-1,e.m12=0,e.m13=0,e.m14=r*i*u*(1-a),e.m15=0,e},t.ortho=function(e,t,n,i,r,o,a,s,c,l){void 0===s&&(s=-1),void 0===c&&(c=1),void 0===l&&(l=0);var u=1/(t-n),h=1/(i-r)*c,_=1/(o-a),f=-2*u,d=-2*h,p=(t+n)*u,m=(r+i)*h,v=Un[l];return e.m00=f*v[0],e.m01=f*v[1],e.m02=0,e.m03=0,e.m04=d*v[2],e.m05=d*v[3],e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=_*(1-s),e.m11=0,e.m12=p*v[0]+m*v[2],e.m13=p*v[1]+m*v[3],e.m14=(o-s*a)*_,e.m15=1,e},t.lookAt=function(e,t,n,i){var r=t.x,o=t.y,a=t.z,s=i.x,c=i.y,l=i.z,u=r-n.x,h=o-n.y,_=a-n.z,f=1/Math.sqrt(u*u+h*h+_*_),d=c*(_*=f)-l*(h*=f),p=l*(u*=f)-s*_,m=s*h-c*u,v=h*(m*=f=1/Math.sqrt(d*d+p*p+m*m))-_*(p*=f),g=_*(d*=f)-u*m,y=u*p-h*d;return e.m00=d,e.m01=v,e.m02=u,e.m03=0,e.m04=p,e.m05=g,e.m06=h,e.m07=0,e.m08=m,e.m09=y,e.m10=_,e.m11=0,e.m12=-(d*r+p*o+m*a),e.m13=-(v*r+g*o+y*a),e.m14=-(u*r+h*o+_*a),e.m15=1,e},t.inverseTranspose=function(e,t){var n=t.m00,i=t.m01,r=t.m02,o=t.m03,a=t.m04,s=t.m05,c=t.m06,l=t.m07,u=t.m08,h=t.m09,_=t.m10,f=t.m11,d=t.m12,p=t.m13,m=t.m14,v=t.m15,g=n*s-i*a,y=n*c-r*a,x=n*l-o*a,S=i*c-r*s,E=i*l-o*s,T=r*l-o*c,C=u*p-h*d,b=u*m-_*d,A=u*v-f*d,w=h*m-_*p,I=h*v-f*p,P=_*v-f*m,R=g*P-y*I+x*w+S*A-E*b+T*C;return R?(R=1/R,e.m00=(s*P-c*I+l*w)*R,e.m01=(c*A-a*P-l*b)*R,e.m02=(a*I-s*A+l*C)*R,e.m03=0,e.m04=(r*I-i*P-o*w)*R,e.m05=(n*P-r*A+o*b)*R,e.m06=(i*A-n*I-o*C)*R,e.m07=0,e.m08=(p*T-m*E+v*S)*R,e.m09=(m*x-d*T-v*y)*R,e.m10=(d*E-p*x+v*g)*R,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e):null},t.toArray=function(e,t,n){return void 0===n&&(n=0),e[n+0]=t.m00,e[n+1]=t.m01,e[n+2]=t.m02,e[n+3]=t.m03,e[n+4]=t.m04,e[n+5]=t.m05,e[n+6]=t.m06,e[n+7]=t.m07,e[n+8]=t.m08,e[n+9]=t.m09,e[n+10]=t.m10,e[n+11]=t.m11,e[n+12]=t.m12,e[n+13]=t.m13,e[n+14]=t.m14,e[n+15]=t.m15,e},t.fromArray=function(e,t,n){return void 0===n&&(n=0),e.m00=t[n+0],e.m01=t[n+1],e.m02=t[n+2],e.m03=t[n+3],e.m04=t[n+4],e.m05=t[n+5],e.m06=t[n+6],e.m07=t[n+7],e.m08=t[n+8],e.m09=t[n+9],e.m10=t[n+10],e.m11=t[n+11],e.m12=t[n+12],e.m13=t[n+13],e.m14=t[n+14],e.m15=t[n+15],e},t.add=function(e,t,n){return e.m00=t.m00+n.m00,e.m01=t.m01+n.m01,e.m02=t.m02+n.m02,e.m03=t.m03+n.m03,e.m04=t.m04+n.m04,e.m05=t.m05+n.m05,e.m06=t.m06+n.m06,e.m07=t.m07+n.m07,e.m08=t.m08+n.m08,e.m09=t.m09+n.m09,e.m10=t.m10+n.m10,e.m11=t.m11+n.m11,e.m12=t.m12+n.m12,e.m13=t.m13+n.m13,e.m14=t.m14+n.m14,e.m15=t.m15+n.m15,e},t.subtract=function(e,t,n){return e.m00=t.m00-n.m00,e.m01=t.m01-n.m01,e.m02=t.m02-n.m02,e.m03=t.m03-n.m03,e.m04=t.m04-n.m04,e.m05=t.m05-n.m05,e.m06=t.m06-n.m06,e.m07=t.m07-n.m07,e.m08=t.m08-n.m08,e.m09=t.m09-n.m09,e.m10=t.m10-n.m10,e.m11=t.m11-n.m11,e.m12=t.m12-n.m12,e.m13=t.m13-n.m13,e.m14=t.m14-n.m14,e.m15=t.m15-n.m15,e},t.multiplyScalar=function(e,t,n){return e.m00=t.m00*n,e.m01=t.m01*n,e.m02=t.m02*n,e.m03=t.m03*n,e.m04=t.m04*n,e.m05=t.m05*n,e.m06=t.m06*n,e.m07=t.m07*n,e.m08=t.m08*n,e.m09=t.m09*n,e.m10=t.m10*n,e.m11=t.m11*n,e.m12=t.m12*n,e.m13=t.m13*n,e.m14=t.m14*n,e.m15=t.m15*n,e},t.multiplyScalarAndAdd=function(e,t,n,i){return e.m00=t.m00+n.m00*i,e.m01=t.m01+n.m01*i,e.m02=t.m02+n.m02*i,e.m03=t.m03+n.m03*i,e.m04=t.m04+n.m04*i,e.m05=t.m05+n.m05*i,e.m06=t.m06+n.m06*i,e.m07=t.m07+n.m07*i,e.m08=t.m08+n.m08*i,e.m09=t.m09+n.m09*i,e.m10=t.m10+n.m10*i,e.m11=t.m11+n.m11*i,e.m12=t.m12+n.m12*i,e.m13=t.m13+n.m13*i,e.m14=t.m14+n.m14*i,e.m15=t.m15+n.m15*i,e},t.strictEquals=function(e,t){return e.m00===t.m00&&e.m01===t.m01&&e.m02===t.m02&&e.m03===t.m03&&e.m04===t.m04&&e.m05===t.m05&&e.m06===t.m06&&e.m07===t.m07&&e.m08===t.m08&&e.m09===t.m09&&e.m10===t.m10&&e.m11===t.m11&&e.m12===t.m12&&e.m13===t.m13&&e.m14===t.m14&&e.m15===t.m15},t.equals=function(e,t,n){return void 0===n&&(n=Jt),Math.abs(e.m00-t.m00)<=n*Math.max(1,Math.abs(e.m00),Math.abs(t.m00))&&Math.abs(e.m01-t.m01)<=n*Math.max(1,Math.abs(e.m01),Math.abs(t.m01))&&Math.abs(e.m02-t.m02)<=n*Math.max(1,Math.abs(e.m02),Math.abs(t.m02))&&Math.abs(e.m03-t.m03)<=n*Math.max(1,Math.abs(e.m03),Math.abs(t.m03))&&Math.abs(e.m04-t.m04)<=n*Math.max(1,Math.abs(e.m04),Math.abs(t.m04))&&Math.abs(e.m05-t.m05)<=n*Math.max(1,Math.abs(e.m05),Math.abs(t.m05))&&Math.abs(e.m06-t.m06)<=n*Math.max(1,Math.abs(e.m06),Math.abs(t.m06))&&Math.abs(e.m07-t.m07)<=n*Math.max(1,Math.abs(e.m07),Math.abs(t.m07))&&Math.abs(e.m08-t.m08)<=n*Math.max(1,Math.abs(e.m08),Math.abs(t.m08))&&Math.abs(e.m09-t.m09)<=n*Math.max(1,Math.abs(e.m09),Math.abs(t.m09))&&Math.abs(e.m10-t.m10)<=n*Math.max(1,Math.abs(e.m10),Math.abs(t.m10))&&Math.abs(e.m11-t.m11)<=n*Math.max(1,Math.abs(e.m11),Math.abs(t.m11))&&Math.abs(e.m12-t.m12)<=n*Math.max(1,Math.abs(e.m12),Math.abs(t.m12))&&Math.abs(e.m13-t.m13)<=n*Math.max(1,Math.abs(e.m13),Math.abs(t.m13))&&Math.abs(e.m14-t.m14)<=n*Math.max(1,Math.abs(e.m14),Math.abs(t.m14))&&Math.abs(e.m15-t.m15)<=n*Math.max(1,Math.abs(e.m15),Math.abs(t.m15))};var n=t.prototype;return n.clone=function(){return new t(this.m00,this.m01,this.m02,this.m03,this.m04,this.m05,this.m06,this.m07,this.m08,this.m09,this.m10,this.m11,this.m12,this.m13,this.m14,this.m15)},n.set=function(e,t,n,i,r,o,a,s,c,l,u,h,_,f,d,p){return void 0===e&&(e=1),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===o&&(o=1),void 0===a&&(a=0),void 0===s&&(s=0),void 0===c&&(c=0),void 0===l&&(l=0),void 0===u&&(u=1),void 0===h&&(h=0),void 0===_&&(_=0),void 0===f&&(f=0),void 0===d&&(d=0),void 0===p&&(p=1),"object"==typeof e?(this.m01=e.m01,this.m02=e.m02,this.m03=e.m03,this.m04=e.m04,this.m05=e.m05,this.m06=e.m06,this.m07=e.m07,this.m08=e.m08,this.m09=e.m09,this.m10=e.m10,this.m11=e.m11,this.m12=e.m12,this.m13=e.m13,this.m14=e.m14,this.m15=e.m15,this.m00=e.m00):(this.m01=t,this.m02=n,this.m03=i,this.m04=r,this.m05=o,this.m06=a,this.m07=s,this.m08=c,this.m09=l,this.m10=u,this.m11=h,this.m12=_,this.m13=f,this.m14=d,this.m15=p,this.m00=e),this},n.equals=function(e,t){return void 0===t&&(t=Jt),Math.abs(this.m00-e.m00)<=t*Math.max(1,Math.abs(this.m00),Math.abs(e.m00))&&Math.abs(this.m01-e.m01)<=t*Math.max(1,Math.abs(this.m01),Math.abs(e.m01))&&Math.abs(this.m02-e.m02)<=t*Math.max(1,Math.abs(this.m02),Math.abs(e.m02))&&Math.abs(this.m03-e.m03)<=t*Math.max(1,Math.abs(this.m03),Math.abs(e.m03))&&Math.abs(this.m04-e.m04)<=t*Math.max(1,Math.abs(this.m04),Math.abs(e.m04))&&Math.abs(this.m05-e.m05)<=t*Math.max(1,Math.abs(this.m05),Math.abs(e.m05))&&Math.abs(this.m06-e.m06)<=t*Math.max(1,Math.abs(this.m06),Math.abs(e.m06))&&Math.abs(this.m07-e.m07)<=t*Math.max(1,Math.abs(this.m07),Math.abs(e.m07))&&Math.abs(this.m08-e.m08)<=t*Math.max(1,Math.abs(this.m08),Math.abs(e.m08))&&Math.abs(this.m09-e.m09)<=t*Math.max(1,Math.abs(this.m09),Math.abs(e.m09))&&Math.abs(this.m10-e.m10)<=t*Math.max(1,Math.abs(this.m10),Math.abs(e.m10))&&Math.abs(this.m11-e.m11)<=t*Math.max(1,Math.abs(this.m11),Math.abs(e.m11))&&Math.abs(this.m12-e.m12)<=t*Math.max(1,Math.abs(this.m12),Math.abs(e.m12))&&Math.abs(this.m13-e.m13)<=t*Math.max(1,Math.abs(this.m13),Math.abs(e.m13))&&Math.abs(this.m14-e.m14)<=t*Math.max(1,Math.abs(this.m14),Math.abs(e.m14))&&Math.abs(this.m15-e.m15)<=t*Math.max(1,Math.abs(this.m15),Math.abs(e.m15))},n.strictEquals=function(e){return this.m00===e.m00&&this.m01===e.m01&&this.m02===e.m02&&this.m03===e.m03&&this.m04===e.m04&&this.m05===e.m05&&this.m06===e.m06&&this.m07===e.m07&&this.m08===e.m08&&this.m09===e.m09&&this.m10===e.m10&&this.m11===e.m11&&this.m12===e.m12&&this.m13===e.m13&&this.m14===e.m14&&this.m15===e.m15},n.toString=function(){return"[\n"+this.m00+", "+this.m01+", "+this.m02+", "+this.m03+",\n"+this.m04+", "+this.m05+", "+this.m06+", "+this.m07+",\n"+this.m08+", "+this.m09+", "+this.m10+", "+this.m11+",\n"+this.m12+", "+this.m13+", "+this.m14+", "+this.m15+"\n]"},n.identity=function(){return this.m00=1,this.m01=0,this.m02=0,this.m03=0,this.m04=0,this.m05=1,this.m06=0,this.m07=0,this.m08=0,this.m09=0,this.m10=1,this.m11=0,this.m12=0,this.m13=0,this.m14=0,this.m15=1,this},n.zero=function(){return this.m00=0,this.m01=0,this.m02=0,this.m03=0,this.m04=0,this.m05=0,this.m06=0,this.m07=0,this.m08=0,this.m09=0,this.m10=0,this.m11=0,this.m12=0,this.m13=0,this.m14=0,this.m15=0,this},n.transpose=function(){var e=this.m01,t=this.m02,n=this.m03,i=this.m06,r=this.m07,o=this.m11;return this.m01=this.m04,this.m02=this.m08,this.m03=this.m12,this.m04=e,this.m06=this.m09,this.m07=this.m13,this.m08=t,this.m09=i,this.m11=this.m14,this.m12=n,this.m13=r,this.m14=o,this},n.invert=function(){var e=this.m00,t=this.m01,n=this.m02,i=this.m03,r=this.m04,o=this.m05,a=this.m06,s=this.m07,c=this.m08,l=this.m09,u=this.m10,h=this.m11,_=this.m12,f=this.m13,d=this.m14,p=this.m15,m=e*o-t*r,v=e*a-n*r,g=e*s-i*r,y=t*a-n*o,x=t*s-i*o,S=n*s-i*a,E=c*f-l*_,T=c*d-u*_,C=c*p-h*_,b=l*d-u*f,A=l*p-h*f,w=u*p-h*d,I=m*w-v*A+g*b+y*C-x*T+S*E;return 0===I?(this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0),this):(I=1/I,this.m00=(o*w-a*A+s*b)*I,this.m01=(n*A-t*w-i*b)*I,this.m02=(f*S-d*x+p*y)*I,this.m03=(u*x-l*S-h*y)*I,this.m04=(a*C-r*w-s*T)*I,this.m05=(e*w-n*C+i*T)*I,this.m06=(d*g-_*S-p*v)*I,this.m07=(c*S-u*g+h*v)*I,this.m08=(r*A-o*C+s*E)*I,this.m09=(t*C-e*A-i*E)*I,this.m10=(_*x-f*g+p*m)*I,this.m11=(l*g-c*x-h*m)*I,this.m12=(o*T-r*b-a*E)*I,this.m13=(e*b-t*T+n*E)*I,this.m14=(f*v-_*y-d*m)*I,this.m15=(c*y-l*v+u*m)*I,this)},n.determinant=function(){var e=this.m00,t=this.m01,n=this.m02,i=this.m03,r=this.m04,o=this.m05,a=this.m06,s=this.m07,c=this.m08,l=this.m09,u=this.m10,h=this.m11,_=this.m12,f=this.m13,d=this.m14,p=this.m15;return(e*o-t*r)*(u*p-h*d)-(e*a-n*r)*(l*p-h*f)+(e*s-i*r)*(l*d-u*f)+(t*a-n*o)*(c*p-h*_)-(t*s-i*o)*(c*d-u*_)+(n*s-i*a)*(c*f-l*_)},n.add=function(e){return this.m00+=e.m00,this.m01+=e.m01,this.m02+=e.m02,this.m03+=e.m03,this.m04+=e.m04,this.m05+=e.m05,this.m06+=e.m06,this.m07+=e.m07,this.m08+=e.m08,this.m09+=e.m09,this.m10+=e.m10,this.m11+=e.m11,this.m12+=e.m12,this.m13+=e.m13,this.m14+=e.m14,this.m15+=e.m15,this},n.subtract=function(e){return this.m00-=e.m00,this.m01-=e.m01,this.m02-=e.m02,this.m03-=e.m03,this.m04-=e.m04,this.m05-=e.m05,this.m06-=e.m06,this.m07-=e.m07,this.m08-=e.m08,this.m09-=e.m09,this.m10-=e.m10,this.m11-=e.m11,this.m12-=e.m12,this.m13-=e.m13,this.m14-=e.m14,this.m15-=e.m15,this},n.multiply=function(e){var t=this.m00,n=this.m01,i=this.m02,r=this.m03,o=this.m04,a=this.m05,s=this.m06,c=this.m07,l=this.m08,u=this.m09,h=this.m10,_=this.m11,f=this.m12,d=this.m13,p=this.m14,m=this.m15,v=e.m00,g=e.m01,y=e.m02,x=e.m03;return this.m00=v*t+g*o+y*l+x*f,this.m01=v*n+g*a+y*u+x*d,this.m02=v*i+g*s+y*h+x*p,this.m03=v*r+g*c+y*_+x*m,v=e.m04,g=e.m05,y=e.m06,x=e.m07,this.m04=v*t+g*o+y*l+x*f,this.m05=v*n+g*a+y*u+x*d,this.m06=v*i+g*s+y*h+x*p,this.m07=v*r+g*c+y*_+x*m,v=e.m08,g=e.m09,y=e.m10,x=e.m11,this.m08=v*t+g*o+y*l+x*f,this.m09=v*n+g*a+y*u+x*d,this.m10=v*i+g*s+y*h+x*p,this.m11=v*r+g*c+y*_+x*m,v=e.m12,g=e.m13,y=e.m14,x=e.m15,this.m12=v*t+g*o+y*l+x*f,this.m13=v*n+g*a+y*u+x*d,this.m14=v*i+g*s+y*h+x*p,this.m15=v*r+g*c+y*_+x*m,this},n.multiplyScalar=function(e){return this.m00*=e,this.m01*=e,this.m02*=e,this.m03*=e,this.m04*=e,this.m05*=e,this.m06*=e,this.m07*=e,this.m08*=e,this.m09*=e,this.m10*=e,this.m11*=e,this.m12*=e,this.m13*=e,this.m14*=e,this.m15*=e,this},n.translate=function(e){return console.warn("function changed"),this.m12+=e.x,this.m13+=e.y,this.m14+=e.z,this},n.scale=function(e){var t=e.x,n=e.y,i=e.z;return this.m00*=t,this.m01*=t,this.m02*=t,this.m03*=t,this.m04*=n,this.m05*=n,this.m06*=n,this.m07*=n,this.m08*=i,this.m09*=i,this.m10*=i,this.m11*=i,this},n.rotate=function(e,t){var n=t.x,i=t.y,r=t.z,o=Math.sqrt(n*n+i*i+r*r);if(Math.abs(o)<Jt)return null;n*=o=1/o,i*=o,r*=o;var a=Math.sin(e),s=Math.cos(e),c=1-s,l=this.m00,u=this.m01,h=this.m02,_=this.m03,f=this.m04,d=this.m05,p=this.m06,m=this.m07,v=this.m08,g=this.m09,y=this.m10,x=this.m11,S=n*n*c+s,E=i*n*c+r*a,T=r*n*c-i*a,C=n*i*c-r*a,b=i*i*c+s,A=r*i*c+n*a,w=n*r*c+i*a,I=i*r*c-n*a,P=r*r*c+s;return this.m00=l*S+f*E+v*T,this.m01=u*S+d*E+g*T,this.m02=h*S+p*E+y*T,this.m03=_*S+m*E+x*T,this.m04=l*C+f*b+v*A,this.m05=u*C+d*b+g*A,this.m06=h*C+p*b+y*A,this.m07=_*C+m*b+x*A,this.m08=l*w+f*I+v*P,this.m09=u*w+d*I+g*P,this.m10=h*w+p*I+y*P,this.m11=_*w+m*I+x*P,this},n.getTranslation=function(e){return e.x=this.m12,e.y=this.m13,e.z=this.m14,e},n.getScale=function(e){var t=Hn.m00=this.m00,n=Hn.m01=this.m01,i=Hn.m02=this.m02,r=Hn.m03=this.m04,o=Hn.m04=this.m05,a=Hn.m05=this.m06,s=Hn.m06=this.m08,c=Hn.m07=this.m09,l=Hn.m08=this.m10;return e.x=Math.sqrt(t*t+n*n+i*i),e.y=Math.sqrt(r*r+o*o+a*a),e.z=Math.sqrt(s*s+c*c+l*l),Pn.determinant(Hn)<0&&(e.x*=-1),e},n.getRotation=function(e){var t=this.m00+this.m05+this.m10,n=0;return t>0?(n=2*Math.sqrt(t+1),e.w=.25*n,e.x=(this.m06-this.m09)/n,e.y=(this.m08-this.m02)/n,e.z=(this.m01-this.m04)/n):this.m00>this.m05&&this.m00>this.m10?(n=2*Math.sqrt(1+this.m00-this.m05-this.m10),e.w=(this.m06-this.m09)/n,e.x=.25*n,e.y=(this.m01+this.m04)/n,e.z=(this.m08+this.m02)/n):this.m05>this.m10?(n=2*Math.sqrt(1+this.m05-this.m00-this.m10),e.w=(this.m08-this.m02)/n,e.x=(this.m01+this.m04)/n,e.y=.25*n,e.z=(this.m06+this.m09)/n):(n=2*Math.sqrt(1+this.m10-this.m00-this.m05),e.w=(this.m01-this.m04)/n,e.x=(this.m08+this.m02)/n,e.y=(this.m06+this.m09)/n,e.z=.25*n),e},n.fromRTS=function(e,t,n){var i=e.x,r=e.y,o=e.z,a=e.w,s=i+i,c=r+r,l=o+o,u=i*s,h=i*c,_=i*l,f=r*c,d=r*l,p=o*l,m=a*s,v=a*c,g=a*l,y=n.x,x=n.y,S=n.z;return this.m00=(1-(f+p))*y,this.m01=(h+g)*y,this.m02=(_-v)*y,this.m03=0,this.m04=(h-g)*x,this.m05=(1-(u+p))*x,this.m06=(d+m)*x,this.m07=0,this.m08=(_+v)*S,this.m09=(d-m)*S,this.m10=(1-(u+f))*S,this.m11=0,this.m12=t.x,this.m13=t.y,this.m14=t.z,this.m15=1,this},n.fromQuat=function(e){var t=e.x,n=e.y,i=e.z,r=e.w,o=t+t,a=n+n,s=i+i,c=t*o,l=n*o,u=n*a,h=i*o,_=i*a,f=i*s,d=r*o,p=r*a,m=r*s;return this.m00=1-u-f,this.m01=l+m,this.m02=h-p,this.m03=0,this.m04=l-m,this.m05=1-c-f,this.m06=_+d,this.m07=0,this.m08=h+p,this.m09=_-d,this.m10=1-c-u,this.m11=0,this.m12=0,this.m13=0,this.m14=0,this.m15=1,this},t}(tt));kn.IDENTITY=Object.freeze(new kn);var Gn=new yn,Hn=new Pn;function Vn(e,t,n,i,r,o,a,s,c,l,u,h,_,f,d,p){return new kn(e,t,n,i,r,o,a,s,c,l,u,h,_,f,d,p)}jt.fastDefine("cc.Mat4",kn,{m00:1,m01:0,m02:0,m03:0,m04:0,m05:1,m06:0,m07:0,m08:0,m09:0,m10:1,m11:0,m12:0,m13:0,m14:0,m15:1}),b.Mat4=kn,b.mat4=Vn;var Wn=e("AffineTransform",function(){function e(e,t,n,i,r,o){void 0===e&&(e=1),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=1),void 0===r&&(r=0),void 0===o&&(o=0),this.a=e,this.b=t,this.c=n,this.d=i,this.tx=r,this.ty=o}return e.identity=function(){return new e},e.clone=function(t){return new e(t.a,t.b,t.c,t.d,t.tx,t.ty)},e.concat=function(e,t,n){var i=t.a,r=t.b,o=t.c,a=t.d,s=t.tx,c=t.ty;e.a=i*n.a+r*n.c,e.b=i*n.b+r*n.d,e.c=o*n.a+a*n.c,e.d=o*n.b+a*n.d,e.tx=s*n.a+c*n.c+n.tx,e.ty=s*n.b+c*n.d+n.ty},e.invert=function(e,t){var n=1/(t.a*t.d-t.b*t.c);e.a=n*t.d,e.b=-n*t.b,e.c=-n*t.c,e.d=n*t.a,e.tx=n*(t.c*t.ty-t.d*t.tx),e.ty=n*(t.b*t.tx-t.a*t.ty)},e.fromMat4=function(e,t){e.a=t.m00,e.b=t.m01,e.c=t.m04,e.d=t.m05,e.tx=t.m12,e.ty=t.m13},e.transformVec2=function(e,t,n,i){var r,o;i?(r=t,o=n):(i=n,r=t.x,o=t.y),e.x=i.a*r+i.c*o+i.tx,e.y=i.b*r+i.d*o+i.ty},e.transformSize=function(e,t,n){e.width=n.a*t.width+n.c*t.height,e.height=n.b*t.width+n.d*t.height},e.transformRect=function(e,t,n){var i=t.x+t.width,r=t.y+t.height,o=n.a*t.x+n.c*t.y+n.tx,a=n.b*t.x+n.d*t.y+n.ty,s=n.a*i+n.c*t.y+n.tx,c=n.b*i+n.d*t.y+n.ty,l=n.a*t.x+n.c*r+n.tx,u=n.b*t.x+n.d*r+n.ty,h=n.a*i+n.c*r+n.tx,_=n.b*i+n.d*r+n.ty,f=Math.min(o,s,l,h),d=Math.max(o,s,l,h),p=Math.min(a,c,u,_),m=Math.max(a,c,u,_);e.x=f,e.y=p,e.width=d-f,e.height=m-p},e.transformObb=function(e,t,n,i,r,o){var a=o.a*r.x+o.c*r.y+o.tx,s=o.b*r.x+o.d*r.y+o.ty,c=o.a*r.width,l=o.b*r.width,u=o.c*r.height,h=o.d*r.height;t.x=a,t.y=s,n.x=c+a,n.y=l+s,e.x=u+a,e.y=h+s,i.x=c+u+a,i.y=l+h+s},e}());b.AffineTransform=Wn;var jn=e("Size",function(e){function t(t,n){var i;return i=e.call(this)||this,t&&"object"==typeof t?(i.width=t.width,i.height=t.height):(i.width=t||0,i.height=n||0),i}f(t,e),t.lerp=function(e,t,n,i){return e.width=t.width+(n.width-t.width)*i,e.height=t.height+(n.height-t.height)*i,e};var n=t.prototype;return n.clone=function(){return new t(this.width,this.height)},n.set=function(e,t){return e&&"object"==typeof e?(this.height=e.height,this.width=e.width):(this.width=e||0,this.height=t||0),this},n.equals=function(e){return this.width===e.width&&this.height===e.height},n.lerp=function(e,t){return this.width+=(e.width-this.width)*t,this.height+=(e.height-this.height)*t,this},n.toString=function(){return"("+this.width.toFixed(2)+", "+this.height.toFixed(2)+")"},h(t,[{key:"x",get:function(){return this.width},set:function(e){this.width=e}},{key:"y",get:function(){return this.height},set:function(e){this.height=e}}]),t}(tt));function qn(e,t){return void 0===e&&(e=0),void 0===t&&(t=0),new jn(e,t)}jn.ZERO=Object.freeze(new jn(0,0)),jn.ONE=Object.freeze(new jn(1,1)),jt.fastDefine("cc.Size",jn,{width:0,height:0}),b.size=qn,b.Size=jn;var Xn=e("Rect",function(e){function t(t,n,i,r){var o;return o=e.call(this)||this,t&&"object"==typeof t?(o.y=t.y,o.width=t.width,o.height=t.height,o.x=t.x):(o.x=t||0,o.y=n||0,o.width=i||0,o.height=r||0),o}f(t,e),t.fromMinMax=function(e,t,n){var i=Math.min(t.x,n.x),r=Math.min(t.y,n.y),o=Math.max(t.x,n.x),a=Math.max(t.y,n.y);return e.x=i,e.y=r,e.width=o-i,e.height=a-r,e},t.lerp=function(e,t,n,i){var r=t.x,o=t.y,a=t.width,s=t.height;return e.x=r+(n.x-r)*i,e.y=o+(n.y-o)*i,e.width=a+(n.width-a)*i,e.height=s+(n.height-s)*i,e},t.intersection=function(e,t,n){var i=t.x,r=t.y,o=t.x+t.width,a=t.y+t.height,s=n.x,c=n.y,l=n.x+n.width,u=n.y+n.height;return e.x=Math.max(i,s),e.y=Math.max(r,c),e.width=Math.min(o,l)-e.x,e.height=Math.min(a,u)-e.y,e},t.union=function(e,t,n){var i=t.x,r=t.y,o=t.width,a=t.height,s=n.x,c=n.y,l=n.width,u=n.height;return e.x=Math.min(i,s),e.y=Math.min(r,c),e.width=Math.max(i+o,s+l)-e.x,e.height=Math.max(r+a,c+u)-e.y,e};var n=t.prototype;return n.clone=function(){return new t(this.x,this.y,this.width,this.height)},n.set=function(e,t,n,i){return e&&"object"==typeof e?(this.y=e.y,this.width=e.width,this.height=e.height,this.x=e.x):(this.x=e||0,this.y=t||0,this.width=n||0,this.height=i||0),this},n.equals=function(e){return this.x===e.x&&this.y===e.y&&this.width===e.width&&this.height===e.height},n.lerp=function(e,t){var n=this.x,i=this.y,r=this.width,o=this.height;return this.x=n+(e.x-n)*t,this.y=i+(e.y-i)*t,this.width=r+(e.width-r)*t,this.height=o+(e.height-o)*t,this},n.toString=function(){return"("+this.x.toFixed(2)+", "+this.y.toFixed(2)+", "+this.width.toFixed(2)+", "+this.height.toFixed(2)+")"},n.intersects=function(e){var t=this.x+this.width,n=this.y+this.height,i=e.x+e.width,r=e.y+e.height;return!(t<e.x||i<this.x||n<e.y||r<this.y)},n.contains=function(e){return this.x<=e.x&&this.x+this.width>=e.x&&this.y<=e.y&&this.y+this.height>=e.y},n.containsRect=function(e){return this.x<=e.x&&this.x+this.width>=e.x+e.width&&this.y<=e.y&&this.y+this.height>=e.y+e.height},n.transformMat4=function(e){var t=this.x,n=this.y,i=t+this.width,r=n+this.height,o=e.m00*t+e.m04*n+e.m12,a=e.m01*t+e.m05*n+e.m13,s=e.m00*i+e.m04*n+e.m12,c=e.m01*i+e.m05*n+e.m13,l=e.m00*t+e.m04*r+e.m12,u=e.m01*t+e.m05*r+e.m13,h=e.m00*i+e.m04*r+e.m12,_=e.m01*i+e.m05*r+e.m13,f=Math.min(o,s,l,h),d=Math.max(o,s,l,h),p=Math.min(a,c,u,_),m=Math.max(a,c,u,_);return this.x=f,this.y=p,this.width=d-f,this.height=m-p,this},n.transformMat4ToPoints=function(e,t,n,i,r){var o=this.x,a=this.y,s=o+this.width,c=a+this.height;t.x=e.m00*o+e.m04*a+e.m12,t.y=e.m01*o+e.m05*a+e.m13,r.x=e.m00*s+e.m04*a+e.m12,r.y=e.m01*s+e.m05*a+e.m13,n.x=e.m00*o+e.m04*c+e.m12,n.y=e.m01*o+e.m05*c+e.m13,i.x=e.m00*s+e.m04*c+e.m12,i.y=e.m01*s+e.m05*c+e.m13},h(t,[{key:"xMin",get:function(){return this.x},set:function(e){this.width+=this.x-e,this.x=e}},{key:"yMin",get:function(){return this.y},set:function(e){this.height+=this.y-e,this.y=e}},{key:"xMax",get:function(){return this.x+this.width},set:function(e){this.width=e-this.x}},{key:"yMax",get:function(){return this.y+this.height},set:function(e){this.height=e-this.y}},{key:"center",get:function(){return new Tn(this.x+.5*this.width,this.y+.5*this.height)},set:function(e){this.x=e.x-.5*this.width,this.y=e.y-.5*this.height}},{key:"origin",get:function(){return new Tn(this.x,this.y)},set:function(e){this.x=e.x,this.y=e.y}},{key:"size",get:function(){return new jn(this.width,this.height)},set:function(e){this.width=e.width,this.height=e.height}},{key:"z",get:function(){return this.width},set:function(e){this.width=e}},{key:"w",get:function(){return this.height},set:function(e){this.height=e}}]),t}(tt));function Yn(e,t,n,i){return void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),new Xn(e,t,n,i)}jt.fastDefine("cc.Rect",Xn,{x:0,y:0,width:0,height:0}),b.Rect=Xn,b.rect=Yn;var Kn=1/255,Qn=e("Color",function(e){function t(t,n,i,r){var o;return(o=e.call(this)||this)._val=0,"string"==typeof t?o.fromHEX(t):void 0!==n?o.set(t,n,i,r):o.set(t),o}f(t,e),t.clone=function(e){var n=new t;return e._val?n._val=e._val:n._val=(e.a<<24>>>0)+(e.b<<16)+(e.g<<8)+e.r,n},t.copy=function(e,t){return e.r=t.r,e.g=t.g,e.b=t.b,e.a=t.a,e},t.set=function(e,t,n,i,r){return e.r=t,e.g=n,e.b=i,e.a=r,e},t.fromHEX=function(e,t){t=0===t.indexOf("#")?t.substring(1):t,e.r=parseInt(t.substr(0,2),16)||0,e.g=parseInt(t.substr(2,2),16)||0,e.b=parseInt(t.substr(4,2),16)||0;var n=parseInt(t.substr(6,2),16);return e.a=Number.isNaN(n)?255:n,e._val=(e.a<<24>>>0)+(e.b<<16)+(e.g<<8)+e.r,e},t.add=function(e,t,n){return e.r=t.r+n.r,e.g=t.g+n.g,e.b=t.b+n.b,e.a=t.a+n.a,e},t.subtract=function(e,t,n){return e.r=t.r-n.r,e.g=t.g-n.g,e.b=t.b-n.b,e.a=t.a-n.a,e},t.multiply=function(e,t,n){return e.r=t.r*n.r,e.g=t.g*n.g,e.b=t.b*n.b,e.a=t.a*n.a,e},t.divide=function(e,t,n){return e.r=t.r/n.r,e.g=t.g/n.g,e.b=t.b/n.b,e.a=t.a/n.a,e},t.scale=function(e,t,n){return e.r=t.r*n,e.g=t.g*n,e.b=t.b*n,e.a=t.a*n,e},t.lerp=function(e,t,n,i){var r=t.r,o=t.g,a=t.b,s=t.a;return r+=(n.r-r)*i,o+=(n.g-o)*i,a+=(n.b-a)*i,s+=(n.a-s)*i,e._val=Math.floor((s<<24>>>0)+(a<<16)+(o<<8)+r),e},t.toArray=function(e,n,i){void 0===i&&(i=0);var r=n instanceof t||n.a>1?1/255:1;return e[i+0]=n.r*r,e[i+1]=n.g*r,e[i+2]=n.b*r,e[i+3]=n.a*r,e},t.fromArray=function(e,t,n){return void 0===n&&(n=0),t.r=255*e[n+0],t.g=255*e[n+1],t.b=255*e[n+2],t.a=255*e[n+3],t},t.strictEquals=function(e,t){return e.r===t.r&&e.g===t.g&&e.b===t.b&&e.a===t.a},t.equals=function(e,t,n){return void 0===n&&(n=Jt),Math.abs(e.r-t.r)<=n*Math.max(1,Math.abs(e.r),Math.abs(t.r))&&Math.abs(e.g-t.g)<=n*Math.max(1,Math.abs(e.g),Math.abs(t.g))&&Math.abs(e.b-t.b)<=n*Math.max(1,Math.abs(e.b),Math.abs(t.b))&&Math.abs(e.a-t.a)<=n*Math.max(1,Math.abs(e.a),Math.abs(t.a))},t.hex=function(e){return(255*e.r<<24|255*e.g<<16|255*e.b<<8|255*e.a)>>>0};var n=t.prototype;return n.clone=function(){var e=new t;return e._val=this._val,e},n.equals=function(e){return e&&this._val===e._val},n.lerp=function(e,t){var n=this.r,i=this.g,r=this.b,o=this.a;return n+=(e.r-n)*t,i+=(e.g-i)*t,r+=(e.b-r)*t,o+=(e.a-o)*t,this._val=Math.floor((o<<24>>>0)+(r<<16)+(i<<8)+n),this},n.toString=function(){return"rgba("+this.r.toFixed()+", "+this.g.toFixed()+", "+this.b.toFixed()+", "+this.a.toFixed()+")"},n.toCSS=function(e){return void 0===e&&(e="rgba"),"rgba"===e?"rgba("+this.r+","+this.g+","+this.b+","+(this.a*Kn).toFixed(2)+")":"rgb"===e?"rgb("+this.r+","+this.g+","+this.b+")":"#"+this.toHEX(e)},n.fromHEX=function(e){e=0===e.indexOf("#")?e.substring(1):e;var t=parseInt(e.substr(0,2),16)||0,n=parseInt(e.substr(2,2),16)||0,i=parseInt(e.substr(4,2),16)||0,r=parseInt(e.substr(6,2),16);return r=Number.isNaN(r)?255:r,this._val=(r<<24>>>0)+(i<<16)+(n<<8)+(0|t),this},n.toHEX=function(e){void 0===e&&(e="#rrggbb");var t="0",n=[(this.r<16?t:"")+this.r.toString(16),(this.g<16?t:"")+this.g.toString(16),(this.b<16?t:"")+this.b.toString(16)];return"#rgb"===e?(n[0]=n[0][0],n[1]=n[1][0],n[2]=n[2][0]):"#rrggbbaa"===e&&n.push((this.a<16?t:"")+this.a.toString(16)),n.join("")},n.toRGBValue=function(){return 16777215&this._val},n.fromHSV=function(e,t,n){var i=0,r=0,o=0;if(0===t)i=r=o=n;else if(0===n)i=r=o=0;else{1===e&&(e=0),e*=6;var a=Math.floor(e),s=e-a,c=n*(1-t),l=n*(1-t*s),u=n*(1-t*(1-s));switch(a){case 0:i=n,r=u,o=c;break;case 1:i=l,r=n,o=c;break;case 2:i=c,r=n,o=u;break;case 3:i=c,r=l,o=n;break;case 4:i=u,r=c,o=n;break;case 5:i=n,r=c,o=l}}return i*=255,r*=255,o*=255,this._val=(this.a<<24>>>0)+(o<<16)+(r<<8)+(0|i),this},n.toHSV=function(){var e=this.r*Kn,t=this.g*Kn,n=this.b*Kn,i={h:0,s:0,v:0},r=Math.max(e,t,n),o=Math.min(e,t,n),a=0;return i.v=r,i.s=r?(r-o)/r:0,i.s?(a=r-o,i.h=e===r?(t-n)/a:t===r?2+(n-e)/a:4+(e-t)/a,i.h/=6,i.h<0&&(i.h+=1)):i.h=0,i},n.set=function(e,t,n,i){return"object"==typeof e?null!=e._val?this._val=e._val:(t=e.g||0,n=e.b||0,i="number"==typeof e.a?e.a:255,e=e.r||0,this._val=(i<<24>>>0)+(n<<16)+(t<<8)+(0|e)):(e=e||0,t=t||0,n=n||0,i="number"==typeof i?i:255,this._val=(i<<24>>>0)+(n<<16)+(t<<8)+(0|e)),this},n.multiply=function(e){var t=(255&this._val)*e.r>>8,n=(65280&this._val)*e.g>>8,i=(16711680&this._val)*e.b>>8,r=((4278190080&this._val)>>>8)*e.a;return this._val=4278190080&r|16711680&i|65280&n|255&t,this},n._set_r_unsafe=function(e){return this._val=(4294967040&this._val|e)>>>0,this},n._set_g_unsafe=function(e){return this._val=(4294902015&this._val|e<<8)>>>0,this},n._set_b_unsafe=function(e){return this._val=(4278255615&this._val|e<<16)>>>0,this},n._set_a_unsafe=function(e){return this._val=(16777215&this._val|e<<24)>>>0,this},h(t,[{key:"r",get:function(){return 255&this._val},set:function(e){e=~~en(e,0,255),this._val=(4294967040&this._val|e)>>>0}},{key:"g",get:function(){return(65280&this._val)>>8},set:function(e){e=~~en(e,0,255),this._val=(4294902015&this._val|e<<8)>>>0}},{key:"b",get:function(){return(16711680&this._val)>>16},set:function(e){e=~~en(e,0,255),this._val=(4278255615&this._val|e<<16)>>>0}},{key:"a",get:function(){return(4278190080&this._val)>>>24},set:function(e){e=~~en(e,0,255),this._val=(16777215&this._val|e<<24)>>>0}},{key:"x",get:function(){return this.r*Kn},set:function(e){this.r=255*e}},{key:"y",get:function(){return this.g*Kn},set:function(e){this.g=255*e}},{key:"z",get:function(){return this.b*Kn},set:function(e){this.b=255*e}},{key:"w",get:function(){return this.a*Kn},set:function(e){this.a=255*e}}]),t}(tt));function Jn(e,t,n,i){return new Qn(e,t,n,i)}Qn.WHITE=Object.freeze(new Qn(255,255,255,255)),Qn.GRAY=Object.freeze(new Qn(127,127,127,255)),Qn.BLACK=Object.freeze(new Qn(0,0,0,255)),Qn.TRANSPARENT=Object.freeze(new Qn(0,0,0,0)),Qn.RED=Object.freeze(new Qn(255,0,0,255)),Qn.GREEN=Object.freeze(new Qn(0,255,0,255)),Qn.BLUE=Object.freeze(new Qn(0,0,255,255)),Qn.CYAN=Object.freeze(new Qn(0,255,255,255)),Qn.MAGENTA=Object.freeze(new Qn(255,0,255,255)),Qn.YELLOW=Object.freeze(new Qn(255,255,0,255)),jt.fastDefine("cc.Color",Qn,{r:0,g:0,b:0,a:255}),b.Color=Qn,b.color=Jn;var Zn=e("MATH_FLOAT_ARRAY",Float64Array),$n=e("MathBase",function(e){function t(){return e.apply(this,arguments)||this}return f(t,e),t.createFloatArray=function(e){return new Zn(e)},h(t,[{key:"array",get:function(){return this._array}}]),t}(tt)),ei=Object.freeze({__proto__:null,bits:l,Vec2:Tn,v2:An,Vec3:yn,v3:En,Vec4:wn,v4:In,Quat:On,quat:zn,Mat3:Pn,Mat4:kn,mat4:Vn,AffineTransform:Wn,Size:jn,size:qn,Rect:Xn,rect:Yn,Color:Qn,color:Jn,EPSILON:Jt,equals:Zt,approx:$t,clamp:en,clamp01:tn,lerp:nn,toRadian:rn,toDegree:on,random:an,randomRange:sn,randomRangeInt:cn,pseudoRandom:ln,pseudoRandomRange:un,pseudoRandomRangeInt:hn,nextPow2:_n,repeat:fn,pingPong:dn,inverseLerp:pn,absMaxComponent:mn,absMax:vn,enumerableProps:gn,MATH_FLOAT_ARRAY:Zn,MathBase:$n});e("math",ei);var ti,ni,ii,ri,oi,ai,si,ci,li,ui,hi,_i,fi,di,pi,mi,vi,gi,yi,xi,Si,Ei,Ti,Ci,bi,Ai,wi,Ii,Pi,Ri,Di,Oi,Ni,Mi,Li,Fi,Bi,zi,Ui,ki,Gi,Hi,Vi=new(function(){function e(){this._finalizationRegistry=null,this._gcObjects=new WeakMap}var t=e.prototype;return t.registerGCObject=function(e){return e},t.init=function(){},t.finalizationRegistryCallback=function(e){var t=this._gcObjects.get(e);t&&(this._gcObjects.delete(e),t.destroy()),this._finalizationRegistry.unregister(e)},t.destroy=function(){},e}()),Wi=function(){function e(){return Vi.registerGCObject(this)}return e.prototype.destroy=function(){},e}(),ji=function(e,t,n){for(var i=0;i<t.length;++i)e.length<=i&&e.push(new n),e[i].copy(t[i]);e.length=t.length};!function(e){e[e.UNKNOWN=0]="UNKNOWN",e[e.SWAPCHAIN=1]="SWAPCHAIN",e[e.BUFFER=2]="BUFFER",e[e.TEXTURE=3]="TEXTURE",e[e.RENDER_PASS=4]="RENDER_PASS",e[e.FRAMEBUFFER=5]="FRAMEBUFFER",e[e.SAMPLER=6]="SAMPLER",e[e.SHADER=7]="SHADER",e[e.DESCRIPTOR_SET_LAYOUT=8]="DESCRIPTOR_SET_LAYOUT",e[e.PIPELINE_LAYOUT=9]="PIPELINE_LAYOUT",e[e.PIPELINE_STATE=10]="PIPELINE_STATE",e[e.DESCRIPTOR_SET=11]="DESCRIPTOR_SET",e[e.INPUT_ASSEMBLER=12]="INPUT_ASSEMBLER",e[e.COMMAND_BUFFER=13]="COMMAND_BUFFER",e[e.QUEUE=14]="QUEUE",e[e.QUERY_POOL=15]="QUERY_POOL",e[e.GLOBAL_BARRIER=16]="GLOBAL_BARRIER",e[e.TEXTURE_BARRIER=17]="TEXTURE_BARRIER",e[e.BUFFER_BARRIER=18]="BUFFER_BARRIER",e[e.COUNT=19]="COUNT"}(ti||(ti={})),function(e){e[e.UNREADY=0]="UNREADY",e[e.FAILED=1]="FAILED",e[e.SUCCESS=2]="SUCCESS"}(ni||(ni={})),function(e){e[e.UNKNOWN=0]="UNKNOWN",e[e.GLES2=1]="GLES2",e[e.GLES3=2]="GLES3",e[e.METAL=3]="METAL",e[e.VULKAN=4]="VULKAN",e[e.NVN=5]="NVN",e[e.WEBGL=6]="WEBGL",e[e.WEBGL2=7]="WEBGL2",e[e.WEBGPU=8]="WEBGPU"}(ii||(ii={})),function(e){e[e.IDENTITY=0]="IDENTITY",e[e.ROTATE_90=1]="ROTATE_90",e[e.ROTATE_180=2]="ROTATE_180",e[e.ROTATE_270=3]="ROTATE_270"}(ri||(ri={})),function(e){e[e.ELEMENT_INDEX_UINT=0]="ELEMENT_INDEX_UINT",e[e.INSTANCED_ARRAYS=1]="INSTANCED_ARRAYS",e[e.MULTIPLE_RENDER_TARGETS=2]="MULTIPLE_RENDER_TARGETS",e[e.BLEND_MINMAX=3]="BLEND_MINMAX",e[e.COMPUTE_SHADER=4]="COMPUTE_SHADER",e[e.INPUT_ATTACHMENT_BENEFIT=5]="INPUT_ATTACHMENT_BENEFIT",e[e.COUNT=6]="COUNT"}(oi||(oi={})),function(e){e[e.UNKNOWN=0]="UNKNOWN",e[e.A8=1]="A8",e[e.L8=2]="L8",e[e.LA8=3]="LA8",e[e.R8=4]="R8",e[e.R8SN=5]="R8SN",e[e.R8UI=6]="R8UI",e[e.R8I=7]="R8I",e[e.R16F=8]="R16F",e[e.R16UI=9]="R16UI",e[e.R16I=10]="R16I",e[e.R32F=11]="R32F",e[e.R32UI=12]="R32UI",e[e.R32I=13]="R32I",e[e.RG8=14]="RG8",e[e.RG8SN=15]="RG8SN",e[e.RG8UI=16]="RG8UI",e[e.RG8I=17]="RG8I",e[e.RG16F=18]="RG16F",e[e.RG16UI=19]="RG16UI",e[e.RG16I=20]="RG16I",e[e.RG32F=21]="RG32F",e[e.RG32UI=22]="RG32UI",e[e.RG32I=23]="RG32I",e[e.RGB8=24]="RGB8",e[e.SRGB8=25]="SRGB8",e[e.RGB8SN=26]="RGB8SN",e[e.RGB8UI=27]="RGB8UI",e[e.RGB8I=28]="RGB8I",e[e.RGB16F=29]="RGB16F",e[e.RGB16UI=30]="RGB16UI",e[e.RGB16I=31]="RGB16I",e[e.RGB32F=32]="RGB32F",e[e.RGB32UI=33]="RGB32UI",e[e.RGB32I=34]="RGB32I",e[e.RGBA8=35]="RGBA8",e[e.BGRA8=36]="BGRA8",e[e.SRGB8_A8=37]="SRGB8_A8",e[e.RGBA8SN=38]="RGBA8SN",e[e.RGBA8UI=39]="RGBA8UI",e[e.RGBA8I=40]="RGBA8I",e[e.RGBA16F=41]="RGBA16F",e[e.RGBA16UI=42]="RGBA16UI",e[e.RGBA16I=43]="RGBA16I",e[e.RGBA32F=44]="RGBA32F",e[e.RGBA32UI=45]="RGBA32UI",e[e.RGBA32I=46]="RGBA32I",e[e.R5G6B5=47]="R5G6B5",e[e.R11G11B10F=48]="R11G11B10F",e[e.RGB5A1=49]="RGB5A1",e[e.RGBA4=50]="RGBA4",e[e.RGB10A2=51]="RGB10A2",e[e.RGB10A2UI=52]="RGB10A2UI",e[e.RGB9E5=53]="RGB9E5",e[e.DEPTH=54]="DEPTH",e[e.DEPTH_STENCIL=55]="DEPTH_STENCIL",e[e.BC1=56]="BC1",e[e.BC1_ALPHA=57]="BC1_ALPHA",e[e.BC1_SRGB=58]="BC1_SRGB",e[e.BC1_SRGB_ALPHA=59]="BC1_SRGB_ALPHA",e[e.BC2=60]="BC2",e[e.BC2_SRGB=61]="BC2_SRGB",e[e.BC3=62]="BC3",e[e.BC3_SRGB=63]="BC3_SRGB",e[e.BC4=64]="BC4",e[e.BC4_SNORM=65]="BC4_SNORM",e[e.BC5=66]="BC5",e[e.BC5_SNORM=67]="BC5_SNORM",e[e.BC6H_UF16=68]="BC6H_UF16",e[e.BC6H_SF16=69]="BC6H_SF16",e[e.BC7=70]="BC7",e[e.BC7_SRGB=71]="BC7_SRGB",e[e.ETC_RGB8=72]="ETC_RGB8",e[e.ETC2_RGB8=73]="ETC2_RGB8",e[e.ETC2_SRGB8=74]="ETC2_SRGB8",e[e.ETC2_RGB8_A1=75]="ETC2_RGB8_A1",e[e.ETC2_SRGB8_A1=76]="ETC2_SRGB8_A1",e[e.ETC2_RGBA8=77]="ETC2_RGBA8",e[e.ETC2_SRGB8_A8=78]="ETC2_SRGB8_A8",e[e.EAC_R11=79]="EAC_R11",e[e.EAC_R11SN=80]="EAC_R11SN",e[e.EAC_RG11=81]="EAC_RG11",e[e.EAC_RG11SN=82]="EAC_RG11SN",e[e.PVRTC_RGB2=83]="PVRTC_RGB2",e[e.PVRTC_RGBA2=84]="PVRTC_RGBA2",e[e.PVRTC_RGB4=85]="PVRTC_RGB4",e[e.PVRTC_RGBA4=86]="PVRTC_RGBA4",e[e.PVRTC2_2BPP=87]="PVRTC2_2BPP",e[e.PVRTC2_4BPP=88]="PVRTC2_4BPP",e[e.ASTC_RGBA_4X4=89]="ASTC_RGBA_4X4",e[e.ASTC_RGBA_5X4=90]="ASTC_RGBA_5X4",e[e.ASTC_RGBA_5X5=91]="ASTC_RGBA_5X5",e[e.ASTC_RGBA_6X5=92]="ASTC_RGBA_6X5",e[e.ASTC_RGBA_6X6=93]="ASTC_RGBA_6X6",e[e.ASTC_RGBA_8X5=94]="ASTC_RGBA_8X5",e[e.ASTC_RGBA_8X6=95]="ASTC_RGBA_8X6",e[e.ASTC_RGBA_8X8=96]="ASTC_RGBA_8X8",e[e.ASTC_RGBA_10X5=97]="ASTC_RGBA_10X5",e[e.ASTC_RGBA_10X6=98]="ASTC_RGBA_10X6",e[e.ASTC_RGBA_10X8=99]="ASTC_RGBA_10X8",e[e.ASTC_RGBA_10X10=100]="ASTC_RGBA_10X10",e[e.ASTC_RGBA_12X10=101]="ASTC_RGBA_12X10",e[e.ASTC_RGBA_12X12=102]="ASTC_RGBA_12X12",e[e.ASTC_SRGBA_4X4=103]="ASTC_SRGBA_4X4",e[e.ASTC_SRGBA_5X4=104]="ASTC_SRGBA_5X4",e[e.ASTC_SRGBA_5X5=105]="ASTC_SRGBA_5X5",e[e.ASTC_SRGBA_6X5=106]="ASTC_SRGBA_6X5",e[e.ASTC_SRGBA_6X6=107]="ASTC_SRGBA_6X6",e[e.ASTC_SRGBA_8X5=108]="ASTC_SRGBA_8X5",e[e.ASTC_SRGBA_8X6=109]="ASTC_SRGBA_8X6",e[e.ASTC_SRGBA_8X8=110]="ASTC_SRGBA_8X8",e[e.ASTC_SRGBA_10X5=111]="ASTC_SRGBA_10X5",e[e.ASTC_SRGBA_10X6=112]="ASTC_SRGBA_10X6",e[e.ASTC_SRGBA_10X8=113]="ASTC_SRGBA_10X8",e[e.ASTC_SRGBA_10X10=114]="ASTC_SRGBA_10X10",e[e.ASTC_SRGBA_12X10=115]="ASTC_SRGBA_12X10",e[e.ASTC_SRGBA_12X12=116]="ASTC_SRGBA_12X12",e[e.COUNT=117]="COUNT"}(ai||(ai={})),function(e){e[e.NONE=0]="NONE",e[e.UNORM=1]="UNORM",e[e.SNORM=2]="SNORM",e[e.UINT=3]="UINT",e[e.INT=4]="INT",e[e.UFLOAT=5]="UFLOAT",e[e.FLOAT=6]="FLOAT"}(si||(si={})),function(e){e[e.UNKNOWN=0]="UNKNOWN",e[e.BOOL=1]="BOOL",e[e.BOOL2=2]="BOOL2",e[e.BOOL3=3]="BOOL3",e[e.BOOL4=4]="BOOL4",e[e.INT=5]="INT",e[e.INT2=6]="INT2",e[e.INT3=7]="INT3",e[e.INT4=8]="INT4",e[e.UINT=9]="UINT",e[e.UINT2=10]="UINT2",e[e.UINT3=11]="UINT3",e[e.UINT4=12]="UINT4",e[e.FLOAT=13]="FLOAT",e[e.FLOAT2=14]="FLOAT2",e[e.FLOAT3=15]="FLOAT3",e[e.FLOAT4=16]="FLOAT4",e[e.MAT2=17]="MAT2",e[e.MAT2X3=18]="MAT2X3",e[e.MAT2X4=19]="MAT2X4",e[e.MAT3X2=20]="MAT3X2",e[e.MAT3=21]="MAT3",e[e.MAT3X4=22]="MAT3X4",e[e.MAT4X2=23]="MAT4X2",e[e.MAT4X3=24]="MAT4X3",e[e.MAT4=25]="MAT4",e[e.SAMPLER1D=26]="SAMPLER1D",e[e.SAMPLER1D_ARRAY=27]="SAMPLER1D_ARRAY",e[e.SAMPLER2D=28]="SAMPLER2D",e[e.SAMPLER2D_ARRAY=29]="SAMPLER2D_ARRAY",e[e.SAMPLER3D=30]="SAMPLER3D",e[e.SAMPLER_CUBE=31]="SAMPLER_CUBE",e[e.SAMPLER=32]="SAMPLER",e[e.TEXTURE1D=33]="TEXTURE1D",e[e.TEXTURE1D_ARRAY=34]="TEXTURE1D_ARRAY",e[e.TEXTURE2D=35]="TEXTURE2D",e[e.TEXTURE2D_ARRAY=36]="TEXTURE2D_ARRAY",e[e.TEXTURE3D=37]="TEXTURE3D",e[e.TEXTURE_CUBE=38]="TEXTURE_CUBE",e[e.IMAGE1D=39]="IMAGE1D",e[e.IMAGE1D_ARRAY=40]="IMAGE1D_ARRAY",e[e.IMAGE2D=41]="IMAGE2D",e[e.IMAGE2D_ARRAY=42]="IMAGE2D_ARRAY",e[e.IMAGE3D=43]="IMAGE3D",e[e.IMAGE_CUBE=44]="IMAGE_CUBE",e[e.SUBPASS_INPUT=45]="SUBPASS_INPUT",e[e.COUNT=46]="COUNT"}(ci||(ci={})),function(e){e[e.NONE=0]="NONE",e[e.TRANSFER_SRC=1]="TRANSFER_SRC",e[e.TRANSFER_DST=2]="TRANSFER_DST",e[e.INDEX=4]="INDEX",e[e.VERTEX=8]="VERTEX",e[e.UNIFORM=16]="UNIFORM",e[e.STORAGE=32]="STORAGE",e[e.INDIRECT=64]="INDIRECT"}(li||(li={})),function(e){e[e.NONE=0]="NONE"}(ui||(ui={})),function(e){e[e.NONE=0]="NONE",e[e.READ_ONLY=1]="READ_ONLY",e[e.WRITE_ONLY=2]="WRITE_ONLY",e[e.READ_WRITE=3]="READ_WRITE"}(hi||(hi={})),function(e){e[e.NONE=0]="NONE",e[e.DEVICE=1]="DEVICE",e[e.HOST=2]="HOST"}(_i||(_i={})),function(e){e[e.TEX1D=0]="TEX1D",e[e.TEX2D=1]="TEX2D",e[e.TEX3D=2]="TEX3D",e[e.CUBE=3]="CUBE",e[e.TEX1D_ARRAY=4]="TEX1D_ARRAY",e[e.TEX2D_ARRAY=5]="TEX2D_ARRAY"}(fi||(fi={})),function(e){e[e.NONE=0]="NONE",e[e.TRANSFER_SRC=1]="TRANSFER_SRC",e[e.TRANSFER_DST=2]="TRANSFER_DST",e[e.SAMPLED=4]="SAMPLED",e[e.STORAGE=8]="STORAGE",e[e.COLOR_ATTACHMENT=16]="COLOR_ATTACHMENT",e[e.DEPTH_STENCIL_ATTACHMENT=32]="DEPTH_STENCIL_ATTACHMENT",e[e.INPUT_ATTACHMENT=64]="INPUT_ATTACHMENT"}(di||(di={})),function(e){e[e.NONE=0]="NONE",e[e.GEN_MIPMAP=1]="GEN_MIPMAP",e[e.GENERAL_LAYOUT=2]="GENERAL_LAYOUT"}(pi||(pi={})),function(e){e[e.NONE=0]="NONE",e[e.RENDER_TARGET=1]="RENDER_TARGET",e[e.SAMPLED_TEXTURE=2]="SAMPLED_TEXTURE",e[e.LINEAR_FILTER=4]="LINEAR_FILTER",e[e.STORAGE_TEXTURE=8]="STORAGE_TEXTURE",e[e.VERTEX_ATTRIBUTE=16]="VERTEX_ATTRIBUTE"}(mi||(mi={})),function(e){e[e.ONE=0]="ONE",e[e.MULTIPLE_PERFORMANCE=1]="MULTIPLE_PERFORMANCE",e[e.MULTIPLE_BALANCE=2]="MULTIPLE_BALANCE",e[e.MULTIPLE_QUALITY=3]="MULTIPLE_QUALITY"}(vi||(vi={})),function(e){e[e.OFF=0]="OFF",e[e.ON=1]="ON",e[e.RELAXED=2]="RELAXED",e[e.MAILBOX=3]="MAILBOX",e[e.HALF=4]="HALF"}(gi||(gi={})),function(e){e[e.NONE=0]="NONE",e[e.POINT=1]="POINT",e[e.LINEAR=2]="LINEAR",e[e.ANISOTROPIC=3]="ANISOTROPIC"}(yi||(yi={})),function(e){e[e.WRAP=0]="WRAP",e[e.MIRROR=1]="MIRROR",e[e.CLAMP=2]="CLAMP",e[e.BORDER=3]="BORDER"}(xi||(xi={})),function(e){e[e.NEVER=0]="NEVER",e[e.LESS=1]="LESS",e[e.EQUAL=2]="EQUAL",e[e.LESS_EQUAL=3]="LESS_EQUAL",e[e.GREATER=4]="GREATER",e[e.NOT_EQUAL=5]="NOT_EQUAL",e[e.GREATER_EQUAL=6]="GREATER_EQUAL",e[e.ALWAYS=7]="ALWAYS"}(Si||(Si={})),function(e){e[e.ZERO=0]="ZERO",e[e.KEEP=1]="KEEP",e[e.REPLACE=2]="REPLACE",e[e.INCR=3]="INCR",e[e.DECR=4]="DECR",e[e.INVERT=5]="INVERT",e[e.INCR_WRAP=6]="INCR_WRAP",e[e.DECR_WRAP=7]="DECR_WRAP"}(Ei||(Ei={})),function(e){e[e.ZERO=0]="ZERO",e[e.ONE=1]="ONE",e[e.SRC_ALPHA=2]="SRC_ALPHA",e[e.DST_ALPHA=3]="DST_ALPHA",e[e.ONE_MINUS_SRC_ALPHA=4]="ONE_MINUS_SRC_ALPHA",e[e.ONE_MINUS_DST_ALPHA=5]="ONE_MINUS_DST_ALPHA",e[e.SRC_COLOR=6]="SRC_COLOR",e[e.DST_COLOR=7]="DST_COLOR",e[e.ONE_MINUS_SRC_COLOR=8]="ONE_MINUS_SRC_COLOR",e[e.ONE_MINUS_DST_COLOR=9]="ONE_MINUS_DST_COLOR",e[e.SRC_ALPHA_SATURATE=10]="SRC_ALPHA_SATURATE",e[e.CONSTANT_COLOR=11]="CONSTANT_COLOR",e[e.ONE_MINUS_CONSTANT_COLOR=12]="ONE_MINUS_CONSTANT_COLOR",e[e.CONSTANT_ALPHA=13]="CONSTANT_ALPHA",e[e.ONE_MINUS_CONSTANT_ALPHA=14]="ONE_MINUS_CONSTANT_ALPHA"}(Ti||(Ti={})),function(e){e[e.ADD=0]="ADD",e[e.SUB=1]="SUB",e[e.REV_SUB=2]="REV_SUB",e[e.MIN=3]="MIN",e[e.MAX=4]="MAX"}(Ci||(Ci={})),function(e){e[e.NONE=0]="NONE",e[e.R=1]="R",e[e.G=2]="G",e[e.B=4]="B",e[e.A=8]="A",e[e.ALL=15]="ALL"}(bi||(bi={})),function(e){e[e.NONE=0]="NONE",e[e.VERTEX=1]="VERTEX",e[e.CONTROL=2]="CONTROL",e[e.EVALUATION=4]="EVALUATION",e[e.GEOMETRY=8]="GEOMETRY",e[e.FRAGMENT=16]="FRAGMENT",e[e.COMPUTE=32]="COMPUTE",e[e.ALL=63]="ALL"}(Ai||(Ai={})),function(e){e[e.LOAD=0]="LOAD",e[e.CLEAR=1]="CLEAR",e[e.DISCARD=2]="DISCARD"}(wi||(wi={})),function(e){e[e.STORE=0]="STORE",e[e.DISCARD=1]="DISCARD"}(Ii||(Ii={})),function(e){e[e.NONE=0]="NONE",e[e.INDIRECT_BUFFER=1]="INDIRECT_BUFFER",e[e.INDEX_BUFFER=2]="INDEX_BUFFER",e[e.VERTEX_BUFFER=4]="VERTEX_BUFFER",e[e.VERTEX_SHADER_READ_UNIFORM_BUFFER=8]="VERTEX_SHADER_READ_UNIFORM_BUFFER",e[e.VERTEX_SHADER_READ_TEXTURE=16]="VERTEX_SHADER_READ_TEXTURE",e[e.VERTEX_SHADER_READ_OTHER=32]="VERTEX_SHADER_READ_OTHER",e[e.FRAGMENT_SHADER_READ_UNIFORM_BUFFER=64]="FRAGMENT_SHADER_READ_UNIFORM_BUFFER",e[e.FRAGMENT_SHADER_READ_TEXTURE=128]="FRAGMENT_SHADER_READ_TEXTURE",e[e.FRAGMENT_SHADER_READ_COLOR_INPUT_ATTACHMENT=256]="FRAGMENT_SHADER_READ_COLOR_INPUT_ATTACHMENT",e[e.FRAGMENT_SHADER_READ_DEPTH_STENCIL_INPUT_ATTACHMENT=512]="FRAGMENT_SHADER_READ_DEPTH_STENCIL_INPUT_ATTACHMENT",e[e.FRAGMENT_SHADER_READ_OTHER=1024]="FRAGMENT_SHADER_READ_OTHER",e[e.COLOR_ATTACHMENT_READ=2048]="COLOR_ATTACHMENT_READ",e[e.DEPTH_STENCIL_ATTACHMENT_READ=4096]="DEPTH_STENCIL_ATTACHMENT_READ",e[e.COMPUTE_SHADER_READ_UNIFORM_BUFFER=8192]="COMPUTE_SHADER_READ_UNIFORM_BUFFER",e[e.COMPUTE_SHADER_READ_TEXTURE=16384]="COMPUTE_SHADER_READ_TEXTURE",e[e.COMPUTE_SHADER_READ_OTHER=32768]="COMPUTE_SHADER_READ_OTHER",e[e.TRANSFER_READ=65536]="TRANSFER_READ",e[e.HOST_READ=131072]="HOST_READ",e[e.PRESENT=262144]="PRESENT",e[e.VERTEX_SHADER_WRITE=524288]="VERTEX_SHADER_WRITE",e[e.FRAGMENT_SHADER_WRITE=1048576]="FRAGMENT_SHADER_WRITE",e[e.COLOR_ATTACHMENT_WRITE=2097152]="COLOR_ATTACHMENT_WRITE",e[e.DEPTH_STENCIL_ATTACHMENT_WRITE=4194304]="DEPTH_STENCIL_ATTACHMENT_WRITE",e[e.COMPUTE_SHADER_WRITE=8388608]="COMPUTE_SHADER_WRITE",e[e.TRANSFER_WRITE=16777216]="TRANSFER_WRITE",e[e.HOST_PREINITIALIZED=33554432]="HOST_PREINITIALIZED",e[e.HOST_WRITE=67108864]="HOST_WRITE"}(Pi||(Pi={})),function(e){e[e.NONE=0]="NONE",e[e.SAMPLE_ZERO=1]="SAMPLE_ZERO",e[e.AVERAGE=2]="AVERAGE",e[e.MIN=3]="MIN",e[e.MAX=4]="MAX"}(Ri||(Ri={})),function(e){e[e.GRAPHICS=0]="GRAPHICS",e[e.COMPUTE=1]="COMPUTE",e[e.RAY_TRACING=2]="RAY_TRACING"}(Di||(Di={})),function(e){e[e.POINT_LIST=0]="POINT_LIST",e[e.LINE_LIST=1]="LINE_LIST",e[e.LINE_STRIP=2]="LINE_STRIP",e[e.LINE_LOOP=3]="LINE_LOOP",e[e.LINE_LIST_ADJACENCY=4]="LINE_LIST_ADJACENCY",e[e.LINE_STRIP_ADJACENCY=5]="LINE_STRIP_ADJACENCY",e[e.ISO_LINE_LIST=6]="ISO_LINE_LIST",e[e.TRIANGLE_LIST=7]="TRIANGLE_LIST",e[e.TRIANGLE_STRIP=8]="TRIANGLE_STRIP",e[e.TRIANGLE_FAN=9]="TRIANGLE_FAN",e[e.TRIANGLE_LIST_ADJACENCY=10]="TRIANGLE_LIST_ADJACENCY",e[e.TRIANGLE_STRIP_ADJACENCY=11]="TRIANGLE_STRIP_ADJACENCY",e[e.TRIANGLE_PATCH_ADJACENCY=12]="TRIANGLE_PATCH_ADJACENCY",e[e.QUAD_PATCH_LIST=13]="QUAD_PATCH_LIST"}(Oi||(Oi={})),function(e){e[e.FILL=0]="FILL",e[e.POINT=1]="POINT",e[e.LINE=2]="LINE"}(Ni||(Ni={})),function(e){e[e.GOURAND=0]="GOURAND",e[e.FLAT=1]="FLAT"}(Mi||(Mi={})),function(e){e[e.NONE=0]="NONE",e[e.FRONT=1]="FRONT",e[e.BACK=2]="BACK"}(Li||(Li={})),function(e){e[e.NONE=0]="NONE",e[e.LINE_WIDTH=1]="LINE_WIDTH",e[e.DEPTH_BIAS=2]="DEPTH_BIAS",e[e.BLEND_CONSTANTS=4]="BLEND_CONSTANTS",e[e.DEPTH_BOUNDS=8]="DEPTH_BOUNDS",e[e.STENCIL_WRITE_MASK=16]="STENCIL_WRITE_MASK",e[e.STENCIL_COMPARE_MASK=32]="STENCIL_COMPARE_MASK"}(Fi||(Fi={})),function(e){e[e.FRONT=1]="FRONT",e[e.BACK=2]="BACK",e[e.ALL=3]="ALL"}(Bi||(Bi={})),function(e){e[e.UNKNOWN=0]="UNKNOWN",e[e.UNIFORM_BUFFER=1]="UNIFORM_BUFFER",e[e.DYNAMIC_UNIFORM_BUFFER=2]="DYNAMIC_UNIFORM_BUFFER",e[e.STORAGE_BUFFER=4]="STORAGE_BUFFER",e[e.DYNAMIC_STORAGE_BUFFER=8]="DYNAMIC_STORAGE_BUFFER",e[e.SAMPLER_TEXTURE=16]="SAMPLER_TEXTURE",e[e.SAMPLER=32]="SAMPLER",e[e.TEXTURE=64]="TEXTURE",e[e.STORAGE_IMAGE=128]="STORAGE_IMAGE",e[e.INPUT_ATTACHMENT=256]="INPUT_ATTACHMENT"}(zi||(zi={})),function(e){e[e.GRAPHICS=0]="GRAPHICS",e[e.COMPUTE=1]="COMPUTE",e[e.TRANSFER=2]="TRANSFER"}(Ui||(Ui={})),function(e){e[e.OCCLUSION=0]="OCCLUSION",e[e.PIPELINE_STATISTICS=1]="PIPELINE_STATISTICS",e[e.TIMESTAMP=2]="TIMESTAMP"}(ki||(ki={})),function(e){e[e.PRIMARY=0]="PRIMARY",e[e.SECONDARY=1]="SECONDARY"}(Gi||(Gi={})),function(e){e[e.NONE=0]="NONE",e[e.COLOR=1]="COLOR",e[e.DEPTH=2]="DEPTH",e[e.STENCIL=4]="STENCIL",e[e.DEPTH_STENCIL=6]="DEPTH_STENCIL",e[e.ALL=7]="ALL"}(Hi||(Hi={}));var qi,Xi=function(){function e(e,t,n){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),this.x=e,this.y=t,this.z=n}return e.prototype.copy=function(e){return this.x=e.x,this.y=e.y,this.z=e.z,this},e}(),Yi=function(){function e(e,t,n,i,r,o,a,s,c,l,u,h,_,f,d,p,m,v,g,y,x,S){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===o&&(o=0),void 0===a&&(a=0),void 0===s&&(s=0),void 0===c&&(c=0),void 0===l&&(l=0),void 0===u&&(u=0),void 0===h&&(h=0),void 0===_&&(_=0),void 0===f&&(f=1),void 0===d&&(d=0),void 0===p&&(p=0),void 0===m&&(m=new Xi),void 0===v&&(v=new Xi),void 0===g&&(g=!1),void 0===y&&(y=-1),void 0===x&&(x=1),void 0===S&&(S=1),this.maxVertexAttributes=e,this.maxVertexUniformVectors=t,this.maxFragmentUniformVectors=n,this.maxTextureUnits=i,this.maxImageUnits=r,this.maxVertexTextureUnits=o,this.maxColorRenderTargets=a,this.maxShaderStorageBufferBindings=s,this.maxShaderStorageBlockSize=c,this.maxUniformBufferBindings=l,this.maxUniformBlockSize=u,this.maxTextureSize=h,this.maxCubeMapTextureSize=_,this.uboOffsetAlignment=f,this.maxComputeSharedMemorySize=d,this.maxComputeWorkGroupInvocations=p,this.maxComputeWorkGroupSize=m,this.maxComputeWorkGroupCount=v,this.supportQuery=g,this.clipSpaceMinZ=y,this.screenSpaceSignY=x,this.clipSpaceSignY=S}return e.prototype.copy=function(e){return this.maxVertexAttributes=e.maxVertexAttributes,this.maxVertexUniformVectors=e.maxVertexUniformVectors,this.maxFragmentUniformVectors=e.maxFragmentUniformVectors,this.maxTextureUnits=e.maxTextureUnits,this.maxImageUnits=e.maxImageUnits,this.maxVertexTextureUnits=e.maxVertexTextureUnits,this.maxColorRenderTargets=e.maxColorRenderTargets,this.maxShaderStorageBufferBindings=e.maxShaderStorageBufferBindings,this.maxShaderStorageBlockSize=e.maxShaderStorageBlockSize,this.maxUniformBufferBindings=e.maxUniformBufferBindings,this.maxUniformBlockSize=e.maxUniformBlockSize,this.maxTextureSize=e.maxTextureSize,this.maxCubeMapTextureSize=e.maxCubeMapTextureSize,this.uboOffsetAlignment=e.uboOffsetAlignment,this.maxComputeSharedMemorySize=e.maxComputeSharedMemorySize,this.maxComputeWorkGroupInvocations=e.maxComputeWorkGroupInvocations,this.maxComputeWorkGroupSize.copy(e.maxComputeWorkGroupSize),this.maxComputeWorkGroupCount.copy(e.maxComputeWorkGroupCount),this.supportQuery=e.supportQuery,this.clipSpaceMinZ=e.clipSpaceMinZ,this.screenSpaceSignY=e.screenSpaceSignY,this.clipSpaceSignY=e.clipSpaceSignY,this},e}(),Ki=function(){function e(e,t,n){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),this.x=e,this.y=t,this.z=n}return e.prototype.copy=function(e){return this.x=e.x,this.y=e.y,this.z=e.z,this},e}(),Qi=function(){function e(e,t,n,i){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),this.x=e,this.y=t,this.width=n,this.height=i}return e.prototype.copy=function(e){return this.x=e.x,this.y=e.y,this.width=e.width,this.height=e.height,this},e}(),Ji=function(){function e(e,t,n){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=1),this.width=e,this.height=t,this.depth=n}return e.prototype.copy=function(e){return this.width=e.width,this.height=e.height,this.depth=e.depth,this},e}(),Zi=function(){function e(e,t,n){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=1),this.mipLevel=e,this.baseArrayLayer=t,this.layerCount=n}return e.prototype.copy=function(e){return this.mipLevel=e.mipLevel,this.baseArrayLayer=e.baseArrayLayer,this.layerCount=e.layerCount,this},e}(),$i=function(){function e(e,t,n,i){void 0===e&&(e=0),void 0===t&&(t=1),void 0===n&&(n=0),void 0===i&&(i=1),this.baseMipLevel=e,this.levelCount=t,this.baseArrayLayer=n,this.layerCount=i}return e.prototype.copy=function(e){return this.baseMipLevel=e.baseMipLevel,this.levelCount=e.levelCount,this.baseArrayLayer=e.baseArrayLayer,this.layerCount=e.layerCount,this},e}(),er=function(){function e(e,t,n,i,r){void 0===e&&(e=new Zi),void 0===t&&(t=new Ki),void 0===n&&(n=new Zi),void 0===i&&(i=new Ki),void 0===r&&(r=new Ji),this.srcSubres=e,this.srcOffset=t,this.dstSubres=n,this.dstOffset=i,this.extent=r}return e.prototype.copy=function(e){return this.srcSubres.copy(e.srcSubres),this.srcOffset.copy(e.srcOffset),this.dstSubres.copy(e.dstSubres),this.dstOffset.copy(e.dstOffset),this.extent.copy(e.extent),this},e}(),tr=function(){function e(e,t,n,i,r,o){void 0===e&&(e=new Zi),void 0===t&&(t=new Ki),void 0===n&&(n=new Ji),void 0===i&&(i=new Zi),void 0===r&&(r=new Ki),void 0===o&&(o=new Ji),this.srcSubres=e,this.srcOffset=t,this.srcExtent=n,this.dstSubres=i,this.dstOffset=r,this.dstExtent=o}return e.prototype.copy=function(e){return this.srcSubres.copy(e.srcSubres),this.srcOffset.copy(e.srcOffset),this.srcExtent.copy(e.srcExtent),this.dstSubres.copy(e.dstSubres),this.dstOffset.copy(e.dstOffset),this.dstExtent.copy(e.dstExtent),this},e}(),nr=function(){function e(e,t,n,i,r){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=new Ki),void 0===i&&(i=new Ji),void 0===r&&(r=new Zi),this.buffStride=e,this.buffTexHeight=t,this.texOffset=n,this.texExtent=i,this.texSubres=r}return e.prototype.copy=function(e){return this.buffStride=e.buffStride,this.buffTexHeight=e.buffTexHeight,this.texOffset.copy(e.texOffset),this.texExtent.copy(e.texExtent),this.texSubres.copy(e.texSubres),this},e}(),ir=function(){function e(e,t,n,i,r,o){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===o&&(o=1),this.left=e,this.top=t,this.width=n,this.height=i,this.minDepth=r,this.maxDepth=o}return e.prototype.copy=function(e){return this.left=e.left,this.top=e.top,this.width=e.width,this.height=e.height,this.minDepth=e.minDepth,this.maxDepth=e.maxDepth,this},e}(),rr=function(){function e(e,t,n,i){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),this.x=e,this.y=t,this.z=n,this.w=i}return e.prototype.copy=function(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w,this},e}(),or=function(){function e(e,t,n,i,r,o,a,s){void 0===e&&(e=[0]),void 0===t&&(t=[0]),void 0===n&&(n=[0]),void 0===i&&(i=[0]),void 0===r&&(r=[0]),void 0===o&&(o=[0]),void 0===a&&(a=[0]),void 0===s&&(s=[0]),this.maxBlockCounts=e,this.maxSamplerTextureCounts=t,this.maxSamplerCounts=n,this.maxTextureCounts=i,this.maxBufferCounts=r,this.maxImageCounts=o,this.maxSubpassInputCounts=a,this.setIndices=s}return e.prototype.copy=function(e){return this.maxBlockCounts=e.maxBlockCounts.slice(),this.maxSamplerTextureCounts=e.maxSamplerTextureCounts.slice(),this.maxSamplerCounts=e.maxSamplerCounts.slice(),this.maxTextureCounts=e.maxTextureCounts.slice(),this.maxBufferCounts=e.maxBufferCounts.slice(),this.maxImageCounts=e.maxImageCounts.slice(),this.maxSubpassInputCounts=e.maxSubpassInputCounts.slice(),this.setIndices=e.setIndices.slice(),this},e}(),ar=function(){function e(e,t,n,i){void 0===e&&(e=null),void 0===t&&(t=gi.ON),void 0===n&&(n=0),void 0===i&&(i=0),this.windowHandle=e,this.vsyncMode=t,this.width=n,this.height=i}return e.prototype.copy=function(e){return this.windowHandle=e.windowHandle,this.vsyncMode=e.vsyncMode,this.width=e.width,this.height=e.height,this},e}(),sr=function(){function e(e){void 0===e&&(e=new or),this.bindingMappingInfo=e}return e.prototype.copy=function(e){return this.bindingMappingInfo.copy(e.bindingMappingInfo),this},e}(),cr=function(){function e(e,t,n,i,r){void 0===e&&(e=li.NONE),void 0===t&&(t=_i.NONE),void 0===n&&(n=0),void 0===i&&(i=1),void 0===r&&(r=ui.NONE),this.usage=e,this.memUsage=t,this.size=n,this.stride=i,this.flags=r}return e.prototype.copy=function(e){return this.usage=e.usage,this.memUsage=e.memUsage,this.size=e.size,this.stride=e.stride,this.flags=e.flags,this},e}(),lr=function(){function e(e,t,n){void 0===e&&(e=null),void 0===t&&(t=0),void 0===n&&(n=0),this.buffer=e,this.offset=t,this.range=n}return e.prototype.copy=function(e){return this.buffer=e.buffer,this.offset=e.offset,this.range=e.range,this},e}(),ur=function(){function e(e,t,n,i,r,o,a){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===o&&(o=0),void 0===a&&(a=0),this.vertexCount=e,this.firstVertex=t,this.indexCount=n,this.firstIndex=i,this.vertexOffset=r,this.instanceCount=o,this.firstInstance=a}return e.prototype.copy=function(e){return this.vertexCount=e.vertexCount,this.firstVertex=e.firstVertex,this.indexCount=e.indexCount,this.firstIndex=e.firstIndex,this.vertexOffset=e.vertexOffset,this.instanceCount=e.instanceCount,this.firstInstance=e.firstInstance,this},e}(),hr=function(){function e(e,t,n,i,r){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=null),void 0===r&&(r=0),this.groupCountX=e,this.groupCountY=t,this.groupCountZ=n,this.indirectBuffer=i,this.indirectOffset=r}return e.prototype.copy=function(e){return this.groupCountX=e.groupCountX,this.groupCountY=e.groupCountY,this.groupCountZ=e.groupCountZ,this.indirectBuffer=e.indirectBuffer,this.indirectOffset=e.indirectOffset,this},e}(),_r=function(){function e(e){void 0===e&&(e=[]),this.drawInfos=e}return e.prototype.copy=function(e){return ji(this.drawInfos,e.drawInfos,ur),this},e}(),fr=function(){function e(e,t,n,i,r,o,a,s,c,l,u){void 0===e&&(e=fi.TEX2D),void 0===t&&(t=di.NONE),void 0===n&&(n=ai.UNKNOWN),void 0===i&&(i=0),void 0===r&&(r=0),void 0===o&&(o=pi.NONE),void 0===a&&(a=1),void 0===s&&(s=1),void 0===c&&(c=vi.ONE),void 0===l&&(l=1),void 0===u&&(u=0),this.type=e,this.usage=t,this.format=n,this.width=i,this.height=r,this.flags=o,this.layerCount=a,this.levelCount=s,this.samples=c,this.depth=l,this.externalRes=u}return e.prototype.copy=function(e){return this.type=e.type,this.usage=e.usage,this.format=e.format,this.width=e.width,this.height=e.height,this.flags=e.flags,this.layerCount=e.layerCount,this.levelCount=e.levelCount,this.samples=e.samples,this.depth=e.depth,this.externalRes=e.externalRes,this},e}(),dr=function(){function e(e,t,n,i,r,o,a){void 0===e&&(e=null),void 0===t&&(t=fi.TEX2D),void 0===n&&(n=ai.UNKNOWN),void 0===i&&(i=0),void 0===r&&(r=1),void 0===o&&(o=0),void 0===a&&(a=1),this.texture=e,this.type=t,this.format=n,this.baseLevel=i,this.levelCount=r,this.baseLayer=o,this.layerCount=a}return e.prototype.copy=function(e){return this.texture=e.texture,this.type=e.type,this.format=e.format,this.baseLevel=e.baseLevel,this.levelCount=e.levelCount,this.baseLayer=e.baseLayer,this.layerCount=e.layerCount,this},e}(),pr=function(){function e(e,t,n,i,r,o,a,s){void 0===e&&(e=yi.LINEAR),void 0===t&&(t=yi.LINEAR),void 0===n&&(n=yi.NONE),void 0===i&&(i=xi.WRAP),void 0===r&&(r=xi.WRAP),void 0===o&&(o=xi.WRAP),void 0===a&&(a=0),void 0===s&&(s=Si.ALWAYS),this.minFilter=e,this.magFilter=t,this.mipFilter=n,this.addressU=i,this.addressV=r,this.addressW=o,this.maxAnisotropy=a,this.cmpFunc=s}return e.prototype.copy=function(e){return this.minFilter=e.minFilter,this.magFilter=e.magFilter,this.mipFilter=e.mipFilter,this.addressU=e.addressU,this.addressV=e.addressV,this.addressW=e.addressW,this.maxAnisotropy=e.maxAnisotropy,this.cmpFunc=e.cmpFunc,this},e}(),mr=function(){function e(e,t,n){void 0===e&&(e=""),void 0===t&&(t=ci.UNKNOWN),void 0===n&&(n=0),this.name=e,this.type=t,this.count=n}return e.prototype.copy=function(e){return this.name=e.name,this.type=e.type,this.count=e.count,this},e}(),vr=function(){function e(e,t,n,i,r){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=""),void 0===i&&(i=[]),void 0===r&&(r=0),this.set=e,this.binding=t,this.name=n,this.members=i,this.count=r}return e.prototype.copy=function(e){return this.set=e.set,this.binding=e.binding,this.name=e.name,ji(this.members,e.members,mr),this.count=e.count,this},e}(),gr=function(){function e(e,t,n,i,r){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=""),void 0===i&&(i=ci.UNKNOWN),void 0===r&&(r=0),this.set=e,this.binding=t,this.name=n,this.type=i,this.count=r}return e.prototype.copy=function(e){return this.set=e.set,this.binding=e.binding,this.name=e.name,this.type=e.type,this.count=e.count,this},e}(),yr=function(){function e(e,t,n,i){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=""),void 0===i&&(i=0),this.set=e,this.binding=t,this.name=n,this.count=i}return e.prototype.copy=function(e){return this.set=e.set,this.binding=e.binding,this.name=e.name,this.count=e.count,this},e}(),xr=function(){function e(e,t,n,i,r){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=""),void 0===i&&(i=ci.UNKNOWN),void 0===r&&(r=0),this.set=e,this.binding=t,this.name=n,this.type=i,this.count=r}return e.prototype.copy=function(e){return this.set=e.set,this.binding=e.binding,this.name=e.name,this.type=e.type,this.count=e.count,this},e}(),Sr=function(){function e(e,t,n,i,r,o){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=""),void 0===i&&(i=ci.UNKNOWN),void 0===r&&(r=0),void 0===o&&(o=hi.READ_WRITE),this.set=e,this.binding=t,this.name=n,this.type=i,this.count=r,this.memoryAccess=o}return e.prototype.copy=function(e){return this.set=e.set,this.binding=e.binding,this.name=e.name,this.type=e.type,this.count=e.count,this.memoryAccess=e.memoryAccess,this},e}(),Er=function(){function e(e,t,n,i,r){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=""),void 0===i&&(i=0),void 0===r&&(r=hi.READ_WRITE),this.set=e,this.binding=t,this.name=n,this.count=i,this.memoryAccess=r}return e.prototype.copy=function(e){return this.set=e.set,this.binding=e.binding,this.name=e.name,this.count=e.count,this.memoryAccess=e.memoryAccess,this},e}(),Tr=function(){function e(e,t,n,i){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=""),void 0===i&&(i=0),this.set=e,this.binding=t,this.name=n,this.count=i}return e.prototype.copy=function(e){return this.set=e.set,this.binding=e.binding,this.name=e.name,this.count=e.count,this},e}(),Cr=function(){function e(e,t){void 0===e&&(e=Ai.NONE),void 0===t&&(t=""),this.stage=e,this.source=t}return e.prototype.copy=function(e){return this.stage=e.stage,this.source=e.source,this},e}(),br=function(){function e(e,t,n,i,r,o){void 0===e&&(e=""),void 0===t&&(t=ai.UNKNOWN),void 0===n&&(n=!1),void 0===i&&(i=0),void 0===r&&(r=!1),void 0===o&&(o=0),this.name=e,this.format=t,this.isNormalized=n,this.stream=i,this.isInstanced=r,this.location=o}return e.prototype.copy=function(e){return this.name=e.name,this.format=e.format,this.isNormalized=e.isNormalized,this.stream=e.stream,this.isInstanced=e.isInstanced,this.location=e.location,this},e}(),Ar=function(){function e(e,t,n,i,r,o,a,s,c,l){void 0===e&&(e=""),void 0===t&&(t=[]),void 0===n&&(n=[]),void 0===i&&(i=[]),void 0===r&&(r=[]),void 0===o&&(o=[]),void 0===a&&(a=[]),void 0===s&&(s=[]),void 0===c&&(c=[]),void 0===l&&(l=[]),this.name=e,this.stages=t,this.attributes=n,this.blocks=i,this.buffers=r,this.samplerTextures=o,this.samplers=a,this.textures=s,this.images=c,this.subpassInputs=l}return e.prototype.copy=function(e){return this.name=e.name,ji(this.stages,e.stages,Cr),ji(this.attributes,e.attributes,br),ji(this.blocks,e.blocks,vr),ji(this.buffers,e.buffers,Er),ji(this.samplerTextures,e.samplerTextures,gr),ji(this.samplers,e.samplers,yr),ji(this.textures,e.textures,xr),ji(this.images,e.images,Sr),ji(this.subpassInputs,e.subpassInputs,Tr),this},e}(),wr=function(){function e(e,t,n,i){void 0===e&&(e=[]),void 0===t&&(t=[]),void 0===n&&(n=null),void 0===i&&(i=null),this.attributes=e,this.vertexBuffers=t,this.indexBuffer=n,this.indirectBuffer=i}return e.prototype.copy=function(e){return ji(this.attributes,e.attributes,br),this.vertexBuffers=e.vertexBuffers.slice(),this.indexBuffer=e.indexBuffer,this.indirectBuffer=e.indirectBuffer,this},e}(),Ir=function(){function e(e,t,n,i,r,o){void 0===e&&(e=ai.UNKNOWN),void 0===t&&(t=vi.ONE),void 0===n&&(n=wi.CLEAR),void 0===i&&(i=Ii.STORE),void 0===r&&(r=null),void 0===o&&(o=!1),this.format=e,this.sampleCount=t,this.loadOp=n,this.storeOp=i,this.barrier=r,this.isGeneralLayout=o}return e.prototype.copy=function(e){return this.format=e.format,this.sampleCount=e.sampleCount,this.loadOp=e.loadOp,this.storeOp=e.storeOp,this.barrier=e.barrier,this.isGeneralLayout=e.isGeneralLayout,this},e}(),Pr=function(){function e(e,t,n,i,r,o,a,s){void 0===e&&(e=ai.UNKNOWN),void 0===t&&(t=vi.ONE),void 0===n&&(n=wi.CLEAR),void 0===i&&(i=Ii.STORE),void 0===r&&(r=wi.CLEAR),void 0===o&&(o=Ii.STORE),void 0===a&&(a=null),void 0===s&&(s=!1),this.format=e,this.sampleCount=t,this.depthLoadOp=n,this.depthStoreOp=i,this.stencilLoadOp=r,this.stencilStoreOp=o,this.barrier=a,this.isGeneralLayout=s}return e.prototype.copy=function(e){return this.format=e.format,this.sampleCount=e.sampleCount,this.depthLoadOp=e.depthLoadOp,this.depthStoreOp=e.depthStoreOp,this.stencilLoadOp=e.stencilLoadOp,this.stencilStoreOp=e.stencilStoreOp,this.barrier=e.barrier,this.isGeneralLayout=e.isGeneralLayout,this},e}(),Rr=function(){function e(e,t,n,i,r,o,a,s){void 0===e&&(e=[]),void 0===t&&(t=[]),void 0===n&&(n=[]),void 0===i&&(i=[]),void 0===r&&(r=-1),void 0===o&&(o=-1),void 0===a&&(a=Ri.NONE),void 0===s&&(s=Ri.NONE),this.inputs=e,this.colors=t,this.resolves=n,this.preserves=i,this.depthStencil=r,this.depthStencilResolve=o,this.depthResolveMode=a,this.stencilResolveMode=s}return e.prototype.copy=function(e){return this.inputs=e.inputs.slice(),this.colors=e.colors.slice(),this.resolves=e.resolves.slice(),this.preserves=e.preserves.slice(),this.depthStencil=e.depthStencil,this.depthStencilResolve=e.depthStencilResolve,this.depthResolveMode=e.depthResolveMode,this.stencilResolveMode=e.stencilResolveMode,this},e}(),Dr=function(){function e(e,t,n){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=null),this.srcSubpass=e,this.dstSubpass=t,this.barrier=n}return e.prototype.copy=function(e){return this.srcSubpass=e.srcSubpass,this.dstSubpass=e.dstSubpass,this.barrier=e.barrier,this},e}(),Or=function(){function e(e,t,n,i){void 0===e&&(e=[]),void 0===t&&(t=new Pr),void 0===n&&(n=[]),void 0===i&&(i=[]),this.colorAttachments=e,this.depthStencilAttachment=t,this.subpasses=n,this.dependencies=i}return e.prototype.copy=function(e){return ji(this.colorAttachments,e.colorAttachments,Ir),this.depthStencilAttachment.copy(e.depthStencilAttachment),ji(this.subpasses,e.subpasses,Rr),ji(this.dependencies,e.dependencies,Dr),this},e}(),Nr=function(){function e(e,t){void 0===e&&(e=Pi.NONE),void 0===t&&(t=Pi.NONE),this.prevAccesses=e,this.nextAccesses=t}return e.prototype.copy=function(e){return this.prevAccesses=e.prevAccesses,this.nextAccesses=e.nextAccesses,this},e}(),Mr=function(){function e(e,t,n,i,r){void 0===e&&(e=Pi.NONE),void 0===t&&(t=Pi.NONE),void 0===n&&(n=!1),void 0===i&&(i=null),void 0===r&&(r=null),this.prevAccesses=e,this.nextAccesses=t,this.discardContents=n,this.srcQueue=i,this.dstQueue=r}return e.prototype.copy=function(e){return this.prevAccesses=e.prevAccesses,this.nextAccesses=e.nextAccesses,this.discardContents=e.discardContents,this.srcQueue=e.srcQueue,this.dstQueue=e.dstQueue,this},e}(),Lr=function(){function e(e,t,n){void 0===e&&(e=null),void 0===t&&(t=[]),void 0===n&&(n=null),this.renderPass=e,this.colorTextures=t,this.depthStencilTexture=n}return e.prototype.copy=function(e){return this.renderPass=e.renderPass,this.colorTextures=e.colorTextures.slice(),this.depthStencilTexture=e.depthStencilTexture,this},e}(),Fr=function(){function e(e,t,n,i,r){void 0===e&&(e=-1),void 0===t&&(t=zi.UNKNOWN),void 0===n&&(n=0),void 0===i&&(i=Ai.NONE),void 0===r&&(r=[]),this.binding=e,this.descriptorType=t,this.count=n,this.stageFlags=i,this.immutableSamplers=r}return e.prototype.copy=function(e){return this.binding=e.binding,this.descriptorType=e.descriptorType,this.count=e.count,this.stageFlags=e.stageFlags,this.immutableSamplers=e.immutableSamplers.slice(),this},e}(),Br=function(){function e(e){void 0===e&&(e=[]),this.bindings=e}return e.prototype.copy=function(e){return ji(this.bindings,e.bindings,Fr),this},e}(),zr=function(){function e(e){void 0===e&&(e=null),this.layout=e}return e.prototype.copy=function(e){return this.layout=e.layout,this},e}(),Ur=function(){function e(e){void 0===e&&(e=[]),this.setLayouts=e}return e.prototype.copy=function(e){return this.setLayouts=e.setLayouts.slice(),this},e}(),kr=function(){function e(e){void 0===e&&(e=[]),this.attributes=e}return e.prototype.copy=function(e){return ji(this.attributes,e.attributes,br),this},e}(),Gr=function(){function e(e,t){void 0===e&&(e=null),void 0===t&&(t=Gi.PRIMARY),this.queue=e,this.type=t}return e.prototype.copy=function(e){return this.queue=e.queue,this.type=e.type,this},e}(),Hr=function(){function e(e){void 0===e&&(e=Ui.GRAPHICS),this.type=e}return e.prototype.copy=function(e){return this.type=e.type,this},e}(),Vr=function(){function e(e,t,n){void 0===e&&(e=ki.OCCLUSION),void 0===t&&(t=32767),void 0===n&&(n=!0),this.type=e,this.maxQueryObjects=t,this.forceWait=n}return e.prototype.copy=function(e){return this.type=e.type,this.maxQueryObjects=e.maxQueryObjects,this.forceWait=e.forceWait,this},e}(),Wr=function(e,t,n,i,r,o,a,s){void 0===e&&(e=""),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=si.NONE),void 0===r&&(r=!1),void 0===o&&(o=!1),void 0===a&&(a=!1),void 0===s&&(s=!1),this.name=e,this.size=t,this.count=n,this.type=i,this.hasAlpha=r,this.hasDepth=o,this.hasStencil=a,this.isCompressed=s},jr=function(){function e(e,t){void 0===e&&(e=0),void 0===t&&(t=0),this.bufferSize=e,this.textureSize=t}return e.prototype.copy=function(e){return this.bufferSize=e.bufferSize,this.textureSize=e.textureSize,this},e}(),qr=function(){function e(e,t,n){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),this.writeMask=e,this.compareMask=t,this.reference=n}return e.prototype.copy=function(e){return this.writeMask=e.writeMask,this.compareMask=e.compareMask,this.reference=e.reference,this},e}(),Xr=function(){function e(e,t,n,i,r,o,a,s,c,l,u){void 0===e&&(e=new ir),void 0===t&&(t=new Qi),void 0===n&&(n=new rr),void 0===i&&(i=1),void 0===r&&(r=0),void 0===o&&(o=0),void 0===a&&(a=0),void 0===s&&(s=0),void 0===c&&(c=0),void 0===l&&(l=new qr),void 0===u&&(u=new qr),this.viewport=e,this.scissor=t,this.blendConstant=n,this.lineWidth=i,this.depthBiasConstant=r,this.depthBiasClamp=o,this.depthBiasSlope=a,this.depthMinBounds=s,this.depthMaxBounds=c,this.stencilStatesFront=l,this.stencilStatesBack=u}return e.prototype.copy=function(e){return this.viewport.copy(e.viewport),this.scissor.copy(e.scissor),this.blendConstant.copy(e.blendConstant),this.lineWidth=e.lineWidth,this.depthBiasConstant=e.depthBiasConstant,this.depthBiasClamp=e.depthBiasClamp,this.depthBiasSlope=e.depthBiasSlope,this.depthMinBounds=e.depthMinBounds,this.depthMaxBounds=e.depthMaxBounds,this.stencilStatesFront.copy(e.stencilStatesFront),this.stencilStatesBack.copy(e.stencilStatesBack),this},e}(),Yr=function(e){function t(n){var i;return(i=e.call(this)||this)._objectType=ti.UNKNOWN,i._objectID=0,i._typedID=0,i._objectType=n,i._objectID=t._idTable[ti.UNKNOWN]++,i._typedID=t._idTable[n]++,i}return f(t,e),h(t,[{key:"objectType",get:function(){return this._objectType}},{key:"objectID",get:function(){return this._objectID}},{key:"typedID",get:function(){return this._typedID}}]),t}(Wi);Yr._idTable=Array(ti.COUNT).fill(65536),function(e){e.ATTR_POSITION="a_position",e.ATTR_NORMAL="a_normal",e.ATTR_TANGENT="a_tangent",e.ATTR_BITANGENT="a_bitangent",e.ATTR_WEIGHTS="a_weights",e.ATTR_JOINTS="a_joints",e.ATTR_COLOR="a_color",e.ATTR_COLOR1="a_color1",e.ATTR_COLOR2="a_color2",e.ATTR_TEX_COORD="a_texCoord",e.ATTR_TEX_COORD1="a_texCoord1",e.ATTR_TEX_COORD2="a_texCoord2",e.ATTR_TEX_COORD3="a_texCoord3",e.ATTR_TEX_COORD4="a_texCoord4",e.ATTR_TEX_COORD5="a_texCoord5",e.ATTR_TEX_COORD6="a_texCoord6",e.ATTR_TEX_COORD7="a_texCoord7",e.ATTR_TEX_COORD8="a_texCoord8",e.ATTR_BATCH_ID="a_batch_id",e.ATTR_BATCH_UV="a_batch_uv"}(qi||(qi={}));var Kr=Object.freeze([new Wr("UNKNOWN",0,0,si.NONE,!1,!1,!1,!1),new Wr("A8",1,1,si.UNORM,!0,!1,!1,!1),new Wr("L8",1,1,si.UNORM,!1,!1,!1,!1),new Wr("LA8",1,2,si.UNORM,!0,!1,!1,!1),new Wr("R8",1,1,si.UNORM,!1,!1,!1,!1),new Wr("R8SN",1,1,si.SNORM,!1,!1,!1,!1),new Wr("R8UI",1,1,si.UINT,!1,!1,!1,!1),new Wr("R8I",1,1,si.INT,!1,!1,!1,!1),new Wr("R16F",2,1,si.FLOAT,!1,!1,!1,!1),new Wr("R16UI",2,1,si.UINT,!1,!1,!1,!1),new Wr("R16I",2,1,si.INT,!1,!1,!1,!1),new Wr("R32F",4,1,si.FLOAT,!1,!1,!1,!1),new Wr("R32UI",4,1,si.UINT,!1,!1,!1,!1),new Wr("R32I",4,1,si.INT,!1,!1,!1,!1),new Wr("RG8",2,2,si.UNORM,!1,!1,!1,!1),new Wr("RG8SN",2,2,si.SNORM,!1,!1,!1,!1),new Wr("RG8UI",2,2,si.UINT,!1,!1,!1,!1),new Wr("RG8I",2,2,si.INT,!1,!1,!1,!1),new Wr("RG16F",4,2,si.FLOAT,!1,!1,!1,!1),new Wr("RG16UI",4,2,si.UINT,!1,!1,!1,!1),new Wr("RG16I",4,2,si.INT,!1,!1,!1,!1),new Wr("RG32F",8,2,si.FLOAT,!1,!1,!1,!1),new Wr("RG32UI",8,2,si.UINT,!1,!1,!1,!1),new Wr("RG32I",8,2,si.INT,!1,!1,!1,!1),new Wr("RGB8",3,3,si.UNORM,!1,!1,!1,!1),new Wr("SRGB8",3,3,si.UNORM,!1,!1,!1,!1),new Wr("RGB8SN",3,3,si.SNORM,!1,!1,!1,!1),new Wr("RGB8UI",3,3,si.UINT,!1,!1,!1,!1),new Wr("RGB8I",3,3,si.INT,!1,!1,!1,!1),new Wr("RGB16F",6,3,si.FLOAT,!1,!1,!1,!1),new Wr("RGB16UI",6,3,si.UINT,!1,!1,!1,!1),new Wr("RGB16I",6,3,si.INT,!1,!1,!1,!1),new Wr("RGB32F",12,3,si.FLOAT,!1,!1,!1,!1),new Wr("RGB32UI",12,3,si.UINT,!1,!1,!1,!1),new Wr("RGB32I",12,3,si.INT,!1,!1,!1,!1),new Wr("RGBA8",4,4,si.UNORM,!0,!1,!1,!1),new Wr("BGRA8",4,4,si.UNORM,!0,!1,!1,!1),new Wr("SRGB8_A8",4,4,si.UNORM,!0,!1,!1,!1),new Wr("RGBA8SN",4,4,si.SNORM,!0,!1,!1,!1),new Wr("RGBA8UI",4,4,si.UINT,!0,!1,!1,!1),new Wr("RGBA8I",4,4,si.INT,!0,!1,!1,!1),new Wr("RGBA16F",8,4,si.FLOAT,!0,!1,!1,!1),new Wr("RGBA16UI",8,4,si.UINT,!0,!1,!1,!1),new Wr("RGBA16I",8,4,si.INT,!0,!1,!1,!1),new Wr("RGBA32F",16,4,si.FLOAT,!0,!1,!1,!1),new Wr("RGBA32UI",16,4,si.UINT,!0,!1,!1,!1),new Wr("RGBA32I",16,4,si.INT,!0,!1,!1,!1),new Wr("R5G6B5",2,3,si.UNORM,!1,!1,!1,!1),new Wr("R11G11B10F",4,3,si.FLOAT,!1,!1,!1,!1),new Wr("RGB5A1",2,4,si.UNORM,!0,!1,!1,!1),new Wr("RGBA4",2,4,si.UNORM,!0,!1,!1,!1),new Wr("RGB10A2",2,4,si.UNORM,!0,!1,!1,!1),new Wr("RGB10A2UI",2,4,si.UINT,!0,!1,!1,!1),new Wr("RGB9E5",2,4,si.FLOAT,!0,!1,!1,!1),new Wr("DEPTH",4,1,si.FLOAT,!1,!0,!1,!1),new Wr("DEPTH_STENCIL",5,2,si.FLOAT,!1,!0,!0,!1),new Wr("BC1",1,3,si.UNORM,!1,!1,!1,!0),new Wr("BC1_ALPHA",1,4,si.UNORM,!0,!1,!1,!0),new Wr("BC1_SRGB",1,3,si.UNORM,!1,!1,!1,!0),new Wr("BC1_SRGB_ALPHA",1,4,si.UNORM,!0,!1,!1,!0),new Wr("BC2",1,4,si.UNORM,!0,!1,!1,!0),new Wr("BC2_SRGB",1,4,si.UNORM,!0,!1,!1,!0),new Wr("BC3",1,4,si.UNORM,!0,!1,!1,!0),new Wr("BC3_SRGB",1,4,si.UNORM,!0,!1,!1,!0),new Wr("BC4",1,1,si.UNORM,!1,!1,!1,!0),new Wr("BC4_SNORM",1,1,si.SNORM,!1,!1,!1,!0),new Wr("BC5",1,2,si.UNORM,!1,!1,!1,!0),new Wr("BC5_SNORM",1,2,si.SNORM,!1,!1,!1,!0),new Wr("BC6H_UF16",1,3,si.UFLOAT,!1,!1,!1,!0),new Wr("BC6H_SF16",1,3,si.FLOAT,!1,!1,!1,!0),new Wr("BC7",1,4,si.UNORM,!0,!1,!1,!0),new Wr("BC7_SRGB",1,4,si.UNORM,!0,!1,!1,!0),new Wr("ETC_RGB8",1,3,si.UNORM,!1,!1,!1,!0),new Wr("ETC2_RGB8",1,3,si.UNORM,!1,!1,!1,!0),new Wr("ETC2_SRGB8",1,3,si.UNORM,!1,!1,!1,!0),new Wr("ETC2_RGB8_A1",1,4,si.UNORM,!0,!1,!1,!0),new Wr("ETC2_SRGB8_A1",1,4,si.UNORM,!0,!1,!1,!0),new Wr("ETC2_RGBA8",2,4,si.UNORM,!0,!1,!1,!0),new Wr("ETC2_SRGB8_A8",2,4,si.UNORM,!0,!1,!1,!0),new Wr("EAC_R11",1,1,si.UNORM,!1,!1,!1,!0),new Wr("EAC_R11SN",1,1,si.SNORM,!1,!1,!1,!0),new Wr("EAC_RG11",2,2,si.UNORM,!1,!1,!1,!0),new Wr("EAC_RG11SN",2,2,si.SNORM,!1,!1,!1,!0),new Wr("PVRTC_RGB2",2,3,si.UNORM,!1,!1,!1,!0),new Wr("PVRTC_RGBA2",2,4,si.UNORM,!0,!1,!1,!0),new Wr("PVRTC_RGB4",2,3,si.UNORM,!1,!1,!1,!0),new Wr("PVRTC_RGBA4",2,4,si.UNORM,!0,!1,!1,!0),new Wr("PVRTC2_2BPP",2,4,si.UNORM,!0,!1,!1,!0),new Wr("PVRTC2_4BPP",2,4,si.UNORM,!0,!1,!1,!0),new Wr("ASTC_RGBA_4x4",1,4,si.UNORM,!0,!1,!1,!0),new Wr("ASTC_RGBA_5x4",1,4,si.UNORM,!0,!1,!1,!0),new Wr("ASTC_RGBA_5x5",1,4,si.UNORM,!0,!1,!1,!0),new Wr("ASTC_RGBA_6x5",1,4,si.UNORM,!0,!1,!1,!0),new Wr("ASTC_RGBA_6x6",1,4,si.UNORM,!0,!1,!1,!0),new Wr("ASTC_RGBA_8x5",1,4,si.UNORM,!0,!1,!1,!0),new Wr("ASTC_RGBA_8x6",1,4,si.UNORM,!0,!1,!1,!0),new Wr("ASTC_RGBA_8x8",1,4,si.UNORM,!0,!1,!1,!0),new Wr("ASTC_RGBA_10x5",1,4,si.UNORM,!0,!1,!1,!0),new Wr("ASTC_RGBA_10x6",1,4,si.UNORM,!0,!1,!1,!0),new Wr("ASTC_RGBA_10x8",1,4,si.UNORM,!0,!1,!1,!0),new Wr("ASTC_RGBA_10x10",1,4,si.UNORM,!0,!1,!1,!0),new Wr("ASTC_RGBA_12x10",1,4,si.UNORM,!0,!1,!1,!0),new Wr("ASTC_RGBA_12x12",1,4,si.UNORM,!0,!1,!1,!0),new Wr("ASTC_SRGBA_4x4",1,4,si.UNORM,!0,!1,!1,!0),new Wr("ASTC_SRGBA_5x4",1,4,si.UNORM,!0,!1,!1,!0),new Wr("ASTC_SRGBA_5x5",1,4,si.UNORM,!0,!1,!1,!0),new Wr("ASTC_SRGBA_6x5",1,4,si.UNORM,!0,!1,!1,!0),new Wr("ASTC_SRGBA_6x6",1,4,si.UNORM,!0,!1,!1,!0),new Wr("ASTC_SRGBA_8x5",1,4,si.UNORM,!0,!1,!1,!0),new Wr("ASTC_SRGBA_8x6",1,4,si.UNORM,!0,!1,!1,!0),new Wr("ASTC_SRGBA_8x8",1,4,si.UNORM,!0,!1,!1,!0),new Wr("ASTC_SRGBA_10x5",1,4,si.UNORM,!0,!1,!1,!0),new Wr("ASTC_SRGBA_10x6",1,4,si.UNORM,!0,!1,!1,!0),new Wr("ASTC_SRGBA_10x8",1,4,si.UNORM,!0,!1,!1,!0),new Wr("ASTC_SRGBA_10x10",1,4,si.UNORM,!0,!1,!1,!0),new Wr("ASTC_SRGBA_12x10",1,4,si.UNORM,!0,!1,!1,!0),new Wr("ASTC_SRGBA_12x12",1,4,si.UNORM,!0,!1,!1,!0)]),Qr=zi.UNIFORM_BUFFER|zi.DYNAMIC_UNIFORM_BUFFER|zi.STORAGE_BUFFER|zi.DYNAMIC_STORAGE_BUFFER,Jr=zi.SAMPLER_TEXTURE|zi.SAMPLER|zi.TEXTURE|zi.STORAGE_IMAGE|zi.INPUT_ATTACHMENT,Zr=zi.DYNAMIC_STORAGE_BUFFER|zi.DYNAMIC_UNIFORM_BUFFER,$r=28;function eo(e){return e>0&&0==(e&e-1)}function to(e,t,n,i){if(!Kr[e].isCompressed)return t*n*i*Kr[e].size;switch(e){case ai.BC1:case ai.BC1_ALPHA:case ai.BC1_SRGB:case ai.BC1_SRGB_ALPHA:return Math.ceil(t/4)*Math.ceil(n/4)*8*i;case ai.BC2:case ai.BC2_SRGB:case ai.BC3:case ai.BC3_SRGB:case ai.BC4:case ai.BC4_SNORM:case ai.BC6H_SF16:case ai.BC6H_UF16:case ai.BC7:case ai.BC7_SRGB:return Math.ceil(t/4)*Math.ceil(n/4)*16*i;case ai.BC5:case ai.BC5_SNORM:return Math.ceil(t/4)*Math.ceil(n/4)*32*i;case ai.ETC_RGB8:case ai.ETC2_RGB8:case ai.ETC2_SRGB8:case ai.ETC2_RGB8_A1:case ai.EAC_R11:case ai.EAC_R11SN:return Math.ceil(t/4)*Math.ceil(n/4)*8*i;case ai.ETC2_RGBA8:case ai.ETC2_SRGB8_A1:case ai.EAC_RG11:case ai.EAC_RG11SN:return Math.ceil(t/4)*Math.ceil(n/4)*16*i;case ai.PVRTC_RGB2:case ai.PVRTC_RGBA2:case ai.PVRTC2_2BPP:return Math.ceil(Math.max(t,16)*Math.max(n,8)/4)*i;case ai.PVRTC_RGB4:case ai.PVRTC_RGBA4:case ai.PVRTC2_4BPP:return Math.ceil(Math.max(t,8)*Math.max(n,8)/2)*i;case ai.ASTC_RGBA_4X4:case ai.ASTC_SRGBA_4X4:return Math.ceil(t/4)*Math.ceil(n/4)*16*i;case ai.ASTC_RGBA_5X4:case ai.ASTC_SRGBA_5X4:return Math.ceil(t/5)*Math.ceil(n/4)*16*i;case ai.ASTC_RGBA_5X5:case ai.ASTC_SRGBA_5X5:return Math.ceil(t/5)*Math.ceil(n/5)*16*i;case ai.ASTC_RGBA_6X5:case ai.ASTC_SRGBA_6X5:return Math.ceil(t/6)*Math.ceil(n/5)*16*i;case ai.ASTC_RGBA_6X6:case ai.ASTC_SRGBA_6X6:return Math.ceil(t/6)*Math.ceil(n/6)*16*i;case ai.ASTC_RGBA_8X5:case ai.ASTC_SRGBA_8X5:return Math.ceil(t/8)*Math.ceil(n/5)*16*i;case ai.ASTC_RGBA_8X6:case ai.ASTC_SRGBA_8X6:return Math.ceil(t/8)*Math.ceil(n/6)*16*i;case ai.ASTC_RGBA_8X8:case ai.ASTC_SRGBA_8X8:return Math.ceil(t/8)*Math.ceil(n/8)*16*i;case ai.ASTC_RGBA_10X5:case ai.ASTC_SRGBA_10X5:return Math.ceil(t/10)*Math.ceil(n/5)*16*i;case ai.ASTC_RGBA_10X6:case ai.ASTC_SRGBA_10X6:return Math.ceil(t/10)*Math.ceil(n/6)*16*i;case ai.ASTC_RGBA_10X8:case ai.ASTC_SRGBA_10X8:return Math.ceil(t/10)*Math.ceil(n/8)*16*i;case ai.ASTC_RGBA_10X10:case ai.ASTC_SRGBA_10X10:return Math.ceil(t/10)*Math.ceil(n/10)*16*i;case ai.ASTC_RGBA_12X10:case ai.ASTC_SRGBA_12X10:return Math.ceil(t/12)*Math.ceil(n/10)*16*i;case ai.ASTC_RGBA_12X12:case ai.ASTC_SRGBA_12X12:return Math.ceil(t/12)*Math.ceil(n/12)*16*i;default:return 0}}function no(e,t,n,i,r){for(var o=0,a=0;a<r;++a)o+=to(e,t,n,i),t=Math.max(t>>1,1),n=Math.max(n>>1,1);return o}var io=[0,4,8,12,16,4,8,12,16,4,8,12,16,4,8,12,16,16,24,32,24,36,48,32,48,64,4,4,4,4,4,4];function ro(e){return io[e]||0}function oo(e){var t=e.size/e.count;switch(e.type){case si.UNORM:case si.UINT:switch(t){case 1:return Uint8Array;case 2:return Uint16Array;case 4:return Uint32Array}break;case si.SNORM:case si.INT:switch(t){case 1:return Int8Array;case 2:return Int16Array;case 4:return Int32Array}break;case si.FLOAT:return Float32Array}return Float32Array}var ao=Object.freeze({__proto__:null,get ObjectType(){return ti},get Status(){return ni},get API(){return ii},get SurfaceTransform(){return ri},get Feature(){return oi},get Format(){return ai},get FormatType(){return si},get Type(){return ci},get BufferUsageBit(){return li},get BufferFlagBit(){return ui},get MemoryAccessBit(){return hi},get MemoryUsageBit(){return _i},get TextureType(){return fi},get TextureUsageBit(){return di},get TextureFlagBit(){return pi},get FormatFeatureBit(){return mi},get SampleCount(){return vi},get VsyncMode(){return gi},get Filter(){return yi},get Address(){return xi},get ComparisonFunc(){return Si},get StencilOp(){return Ei},get BlendFactor(){return Ti},get BlendOp(){return Ci},get ColorMask(){return bi},get ShaderStageFlagBit(){return Ai},get LoadOp(){return wi},get StoreOp(){return Ii},get AccessFlagBit(){return Pi},get ResolveMode(){return Ri},get PipelineBindPoint(){return Di},get PrimitiveMode(){return Oi},get PolygonMode(){return Ni},get ShadeModel(){return Mi},get CullMode(){return Li},get DynamicStateFlagBit(){return Fi},get StencilFace(){return Bi},get DescriptorType(){return zi},get QueueType(){return Ui},get QueryType(){return ki},get CommandBufferType(){return Gi},get ClearFlagBit(){return Hi},Size:Xi,DeviceCaps:Yi,Offset:Ki,Rect:Qi,Extent:Ji,TextureSubresLayers:Zi,TextureSubresRange:$i,TextureCopy:er,TextureBlit:tr,BufferTextureCopy:nr,Viewport:ir,Color:rr,BindingMappingInfo:or,SwapchainInfo:ar,DeviceInfo:sr,BufferInfo:cr,BufferViewInfo:lr,DrawInfo:ur,DispatchInfo:hr,IndirectBuffer:_r,TextureInfo:fr,TextureViewInfo:dr,SamplerInfo:pr,Uniform:mr,UniformBlock:vr,UniformSamplerTexture:gr,UniformSampler:yr,UniformTexture:xr,UniformStorageImage:Sr,UniformStorageBuffer:Er,UniformInputAttachment:Tr,ShaderStage:Cr,Attribute:br,ShaderInfo:Ar,InputAssemblerInfo:wr,ColorAttachment:Ir,DepthStencilAttachment:Pr,SubpassInfo:Rr,SubpassDependency:Dr,RenderPassInfo:Or,GeneralBarrierInfo:Nr,TextureBarrierInfo:Mr,FramebufferInfo:Lr,DescriptorSetLayoutBinding:Fr,DescriptorSetLayoutInfo:Br,DescriptorSetInfo:zr,PipelineLayoutInfo:Ur,InputState:kr,CommandBufferInfo:Gr,QueueInfo:Hr,QueryPoolInfo:Vr,FormatInfo:Wr,MemoryStatus:jr,DynamicStencilStates:qr,DynamicStates:Xr,GFXObject:Yr,get AttributeName(){return qi},FormatInfos:Kr,DESCRIPTOR_BUFFER_TYPE:Qr,DESCRIPTOR_SAMPLER_TYPE:Jr,DESCRIPTOR_DYNAMIC_TYPE:Zr,DRAW_INFO_SIZE:$r,IsPowerOf2:eo,FormatSize:to,FormatSurfaceSize:no,GetTypeSize:ro,getTypedArrayConstructor:oo}),so=function(e){function t(){var t;return(t=e.call(this,ti.BUFFER)||this)._usage=li.NONE,t._memUsage=_i.NONE,t._size=0,t._stride=1,t._count=0,t._flags=ui.NONE,t._isBufferView=!1,t}return f(t,e),h(t,[{key:"usage",get:function(){return this._usage}},{key:"memUsage",get:function(){return this._memUsage}},{key:"size",get:function(){return this._size}},{key:"stride",get:function(){return this._stride}},{key:"count",get:function(){return this._count}},{key:"flags",get:function(){return this._flags}}]),t}(Yr),co=function(e){function t(){var t;return(t=e.call(this,ti.COMMAND_BUFFER)||this)._queue=null,t._type=Gi.PRIMARY,t._numDrawCalls=0,t._numInstances=0,t._numTris=0,t}return f(t,e),h(t,[{key:"type",get:function(){return this._type}},{key:"queue",get:function(){return this._queue}},{key:"numDrawCalls",get:function(){return this._numDrawCalls}},{key:"numInstances",get:function(){return this._numInstances}},{key:"numTris",get:function(){return this._numTris}}]),t}(Yr),lo=function(){function e(){this._gfxAPI=ii.UNKNOWN,this._renderer="",this._vendor="",this._features=new Array(oi.COUNT),this._formatFeatures=new Array(ai.COUNT),this._queue=null,this._cmdBuff=null,this._numDrawCalls=0,this._numInstances=0,this._numTris=0,this._memoryStatus=new jr,this._caps=new Yi,this._bindingMappingInfo=new or,this._samplers=new Map,this._generalBarrierss=new Map,this._textureBarriers=new Map}var t=e.prototype;return t.hasFeature=function(e){return this._features[e]},t.getFormatFeatures=function(e){return this._formatFeatures[e]},h(e,[{key:"gfxAPI",get:function(){return this._gfxAPI}},{key:"queue",get:function(){return this._queue}},{key:"commandBuffer",get:function(){return this._cmdBuff}},{key:"renderer",get:function(){return this._renderer}},{key:"vendor",get:function(){return this._vendor}},{key:"numDrawCalls",get:function(){return this._numDrawCalls}},{key:"numInstances",get:function(){return this._numInstances}},{key:"numTris",get:function(){return this._numTris}},{key:"memoryStatus",get:function(){return this._memoryStatus}},{key:"capabilities",get:function(){return this._caps}},{key:"bindingMappingInfo",get:function(){return this._bindingMappingInfo}}]),e}();lo.canvas=void 0;var uo=function(e){function t(){var t;return(t=e.call(this,ti.SWAPCHAIN)||this)._transform=ri.IDENTITY,t._colorTexture=null,t._depthStencilTexture=null,t}return f(t,e),h(t,[{key:"colorTexture",get:function(){return this._colorTexture}},{key:"depthStencilTexture",get:function(){return this._depthStencilTexture}},{key:"surfaceTransform",get:function(){return this._transform}},{key:"width",get:function(){return this._colorTexture.width}},{key:"height",get:function(){return this._colorTexture.height}}]),t}(Yr),ho=function(e){function t(){var t;return(t=e.call(this,ti.FRAMEBUFFER)||this)._renderPass=null,t._colorTextures=[],t._depthStencilTexture=null,t}return f(t,e),h(t,[{key:"renderPass",get:function(){return this._renderPass}},{key:"colorTextures",get:function(){return this._colorTextures}},{key:"depthStencilTexture",get:function(){return this._depthStencilTexture}}]),t}(Yr),_o=String.prototype.charCodeAt;function fo(e){return this[e]}function po(e,t){for(var n=e.length,i=t^n,r=0,o="string"==typeof e?_o:fo;n>=4;){var a=255&o.call(e,r)|(255&o.call(e,++r))<<8|(255&o.call(e,++r))<<16|(255&o.call(e,++r))<<24;a=1540483477*(65535&a)+((1540483477*(a>>>16)&65535)<<16),i=1540483477*(65535&i)+((1540483477*(i>>>16)&65535)<<16)^(a=1540483477*(65535&(a^=a>>>24))+((1540483477*(a>>>16)&65535)<<16)),n-=4,++r}switch(n){case 3:i^=(255&o.call(e,r+2))<<16;case 2:i^=(255&o.call(e,r+1))<<8;case 1:i=1540483477*(65535&(i^=255&o.call(e,r)))+((1540483477*(i>>>16)&65535)<<16)}return i=1540483477*(65535&(i^=i>>>13))+((1540483477*(i>>>16)&65535)<<16),(i^=i>>>15)>>>0}var mo=function(e){function t(){var t;return(t=e.call(this,ti.INPUT_ASSEMBLER)||this)._attributes=[],t._attributesHash=0,t._vertexBuffers=[],t._indexBuffer=null,t._indirectBuffer=null,t._drawInfo=new ur,t}f(t,e);var n=t.prototype;return n.getVertexBuffer=function(e){return void 0===e&&(e=0),e<this._vertexBuffers.length?this._vertexBuffers[e]:null},n.computeAttributesHash=function(){for(var e="attrs",t=0;t<this.attributes.length;++t){var n=this.attributes[t];e+=","+n.name+","+n.format+","+n.isNormalized+","+n.stream+","+n.isInstanced}return po(e,666)},h(t,[{key:"attributes",get:function(){return this._attributes}},{key:"vertexBuffers",get:function(){return this._vertexBuffers}},{key:"indexBuffer",get:function(){return this._indexBuffer}},{key:"indirectBuffer",get:function(){return this._indirectBuffer}},{key:"attributesHash",get:function(){return this._attributesHash}},{key:"vertexCount",get:function(){return this._drawInfo.vertexCount},set:function(e){this._drawInfo.vertexCount=e}},{key:"firstVertex",get:function(){return this._drawInfo.firstVertex},set:function(e){this._drawInfo.firstVertex=e}},{key:"indexCount",get:function(){return this._drawInfo.indexCount},set:function(e){this._drawInfo.indexCount=e}},{key:"firstIndex",get:function(){return this._drawInfo.firstIndex},set:function(e){this._drawInfo.firstIndex=e}},{key:"vertexOffset",get:function(){return this._drawInfo.vertexOffset},set:function(e){this._drawInfo.vertexOffset=e}},{key:"instanceCount",get:function(){return this._drawInfo.instanceCount},set:function(e){this._drawInfo.instanceCount=e}},{key:"firstInstance",get:function(){return this._drawInfo.firstInstance},set:function(e){this._drawInfo.firstInstance=e}},{key:"drawInfo",get:function(){return this._drawInfo}}]),t}(Yr),vo=function(e){function t(){var t;return(t=e.call(this,ti.DESCRIPTOR_SET)||this)._layout=null,t._buffers=[],t._textures=[],t._samplers=[],t._isDirty=!1,t}f(t,e);var n=t.prototype;return n.bindBuffer=function(e,t,n){void 0===n&&(n=0);var i=this._layout.bindingIndices[e],r=this._layout.bindings[i];if(r&&r.descriptorType&Qr){var o=this._layout.descriptorIndices[e];this._buffers[o+n]!==t&&(this._buffers[o+n]=t,this._isDirty=!0)}},n.bindSampler=function(e,t,n){void 0===n&&(n=0);var i=this._layout.bindingIndices[e],r=this._layout.bindings[i];if(r&&r.descriptorType&Jr){var o=this._layout.descriptorIndices[e];this._samplers[o+n]!==t&&(this._samplers[o+n]=t,this._isDirty=!0)}},n.bindTexture=function(e,t,n){void 0===n&&(n=0);var i=this._layout.bindingIndices[e],r=this._layout.bindings[i];if(r&&r.descriptorType&Jr){var o=this._layout.descriptorIndices[e];this._textures[o+n]!==t&&(this._textures[o+n]=t,this._isDirty=!0)}},n.getBuffer=function(e,t){void 0===t&&(t=0);var n=this._layout.descriptorIndices[e];return this._buffers[n+t]},n.getSampler=function(e,t){void 0===t&&(t=0);var n=this._layout.descriptorIndices[e];return this._samplers[n+t]},n.getTexture=function(e,t){void 0===t&&(t=0);var n=this._layout.descriptorIndices[e];return this._textures[n+t]},h(t,[{key:"layout",get:function(){return this._layout}}]),t}(Yr),go=function(e){function t(){var t;return(t=e.call(this,ti.DESCRIPTOR_SET_LAYOUT)||this)._bindings=[],t._bindingIndices=[],t._descriptorIndices=[],t}return f(t,e),h(t,[{key:"bindings",get:function(){return this._bindings}},{key:"bindingIndices",get:function(){return this._bindingIndices}},{key:"descriptorIndices",get:function(){return this._descriptorIndices}}]),t}(Yr),yo=function(e){function t(){var t;return(t=e.call(this,ti.PIPELINE_LAYOUT)||this)._setLayouts=[],t}return f(t,e),h(t,[{key:"setLayouts",get:function(){return this._setLayouts}}]),t}(Yr),xo=function(){function e(e,t,n,i,r,o,a,s,c,l,u,h){void 0===e&&(e=!1),void 0===t&&(t=Ni.FILL),void 0===n&&(n=Mi.GOURAND),void 0===i&&(i=Li.BACK),void 0===r&&(r=!0),void 0===o&&(o=!1),void 0===a&&(a=0),void 0===s&&(s=0),void 0===c&&(c=0),void 0===l&&(l=!0),void 0===u&&(u=!1),void 0===h&&(h=1),this.isDiscard=e,this.polygonMode=t,this.shadeModel=n,this.cullMode=i,this.isFrontFaceCCW=r,this.depthBiasEnabled=o,this.depthBias=a,this.depthBiasClamp=s,this.depthBiasSlop=c,this.isDepthClip=l,this.isMultisample=u,this.lineWidth=h}var t=e.prototype;return t.reset=function(){this.isDiscard=!1,this.polygonMode=Ni.FILL,this.shadeModel=Mi.GOURAND,this.cullMode=Li.BACK,this.isFrontFaceCCW=!0,this.depthBiasEnabled=!1,this.depthBias=0,this.depthBiasClamp=0,this.depthBiasSlop=0,this.isDepthClip=!0,this.isMultisample=!1,this.lineWidth=1},t.assign=function(e){Object.assign(this,e)},t.destroy=function(){},h(e,[{key:"native",get:function(){return this}}]),e}(),So=function(){function e(e,t,n,i,r,o,a,s,c,l,u,h,_,f,d,p,m,v,g){void 0===e&&(e=!0),void 0===t&&(t=!0),void 0===n&&(n=Si.LESS),void 0===i&&(i=!1),void 0===r&&(r=Si.ALWAYS),void 0===o&&(o=65535),void 0===a&&(a=65535),void 0===s&&(s=Ei.KEEP),void 0===c&&(c=Ei.KEEP),void 0===l&&(l=Ei.KEEP),void 0===u&&(u=1),void 0===h&&(h=!1),void 0===_&&(_=Si.ALWAYS),void 0===f&&(f=65535),void 0===d&&(d=65535),void 0===p&&(p=Ei.KEEP),void 0===m&&(m=Ei.KEEP),void 0===v&&(v=Ei.KEEP),void 0===g&&(g=1),this.depthTest=e,this.depthWrite=t,this.depthFunc=n,this.stencilTestFront=i,this.stencilFuncFront=r,this.stencilReadMaskFront=o,this.stencilWriteMaskFront=a,this.stencilFailOpFront=s,this.stencilZFailOpFront=c,this.stencilPassOpFront=l,this.stencilRefFront=u,this.stencilTestBack=h,this.stencilFuncBack=_,this.stencilReadMaskBack=f,this.stencilWriteMaskBack=d,this.stencilFailOpBack=p,this.stencilZFailOpBack=m,this.stencilPassOpBack=v,this.stencilRefBack=g}var t=e.prototype;return t.reset=function(){this.depthTest=!0,this.depthWrite=!0,this.depthFunc=Si.LESS,this.stencilTestFront=!1,this.stencilFuncFront=Si.ALWAYS,this.stencilReadMaskFront=65535,this.stencilWriteMaskFront=65535,this.stencilFailOpFront=Ei.KEEP,this.stencilZFailOpFront=Ei.KEEP,this.stencilPassOpFront=Ei.KEEP,this.stencilRefFront=1,this.stencilTestBack=!1,this.stencilFuncBack=Si.ALWAYS,this.stencilReadMaskBack=65535,this.stencilWriteMaskBack=65535,this.stencilFailOpBack=Ei.KEEP,this.stencilZFailOpBack=Ei.KEEP,this.stencilPassOpBack=Ei.KEEP,this.stencilRefBack=1},t.assign=function(e){Object.assign(this,e)},t.destroy=function(){},h(e,[{key:"native",get:function(){return this}}]),e}(),Eo=function(){function e(e,t,n,i,r,o,a,s){void 0===e&&(e=!1),void 0===t&&(t=Ti.ONE),void 0===n&&(n=Ti.ZERO),void 0===i&&(i=Ci.ADD),void 0===r&&(r=Ti.ONE),void 0===o&&(o=Ti.ZERO),void 0===a&&(a=Ci.ADD),void 0===s&&(s=bi.ALL),this.blend=e,this.blendSrc=t,this.blendDst=n,this.blendEq=i,this.blendSrcAlpha=r,this.blendDstAlpha=o,this.blendAlphaEq=a,this.blendColorMask=s}var t=e.prototype;return t.reset=function(){this.blend=!1,this.blendSrc=Ti.ONE,this.blendDst=Ti.ZERO,this.blendEq=Ci.ADD,this.blendSrcAlpha=Ti.ONE,this.blendDstAlpha=Ti.ZERO,this.blendAlphaEq=Ci.ADD,this.blendColorMask=bi.ALL},t.assign=function(e){Object.assign(this,e)},t.destroy=function(){},e}(),To=function(){function e(e,t,n,i){void 0===e&&(e=!1),void 0===t&&(t=!1),void 0===n&&(n=new rr),void 0===i&&(i=[new Eo]),this.isA2C=e,this.isIndepend=t,this.blendColor=n,this.targets=i}var t=e.prototype;return t.setTarget=function(e,t){var n=this.targets[e];n||(n=this.targets[e]=new Eo),Object.assign(n,t)},t.reset=function(){this.isA2C=!1,this.isIndepend=!1,this.blendColor.x=0,this.blendColor.y=0,this.blendColor.z=0,this.blendColor.w=0,this.targets.length=1,this.targets[0].reset()},t.destroy=function(){},h(e,[{key:"native",get:function(){return this}}]),e}(),Co=function(e,t,n,i,r,o,a,s,c,l){void 0===e&&(e=null),void 0===t&&(t=null),void 0===n&&(n=null),void 0===i&&(i=new kr),void 0===r&&(r=new xo),void 0===o&&(o=new So),void 0===a&&(a=new To),void 0===s&&(s=Oi.TRIANGLE_LIST),void 0===c&&(c=Fi.NONE),void 0===l&&(l=Di.GRAPHICS),this.shader=e,this.pipelineLayout=t,this.renderPass=n,this.inputState=i,this.rasterizerState=r,this.depthStencilState=o,this.blendState=a,this.primitive=s,this.dynamicStates=c,this.bindPoint=l},bo=function(e){function t(){var t;return(t=e.call(this,ti.PIPELINE_STATE)||this)._shader=null,t._pipelineLayout=null,t._primitive=Oi.TRIANGLE_LIST,t._is=null,t._rs=new xo,t._dss=new So,t._bs=new To,t._dynamicStates=Fi.NONE,t._renderPass=null,t}return f(t,e),h(t,[{key:"shader",get:function(){return this._shader}},{key:"pipelineLayout",get:function(){return this._pipelineLayout}},{key:"primitive",get:function(){return this._primitive}},{key:"rasterizerState",get:function(){return this._rs}},{key:"depthStencilState",get:function(){return this._dss}},{key:"blendState",get:function(){return this._bs}},{key:"inputState",get:function(){return this._is}},{key:"dynamicStates",get:function(){return this._dynamicStates}},{key:"renderPass",get:function(){return this._renderPass}}]),t}(Yr),Ao=function(e){function t(){var t;return(t=e.call(this,ti.QUEUE)||this)._type=Ui.GRAPHICS,t}return f(t,e),h(t,[{key:"type",get:function(){return this._type}}]),t}(Yr),wo=function(e){function t(){var t;return(t=e.call(this,ti.RENDER_PASS)||this)._colorInfos=[],t._depthStencilInfo=null,t._subpasses=[],t._hash=0,t}return f(t,e),t.prototype.computeHash=function(){var e="";if(this._subpasses.length)for(var t=0;t<this._subpasses.length;++t){var n=this._subpasses[t];if(n.inputs.length){e+="ia";for(var i=0;i<n.inputs.length;++i){var r=this._colorInfos[n.inputs[i]];e+=","+r.format+","+r.sampleCount}}if(n.colors.length){e+="ca";for(var o=0;o<n.inputs.length;++o){var a=this._colorInfos[n.inputs[o]];e+=","+a.format+","+a.sampleCount}}if(n.depthStencil>=0){var s=this._colorInfos[n.depthStencil];e+="ds,"+s.format+","+s.sampleCount}}else{e+="ca";for(var c=0;c<this._colorInfos.length;++c){var l=this._colorInfos[c];e+=","+l.format+","+l.sampleCount}var u=this._depthStencilInfo;u&&(e+="ds,"+u.format+","+u.sampleCount)}return po(e,666)},h(t,[{key:"colorAttachments",get:function(){return this._colorInfos}},{key:"depthStencilAttachment",get:function(){return this._depthStencilInfo}},{key:"subPasses",get:function(){return this._subpasses}},{key:"hash",get:function(){return this._hash}}]),t}(Yr),Io=function(e){function t(t,n){var i;return(i=e.call(this,ti.SAMPLER)||this)._info=new pr,i._hash=0,i._info.copy(t),i._hash=n,i}return f(t,e),t.computeHash=function(e){var t=e.minFilter;return t|=e.magFilter<<2,t|=e.mipFilter<<4,t|=e.addressU<<6,t|=e.addressV<<8,t|=e.addressW<<10,(t|=e.maxAnisotropy<<12)|e.cmpFunc<<16},t.unpackFromHash=function(e){var t=new pr;return t.minFilter=(3&e)>>0,t.magFilter=(3&e)>>2,t.mipFilter=(3&e)>>4,t.addressU=(3&e)>>6,t.addressV=(3&e)>>8,t.addressW=(3&e)>>10,t.maxAnisotropy=(15&e)>>12,t.cmpFunc=(7&e)>>16,t},h(t,[{key:"info",get:function(){return this._info}},{key:"hash",get:function(){return this._hash}}]),t}(Yr),Po=function(e){function t(){var t;return(t=e.call(this,ti.SHADER)||this)._name="",t._stages=[],t._attributes=[],t._blocks=[],t._samplers=[],t}return f(t,e),h(t,[{key:"name",get:function(){return this._name}},{key:"attributes",get:function(){return this._attributes}},{key:"blocks",get:function(){return this._blocks}},{key:"samplers",get:function(){return this._samplers}}]),t}(Yr),Ro=function(e){function t(){var t;return(t=e.call(this,ti.TEXTURE)||this)._info=new fr,t._viewInfo=new dr,t._isPowerOf2=!1,t._isTextureView=!1,t._size=0,t}return f(t,e),t.getLevelCount=function(e,t){return Math.floor(Math.log2(Math.max(e,t)))},h(t,[{key:"type",get:function(){return this._info.type}},{key:"usage",get:function(){return this._info.usage}},{key:"format",get:function(){return this._info.format}},{key:"width",get:function(){return this._info.width}},{key:"height",get:function(){return this._info.height}},{key:"depth",get:function(){return this._info.depth}},{key:"layerCount",get:function(){return this._info.layerCount}},{key:"levelCount",get:function(){return this._info.levelCount}},{key:"samples",get:function(){return this._info.samples}},{key:"flags",get:function(){return this._info.flags}},{key:"size",get:function(){return this._size}},{key:"info",get:function(){return this._info}},{key:"viewInfo",get:function(){return this._viewInfo}},{key:"isTextureView",get:function(){return this._isTextureView}}]),t}(Yr),Do=function(e){function t(t,n){var i;return(i=e.call(this,ti.GLOBAL_BARRIER)||this)._info=new Nr,i._hash=0,i._info.copy(t),i._hash=n,i}return f(t,e),t.computeHash=function(e){return po(e.prevAccesses+" "+e.nextAccesses,666)},h(t,[{key:"info",get:function(){return this._info}},{key:"hash",get:function(){return this._hash}}]),t}(Yr),Oo=function(e){function t(t,n){var i;return(i=e.call(this,ti.TEXTURE_BARRIER)||this)._info=new Mr,i._hash=0,i._info.copy(t),i._hash=n,i}return f(t,e),t.computeHash=function(e){var t=e.prevAccesses+" "+e.nextAccesses;return t+=e.discardContents,t+=e.srcQueue?e.srcQueue.type:0,po(t+=e.dstQueue?e.dstQueue.type:0,666)},h(t,[{key:"info",get:function(){return this._info}},{key:"hash",get:function(){return this._hash}}]),t}(Yr),No={Device:lo,Swapchain:uo,Buffer:so,Texture:Ro,Sampler:Io,Shader:Po,InputAssembler:mo,RenderPass:wo,Framebuffer:ho,DescriptorSet:vo,DescriptorSetLayout:go,PipelineLayout:yo,PipelineState:bo,CommandBuffer:co,Queue:Ao,GeneralBarrier:Do,TextureBarrier:Oo,RasterizerState:xo,BlendState:To,BlendTarget:Eo,DepthStencilState:So,PipelineStateInfo:Co};Object.assign(No,ao),b.gfx=No,e("gfx",Object.freeze({__proto__:null,DescriptorSet:vo,Buffer:so,CommandBuffer:co,get ObjectType(){return ti},get Status(){return ni},get API(){return ii},get SurfaceTransform(){return ri},get Feature(){return oi},get Format(){return ai},get FormatType(){return si},get Type(){return ci},get BufferUsageBit(){return li},get BufferFlagBit(){return ui},get MemoryAccessBit(){return hi},get MemoryUsageBit(){return _i},get TextureType(){return fi},get TextureUsageBit(){return di},get TextureFlagBit(){return pi},get FormatFeatureBit(){return mi},get SampleCount(){return vi},get VsyncMode(){return gi},get Filter(){return yi},get Address(){return xi},get ComparisonFunc(){return Si},get StencilOp(){return Ei},get BlendFactor(){return Ti},get BlendOp(){return Ci},get ColorMask(){return bi},get ShaderStageFlagBit(){return Ai},get LoadOp(){return wi},get StoreOp(){return Ii},get AccessFlagBit(){return Pi},get ResolveMode(){return Ri},get PipelineBindPoint(){return Di},get PrimitiveMode(){return Oi},get PolygonMode(){return Ni},get ShadeModel(){return Mi},get CullMode(){return Li},get DynamicStateFlagBit(){return Fi},get StencilFace(){return Bi},get DescriptorType(){return zi},get QueueType(){return Ui},get QueryType(){return ki},get CommandBufferType(){return Gi},get ClearFlagBit(){return Hi},Size:Xi,DeviceCaps:Yi,Offset:Ki,Rect:Qi,Extent:Ji,TextureSubresLayers:Zi,TextureSubresRange:$i,TextureCopy:er,TextureBlit:tr,BufferTextureCopy:nr,Viewport:ir,Color:rr,BindingMappingInfo:or,SwapchainInfo:ar,DeviceInfo:sr,BufferInfo:cr,BufferViewInfo:lr,DrawInfo:ur,DispatchInfo:hr,IndirectBuffer:_r,TextureInfo:fr,TextureViewInfo:dr,SamplerInfo:pr,Uniform:mr,UniformBlock:vr,UniformSamplerTexture:gr,UniformSampler:yr,UniformTexture:xr,UniformStorageImage:Sr,UniformStorageBuffer:Er,UniformInputAttachment:Tr,ShaderStage:Cr,Attribute:br,ShaderInfo:Ar,InputAssemblerInfo:wr,ColorAttachment:Ir,DepthStencilAttachment:Pr,SubpassInfo:Rr,SubpassDependency:Dr,RenderPassInfo:Or,GeneralBarrierInfo:Nr,TextureBarrierInfo:Mr,FramebufferInfo:Lr,DescriptorSetLayoutBinding:Fr,DescriptorSetLayoutInfo:Br,DescriptorSetInfo:zr,PipelineLayoutInfo:Ur,InputState:kr,CommandBufferInfo:Gr,QueueInfo:Hr,QueryPoolInfo:Vr,FormatInfo:Wr,MemoryStatus:jr,DynamicStencilStates:qr,DynamicStates:Xr,GFXObject:Yr,get AttributeName(){return qi},FormatInfos:Kr,DESCRIPTOR_BUFFER_TYPE:Qr,DESCRIPTOR_SAMPLER_TYPE:Jr,DESCRIPTOR_DYNAMIC_TYPE:Zr,DRAW_INFO_SIZE:$r,IsPowerOf2:eo,FormatSize:to,FormatSurfaceSize:no,GetTypeSize:ro,getTypedArrayConstructor:oo,Device:lo,Swapchain:uo,Framebuffer:ho,InputAssembler:mo,DescriptorSetLayout:go,PipelineLayout:yo,RasterizerState:xo,DepthStencilState:So,BlendTarget:Eo,BlendState:To,PipelineStateInfo:Co,PipelineState:bo,Queue:Ao,RenderPass:wo,Sampler:Io,Shader:Po,Texture:Ro,GeneralBarrier:Do,TextureBarrier:Oo}));var Mo=new yn,Lo=new yn,Fo=new yn,Bo=new yn,zo=new yn,Uo=new yn,ko=new Array(3),Go=new Array(3);function Ho(e,t){return yn.dot(t.n,e)-t.d}function Vo(e,t,n){return yn.copy(e,t),yn.subtract(zo,n.center,n.halfExtents),yn.add(Uo,n.center,n.halfExtents),e.x=e.x<zo.x?zo.x:e.x,e.y=e.y<zo.y?zo.y:e.y,e.z=e.z<zo.z?zo.z:e.z,e.x=e.x>Uo.x?Uo.x:e.x,e.y=e.y>Uo.y?Uo.y:e.y,e.z=e.z>Uo.z?Uo.z:e.z,e}function Wo(e,t,n){yn.set(Mo,n.orientation.m00,n.orientation.m01,n.orientation.m02),yn.set(Lo,n.orientation.m03,n.orientation.m04,n.orientation.m05),yn.set(Fo,n.orientation.m06,n.orientation.m07,n.orientation.m08),ko[0]=Mo,ko[1]=Lo,ko[2]=Fo,Go[0]=n.halfExtents.x,Go[1]=n.halfExtents.y,Go[2]=n.halfExtents.z,yn.subtract(Bo,t,n.center),yn.set(e,n.center.x,n.center.y,n.center.z);for(var i=0;i<3;i++){var r=yn.dot(Bo,ko[i]);r>Go[i]&&(r=Go[i]),r<-Go[i]&&(r=-Go[i]),e.x+=r*ko[i].x,e.y+=r*ko[i].y,e.z+=r*ko[i].z}return e}var jo=Object.freeze({__proto__:null,point_plane:Ho,pt_point_plane:function(e,t,n){var i=Ho(t,n);return yn.subtract(e,t,yn.multiplyScalar(e,n.n,i))},pt_point_aabb:Vo,pt_point_obb:Wo,pt_point_line:function(e,t,n,i){yn.subtract(Mo,n,i);var r=Mo,o=yn.lengthSqr(r);if(0==o)yn.copy(e,n);else{yn.subtract(Mo,t,n);var a=yn.dot(Mo,r)/o;a<0?yn.copy(e,n):a>1?yn.copy(e,i):yn.scaleAndAdd(e,n,r,a)}}}),qo={SHAPE_RAY:1,SHAPE_LINE:2,SHAPE_SPHERE:4,SHAPE_AABB:8,SHAPE_OBB:16,SHAPE_PLANE:32,SHAPE_TRIANGLE:64,SHAPE_FRUSTUM:128,SHAPE_FRUSTUM_ACCURATE:256,SHAPE_CAPSULE:512},Xo=function(){function e(e,t,n,i,r,o){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===o&&(o=-1),this.o=void 0,this.d=void 0,this._type=void 0,this._type=qo.SHAPE_RAY,this.o=new yn(e,t,n),this.d=new yn(i,r,o)}return e.create=function(t,n,i,r,o,a){return void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===o&&(o=0),void 0===a&&(a=1),new e(t,n,i,r,o,a)},e.clone=function(t){return new e(t.o.x,t.o.y,t.o.z,t.d.x,t.d.y,t.d.z)},e.copy=function(e,t){return yn.copy(e.o,t.o),yn.copy(e.d,t.d),e},e.fromPoints=function(e,t,n){return yn.copy(e.o,t),yn.normalize(e.d,yn.subtract(e.d,n,t)),e},e.set=function(e,t,n,i,r,o,a){return e.o.x=t,e.o.y=n,e.o.z=i,e.d.x=r,e.d.y=o,e.d.z=a,e},e.prototype.computeHit=function(e,t){yn.normalize(e,this.d),yn.scaleAndAdd(e,this.o,e,t)},h(e,[{key:"type",get:function(){return this._type}}]),e}(),Yo=new yn,Ko=new yn,Qo=new yn,Jo=new yn;function Zo(e){return Math.max(Math.max(e.x,e.y),e.z)}var $o,ea=function(){function e(e,t,n,i){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=1),this._center=new yn(0,0,0),this._radius=0,this._type=void 0,this._type=qo.SHAPE_SPHERE,this._center=new yn(e,t,n),this._radius=i}e.create=function(t,n,i,r){return new e(t,n,i,r)},e.clone=function(t){return new e(t.center.x,t.center.y,t.center.z,t.radius)},e.copy=function(e,t){return yn.copy(e.center,t.center),e.radius=t.radius,e},e.fromPoints=function(e,t,n){return yn.multiplyScalar(e.center,yn.add(Yo,t,n),.5),e.radius=.5*yn.subtract(Yo,n,t).length(),e},e.set=function(e,t,n,i,r){return e.center.x=t,e.center.y=n,e.center.z=i,e.radius=r,e};var t=e.prototype;return t.destroy=function(){},t.clone=function(){return e.clone(this)},t.copy=function(t){return e.copy(this,t)},t.getBoundary=function(e,t){yn.set(e,this.center.x-this.radius,this.center.y-this.radius,this.center.z-this.radius),yn.set(t,this.center.x+this.radius,this.center.y+this.radius,this.center.z+this.radius)},t.transform=function(e,t,n,i,r){yn.transformMat4(r.center,this.center,e),r.radius=this.radius*Zo(i)},t.translateAndRotate=function(e,t,n){yn.transformMat4(n.center,this.center,e)},t.setScale=function(e,t){t.radius=this.radius*Zo(e)},t.mergePoint=function(e){this.radius<0&&(this.center.set(e),this.radius=0),yn.subtract(Ko,e,this.center);var t=Ko.length();if(t>this.radius){var n=.5*(t-this.radius);this.radius+=n,yn.multiplyScalar(Ko,Ko,n/t),yn.add(this.center,this.center,Ko)}},t.mergePoints=function(e){var t=e.length;if(!(t<1)){this.radius=-1;for(var n=0;n<t;n++)this.mergePoint(e[n])}},t.mergeAABB=function(e){e.getBoundary(Qo,Jo),this.mergePoint(Qo),this.mergePoint(Jo)},h(e,[{key:"center",get:function(){return this._center},set:function(e){this._center=e}},{key:"radius",get:function(){return this._radius},set:function(e){this._radius=e}},{key:"type",get:function(){return this._type}}]),e}(),ta=function(){function e(e,t,n,i,r,o,a,s,c){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=1),void 0===r&&(r=0),void 0===o&&(o=0),void 0===a&&(a=0),void 0===s&&(s=1),void 0===c&&(c=0),this.a=void 0,this.b=void 0,this.c=void 0,this._type=void 0,this._type=qo.SHAPE_TRIANGLE,this.a=new yn(e,t,n),this.b=new yn(i,r,o),this.c=new yn(a,s,c)}return e.create=function(t,n,i,r,o,a,s,c,l){return void 0===t&&(t=1),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===o&&(o=0),void 0===a&&(a=0),void 0===s&&(s=0),void 0===c&&(c=0),void 0===l&&(l=1),new e(t,n,i,r,o,a,s,c,l)},e.clone=function(t){return new e(t.a.x,t.a.y,t.a.z,t.b.x,t.b.y,t.b.z,t.c.x,t.c.y,t.c.z)},e.copy=function(e,t){return yn.copy(e.a,t.a),yn.copy(e.b,t.b),yn.copy(e.c,t.c),e},e.fromPoints=function(e,t,n,i){return yn.copy(e.a,t),yn.copy(e.b,n),yn.copy(e.c,i),e},e.set=function(e,t,n,i,r,o,a,s,c,l){return e.a.x=t,e.a.y=n,e.a.z=i,e.b.x=r,e.b.y=o,e.b.z=a,e.c.x=s,e.c.y=c,e.c.z=l,e},h(e,[{key:"type",get:function(){return this._type}}]),e}();!function(e){e[e.ALL=0]="ALL",e[e.CLOSEST=1]="CLOSEST",e[e.ANY=2]="ANY"}($o||($o={}));var na,ia,ra,oa,aa,sa,ca,la,ua=(na=new yn(0,0,0),function(e,t){var n=yn.dot(e.d,t.n);if(Math.abs(n)<Number.EPSILON)return 0;yn.multiplyScalar(na,t.n,t.d);var i=yn.dot(yn.subtract(na,na,e.o),t.n)/n;return i<0?0:i}),ha=(ia=new yn(0,0,0),ra=new yn(0,0,0),oa=new yn(0,0,0),aa=new yn(0,0,0),sa=new yn(0,0,0),function(e,t,n){yn.subtract(ia,t.b,t.a),yn.subtract(ra,t.c,t.a),yn.cross(oa,e.d,ra);var i=yn.dot(ia,oa);if(i<Number.EPSILON&&(!n||i>-Number.EPSILON))return 0;var r=1/i;yn.subtract(aa,e.o,t.a);var o=yn.dot(aa,oa)*r;if(o<0||o>1)return 0;yn.cross(sa,aa,ia);var a=yn.dot(e.d,sa)*r;if(a<0||o+a>1)return 0;var s=yn.dot(ra,sa)*r;return s<0?0:s}),_a=function(){var e=new yn(0,0,0);return function(t,n){var i=n.radius,r=n.center,o=t.o,a=t.d,s=i*i;yn.subtract(e,r,o);var c=e.lengthSqr(),l=yn.dot(e,a),u=s-(c-l*l);if(u<0)return 0;var h=Math.sqrt(u),_=c<s?l+h:l-h;return _<0?0:_}}(),fa=(ca=new yn,la=new yn,function(e,t){return yn.subtract(ca,t.center,t.halfExtents),yn.add(la,t.center,t.halfExtents),da(e,ca,la)});function da(e,t,n){var i=e.o,r=e.d,o=1/r.x,a=1/r.y,s=1/r.z,c=(t.x-i.x)*o,l=(n.x-i.x)*o,u=(t.y-i.y)*a,h=(n.y-i.y)*a,_=(t.z-i.z)*s,f=(n.z-i.z)*s,d=Math.max(Math.max(Math.min(c,l),Math.min(u,h)),Math.min(_,f)),p=Math.min(Math.min(Math.max(c,l),Math.max(u,h)),Math.max(_,f));return p<0||d>p?0:d>0?d:p}var pa,ma,va,ga,ya=function(){var e=new yn,t=new yn,n=new yn,i=new yn,r=new yn,o=new yn,a=new yn,s=new Array(3),c=new Array(3),l=new Array(3),u=new Array(6);return function(h,_){s[0]=_.halfExtents.x,s[1]=_.halfExtents.y,s[2]=_.halfExtents.z,e=_.center,t=h.o,n=h.d,yn.set(i,_.orientation.m00,_.orientation.m01,_.orientation.m02),yn.set(r,_.orientation.m03,_.orientation.m04,_.orientation.m05),yn.set(o,_.orientation.m06,_.orientation.m07,_.orientation.m08),yn.subtract(a,e,t),c[0]=yn.dot(i,n),c[1]=yn.dot(r,n),c[2]=yn.dot(o,n),l[0]=yn.dot(i,a),l[1]=yn.dot(r,a),l[2]=yn.dot(o,a);for(var f=0;f<3;++f){if(0===c[f]){if(-l[f]-s[f]>0||-l[f]+s[f]<0)return 0;c[f]=1e-7}u[2*f+0]=(l[f]+s[f])/c[f],u[2*f+1]=(l[f]-s[f])/c[f]}var d=Math.max(Math.max(Math.min(u[0],u[1]),Math.min(u[2],u[3])),Math.min(u[4],u[5])),p=Math.min(Math.min(Math.max(u[0],u[1]),Math.max(u[2],u[3])),Math.max(u[4],u[5]));return p<0||d>p?0:d>0?d:p}}(),xa=function(){var e=new yn,t=new yn,n=new yn,i=new yn,r=new yn,o=new yn,a=new yn,s=new ea;return function(c,l){var u=l.radius*l.radius,h=yn.normalize(e,c.d),_=l.ellipseCenter0,f=l.ellipseCenter1,d=yn.subtract(t,f,_);if(d.equals(yn.ZERO))return s.radius=l.radius,s.center.set(l.ellipseCenter0),rs.raySphere(c,s);var p=c.o,m=yn.subtract(n,p,_),v=yn.cross(i,h,d),g=v.lengthSqr();if(0===g){s.radius=l.radius;var y=yn.subtract(r,f,p);return m.lengthSqr()<y.lengthSqr()?s.center.set(l.ellipseCenter0):s.center.set(l.ellipseCenter1),rs.raySphere(c,s)}var x=yn.cross(r,m,d),S=d.lengthSqr(),E=2*yn.dot(v,x),T=E*E-4*g*(x.lengthSqr()-u*S);if(T<0)return 0;var C=(-E-Math.sqrt(T))/(2*g);if(C<0){s.radius=l.radius;var b=yn.subtract(o,f,p);return m.lengthSqr()<b.lengthSqr()?s.center.set(l.ellipseCenter0):s.center.set(l.ellipseCenter1),rs.raySphere(c,s)}var A=yn.scaleAndAdd(o,c.o,h,C),w=yn.subtract(a,A,_),I=yn.dot(w,d)/S;return I>=0&&I<=1?C:I<0?(s.radius=l.radius,s.center.set(l.ellipseCenter0),rs.raySphere(c,s)):I>1?(s.radius=l.radius,s.center.set(l.ellipseCenter1),rs.raySphere(c,s)):0}}(),Sa=(pa=ta.create(),ma={distance:1/0,doubleSided:!1,mode:$o.ANY},va=0,ga=function(e,t,n,i,r,o){e===$o.CLOSEST?(va>t||0===va)&&(va=t,o&&(0===o.length?o.push({distance:t,vertexIndex0:n/3,vertexIndex1:i/3,vertexIndex2:r/3}):(o[0].distance=t,o[0].vertexIndex0=n/3,o[0].vertexIndex1=i/3,o[0].vertexIndex2=r/3))):(va=t,o&&o.push({distance:t,vertexIndex0:n/3,vertexIndex1:i/3,vertexIndex2:r/3}))},function(e,t,n){if(va=0,0===t.geometricInfo.positions.length)return va;var i=void 0===n?ma:n;if(da(e,t.geometricInfo.boundingBox.min,t.geometricInfo.boundingBox.max)){var r=t.primitiveMode,o=t.geometricInfo;!function(e,t,n,i,r){if(n===Oi.TRIANGLE_LIST)for(var o=t.length,a=0;a<o;a+=3){var s=3*t[a],c=3*t[a+1],l=3*t[a+2];yn.set(pa.a,e[s],e[s+1],e[s+2]),yn.set(pa.b,e[c],e[c+1],e[c+2]),yn.set(pa.c,e[l],e[l+1],e[l+2]);var u=rs.rayTriangle(i,pa,r.doubleSided);if(!(0===u||u>r.distance)&&(ga(r.mode,u,s,c,l,r.result),r.mode===$o.ANY))return u}else if(n===Oi.TRIANGLE_STRIP)for(var h=t.length-2,_=0,f=0;f<h;f+=1){var d=3*t[f-_],p=3*t[f+_+1],m=3*t[f+2];yn.set(pa.a,e[d],e[d+1],e[d+2]),yn.set(pa.b,e[p],e[p+1],e[p+2]),yn.set(pa.c,e[m],e[m+1],e[m+2]),_=~_;var v=rs.rayTriangle(i,pa,r.doubleSided);if(!(0===v||v>r.distance)&&(ga(r.mode,v,d,p,m,r.result),r.mode===$o.ANY))return v}else if(n===Oi.TRIANGLE_FAN){var g=t.length-1,y=3*t[0];yn.set(pa.a,e[y],e[y+1],e[y+2]);for(var x=1;x<g;x+=1){var S=3*t[x],E=3*t[x+1];yn.set(pa.b,e[S],e[S+1],e[S+2]),yn.set(pa.c,e[E],e[E+1],e[E+2]);var T=rs.rayTriangle(i,pa,r.doubleSided);if(!(0===T||T>r.distance)&&(ga(r.mode,T,y,S,E,r.result),r.mode===$o.ANY))return T}}}(o.positions,o.indices,r,e,i)}return va}),Ea=function(){var e=0,t={distance:1/0,doubleSided:!1,mode:$o.ANY};return function(n,i,r){e=0;var o=void 0===r?t:r,a=i.renderingSubMeshes.length,s=i.struct.minPosition,c=i.struct.maxPosition;if(s&&c&&!da(n,s,c))return e;for(var l=0;l<a;l++){var u=i.renderingSubMeshes[l],h=Sa(n,u,o);if(h)if(o.mode===$o.CLOSEST)(0===e||e>h)&&(e=h,o.subIndices&&(o.subIndices[0]=l));else if(e=h,o.subIndices&&o.subIndices.push(l),o.mode===$o.ANY)return h}return e&&o.mode===$o.CLOSEST&&(o.result&&(o.result[0].distance=e,o.result.length=1),o.subIndices&&(o.subIndices.length=1)),e}}(),Ta=function(){var e=0,t={distance:1/0,doubleSided:!1,mode:$o.ANY},n=new Xo,i=new kn;return function(r,o,a){e=0;var s=void 0===a?t:a,c=o.worldBounds;if(c&&!fa(r,c))return e;Xo.copy(n,r),o.node&&(kn.invert(i,o.node.getWorldMatrix(i)),yn.transformMat4(n.o,r.o,i),yn.transformMat4Normal(n.d,r.d,i));for(var l=o.subModels,u=0;u<l.length;u++){var h=l[u].subMesh,_=Sa(n,h,s);if(_)if(s.mode===$o.CLOSEST)(0===e||e>_)&&(e=_,s.subIndices&&(s.subIndices[0]=u));else if(e=_,s.subIndices&&s.subIndices.push(u),s.mode===$o.ANY)return _}return e&&s.mode===$o.CLOSEST&&(s.result&&(s.result[0].distance=e,s.result.length=1),s.subIndices&&(s.subIndices.length=1)),e}}(),Ca=function(){var e=new yn(0,0,0);return function(t,n){yn.subtract(e,t.e,t.s);var i=(n.d-yn.dot(t.s,n.n))/yn.dot(e,n.n);return i<0||i>1?0:i}}(),ba=function(){var e=new yn(0,0,0),t=new yn(0,0,0),n=new yn(0,0,0),i=new yn(0,0,0),r=new yn(0,0,0),o=new yn(0,0,0);return function(a,s,c){yn.subtract(e,s.b,s.a),yn.subtract(t,s.c,s.a),yn.subtract(n,a.s,a.e),yn.cross(r,e,t);var l=yn.dot(n,r);if(l<=0)return 0;yn.subtract(i,a.s,s.a);var u=yn.dot(i,r);if(u<0||u>l)return 0;yn.cross(o,n,i);var h=yn.dot(t,o);if(h<0||h>l)return 0;var _=-yn.dot(e,o);if(_<0||h+_>l)return 0;if(c){var f=1/l,d=1-(h*=f)-(_*=f);yn.set(c,s.a.x*d+s.b.x*h+s.c.x*_,s.a.y*d+s.b.y*h+s.c.y*_,s.a.z*d+s.b.z*h+s.c.z*_)}return 1}}(),Aa=new Xo;function wa(e,t){Aa.o.set(e.s),yn.subtract(Aa.d,e.e,e.s),Aa.d.normalize();var n=fa(Aa,t);return n<=e.length()?n:0}function Ia(e,t){Aa.o.set(e.s),yn.subtract(Aa.d,e.e,e.s),Aa.d.normalize();var n=ya(Aa,t);return n<=e.length()?n:0}function Pa(e,t){Aa.o.set(e.s),yn.subtract(Aa.d,e.e,e.s),Aa.d.normalize();var n=_a(Aa,t);return n<=e.length()?n:0}var Ra,Da,Oa,Na,Ma=(Ra=new yn,Da=new yn,Oa=new yn,Na=new yn,function(e,t){return yn.subtract(Ra,e.center,e.halfExtents),yn.add(Da,e.center,e.halfExtents),yn.subtract(Oa,t.center,t.halfExtents),yn.add(Na,t.center,t.halfExtents),Ra.x<=Na.x&&Da.x>=Oa.x&&Ra.y<=Na.y&&Da.y>=Oa.y&&Ra.z<=Na.z&&Da.z>=Oa.z});function La(e,t,n,i,r,o){yn.set(o[0],e.x+n.x*t.x+i.x*t.y+r.x*t.z,e.y+n.y*t.x+i.y*t.y+r.y*t.z,e.z+n.z*t.x+i.z*t.y+r.z*t.z),yn.set(o[1],e.x-n.x*t.x+i.x*t.y+r.x*t.z,e.y-n.y*t.x+i.y*t.y+r.y*t.z,e.z-n.z*t.x+i.z*t.y+r.z*t.z),yn.set(o[2],e.x+n.x*t.x-i.x*t.y+r.x*t.z,e.y+n.y*t.x-i.y*t.y+r.y*t.z,e.z+n.z*t.x-i.z*t.y+r.z*t.z),yn.set(o[3],e.x+n.x*t.x+i.x*t.y-r.x*t.z,e.y+n.y*t.x+i.y*t.y-r.y*t.z,e.z+n.z*t.x+i.z*t.y-r.z*t.z),yn.set(o[4],e.x-n.x*t.x-i.x*t.y-r.x*t.z,e.y-n.y*t.x-i.y*t.y-r.y*t.z,e.z-n.z*t.x-i.z*t.y-r.z*t.z),yn.set(o[5],e.x+n.x*t.x-i.x*t.y-r.x*t.z,e.y+n.y*t.x-i.y*t.y-r.y*t.z,e.z+n.z*t.x-i.z*t.y-r.z*t.z),yn.set(o[6],e.x-n.x*t.x+i.x*t.y-r.x*t.z,e.y-n.y*t.x+i.y*t.y-r.y*t.z,e.z-n.z*t.x+i.z*t.y-r.z*t.z),yn.set(o[7],e.x-n.x*t.x-i.x*t.y+r.x*t.z,e.y-n.y*t.x-i.y*t.y+r.y*t.z,e.z-n.z*t.x-i.z*t.y+r.z*t.z)}function Fa(e,t){for(var n=yn.dot(t,e[0]),i=n,r=1;r<8;++r){var o=yn.dot(t,e[r]);n=o<n?o:n,i=o>i?o:i}return[n,i]}var Ba,za,Ua,ka=function(){for(var e=new Array(15),t=0;t<15;t++)e[t]=new yn(0,0,0);for(var n=new Array(8),i=new Array(8),r=0;r<8;r++)n[r]=new yn(0,0,0),i[r]=new yn(0,0,0);var o=new yn,a=new yn;return function(t,r){yn.set(e[0],1,0,0),yn.set(e[1],0,1,0),yn.set(e[2],0,0,1),yn.set(e[3],r.orientation.m00,r.orientation.m01,r.orientation.m02),yn.set(e[4],r.orientation.m03,r.orientation.m04,r.orientation.m05),yn.set(e[5],r.orientation.m06,r.orientation.m07,r.orientation.m08);for(var s=0;s<3;++s)yn.cross(e[6+3*s],e[s],e[3]),yn.cross(e[7+3*s],e[s],e[4]),yn.cross(e[7+3*s],e[s],e[5]);yn.subtract(o,t.center,t.halfExtents),yn.add(a,t.center,t.halfExtents),function(e,t,n){yn.set(n[0],e.x,t.y,t.z),yn.set(n[1],e.x,t.y,e.z),yn.set(n[2],e.x,e.y,t.z),yn.set(n[3],e.x,e.y,e.z),yn.set(n[4],t.x,t.y,t.z),yn.set(n[5],t.x,t.y,e.z),yn.set(n[6],t.x,e.y,t.z),yn.set(n[7],t.x,e.y,e.z)}(o,a,n),La(r.center,r.halfExtents,e[3],e[4],e[5],i);for(var c=0;c<15;++c){var l=Fa(n,e[c]),u=Fa(i,e[c]);if(u[0]>l[1]||l[0]>u[1])return 0}return 1}}(),Ga=function(e,t){var n=e.halfExtents.x*Math.abs(t.n.x)+e.halfExtents.y*Math.abs(t.n.y)+e.halfExtents.z*Math.abs(t.n.z),i=yn.dot(t.n,e.center);return i+n<t.d?-1:i-n>t.d?0:1},Ha=function(e,t){for(var n=0;n<t.planes.length;n++)if(-1===Ga(e,t.planes[n]))return 0;return 1},Va=function(){for(var e=new Array(8),t=0,n=0,i=0;i<e.length;i++)e[i]=new yn(0,0,0);return function(i,r){for(var o=0,a=!1,s=0;s<r.planes.length;s++){if(-1===(o=Ga(i,r.planes[s])))return 0;1===o&&(a=!0)}if(!a)return 1;for(var c=0;c<r.vertices.length;c++)yn.subtract(e[c],r.vertices[c],i.center);t=0,n=0;for(var l=0;l<r.vertices.length;l++)e[l].x>i.halfExtents.x?t++:e[l].x<-i.halfExtents.x&&n++;if(t===r.vertices.length||n===r.vertices.length)return 0;t=0,n=0;for(var u=0;u<r.vertices.length;u++)e[u].y>i.halfExtents.y?t++:e[u].y<-i.halfExtents.y&&n++;if(t===r.vertices.length||n===r.vertices.length)return 0;t=0,n=0;for(var h=0;h<r.vertices.length;h++)e[h].z>i.halfExtents.z?t++:e[h].z<-i.halfExtents.z&&n++;return t===r.vertices.length||n===r.vertices.length?0:1}}(),Wa=(Ba=new yn(0,0,0),za=new Pn,function(e,t){return yn.subtract(Ba,t,e.center),yn.transformMat3(Ba,Ba,Pn.transpose(za,e.orientation)),n=Ba,i=e.halfExtents,Math.abs(n.x)<i.x&&Math.abs(n.y)<i.y&&Math.abs(n.z)<i.z;var n,i}),ja=(Ua=function(e,t,n,i){return Math.abs(e.x*t+e.y*n+e.z*i)},function(e,t){var n=e.halfExtents.x*Ua(t.n,e.orientation.m00,e.orientation.m01,e.orientation.m02)+e.halfExtents.y*Ua(t.n,e.orientation.m03,e.orientation.m04,e.orientation.m05)+e.halfExtents.z*Ua(t.n,e.orientation.m06,e.orientation.m07,e.orientation.m08),i=yn.dot(t.n,e.center);return i+n<t.d?-1:i-n>t.d?0:1}),qa=function(e,t){for(var n=0;n<t.planes.length;n++)if(-1===ja(e,t.planes[n]))return 0;return 1},Xa=function(){for(var e=new Array(8),t=0,n=0,i=0,r=0;r<e.length;r++)e[r]=new yn(0,0,0);var o=function(e,t,n,i){return e.x*t+e.y*n+e.z*i};return function(r,a){for(var s=0,c=!1,l=0;l<a.planes.length;l++){if(-1===(s=ja(r,a.planes[l])))return 0;1===s&&(c=!0)}if(!c)return 1;for(var u=0;u<a.vertices.length;u++)yn.subtract(e[u],a.vertices[u],r.center);n=0,i=0;for(var h=0;h<a.vertices.length;h++)(t=o(e[h],r.orientation.m00,r.orientation.m01,r.orientation.m02))>r.halfExtents.x?n++:t<-r.halfExtents.x&&i++;if(n===a.vertices.length||i===a.vertices.length)return 0;n=0,i=0;for(var _=0;_<a.vertices.length;_++)(t=o(e[_],r.orientation.m03,r.orientation.m04,r.orientation.m05))>r.halfExtents.y?n++:t<-r.halfExtents.y&&i++;if(n===a.vertices.length||i===a.vertices.length)return 0;n=0,i=0;for(var f=0;f<a.vertices.length;f++)(t=o(e[f],r.orientation.m06,r.orientation.m07,r.orientation.m08))>r.halfExtents.z?n++:t<-r.halfExtents.z&&i++;return n===a.vertices.length||i===a.vertices.length?0:1}}(),Ya=function(){for(var e=new Array(15),t=0;t<15;t++)e[t]=new yn(0,0,0);for(var n=new Array(8),i=new Array(8),r=0;r<8;r++)n[r]=new yn(0,0,0),i[r]=new yn(0,0,0);return function(t,r){yn.set(e[0],t.orientation.m00,t.orientation.m01,t.orientation.m02),yn.set(e[1],t.orientation.m03,t.orientation.m04,t.orientation.m05),yn.set(e[2],t.orientation.m06,t.orientation.m07,t.orientation.m08),yn.set(e[3],r.orientation.m00,r.orientation.m01,r.orientation.m02),yn.set(e[4],r.orientation.m03,r.orientation.m04,r.orientation.m05),yn.set(e[5],r.orientation.m06,r.orientation.m07,r.orientation.m08);for(var o=0;o<3;++o)yn.cross(e[6+3*o],e[o],e[3]),yn.cross(e[7+3*o],e[o],e[4]),yn.cross(e[8+3*o],e[o],e[5]);La(t.center,t.halfExtents,e[0],e[1],e[2],n),La(r.center,r.halfExtents,e[3],e[4],e[5],i);for(var a=0;a<15;++a){var s=Fa(n,e[a]),c=Fa(i,e[a]);if(c[0]>s[1]||s[0]>c[1])return 0}return 1}}(),Ka=function(){for(var e=new ea,t=new yn,n=new yn,i=new yn,r=new Array(8),o=0;o<8;o++)r[o]=new yn;for(var a=new Array(8),s=0;s<8;s++)a[s]=new yn;return function(o,s){if(0===yn.squaredDistance(s.ellipseCenter0,s.ellipseCenter1))return e.radius=s.radius,e.center.set(s.ellipseCenter0),rs.sphereOBB(e,o);t.x=o.orientation.m00,t.y=o.orientation.m01,t.z=o.orientation.m02,n.x=o.orientation.m03,n.y=o.orientation.m04,n.z=o.orientation.m05,i.x=o.orientation.m06,i.y=o.orientation.m07,i.z=o.orientation.m08,La(o.center,o.halfExtents,t,n,i,r);var c=a,l=yn.copy(c[0],t),u=yn.copy(c[1],n),h=yn.copy(c[2],i);yn.subtract(c[3],s.center,o.center).normalize();var _=yn.subtract(c[4],s.ellipseCenter0,s.ellipseCenter1);_.normalize(),yn.cross(c[5],l,_),yn.cross(c[6],u,_),yn.cross(c[7],h,_);for(var f=0;f<8;++f){var d=Fa(r,c[f]),p=yn.dot(c[f],s.ellipseCenter0),m=yn.dot(c[f],s.ellipseCenter1),v=Math.max(p,m),g=Math.min(p,m)-s.radius,y=v+s.radius;if(g>d[1]||d[0]>y)return 0}return 1}}(),Qa=function(e,t){var n=yn.dot(t.n,e.center),i=e.radius*t.n.length();return n+i<t.d?-1:n-i>t.d?0:1},Ja=function(e,t){for(var n=0;n<t.planes.length;n++)if(-1===Qa(e,t.planes[n]))return 0;return 1},Za=function(){var e=new yn(0,0,0),t=[1,-1,1,-1,1,-1];return function(n,i){for(var r=0;r<6;r++){var o=i.planes[r],a=n.radius,s=n.center,c=o.n,l=o.d,u=yn.dot(c,s);if(u+a<l)return 0;if(!(u-a>l)){yn.add(e,s,yn.multiplyScalar(e,c,a));for(var h=0;h<6;h++)if(h!==r&&h!==r+t[r]){var _=i.planes[h];if(yn.dot(_.n,e)<_.d)return 0}}}return 1}}(),$a=function(e,t){var n=e.radius+t.radius;return yn.squaredDistance(e.center,t.center)<n*n},es=function(){var e=new yn;return function(t,n){return Vo(e,t.center,n),yn.squaredDistance(t.center,e)<t.radius*t.radius}}(),ts=function(){var e=new yn;return function(t,n){return Wo(e,t.center,n),yn.squaredDistance(t.center,e)<t.radius*t.radius}}(),ns=function(){var e=new yn,t=new yn;return function(n,i){var r=n.radius+i.radius,o=r*r,a=yn.squaredDistance(i.ellipseCenter0,i.ellipseCenter1);if(0===a)return yn.squaredDistance(n.center,i.center)<o;yn.subtract(e,n.center,i.ellipseCenter0),yn.subtract(t,i.ellipseCenter1,i.ellipseCenter0);var s=yn.dot(e,t)/a;return s<0?yn.squaredDistance(n.center,i.ellipseCenter0)<o:s>1?yn.squaredDistance(n.center,i.ellipseCenter1)<o:(yn.scaleAndAdd(e,i.ellipseCenter0,t,s),yn.squaredDistance(n.center,e)<o)}}(),is=function(){var e=new yn,t=new yn,n=new yn,i=new yn,r=new yn,o=new yn;return function(a,s){var c,l,u=yn.subtract(e,a.ellipseCenter1,a.ellipseCenter0),h=yn.subtract(t,s.ellipseCenter1,s.ellipseCenter0),_=yn.subtract(n,a.ellipseCenter0,s.ellipseCenter0),f=yn.dot(u,u),d=yn.dot(u,h),p=yn.dot(h,h),m=yn.dot(u,_),v=yn.dot(h,_),g=f*p-d*d,y=g,x=g;g<Jt?(c=0,y=1,l=v,x=p):(l=f*v-d*m,(c=d*v-p*m)<0?(c=0,l=v,x=p):c>y&&(c=y,l=v+d,x=p)),l<0?(l=0,-m<0?c=0:-m>f?c=y:(c=-m,y=f)):l>x&&(l=x,-m+d<0?c=0:-m+d>f?c=y:(c=-m+d,y=f));var S=Math.abs(c)<Jt?0:c/y,E=Math.abs(l)<Jt?0:l/x,T=i;T.set(_),T.add(yn.multiplyScalar(r,u,S)),T.subtract(yn.multiplyScalar(o,h,E));var C=a.radius+s.radius;return T.lengthSqr()<C*C}}(),rs={raySphere:_a,rayAABB:fa,rayOBB:ya,rayPlane:ua,rayTriangle:ha,rayCapsule:xa,raySubMesh:Sa,rayMesh:Ea,rayModel:Ta,lineSphere:Pa,lineAABB:wa,lineOBB:Ia,linePlane:Ca,lineTriangle:ba,sphereWithSphere:$a,sphereAABB:es,sphereOBB:ts,spherePlane:Qa,sphereFrustum:Ja,sphereFrustumAccurate:Za,sphereCapsule:ns,aabbWithAABB:Ma,aabbWithOBB:ka,aabbPlane:Ga,aabbFrustum:Ha,aabbFrustumAccurate:Va,obbWithOBB:Ya,obbPlane:ja,obbFrustum:qa,obbFrustumAccurate:Xa,obbPoint:Wa,obbCapsule:Ka,capsuleWithCapsule:is,resolve:function(e,t,n){void 0===n&&(n=null);var i=e._type,r=t._type,o=this[i|r];return i<r?o(e,t,n):o(t,e,n)}};rs[qo.SHAPE_RAY|qo.SHAPE_SPHERE]=_a,rs[qo.SHAPE_RAY|qo.SHAPE_AABB]=fa,rs[qo.SHAPE_RAY|qo.SHAPE_OBB]=ya,rs[qo.SHAPE_RAY|qo.SHAPE_PLANE]=ua,rs[qo.SHAPE_RAY|qo.SHAPE_TRIANGLE]=ha,rs[qo.SHAPE_RAY|qo.SHAPE_CAPSULE]=xa,rs[qo.SHAPE_LINE|qo.SHAPE_SPHERE]=Pa,rs[qo.SHAPE_LINE|qo.SHAPE_AABB]=wa,rs[qo.SHAPE_LINE|qo.SHAPE_OBB]=Ia,rs[qo.SHAPE_LINE|qo.SHAPE_PLANE]=Ca,rs[qo.SHAPE_LINE|qo.SHAPE_TRIANGLE]=ba,rs[qo.SHAPE_SPHERE]=$a,rs[qo.SHAPE_SPHERE|qo.SHAPE_AABB]=es,rs[qo.SHAPE_SPHERE|qo.SHAPE_OBB]=ts,rs[qo.SHAPE_SPHERE|qo.SHAPE_PLANE]=Qa,rs[qo.SHAPE_SPHERE|qo.SHAPE_FRUSTUM]=Ja,rs[qo.SHAPE_SPHERE|qo.SHAPE_FRUSTUM_ACCURATE]=Za,rs[qo.SHAPE_SPHERE|qo.SHAPE_CAPSULE]=ns,rs[qo.SHAPE_AABB]=Ma,rs[qo.SHAPE_AABB|qo.SHAPE_OBB]=ka,rs[qo.SHAPE_AABB|qo.SHAPE_PLANE]=Ga,rs[qo.SHAPE_AABB|qo.SHAPE_FRUSTUM]=Ha,rs[qo.SHAPE_AABB|qo.SHAPE_FRUSTUM_ACCURATE]=Va,rs[qo.SHAPE_OBB]=Ya,rs[qo.SHAPE_OBB|qo.SHAPE_PLANE]=ja,rs[qo.SHAPE_OBB|qo.SHAPE_FRUSTUM]=qa,rs[qo.SHAPE_OBB|qo.SHAPE_FRUSTUM_ACCURATE]=Xa,rs[qo.SHAPE_OBB|qo.SHAPE_CAPSULE]=Ka,rs[qo.SHAPE_CAPSULE]=is;var os,as,ss,cs,ls,us,hs,_s=function(){function e(e,t,n,i,r,o){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===o&&(o=-1),this.s=void 0,this.e=void 0,this._type=void 0,this._type=qo.SHAPE_LINE,this.s=new yn(e,t,n),this.e=new yn(i,r,o)}return e.create=function(t,n,i,r,o,a){return new e(t,n,i,r,o,a)},e.clone=function(t){return new e(t.s.x,t.s.y,t.s.z,t.e.x,t.e.y,t.e.z)},e.copy=function(e,t){return yn.copy(e.s,t.s),yn.copy(e.e,t.e),e},e.fromPoints=function(e,t,n){return yn.copy(e.s,t),yn.copy(e.e,n),e},e.set=function(e,t,n,i,r,o,a){return e.s.x=t,e.s.y=n,e.s.z=i,e.e.x=r,e.e.y=o,e.e.z=a,e},e.len=function(e){return yn.distance(e.s,e.e)},e.prototype.length=function(){return yn.distance(this.s,this.e)},h(e,[{key:"type",get:function(){return this._type}}]),e}(),fs=new yn(0,0,0),ds=new yn(0,0,0),ps=b.mat4(),ms=b.v4(),vs=function(){function e(e,t,n,i){void 0===e&&(e=0),void 0===t&&(t=1),void 0===n&&(n=0),void 0===i&&(i=0),this.n=void 0,this.d=void 0,this._type=void 0,this._type=qo.SHAPE_PLANE,this.n=new yn(e,t,n),this.d=i}return e.create=function(t,n,i,r){return new e(t,n,i,r)},e.clone=function(t){return new e(t.n.x,t.n.y,t.n.z,t.d)},e.copy=function(e,t){return yn.copy(e.n,t.n),e.d=t.d,e},e.fromPoints=function(e,t,n,i){return yn.subtract(fs,n,t),yn.subtract(ds,i,t),yn.normalize(e.n,yn.cross(e.n,fs,ds)),e.d=yn.dot(e.n,t),e},e.set=function(e,t,n,i,r){return e.n.x=t,e.n.y=n,e.n.z=i,e.d=r,e},e.fromNormalAndPoint=function(e,t,n){return yn.copy(e.n,t),e.d=yn.dot(t,n),e},e.normalize=function(e,t){var n=t.n.length();return yn.normalize(e.n,t.n),n>0&&(e.d=t.d/n),e},e.prototype.transform=function(e){kn.invert(ps,e),kn.transpose(ps,ps),wn.set(ms,this.n.x,this.n.y,this.n.z,this.d),wn.transformMat4(ms,ms,ps),yn.set(this.n,ms.x,ms.y,ms.z),this.d=ms.w},h(e,[{key:"type",get:function(){return this._type}},{key:"x",get:function(){return this.n.x},set:function(e){this.n.x=e}},{key:"y",get:function(){return this.n.y},set:function(e){this.n.y=e}},{key:"z",get:function(){return this.n.z},set:function(e){this.n.z=e}},{key:"w",get:function(){return this.d},set:function(e){this.d=e}}]),e}(),gs=function(){function e(e,t,n){this._arrayBuffers=[],this._chunkSize=void 0,this._chunkSize=n*(1<<t)}return e.prototype.allocateNewChunk=function(){return new ArrayBuffer(this._chunkSize)},e}();!function(e){e[e.UINT32=0]="UINT32",e[e.FLOAT32=1]="FLOAT32",e[e.NEVER=2]="NEVER"}(hs||(hs={}));var ys,xs,Ss=function(){function e(e,t,n,i,r){void 0===r&&(r=8),this._dataType=void 0,this._dataMembers=void 0,this._elementCount=void 0,this._entryBits=void 0,this._stride=void 0,this._entriesPerChunk=void 0,this._entryMask=void 0,this._chunkMask=void 0,this._poolFlag=void 0,this._arrayBuffers=[],this._freeLists=[],this._uint32BufferViews=[],this._float32BufferViews=[],this._hasUint32=!1,this._hasFloat32=!1,this._nativePool=void 0,this._elementCount=i.COUNT,this._entryBits=r,this._dataType=t,this._dataMembers=n,this._stride=4*this._elementCount,this._entriesPerChunk=1<<r,this._entryMask=this._entriesPerChunk-1,this._poolFlag=1<<30,this._chunkMask=~(this._entryMask|this._poolFlag),this._nativePool=new gs(e,r,this._stride);var o=hs.NEVER,a=!1,s=!1;for(var c in t){if(a=this._hasFloat32,(s=this._hasUint32)&&a)break;o=t[c],a||o!==hs.FLOAT32?s||o!==hs.UINT32||(this._hasUint32=!0):this._hasFloat32=!0}}var t=e.prototype;return t.alloc=function(){for(var e=0;e<this._freeLists.length;e++){var t=this._freeLists[e];if(t.length){var n=t[t.length-1];return t.length--,(e<<this._entryBits)+n+this._poolFlag}}for(var i=this._nativePool.allocateNewChunk(),r=[],o=[],a=[],s=this._hasFloat32,c=this._hasUint32,l=0;l<this._entriesPerChunk;l++)s&&r.push(new Float32Array(i,this._stride*l,this._elementCount)),c&&o.push(new Uint32Array(i,this._stride*l,this._elementCount)),l&&a.push(l);return c&&this._uint32BufferViews.push(o),s&&this._float32BufferViews.push(r),this._freeLists.push(a),this._arrayBuffers.push(i),(e<<this._entryBits)+this._poolFlag},t.getBuffer=function(e){var t=(this._chunkMask&e)>>this._entryBits,n=this._entryMask&e;return(this._hasFloat32?this._float32BufferViews:this._uint32BufferViews)[t][n]},t.getTypedArray=function(e,t){var n=(this._chunkMask&e)>>this._entryBits,i=this._entryMask&e,r=t,o=(this._dataType[t]===hs.UINT32?this._uint32BufferViews:this._float32BufferViews)[n][i],a=this._dataMembers[t];return o.subarray(r,r+a)},t.free=function(e){var t=(this._chunkMask&e)>>this._entryBits,n=this._entryMask&e;(this._hasUint32?this._uint32BufferViews:this._float32BufferViews)[t][n].fill(0),this._freeLists[t].push(n)},e}();!function(e){e[e.NODE=0]="NODE",e[e.PASS=1]="PASS",e[e.AABB=2]="AABB"}(ys||(ys={})),function(e){e[e.DIRTY_FLAG=0]="DIRTY_FLAG",e[e.LAYER=1]="LAYER",e[e.WORLD_SCALE=2]="WORLD_SCALE",e[e.WORLD_POSITION=5]="WORLD_POSITION",e[e.WORLD_ROTATION=8]="WORLD_ROTATION",e[e.WORLD_MATRIX=12]="WORLD_MATRIX",e[e.LOCAL_SCALE=28]="LOCAL_SCALE",e[e.LOCAL_POSITION=31]="LOCAL_POSITION",e[e.LOCAL_ROTATION=34]="LOCAL_ROTATION",e[e.COUNT=38]="COUNT"}(xs||(xs={}));var Es,Ts=((os={})[xs.DIRTY_FLAG]=hs.UINT32,os[xs.LAYER]=hs.UINT32,os[xs.WORLD_SCALE]=hs.FLOAT32,os[xs.WORLD_POSITION]=hs.FLOAT32,os[xs.WORLD_ROTATION]=hs.FLOAT32,os[xs.WORLD_MATRIX]=hs.FLOAT32,os[xs.LOCAL_SCALE]=hs.FLOAT32,os[xs.LOCAL_POSITION]=hs.FLOAT32,os[xs.LOCAL_ROTATION]=hs.FLOAT32,os[xs.COUNT]=hs.NEVER,os),Cs=((as={})[xs.DIRTY_FLAG]=xs.LAYER-xs.DIRTY_FLAG,as[xs.LAYER]=xs.WORLD_SCALE-xs.LAYER,as[xs.WORLD_SCALE]=xs.WORLD_POSITION-xs.WORLD_SCALE,as[xs.WORLD_POSITION]=xs.WORLD_ROTATION-xs.WORLD_POSITION,as[xs.WORLD_ROTATION]=xs.WORLD_MATRIX-xs.WORLD_ROTATION,as[xs.WORLD_MATRIX]=xs.LOCAL_SCALE-xs.WORLD_MATRIX,as[xs.LOCAL_SCALE]=xs.LOCAL_POSITION-xs.LOCAL_SCALE,as[xs.LOCAL_POSITION]=xs.LOCAL_ROTATION-xs.LOCAL_POSITION,as[xs.LOCAL_ROTATION]=xs.COUNT-xs.LOCAL_ROTATION,as[xs.COUNT]=1,as),bs=new Ss(ys.NODE,Ts,Cs,xs);!function(e){e[e.PRIORITY=0]="PRIORITY",e[e.STAGE=1]="STAGE",e[e.PHASE=2]="PHASE",e[e.PRIMITIVE=3]="PRIMITIVE",e[e.BATCHING_SCHEME=4]="BATCHING_SCHEME",e[e.DYNAMIC_STATE=5]="DYNAMIC_STATE",e[e.HASH=6]="HASH",e[e.COUNT=7]="COUNT"}(Es||(Es={}));var As,ws=((ss={})[Es.PRIORITY]=hs.UINT32,ss[Es.STAGE]=hs.UINT32,ss[Es.PHASE]=hs.UINT32,ss[Es.PRIMITIVE]=hs.UINT32,ss[Es.BATCHING_SCHEME]=hs.UINT32,ss[Es.DYNAMIC_STATE]=hs.UINT32,ss[Es.HASH]=hs.UINT32,ss[Es.COUNT]=hs.NEVER,ss),Is=((cs={})[Es.PRIORITY]=Es.STAGE-Es.PRIORITY,cs[Es.STAGE]=Es.PHASE-Es.STAGE,cs[Es.PHASE]=Es.PRIMITIVE-Es.PHASE,cs[Es.PRIMITIVE]=Es.BATCHING_SCHEME-Es.PRIMITIVE,cs[Es.BATCHING_SCHEME]=Es.DYNAMIC_STATE-Es.BATCHING_SCHEME,cs[Es.DYNAMIC_STATE]=Es.HASH-Es.DYNAMIC_STATE,cs[Es.HASH]=Es.COUNT-Es.HASH,cs[Es.COUNT]=1,cs),Ps=new Ss(ys.PASS,ws,Is,Es);!function(e){e[e.CENTER=0]="CENTER",e[e.HALFEXTENTS=3]="HALFEXTENTS",e[e.COUNT=6]="COUNT"}(As||(As={}));var Rs=((ls={})[As.CENTER]=hs.FLOAT32,ls[As.HALFEXTENTS]=hs.FLOAT32,ls[As.COUNT]=hs.NEVER,ls),Ds=((us={})[As.CENTER]=As.HALFEXTENTS-As.CENTER,us[As.HALFEXTENTS]=As.COUNT-As.HALFEXTENTS,us[As.COUNT]=1,us),Os=new Ss(ys.AABB,Rs,Ds,As),Ns=new yn,Ms=new yn,Ls=new yn,Fs=new yn,Bs=new Pn,zs=function(e,t,n){Bs.m00=Math.abs(n.m00),Bs.m01=Math.abs(n.m01),Bs.m02=Math.abs(n.m02),Bs.m03=Math.abs(n.m04),Bs.m04=Math.abs(n.m05),Bs.m05=Math.abs(n.m06),Bs.m06=Math.abs(n.m08),Bs.m07=Math.abs(n.m09),Bs.m08=Math.abs(n.m10),yn.transformMat3(e,t,Bs)},Us=function(){function e(e,t,n,i,r,o){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=1),void 0===r&&(r=1),void 0===o&&(o=1),this.center=void 0,this.halfExtents=void 0,this._type=void 0,this._aabbHandle=0,this._type=qo.SHAPE_AABB,this.center=new yn(e,t,n),this.halfExtents=new yn(i,r,o)}e.create=function(t,n,i,r,o,a){return new e(t,n,i,r,o,a)},e.clone=function(t){return new e(t.center.x,t.center.y,t.center.z,t.halfExtents.x,t.halfExtents.y,t.halfExtents.z)},e.copy=function(e,t){return yn.copy(e.center,t.center),yn.copy(e.halfExtents,t.halfExtents),e},e.fromPoints=function(e,t,n){return yn.add(Ns,n,t),yn.subtract(Ms,n,t),yn.multiplyScalar(e.center,Ns,.5),yn.multiplyScalar(e.halfExtents,Ms,.5),e},e.set=function(e,t,n,i,r,o,a){return e.center.set(t,n,i),e.halfExtents.set(r,o,a),e},e.merge=function(t,n,i){return yn.subtract(Ns,n.center,n.halfExtents),yn.subtract(Ms,i.center,i.halfExtents),yn.add(Ls,n.center,n.halfExtents),yn.add(Fs,i.center,i.halfExtents),yn.max(Fs,Ls,Fs),yn.min(Ls,Ns,Ms),e.fromPoints(t,Ls,Fs)},e.toBoundingSphere=function(e,t){return e.center.set(t.center),e.radius=t.halfExtents.length(),e},e.transform=function(e,t,n){return yn.transformMat4(e.center,t.center,n),zs(e.halfExtents,t.halfExtents,n),e};var t=e.prototype;return t.getBoundary=function(e,t){yn.subtract(e,this.center,this.halfExtents),yn.add(t,this.center,this.halfExtents)},t.transform=function(e,t,n,i,r){yn.transformMat4(r.center,this.center,e),zs(r.halfExtents,this.halfExtents,e)},t.clone=function(){return e.clone(this)},t.copy=function(t){return e.copy(this,t)},t.mergePoint=function(e){this.getBoundary(Ns,Ms),e.x<Ns.x&&(Ns.x=e.x),e.y<Ns.y&&(Ns.y=e.y),e.z<Ns.z&&(Ns.z=e.z),e.x>Ms.x&&(Ms.x=e.x),e.y>Ms.y&&(Ms.y=e.y),e.z>Ms.z&&(Ms.z=e.z),yn.add(Ls,Ns,Ms),this.center.set(yn.multiplyScalar(Ls,Ls,.5)),this.halfExtents.set(Ms.x-Ls.x,Ms.y-Ls.y,Ms.z-Ls.z)},t.mergePoints=function(e){if(!(e.length<1))for(var t=0;t<e.length;t++)this.mergePoint(e[t])},t.mergeFrustum=function(e){return this.mergePoints(e.vertices)},h(e,[{key:"type",get:function(){return this._type}},{key:"native",get:function(){return this._nativeObj}}]),e}(),ks=new yn,Gs=new yn,Hs=new Pn,Vs=function(){function e(e,t,n,i,r,o,a,s,c,l,u,h,_,f,d){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=1),void 0===r&&(r=1),void 0===o&&(o=1),void 0===a&&(a=1),void 0===s&&(s=0),void 0===c&&(c=0),void 0===l&&(l=0),void 0===u&&(u=1),void 0===h&&(h=0),void 0===_&&(_=0),void 0===f&&(f=0),void 0===d&&(d=1),this.center=void 0,this.halfExtents=void 0,this.orientation=void 0,this._type=void 0,this._type=qo.SHAPE_OBB,this.center=new yn(e,t,n),this.halfExtents=new yn(i,r,o),this.orientation=new Pn(a,s,c,l,u,h,_,f,d)}e.create=function(t,n,i,r,o,a,s,c,l,u,h,_,f,d,p){return new e(t,n,i,r,o,a,s,c,l,u,h,_,f,d,p)},e.clone=function(t){return new e(t.center.x,t.center.y,t.center.z,t.halfExtents.x,t.halfExtents.y,t.halfExtents.z,t.orientation.m00,t.orientation.m01,t.orientation.m02,t.orientation.m03,t.orientation.m04,t.orientation.m05,t.orientation.m06,t.orientation.m07,t.orientation.m08)},e.copy=function(e,t){return yn.copy(e.center,t.center),yn.copy(e.halfExtents,t.halfExtents),Pn.copy(e.orientation,t.orientation),e},e.fromPoints=function(e,t,n){return yn.multiplyScalar(e.center,yn.add(ks,t,n),.5),yn.multiplyScalar(e.halfExtents,yn.subtract(Gs,n,t),.5),Pn.identity(e.orientation),e},e.set=function(e,t,n,i,r,o,a,s,c,l,u,h,_,f,d,p){return yn.set(e.center,t,n,i),yn.set(e.halfExtents,r,o,a),Pn.set(e.orientation,s,c,l,u,h,_,f,d,p),e};var t=e.prototype;return t.getBoundary=function(e,t){!function(e,t,n){Hs.m00=Math.abs(n.m00),Hs.m01=Math.abs(n.m01),Hs.m02=Math.abs(n.m02),Hs.m03=Math.abs(n.m03),Hs.m04=Math.abs(n.m04),Hs.m05=Math.abs(n.m05),Hs.m06=Math.abs(n.m06),Hs.m07=Math.abs(n.m07),Hs.m08=Math.abs(n.m08),yn.transformMat3(e,t,Hs)}(ks,this.halfExtents,this.orientation),yn.subtract(e,this.center,ks),yn.add(t,this.center,ks)},t.transform=function(e,t,n,i,r){yn.transformMat4(r.center,this.center,e),Pn.fromQuat(r.orientation,n),yn.multiply(r.halfExtents,this.halfExtents,i)},t.translateAndRotate=function(e,t,n){yn.transformMat4(n.center,this.center,e),Pn.fromQuat(n.orientation,t)},t.setScale=function(e,t){yn.multiply(t.halfExtents,this.halfExtents,e)},h(e,[{key:"type",get:function(){return this._type}}]),e}(),Ws=function(){function e(e,t,n){void 0===e&&(e=.5),void 0===t&&(t=.5),void 0===n&&(n=1),this._type=void 0,this.radius=void 0,this.halfHeight=void 0,this.axis=void 0,this.center=void 0,this.rotation=void 0,this.ellipseCenter0=void 0,this.ellipseCenter1=void 0,this._type=qo.SHAPE_CAPSULE,this.radius=e,this.halfHeight=t,this.axis=n,this.center=new yn,this.rotation=new On,this.ellipseCenter0=new yn(0,t,0),this.ellipseCenter1=new yn(0,-t,0),this.updateCache()}var t=e.prototype;return t.transform=function(e,t,n,i,r){var o=i,a=mn(o);r.radius=this.radius*Math.abs(a);var s=(this.halfHeight+this.radius)*Math.abs(o.y)-r.radius;s<0&&(s=0),r.halfHeight=s,yn.transformMat4(r.center,this.center,e),On.multiply(r.rotation,this.rotation,n),r.updateCache()},t.updateCache=function(){this.updateLocalCenter(),yn.transformQuat(this.ellipseCenter0,this.ellipseCenter0,this.rotation),yn.transformQuat(this.ellipseCenter1,this.ellipseCenter1,this.rotation),this.ellipseCenter0.add(this.center),this.ellipseCenter1.add(this.center)},t.updateLocalCenter=function(){var e=this.halfHeight;switch(this.axis){case 0:this.ellipseCenter0.set(e,0,0),this.ellipseCenter1.set(-e,0,0);break;case 1:this.ellipseCenter0.set(0,e,0),this.ellipseCenter1.set(0,-e,0);break;case 2:this.ellipseCenter0.set(0,0,e),this.ellipseCenter1.set(0,0,-e)}},h(e,[{key:"type",get:function(){return this._type}}]),e}(),js=new Array(8);js[0]=new yn(1,1,1),js[1]=new yn(-1,1,1),js[2]=new yn(-1,-1,1),js[3]=new yn(1,-1,1),js[4]=new yn(1,1,-1),js[5]=new yn(-1,1,-1),js[6]=new yn(-1,-1,-1),js[7]=new yn(1,-1,-1);var qs,Xs,Ys=new yn,Ks=new yn,Qs=new yn,Js=function(){function e(){this.planes=void 0,this.vertices=void 0,this._type=void 0,this._type=qo.SHAPE_FRUSTUM,this.planes=new Array(6);for(var e=0;e<6;++e)this.planes[e]=vs.create(0,0,0,0);this.vertices=new Array(8);for(var t=0;t<8;++t)this.vertices[t]=new yn}e.createFromAABB=function(e,t){var n=new yn,i=new yn;return yn.subtract(n,t.center,t.halfExtents),yn.add(i,t.center,t.halfExtents),e.vertices[0].set(n.x,i.y,n.z),e.vertices[1].set(i.x,i.y,n.z),e.vertices[2].set(i.x,n.y,n.z),e.vertices[3].set(n.x,n.y,n.z),e.vertices[4].set(n.x,i.y,i.z),e.vertices[5].set(i.x,i.y,i.z),e.vertices[6].set(i.x,n.y,i.z),e.vertices[7].set(n.x,n.y,i.z),e._type!==qo.SHAPE_FRUSTUM_ACCURATE||e.updatePlanes(),e},e.split=function(e,t,n,i,r){var o=Math.tan(.5*t.fov),a=o*t.aspect;Ys.set(i*a,i*o,i),Ks.set(r*a,r*o,r);var s=e.vertices;return Qs.set(Ys.x,Ys.y,Ys.z),yn.transformMat4(s[0],Qs,n),Qs.set(-Ys.x,Ys.y,Ys.z),yn.transformMat4(s[1],Qs,n),Qs.set(-Ys.x,-Ys.y,Ys.z),yn.transformMat4(s[2],Qs,n),Qs.set(Ys.x,-Ys.y,Ys.z),yn.transformMat4(s[3],Qs,n),Qs.set(Ks.x,Ks.y,Ks.z),yn.transformMat4(s[4],Qs,n),Qs.set(-Ks.x,Ks.y,Ks.z),yn.transformMat4(s[5],Qs,n),Qs.set(-Ks.x,-Ks.y,Ks.z),yn.transformMat4(s[6],Qs,n),Qs.set(Ks.x,-Ks.y,Ks.z),yn.transformMat4(s[7],Qs,n),e.updatePlanes(),e},e.create=function(){return new e},e.clone=function(t){return e.copy(new e,t)},e.copy=function(e,t){e._type=t._type;for(var n=0;n<6;++n)vs.copy(e.planes[n],t.planes[n]);for(var i=0;i<8;++i)yn.copy(e.vertices[i],t.vertices[i]);return e};var t=e.prototype;return t.update=function(e,t){if(yn.set(this.planes[0].n,e.m03+e.m00,e.m07+e.m04,e.m11+e.m08),this.planes[0].d=-(e.m15+e.m12),yn.set(this.planes[1].n,e.m03-e.m00,e.m07-e.m04,e.m11-e.m08),this.planes[1].d=-(e.m15-e.m12),yn.set(this.planes[2].n,e.m03+e.m01,e.m07+e.m05,e.m11+e.m09),this.planes[2].d=-(e.m15+e.m13),yn.set(this.planes[3].n,e.m03-e.m01,e.m07-e.m05,e.m11-e.m09),this.planes[3].d=-(e.m15-e.m13),yn.set(this.planes[4].n,e.m03+e.m02,e.m07+e.m06,e.m11+e.m10),this.planes[4].d=-(e.m15+e.m14),yn.set(this.planes[5].n,e.m03-e.m02,e.m07-e.m06,e.m11-e.m10),this.planes[5].d=-(e.m15-e.m14),this._type===qo.SHAPE_FRUSTUM_ACCURATE){for(var n=0;n<6;n++){var i=this.planes[n],r=1/i.n.length();yn.multiplyScalar(i.n,i.n,r),i.d*=r}for(var o=0;o<8;o++)yn.transformMat4(this.vertices[o],js[o],t)}},t.transform=function(e){if(this._type===qo.SHAPE_FRUSTUM_ACCURATE){for(var t=0;t<8;t++)yn.transformMat4(this.vertices[t],this.vertices[t],e);this.updatePlanes()}},t.updatePlanes=function(){vs.fromPoints(this.planes[0],this.vertices[1],this.vertices[6],this.vertices[5]),vs.fromPoints(this.planes[1],this.vertices[3],this.vertices[4],this.vertices[7]),vs.fromPoints(this.planes[2],this.vertices[6],this.vertices[3],this.vertices[7]),vs.fromPoints(this.planes[3],this.vertices[0],this.vertices[5],this.vertices[4]),vs.fromPoints(this.planes[4],this.vertices[2],this.vertices[0],this.vertices[3]),vs.fromPoints(this.planes[5],this.vertices[7],this.vertices[5],this.vertices[6])},h(e,[{key:"accurate",set:function(e){this._type=e?qo.SHAPE_FRUSTUM_ACCURATE:qo.SHAPE_FRUSTUM}},{key:"type",get:function(){return this._type}}]),e}();Js.createOrtho=function(e,t,n,i,r,o){var a=t/2,s=n/2;yn.set(Qs,a,s,-i),yn.transformMat4(e.vertices[0],Qs,o),yn.set(Qs,-a,s,-i),yn.transformMat4(e.vertices[1],Qs,o),yn.set(Qs,-a,-s,-i),yn.transformMat4(e.vertices[2],Qs,o),yn.set(Qs,a,-s,-i),yn.transformMat4(e.vertices[3],Qs,o),yn.set(Qs,a,s,-r),yn.transformMat4(e.vertices[4],Qs,o),yn.set(Qs,-a,s,-r),yn.transformMat4(e.vertices[5],Qs,o),yn.set(Qs,-a,-s,-r),yn.transformMat4(e.vertices[6],Qs,o),yn.set(Qs,a,-s,-r),yn.transformMat4(e.vertices[7],Qs,o),vs.fromPoints(e.planes[0],e.vertices[1],e.vertices[6],e.vertices[5]),vs.fromPoints(e.planes[1],e.vertices[3],e.vertices[4],e.vertices[7]),vs.fromPoints(e.planes[2],e.vertices[6],e.vertices[3],e.vertices[7]),vs.fromPoints(e.planes[3],e.vertices[0],e.vertices[5],e.vertices[4]),vs.fromPoints(e.planes[4],e.vertices[2],e.vertices[0],e.vertices[3]),vs.fromPoints(e.planes[5],e.vertices[7],e.vertices[5],e.vertices[6])},function(e){e[e.Default=0]="Default",e[e.Normal=1]="Normal",e[e.Loop=2]="Loop",e[e.ShouldWrap=4]="ShouldWrap",e[e.Clamp=8]="Clamp",e[e.PingPong=22]="PingPong",e[e.Reverse=36]="Reverse"}(qs||(qs={})),function(e){e[e.Default=qs.Default]="Default",e[e.Normal=qs.Normal]="Normal",e[e.Reverse=qs.Reverse]="Reverse",e[e.Loop=qs.Loop]="Loop",e[e.LoopReverse=qs.Loop|qs.Reverse]="LoopReverse",e[e.PingPong=qs.PingPong]="PingPong",e[e.PingPongReverse=qs.PingPong|qs.Reverse]="PingPongReverse"}(Xs||(Xs={})),et(Xs);var Zs,$s=function(){function e(e){this.ratio=0,this.time=0,this.direction=1,this.stopped=!0,this.iterations=0,this.frameIndex=void 0,e&&this.set(e)}return e.prototype.set=function(e){this.ratio=e.ratio,this.time=e.time,this.direction=e.direction,this.stopped=e.stopped,this.iterations=e.iterations,this.frameIndex=e.frameIndex},e}();function ec(e,t,n){void 0===n&&(n=1e-6);for(var i=0,r=e.length-1,o=r>>>1;i<=r;o=i+r>>>1){var a=e[o];if(a>t+n)r=o-1;else{if(!(a<t-n))return o;i=o+1}}return~i}Zs=Symbol.iterator;var tc,nc,ic,rc=function(){function e(){this._times=[],this._values=[]}var t=e.prototype;return t[Zs]=function(){var e=this,t=0;return{next:function(){if(t>=e._times.length)return{done:!0,value:void 0};var n=[e._times[t],e._values[t]];return++t,{done:!1,value:n}}}},t.keyframes=function(){return this},t.times=function(){return this._times},t.values=function(){return this._values},t.getKeyframeTime=function(e){return this._times[e]},t.getKeyframeValue=function(e){return this._values[e]},t.addKeyFrame=function(e,t){return this._insertNewKeyframe(e,t)},t.removeKeyframe=function(e){this._times.splice(e,1),this._values.splice(e,1)},t.indexOfKeyframe=function(e){return ec(this._times,e)},t.updateTime=function(e,t){var n=this._values[e];this.removeKeyframe(e),this._insertNewKeyframe(t,n)},t.assignSorted=function(e,t){if(void 0!==t)this.setKeyframes(e.slice(),t.slice());else{var n=Array.from(e);this.setKeyframes(n.map((function(e){return e[0]})),n.map((function(e){return e[1]})))}},t.clear=function(){this._times.length=0,this._values.length=0},t.searchKeyframe=function(e){return ec(this._times,e)},t.setKeyframes=function(e,t){e.length,t.length,function(e){e.every((function(e,t,n){return 0===t||e>n[t-1]||$t(e,n[t-1],1e-6)}))}(e),this._times=e,this._values=t},t._insertNewKeyframe=function(e,t){var n=this._times,i=this._values,r=n.length,o=ec(n,e);if(o>=0)return o;var a=~o;return 0===a?(n.unshift(e),i.unshift(t)):a===r?(n.push(e),i.push(t)):(n.splice(a-1,0,e),i.splice(a-1,0,t)),a},h(e,[{key:"keyFramesCount",get:function(){return this._times.length}},{key:"rangeMin",get:function(){return this._times[0]}},{key:"rangeMax",get:function(){return this._times[this._values.length-1]}}]),e}();function oc(e){return e>-1e-9&&e<1e-9}jt.fastDefine("cc.KeyframeCurve",rc,{_times:[],_values:[]}),function(e){e[e.LINEAR=0]="LINEAR",e[e.CONSTANT=1]="CONSTANT",e[e.CUBIC=2]="CUBIC"}(tc||(tc=e("RealInterpolationMode",{}))),function(e){e[e.LINEAR=0]="LINEAR",e[e.CLAMP=1]="CLAMP",e[e.LOOP=2]="LOOP",e[e.PING_PONG=3]="PING_PONG"}(nc||(nc=e("ExtrapolationMode",{}))),function(e){e[e.NONE=0]="NONE",e[e.LEFT=1]="LEFT",e[e.RIGHT=2]="RIGHT",e[e.BOTH=3]="BOTH"}(ic||(ic=e("TangentWeightMode",{})));var ac=function(){},sc=function(){return ac},cc=lc((function(){}));function lc(e){return function(t){return"function"==typeof t?e(t):function(n){return e(n,t)}}}function uc(e){return function(t){return function(n){!function(e,t,n){var i=_c(e);if(i){var r=fc(i,"proto");fc(r,"editor")[t]=n}}(n,e,t)}}}var hc="__ccclassCache__";function _c(e){return fc(e,hc)}function fc(e,t){return e[t]||(e[t]={})}var dc=lc((function(e,t){var n=Ke.getSuper(e);n===Object&&(n=null);var i={name:t,extends:n,ctor:e},r=e[hc];if(r){var o=r.proto;o&&Ke.mixin(i,o),e[hc]=void 0}return jt(i)})),pc=uc("requireComponent"),mc=uc("executionOrder"),vc=cc;function gc(e,t,n){var i=null;function r(e,t,n){!function(e,t,n,i,r,o){var a,s=o&&(o.get||o.set);r&&(a=Mt(r,s));var c=Ke.mixin(t,a||r||{});s?(o.get&&(c.get=o.get),o.set&&(c.set=o.set)):xc(e,c,n,i,o)}(function(e){return _c(e.constructor)}(e),function(e,t){var n,i,r=fc(_c(e.constructor),"proto"),o=fc(r,"properties");return null!==(i=o[n=t])&&void 0!==i?i:o[n]={}}(e,t),e.constructor,t,i,n)}return void 0===e?gc({type:void 0}):void 0===t?(i=e,r):void r(e,t,n)}function yc(e,t,n){var i,r,o=_c(e.constructor),a=fc(o,"proto"),s=fc(a,"properties"),c=null!==(r=s[i=t])&&void 0!==r?r:s[i]={};return c.__internalFlags|=Lt.STANDALONE,n&&(n.get||n.set)?(n.get&&(c.get=n.get),n.set&&(c.set=n.set)):xc(o,c,e.constructor,t,n),c}function xc(e,t,n,i,r){if(r)r.initializer&&(t.default=function(e){var t;try{t=e()}catch(t){return e}return"object"!=typeof t||null===t?t:e}(r.initializer));else{var o=e.default||(e.default=function(e){var t;try{t=new e}catch(e){return{}}return t}(n));o.hasOwnProperty(i)&&(t.default=o[i])}}var Sc=Symbol("cc:SerializationMetadata"),Ec=function(e,t,n){bc(yc(e,t,n))};function Tc(e){return function(t,n,i){var r=yc(t,n,i);r.formerlySerializedAs=e,bc(r)}}var Cc=function(e,t,n){var i=yc(e,t,n);i.editorOnly=!0,bc(i)};function bc(e){e.__internalFlags|=Lt.IMPLICIT_SERIALIZABLE}var Ac=ac,wc=cc,Ic=sc,Pc=cc,Rc=sc,Dc=sc,Oc=sc,Nc=ac,Mc=sc,Lc=ac,Fc=sc,Bc=sc,zc=sc,Uc=sc,kc=sc,Gc=sc,Hc=ac,Vc=sc,Wc=ac,jc=ac,qc=ac,Xc=Jc(Ct),Yc=Jc(bt),Kc=Jc(At),Qc=Jc(wt);function Jc(e){return gc({type:e})}var Zc,$c=function(e,t,n){yc(e,t,n).override=!0},el=e("editorExtrasTag","__editorExtras__"),tl=function(){},nl=Object.freeze({__proto__:null,uniquelyReferenced:Ac,ccclass:dc,property:gc,requireComponent:pc,executionOrder:mc,disallowMultiple:vc,allowReplicated:function(e){jt.Attr.setClassAttr(e,"replicated","visible",!0)},executeInEditMode:wc,menu:Ic,playOnFocus:Pc,inspector:Rc,icon:Dc,help:Oc,type:Jc,integer:Xc,float:Yc,boolean:Kc,string:Qc});e("_decorator",nl);var il=1<<22,rl=[],ol=e("CCObject",function(){function e(e){void 0===e&&(e=""),this._objFlags=void 0,this._name=void 0,this._name=e,this._objFlags=0}e._deferredDestroy=function(){for(var e=rl.length,t=0;t<e;++t){var n=rl[t];1&n._objFlags||n._destroyImmediate()}e===rl.length?rl.length=0:rl.splice(0,e)};var t=e.prototype;return t.destroy=function(){return 1&this._objFlags?(q(5e3),!1):!(4&this._objFlags||(this._objFlags|=4,rl.push(this),0))},t._destruct=function(){var e=this.constructor,t=e.__destruct__;t||(t=function(e,t){var n,i=e instanceof b._BaseNode||e instanceof b.Component,r=i?"_id":null,o={};for(n in e)if(e.hasOwnProperty(n)){if(n===r)continue;switch(typeof e[n]){case"string":o[n]="";break;case"object":case"function":o[n]=null}}if(jt._isCCClass(t))for(var a=b.Class.Attr.getClassAttrs(t),s=t.__props__,c=0;c<s.length;c++){var l=(n=s[c])+b.Class.Attr.DELIMETER+"default";if(l in a){if(i&&"_id"===n)continue;switch(typeof a[l]){case"string":o[n]="";break;case"object":case"function":o[n]=null;break;case"undefined":o[n]=void 0}}}var u="";for(n in o){var h;h=jt.IDENTIFIER_RE.test(n)?"o."+n+"=":"o["+jt.escapeForJS(n)+"]=";var _=o[n];""===_&&(_='""'),u+=h+_+";\n"}return Function("o",u)}(this,e),me(e,"__destruct__",t,!0)),t(this)},t._destroyImmediate=function(){1&this._objFlags?Y(5e3):(this._onPreDestroy&&this._onPreDestroy(),this._destruct(),this._objFlags|=1)},h(e,[{key:"name",get:function(){return this._name},set:function(e){this._name=e}},{key:"hideFlags",get:function(){return this._objFlags&e.Flags.AllHideMasks},set:function(t){var n=t&e.Flags.AllHideMasks;this._objFlags=this._objFlags&~e.Flags.AllHideMasks|n}},{key:"replicated",get:function(){return!!(this._objFlags&il)},set:function(e){e?this._objFlags|=il:this._objFlags&=-4194305}},{key:"isValid",get:function(){return!(1&this._objFlags)}}]),e}()),al=ol.prototype;function sl(e,t){return"object"==typeof e?!(!e||e._objFlags&(t?5:1)):void 0!==e}al._deserialize=null,al._onPreDestroy=null,jt.fastDefine("cc.Object",ol,((Zc={_name:"",_objFlags:0})[el]={},Zc)),jt.Attr.setClassAttr(ol,el,"editorOnly",!0),jt.Attr.setClassAttr(ol,"replicated","visible",!1),me(ol,"Flags",{Destroyed:1,DontSave:8,EditorOnly:16,Dirty:32,DontDestroy:64,PersistentMask:-4192741,Destroying:128,Deactivating:256,LockedInEditor:512,HideInHierarchy:1024,AllHideMasks:1560,IsPreloadStarted:8192,IsOnLoadStarted:32768,IsOnLoadCalled:16384,IsOnEnableCalled:2048,IsStartCalled:65536,IsEditorOnEnableCalled:4096,IsPositionLocked:1<<21,IsRotationLocked:1<<17,IsScaleLocked:1<<18,IsAnchorLocked:1<<19,IsSizeLocked:1<<20}),b.isValid=sl,b.Object=ol;var cl=function(){function e(e){this._map=null,this._count=0,e?(this._map=e,this._count=Object.keys(e).length):(this._map=Ke.createMap(!0),this._count=0)}var t=e.prototype;return t.add=function(e,t){return e in this._map||this._count++,this._map[e]=t},t.get=function(e){return this._map[e]},t.has=function(e){return e in this._map},t.remove=function(e){var t=this._map[e];return e in this._map&&(delete this._map[e],this._count--),t},t.clear=function(){0!==this._count&&(this._map=Ke.createMap(!0),this._count=0)},t.forEach=function(e){for(var t in this._map)e(this._map[t],t)},t.find=function(e){for(var t in this._map)if(e(this._map[t],t))return this._map[t];return null},t.destroy=function(){this._map=null},h(e,[{key:"count",get:function(){return this._count}}]),e}(),ll=function(){function e(t,n){this.id=e._pipelineId++,this.name="",this.pipes=[],this.name=t;for(var i=0,r=n.length;i<r;i++)this.pipes.push(n[i])}var t=e.prototype;return t.insert=function(e,t){return t>this.pipes.length?(q(4921),this):(this.pipes.splice(t,0,e),this)},t.append=function(e){return this.pipes.push(e),this},t.remove=function(e){return this.pipes.splice(e,1),this},t.sync=function(e){var t=this.pipes;if(0===t.length)return null;e.isFinish=!1;for(var n=0,i=t.length;n<i;){var r=(0,t[n])(e);if(r)return e.isFinish=!0,r;++n!==i&&(e.input=e.output,e.output=null)}return e.isFinish=!0,e.output},t.async=function(e){0!==this.pipes.length&&(e.isFinish=!1,this._flow(0,e))},t._flow=function(e,t){var n=this;(0,this.pipes[e])(t,(function(i){i?(t.isFinish=!0,t.dispatch("complete",i)):++e<n.pipes.length?(t.input=t.output,t.output=null,n._flow(e,t)):(t.isFinish=!0,t.dispatch("complete",i,t.output))}))},e}();ll._pipelineId=0,function(){function e(e){if(this._weakMap={},void 0===window.WeakRef)throw new Error("this platform does not support WeakRef!");if(e)for(var t in e)this._weakMap[t]=new WeakRef(e[t])}var t=e.prototype;t.add=function(e,t){return this._weakMap[e]=new WeakRef(t),t},t.has=function(e){return e in this._weakMap&&!!this._weakMap[e].deref()},t.get=function(e){return this._weakMap[e]&&this._weakMap[e].deref()},t.remove=function(e){var t=this._weakMap[e];return delete this._weakMap[e],t&&t.deref()},t.clear=function(){this._weakMap=Ke.createMap(!0)},t.forEach=function(e){for(var t in this._weakMap){var n=this.get(t);n&&e(n,t)}},t.find=function(e){for(var t in this._weakMap){var n=this.get(t);if(n&&e(n,t))return this._weakMap[t].deref()}return null},t.destroy=function(){this._weakMap={}},h(e,[{key:"count",get:function(){return Object.values(this._weakMap).filter((function(e){return e.deref()})).length}}])}();var ul,hl=new cl,_l=new cl,fl=new cl,dl=new cl,pl=new ll("normal load",[]),ml=new ll("fetch",[]),vl=new ll("transform url",[]);!function(e){e.UUID="uuid",e.PATH="path",e.DIR="dir",e.URL="url",e.SCENE="scene"}(ul||(ul={}));var gl,yl={default:{priority:0},preload:{maxConcurrency:6,maxRequestsPerFrame:2,priority:-1},scene:{maxConcurrency:20,maxRequestsPerFrame:20,priority:1},bundle:{maxConcurrency:20,maxRequestsPerFrame:20,priority:2},remote:{maxRetryCount:4}};!function(e){e.RESOURCES="resources",e.MAIN="main",e.START_SCENE="start-scene"}(gl||(gl={}));var xl=function(){function e(t){this.id=e._taskId++,this.onComplete=null,this.onProgress=null,this.onError=null,this.source=null,this.output=null,this.input=null,this.progress=null,this.options=null,this.isFinish=!0,this.set(t)}e.create=function(t){var n;return 0!==e._deadPool.length?(n=e._deadPool.pop()).set(t):n=new e(t),n};var t=e.prototype;return t.set=function(e){void 0===e&&(e=Object.create(null)),this.onComplete=e.onComplete||null,this.onProgress=e.onProgress||null,this.onError=e.onError||null,this.source=this.input=e.input,this.output=null,this.progress=e.progress,this.options=e.options||Object.create(null)},t.dispatch=function(e,t,n,i,r){switch(e){case"complete":this.onComplete&&this.onComplete(t,n);break;case"progress":this.onProgress&&this.onProgress(t,n,i,r);break;case"error":this.onError&&this.onError(t,n,i,r);break;default:var o="on"+e[0].toUpperCase()+e.substr(1);"function"==typeof this[o]&&this[o](t,n,i,r)}},t.recycle=function(){e._deadPool.length!==e.MAX_DEAD_NUM&&(this.onComplete=null,this.onProgress=null,this.onError=null,this.source=this.output=this.input=null,this.progress=null,this.options=null,e._deadPool.push(this))},e}();xl.MAX_DEAD_NUM=500,xl._taskId=0,xl._deadPool=[];var Sl="0123456789abcdef".split(""),El=["","","",""],Tl=El.concat(El,"-",El,"-",El,"-",El,"-",El,El,El),Cl=Tl.map((function(e,t){return"-"===e?NaN:t})).filter(isFinite);function bl(e){var t=e.split("@")[0];if(22!==t.length)return e;Tl[0]=e[0],Tl[1]=e[1];for(var n=2,i=2;n<22;n+=2){var r=st[e.charCodeAt(n)],o=st[e.charCodeAt(n+1)];Tl[Cl[i++]]=Sl[r>>2],Tl[Cl[i++]]=Sl[(3&r)<<2|o>>4],Tl[Cl[i++]]=Sl[15&o]}return e.replace(t,Tl.join(""))}var Al=/.*[/\\][0-9a-fA-F]{2}[/\\]([0-9a-fA-F-@]{8,}).*/;function wl(e,t){(t=t||Object.create(null)).__isNative__=t.isNative,t.nativeExt&&(t.ext=t.nativeExt);var n=dl.find((function(t){return!!t.getAssetInfo(e)}));return n&&(t.bundle=n.name),Rl(e,t)}function Il(e){return!!e&&(e instanceof b.SceneAsset||e instanceof b.Scene)}function Pl(e){return e&&(46===e.charCodeAt(0)&&47===e.charCodeAt(1)?e=e.slice(2):47===e.charCodeAt(0)&&(e=e.slice(1))),e}function Rl(e,t){var n=xl.create({input:e,options:t}),i=[];try{for(var r,o=S(vl.sync(n));!(r=o()).done;){var a=r.value,s=a.url;a.recycle(),i.push(s)}}catch(e){for(var c,l=S(n.output);!(c=l()).done;)c.value.recycle();B(e.message,e.stack)}return n.recycle(),i.length>1?i:i[0]}var Dl=Object.freeze({__proto__:null,getUuidFromURL:function(e){var t=Al.exec(e);return t?t[1]:""},getUrlWithUuid:wl,isScene:Il,normalize:Pl,transform:Rl,decodeUuid:bl}),Ol=new(function(){function e(){this._pools=[],this._lastShrinkPassed=0,this.shrinkTimeSpan=5}var t=e.prototype;return t.addContainer=function(e){-1===e._poolHandle&&(e._poolHandle=this._pools.length,this._pools.push(e))},t.removeContainer=function(e){-1!==e._poolHandle&&(this._pools[this._pools.length-1]._poolHandle=e._poolHandle,re(this._pools,e._poolHandle),e._poolHandle=-1)},t.tryShrink=function(){for(var e=0;e<this._pools.length;e++)this._pools[e].tryShrink()},t.update=function(e){this._lastShrinkPassed+=e,this._lastShrinkPassed>this.shrinkTimeSpan&&(this.tryShrink(),this._lastShrinkPassed-=this.shrinkTimeSpan)},e}()),Nl=function(){function e(){this._poolHandle=-1,Ol.addContainer(this)}return e.prototype.destroy=function(){Ol.removeContainer(this)},e}(),Ml=e("Pool",function(e){function t(t,n,i){var r;(r=e.call(this)||this)._ctor=void 0,r._elementsPerBatch=void 0,r._nextAvail=void 0,r._freepool=[],r._dtor=void 0,r._ctor=t,r._dtor=i||null,r._elementsPerBatch=Math.max(n,1),r._nextAvail=r._elementsPerBatch-1;for(var o=0;o<r._elementsPerBatch;++o)r._freepool.push(t());return r}f(t,e);var n=t.prototype;return n.alloc=function(){if(this._nextAvail<0){this._freepool.length=this._elementsPerBatch;for(var e=0;e<this._elementsPerBatch;e++)this._freepool[e]=this._ctor();this._nextAvail=this._elementsPerBatch-1}return this._freepool[this._nextAvail--]},n.free=function(e){this._freepool[++this._nextAvail]=e},n.freeArray=function(e){this._freepool.length=this._nextAvail+1,Array.prototype.push.apply(this._freepool,e),this._nextAvail+=e.length},n.tryShrink=function(){if(this._nextAvail>>1>this._elementsPerBatch){if(this._dtor)for(var e=this._nextAvail>>1;e<=this._nextAvail;e++)this._dtor(this._freepool[e]);this._freepool.length=this._nextAvail>>1,this._nextAvail=this._freepool.length-1}},n.destroy=function(){var t=arguments.length>0?arguments[0]:null;t&&q(14100);var n=t||this._dtor;if(n)for(var i=0;i<=this._nextAvail;i++)n(this._freepool[i]);this._freepool.length=0,this._nextAvail=-1,e.prototype.destroy.call(this)},t}(Nl)),Ll=e("RecyclePool",function(e){function t(t,n,i){var r;(r=e.call(this)||this)._fn=void 0,r._dtor=null,r._count=0,r._data=void 0,r._initSize=0,r._fn=t,r._dtor=i||null,r._data=new Array(n),r._initSize=n;for(var o=0;o<n;++o)r._data[o]=t();return r}f(t,e);var n=t.prototype;return n.reset=function(){this._count=0},n.resize=function(e){if(e>this._data.length)for(var t=this._data.length;t<e;++t)this._data[t]=this._fn()},n.add=function(){return this._count>=this._data.length&&this.resize(this._data.length<<1),this._data[this._count++]},n.destroy=function(){if(this._dtor)for(var t=0;t<this._data.length;t++)this._dtor(this._data[t]);this._data.length=0,this._count=0,e.prototype.destroy.call(this)},n.tryShrink=function(){if(this._data.length>>2>this._count){var e=Math.max(this._initSize,this._data.length>>1);if(this._dtor)for(var t=e;t<this._data.length;t++)this._dtor(this._data[t]);this._data.length=e}},n.removeAt=function(e){if(!(e>=this._count)){var t=this._count-1,n=this._data[e];this._data[e]=this._data[t],this._data[t]=n,this._count-=1}},h(t,[{key:"length",get:function(){return this._count}},{key:"data",get:function(){return this._data}}]),t}(Nl)),Fl=e("CachedArray",function(e){function t(t,n){var i;return(i=e.call(this)||this).array=void 0,i.length=0,i._compareFn=void 0,i._initSize=0,i.array=new Array(t),i._initSize=t,i.length=0,i._compareFn=n,i}f(t,e);var n=t.prototype;return n.push=function(e){this.array[this.length++]=e},n.pop=function(){return this.array[--this.length]},n.get=function(e){return this.array[e]},n.clear=function(){this.length=0},n.destroy=function(){this.length=0,this.array.length=0,e.prototype.destroy.call(this)},n.tryShrink=function(){this.array.length>>2>this.length&&(this.array.length=Math.max(this._initSize,this.array.length>>1))},n.sort=function(){this.array.length=this.length,this.array.sort(this._compareFn)},n.concat=function(e){for(var t=0;t<e.length;++t)this.array[this.length++]=e[t]},n.fastRemove=function(e){if(!(e>=this.length||e<0)){var t=--this.length;this.array[e]=this.array[t]}},n.indexOf=function(e){for(var t=0,n=this.length;t<n;++t)if(this.array[t]===e)return t;return-1},t}(Nl));e("memop",Object.freeze({__proto__:null,Pool:Ml,RecyclePool:Ll,CachedArray:Fl}));var Bl=Ye.fastRemoveAt;function zl(){}var Ul=function(){function e(){this.callback=zl,this.target=void 0,this.once=!1}var t=e.prototype;return t.set=function(e,t,n){this.callback=e||zl,this.target=t,this.once=!!n},t.reset=function(){this.target=void 0,this.callback=zl,this.once=!1},t.check=function(){return!(this.target instanceof ol&&!sl(this.target,!0))},e}(),kl=new Ml((function(){return new Ul}),32),Gl=function(){function e(){this.callbackInfos=[],this.isInvoking=!1,this.containCanceled=!1}var t=e.prototype;return t.removeByCallback=function(e){for(var t=0;t<this.callbackInfos.length;++t){var n=this.callbackInfos[t];n&&n.callback===e&&(n.reset(),kl.free(n),Bl(this.callbackInfos,t),--t)}},t.removeByTarget=function(e){for(var t=0;t<this.callbackInfos.length;++t){var n=this.callbackInfos[t];n&&n.target===e&&(n.reset(),kl.free(n),Bl(this.callbackInfos,t),--t)}},t.cancel=function(e){var t=this.callbackInfos[e];t&&(t.reset(),this.isInvoking?this.callbackInfos[e]=null:Bl(this.callbackInfos,e),kl.free(t)),this.containCanceled=!0},t.cancelAll=function(){for(var e=0;e<this.callbackInfos.length;e++){var t=this.callbackInfos[e];t&&(t.reset(),kl.free(t),this.callbackInfos[e]=null)}this.containCanceled=!0},t.purgeCanceled=function(){for(var e=this.callbackInfos.length-1;e>=0;--e)this.callbackInfos[e]||Bl(this.callbackInfos,e);this.containCanceled=!1},t.clear=function(){this.cancelAll(),this.callbackInfos.length=0,this.isInvoking=!1,this.containCanceled=!1},e}(),Hl=new Ml((function(){return new Gl}),16),Vl=function(){function e(){this._callbackTable=xe(!0),this._offCallback=void 0}var t=e.prototype;return t.on=function(e,t,n,i){if(!this.hasEventListener(e,t,n)){var r=this._callbackTable[e];r||(r=this._callbackTable[e]=Hl.alloc());var o=kl.alloc();o.set(t,n,i),r.callbackInfos.push(o)}return t},t.hasEventListener=function(e,t,n){var i=this._callbackTable&&this._callbackTable[e];if(!i)return!1;var r=i.callbackInfos;if(!t){if(i.isInvoking){for(var o=0;o<r.length;++o)if(r[o])return!0;return!1}return r.length>0}for(var a=0;a<r.length;++a){var s=r[a];if(s&&s.check()&&s.callback===t&&s.target===n)return!0}return!1},t.removeAll=function(e){var t=typeof e;if("string"===t||"number"===t){var n=this._callbackTable&&this._callbackTable[e];n&&(n.isInvoking?n.cancelAll():(n.clear(),Hl.free(n),delete this._callbackTable[e]))}else if(e)for(var i in this._callbackTable){var r=this._callbackTable[i];if(r.isInvoking)for(var o=r.callbackInfos,a=0;a<o.length;++a){var s=o[a];s&&s.target===e&&r.cancel(a)}else r.removeByTarget(e)}},t.off=function(e,t,n){var i,r=this._callbackTable&&this._callbackTable[e];if(r){var o=r.callbackInfos;if(t)for(var a=0;a<o.length;++a){var s=o[a];if(s&&s.callback===t&&s.target===n){r.cancel(a);break}}else this.removeAll(e)}null===(i=this._offCallback)||void 0===i||i.call(this)},t.emit=function(e,t,n,i,r,o){var a=this._callbackTable&&this._callbackTable[e];if(a){var s=!a.isInvoking;a.isInvoking=!0;for(var c=a.callbackInfos,l=0,u=c.length;l<u;++l){var h=c[l];if(h){var _=h.callback,f=h.target;h.once&&this.off(e,_,f),h.check()?f?_.call(f,t,n,i,r,o):_(t,n,i,r,o):this.off(e,_,f)}}s&&(a.isInvoking=!1,a.containCanceled&&a.purgeCanceled())}},t.clear=function(){for(var e in this._callbackTable){var t=this._callbackTable[e];t&&(t.clear(),Hl.free(t),delete this._callbackTable[e])}},t._registerOffCallback=function(e){this._offCallback=e},e}();function Wl(e){for(var t=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._callbackTable=xe(!0),t}f(t,e);var n=t.prototype;return n.once=function(e,t,n){return this.on(e,t,n,!0)},n.targetOff=function(e){this.removeAll(e)},t}(e),n=Vl.prototype,i=Object.getOwnPropertyNames(n).concat(Object.getOwnPropertySymbols(n)),r=0;r<i.length;++r){var o=i[r];if(!(o in t.prototype)){var a=Object.getOwnPropertyDescriptor(n,o);a&&Object.defineProperty(t.prototype,o,a)}}return t}var jl,ql,Xl,Yl,Kl,Ql,Jl=e("EventTarget",Wl((function(){})));b.EventTarget=Jl,function(e){e.UNKNOWN="unknown",e.WECHAT="wechat",e.ANDROID="androidbrowser",e.IE="ie",e.EDGE="edge",e.QQ="qqbrowser",e.MOBILE_QQ="mqqbrowser",e.UC="ucbrowser",e.UCBS="ucbs",e.BROWSER_360="360browser",e.BAIDU_APP="baiduboxapp",e.BAIDU="baidubrowser",e.MAXTHON="maxthon",e.OPERA="opera",e.OUPENG="oupeng",e.MIUI="miuibrowser",e.FIREFOX="firefox",e.SAFARI="safari",e.CHROME="chrome",e.LIEBAO="liebao",e.QZONE="qzone",e.SOUGOU="sogou",e.HUAWEI="huawei"}(jl||(jl={})),function(e){e.UNKNOWN="unknown",e.ENGLISH="en",e.CHINESE="zh",e.FRENCH="fr",e.ITALIAN="it",e.GERMAN="de",e.SPANISH="es",e.DUTCH="du",e.RUSSIAN="ru",e.KOREAN="ko",e.JAPANESE="ja",e.HUNGARIAN="hu",e.PORTUGUESE="pt",e.ARABIC="ar",e.NORWEGIAN="no",e.POLISH="pl",e.TURKISH="tr",e.UKRAINIAN="uk",e.ROMANIAN="ro",e.BULGARIAN="bg"}(ql||(ql={})),function(e){e[e.NONE=0]="NONE",e[e.LAN=1]="LAN",e[e.WWAN=2]="WWAN"}(Xl||(Xl={})),function(e){e.UNKNOWN="Unknown",e.IOS="iOS",e.ANDROID="Android",e.WINDOWS="Windows",e.LINUX="Linux",e.OSX="OS X",e.OHOS="OHOS"}(Yl||(Yl={})),function(e){e.UNKNOWN="UNKNOWN",e.EDITOR_PAGE="EDITOR_PAGE",e.EDITOR_CORE="EDITOR_CORE",e.MOBILE_BROWSER="MOBILE_BROWSER",e.DESKTOP_BROWSER="DESKTOP_BROWSER",e.WIN32="WIN32",e.ANDROID="ANDROID",e.IOS="IOS",e.MACOS="MACOS",e.OHOS="OHOS",e.WECHAT_GAME="WECHAT_GAME",e.BAIDU_MINI_GAME="BAIDU_MINI_GAME",e.XIAOMI_QUICK_GAME="XIAOMI_QUICK_GAME",e.ALIPAY_MINI_GAME="ALIPAY_MINI_GAME",e.BYTEDANCE_MINI_GAME="BYTEDANCE_MINI_GAME",e.OPPO_MINI_GAME="OPPO_MINI_GAME",e.VIVO_MINI_GAME="VIVO_MINI_GAME",e.HUAWEI_QUICK_GAME="HUAWEI_QUICK_GAME",e.COCOSPLAY="COCOSPLAY",e.LINKSURE_MINI_GAME="LINKSURE_MINI_GAME",e.QTT_MINI_GAME="QTT_MINI_GAME"}(Kl||(Kl={})),function(e){e.WEBP="WEBP",e.IMAGE_BITMAP="IMAGE_BITMAP",e.WEB_VIEW="WEB_VIEW",e.VIDEO_PLAYER="VIDEO_PLAYER",e.SAFE_AREA="SAFE_AREA",e.INPUT_TOUCH="INPUT_TOUCH",e.EVENT_KEYBOARD="EVENT_KEYBOARD",e.EVENT_MOUSE="EVENT_MOUSE",e.EVENT_TOUCH="EVENT_TOUCH",e.EVENT_ACCELEROMETER="EVENT_ACCELEROMETER"}(Ql||(Ql={}));var Zl,$l,eu,tu,nu=new(function(e){function t(){var t,n,i;(i=e.call(this)||this).networkType=void 0,i.isNative=void 0,i.isBrowser=void 0,i.isMobile=void 0,i.isLittleEndian=void 0,i.platform=void 0,i.language=void 0,i.nativeLanguage=void 0,i.os=void 0,i.osVersion=void 0,i.osMainVersion=void 0,i.browserType=void 0,i.browserVersion=void 0,i._battery=void 0,i._featureMap=void 0;var r,o=window.navigator,a=o.userAgent.toLowerCase();null===(t=o.getBattery)||void 0===t||t.call(o).then((function(e){i._battery=e})),i.networkType=Xl.LAN,i.isNative=!1,i.isBrowser=!0,i.isMobile=/mobile|android|iphone|ipad/.test(a),i.platform=i.isMobile?Kl.MOBILE_BROWSER:Kl.DESKTOP_BROWSER,i.isLittleEndian=(r=new ArrayBuffer(2),new DataView(r).setInt16(0,256,!0),256===new Int16Array(r)[0]);var s=o.language;i.nativeLanguage=s.toLowerCase(),s=(s=s||o.browserLanguage)?s.split("-")[0]:ql.ENGLISH,i.language=s;var c=!1,l=!1,u="",h=0,_=/android\s*(\d+(?:\.\d+)*)/i.exec(a)||/android\s*(\d+(?:\.\d+)*)/i.exec(o.platform);_&&(c=!0,u=_[1]||"",h=parseInt(u)||0),(_=/(iPad|iPhone|iPod).*OS ((\d+_?){2,3})/i.exec(a))?(l=!0,u=_[2]||"",h=parseInt(u)||0):(/(iPhone|iPad|iPod)/.exec(o.platform)||"MacIntel"===o.platform&&o.maxTouchPoints&&o.maxTouchPoints>1)&&(l=!0,u="",h=0);var f=Yl.UNKNOWN;-1!==o.appVersion.indexOf("Win")?f=Yl.WINDOWS:l?f=Yl.IOS:-1!==o.appVersion.indexOf("Mac")?f=Yl.OSX:-1!==o.appVersion.indexOf("X11")&&-1===o.appVersion.indexOf("Linux")?f=Yl.LINUX:c?f=Yl.ANDROID:-1===o.appVersion.indexOf("Linux")&&-1===a.indexOf("ubuntu")||(f=Yl.LINUX),i.os=f,i.osVersion=u,i.osMainVersion=h,i.browserType=jl.UNKNOWN;var d=/wechat|weixin|micromessenger/i.exec(a)||/mqqbrowser|micromessenger|qqbrowser|sogou|qzone|liebao|maxthon|ucbs|360 aphone|360browser|baiduboxapp|baidubrowser|maxthon|mxbrowser|miuibrowser/i.exec(a)||/qq|qqbrowser|ucbrowser|ubrowser|edge|HuaweiBrowser/i.exec(a)||/chrome|safari|firefox|trident|opera|opr\/|oupeng/i.exec(a),p=d?d[0].toLowerCase():Yl.UNKNOWN;("safari"===p&&c||"qq"===p&&/android.*applewebkit/i.test(a))&&(p=jl.ANDROID);var m={micromessenger:jl.WECHAT,wechat:jl.WECHAT,weixin:jl.WECHAT,trident:jl.IE,edge:jl.EDGE,"360 aphone":jl.BROWSER_360,mxbrowser:jl.MAXTHON,"opr/":jl.OPERA,ubrowser:jl.UC,huaweibrowser:jl.HUAWEI};i.browserType=m[p]||p,i.browserVersion="";var v=/(mqqbrowser|micromessenger|qqbrowser|sogou|qzone|liebao|maxthon|uc|ucbs|360 aphone|360|baiduboxapp|baidu|maxthon|mxbrowser|miui(?:.hybrid)?)(mobile)?(browser)?\/?([\d.]+)/i.exec(a);v||(v=/(qq|chrome|safari|firefox|trident|opera|opr\/|oupeng)(mobile)?(browser)?\/?([\d.]+)/i.exec(a)),i.browserVersion=v?v[4]:"";var g,y=document.createElement("canvas");y.getContext("2d");try{g=y.toDataURL("image/webp").startsWith("data:image/webp")}catch(e){g=!1}var x=!1;"undefined"!=typeof createImageBitmap&&"undefined"!=typeof Blob&&(y.width=y.height=2,createImageBitmap(y,{}).then((function(e){x=!0,null==e||e.close()})).catch((function(){})));var S=void 0!==document.documentElement.ontouchstart||void 0!==document.ontouchstart,E=void 0!==document.documentElement.onmouseup;return i._featureMap=((n={})[Ql.WEBP]=g,n[Ql.IMAGE_BITMAP]=x,n[Ql.WEB_VIEW]=!0,n[Ql.VIDEO_PLAYER]=!0,n[Ql.SAFE_AREA]=!1,n[Ql.INPUT_TOUCH]=S,n[Ql.EVENT_KEYBOARD]=void 0!==document.documentElement.onkeyup,n[Ql.EVENT_MOUSE]=E,n[Ql.EVENT_TOUCH]=S||E,n[Ql.EVENT_ACCELEROMETER]=void 0!==window.DeviceMotionEvent||void 0!==window.DeviceOrientationEvent,n),i._registerEvent(),i}f(t,e);var n=t.prototype;return n._registerEvent=function(){var e,t=this;e=void 0!==document.hidden?"hidden":void 0!==document.mozHidden?"mozHidden":void 0!==document.msHidden?"msHidden":void 0!==document.webkitHidden?"webkitHidden":"hidden";var n=!1,i=function(){n||(n=!0,t.emit("hide"))},r=function(e,i,r,o,a){n&&(n=!1,t.emit("show",e,i,r,o,a))};if(e)for(var o=["visibilitychange","mozvisibilitychange","msvisibilitychange","webkitvisibilitychange","qbrowserVisibilityChange"],a=0;a<o.length;a++)document.addEventListener(o[a],(function(t){var n=document[e];(n=n||t.hidden)?i():r()}));else window.addEventListener("blur",i),window.addEventListener("focus",r);window.navigator.userAgent.indexOf("MicroMessenger")>-1&&(window.onfocus=r),"onpageshow"in window&&"onpagehide"in window&&(window.addEventListener("pagehide",i),window.addEventListener("pageshow",r),document.addEventListener("pagehide",i),document.addEventListener("pageshow",r))},n.hasFeature=function(e){return this._featureMap[e]},n.getBatteryLevel=function(){return this._battery?this._battery.level:1},n.triggerGC=function(){},n.openURL=function(e){window.open(e)},n.now=function(){return Date.now?Date.now():+new Date},n.restartJSVM=function(){},n.close=function(){this.emit("close"),window.close()},t}(Jl)),iu=/(\.[^\.\/\?\\]*)(\?.*)?$/,ru=/((.*)(\/|\\|\\\\))?(.*?\..*$)?/,ou=/[^\.\/]+\/\.\.\//;function au(){for(var e="",t=arguments.length,n=new Array(t),i=0;i<t;i++)n[i]=arguments[i];for(var r=0,o=n;r<o.length;r++){var a=o[r];e=(e+(""===e?"":"/")+a).replace(/(\/|\\\\)$/,"")}return e}function su(e){var t=iu.exec(e);return t?t[1]:""}function cu(e){if(e){var t=e.lastIndexOf(".");if(-1!==t)return e.substring(0,t)}return e}function lu(e,t){var n=e.indexOf("?");n>0&&(e=e.substring(0,n));var i=/(\/|\\)([^\/\\]+)$/g.exec(e.replace(/(\/|\\)$/,""));if(!i)return e;var r=i[2];return t&&e.substring(e.length-t.length).toLowerCase()===t.toLowerCase()?r.substring(0,r.length-t.length):r}function uu(e){var t=ru.exec(e);return t?t[2]:""}function hu(e,t){t=t||"";var n=e.indexOf("?"),i="";return n>0&&(i=e.substring(n),e=e.substring(0,n)),(n=e.lastIndexOf("."))<0?e+t+i:e.substring(0,n)+t+i}function _u(e,t,n){if(0===t.indexOf("."))return hu(e,t);var i=e.indexOf("?"),r="",o=n?su(e):"";return i>0&&(r=e.substring(i),e=e.substring(0,i)),i=(i=e.lastIndexOf("/"))<=0?0:i+1,e.substring(0,i)+t+o+r}function fu(e){var t=e=String(e);do{t=e,e=e.replace(ou,"")}while(t.length!==e.length);return e}function du(e){return e.replace(/[\/\\]$/,"")}function pu(){return nu.os===Yl.WINDOWS?"\\":"/"}e("path",Object.freeze({__proto__:null,join:au,extname:su,mainFileName:cu,basename:lu,dirname:uu,changeExtname:hu,changeBasename:_u,_normalize:fu,stripSep:du,getSeperator:pu}));var mu,vu,gu,yu=e("Asset",dc("cc.Asset")((tu=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).loaded=!0,E(t,"_native",eu,y(t)),t._nativeUrl="",t._file=null,t._ref=0,Object.defineProperty(y(t),"_uuid",{value:"",writable:!0}),t}f(t,e),t.deserialize=function(e){return b.deserialize(e)};var n=t.prototype;return n.toString=function(){return this.nativeUrl},n.serialize=function(){},n._setRawAsset=function(e,t){void 0===t&&(t=!0),this._native=!1!==t?e||"":"/"+e},n.addRef=function(){return this._ref++,this},n.decRef=function(e){return void 0===e&&(e=!0),this._ref>0&&this._ref--,e&&b.assetManager._releaseManager.tryRelease(this),this},n.onLoaded=function(){},n.initDefault=function(e){e&&(this._uuid=e),this.isDefault=!0},n.validate=function(){return!0},n.destroy=function(){return U(Z(12101,this._uuid)),e.prototype.destroy.call(this)},h(t,[{key:"nativeUrl",get:function(){if(!this._nativeUrl){if(!this._native)return"";var e=this._native;if(47===e.charCodeAt(0))return e.slice(1);46===e.charCodeAt(0)?this._nativeUrl=wl(this._uuid,{nativeExt:e,isNative:!0}):this._nativeUrl=wl(this._uuid,{__nativeName__:e,nativeExt:su(e),isNative:!0})}return this._nativeUrl}},{key:"_nativeAsset",get:function(){return this._file},set:function(e){this._file=e}},{key:"_nativeDep",get:function(){if(this._native)return{__isNative__:!0,uuid:this._uuid,ext:this._native}}},{key:"refCount",get:function(){return this._ref}}]),t}(Wl(ol)),eu=T(($l=tu).prototype,"_native",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),T($l.prototype,"_nativeAsset",[gc],Object.getOwnPropertyDescriptor($l.prototype,"_nativeAsset"),$l.prototype),Zl=$l))||Zl);yu.prototype.createNode=null,b.Asset=yu;var xu=e("Script",dc("cc.Script")(mu=function(e){function t(){return e.apply(this,arguments)||this}return f(t,e),t}(yu))||mu);b._Script=xu;var Su=e("JavaScript",dc("cc.JavaScript")(vu=function(e){function t(){return e.apply(this,arguments)||this}return f(t,e),t}(xu))||vu);b._JavaScript=Su;var Eu,Tu,Cu,bu,Au,wu,Iu,Pu,Ru,Du,Ou,Nu=e("TypeScript",dc("cc.TypeScript")(gu=function(e){function t(){return e.apply(this,arguments)||this}return f(t,e),t}(xu))||gu);b._TypeScript=Nu;var Mu,Lu,Fu,Bu,zu=new ce("Comp"),Uu=ol.Flags.IsOnLoadCalled,ku=e("Component",(Eu=dc("cc.Component"),Tu=Fc(),Cu=Jc(xu),bu=Bc(),Eu((Ou=Du=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return E(t=e.call.apply(e,[this].concat(i))||this,"node",Iu,y(t)),E(t,"_enabled",Pu,y(t)),E(t,"__prefab",Ru,y(t)),t._sceneGetter=null,t._id=zu.getNewId(),t}f(t,e);var n=t.prototype;return n._getRenderScene=function(){return this._sceneGetter?this._sceneGetter():this.node.scene.renderScene},n.addComponent=function(e){return this.node.addComponent(e)},n.getComponent=function(e){return this.node.getComponent(e)},n.getComponents=function(e){return this.node.getComponents(e)},n.getComponentInChildren=function(e){return this.node.getComponentInChildren(e)},n.getComponentsInChildren=function(e){return this.node.getComponentsInChildren(e)},n.destroy=function(){return!!e.prototype.destroy.call(this)&&(this._enabled&&this.node.activeInHierarchy&&b.director._compScheduler.disableComp(this),!0)},n._onPreDestroy=function(){this.unscheduleAllCallbacks(),b.director._nodeActivator.destroyComp(this),this.node._removeComponent(this)},n._instantiate=function(e){return e||(e=b.instantiate._clone(this,this)),e&&(e.node=null),e},n.schedule=function(e,t,n,i){void 0===t&&(t=0),void 0===n&&(n=b.macro.REPEAT_FOREVER),void 0===i&&(i=0),J(e,1619),J((t=t||0)>=0,1620),n=Number.isNaN(n)?b.macro.REPEAT_FOREVER:n,i=i||0;var r=b.director.getScheduler(),o=r.isTargetPaused(this);r.schedule(e,this,t,n,i,o)},n.scheduleOnce=function(e,t){void 0===t&&(t=0),this.schedule(e,0,0,t)},n.unschedule=function(e){e&&b.director.getScheduler().unschedule(e,this)},n.unscheduleAllCallbacks=function(){b.director.getScheduler().unscheduleAllForTarget(this)},h(t,[{key:"name",get:function(){if(this._name)return this._name;var e=Se(this),t=e.lastIndexOf(".");return t>=0&&(e=e.slice(t+1)),this.node?this.node.name+"<"+e+">":e},set:function(e){this._name=e}},{key:"uuid",get:function(){return this._id}},{key:"__scriptAsset",get:function(){return null}},{key:"enabled",get:function(){return this._enabled},set:function(e){if(this._enabled!==e&&(this._enabled=e,this.node.activeInHierarchy)){var t=b.director._compScheduler;e?t.enableComp(this):t.disableComp(this)}}},{key:"enabledInHierarchy",get:function(){return this._enabled&&this.node&&this.node.activeInHierarchy}},{key:"_isOnLoadCalled",get:function(){return this._objFlags&Uu}}]),t}(ol),Du.system=null,T((wu=Ou).prototype,"__scriptAsset",[Tu,Cu,bu,qc],Object.getOwnPropertyDescriptor(wu.prototype,"__scriptAsset"),wu.prototype),Iu=T(wu.prototype,"node",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Pu=T(wu.prototype,"_enabled",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Ru=T(wu.prototype,"__prefab",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Au=wu))||Au)),Gu=ku.prototype;Gu.update=null,Gu.lateUpdate=null,Gu.__preload=null,Gu.onLoad=null,Gu.start=null,Gu.onEnable=null,Gu.onDisable=null,Gu.onDestroy=null,Gu.onFocusInEditor=null,Gu.onLostFocusInEditor=null,Gu.resetInEditor=null,Gu._getLocalBounds=null,Gu.onRestore=null,ku._requireComponent=null,ku._executionOrder=0,me(ku,"_registerEditorProps",(function(e,t){var n=t.requireComponent;n&&(Array.isArray(n)&&(n=n.filter(Boolean)),e._requireComponent=n);var i=t.executionOrder;i&&"number"==typeof i&&(e._executionOrder=i)})),b.Component=ku;var Hu,Vu=e("MissingScript",dc("cc.MissingScript")(Mu=Rc()((Bu=function(e){function t(){var t;return E(t=e.call(this)||this,"_$erialized",Fu,y(t)),t}return f(t,e),t.safeFindClass=function(e){var t=We(e);if(t)return t;b.deserialize.reportMissingClass(e)},t.prototype.onLoad=function(){q(4600,this.node.name)},t}(ku),Fu=T((Lu=Bu).prototype,"_$erialized",[Ec,Cc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Mu=Lu))||Mu)||Mu);b._MissingScript=Vu;try{var Wu=Vu.__values__;0!==Wu.length&&"_$erialized"===Wu[Wu.length-1]||(B("The '_$erialized' prop in MissingScript is missing. Please contact jare."),B("    Error props: ['"+Wu+"']"))}catch(Go){B("Error when checking MissingScript 5, "+Go)}!function(e){e[e.PORTRAIT=1]="PORTRAIT",e[e.PORTRAIT_UPSIDE_DOWN=2]="PORTRAIT_UPSIDE_DOWN",e[e.LANDSCAPE_LEFT=4]="LANDSCAPE_LEFT",e[e.LANDSCAPE_RIGHT=8]="LANDSCAPE_RIGHT",e[e.LANDSCAPE=12]="LANDSCAPE",e[e.AUTO=13]="AUTO"}(Hu||(Hu={}));var ju,qu={auto:Hu.AUTO,landscape:Hu.LANDSCAPE,portrait:Hu.PORTRAIT};!function(e){e[e.Unknown=0]="Unknown",e[e.SubFrame=1]="SubFrame",e[e.BrowserWindow=2]="BrowserWindow",e[e.Fullscreen=3]="Fullscreen"}(ju||(ju={}));var Xu=new(function(e){function t(){var t,n,i,r,o,a;(t=e.call(this)||this).isFrameRotated=!1,t.handleResizeEvent=!0,t._gameFrame=void 0,t._gameContainer=void 0,t._gameCanvas=void 0,t._isProportionalToFrame=!1,t._cachedFrameStyle={width:"0px",height:"0px"},t._cachedContainerStyle={width:"0px",height:"0px"},t._cbToUpdateFrameBuffer=void 0,t._supportFullScreen=!1,t._touchEventName=void 0,t._onFullscreenChange=void 0,t._onFullscreenError=void 0,t._orientationChangeTimeoutId=-1,t._cachedFrameSize=new jn(0,0),t._exactFitScreen=!1,t._fn={},t._fnGroup=[["requestFullscreen","exitFullscreen","fullscreenchange","fullscreenEnabled","fullscreenElement","fullscreenerror"],["requestFullScreen","exitFullScreen","fullScreenchange","fullScreenEnabled","fullScreenElement","fullscreenerror"],["webkitRequestFullScreen","webkitCancelFullScreen","webkitfullscreenchange","webkitIsFullScreen","webkitCurrentFullScreenElement","webkitfullscreenerror"],["mozRequestFullScreen","mozCancelFullScreen","mozfullscreenchange","mozFullScreen","mozFullScreenElement","mozfullscreenerror"],["msRequestFullscreen","msExitFullscreen","MSFullscreenChange","msFullscreenEnabled","msFullscreenElement","msfullscreenerror"]],t._resolutionScale=1,t._orientation=Hu.AUTO,t._gameFrame=document.getElementById("GameDiv"),t._gameContainer=document.getElementById("Cocos3dGameContainer"),t._gameCanvas=document.getElementById("GameCanvas"),t._gameFrame||(t._gameFrame=document.createElement("div"),t._gameFrame.setAttribute("id","GameDiv"),null===(n=t._gameCanvas)||void 0===n||null===(i=n.parentNode)||void 0===i||i.insertBefore(t._gameFrame,t._gameCanvas),t._gameFrame.appendChild(t._gameCanvas)),t._gameContainer||(t._gameContainer=document.createElement("div"),t._gameContainer.setAttribute("id","Cocos3dGameContainer"),null===(r=t._gameCanvas)||void 0===r||null===(o=r.parentNode)||void 0===o||o.insertBefore(t._gameContainer,t._gameCanvas),t._gameContainer.appendChild(t._gameCanvas));for(var s=t._fnGroup,c=0;c<s.length;c++)if(a=s[c],void 0!==document[a[1]]){for(var l=0;l<a.length;l++)t._fn[s[0][l]]=a[l];break}return t._supportFullScreen=void 0!==t._fn.requestFullscreen,t._touchEventName="ontouchstart"in window?"touchend":"mousedown",t._registerEvent(),t}f(t,e);var n=t.prototype;return n.init=function(e,t){this._cbToUpdateFrameBuffer=t,this.orientation=qu[e.configOrientation],this._exactFitScreen=e.exactFitScreen,this._resizeFrame()},n.requestFullScreen=function(){var e=this;return new Promise((function(t,n){e.isFullScreen?t():(e._cachedFrameSize=e.windowSize,e._doRequestFullScreen().then((function(){t()})).catch((function(){var i=e._getFullscreenTarget();i?i.addEventListener(e._touchEventName,(function(){e._doRequestFullScreen().then((function(){t()})).catch(n)}),{once:!0,capture:!0}):n(new Error("Cannot access fullscreen target"))})))}))},n.exitFullScreen=function(){var e=this;return new Promise((function(t,n){var i=document[e._fn.exitFullscreen]();window.Promise&&i instanceof Promise?i.then((function(){e.windowSize=e._cachedFrameSize,t()})).catch(n):(e.windowSize=e._cachedFrameSize,t())}))},n._registerEvent=function(){var e=this;document.addEventListener(this._fn.fullscreenerror,(function(){var t;null===(t=e._onFullscreenError)||void 0===t||t.call(e)})),window.addEventListener("resize",(function(){e.handleResizeEvent&&e._resizeFrame()})),"function"==typeof window.matchMedia&&function t(){var n,i,r=window.devicePixelRatio;null===(n=window.matchMedia("(resolution: "+r+"dppx)"))||void 0===n||null===(i=n.addEventListener)||void 0===i||i.call(n,"change",(function(){e.emit("window-resize"),t()}),{once:!0})}(),window.addEventListener("orientationchange",(function(){-1!==e._orientationChangeTimeoutId&&clearTimeout(e._orientationChangeTimeoutId),e._orientationChangeTimeoutId=setTimeout((function(){e.handleResizeEvent&&(e._updateFrameState(),e._resizeFrame(),e.emit("orientation-change"),e._orientationChangeTimeoutId=-1)}),200)})),document.addEventListener(this._fn.fullscreenchange,(function(){var t;null===(t=e._onFullscreenChange)||void 0===t||t.call(e),e.emit("fullscreen-change")}))},n._convertToSizeInCssPixels=function(e){var t=e.clone(),n=this.devicePixelRatio;return t.width/=n,t.height/=n,t},n._resizeFrame=function(e){if(this._gameFrame){if(this._gameFrame.style.display="flex",this._gameFrame.style["justify-content"]="center",this._gameFrame.style["align-items"]="center",this._windowType===ju.SubFrame){if(!e)return void this._updateContainer();this._gameFrame.style.width=e.width+"px",this._gameFrame.style.height=e.height+"px"}else{var t=window.innerWidth,n=window.innerHeight;this.isFrameRotated?(this._gameFrame.style["-webkit-transform"]="rotate(90deg)",this._gameFrame.style.transform="rotate(90deg)",this._gameFrame.style["-webkit-transform-origin"]="0px 0px 0px",this._gameFrame.style.transformOrigin="0px 0px 0px",this._gameFrame.style.margin="0 0 0 "+t+"px",this._gameFrame.style.width=n+"px",this._gameFrame.style.height=t+"px"):(this._gameFrame.style["-webkit-transform"]="rotate(0deg)",this._gameFrame.style.transform="rotate(0deg)",this._gameFrame.style.margin="0px auto",this._gameFrame.style.width=t+"px",this._gameFrame.style.height=n+"px")}this._updateContainer()}},n._getFullscreenTarget=function(){var e=this._windowType;return e===ju.Fullscreen?document[this._fn.fullscreenElement]:e===ju.SubFrame?this._gameFrame:document.body},n._doRequestFullScreen=function(){var e=this;return new Promise((function(t,n){if(e._supportFullScreen){var i=e._getFullscreenTarget();if(i){e._onFullscreenChange=void 0,e._onFullscreenError=void 0;var r=i[e._fn.requestFullscreen]();window.Promise&&r instanceof Promise?r.then(t).catch(n):(e._onFullscreenChange=t,e._onFullscreenError=n)}else n(new Error("Cannot access fullscreen target"))}else n(new Error("fullscreen is not supported"))}))},n._updateFrameState=function(){var e=this.orientation,t=window.innerWidth>window.innerHeight;this.isFrameRotated=nu.isMobile&&(t&&e===Hu.PORTRAIT||!t&&e===Hu.LANDSCAPE)},n._updateContainer=function(){if(this._gameContainer){if(this.isProportionalToFrame){if(!this._gameFrame)return void q(9201);var e,t,n=b.view.getDesignResolutionSize(),i=this._gameFrame,r=i.clientWidth,o=i.clientHeight,a=n.width,s=n.height,c=r/a,l=o/s,u=this._gameContainer.style;c<l?(e=r,t=s*c):(e=a*l,t=o),u.width=e+"px",u.height=t+"px"}else{var h=this._gameContainer.style;h.width="100%",h.height="100%"}!this._gameFrame||this._cachedFrameStyle.width===this._gameFrame.style.width&&this._cachedFrameStyle.height===this._gameFrame.style.height&&this._cachedContainerStyle.width===this._gameContainer.style.width&&this._cachedContainerStyle.height===this._gameContainer.style.height||(this.emit("window-resize"),this._cachedFrameStyle.width=this._gameFrame.style.width,this._cachedFrameStyle.height=this._gameFrame.style.height,this._cachedContainerStyle.width=this._gameContainer.style.width,this._cachedContainerStyle.height=this._gameContainer.style.height)}else q(9201)},h(t,[{key:"supportFullScreen",get:function(){return this._supportFullScreen}},{key:"isFullScreen",get:function(){return!!this._supportFullScreen&&!!document[this._fn.fullscreenElement]}},{key:"devicePixelRatio",get:function(){var e;return Math.min(null!==(e=window.devicePixelRatio)&&void 0!==e?e:1,2)}},{key:"windowSize",get:function(){var e=this._windowSizeInCssPixels,t=this.devicePixelRatio;return e.width*=t,e.height*=t,e},set:function(e){this._windowType===ju.SubFrame?this._resizeFrame(this._convertToSizeInCssPixels(e)):q(9202)}},{key:"resolution",get:function(){var e=this.windowSize,t=this.resolutionScale;return new jn(e.width*t,e.height*t)}},{key:"resolutionScale",get:function(){return this._resolutionScale},set:function(e){var t;e!==this._resolutionScale&&(this._resolutionScale=e,null===(t=this._cbToUpdateFrameBuffer)||void 0===t||t.call(this))}},{key:"orientation",get:function(){return this._orientation},set:function(e){this._orientation!==e&&(this._orientation=e,this._updateFrameState())}},{key:"safeAreaEdge",get:function(){return{top:0,bottom:0,left:0,right:0}}},{key:"isProportionalToFrame",get:function(){return this._isProportionalToFrame},set:function(e){this._isProportionalToFrame!==e&&(this._isProportionalToFrame=e,this._updateContainer())}},{key:"_windowSizeInCssPixels",get:function(){if(this.isProportionalToFrame)return this._gameContainer?new jn(this._gameContainer.clientWidth,this._gameContainer.clientHeight):(q(9201),new jn(0,0));var e,t,n;switch(this._windowType){case ju.SubFrame:return this._gameFrame?new jn(this._gameFrame.clientWidth,this._gameFrame.clientHeight):(q(9201),new jn(0,0));case ju.Fullscreen:return e=this._getFullscreenTarget(),t=this.isFrameRotated?e.clientHeight:e.clientWidth,n=this.isFrameRotated?e.clientWidth:e.clientHeight,new jn(t,n);case ju.BrowserWindow:return t=this.isFrameRotated?window.innerHeight:window.innerWidth,n=this.isFrameRotated?window.innerWidth:window.innerHeight,new jn(t,n);case ju.Unknown:default:return new jn(0,0)}}},{key:"_windowType",get:function(){return this.isFullScreen?ju.Fullscreen:this._gameFrame?this._exactFitScreen?ju.BrowserWindow:ju.SubFrame:(q(9201),ju.Unknown)}}]),t}(Jl)),Yu=function(){function e(){}var t=e.prototype;return t._init=function(e){Xu.init(e,(function(){var e,t=b.director;(null===(e=t.root)||void 0===e?void 0:e.pipeline)?t.root.pipeline.pipelineSceneData.shadingScale=Xu.resolutionScale:q(1220)}))},t.fullScreen=function(){return Xu.isFullScreen},t.requestFullScreen=function(e,t,n){return arguments.length>0&&q(1400,"screen.requestFullScreen(element, onFullScreenChange?, onFullScreenError?)","screen.requestFullScreen(): Promise"),Xu.requestFullScreen().then((function(){null==t||t()})).catch((function(e){console.error(e),null==n||n()}))},t.exitFullScreen=function(){return Xu.exitFullScreen()},t.autoFullScreen=function(e,t){var n;null===(n=this.requestFullScreen(e,t))||void 0===n||n.catch((function(){}))},t.disableAutoFullScreen=function(){},h(e,[{key:"devicePixelRatio",get:function(){return Xu.devicePixelRatio}},{key:"windowSize",get:function(){return Xu.windowSize},set:function(e){Xu.windowSize=e}},{key:"resolution",get:function(){return Xu.resolution}},{key:"supportsFullScreen",get:function(){return Xu.supportFullScreen}}]),e}(),Ku=e("screen",new Yu);b.screen=Ku;var Qu=e("sys",{Feature:Ql,hasFeature:function(e){return nu.hasFeature(e)},NetworkType:Xl,Language:ql,OS:Yl,Platform:Kl,BrowserType:jl,isNative:nu.isNative,isBrowser:nu.isBrowser,isMobile:nu.isMobile,isLittleEndian:nu.isLittleEndian,platform:nu.platform,language:nu.language,languageCode:nu.nativeLanguage,os:nu.os,osVersion:nu.osVersion,osMainVersion:nu.osMainVersion,browserType:nu.browserType,browserVersion:nu.browserVersion,windowPixelResolution:Ku.windowSize,capabilities:{canvas:!0,opengl:!0,webp:nu.hasFeature(Ql.WEBP),imageBitmap:nu.hasFeature(Ql.IMAGE_BITMAP),touches:nu.hasFeature(Ql.INPUT_TOUCH),mouse:nu.hasFeature(Ql.EVENT_MOUSE),keyboard:nu.hasFeature(Ql.EVENT_KEYBOARD),accelerometer:nu.hasFeature(Ql.EVENT_ACCELEROMETER)},localStorage:{},getNetworkType:function(){return nu.networkType},getBatteryLevel:function(){return nu.getBatteryLevel()},garbageCollect:function(){nu.triggerGC()},isObjectValid:function(e){return null!=e},dump:function(){var e="";e+="isMobile : "+this.isMobile+"\r\n",e+="language : "+this.language+"\r\n",e+="browserType : "+this.browserType+"\r\n",e+="browserVersion : "+this.browserVersion+"\r\n",e+="capabilities : "+JSON.stringify(this.capabilities)+"\r\n",e+="os : "+this.os+"\r\n",e+="osVersion : "+this.osVersion+"\r\n",e+="platform : "+this.platform+"\r\n",L(e+="Using "+(b.game.renderType===b.game.RENDER_TYPE_WEBGL?"WEBGL":"CANVAS")+" renderer.\r\n")},openURL:function(e){nu.openURL(e)},now:function(){return nu.now()},restartVM:function(){nu.restartJSVM()},getSafeAreaRect:function(){var e=b.view,t=Xu.safeAreaEdge,n=Xu.windowSize,i=new Tn(t.left,t.bottom),r=new Tn(n.width-t.right,n.height-t.top);e._convertToUISpace(i),e._convertToUISpace(r);var o=i.x,a=i.y,s=r.x-i.x,c=r.y-i.y;return new Xn(o,a,s,c)}});!function(){try{var e=Qu.localStorage=window.localStorage;e.setItem("storage",""),e.removeItem("storage"),e=null}catch(e){var t=function(){q(5200)};Qu.localStorage={getItem:t,setItem:t,clear:t,removeItem:t}}Qu.__isWebIOS14OrIPadOS14Env=(Qu.os===Yl.IOS||Qu.os===Yl.OSX)&&nu.isBrowser&&/(OS 14)|(Version\/14)/.test(window.navigator.userAgent)}(),b.sys=Qu;var Ju=e("serializeTag",Symbol("[[Serialize]]")),Zu=e("deserializeTag",Symbol("[[Deserialize]]")),$u=function(){function e(e,t){this._document=void 0,this._chunks=void 0,this._document=e,this._chunks=t}return h(e,[{key:"document",get:function(){return this._document}},{key:"chunks",get:function(){return this._chunks}}]),e}();function eh(e){var t=e;return{chunks:t.chunks,document:t.document}}function th(e){if(e.length<16)throw new nh(Z(13102));var t=new DataView(e.buffer,e.byteOffset,e.byteLength);if(1313817411!==t.getUint32(0,!0))throw new nh(Z(13100));var n=t.getUint32(4,!0);if(1!==n)throw new nh(Z(13101,n));if(t.getUint32(8,!0)!==t.byteLength)throw new nh(Z(13102));var i=12,r=t.getUint32(i,!0);i+=4;var o=new Uint8Array(t.buffer,i+t.byteOffset,r);i+=r;var a,s=function(e){if("undefined"!=typeof TextDecoder)return(new TextDecoder).decode(e);if("Buffer"in globalThis)return globalThis.Buffer.from(e.buffer,e.byteOffset,e.byteLength).toString();throw new Error(Z(13104))}(o);try{a=JSON.parse(s)}catch(e){throw new nh(e)}for(var c=[];i<t.byteLength;){i%8!=0&&(i+=8-i%8);var l=t.getUint32(i,!0);i+=4,c.push(new Uint8Array(t.buffer,i+t.byteOffset,l)),i+=l}if(i!==t.byteLength)throw new nh(Z(13102));return new $u(a,c)}var nh=function(e){function t(){return e.apply(this,arguments)||this}return f(t,e),t}(g(Error));function ih(e,t,n,i,r){if(t instanceof b.ValueType){r||e.push("if(prop){");var o=Se(t);e.push("s._deserializeFastDefinedObject(o"+n+",prop,"+o+");"),r||e.push("}else o"+n+"=null;")}else e.push("\nif (prop) {\n    s._deserializeAndAssignField(o, prop, "+i+");\n} else {\n    o"+n+"=null;\n}\n")}!function(){function e(){this._viewOrPaddings=[],this._length=0}var t=e.prototype;t.alignAs=function(e){if(0!==e){var t=this._length%e;if(0!==t){var n=e-t;return this._viewOrPaddings.push(n),this._length+=n,n}}return 0},t.append=function(e){var t=this._length;return this._viewOrPaddings.push(e),this._length+=e.byteLength,t},t.get=function(){var e=new Uint8Array(this._length),t=0;return this._viewOrPaddings.forEach((function(n){"number"==typeof n?t+=n:(e.set(new Uint8Array(n.buffer,n.byteOffset,n.byteLength),t),t+=n.byteLength)})),e},h(e,[{key:"byteLength",get:function(){return this._length}}])}(),b.internal.parseCCONJson=eh,b.internal.decodeCCONBinary=th,b.internal.CCON=$u;var rh="$_$default",oh="$_$formerlySerializedAs",ah=function(e){function t(){return e.call(this,(function(e){e.clear()}),1)||this}return f(t,e),t.prototype.get=function(e,t,n,i,r){var o=this._get();return o?(o.reset(e,t,n,i,r),o):new sh(e,t,n,i,r)},t}(Xe),sh=function(){function e(e,t,n,i){this.deserializedList=void 0,this.deserializedData=void 0,this._ignoreEditorOnly=void 0,this.result=e,this.customEnv=i,this.deserializedList=[],this.deserializedData=null,this._classFinder=t,this._reportMissingClass=n,this._onDereferenced=null==t?void 0:t.onDereferenced}var t=e.prototype;return t.reset=function(e,t,n,i){this.result=e,this.customEnv=i,this._classFinder=t,this._reportMissingClass=n,this._onDereferenced=null==t?void 0:t.onDereferenced},t.clear=function(){this.result=null,this.customEnv=null,this.deserializedList.length=0,this.deserializedData=null,this._classFinder=null,this._reportMissingClass=null,this._onDereferenced=null},t.deserialize=function(e){var t,n=!1;e instanceof $u?(n=!0,t=e.document,e.chunks.length>0&&(e.chunks.length,this._mainBinChunk=e.chunks[0])):t=e,this._serializedData=t,this._context={fromCCON:n};var i=Array.isArray(t)?t[0]:t;return this.deserializedData=this._deserializeObject(i,0),this._serializedData=void 0,this._mainBinChunk=void 0,this._context=void 0,this.deserializedData},t._deserializeObject=function(e,t,n,i){switch(e.__type__){case"TypedArray":return this._deserializeTypedArrayView(e);case"TypedArrayRef":return this._deserializeTypedArrayViewRef(e);default:return e.__type__?this._deserializeTypeTaggedObject(e,t,n,i):Array.isArray(e)?this._deserializeArray(e):this._deserializePlainObject(e)}},t._deserializeTypedArrayView=function(e){return globalThis[e.ctor].from(e.array)},t._deserializeTypedArrayViewRef=function(e){var t=e.offset,n=e.length,i=e.ctor;return new globalThis[i](this._mainBinChunk.buffer,this._mainBinChunk.byteOffset+t,n)},t._deserializeArray=function(e){for(var t,n=new Array(e.length),i=0;i<e.length;i++)"object"==typeof(t=e[i])&&t?this._deserializeAndAssignField(n,t,""+i)&&(n[i]=null):n[i]=t;return n},t._deserializePlainObject=function(e){var t={};return this._fillPlainObject(t,e),t},t._deserializeTypeTaggedObject=function(e,t,n,i){var r=this,o=e.__type__,a=this._classFinder(o,e,n,i);if(!a)return this._classFinder===We&&this._reportMissingClass(o),null;var s=function(e){var n=new e;return t>=0&&(r.deserializedList[t]=n),n}(a);return this._deserializeInto(e,s,a),s},t._deserializeInto=function(e,t,n,i){void 0===i&&(i=!1),i||!t[Zu]?t._deserialize?t._deserialize(e.content,this):b.Class._isCCClass(n)?this._deserializeFireClass(t,e,n):this._deserializeFastDefinedObject(t,e,n):this._runCustomizedDeserialize(e,t,n)},t._runCustomizedDeserialize=function(e,t,n){var i=this,r={readProperty:function(t){var n=e[t];return"object"==typeof n&&n?i._deserializeObjectField(n):n},readThis:function(){i._deserializeInto(e,t,n,!0)},readSuper:function(){var r=Ne(n);r&&i._deserializeInto(e,t,r)}};t[Zu](r,this._context)},t._deserializeFireClass=function(e,t,n){var i;if(n.hasOwnProperty("__deserialize__"))i=n.__deserialize__;else{i=function(e,t){for(var n=St(t),i=t.__values__,r=["var prop;"],o=it.test(qe(t)),a=0;a<i.length;a++){var s=i[a],c=void 0,l=void 0;jt.IDENTIFIER_RE.test(s)?(l='"'+s+'"',c="."+s):c="["+(l=jt.escapeForJS(s))+"]";var u=c;if(n[s+oh]){var h=n[s+oh];u=jt.IDENTIFIER_RE.test(h)?"."+h:"["+jt.escapeForJS(h)+"]"}r.push("prop=d"+u+";"),r.push('if(typeof prop!=="undefined"){');var _=jt.getDefault(n[s+rh]);if(o){var f=void 0,d=n[s+"$_$type"];if(void 0===_&&d)f=d instanceof Tt;else{var p=typeof _;f="string"===p||"number"===p||"boolean"===p}f?r.push("o"+c+"=prop;"):ih(r,_,c,l,!0)}else r.push('if(typeof prop!=="object"){o'+c+"=prop;}else{"),ih(r,_,c,l,!1),r.push("}");r.push("}")}return(b.js.isChildClassOf(t,b._BaseNode)||b.js.isChildClassOf(t,b.Component))&&r.push("d._id&&(o._id=d._id);"),"_$erialized"===i[i.length-1]&&(r.push("o._$erialized=JSON.parse(JSON.stringify(d));"),r.push("s._fillPlainObject(o._$erialized,d);")),Function("s","o","d","k",r.join(""))}(0,n);try{if(n===Vu){var r=n.__values__;0!==r.length&&"_$erialized"===r[r.length-1]||(B("The '_$erialized' prop of MissingScript is missing. Will force the raw data to be save."),B("    Error props: ['"+r+"']. Please contact jare."));var o=i;i=function(e,t,n,i){o(e,t,n,i),t._$erialized||B("Unable to stash previously serialized data. "+JSON.stringify(n))}}}catch(e){B("Error when checking MissingScript 6, "+e)}me(n,"__deserialize__",i,!0)}i(this,e,t,n)},t._deserializeAndAssignField=function(e,t,n){var i=t.__id__;if("number"==typeof i){var r=this.deserializedList[i];if(r)e[n]=r;else{var o,a=this._serializedData[i];e[n]=this._deserializeObject(a,i,void 0,n),null===(o=this._onDereferenced)||void 0===o||o.call(this,this.deserializedList,i,e,n)}}else{var s=t.__uuid__;if(s){var c=t.__expectedType__;this.result.push(e,n,s,c)}else e[n]=this._deserializeObject(t,-1)}return!1},t._deserializeObjectField=function(e){var t=e.__id__;if("number"==typeof t){var n=this.deserializedList[t];if(n)return n;var i=this._serializedData[t];return this._deserializeObject(i,t,void 0,void 0)}if(e.__uuid__)throw e.__expectedType__,new Error("Asset reference field serialization is currently not supported in custom serialization.");return this._deserializeObject(e,-1)},t._fillPlainObject=function(e,t){for(var n in t)if(t.hasOwnProperty(n)){var i=t[n];"object"!=typeof i?"__type__"!==n&&(e[n]=i):i?this._deserializeAndAssignField(e,i,n)&&(e[n]=null):e[n]=null}},t._deserializeFastDefinedObject=function(e,t,n){if(n===b.Vec2)return e.x=t.x||0,void(e.y=t.y||0);if(n===b.Vec3)return e.x=t.x||0,e.y=t.y||0,void(e.z=t.z||0);if(n!==b.Color){if(n===b.Size)return e.width=t.width||0,void(e.height=t.height||0);for(var i=St(n),r=n.__values__,o=0;o<r.length;o++){var a=r[o],s=t[a];void 0!==s||t.hasOwnProperty(a)||(s=jt.getDefault(i[a+rh])),"object"!=typeof s?e[a]=s:s?this._deserializeAndAssignField(e,s,a):e[a]=null}}else{e.r=t.r||0,e.g=t.g||0,e.b=t.b||0;var c=t.a;e.a=void 0===c?255:c}},e}();sh.pool=new ah;var ch=[Tn,yn,wn,On,Qn,jn,Xn,kn];function lh(e,t){e.x=t[1],e.y=t[2],e.z=t[3],e.w=t[4]}var uh=[function(e,t){e.x=t[1],e.y=t[2]},function(e,t){e.x=t[1],e.y=t[2],e.z=t[3]},lh,lh,function(e,t){e._val=t[1]},function(e,t){e.width=t[1],e.height=t[2]},function(e,t){e.x=t[1],e.y=t[2],e.width=t[3],e.height=t[4]},function(e,t){kn.fromArray(e,t,1)}],hh=e("Details",function(){function e(){this.uuidObjList=null,this.uuidPropList=null,this.uuidList=null,this.uuidTypeList=[]}var t=e.prototype;return t.init=function(e){e?(this.uuidObjList=e[8],this.uuidPropList=e[9],this.uuidList=e[10]):this.uuidList||(this.uuidList=[],this.uuidObjList=[],this.uuidPropList=[],this.uuidTypeList=[])},t.reset=function(){this.uuidList&&(this.uuidList.length=0,this.uuidObjList.length=0,this.uuidPropList.length=0,this.uuidTypeList.length=0)},t.push=function(e,t,n,i){this.uuidObjList.push(e),this.uuidPropList.push(t),this.uuidList.push(n),this.uuidTypeList.push(i||"")},e}());function _h(e,t){for(var n=e[4][t[0]],i=n[0],r=new(0,i[0]),o=i[1],a=i[2],s=n[n.length-1],c=1;c<s;++c)r[o[n[c]]]=t[c];for(;c<t.length;++c){var l=o[n[c]],u=i[n[c]+a];(0,gh[u])(e,r,l,t[c])}return r}function fh(e,t,n){var i=new t;return i._deserialize?i._deserialize(n,e[0]):Y(5303,Se(t)),i}function dh(e,t,n,i){i>=0?t[n]=e[5][i]:e[7][3*~i]=t}function ph(e){return function(t,n,i,r){n[i]=r;for(var o=0;o<r.length;++o)e(t,r,o,r[o])}}function mh(e,t,n,i){t[n]=null,e[8][i]=t}function vh(e,t,n,i){t[n]=_h(e,i)}hh.pool=new Xe((function(e){e.reset()}),5),hh.pool.get=function(){return this._get()||new hh};var gh=new Array(13);function yh(e,t,n){return e||n(t),Object}function xh(e,t,n,i,r,o,a){var s=e(t);if(!s){if(r)return void(n[i]=function(t,n,i){return function(){var r=e(i)||yh(o,i,a);return t[n]=r,new r}}(n,i,t));s=yh(o,t,a)}n[i]=s}function Sh(e,t,n,i){for(var r=n||We,o=e[3],a=0;a<o.length;++a){var s=o[a];"string"!=typeof s?xh(r,s[0],s,0,t,n,i):xh(r,s,o,a,t,n,i)}}function Eh(e){var t=e[4];if(t)for(var n=e[3],i=0;i<t.length;++i){var r=t[i];r[0]=n[r[0]]}}function Th(e,t,n){"string"==typeof e&&(e=JSON.parse(e));var i,r=!t;if(t=t||hh.pool.get(),function(e){if(Array.isArray(e)){var t=e[0];return"number"==typeof t||t instanceof Ch}return!1}(e)){t.init(e),n=n||{};var o,a=e[0],s=!1;if("object"==typeof a&&(s=a.preprocessed,a=a.version),a<1)throw new Error(Z(5304,a));n._version=a,n.result=t,e[0]=n,s||(Sh(e,!1,n.classFinder,null!==(o=n.reportMissingClass)&&void 0!==o?o:Th.reportMissingClass),Eh(e)),b.game._isCloning=!0;var c=e[5],l=function(e){var t=e[5],n=e[6],i=0===n?0:n.length,r=t[t.length-1],o=t.length-i;"number"!=typeof r?r=0:(r<0&&(r=~r),--o);for(var a=0;a<o;++a)t[a]=_h(e,t[a]);for(var s=e[3],c=0;c<i;++c,++a){var l=n[c],u=t[a];if(l>=0){var h=s[l];t[a]=fh(e,h,u)}else(0,gh[l=~l])(e,t,a,u)}return r}(e);b.game._isCloning=!1,e[7]&&function(e,t,n){for(var i=e.length-1,r=0,o=3*e[i];r<o;r+=3){var a=e[r],s=t[e[r+2]],c=e[r+1];c>=0?a[n[c]]=s:a[~c]=s}for(;r<i;r+=3){var l=t[e[r]],u=t[e[r+2]],h=e[r+1];h>=0?l[n[h]]=u:l[~h]=u}}(e[7],c,e[2]),function(e){for(var t=e[5],n=e[2],i=e[1],r=e[8],o=e[9],a=e[10],s=0;s<r.length;++s){var c=r[s];"number"==typeof c&&(r[s]=t[c]);var l=o[s];"number"==typeof l&&(l=l>=0?n[l]:~l,o[s]=l);var u=a[s];"number"==typeof u&&(a[s]=i[u])}}(e),i=c[l]}else i=function(e,t,n){var i,r=(n=n||{}).classFinder||We,o=n.createAssetRefs||Qu.platform===Kl.EDITOR_CORE,a=n.customEnv,s=n.ignoreEditorOnly,c=null!==(i=n.reportMissingClass)&&void 0!==i?i:b.deserialize.reportMissingClass;t.init();var l=sh.pool.get(t,r,c,a,s);b.game._isCloning=!0;var u=l.deserialize(e);return b.game._isCloning=!1,sh.pool.put(l),o&&t.assignAssetsBy(EditorExtends.serialize.asAsset),u}(e,t,n);return r&&hh.pool.put(t),i}gh[0]=function(e,t,n,i){t[n]=i},gh[1]=dh,gh[2]=ph(dh),gh[3]=ph(mh),gh[4]=vh,gh[5]=function(e,t,n,i){uh[i[0]](t[n],i)},gh[6]=mh,gh[7]=function(e,t,n,i){t[n].set(i)},gh[8]=function(e,t,n,i){var r=new ch[i[0]];uh[i[0]](r,i),t[n]=r},gh[9]=ph(vh),gh[10]=function(e,t,n,i){var r=e[3][i[0]];t[n]=fh(e,r,i[1])},gh[11]=function(e,t,n,i){var r=i[0];t[n]=r;for(var o=1;o<i.length;o+=3){var a=i[o],s=i[o+1],c=i[o+2];(0,gh[s])(e,r,a,c)}},gh[12]=function(e,t,n,i){var r=i[0];t[n]=r;for(var o=0;o<r.length;++o){var a=r[o],s=i[o+1];0!==s&&(0,gh[s])(e,r,o,a)}},Th.Details=hh,Th.reportMissingClass=function(e){Y(5302,e)};var Ch=function(e){this.preprocessed=!0,this.version=e};function bh(e,t,n){return[1,0,0,[e],0,n?[t,-1]:[t],[0],0,[],[],[]]}b.deserialize=Th;var Ah,wh,Ih,Ph,Rh,Dh,Oh,Nh,Mh,Lh,Fh,Bh=ol.Flags.Destroyed,zh=ol.Flags.PersistentMask,Uh=[];function kh(e){var t;if(e instanceof ol){if(e._instantiate)return b.game._isCloning=!0,t=e._instantiate(null,!0),b.game._isCloning=!1,t;if(e instanceof b.Asset)throw new TypeError(Z(6903))}return b.game._isCloning=!0,t=Gh(e),b.game._isCloning=!1,t}function Gh(e,t){var n;Hh(e,n=e._iN$t?e._iN$t:e.constructor?new(0,e.constructor):Object.create(null),t);for(var i=0,r=Uh.length;i<r;++i)Uh[i]._iN$t=null;return Uh.length=0,n}function Hh(e,t,n){Ke.value(e,"_iN$t",t,!0),Uh.push(e);var i=e.constructor;if(qt(i))!function(e,t,n,i){for(var r=e.__values__,o=0;o<r.length;o++){var a=r[o],s=t[a];if("object"==typeof s&&s){var c=n[a];c instanceof tt&&c.constructor===s.constructor?c.set(s):n[a]=s._iN$t||Vh(s,i)}else n[a]=s}}(i,e,t,n);else for(var r in e)if(e.hasOwnProperty(r)&&(95!==r.charCodeAt(0)||95!==r.charCodeAt(1)||"__type__"===r||"__prefab"===r)){var o=e[r];if("object"==typeof o&&o){if(o===t)continue;t[r]=o._iN$t||Vh(o,n)}else t[r]=o}e instanceof ol&&(t._objFlags&=zh)}function Vh(e,t){if(e instanceof tt)return e.clone();if(e instanceof b.Asset)return e;var n;if(ArrayBuffer.isView(e)){var i=e.length;n=new e.constructor(i),e._iN$t=n,Uh.push(e);for(var r=0;r<i;++r)n[r]=e[r];return n}if(Array.isArray(e)){var o=e.length;n=new Array(o),e._iN$t=n,Uh.push(e);for(var a=0;a<o;++a){var s=e[a];n[a]="object"==typeof s&&s?s._iN$t||Vh(s,t):s}return n}if(e._objFlags&Bh)return null;var c=e.constructor;if(qt(c)){if(t)if(t instanceof b.Component){if(e instanceof b._BaseNode||e instanceof b.Component)return e}else if(t instanceof b._BaseNode)if(e instanceof b._BaseNode){if(!e.isChildOf(t))return e}else if(e instanceof b.Component&&e.node&&!e.node.isChildOf(t))return e;n=new c}else if(c===Object)n={};else{if(c)return e;n=Object.create(null)}return Hh(e,n,t),n}function Wh(e,t){return(t<<3)+e}function jh(e){return Xh[e]}function qh(e){switch(e){case Lh.Uint8:return Uint8Array;case Lh.Uint16:return Uint16Array;case Lh.Uint32:return Uint32Array;case Lh.Int8:return Int8Array;case Lh.Int16:return Int16Array;case Lh.Int32:return Int32Array;case Lh.Float32:return Float32Array;case Lh.Float64:return Float64Array}}kh._clone=Gh,b.instantiate=kh,function(e){e[e.Uint8=0]="Uint8",e[e.Uint16=1]="Uint16",e[e.Uint32=2]="Uint32",e[e.Int8=3]="Int8",e[e.Int16=4]="Int16",e[e.Int32=5]="Int32",e[e.Float32=6]="Float32",e[e.Float64=7]="Float64"}(Lh||(Lh={})),function(e){e[e.Scalar=0]="Scalar",e[e.Vec2=1]="Vec2",e[e.Vec3=2]="Vec3",e[e.Vec4=3]="Vec4",e[e.Quat=4]="Quat",e[e.Mat4=5]="Mat4"}(Fh||(Fh={})),e("CompactValueTypeArray",dc("cc.CompactValueTypeArray")((Nh=Oh=function(){function e(){E(this,"_byteOffset",Ih,this),E(this,"_unitCount",Ph,this),E(this,"_unitElement",Rh,this),E(this,"_length",Dh,this)}return e.lengthFor=function(e,t,n){return jh(t).requiredUnits*e.length*qh(n).BYTES_PER_ELEMENT},e.compress=function(t,n,i,r,o,a){for(var s=jh(n),c=qh(i),l=s.requiredUnits*t.length,u=new c(r,o,l),h=0;h<t.length;++h)s.compress(u,h,t[h]);var _=new e;return _._unitElement=Wh(i,n),_._byteOffset=a,_._unitCount=l,_._length=t.length,_},e.prototype.decompress=function(e){for(var t,n={storageUnit:7&(t=this._unitElement),elementType:t>>3},i=n.storageUnit,r=jh(n.elementType),o=new(qh(i))(e,this._byteOffset,this._unitCount),a=new Array(this._length),s=0;s<this._length;++s)a[s]=r.decompress(o,s);return a},e}(),Oh.StorageUnit=Lh,Oh.ElementType=Fh,Ih=T((wh=Nh).prototype,"_byteOffset",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Ph=T(wh.prototype,"_unitCount",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Rh=T(wh.prototype,"_unitElement",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Wh(Lh.Uint8,Fh.Scalar)}}),Dh=T(wh.prototype,"_length",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Ah=wh))||Ah);var Xh=((Mh={})[Fh.Scalar]={requiredUnits:1,compress:function(e,t,n){e[t]=n},decompress:function(e,t){return e[t]}},Mh[Fh.Vec2]={requiredUnits:2,compress:function(e,t,n){e[2*t]=n.x,e[2*t+1]=n.y},decompress:function(e,t){return new yn(e[2*t],e[2*t+1])}},Mh[Fh.Vec3]={requiredUnits:3,compress:function(e,t,n){e[3*t]=n.x,e[3*t+1]=n.y,e[3*t+2]=n.z},decompress:function(e,t){return new yn(e[3*t],e[3*t+1],e[3*t+2])}},Mh[Fh.Vec4]={requiredUnits:4,compress:function(e,t,n){e[4*t]=n.x,e[4*t+1]=n.y,e[4*t+2]=n.z,e[4*t+3]=n.w},decompress:function(e,t){return new wn(e[4*t],e[4*t+1],e[4*t+2],e[4*t+3])}},Mh[Fh.Quat]={requiredUnits:4,compress:function(e,t,n){e[4*t]=n.x,e[4*t+1]=n.y,e[4*t+2]=n.z,e[4*t+3]=n.w},decompress:function(e,t){return new On(e[4*t],e[4*t+1],e[4*t+2],e[4*t+3])}},Mh[Fh.Mat4]={requiredUnits:16,compress:function(e,t,n){kn.toArray(e,n,16*t)},decompress:function(e,t){return kn.fromArray(new kn,e,16*t)}},Mh);function Yh(){return 0}function Kh(e){return e}function Qh(e){return e*e}function Jh(e){return e*(2-e)}function Zh(e){return(e*=2)<1?.5*e*e:-.5*(--e*(e-2)-1)}function $h(e){return e*e*e}function e_(e){return--e*e*e+1}function t_(e){return(e*=2)<1?.5*e*e*e:.5*((e-=2)*e*e+2)}function n_(e){return e*e*e*e}function i_(e){return 1- --e*e*e*e}function r_(e){return(e*=2)<1?.5*e*e*e*e:-.5*((e-=2)*e*e*e-2)}function o_(e){return e*e*e*e*e}function a_(e){return--e*e*e*e*e+1}function s_(e){return(e*=2)<1?.5*e*e*e*e*e:.5*((e-=2)*e*e*e*e+2)}function c_(e){return 1===e?1:1-Math.cos(e*Math.PI/2)}function l_(e){return Math.sin(e*Math.PI/2)}function u_(e){return.5*(1-Math.cos(Math.PI*e))}function h_(e){return 0===e?0:Math.pow(1024,e-1)}function __(e){return 1===e?1:1-Math.pow(2,-10*e)}function f_(e){return 0===e?0:1===e?1:(e*=2)<1?.5*Math.pow(1024,e-1):.5*(2-Math.pow(2,-10*(e-1)))}function d_(e){return 1-Math.sqrt(1-e*e)}function p_(e){return Math.sqrt(1- --e*e)}function m_(e){return(e*=2)<1?-.5*(Math.sqrt(1-e*e)-1):.5*(Math.sqrt(1-(e-=2)*e)+1)}function v_(e){var t,n=.1;return 0===e?0:1===e?1:(!n||n<1?(n=1,t=.1):t=.4*Math.asin(1/n)/(2*Math.PI),-n*Math.pow(2,10*(e-=1))*Math.sin(2*(e-t)*Math.PI/.4))}function g_(e){var t,n=.1;return 0===e?0:1===e?1:(!n||n<1?(n=1,t=.1):t=.4*Math.asin(1/n)/(2*Math.PI),n*Math.pow(2,-10*e)*Math.sin(2*(e-t)*Math.PI/.4)+1)}function y_(e){var t,n=.1;return 0===e?0:1===e?1:(!n||n<1?(n=1,t=.1):t=.4*Math.asin(1/n)/(2*Math.PI),(e*=2)<1?n*Math.pow(2,10*(e-=1))*Math.sin(2*(e-t)*Math.PI/.4)*-.5:n*Math.pow(2,-10*(e-=1))*Math.sin(2*(e-t)*Math.PI/.4)*.5+1)}function x_(e){if(1===e)return 1;var t=1.70158;return e*e*((t+1)*e-t)}function S_(e){if(0===e)return 0;var t=1.70158;return--e*e*((t+1)*e+t)+1}function E_(e){var t=2.5949095;return(e*=2)<1?e*e*((t+1)*e-t)*.5:.5*((e-=2)*e*((t+1)*e+t)+2)}function T_(e){return 1-C_(1-e)}function C_(e){return e<1/2.75?7.5625*e*e:e<2/2.75?7.5625*(e-=1.5/2.75)*e+.75:e<2.5/2.75?7.5625*(e-=2.25/2.75)*e+.9375:7.5625*(e-=2.625/2.75)*e+.984375}function b_(e){return e<.5?.5*T_(2*e):.5*C_(2*e-1)+.5}function A_(e){return e<=0?0:e>=1?1:e*e*(3-2*e)}function w_(e){return e<=0?0:e>=1?1:e*e*e*(e*(6*e-15)+10)}b._decorator=nl;var I_=z_(Qh,Jh),P_=z_($h,e_),R_=z_(n_,i_),D_=z_(o_,a_),O_=z_(c_,l_),N_=z_(h_,__),M_=z_(d_,p_),L_=z_(v_,g_),F_=z_(x_,S_),B_=z_(T_,C_);function z_(e,t){return function(n){return n<.5?t(2*n)/2:e(2*n-1)/2+.5}}var U_,k_,G_=Object.freeze({__proto__:null,constant:Yh,linear:Kh,quadIn:Qh,quadOut:Jh,quadInOut:Zh,cubicIn:$h,cubicOut:e_,cubicInOut:t_,quartIn:n_,quartOut:i_,quartInOut:r_,quintIn:o_,quintOut:a_,quintInOut:s_,sineIn:c_,sineOut:l_,sineInOut:u_,expoIn:h_,expoOut:__,expoInOut:f_,circIn:d_,circOut:p_,circInOut:m_,elasticIn:v_,elasticOut:g_,elasticInOut:y_,backIn:x_,backOut:S_,backInOut:E_,bounceIn:T_,bounceOut:C_,bounceInOut:b_,smooth:A_,fade:w_,quadOutIn:I_,cubicOutIn:P_,quartOutIn:R_,quintOutIn:D_,sineOutIn:O_,expoOutIn:N_,circOutIn:M_,elasticOutIn:L_,backOutIn:F_,bounceOutIn:B_});e("easing",G_),function(e){e[e.LINEAR=0]="LINEAR",e[e.CONSTANT=1]="CONSTANT",e[e.QUAD_IN=2]="QUAD_IN",e[e.QUAD_OUT=3]="QUAD_OUT",e[e.QUAD_IN_OUT=4]="QUAD_IN_OUT",e[e.QUAD_OUT_IN=5]="QUAD_OUT_IN",e[e.CUBIC_IN=6]="CUBIC_IN",e[e.CUBIC_OUT=7]="CUBIC_OUT",e[e.CUBIC_IN_OUT=8]="CUBIC_IN_OUT",e[e.CUBIC_OUT_IN=9]="CUBIC_OUT_IN",e[e.QUART_IN=10]="QUART_IN",e[e.QUART_OUT=11]="QUART_OUT",e[e.QUART_IN_OUT=12]="QUART_IN_OUT",e[e.QUART_OUT_IN=13]="QUART_OUT_IN",e[e.QUINT_IN=14]="QUINT_IN",e[e.QUINT_OUT=15]="QUINT_OUT",e[e.QUINT_IN_OUT=16]="QUINT_IN_OUT",e[e.QUINT_OUT_IN=17]="QUINT_OUT_IN",e[e.SINE_IN=18]="SINE_IN",e[e.SINE_OUT=19]="SINE_OUT",e[e.SINE_IN_OUT=20]="SINE_IN_OUT",e[e.SINE_OUT_IN=21]="SINE_OUT_IN",e[e.EXPO_IN=22]="EXPO_IN",e[e.EXPO_OUT=23]="EXPO_OUT",e[e.EXPO_IN_OUT=24]="EXPO_IN_OUT",e[e.EXPO_OUT_IN=25]="EXPO_OUT_IN",e[e.CIRC_IN=26]="CIRC_IN",e[e.CIRC_OUT=27]="CIRC_OUT",e[e.CIRC_IN_OUT=28]="CIRC_IN_OUT",e[e.CIRC_OUT_IN=29]="CIRC_OUT_IN",e[e.ELASTIC_IN=30]="ELASTIC_IN",e[e.ELASTIC_OUT=31]="ELASTIC_OUT",e[e.ELASTIC_IN_OUT=32]="ELASTIC_IN_OUT",e[e.ELASTIC_OUT_IN=33]="ELASTIC_OUT_IN",e[e.BACK_IN=34]="BACK_IN",e[e.BACK_OUT=35]="BACK_OUT",e[e.BACK_IN_OUT=36]="BACK_IN_OUT",e[e.BACK_OUT_IN=37]="BACK_OUT_IN",e[e.BOUNCE_IN=38]="BOUNCE_IN",e[e.BOUNCE_OUT=39]="BOUNCE_OUT",e[e.BOUNCE_IN_OUT=40]="BOUNCE_IN_OUT",e[e.BOUNCE_OUT_IN=41]="BOUNCE_OUT_IN",e[e.SMOOTH=42]="SMOOTH",e[e.FADE=43]="FADE"}(k_||(k_={}));var H_,V_=((U_={})[k_.CONSTANT]=Yh,U_[k_.LINEAR]=Kh,U_[k_.QUAD_IN]=Qh,U_[k_.QUAD_OUT]=Jh,U_[k_.QUAD_IN_OUT]=Zh,U_[k_.QUAD_OUT_IN]=I_,U_[k_.CUBIC_IN]=$h,U_[k_.CUBIC_OUT]=e_,U_[k_.CUBIC_IN_OUT]=t_,U_[k_.CUBIC_OUT_IN]=P_,U_[k_.QUART_IN]=n_,U_[k_.QUART_OUT]=i_,U_[k_.QUART_IN_OUT]=r_,U_[k_.QUART_OUT_IN]=R_,U_[k_.QUINT_IN]=o_,U_[k_.QUINT_OUT]=a_,U_[k_.QUINT_IN_OUT]=s_,U_[k_.QUINT_OUT_IN]=D_,U_[k_.SINE_IN]=c_,U_[k_.SINE_OUT]=l_,U_[k_.SINE_IN_OUT]=u_,U_[k_.SINE_OUT_IN]=O_,U_[k_.EXPO_IN]=h_,U_[k_.EXPO_OUT]=__,U_[k_.EXPO_IN_OUT]=f_,U_[k_.EXPO_OUT_IN]=N_,U_[k_.CIRC_IN]=d_,U_[k_.CIRC_OUT]=p_,U_[k_.CIRC_IN_OUT]=m_,U_[k_.CIRC_OUT_IN]=M_,U_[k_.ELASTIC_IN]=v_,U_[k_.ELASTIC_OUT]=g_,U_[k_.ELASTIC_IN_OUT]=y_,U_[k_.ELASTIC_OUT_IN]=L_,U_[k_.BACK_IN]=x_,U_[k_.BACK_OUT]=S_,U_[k_.BACK_IN_OUT]=E_,U_[k_.BACK_OUT_IN]=F_,U_[k_.BOUNCE_IN]=T_,U_[k_.BOUNCE_OUT]=C_,U_[k_.BOUNCE_IN_OUT]=b_,U_[k_.BOUNCE_OUT_IN]=B_,U_[k_.SMOOTH]=A_,U_[k_.FADE]=w_,U_);function W_(e){return V_[e]}o(255),o(65280);var j_,q_,X_,Y_=tc.LINEAR<<0|ic.NONE<<8|k_.LINEAR<<16,K_=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).value=0,t.rightTangent=0,t.rightTangentWeight=0,t.leftTangent=0,t.leftTangentWeight=0,t._flags=Y_,t}return f(t,e),h(t,[{key:"interpolationMode",get:function(){return(255&this._flags)>>0},set:function(e){this._flags&=-256,this._flags|=e<<0}},{key:"tangentWeightMode",get:function(){return(65280&this._flags)>>8},set:function(e){this._flags&=-65281,this._flags|=e<<8}},{key:"easingMethod",get:function(){return(16711680&this._flags)>>16},set:function(e){this._flags&=-16711681,this._flags|=e<<16}}]),t}(tl);function Q_(e){var t=new K_;if("number"==typeof e)t.value=e;else{var n=e.interpolationMode,i=e.tangentWeightMode,r=e.value,o=e.rightTangent,a=e.rightTangentWeight,s=e.leftTangent,c=e.leftTangentWeight,l=e.easingMethod,u=e[el];t.value=null!=r?r:t.value,t.rightTangent=null!=o?o:t.rightTangent,t.rightTangentWeight=null!=a?a:t.rightTangentWeight,t.leftTangent=null!=s?s:t.leftTangent,t.leftTangentWeight=null!=c?c:t.leftTangentWeight,t.interpolationMode=null!=n?n:t.interpolationMode,t.tangentWeightMode=null!=i?i:t.tangentWeightMode,t.easingMethod=null!=l?l:t.easingMethod,u&&(t[el]=u)}return t}jt.fastDefine("cc.RealKeyframeValue",K_,((H_={interpolationMode:tc.LINEAR,tangentWeightMode:ic.NONE,value:0,rightTangent:0,rightTangentWeight:0,leftTangent:0,leftTangentWeight:0,easingMethod:k_.LINEAR})[el]=void 0,H_)),jt.Attr.setClassAttr(K_,el,"editorOnly",!0),(j_=K_,null!==(X_=(q_=j_)[Sc])&&void 0!==X_?X_:q_[Sc]={}).uniquelyReferenced=!0;var J_,Z_=e("RealCurve",function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).preExtrapolation=nc.CLAMP,t.postExtrapolation=nc.CLAMP,t}f(t,e);var n=t.prototype;return n.evaluate=function(e){var t=this._times,n=this._values,i=t.length;if(0===i)return 0;var r=t[0],o=t[i-1];if(e<r){var a=this.preExtrapolation,s=n[0];if(a===nc.CLAMP||i<2)return s.value;switch(a){case nc.LINEAR:return pf(r,n[0].value,t[1],n[1].value,e);case nc.LOOP:e=ff(e,r,o);break;case nc.PING_PONG:e=df(e,r,o);break;default:return s.value}}else if(e>o){var c=this.postExtrapolation,l=n[i-1];if(c===nc.CLAMP||i<2)return l.value;switch(c){case nc.LINEAR:return pf(o,l.value,t[i-2],n[i-2].value,e);case nc.LOOP:e=ff(e,r,o);break;case nc.PING_PONG:e=df(e,r,o);break;default:return l.value}}var u=ec(t,e);if(u>=0)return n[u].value;var h=~u,_=h-1,f=t[_],d=n[_],p=t[h];return function(e,t,n,i,r){var o=n-e;switch(t.interpolationMode){default:case tc.CONSTANT:return t.value;case tc.LINEAR:var a=t.easingMethod===k_.LINEAR?r:W_(t.easingMethod)(r);return nn(t.value,i.value,a);case tc.CUBIC:var s=1/3,c=t.rightTangent,l=t.rightTangentWeight,u=0!=(t.tangentWeightMode&ic.RIGHT),h=i.leftTangent,_=i.leftTangentWeight,f=0!=(i.tangentWeightMode&ic.LEFT);if(u||f){var d=0;if(u)d=l;else{var p=o,m=o*c;d=Math.sqrt(p*p+m*m)*s}var v=Math.atan(c),g=Math.cos(v)*d+e,y=Math.sin(v)*d+t.value,x=0;if(f)x=_;else{var S=o,E=o*h;x=Math.sqrt(S*S+E*E)*s}var T=Math.atan(h),C=(g-e)/o,b=(-Math.cos(T)*x+n-e)/o,A=y,w=-Math.sin(T)*x+i.value,I=[0,0,0],P=function(e,t,n,i,r){var o=n/i,a=t/i,s=o*o,c=1/3*(-1/3*s+a),l=.5*(2/27*o*s-1/3*o*a+e/i),u=c*c*c,h=l*l+u,_=0;if(oc(h)){if(oc(l))return r[0]=0,1;var f=Math.cbrt(-l);return r[0]=2*f,r[1]=-f,2}if(h<0){var d=1/3*Math.acos(-l/Math.sqrt(-u)),p=2*Math.sqrt(-c);r[0]=p*Math.cos(d),r[1]=-p*Math.cos(d+Math.PI/3),r[2]=-p*Math.cos(d-Math.PI/3),_=3}else{var m=Math.sqrt(h),v=Math.cbrt(m-l),g=-Math.cbrt(m+l);r[0]=v+g,_=1}for(var y=1/3*o,x=0;x<_;++x)r[x]-=y;return _}(0-r,3*C,3*b-6*C,3*(C-b)+1,I),R=function(e,t,n){var i=n;if(1===t)i=e[0];else{i=-1/0;for(var r=0;r<t;++r){var o=e[r];o>=0&&o<=1&&o>i&&(i=o)}i===-1/0&&(i=0)}return i}(I,P,r);return mf(t.value,A,w,i.value,R)}var D=t.value+s*c*o,O=i.value-s*h*o;return mf(t.value,D,O,i.value,r)}}(f,d,p,n[h],(e-f)/(p-f))},n.addKeyFrame=function(t,n){return e.prototype.addKeyFrame.call(this,t,Q_(n))},n.assignSorted=function(e,t){if(void 0!==t)this.setKeyframes(e.slice(),t.map((function(e){return Q_(e)})));else{var n=Array.from(e);this.setKeyframes(n.map((function(e){return e[0]})),n.map((function(e){return Q_(e[1])})))}},n.isConstant=function(e){if(this._values.length<=1)return!0;var t=this._values[0].value;return this._values.every((function(n){return $t(n.value,t,e)}))},n[Ju]=function(e,t){if(t.toCCON){var n=this._times,i=this._values,r=n.length,o=new DataView(new ArrayBuffer(0+$_+$_+ef+tf*r+uf*r)),a=0;o.setUint8(a,this.preExtrapolation),a+=$_,o.setUint8(a,this.postExtrapolation),a+=$_,o.setUint32(a,r,!0),a+=ef,n.forEach((function(e,t){return o.setFloat32(a+tf*t,e,!0)})),a+=tf*r;for(var s,c=S(i);!(s=c()).done;){var l=s.value;a=hf(o,l,a)}var u=new Uint8Array(o.buffer,0,a);e.writeProperty("bytes",u);var h=i.map((function(e){return e[el]}));h.some((function(e){return void 0!==e}))&&e.writeProperty("keyframeValueEditorExtras",h)}else e.writeThis()},n[Zu]=function(e,t){if(t.fromCCON){var n=e.readProperty("bytes"),i=new DataView(n.buffer,n.byteOffset,n.byteLength),r=0;this.preExtrapolation=i.getUint8(r),r+=$_,this.postExtrapolation=i.getUint8(r),r+=$_;var o=i.getUint32(r,!0);r+=ef;var a=Array.from({length:o},(function(e,t){return i.getFloat32(r+tf*t,!0)}));r+=tf*o;for(var s=new Array(o),c=0;c<o;++c){var l=Q_({});r=_f(i,l,r),s[c]=l}n.byteLength;var u=e.readProperty("keyframeValueEditorExtras");u&&(u.length,u.forEach((function(e,t){return s[t][el]=e}))),this._times=a,this._values=s}else e.readThis()},t}(rc));jt.fastDefine("cc.RealCurve",Z_,{_times:[],_values:[],preExtrapolation:nc.CLAMP,postExtrapolation:nc.CLAMP}),function(e){e[e.VALUE=1]="VALUE",e[e.INTERPOLATION_MODE=2]="INTERPOLATION_MODE",e[e.TANGENT_WEIGHT_MODE=4]="TANGENT_WEIGHT_MODE",e[e.LEFT_TANGENT=8]="LEFT_TANGENT",e[e.LEFT_TANGENT_WEIGHT=16]="LEFT_TANGENT_WEIGHT",e[e.RIGHT_TANGENT=32]="RIGHT_TANGENT",e[e.RIGHT_TANGENT_WEIGHT=64]="RIGHT_TANGENT_WEIGHT"}(J_||(J_={}));var $_=1,ef=4,tf=4,nf=Q_({}),rf=nf.interpolationMode,of=nf.tangentWeightMode,af=nf.leftTangent,sf=nf.leftTangentWeight,cf=nf.rightTangent,lf=nf.rightTangentWeight,uf=26;function hf(e,t,n){var i=0,r=n,o=r;r+=4;var a=t.value,s=t.interpolationMode,c=t.tangentWeightMode,l=t.rightTangent,u=t.rightTangentWeight,h=t.leftTangent,_=t.leftTangentWeight,f=t.easingMethod;return e.setFloat32(r,a,!0),r+=4,s!==rf&&(i|=J_.INTERPOLATION_MODE,e.setUint8(r,s),r+=1),c!==of&&(i|=J_.TANGENT_WEIGHT_MODE,e.setUint8(r,c),r+=1),h!==af&&(i|=J_.LEFT_TANGENT,e.setFloat32(r,h,!0),r+=4),_!==sf&&(i|=J_.LEFT_TANGENT_WEIGHT,e.setFloat32(r,_,!0),r+=4),l!==cf&&(i|=J_.RIGHT_TANGENT,e.setFloat32(r,l,!0),r+=4),u!==lf&&(i|=J_.RIGHT_TANGENT_WEIGHT,e.setFloat32(r,u,!0),r+=4),i|=f<<8,e.setUint32(o,i,!0),r}function _f(e,t,n){var i=n,r=e.getUint32(i,!0);i+=4,t.value=e.getFloat32(i,!0),i+=4,r&J_.INTERPOLATION_MODE&&(t.interpolationMode=e.getUint8(i),i+=1),r&J_.TANGENT_WEIGHT_MODE&&(t.tangentWeightMode=e.getUint8(i),i+=1),r&J_.LEFT_TANGENT&&(t.leftTangent=e.getFloat32(i,!0),i+=4),r&J_.LEFT_TANGENT_WEIGHT&&(t.leftTangentWeight=e.getFloat32(i,!0),i+=4),r&J_.RIGHT_TANGENT&&(t.rightTangent=e.getFloat32(i,!0),i+=4),r&J_.RIGHT_TANGENT_WEIGHT&&(t.rightTangentWeight=e.getFloat32(i,!0),i+=4);var o=(65280&r)>>8;return t.easingMethod=o,i}function ff(e,t,n){return t+fn(e-t,n-t)}function df(e,t,n){return t+dn(e-t,n-t)}function pf(e,t,n,i,r){return t+(i-t)/(n-e)*(r-e)}function mf(e,t,n,i,r){var o=1-r;return o*o*o*e+3*o*o*r*t+3*o*r*r*n+r*r*r*i}function vf(e,t,n,i,r){var o=1-r;return o*(o*(e+(3*t-e)*r)+3*n*r*r)+i*r*r*r}b.bezier=vf;var gf,yf,xf,Sf,Ef,Tf,Cf,bf,Af,wf,If,Pf=Math.cos,Rf=Math.acos,Df=Math.max,Of=2*Math.PI,Nf=Math.sqrt;function Mf(e){return e<0?-Math.pow(-e,1/3):Math.pow(e,1/3)}function Lf(e,t){var n=function(e,t){var n,i,r,o,a=t-0,s=t-e[0],c=3*a,l=3*s,u=3*(t-e[2]),h=1/(-a+l-u+(t-1)),_=1/3,f=(c-6*s+u)*h,d=f*_,p=(-c+l)*h,m=(3*p-f*f)*_,v=m*_,g=(2*f*f*f-9*f*p+a*h*27)/27,y=g/2,x=y*y+v*v*v;if(x<0){var S=-m*_,E=Nf(S*S*S),T=-g/(2*E),C=Rf(T<-1?-1:T>1?1:T),b=2*Mf(E);return i=b*Pf(C*_)-d,r=b*Pf((C+Of)*_)-d,o=b*Pf((C+2*Of)*_)-d,i>=0&&i<=1?r>=0&&r<=1?o>=0&&o<=1?Df(i,r,o):Df(i,r):o>=0&&o<=1?Df(i,o):i:r>=0&&r<=1?o>=0&&o<=1?Df(r,o):r:o}if(0===x)return r=-(n=y<0?Mf(-y):-Mf(y))-d,(i=2*n-d)>=0&&i<=1?r>=0&&r<=1?Df(i,r):i:r;var A=Nf(x);return(n=Mf(-y+A))-Mf(y+A)-d}(e,t),i=e[1];return((1-n)*(i+(e[3]-i)*n)*3+n*n)*n}b.bezierByTime=Lf,function(e){e[e.SLERP=0]="SLERP",e[e.CONSTANT=1]="CONSTANT"}(If||(If=e("QuatInterpolationMode",{})));var Ff=dc("cc.QuatKeyframeValue")(gf=Ac((xf=T((yf=function(e){var t=void 0===e?{}:e,n=t.value,i=t.interpolationMode,r=t.easingMethod;E(this,"interpolationMode",xf,this),E(this,"value",Sf,this),E(this,"easingMethod",Ef,this),this.value=n?On.clone(n):this.value,this.interpolationMode=null!=i?i:this.interpolationMode,this.easingMethod=null!=r?r:this.easingMethod}).prototype,"interpolationMode",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return If.SLERP}}),Sf=T(yf.prototype,"value",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return On.clone(On.IDENTITY)}}),Ef=T(yf.prototype,"easingMethod",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return k_.LINEAR}}),gf=yf))||gf)||gf;function Bf(e){return new Ff(e)}var zf,Uf=e("QuatCurve",dc("cc.QuatCurve")((wf=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return E(t=e.call.apply(e,[this].concat(i))||this,"preExtrapolation",bf,y(t)),E(t,"postExtrapolation",Af,y(t)),t}f(t,e);var n=t.prototype;return n.evaluate=function(e,t){var n;null!==(n=t)&&void 0!==n||(t=new On);var i=this._times,r=this._values,o=this.postExtrapolation,a=this.preExtrapolation,s=i.length;if(0===s)return t;var c=i[0],l=i[s-1];if(e<c){var u=r[0];switch(a){case nc.LOOP:e=c+fn(e-c,l-c);break;case nc.PING_PONG:e=c+dn(e-c,l-c);break;case nc.CLAMP:default:return On.copy(t,u.value)}}else if(e>l){var h=r[s-1];switch(o){case nc.LOOP:e=c+fn(e-c,l-c);break;case nc.PING_PONG:e=c+dn(e-c,l-c);break;case nc.CLAMP:default:return On.copy(t,h.value)}}var _=ec(i,e);if(_>=0)return On.copy(t,r[_].value);var f=~_,d=f-1,p=i[d],m=r[d],v=i[f],g=r[f],y=(e-p)/(v-p);switch(m.interpolationMode){default:case If.CONSTANT:return On.copy(t,m.value);case If.SLERP:var x=m.easingMethod,S=x===k_.LINEAR?y:Array.isArray(x)?Lf(x,y):W_(x)(y);return On.slerp(t,m.value,g.value,S)}},n.addKeyFrame=function(t,n){var i=new Ff(n);return e.prototype.addKeyFrame.call(this,t,i)},n.assignSorted=function(e,t){if(void 0!==t)this.setKeyframes(e.slice(),t.map((function(e){return Bf(e)})));else{var n=Array.from(e);this.setKeyframes(n.map((function(e){return e[0]})),n.map((function(e){return Bf(e[1])})))}},n[Ju]=function(e,t){if(t.toCCON){var n=this._times,i=this._values,r=!0;i.forEach((function(e,t,n){var i=n[0];r&&e.interpolationMode!==i.interpolationMode&&(r=!1)}));var o=n.length,a=jf*(r?1:o),s=i.reduce((function(e,t){var n=t.easingMethod;return e+(Array.isArray(n)?qf+4*Yf:qf)}),0),c=0,l=new DataView(new ArrayBuffer(c+=Gf+Hf+Vf*o+4*Wf*o+s+a+0)),u=0,h=0;r&&(h|=zf.INTERPOLATION_MODE),l.setUint32(u,h,!0),u+=Gf,l.setUint32(u,o,!0),u+=Hf,n.forEach((function(e,t){return l.setFloat32(u+Vf*t,e,!0)})),u+=Vf*o,i.forEach((function(e,t){var n=e.value,i=n.x,r=n.y,o=n.z,a=n.w,s=u+4*Wf*t;l.setFloat32(s+0*Wf,i,!0),l.setFloat32(s+1*Wf,r,!0),l.setFloat32(s+2*Wf,o,!0),l.setFloat32(s+3*Wf,a,!0)})),u+=4*Wf*o,i.forEach((function(e){var t=e.easingMethod;Array.isArray(t)?(l.setUint8(u,Xf),++u,l.setFloat32(u+0*Yf,t[0],!0),l.setFloat32(u+1*Yf,t[1],!0),l.setFloat32(u+2*Yf,t[2],!0),l.setFloat32(u+3*Yf,t[3],!0),u+=4*Yf):(l.setUint8(u,t),++u)}));var _=u;u+=a;var f=_;i.forEach((function(e){var t=e.interpolationMode;l.setUint8(f,t),r||(f+=jf)}));var d=new Uint8Array(l.buffer);e.writeProperty("bytes",d)}else e.writeThis()},n[Zu]=function(e,t){if(t.fromCCON){var n=e.readProperty("bytes"),i=new DataView(n.buffer,n.byteOffset,n.byteLength),r=0,o=i.getUint32(r,!0);r+=Gf;var a=o&zf.INTERPOLATION_MODE,s=i.getUint32(r,!0);r+=Hf;var c=Array.from({length:s},(function(e,t){return i.getFloat32(r+Vf*t,!0)})),l=r+=Vf*s;r+=4*Wf*s;var u=Array.from({length:s},(function(e,t){var n=l+4*Wf*t,o=i.getFloat32(n+0*Wf,!0),a=i.getFloat32(n+1*Wf,!0),s=i.getFloat32(n+2*Wf,!0),c=i.getFloat32(n+3*Wf,!0),u=i.getUint8(r);++r;var h=Bf({value:{x:o,y:a,z:s,w:c}});return u!==Xf?h.easingMethod=u:(h.easingMethod=[i.getFloat32(r+0*Yf,!0),i.getFloat32(r+1*Yf,!0),i.getFloat32(r+2*Yf,!0),i.getFloat32(r+3*Yf,!0)],r+=4*Yf),h}));if(a){var h=i.getUint8(r);++r;for(var _=0;_<s;++_)u[_].interpolationMode=h}else{for(var f=0;f<s;++f){var d=i.getUint8(r+f);u[f].interpolationMode=d}r+=s}this._times=c,this._values=u}else e.readThis()},t}(rc),bf=T((Cf=wf).prototype,"preExtrapolation",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return nc.CLAMP}}),Af=T(Cf.prototype,"postExtrapolation",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return nc.CLAMP}}),Tf=Cf))||Tf);!function(e){e[e.INTERPOLATION_MODE=1]="INTERPOLATION_MODE"}(zf||(zf={}));var kf,Gf=1,Hf=4,Vf=4,Wf=4,jf=1,qf=1,Xf=255,Yf=4,Kf=e("ObjectCurve",dc("cc.ObjectCurve")(kf=function(e){function t(){return e.apply(this,arguments)||this}return f(t,e),t.prototype.evaluate=function(e){var t=this.searchKeyframe(e);if(t>=0)return this._values[t];var n=en(~t-1,0,this._values.length-1);return this._values[n]},t}(rc))||kf),Qf=function(){this.time=0,this.value=0,this.inTangent=0,this.outTangent=0};jt.fastDefine("cc.Keyframe",Qf,{time:0,value:0,inTangent:0,outTangent:0});var Jf=function(){function e(){this.index=void 0,this.time=void 0,this.endTime=void 0,this.coefficient=void 0,this.index=-1,this.time=0,this.endTime=0,this.coefficient=new Float32Array(4)}return e.prototype.evaluate=function(e){return t=e-this.time,n=this.coefficient,t*(t*(t*n[0]+n[1])+n[2])+n[3];var t,n},e}(),Zf=function(){function e(e){if(void 0===e&&(e=null),this.cachedKey=void 0,e instanceof Z_)this._curve=e;else{var t=new Z_;this._curve=t,t.preExtrapolation=nc.LOOP,t.postExtrapolation=nc.CLAMP,e?t.assignSorted(e.map((function(e){return[e.time,{interpolationMode:tc.CUBIC,value:e.value,leftTangent:e.inTangent,rightTangent:e.outTangent}]}))):t.assignSorted([[0,{interpolationMode:tc.CUBIC,value:1}],[1,{interpolationMode:tc.CUBIC,value:1}]])}this.cachedKey=new Jf}var t=e.prototype;return t.addKey=function(e){e?this._curve.addKeyFrame(e.time,{interpolationMode:tc.CUBIC,value:e.value,leftTangent:e.inTangent,rightTangent:e.outTangent}):this._curve.clear()},t.evaluate_slow=function(e){return this._curve.evaluate(e)},t.evaluate=function(e){var t=this.cachedKey,n=this._curve,i=n.keyFramesCount-1,r=e,o=e<0?n.preExtrapolation:n.postExtrapolation,a=n.getKeyframeTime(0),s=n.getKeyframeTime(i);switch(o){case nc.LOOP:r=fn(e-a,s-a)+a;break;case nc.PING_PONG:r=dn(e-a,s-a)+a;break;case nc.CLAMP:default:r=en(e,a,s)}if(r>=t.time&&r<t.endTime)return t.evaluate(r);var c=this.findIndex(t,r),l=Math.min(c+1,i);return this.calcOptimizedKey(t,c,l),t.evaluate(r)},t.calcOptimizedKey=function(e,t,n){var i=this._curve.getKeyframeTime(t),r=this._curve.getKeyframeTime(n),o=this._curve.getKeyframeValue(t),a=o.value,s=o.leftTangent,c=this._curve.getKeyframeValue(n),l=c.value,u=c.rightTangent;e.index=t,e.time=i,e.endTime=r;var h=r-i,_=l-a,f=1/(h*h),d=s*h,p=u*h;e.coefficient[0]=(d+p-_-_)*f/h,e.coefficient[1]=(_+_+_-d-d-p)*f,e.coefficient[2]=s,e.coefficient[3]=a},t.findIndex=function(e,t){var n=this._curve,i=n.keyFramesCount,r=e.index;if(-1!==r)if(t>n.getKeyframeTime(r))for(var o=0;o<3;o++){var a=r+o;if(a+1<i&&n.getKeyframeTime(a+1)>t)return a}else for(var s=0;s<3;s++){var c=r-s;if(c>=0&&n.getKeyframeTime(c-1)<=t)return c-1}for(var l,u=0,h=i;h-u>1;)l=Math.floor((u+h)/2),n.getKeyframeTime(l)>=t?h=l:u=l;return u},h(e,[{key:"_internalCurve",get:function(){return this._curve}},{key:"keyFrames",get:function(){return Array.from(this._curve.keyframes()).map((function(e){var t=e[0],n=e[1],i=new Qf;return i.time=t,i.value=n.value,i.inTangent=n.leftTangent,i.outTangent=n.rightTangent,i}))},set:function(e){this._curve.assignSorted(e.map((function(e){return[e.time,{interpolationMode:tc.CUBIC,value:e.value,leftTangent:e.inTangent,rightTangent:e.outTangent}]})))}},{key:"preWrapMode",get:function(){return ed(this._curve.preExtrapolation)},set:function(e){this._curve.preExtrapolation=$f(e)}},{key:"postWrapMode",get:function(){return ed(this._curve.postExtrapolation)},set:function(e){this._curve.postExtrapolation=$f(e)}}]),e}();function $f(e){switch(e){default:case qs.Default:case qs.Normal:case qs.Clamp:return nc.CLAMP;case qs.PingPong:return nc.PING_PONG;case qs.Loop:return nc.LOOP}}function ed(e){switch(e){default:case nc.LINEAR:case nc.CLAMP:return qs.Clamp;case nc.PING_PONG:return qs.PingPong;case nc.LOOP:return qs.Loop}}function td(){var e=new Z_;return e.assignSorted([[0,{interpolationMode:tc.CUBIC,value:1}],[1,{interpolationMode:tc.CUBIC,value:1}]]),e}Zf.defaultKF=[{time:0,value:1,inTangent:0,outTangent:0},{time:1,value:1,inTangent:0,outTangent:0}],jt.fastDefine("cc.AnimationCurve",Zf,{_curve:null});var nd=Object.freeze({__proto__:null,distance:jo,enums:qo,intersect:rs,Line:_s,Plane:vs,Ray:Xo,Triangle:ta,Sphere:ea,AABB:Us,OBB:Vs,Capsule:Ws,Frustum:Js,Keyframe:Qf,AnimationCurve:Zf,get ERaycastMode(){return $o}});e("geometry",nd);var id={NONE:0,IGNORE_RAYCAST:1<<20,GIZMOS:1<<21,EDITOR:1<<22,UI_3D:1<<23,SCENE_GIZMO:1<<24,UI_2D:1<<25,PROFILER:1<<28,DEFAULT:1<<30,ALL:4294967295},rd=e("Layers",function(){function e(){}return e.makeMaskInclude=function(e){for(var t,n=0,i=S(e);!(t=i()).done;)n|=t.value;return n},e.makeMaskExclude=function(t){return~e.makeMaskInclude(t)},e.addLayer=function(t,n){if(void 0!==n)if(n>19||n<0)console.warn("maximum layers reached.");else{var i=1<<n;e.Enum[t],Z(2104,t),e.Enum[t]=i,Ke.value(e.Enum,String(i),t),e.BitMask[t]=i,Ke.value(e.BitMask,String(i),t)}else console.warn("bitNum can't be undefined")},e.deleteLayer=function(t){if(t>19||t<0)console.warn("do not change buildin layers.");else{var n=1<<t;delete e.Enum[e.Enum[n]],delete e.Enum[n],delete e.BitMask[e.BitMask[n]],delete e.BitMask[n]}},e.nameToLayer=function(t){return void 0===t?(console.warn("name can't be undefined"),-1):r(e.Enum[t])},e.layerToName=function(t){return t>31||t<0?(console.warn("Unable to access unknown layer."),""):e.Enum[1<<t]},e}());rd.Enum=Je(id),rd.BitMask=Qe(_({},id)),b.Layers=rd;var od,ad,sd="MainFlow",cd="ForwardFlow",ld="ShadowFlow";!function(e){e[e.DEFAULT=100]="DEFAULT",e[e.UI=200]="UI"}(od||(od={})),b.RenderPassStage=od,function(e){e[e.MIN=0]="MIN",e[e.MAX=255]="MAX",e[e.DEFAULT=128]="DEFAULT"}(ad||(ad={}));var ud,hd={bindings:[],layouts:{}},_d={bindings:[],layouts:{}};!function(e){e[e.UBO_GLOBAL=0]="UBO_GLOBAL",e[e.UBO_CAMERA=1]="UBO_CAMERA",e[e.UBO_SHADOW=2]="UBO_SHADOW",e[e.SAMPLER_SHADOWMAP=3]="SAMPLER_SHADOWMAP",e[e.SAMPLER_ENVIRONMENT=4]="SAMPLER_ENVIRONMENT",e[e.SAMPLER_SPOT_LIGHTING_MAP=5]="SAMPLER_SPOT_LIGHTING_MAP",e[e.SAMPLER_DIFFUSEMAP=6]="SAMPLER_DIFFUSEMAP",e[e.COUNT=7]="COUNT"}(ud||(ud={}));var fd,dd=ud.SAMPLER_SHADOWMAP,pd=ud.COUNT-dd;!function(e){e[e.UBO_LOCAL=0]="UBO_LOCAL",e[e.UBO_FORWARD_LIGHTS=1]="UBO_FORWARD_LIGHTS",e[e.UBO_SKINNING_ANIMATION=2]="UBO_SKINNING_ANIMATION",e[e.UBO_SKINNING_TEXTURE=3]="UBO_SKINNING_TEXTURE",e[e.UBO_MORPH=4]="UBO_MORPH",e[e.UBO_UI_LOCAL=5]="UBO_UI_LOCAL",e[e.SAMPLER_JOINTS=6]="SAMPLER_JOINTS",e[e.SAMPLER_MORPH_POSITION=7]="SAMPLER_MORPH_POSITION",e[e.SAMPLER_MORPH_NORMAL=8]="SAMPLER_MORPH_NORMAL",e[e.SAMPLER_MORPH_TANGENT=9]="SAMPLER_MORPH_TANGENT",e[e.SAMPLER_LIGHTMAP=10]="SAMPLER_LIGHTMAP",e[e.SAMPLER_SPRITE=11]="SAMPLER_SPRITE",e[e.SAMPLER_REFLECTION=12]="SAMPLER_REFLECTION",e[e.STORAGE_REFLECTION=13]="STORAGE_REFLECTION",e[e.COUNT=14]="COUNT"}(fd||(fd={}));var md,vd=fd.SAMPLER_JOINTS,gd=fd.STORAGE_REFLECTION-vd,yd=fd.COUNT-vd-gd;!function(e){e[e.GLOBAL=0]="GLOBAL",e[e.MATERIAL=1]="MATERIAL",e[e.LOCAL=2]="LOCAL"}(md||(md={}));var xd=new or([dd,0,vd],[pd,0,gd],[0,0,0],[0,0,0],[0,0,0],[0,0,yd],[0,0,0],[0,2,1]),Sd=function(){};Sd.SIZE=4*(Sd.COUNT=4+(Sd.SCREEN_SIZE_OFFSET=4+(Sd.NATIVE_SIZE_OFFSET=4+(Sd.TIME_OFFSET=0)))),Sd.NAME="CCGlobal",Sd.BINDING=ud.UBO_GLOBAL,Sd.DESCRIPTOR=new Fr(Sd.BINDING,zi.UNIFORM_BUFFER,1,Ai.ALL),Sd.LAYOUT=new vr(md.GLOBAL,Sd.BINDING,Sd.NAME,[new mr("cc_time",ci.FLOAT4,1),new mr("cc_screenSize",ci.FLOAT4,1),new mr("cc_nativeSize",ci.FLOAT4,1)],1),hd.layouts[Sd.NAME]=Sd.LAYOUT,hd.bindings[Sd.BINDING]=Sd.DESCRIPTOR;var Ed=function(){};Ed.SIZE=4*(Ed.COUNT=4+(Ed.VIEW_PORT_OFFSET=4+(Ed.NEAR_FAR_OFFSET=4+(Ed.GLOBAL_FOG_ADD_OFFSET=4+(Ed.GLOBAL_FOG_BASE_OFFSET=4+(Ed.GLOBAL_FOG_COLOR_OFFSET=4+(Ed.AMBIENT_GROUND_OFFSET=4+(Ed.AMBIENT_SKY_OFFSET=4+(Ed.MAIN_LIT_COLOR_OFFSET=4+(Ed.MAIN_LIT_DIR_OFFSET=4+(Ed.EXPOSURE_OFFSET=4+(Ed.SCREEN_SCALE_OFFSET=4+(Ed.CAMERA_POS_OFFSET=16+(Ed.MAT_VIEW_PROJ_INV_OFFSET=16+(Ed.MAT_VIEW_PROJ_OFFSET=16+(Ed.MAT_PROJ_INV_OFFSET=16+(Ed.MAT_PROJ_OFFSET=16+(Ed.MAT_VIEW_INV_OFFSET=16+(Ed.MAT_VIEW_OFFSET=0))))))))))))))))))),Ed.NAME="CCCamera",Ed.BINDING=ud.UBO_CAMERA,Ed.DESCRIPTOR=new Fr(Ed.BINDING,zi.UNIFORM_BUFFER,1,Ai.ALL),Ed.LAYOUT=new vr(md.GLOBAL,Ed.BINDING,Ed.NAME,[new mr("cc_matView",ci.MAT4,1),new mr("cc_matViewInv",ci.MAT4,1),new mr("cc_matProj",ci.MAT4,1),new mr("cc_matProjInv",ci.MAT4,1),new mr("cc_matViewProj",ci.MAT4,1),new mr("cc_matViewProjInv",ci.MAT4,1),new mr("cc_cameraPos",ci.FLOAT4,1),new mr("cc_screenScale",ci.FLOAT4,1),new mr("cc_exposure",ci.FLOAT4,1),new mr("cc_mainLitDir",ci.FLOAT4,1),new mr("cc_mainLitColor",ci.FLOAT4,1),new mr("cc_ambientSky",ci.FLOAT4,1),new mr("cc_ambientGround",ci.FLOAT4,1),new mr("cc_fogColor",ci.FLOAT4,1),new mr("cc_fogBase",ci.FLOAT4,1),new mr("cc_fogAdd",ci.FLOAT4,1),new mr("cc_nearFar",ci.FLOAT4,1),new mr("cc_viewPort",ci.FLOAT4,1)],1),hd.layouts[Ed.NAME]=Ed.LAYOUT,hd.bindings[Ed.BINDING]=Ed.DESCRIPTOR;var Td=function(){};Td.SIZE=4*(Td.COUNT=4+(Td.PLANAR_NORMAL_DISTANCE_INFO_OFFSET=4+(Td.SHADOW_COLOR_OFFSET=4+(Td.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET=4+(Td.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET=4+(Td.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET=4+(Td.SHADOW_PROJ_INFO_OFFSET=4+(Td.SHADOW_PROJ_DEPTH_INFO_OFFSET=4+(Td.SHADOW_INV_PROJ_DEPTH_INFO_OFFSET=16+(Td.MAT_LIGHT_VIEW_PROJ_OFFSET=16+(Td.MAT_LIGHT_VIEW_OFFSET=16+(Td.MAT_LIGHT_PLANE_PROJ_OFFSET=0)))))))))))),Td.NAME="CCShadow",Td.BINDING=ud.UBO_SHADOW,Td.DESCRIPTOR=new Fr(Td.BINDING,zi.UNIFORM_BUFFER,1,Ai.ALL),Td.LAYOUT=new vr(md.GLOBAL,Td.BINDING,Td.NAME,[new mr("cc_matLightPlaneProj",ci.MAT4,1),new mr("cc_matLightView",ci.MAT4,1),new mr("cc_matLightViewProj",ci.MAT4,1),new mr("cc_shadowInvProjDepthInfo",ci.FLOAT4,1),new mr("cc_shadowProjDepthInfo",ci.FLOAT4,1),new mr("cc_shadowProjInfo",ci.FLOAT4,1),new mr("cc_shadowNFLSInfo",ci.FLOAT4,1),new mr("cc_shadowWHPBInfo",ci.FLOAT4,1),new mr("cc_shadowLPNNInfo",ci.FLOAT4,1),new mr("cc_shadowColor",ci.FLOAT4,1),new mr("cc_planarNDInfo",ci.FLOAT4,1)],1),hd.layouts[Td.NAME]=Td.LAYOUT,hd.bindings[Td.BINDING]=Td.DESCRIPTOR;var Cd=ud.SAMPLER_SHADOWMAP,bd=new Fr(Cd,zi.SAMPLER_TEXTURE,1,Ai.FRAGMENT),Ad=new gr(md.GLOBAL,Cd,"cc_shadowMap",ci.SAMPLER2D,1);hd.layouts.cc_shadowMap=Ad,hd.bindings[Cd]=bd;var wd=ud.SAMPLER_ENVIRONMENT,Id=new Fr(wd,zi.SAMPLER_TEXTURE,1,Ai.FRAGMENT),Pd=new gr(md.GLOBAL,wd,"cc_environment",ci.SAMPLER_CUBE,1);hd.layouts.cc_environment=Pd,hd.bindings[wd]=Id;var Rd=ud.SAMPLER_DIFFUSEMAP,Dd=new Fr(Rd,zi.SAMPLER_TEXTURE,1,Ai.FRAGMENT),Od=new gr(md.GLOBAL,Rd,"cc_diffuseMap",ci.SAMPLER_CUBE,1);hd.layouts.cc_diffuseMap=Od,hd.bindings[Rd]=Dd;var Nd=ud.SAMPLER_SPOT_LIGHTING_MAP,Md=new Fr(Nd,zi.SAMPLER_TEXTURE,1,Ai.FRAGMENT),Ld=new gr(md.GLOBAL,Nd,"cc_spotLightingMap",ci.SAMPLER2D,1);hd.layouts.cc_spotLightingMap=Ld,hd.bindings[Nd]=Md;var Fd=function(){};Fd.SIZE=4*(Fd.COUNT=4+(Fd.LOCAL_SHADOW_BIAS=4+(Fd.LIGHTINGMAP_UVPARAM=16+(Fd.MAT_WORLD_IT_OFFSET=16+(Fd.MAT_WORLD_OFFSET=0))))),Fd.NAME="CCLocal",Fd.BINDING=fd.UBO_LOCAL,Fd.DESCRIPTOR=new Fr(Fd.BINDING,zi.UNIFORM_BUFFER,1,Ai.VERTEX|Ai.COMPUTE),Fd.LAYOUT=new vr(md.LOCAL,Fd.BINDING,Fd.NAME,[new mr("cc_matWorld",ci.MAT4,1),new mr("cc_matWorldIT",ci.MAT4,1),new mr("cc_lightingMapUVParam",ci.FLOAT4,1),new mr("cc_localShadowBias",ci.FLOAT4,1)],1),_d.layouts[Fd.NAME]=Fd.LAYOUT,_d.bindings[Fd.BINDING]=Fd.DESCRIPTOR;var Bd=function(){};Bd.SIZE=4*(Bd.COUNT=4+(Bd.WORLD_BOUND_HALF_EXTENTS=4+(Bd.WORLD_BOUND_CENTER=0))),Bd.NAME="CCWorldBound",Bd.BINDING=fd.UBO_LOCAL,Bd.DESCRIPTOR=new Fr(Bd.BINDING,zi.UNIFORM_BUFFER,1,Ai.VERTEX|Ai.COMPUTE),Bd.LAYOUT=new vr(md.LOCAL,Bd.BINDING,Bd.NAME,[new mr("cc_worldBoundCenter",ci.FLOAT4,1),new mr("cc_worldBoundHalfExtents",ci.FLOAT4,1)],1),_d.layouts[Bd.NAME]=Bd.LAYOUT,_d.bindings[Bd.BINDING]=Bd.DESCRIPTOR;var zd="a_matWorld0",Ud=function(){};Ud.BATCHING_COUNT=10,Ud.MAT_WORLDS_OFFSET=0,Ud.SIZE=4*(Ud.COUNT=16*Ud.BATCHING_COUNT),Ud.NAME="CCLocalBatched",Ud.BINDING=fd.UBO_LOCAL,Ud.DESCRIPTOR=new Fr(Ud.BINDING,zi.UNIFORM_BUFFER,1,Ai.VERTEX|Ai.COMPUTE),Ud.LAYOUT=new vr(md.LOCAL,Ud.BINDING,Ud.NAME,[new mr("cc_matWorlds",ci.MAT4,Ud.BATCHING_COUNT)],1),_d.layouts[Ud.NAME]=Ud.LAYOUT,_d.bindings[Ud.BINDING]=Ud.DESCRIPTOR;var kd=function(){};kd.LIGHTS_PER_PASS=1,kd.SIZE=4*(kd.COUNT=(kd.LIGHT_DIR_OFFSET=(kd.LIGHT_SIZE_RANGE_ANGLE_OFFSET=(kd.LIGHT_COLOR_OFFSET=(kd.LIGHT_POS_OFFSET=0)+4*kd.LIGHTS_PER_PASS)+4*kd.LIGHTS_PER_PASS)+4*kd.LIGHTS_PER_PASS)+4*kd.LIGHTS_PER_PASS),kd.NAME="CCForwardLight",kd.BINDING=fd.UBO_FORWARD_LIGHTS,kd.DESCRIPTOR=new Fr(kd.BINDING,zi.DYNAMIC_UNIFORM_BUFFER,1,Ai.FRAGMENT),kd.LAYOUT=new vr(md.LOCAL,kd.BINDING,kd.NAME,[new mr("cc_lightPos",ci.FLOAT4,kd.LIGHTS_PER_PASS),new mr("cc_lightColor",ci.FLOAT4,kd.LIGHTS_PER_PASS),new mr("cc_lightSizeRangeAngle",ci.FLOAT4,kd.LIGHTS_PER_PASS),new mr("cc_lightDir",ci.FLOAT4,kd.LIGHTS_PER_PASS)],1),_d.layouts[kd.NAME]=kd.LAYOUT,_d.bindings[kd.BINDING]=kd.DESCRIPTOR;var Gd=function(){};Gd.LIGHTS_PER_PASS=10;var Hd=function(){};Hd.SIZE=4*(Hd.COUNT=4+(Hd.JOINTS_TEXTURE_INFO_OFFSET=0)),Hd.NAME="CCSkinningTexture",Hd.BINDING=fd.UBO_SKINNING_TEXTURE,Hd.DESCRIPTOR=new Fr(Hd.BINDING,zi.UNIFORM_BUFFER,1,Ai.VERTEX),Hd.LAYOUT=new vr(md.LOCAL,Hd.BINDING,Hd.NAME,[new mr("cc_jointTextureInfo",ci.FLOAT4,1)],1),_d.layouts[Hd.NAME]=Hd.LAYOUT,_d.bindings[Hd.BINDING]=Hd.DESCRIPTOR;var Vd=function(){};Vd.SIZE=4*(Vd.COUNT=4+(Vd.JOINTS_ANIM_INFO_OFFSET=0)),Vd.NAME="CCSkinningAnimation",Vd.BINDING=fd.UBO_SKINNING_ANIMATION,Vd.DESCRIPTOR=new Fr(Vd.BINDING,zi.UNIFORM_BUFFER,1,Ai.VERTEX),Vd.LAYOUT=new vr(md.LOCAL,Vd.BINDING,Vd.NAME,[new mr("cc_jointAnimInfo",ci.FLOAT4,1)],1),_d.layouts[Vd.NAME]=Vd.LAYOUT,_d.bindings[Vd.BINDING]=Vd.DESCRIPTOR;var Wd="a_jointAnimInfo",jd=function(){};jd.SIZE=4*(jd.COUNT=360+(jd.JOINTS_OFFSET=0)),jd.NAME="CCSkinning",jd.BINDING=fd.UBO_SKINNING_TEXTURE,jd.DESCRIPTOR=new Fr(jd.BINDING,zi.UNIFORM_BUFFER,1,Ai.VERTEX),jd.LAYOUT=new vr(md.LOCAL,jd.BINDING,jd.NAME,[new mr("cc_joints",ci.FLOAT4,90)],1),_d.layouts[jd.NAME]=jd.LAYOUT,_d.bindings[jd.BINDING]=jd.DESCRIPTOR;var qd=function(){};qd.MAX_MORPH_TARGET_COUNT=60,qd.OFFSET_OF_WEIGHTS=0,qd.OFFSET_OF_VERTICES_COUNT=4+(qd.OFFSET_OF_DISPLACEMENT_TEXTURE_HEIGHT=4+(qd.OFFSET_OF_DISPLACEMENT_TEXTURE_WIDTH=4*qd.MAX_MORPH_TARGET_COUNT)),qd.COUNT_BASE_4_BYTES=4*Math.ceil(qd.MAX_MORPH_TARGET_COUNT/4)+4,qd.SIZE=4*qd.COUNT_BASE_4_BYTES,qd.NAME="CCMorph",qd.BINDING=fd.UBO_MORPH,qd.DESCRIPTOR=new Fr(qd.BINDING,zi.UNIFORM_BUFFER,1,Ai.VERTEX),qd.LAYOUT=new vr(md.LOCAL,qd.BINDING,qd.NAME,[new mr("cc_displacementWeights",ci.FLOAT4,qd.MAX_MORPH_TARGET_COUNT/4),new mr("cc_displacementTextureInfo",ci.FLOAT4,1)],1),_d.layouts[qd.NAME]=qd.LAYOUT,_d.bindings[qd.BINDING]=qd.DESCRIPTOR;var Xd=function(){};Xd.NAME="CCUILocal",Xd.BINDING=fd.UBO_UI_LOCAL,Xd.DESCRIPTOR=new Fr(Xd.BINDING,zi.DYNAMIC_UNIFORM_BUFFER,1,Ai.VERTEX),Xd.LAYOUT=new vr(md.LOCAL,Xd.BINDING,Xd.NAME,[new mr("cc_local_data",ci.FLOAT4,1)],1),_d.layouts[Xd.NAME]=Xd.LAYOUT,_d.bindings[Xd.BINDING]=Xd.DESCRIPTOR;var Yd=fd.SAMPLER_JOINTS,Kd=new Fr(Yd,zi.SAMPLER_TEXTURE,1,Ai.VERTEX),Qd=new gr(md.LOCAL,Yd,"cc_jointTexture",ci.SAMPLER2D,1);_d.layouts.cc_jointTexture=Qd,_d.bindings[Yd]=Kd;var Jd=fd.SAMPLER_MORPH_POSITION,Zd=new Fr(Jd,zi.SAMPLER_TEXTURE,1,Ai.VERTEX),$d=new gr(md.LOCAL,Jd,"cc_PositionDisplacements",ci.SAMPLER2D,1);_d.layouts.cc_PositionDisplacements=$d,_d.bindings[Jd]=Zd;var ep=fd.SAMPLER_MORPH_NORMAL,tp=new Fr(ep,zi.SAMPLER_TEXTURE,1,Ai.VERTEX),np=new gr(md.LOCAL,ep,"cc_NormalDisplacements",ci.SAMPLER2D,1);_d.layouts.cc_NormalDisplacements=np,_d.bindings[ep]=tp;var ip=fd.SAMPLER_MORPH_TANGENT,rp=new Fr(ip,zi.SAMPLER_TEXTURE,1,Ai.VERTEX),op=new gr(md.LOCAL,ip,"cc_TangentDisplacements",ci.SAMPLER2D,1);_d.layouts.cc_TangentDisplacements=op,_d.bindings[ip]=rp;var ap=fd.SAMPLER_LIGHTMAP,sp=new Fr(ap,zi.SAMPLER_TEXTURE,1,Ai.FRAGMENT),cp=new gr(md.LOCAL,ap,"cc_lightingMap",ci.SAMPLER2D,1);_d.layouts.cc_lightingMap=cp,_d.bindings[ap]=sp;var lp=fd.SAMPLER_SPRITE,up=new Fr(lp,zi.SAMPLER_TEXTURE,1,Ai.FRAGMENT),hp=new gr(md.LOCAL,lp,"cc_spriteTexture",ci.SAMPLER2D,1);_d.layouts.cc_spriteTexture=hp,_d.bindings[lp]=up;var _p=fd.SAMPLER_REFLECTION,fp=new Fr(_p,zi.SAMPLER_TEXTURE,1,Ai.FRAGMENT),dp=new gr(md.LOCAL,_p,"cc_reflectionTexture",ci.SAMPLER2D,1);_d.layouts.cc_reflectionTexture=dp,_d.bindings[_p]=fp;var pp=fd.STORAGE_REFLECTION,mp=new Fr(pp,zi.STORAGE_IMAGE,1,Ai.COMPUTE),vp=new Sr(md.LOCAL,pp,"cc_reflectionStorage",ci.IMAGE2D,1);_d.layouts.cc_reflectionStorage=vp,_d.bindings[pp]=mp;var gp,yp,xp=rd.makeMaskExclude([rd.BitMask.UI_2D,rd.BitMask.GIZMOS,rd.BitMask.EDITOR,rd.BitMask.SCENE_GIZMO,rd.BitMask.PROFILER]),Sp=rd.makeMaskExclude([rd.BitMask.UI_2D,rd.BitMask.PROFILER]),Ep=rd.Enum.ALL;function Tp(e){return(e.getFormatFeatures(ai.R32F)&(mi.RENDER_TARGET|mi.SAMPLED_TEXTURE))==(mi.RENDER_TARGET|mi.SAMPLED_TEXTURE)}e("pipeline",Object.freeze({__proto__:null,PIPELINE_FLOW_MAIN:sd,PIPELINE_FLOW_FORWARD:cd,PIPELINE_FLOW_SHADOW:ld,PIPELINE_FLOW_SMAA:"SMAAFlow",PIPELINE_FLOW_TONEMAP:"ToneMapFlow",get RenderPassStage(){return od},get RenderPriority(){return ad},globalDescriptorSetLayout:hd,localDescriptorSetLayout:_d,get PipelineGlobalBindings(){return ud},get ModelLocalBindings(){return fd},get SetIndex(){return md},bindingMappingInfo:xd,UBOGlobal:Sd,UBOCamera:Ed,UBOShadow:Td,UNIFORM_SHADOWMAP_BINDING:Cd,UNIFORM_ENVIRONMENT_BINDING:wd,UNIFORM_DIFFUSEMAP_BINDING:Rd,UNIFORM_SPOT_LIGHTING_MAP_TEXTURE_BINDING:Nd,UBOLocal:Fd,UBOWorldBound:Bd,INST_MAT_WORLD:zd,UBOLocalBatched:Ud,UBOForwardLight:kd,UBODeferredLight:Gd,JOINT_UNIFORM_CAPACITY:30,UBOSkinningTexture:Hd,UBOSkinningAnimation:Vd,INST_JOINT_ANIM_INFO:Wd,UBOSkinning:jd,UBOMorph:qd,UBOUILocal:Xd,UNIFORM_JOINT_TEXTURE_BINDING:Yd,UNIFORM_POSITION_MORPH_TEXTURE_BINDING:Jd,UNIFORM_NORMAL_MORPH_TEXTURE_BINDING:ep,UNIFORM_TANGENT_MORPH_TEXTURE_BINDING:ip,UNIFORM_LIGHTMAP_TEXTURE_BINDING:ap,UNIFORM_SPRITE_TEXTURE_BINDING:lp,UNIFORM_REFLECTION_TEXTURE_BINDING:_p,UNIFORM_REFLECTION_STORAGE_BINDING:pp,CAMERA_DEFAULT_MASK:xp,CAMERA_EDITOR_MASK:Sp,MODEL_ALWAYS_MASK:Ep,supportsR16HalfFloatTexture:function(e){return(e.getFormatFeatures(ai.R16F)&(mi.RENDER_TARGET|mi.SAMPLED_TEXTURE))==(mi.RENDER_TARGET|mi.SAMPLED_TEXTURE)},supportsR32FloatTexture:Tp}));var Cp=4227858432,bp=66060288,Ap=1044480,wp=function(e,t,n,i){return void 0===i&&(i=0),t<<26&Cp|e<<20&bp|n<<12&Ap|4095&i},Ip=function(e){return(e&Cp)>>>26},Pp=function(e){return(e&bp)>>>20},Rp=function(e){return(e&Ap)>>>12},Dp=function(e){return 4095&e},Op=function(e,t){return 67108863&e|t<<26&Cp},Np=((gp={})[ci.UNKNOWN]=function(){return console.warn("illegal uniform handle")},gp[ci.INT]=function(e,t,n){return void 0===n&&(n=0),e[n]},gp[ci.INT2]=function(e,t,n){return void 0===n&&(n=0),Tn.fromArray(t,e,n)},gp[ci.INT3]=function(e,t,n){return void 0===n&&(n=0),yn.fromArray(t,e,n)},gp[ci.INT4]=function(e,t,n){return void 0===n&&(n=0),wn.fromArray(t,e,n)},gp[ci.FLOAT]=function(e,t,n){return void 0===n&&(n=0),e[n]},gp[ci.FLOAT2]=function(e,t,n){return void 0===n&&(n=0),Tn.fromArray(t,e,n)},gp[ci.FLOAT3]=function(e,t,n){return void 0===n&&(n=0),yn.fromArray(t,e,n)},gp[ci.FLOAT4]=function(e,t,n){return void 0===n&&(n=0),wn.fromArray(t,e,n)},gp[ci.MAT3]=function(e,t,n){return void 0===n&&(n=0),Pn.fromArray(t,e,n)},gp[ci.MAT4]=function(e,t,n){return void 0===n&&(n=0),kn.fromArray(t,e,n)},gp),Mp=((yp={})[ci.UNKNOWN]=function(){return console.warn("illegal uniform handle")},yp[ci.INT]=function(e,t,n){return void 0===n&&(n=0),e[n]=t},yp[ci.INT2]=function(e,t,n){return void 0===n&&(n=0),Tn.toArray(e,t,n)},yp[ci.INT3]=function(e,t,n){return void 0===n&&(n=0),yn.toArray(e,t,n)},yp[ci.INT4]=function(e,t,n){return void 0===n&&(n=0),wn.toArray(e,t,n)},yp[ci.FLOAT]=function(e,t,n){return void 0===n&&(n=0),e[n]=t},yp[ci.FLOAT2]=function(e,t,n){return void 0===n&&(n=0),Tn.toArray(e,t,n)},yp[ci.FLOAT3]=function(e,t,n){return void 0===n&&(n=0),yn.toArray(e,t,n)},yp[ci.FLOAT4]=function(e,t,n){return void 0===n&&(n=0),wn.toArray(e,t,n)},yp[ci.MAT3]=function(e,t,n){return void 0===n&&(n=0),Pn.toArray(e,t,n)},yp[ci.MAT4]=function(e,t,n){return void 0===n&&(n=0),kn.toArray(e,t,n)},yp),Lp=[Object.freeze([0]),Object.freeze([0,0]),Object.freeze([0,0,0,0]),Object.freeze([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])];function Fp(e){switch(e){case ci.BOOL:case ci.INT:case ci.UINT:case ci.FLOAT:return Lp[0];case ci.BOOL2:case ci.INT2:case ci.UINT2:case ci.FLOAT2:return Lp[1];case ci.BOOL4:case ci.INT4:case ci.UINT4:case ci.FLOAT4:return Lp[2];case ci.MAT4:return Lp[3];case ci.SAMPLER2D:return"default-texture";case ci.SAMPLER_CUBE:return"default-cube-texture"}return Lp[0]}function Bp(e,t){for(var n=Object.entries(t),i=!1,r=0;r<n.length;r++)e[n[r][0]]!==n[r][1]&&(e[n[r][0]]=n[r][1],i=!0);return i}var zp=new Br;function Up(e){return Math.ceil(Math.log2(Math.max(e,2)))}function kp(e,t){switch(e.type){case"boolean":return"number"==typeof t?t.toString():t?"1":"0";case"string":return void 0!==t?t:e.options[0];case"number":return void 0!==t?t.toString():e.range[0].toString();default:return console.warn("unknown define type '"+e.type+"'"),"-1"}}function Gp(e,t,n,i,r){for(var o=e.builtins[i],a=[],s=function(e){var t=o.blocks[e],i=n.layouts[t.name],s=i&&n.bindings.find((function(e){return e.binding===i.binding}));if(!(i&&s&&s.descriptorType&Qr))return console.warn("builtin UBO '"+t.name+"' not available!"),"continue";a.push(i),r&&!r.includes(s)&&r.push(s)},c=0;c<o.blocks.length;c++)s(c);Array.prototype.unshift.apply(t.shaderInfo.blocks,a);for(var l=[],u=function(e){var t=o.samplerTextures[e],i=n.layouts[t.name],a=i&&n.bindings.find((function(e){return e.binding===i.binding}));if(!(i&&a&&a.descriptorType&Jr))return console.warn("builtin samplerTexture '"+t.name+"' not available!"),"continue";l.push(i),r&&!r.includes(a)&&r.push(a)},h=0;h<o.samplerTextures.length;h++)u(h);Array.prototype.unshift.apply(t.shaderInfo.samplerTextures,l),r&&r.sort((function(e,t){return e.binding-t.binding}))}function Hp(e){return e.members.reduce((function(e,t){return e+ro(t.type)*t.count}),0)}function Vp(e,t){for(var n=0;n<e.length;n++){var i=e[n];if("!"===i[0]){if(t[i.slice(1)])return!1}else if(!t[i])return!1}return!0}function Wp(e){switch(e.gfxAPI){case ii.GLES2:case ii.WEBGL:return"glsl1";case ii.GLES3:case ii.WEBGL2:return"glsl3";default:return"glsl4"}}var jp,qp,Xp,Yp,Kp,Qp,Jp,Zp,$p=new(function(){function e(){this._templates={},this._cache={},this._templateInfos={}}var t=e.prototype;return t.register=function(e){for(var t=0;t<e.shaders.length;t++)this.define(e.shaders[t]).effectName=e.name;for(var n=0;n<e.techniques.length;n++)for(var i=e.techniques[n],r=0;r<i.passes.length;r++){var o=i.passes[r];void 0!==o.propertyIndex&&void 0===o.properties&&(o.properties=i.passes[o.propertyIndex].properties)}},t.define=function(e){var t=this._templates[e.name];if(t&&t.hash===e.hash)return t;for(var n=_({},e),i=0,r=function(e){var t=n.defines[e],r=1;if("number"===t.type){var o=t.range;r=Up(o[1]-o[0]+1),t._map=function(e){return e-o[0]}}else"string"===t.type?(r=Up(t.options.length),t._map=function(e){return Math.max(0,t.options.findIndex((function(t){return t===e})))}):"boolean"===t.type&&(t._map=function(e){return e?1:0});t._offset=i,i+=r},o=0;o<n.defines.length;o++)r(o);for(var a in i>31&&(n.uber=!0),n.constantMacros="",n.builtins.statistics)n.constantMacros+="#define "+a+" "+n.builtins.statistics[a]+"\n";if(this._templates[e.name]=n,!this._templateInfos[n.hash]){var s={};s.samplerStartBinding=n.blocks.length,s.shaderInfo=new Ar,s.blockSizes=[],s.bindings=[];for(var c=0;c<n.blocks.length;c++){var l=n.blocks[c];s.blockSizes.push(Hp(l)),s.bindings.push(new Fr(l.binding,zi.UNIFORM_BUFFER,1,l.stageFlags)),s.shaderInfo.blocks.push(new vr(md.MATERIAL,l.binding,l.name,l.members.map((function(e){return new mr(e.name,e.type,e.count)})),1))}for(var u=0;u<n.samplerTextures.length;u++){var h=n.samplerTextures[u];s.bindings.push(new Fr(h.binding,zi.SAMPLER_TEXTURE,h.count,h.stageFlags)),s.shaderInfo.samplerTextures.push(new gr(md.MATERIAL,h.binding,h.name,h.type,h.count))}for(var f=0;f<n.samplers.length;f++){var d=n.samplers[f];s.bindings.push(new Fr(d.binding,zi.SAMPLER,d.count,d.stageFlags)),s.shaderInfo.samplers.push(new yr(md.MATERIAL,d.binding,d.name,d.count))}for(var p=0;p<n.textures.length;p++){var m=n.textures[p];s.bindings.push(new Fr(m.binding,zi.TEXTURE,m.count,m.stageFlags)),s.shaderInfo.textures.push(new xr(md.MATERIAL,m.binding,m.name,m.type,m.count))}for(var v=0;v<n.buffers.length;v++){var g=n.buffers[v];s.bindings.push(new Fr(g.binding,zi.STORAGE_BUFFER,1,g.stageFlags)),s.shaderInfo.buffers.push(new Er(md.MATERIAL,g.binding,g.name,1,g.memoryAccess))}for(var y=0;y<n.images.length;y++){var x=n.images[y];s.bindings.push(new Fr(x.binding,zi.STORAGE_IMAGE,x.count,x.stageFlags)),s.shaderInfo.images.push(new Sr(md.MATERIAL,x.binding,x.name,x.type,x.count,x.memoryAccess))}for(var S=0;S<n.subpassInputs.length;S++){var E=n.subpassInputs[S];s.bindings.push(new Fr(E.binding,zi.INPUT_ATTACHMENT,E.count,E.stageFlags)),s.shaderInfo.subpassInputs.push(new Tr(md.MATERIAL,E.binding,E.name,E.count))}s.gfxAttributes=[];for(var T=0;T<n.attributes.length;T++){var C=n.attributes[T];s.gfxAttributes.push(new br(C.name,C.format,C.isNormalized,0,C.isInstanced,C.location))}Gp(n,s,_d,"locals"),s.shaderInfo.stages.push(new Cr(Ai.VERTEX,"")),s.shaderInfo.stages.push(new Cr(Ai.FRAGMENT,"")),s.handleMap=function(e){for(var t={},n=0;n<e.blocks.length;n++)for(var i=e.blocks[n],r=i.members,o=0,a=0;a<r.length;a++){var s=r[a];t[s.name]=wp(i.binding,s.type,s.count,o),o+=(ro(s.type)>>2)*s.count}for(var c=0;c<e.samplerTextures.length;c++){var l=e.samplerTextures[c];t[l.name]=wp(l.binding,l.type,l.count)}return t}(n),s.setLayouts=[],this._templateInfos[n.hash]=s}return n},t.getTemplate=function(e){return this._templates[e]},t.getTemplateInfo=function(e){var t=this._templates[e].hash;return this._templateInfos[t]},t.getDescriptorSetLayout=function(e,t,n){void 0===n&&(n=!1);var i=this._templates[t],r=this._templateInfos[i.hash];return r.setLayouts.length||(zp.bindings=r.bindings,r.setLayouts[md.MATERIAL]=e.createDescriptorSetLayout(zp),zp.bindings=_d.bindings,r.setLayouts[md.LOCAL]=e.createDescriptorSetLayout(zp)),r.setLayouts[n?md.LOCAL:md.MATERIAL]},t.hasProgram=function(e){return void 0!==this._templates[e]},t.getKey=function(e,t){var n=this._templates[e],i=n.defines;if(n.uber){for(var r="",o=0;o<i.length;o++){var a=i[o],s=t[a.name];if(s&&a._map){var c=a._map(s);r+=""+a._offset+c+"|"}}return""+r+n.hash}for(var l=0,u=0;u<i.length;u++){var h=i[u],_=t[h.name];_&&h._map&&(l|=h._map(_)<<h._offset)}return l.toString(16)+"|"+n.hash},t.destroyShaderByDefines=function(e){var t=this,n=Object.keys(e);if(n.length)for(var i=n.map((function(t){var n=e[t];return"boolean"==typeof n&&(n=n?"1":"0"),new RegExp(""+t+n)})),r=Object.keys(this._cache).filter((function(e){return i.every((function(n){return n.test(t._cache[e].name)}))})),o=0;o<r.length;o++){var a=r[o],s=this._cache[a];U("destroyed shader "+s.name),s.destroy(),delete this._cache[a]}},t.getGFXShader=function(e,t,n,i,r){Object.assign(n,i.macros),r||(r=this.getKey(t,n));var o=this._cache[r];if(o)return o;var a=this._templates[t],s=this._templateInfos[a.hash];s.pipelineLayout||(this.getDescriptorSetLayout(e,t),Gp(a,s,hd,"globals"),s.setLayouts[md.GLOBAL]=i.descriptorSetLayout,s.pipelineLayout=e.createPipelineLayout(new Ur(s.setLayouts)));var c=function(e,t){for(var n=[],i=0;i<t.length;i++){var r=t[i],o=r.name,a=e[o],s=kp(r,a),c=!a||"0"===a;n.push({name:o,value:s,isDefault:c})}return n}(n,a.defines),l=i.constantMacros+a.constantMacros+c.reduce((function(e,t){return e+"#define "+t.name+" "+t.value+"\n"}),""),u=a.glsl3,h=Wp(e);return h?u=a[h]:console.error("Invalid GFX API!"),s.shaderInfo.stages[0].source=l+u.vert,s.shaderInfo.stages[1].source=l+u.frag,s.shaderInfo.attributes=function(e,t,n){for(var i=[],r=e.attributes,o=t.gfxAttributes,a=0;a<r.length;a++)Vp(r[a].defines,n)&&i.push(o[a]);return i}(a,s,n),s.shaderInfo.name=function(e,t){return e+t.reduce((function(e,t){return t.isDefault?e:e+"|"+t.name+t.value}),"")}(t,c),this._cache[r]=e.createShader(s.shaderInfo)},e}());b.programLib=$p;var em=e("EffectAsset",dc("cc.EffectAsset")((Zp=Jp=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return E(t=e.call.apply(e,[this].concat(i))||this,"techniques",Xp,y(t)),E(t,"shaders",Yp,y(t)),E(t,"combinations",Kp,y(t)),E(t,"hideInEditor",Qp,y(t)),t}f(t,e),t.register=function(e){t._effects[e.name]=e},t.remove=function(e){if("string"!=typeof e)t._effects[e.name]&&t._effects[e.name]===e&&delete t._effects[e.name];else{if(t._effects[e])return void delete t._effects[e];for(var n in t._effects)if(t._effects[n]._uuid===e)return void delete t._effects[n]}},t.get=function(e){if(t._effects[e])return t._effects[e];for(var n in t._effects)if(t._effects[n]._uuid===e)return t._effects[n];return null},t.getAll=function(){return t._effects};var n=t.prototype;return n.onLoaded=function(){$p.register(this),t.register(this),b.game.once(b.Game.EVENT_ENGINE_INITED,this._precompile,this)},n._precompile=function(){for(var e=this,t=b.director.root,n=function(n){var i=e.shaders[n],r=e.combinations[n];if(!r)return"continue";Object.keys(r).reduce((function(e,t){return e.reduce((function(e,n){for(var i=r[t],o=0;o<i.length;++o){var a=_({},n);a[t]=i[o],e.push(a)}return e}),[])}),[{}]).forEach((function(e){return $p.getGFXShader(t.device,i.name,e,t.pipeline)}))},i=0;i<this.shaders.length;i++)n(i)},n.destroy=function(){return t.remove(this),e.prototype.destroy.call(this)},n.initDefault=function(n){e.prototype.initDefault.call(this,n);var i=t.get("unlit");this.name="unlit",this.shaders=i.shaders,this.combinations=i.combinations,this.techniques=i.techniques},n.validate=function(){return this.techniques.length>0&&this.shaders.length>0},t}(yu),Jp._effects={},Xp=T((qp=Zp).prototype,"techniques",[Ec,Nc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Yp=T(qp.prototype,"shaders",[Ec,Nc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Kp=T(qp.prototype,"combinations",[Ec,Nc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Qp=T(qp.prototype,"hideInEditor",[Ec,Cc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),jp=qp))||jp);b.EffectAsset=em;var tm,nm,im,rm,om,am,sm,cm,lm,um,hm,_m,fm,dm,pm,mm=1024;!function(e){e[e.RGB565=ai.R5G6B5]="RGB565",e[e.RGB5A1=ai.RGB5A1]="RGB5A1",e[e.RGBA4444=ai.RGBA4]="RGBA4444",e[e.RGB888=ai.RGB8]="RGB888",e[e.RGB32F=ai.RGB32F]="RGB32F",e[e.RGBA8888=ai.RGBA8]="RGBA8888",e[e.RGBA32F=ai.RGBA32F]="RGBA32F",e[e.A8=ai.A8]="A8",e[e.I8=ai.L8]="I8",e[e.AI8=ai.LA8]="AI8",e[e.RGB_PVRTC_2BPPV1=ai.PVRTC_RGB2]="RGB_PVRTC_2BPPV1",e[e.RGBA_PVRTC_2BPPV1=ai.PVRTC_RGBA2]="RGBA_PVRTC_2BPPV1",e[e.RGB_A_PVRTC_2BPPV1=mm++]="RGB_A_PVRTC_2BPPV1",e[e.RGB_PVRTC_4BPPV1=ai.PVRTC_RGB4]="RGB_PVRTC_4BPPV1",e[e.RGBA_PVRTC_4BPPV1=ai.PVRTC_RGBA4]="RGBA_PVRTC_4BPPV1",e[e.RGB_A_PVRTC_4BPPV1=mm++]="RGB_A_PVRTC_4BPPV1",e[e.RGB_ETC1=ai.ETC_RGB8]="RGB_ETC1",e[e.RGBA_ETC1=mm++]="RGBA_ETC1",e[e.RGB_ETC2=ai.ETC2_RGB8]="RGB_ETC2",e[e.RGBA_ETC2=ai.ETC2_RGBA8]="RGBA_ETC2",e[e.RGBA_ASTC_4x4=ai.ASTC_RGBA_4X4]="RGBA_ASTC_4x4",e[e.RGBA_ASTC_5x4=ai.ASTC_RGBA_5X4]="RGBA_ASTC_5x4",e[e.RGBA_ASTC_5x5=ai.ASTC_RGBA_5X5]="RGBA_ASTC_5x5",e[e.RGBA_ASTC_6x5=ai.ASTC_RGBA_6X5]="RGBA_ASTC_6x5",e[e.RGBA_ASTC_6x6=ai.ASTC_RGBA_6X6]="RGBA_ASTC_6x6",e[e.RGBA_ASTC_8x5=ai.ASTC_RGBA_8X5]="RGBA_ASTC_8x5",e[e.RGBA_ASTC_8x6=ai.ASTC_RGBA_8X6]="RGBA_ASTC_8x6",e[e.RGBA_ASTC_8x8=ai.ASTC_RGBA_8X8]="RGBA_ASTC_8x8",e[e.RGBA_ASTC_10x5=ai.ASTC_RGBA_10X5]="RGBA_ASTC_10x5",e[e.RGBA_ASTC_10x6=ai.ASTC_RGBA_10X6]="RGBA_ASTC_10x6",e[e.RGBA_ASTC_10x8=ai.ASTC_RGBA_10X8]="RGBA_ASTC_10x8",e[e.RGBA_ASTC_10x10=ai.ASTC_RGBA_10X10]="RGBA_ASTC_10x10",e[e.RGBA_ASTC_12x10=ai.ASTC_RGBA_12X10]="RGBA_ASTC_12x10",e[e.RGBA_ASTC_12x12=ai.ASTC_RGBA_12X12]="RGBA_ASTC_12x12"}(tm||(tm={})),function(e){e[e.REPEAT=xi.WRAP]="REPEAT",e[e.CLAMP_TO_EDGE=xi.CLAMP]="CLAMP_TO_EDGE",e[e.MIRRORED_REPEAT=xi.MIRROR]="MIRRORED_REPEAT",e[e.CLAMP_TO_BORDER=xi.BORDER]="CLAMP_TO_BORDER"}(nm||(nm={})),function(e){e[e.NONE=yi.NONE]="NONE",e[e.LINEAR=yi.LINEAR]="LINEAR",e[e.NEAREST=yi.POINT]="NEAREST"}(im||(im={})),et(ai);var vm,gm,ym,xm,Sm=new ce("Tex"),Em=dc("cc.TextureBase")((pm=dm=function(e){function t(){var t;return E(t=e.call(this)||this,"_format",am,y(t)),E(t,"_minFilter",sm,y(t)),E(t,"_magFilter",cm,y(t)),E(t,"_mipFilter",lm,y(t)),E(t,"_wrapS",um,y(t)),E(t,"_wrapT",hm,y(t)),E(t,"_wrapR",_m,y(t)),E(t,"_anisotropy",fm,y(t)),t._width=1,t._height=1,t._id=void 0,t._samplerInfo=new pr,t._gfxSampler=null,t._gfxDevice=null,t._textureHash=0,t._id=Sm.getNewId(),t._gfxDevice=t._getGFXDevice(),t._textureHash=po(t._id,666),t}f(t,e);var n=t.prototype;return n.getId=function(){return this._id},n.getPixelFormat=function(){return this._format},n.getAnisotropy=function(){return this._anisotropy},n.setWrapMode=function(e,t,n){void 0===n&&(n=e),this._wrapS=e,this._samplerInfo.addressU=e,this._wrapT=t,this._samplerInfo.addressV=t,this._wrapR=n,this._samplerInfo.addressW=n,this._gfxDevice&&(this._gfxSampler=this._gfxDevice.getSampler(this._samplerInfo))},n.setFilters=function(e,t){this._minFilter=e,this._samplerInfo.minFilter=e,this._magFilter=t,this._samplerInfo.magFilter=t,this._gfxDevice&&(this._gfxSampler=this._gfxDevice.getSampler(this._samplerInfo))},n.setMipFilter=function(e){this._mipFilter=e,this._samplerInfo.mipFilter=e,this._gfxDevice&&(this._gfxSampler=this._gfxDevice.getSampler(this._samplerInfo))},n.setAnisotropy=function(e){this._anisotropy=e,this._samplerInfo.maxAnisotropy=e,this._gfxDevice&&(this._gfxSampler=this._gfxDevice.getSampler(this._samplerInfo))},n.destroy=function(){var t,n=e.prototype.destroy.call(this);return n&&(null===(t=b.director.root)||void 0===t?void 0:t.batcher2D)&&b.director.root.batcher2D._releaseDescriptorSetCache(this._textureHash),n},n.getHash=function(){return this._textureHash},n.getGFXTexture=function(){return null},n.getSamplerInfo=function(){return this._samplerInfo},n.getGFXSampler=function(){return this._gfxSampler||(this._gfxDevice?this._gfxSampler=this._gfxDevice.getSampler(this._samplerInfo):Y(9302)),this._gfxSampler},n._serialize=function(){return""},n._deserialize=function(e){var t=e.split(",");t.unshift(""),t.length>=5&&(this.setFilters(parseInt(t[1]),parseInt(t[2])),this.setWrapMode(parseInt(t[3]),parseInt(t[4]))),t.length>=7&&(this.setMipFilter(parseInt(t[5])),this.setAnisotropy(parseInt(t[6])))},n._getGFXDevice=function(){return b.director.root?b.director.root.device:null},n._getGFXFormat=function(){return this._getGFXPixelFormat(this._format)},n._setGFXFormat=function(e){this._format=void 0===e?tm.RGBA8888:e},n._getGFXPixelFormat=function(e){return e===tm.RGBA_ETC1?e=tm.RGB_ETC1:e===tm.RGB_A_PVRTC_4BPPV1?e=tm.RGB_PVRTC_4BPPV1:e===tm.RGB_A_PVRTC_2BPPV1&&(e=tm.RGB_PVRTC_2BPPV1),e},h(t,[{key:"isCompressed",get:function(){return this._format>=tm.RGB_ETC1&&this._format<=tm.RGBA_ASTC_12x12||this._format>=tm.RGB_A_PVRTC_2BPPV1&&this._format<=tm.RGBA_ETC1}},{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}}]),t}(yu),dm.PixelFormat=tm,dm.WrapMode=nm,dm.Filter=im,am=T((om=pm).prototype,"_format",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return tm.RGBA8888}}),sm=T(om.prototype,"_minFilter",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return im.LINEAR}}),cm=T(om.prototype,"_magFilter",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return im.LINEAR}}),lm=T(om.prototype,"_mipFilter",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return im.NONE}}),um=T(om.prototype,"_wrapS",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return nm.REPEAT}}),hm=T(om.prototype,"_wrapT",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return nm.REPEAT}}),_m=T(om.prototype,"_wrapR",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return nm.REPEAT}}),fm=T(om.prototype,"_anisotropy",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),rm=om))||rm;function Tm(e){return!!(b.sys.hasFeature(b.sys.Feature.IMAGE_BITMAP)&&e instanceof ImageBitmap)}b.TextureBase=Em;var Cm=e("ImageAsset",dc("cc.ImageAsset")((xm=ym=function(e){function t(t){var n;return(n=e.call(this)||this)._nativeData=void 0,n._exportedExts=void 0,n._format=tm.RGBA8888,n._width=0,n._height=0,n._nativeData={_data:null,width:0,height:0,format:0,_compressed:!1},void 0!==t&&n.reset(t),n}f(t,e);var n=t.prototype;return n.reset=function(e){Tm(e)||e instanceof HTMLElement?this._nativeData=e:(this._nativeData=e,this._format=e.format)},n.destroy=function(){return this.data&&this.data instanceof HTMLImageElement?(this.data.src="",this._setRawAsset("")):Tm(this.data)&&this.data.close&&this.data.close(),e.prototype.destroy.call(this)},n._serialize=function(){},n._deserialize=function(e){var n="";"string"==typeof e?n=e:(this._width=e.w,this._height=e.h,n=e.fmt);for(var i,r=b.director.root?b.director.root.device:null,o=n.split("_"),a=Number.MAX_VALUE,s=this._format,c="",l=b.macro.SUPPORT_TEXTURE_FORMATS,u=S(o);!(i=u()).done;){var h=i.value.split("@"),_=parseInt(h[0],void 0),f=t.extnames[_]||h[0],d=l.indexOf(f);if(-1!==d&&d<a){var p=h[1]?parseInt(h[1]):this._format;if(!(".astc"!==f||r&&r.getFormatFeatures(ai.ASTC_RGBA_4X4)&mi.SAMPLED_TEXTURE))continue;if(!(".pvr"!==f||r&&r.getFormatFeatures(ai.PVRTC_RGBA4)&mi.SAMPLED_TEXTURE))continue;if(!(p!==tm.RGB_ETC1&&p!==tm.RGBA_ETC1||r&&r.getFormatFeatures(ai.ETC_RGB8)&mi.SAMPLED_TEXTURE))continue;if(!(p!==tm.RGB_ETC2&&p!==tm.RGBA_ETC2||r&&r.getFormatFeatures(ai.ETC2_RGB8)&mi.SAMPLED_TEXTURE))continue;if(".webp"===f&&!b.sys.hasFeature(b.sys.Feature.WEBP))continue;a=d,c=f,s=p}}c?(this._setRawAsset(c),this._format=s):q(3121)},n.initDefault=function(n){if(e.prototype.initDefault.call(this,n),t._sharedPlaceHolderCanvas)this.reset(t._sharedPlaceHolderCanvas);else{var i=document.createElement("canvas"),r=i.getContext("2d"),o=i.width=i.height=2;r.fillStyle="#ff00ff",r.fillRect(0,0,o,o),this.reset(i),t._sharedPlaceHolderCanvas=i}},n.validate=function(){return!!this.data},h(t,[{key:"_nativeAsset",get:function(){return this._nativeData},set:function(e){e instanceof HTMLElement||Tm(e)||(e.format=e.format||this._format),this.reset(e)}},{key:"data",get:function(){return this._nativeData&&((e=this._nativeData)instanceof HTMLImageElement||e instanceof HTMLCanvasElement||Tm(e))?this._nativeData:this._nativeData&&this._nativeData._data;var e}},{key:"width",get:function(){return this._nativeData.width||this._width}},{key:"height",get:function(){return this._nativeData.height||this._height}},{key:"format",get:function(){return this._format}},{key:"isCompressed",get:function(){return this._format>=tm.RGB_ETC1&&this._format<=tm.RGBA_ASTC_12x12||this._format>=tm.RGB_A_PVRTC_2BPPV1&&this._format<=tm.RGBA_ETC1}},{key:"url",get:function(){return this.nativeUrl}}]),t}(yu),ym.extnames=[".png",".jpg",".jpeg",".bmp",".webp",".pvr",".pkm",".astc"],ym._sharedPlaceHolderCanvas=null,T((gm=xm).prototype,"_nativeAsset",[$c],Object.getOwnPropertyDescriptor(gm.prototype,"_nativeAsset"),gm.prototype),vm=gm))||vm);b.ImageAsset=Cm;var bm=new WeakMap,Am=new WeakSet,wm=new WeakSet;function Im(e,t){var n;n=Vu.safeFindClass;var i,r=hh.pool.get();try{i=Th(e,r,{classFinder:n,customEnv:t})}catch(e){throw B(e),hh.pool.put(r),e}i._uuid=t.__uuid__||"";for(var o=r.uuidList,a=r.uuidObjList,s=r.uuidPropList,c=r.uuidTypeList||[],l=[],u=0;u<o.length;u++){var h=o[u];l[u]={uuid:bl(h),owner:a[u],prop:s[u],type:Ke._getClassById(c[u])}}return bm.set(i,l),i._native&&Am.add(i),hh.pool.put(r),i}var Pm,Rm=new(function(){function e(){this._depends=new cl}var t=e.prototype;return t.init=function(){this._depends.clear()},t.getNativeDep=function(e){var t=this._depends.get(e);return t&&t.nativeDep?_({},t.nativeDep):null},t.getDeps=function(e){return this._depends.has(e)?this._depends.get(e).deps:[]},t.getDepsRecursively=function(e){var t=Object.create(null),n=[];return this._descend(e,t,n),n},t.remove=function(e){this._depends.remove(e)},t.parse=function(e,t){var n,i,r=null;if(Array.isArray(t)||t.__type__||t instanceof $u){if(this._depends.has(e))return this._depends.get(e);if(!Array.isArray(t)||"number"==typeof(i=(n=t[5])[n.length-1])&&i<0)try{var o=Im(t,{__uuid__:e});(r=this._parseDepsFromAsset(o)).nativeDep&&(r.nativeDep.uuid=e),fl.add(e+"@import",o)}catch(t){_l.remove(e+"@import"),r={deps:[]}}else r={deps:this._parseDepsFromJson(t)}}else{if(this._depends.has(e)&&(r=this._depends.get(e)).parsedFromExistAsset)return r;r=this._parseDepsFromAsset(t)}return this._depends.add(e,r),r},t._parseDepsFromAsset=function(e){for(var t={deps:[],parsedFromExistAsset:!0},n=bm.get(e),i=0,r=n.length;i<r;i++)t.deps.push(n[i].uuid);return Am.has(e)&&(t.nativeDep=e._nativeDep),t},t._parseDepsFromJson=function(e){var t=function(e){return n=(t=e)[1],t[10].map((function(e){return n[e]}));var t,n}(e);return t.forEach((function(e,n){return t[n]=bl(e)})),t},t._descend=function(e,t,n){for(var i=this.getDeps(e),r=0;r<i.length;r++){var o=i[r];t[o]||(t[o]=!0,n.push(o),this._descend(o,t,n))}},e}()),Dm=[new nr];function Om(e){return e&&0==(e&e-1)}var Nm,Mm,Lm,Fm,Bm,zm,Um=dc("cc.SimpleTexture")(Pm=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gfxTexture=null,t._gfxTextureView=null,t._mipmapLevel=1,t._textureWidth=0,t._textureHeight=0,t._baseLevel=0,t._maxLevel=1e3,t}f(t,e);var n=t.prototype;return n.getGFXTexture=function(){return this._gfxTextureView},n.destroy=function(){return this._tryDestroyTextureView(),this._tryDestroyTexture(),e.prototype.destroy.call(this)},n.updateImage=function(){this.updateMipmaps(0)},n.updateMipmaps=function(){},n.uploadData=function(e,t,n){if(void 0===t&&(t=0),void 0===n&&(n=0),this._gfxTexture&&!(this._mipmapLevel<=t)){var i=this._getGFXDevice();if(i){var r=Dm[0];r.texExtent.width=this._textureWidth>>t,r.texExtent.height=this._textureHeight>>t,r.texSubres.mipLevel=t,r.texSubres.baseArrayLayer=n,ArrayBuffer.isView(e)?i.copyBuffersToTexture([e],this._gfxTexture,Dm):i.copyTexImagesToTexture([e],this._gfxTexture,Dm)}}},n._assignImage=function(e,t,n){var i=e.data;if(i&&(this.uploadData(i,t,n),this._checkTextureLoaded(),nt.CLEANUP_IMAGE_CACHE)){var r=Rm.getDeps(this._uuid),o=r.indexOf(e._uuid);-1!==o&&(re(r,o),e.decRef())}},n._checkTextureLoaded=function(){this._textureReady()},n._textureReady=function(){this.loaded=!0,this.emit("load")},n._setMipmapLevel=function(e){this._mipmapLevel=e<1?1:e},n._setMipRange=function(e,t){this._baseLevel=e<1?0:e,this._maxLevel=t<1?0:t},n.setMipRange=function(e,t){J(e<=t,3124),this._setMipRange(e,t);var n=this._getGFXDevice();if(n){var i=this._createTextureView(n);this._tryDestroyTextureView(),this._gfxTextureView=i}},n._getGfxTextureCreateInfo=function(){return null},n._getGfxTextureViewCreateInfo=function(){return null},n._tryReset=function(){if(this._tryDestroyTextureView(),this._tryDestroyTexture(),0!==this._mipmapLevel){var e=this._getGFXDevice();e&&(this._createTexture(e),this._gfxTextureView=this._createTextureView(e))}},n._createTexture=function(e){if(0!==this._width&&0!==this._height){var t=pi.NONE;this._mipFilter!==im.NONE&&function(e,t,n){return!(e.gfxAPI===ii.WEBGL)||Om(t)&&Om(n)}(e,this._width,this._height)&&(this._mipmapLevel=function(e,t){for(var n=Math.max(e,t),i=0;n;)n>>=1,i++;return i}(this._width,this._height),t=pi.GEN_MIPMAP);var n=this._getGfxTextureCreateInfo({usage:di.SAMPLED|di.TRANSFER_DST,format:this._getGFXFormat(),levelCount:this._mipmapLevel,flags:t});if(n){var i=e.createTexture(n);this._textureWidth=n.width,this._textureHeight=n.height,this._gfxTexture=i}}},n._createTextureView=function(e){if(!this._gfxTexture)return null;var t=this._maxLevel<this._mipmapLevel?this._maxLevel:this._mipmapLevel-1,n=this._getGfxTextureViewCreateInfo({texture:this._gfxTexture,format:this._getGFXFormat(),baseLevel:this._baseLevel,levelCount:t-this._baseLevel+1});return n?e.createTexture(n):null},n._tryDestroyTexture=function(){this._gfxTexture&&(this._gfxTexture.destroy(),this._gfxTexture=null)},n._tryDestroyTextureView=function(){this._gfxTextureView&&(this._gfxTextureView.destroy(),this._gfxTextureView=null)},h(t,[{key:"mipmapLevel",get:function(){return this._mipmapLevel}}]),t}(Em))||Pm;b.SimpleTexture=Um;var km,Gm,Hm,Vm,Wm,jm,qm,Xm=e("Texture2D",(Nm=dc("cc.Texture2D"),Mm=Jc([Cm]),Nm((zm=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return E(t=e.call.apply(e,[this].concat(i))||this,"_mipmaps",Bm,y(t)),t}f(t,e);var n=t.prototype;return n.initialize=function(){this.mipmaps=this._mipmaps},n.onLoaded=function(){this.initialize()},n.reset=function(e){this._width=e.width,this._height=e.height,this._setGFXFormat(e.format);var t=void 0===e.mipmapLevel?1:e.mipmapLevel;this._setMipmapLevel(t);var n=void 0===e.baseLevel?0:e.baseLevel,i=void 0===e.maxLevel?1e3:e.maxLevel;this._setMipRange(n,i),this._tryReset()},n.create=function(e,t,n,i,r,o){void 0===n&&(n=tm.RGBA8888),void 0===i&&(i=1),void 0===r&&(r=0),void 0===o&&(o=1e3),this.reset({width:e,height:t,format:n,mipmapLevel:i,baseLevel:r,maxLevel:o})},n.toString=function(){return 0!==this._mipmaps.length?this._mipmaps[0].url:""},n.updateMipmaps=function(e,t){if(void 0===e&&(e=0),!(e>=this._mipmaps.length))for(var n=Math.min(void 0===t?this._mipmaps.length:t,this._mipmaps.length-e),i=0;i<n;++i){var r=e+i;this._assignImage(this._mipmaps[r],r)}},n.getHtmlElementObj=function(){return this._mipmaps[0]&&this._mipmaps[0].data instanceof HTMLElement?this._mipmaps[0].data:null},n.destroy=function(){return this._mipmaps=[],e.prototype.destroy.call(this)},n.description=function(){return"<cc.Texture2D | Name = "+(this._mipmaps[0]?this._mipmaps[0].url:"")+" | Dimension = "+this.width+" x "+this.height+">"},n.releaseTexture=function(){this.destroy()},n._serialize=function(){return null},n._deserialize=function(t,n){var i=t;e.prototype._deserialize.call(this,i.base,n),this._mipmaps=new Array(i.mipmaps.length);for(var r=0;r<i.mipmaps.length;++r)if(this._mipmaps[r]=new Cm,i.mipmaps[r]){var o=i.mipmaps[r];n.result.push(this._mipmaps,""+r,o,Ke._getClassId(Cm))}},n._getGfxTextureCreateInfo=function(e){var t=new fr(fi.TEX2D);return t.width=this._width,t.height=this._height,Object.assign(t,e),t},n._getGfxTextureViewCreateInfo=function(e){var t=new dr;return t.type=fi.TEX2D,Object.assign(t,e),t},n.initDefault=function(t){e.prototype.initDefault.call(this,t);var n=new Cm;n.initDefault(),this.image=n},n.validate=function(){return this.mipmaps&&0!==this.mipmaps.length},h(t,[{key:"mipmaps",get:function(){return this._mipmaps},set:function(e){var t=this;if(this._mipmaps=e,this._setMipmapLevel(this._mipmaps.length),this._mipmaps.length>0){var n=this._mipmaps[0];this.reset({width:n.width,height:n.height,format:n.format,mipmapLevel:this._mipmaps.length,baseLevel:this._baseLevel,maxLevel:this._maxLevel}),this._mipmaps.forEach((function(e,n){t._assignImage(e,n)}))}else this.reset({width:0,height:0,mipmapLevel:this._mipmaps.length,baseLevel:this._baseLevel,maxLevel:this._maxLevel})}},{key:"image",get:function(){return 0===this._mipmaps.length?null:this._mipmaps[0]},set:function(e){this.mipmaps=e?[e]:[]}}]),t}(Um),Bm=T((Fm=zm).prototype,"_mipmaps",[Mm],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Lm=Fm))||Lm));b.Texture2D=Xm,function(e){e[e.right=0]="right",e[e.left=1]="left",e[e.top=2]="top",e[e.bottom=3]="bottom",e[e.front=4]="front",e[e.back=5]="back"}(qm||(qm={}));var Ym=e("TextureCube",dc("cc.TextureCube")((jm=Wm=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return E(t=e.call.apply(e,[this].concat(i))||this,"isRGBE",Hm,y(t)),E(t,"_mipmaps",Vm,y(t)),t}f(t,e),t.fromTexture2DArray=function(e,n){for(var i=[],r=e.length/6,o=0;o<r;o++){var a=6*o;i.push({front:e[a+qm.front].image,back:e[a+qm.back].image,left:e[a+qm.left].image,right:e[a+qm.right].image,top:e[a+qm.top].image,bottom:e[a+qm.bottom].image})}return(n=n||new t).mipmaps=i,n};var n=t.prototype;return n.onLoaded=function(){this.mipmaps=this._mipmaps},n.reset=function(e){this._width=e.width,this._height=e.height,this._setGFXFormat(e.format);var t=void 0===e.mipmapLevel?1:e.mipmapLevel;this._setMipmapLevel(t);var n=void 0===e.baseLevel?0:e.baseLevel,i=void 0===e.maxLevel?1e3:e.maxLevel;this._setMipRange(n,i),this._tryReset()},n.updateMipmaps=function(e,t){var n=this;if(void 0===e&&(e=0),!(e>=this._mipmaps.length))for(var i=Math.min(void 0===t?this._mipmaps.length:t,this._mipmaps.length-e),r=function(t){var i=e+t;Km(n._mipmaps[i],(function(e,t){n._assignImage(e,i,t)}))},o=0;o<i;++o)r(o)},n.destroy=function(){return this._mipmaps=[],e.prototype.destroy.call(this)},n.releaseTexture=function(){this.mipmaps=[]},n._serialize=function(){return null},n._deserialize=function(t,n){var i=t;e.prototype._deserialize.call(this,i.base,n),this.isRGBE=i.rgbe,this._mipmaps=new Array(i.mipmaps.length);for(var r=0;r<i.mipmaps.length;++r){this._mipmaps[r]={front:new Cm,back:new Cm,left:new Cm,right:new Cm,top:new Cm,bottom:new Cm};var o=i.mipmaps[r],a=Ke._getClassId(Cm);n.result.push(this._mipmaps[r],"front",o.front,a),n.result.push(this._mipmaps[r],"back",o.back,a),n.result.push(this._mipmaps[r],"left",o.left,a),n.result.push(this._mipmaps[r],"right",o.right,a),n.result.push(this._mipmaps[r],"top",o.top,a),n.result.push(this._mipmaps[r],"bottom",o.bottom,a)}},n._getGfxTextureCreateInfo=function(e){var t=new fr(fi.CUBE);return t.width=this._width,t.height=this._height,t.layerCount=6,Object.assign(t,e),t},n._getGfxTextureViewCreateInfo=function(e){var t=new dr;return t.type=fi.CUBE,t.baseLayer=0,t.layerCount=6,Object.assign(t,e),t},n.initDefault=function(t){e.prototype.initDefault.call(this,t);var n=new Cm;n.initDefault(),this.mipmaps=[{front:n,back:n,top:n,bottom:n,left:n,right:n}]},n.validate=function(){return 0!==this._mipmaps.length&&!this._mipmaps.find((function(e){return!(e.top&&e.bottom&&e.front&&e.back&&e.left&&e.right)}))},h(t,[{key:"mipmaps",get:function(){return this._mipmaps},set:function(e){var t=this;if(this._mipmaps=e,this._setMipmapLevel(this._mipmaps.length),this._mipmaps.length>0){var n=this._mipmaps[0].front;this.reset({width:n.width,height:n.height,format:n.format,mipmapLevel:this._mipmaps.length,baseLevel:this._baseLevel,maxLevel:this._maxLevel}),this._mipmaps.forEach((function(e,n){Km(e,(function(e,i){t._assignImage(e,n,i)}))}))}else this.reset({width:0,height:0,mipmapLevel:this._mipmaps.length,baseLevel:this._baseLevel,maxLevel:this._maxLevel})}},{key:"image",get:function(){return 0===this._mipmaps.length?null:this._mipmaps[0]},set:function(e){this.mipmaps=e?[e]:[]}}]),t}(Um),Wm.FaceIndex=qm,Hm=T((Gm=jm).prototype,"isRGBE",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Vm=T(Gm.prototype,"_mipmaps",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),km=Gm))||km);function Km(e,t){t(e.front,qm.front),t(e.back,qm.back),t(e.left,qm.left),t(e.right,qm.right),t(e.top,qm.top),t(e.bottom,qm.bottom)}b.TextureCube=Ym;var Qm,Jm,Zm,$m=e("effects",[{name:"billboard",techniques:[{name:"add",passes:[{rasterizerState:{cullMode:0},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:1,blendSrcAlpha:2,blendDstAlpha:1}]},program:"billboard|vert:vs_main|tinted-fs:add",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},mainTiling_Offset:{value:[1,1,0,0],type:16},tintColor:{value:[.5,.5,.5,.5],type:16}}}]}],shaders:[{name:"billboard|vert:vs_main|tinted-fs:add",hash:3642336485,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:54,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:40},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplerTextures:[],buffers:[],images:[]}},defines:[],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_texCoord",defines:[],format:21,location:1},{name:"a_color",defines:[],format:44,location:2}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:1,members:[{name:"mainTiling_Offset",type:16,count:1},{name:"frameTile_velLenScale",type:16,count:1},{name:"scale",type:16,count:1},{name:"nodeRotation",type:16,count:1}]},{name:"builtin",defines:[],binding:1,stageFlags:1,members:[{name:"cc_size_rotation",type:16,count:1}]},{name:"FragConstants",defines:[],binding:2,stageFlags:16,members:[{name:"tintColor",type:16,count:1}]}],samplerTextures:[{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:3}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"clear-stencil",techniques:[{passes:[{blendState:{targets:[{blend:!0}]},rasterizerState:{cullMode:0},program:"clear-stencil|sprite-vs:vert|sprite-fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1}}]}],shaders:[{name:"clear-stencil|sprite-vs:vert|sprite-fs:frag",hash:3507038093,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:0,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:0},globals:{blocks:[],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[],samplerTextures:[],buffers:[],images:[]}},defines:[],attributes:[{name:"a_position",defines:[],format:32,location:0}],blocks:[],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"geometry-renderer",techniques:[{passes:[{primitive:1,blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},program:"geometry-renderer|line-vs:vert|line-fs:front",priority:245,depthStencilState:{depthTest:!1,depthWrite:!1}}]},{passes:[{primitive:1,blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},program:"geometry-renderer|line-vs:vert|line-fs:front",priority:245,depthStencilState:{depthTest:!0,depthWrite:!1}},{primitive:1,blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},program:"geometry-renderer|line-vs:vert|line-fs:back",priority:245,depthStencilState:{depthTest:!0,depthWrite:!1,depthFunc:4}}]},{passes:[{primitive:1,blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},program:"geometry-renderer|dashed-line-vs:vert|dashed-line-fs:front",priority:245,depthStencilState:{depthTest:!1,depthWrite:!1}}]},{passes:[{primitive:1,blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},program:"geometry-renderer|dashed-line-vs:vert|dashed-line-fs:front",priority:245,depthStencilState:{depthTest:!0,depthWrite:!1}},{primitive:1,blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},program:"geometry-renderer|dashed-line-vs:vert|dashed-line-fs:back",priority:245,depthStencilState:{depthTest:!0,depthWrite:!1,depthFunc:4}}]},{passes:[{rasterizerState:{cullMode:2},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},program:"geometry-renderer|triangle-vs:vert|triangle-fs:front",priority:245,depthStencilState:{depthTest:!1,depthWrite:!1}}]},{passes:[{rasterizerState:{cullMode:2},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},program:"geometry-renderer|triangle-vs:vert|triangle-fs:front",priority:245,depthStencilState:{depthTest:!0,depthWrite:!1}},{rasterizerState:{cullMode:2},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},program:"geometry-renderer|triangle-vs:vert|triangle-fs:back",priority:245,depthStencilState:{depthTest:!0,depthWrite:!1,depthFunc:4}}]}],shaders:[{name:"geometry-renderer|line-vs:vert|line-fs:front",hash:3617431e3,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:39,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:39},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[],samplerTextures:[],buffers:[],images:[]}},defines:[{name:"USE_FORWARD_PIPELINE",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_color",defines:[],format:44,location:1}],blocks:[],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]},{name:"geometry-renderer|line-vs:vert|line-fs:back",hash:4168905198,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:39,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:39},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[],samplerTextures:[],buffers:[],images:[]}},defines:[{name:"USE_FORWARD_PIPELINE",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_color",defines:[],format:44,location:1}],blocks:[],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]},{name:"geometry-renderer|dashed-line-vs:vert|dashed-line-fs:front",hash:4034582016,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:39,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:39},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[],samplerTextures:[],buffers:[],images:[]}},defines:[{name:"USE_FORWARD_PIPELINE",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_color",defines:[],format:44,location:1}],blocks:[],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]},{name:"geometry-renderer|dashed-line-vs:vert|dashed-line-fs:back",hash:1762165009,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:39,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:39},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[],samplerTextures:[],buffers:[],images:[]}},defines:[{name:"USE_FORWARD_PIPELINE",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_color",defines:[],format:44,location:1}],blocks:[],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]},{name:"geometry-renderer|triangle-vs:vert|triangle-fs:front",hash:4143142643,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:39,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:39},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[],samplerTextures:[],buffers:[],images:[]}},defines:[{name:"USE_FORWARD_PIPELINE",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:44,location:1},{name:"a_color",defines:[],format:44,location:2}],blocks:[],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]},{name:"geometry-renderer|triangle-vs:vert|triangle-fs:back",hash:826026446,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:39,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:39},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[],samplerTextures:[],buffers:[],images:[]}},defines:[{name:"USE_FORWARD_PIPELINE",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:44,location:1},{name:"a_color",defines:[],format:44,location:2}],blocks:[],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"graphics",techniques:[{passes:[{blendState:{targets:[{blend:!0,blendSrc:1,blendDst:4,blendSrcAlpha:1,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"graphics|vs:vert|fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1}}]}],shaders:[{name:"graphics|vs:vert|fs:frag",hash:4284763886,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:49,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:0},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplerTextures:[],buffers:[],images:[]}},defines:[],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_color",defines:[],format:44,location:1},{name:"a_dist",defines:[],format:11,location:2}],blocks:[],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"occlusion-query",techniques:[{passes:[{rasterizerState:{cullMode:2},blendState:{targets:[{blendColorMask:0}]},program:"occlusion-query|occlusion-query-vs:vert|occlusion-query-fs:frag",depthStencilState:{depthTest:!0,depthWrite:!1}}]}],shaders:[{name:"occlusion-query|occlusion-query-vs:vert|occlusion-query-fs:frag",hash:1571978323,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:41,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:0},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCWorldBound",defines:[]}],samplerTextures:[],buffers:[],images:[]}},defines:[],attributes:[{name:"a_position",defines:[],format:32,location:0}],blocks:[],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"particle-gpu",techniques:[{name:"add",passes:[{rasterizerState:{cullMode:0},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:1,blendSrcAlpha:2,blendDstAlpha:1}]},program:"particle-gpu|particle-vs-gpu:gpvs_main|tinted-fs:add",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},mainTiling_Offset:{value:[1,1,0,0],type:16},tintColor:{value:[.5,.5,.5,.5],type:16}}}]}],shaders:[{name:"particle-gpu|particle-vs-gpu:gpvs_main|tinted-fs:add",hash:851293782,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:64,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:40},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplerTextures:[],buffers:[],images:[]}},defines:[{name:"CC_RENDER_MODE",type:"number",range:[0,4]},{name:"USE_VK_SHADER",type:"boolean"},{name:"COLOR_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"ROTATION_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"SIZE_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"FORCE_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"VELOCITY_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"TEXTURE_ANIMATION_MODULE_ENABLE",type:"boolean"},{name:"CC_USE_WORLD_SPACE",type:"boolean"}],attributes:[{name:"a_position_starttime",defines:[],format:44,location:0},{name:"a_size_uv",defines:[],format:44,location:1},{name:"a_rotation_uv",defines:[],format:44,location:2},{name:"a_color",defines:[],format:44,location:3},{name:"a_dir_life",defines:[],format:44,location:4},{name:"a_rndSeed",defines:[],format:11,location:5},{name:"a_texCoord",defines:["CC_RENDER_MODE"],format:32,location:6},{name:"a_texCoord3",defines:["CC_RENDER_MODE"],format:32,location:7},{name:"a_normal",defines:["CC_RENDER_MODE"],format:32,location:8},{name:"a_color1",defines:["CC_RENDER_MODE"],format:44,location:9}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:1,members:[{name:"mainTiling_Offset",type:16,count:1},{name:"frameTile_velLenScale",type:16,count:1},{name:"scale",type:16,count:1},{name:"nodeRotation",type:16,count:1}]},{name:"SampleConstants",defines:[],binding:1,stageFlags:1,members:[{name:"u_sampleInfo",type:16,count:1}]},{name:"TickConstants",defines:[],binding:2,stageFlags:1,members:[{name:"u_worldRot",type:16,count:1},{name:"u_timeDelta",type:16,count:1}]},{name:"ColorConstant",defines:["COLOR_OVER_TIME_MODULE_ENABLE"],binding:3,stageFlags:1,members:[{name:"u_color_mode",type:5,count:1}]},{name:"RotationConstant",defines:["ROTATION_OVER_TIME_MODULE_ENABLE"],binding:4,stageFlags:1,members:[{name:"u_rotation_mode",type:5,count:1}]},{name:"SizeConstant",defines:["SIZE_OVER_TIME_MODULE_ENABLE"],binding:5,stageFlags:1,members:[{name:"u_size_mode",type:5,count:1}]},{name:"ForceConstant",defines:["FORCE_OVER_TIME_MODULE_ENABLE"],binding:6,stageFlags:1,members:[{name:"u_force_mode",type:5,count:1},{name:"u_force_space",type:5,count:1}]},{name:"VelocityConstant",defines:["VELOCITY_OVER_TIME_MODULE_ENABLE"],binding:7,stageFlags:1,members:[{name:"u_velocity_mode",type:5,count:1},{name:"u_velocity_space",type:5,count:1}]},{name:"AnimationConstant",defines:["TEXTURE_ANIMATION_MODULE_ENABLE"],binding:8,stageFlags:1,members:[{name:"u_anim_info",type:16,count:1}]},{name:"FragConstants",defines:[],binding:9,stageFlags:16,members:[{name:"tintColor",type:16,count:1}]}],samplerTextures:[{name:"color_over_time_tex0",type:28,count:1,defines:["COLOR_OVER_TIME_MODULE_ENABLE"],stageFlags:1,binding:10},{name:"rotation_over_time_tex0",type:28,count:1,defines:["ROTATION_OVER_TIME_MODULE_ENABLE"],stageFlags:1,binding:11},{name:"size_over_time_tex0",type:28,count:1,defines:["SIZE_OVER_TIME_MODULE_ENABLE"],stageFlags:1,binding:12},{name:"force_over_time_tex0",type:28,count:1,defines:["FORCE_OVER_TIME_MODULE_ENABLE"],stageFlags:1,binding:13},{name:"velocity_over_time_tex0",type:28,count:1,defines:["VELOCITY_OVER_TIME_MODULE_ENABLE"],stageFlags:1,binding:14},{name:"texture_animation_tex0",type:28,count:1,defines:["TEXTURE_ANIMATION_MODULE_ENABLE"],stageFlags:1,binding:15},{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:16}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"particle-trail",techniques:[{name:"add",passes:[{rasterizerState:{cullMode:0},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:1,blendSrcAlpha:2,blendDstAlpha:1}]},program:"particle-trail|particle-trail:vs_main|tinted-fs:add",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},mainTiling_Offset:{value:[1,1,0,0],type:16},frameTile_velLenScale:{value:[1,1,0,0],type:16},tintColor:{value:[.5,.5,.5,.5],type:16}}}]}],shaders:[{name:"particle-trail|particle-trail:vs_main|tinted-fs:add",hash:2502358098,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:53,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:40},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplerTextures:[],buffers:[],images:[]}},defines:[{name:"CC_RENDER_MODE",type:"number",range:[0,4]},{name:"CC_DRAW_WIRE_FRAME",type:"boolean"},{name:"CC_USE_WORLD_SPACE",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_texCoord",defines:[],format:44,location:1},{name:"a_texCoord1",defines:[],format:32,location:2},{name:"a_texCoord2",defines:[],format:32,location:3},{name:"a_color",defines:[],format:44,location:4}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:1,members:[{name:"mainTiling_Offset",type:16,count:1},{name:"frameTile_velLenScale",type:16,count:1},{name:"scale",type:16,count:1},{name:"nodeRotation",type:16,count:1}]},{name:"FragConstants",defines:[],binding:1,stageFlags:16,members:[{name:"tintColor",type:16,count:1}]}],samplerTextures:[{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:2}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"particle",techniques:[{name:"add",passes:[{rasterizerState:{cullMode:0},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:1,blendSrcAlpha:2,blendDstAlpha:1}]},program:"particle|particle-vs-legacy:lpvs_main|tinted-fs:add",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},mainTiling_Offset:{value:[1,1,0,0],type:16},tintColor:{value:[.5,.5,.5,.5],type:16}}}]}],shaders:[{name:"particle|particle-vs-legacy:lpvs_main|tinted-fs:add",hash:585841727,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:53,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:40},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplerTextures:[],buffers:[],images:[]}},defines:[{name:"CC_RENDER_MODE",type:"number",range:[0,4]},{name:"CC_USE_WORLD_SPACE",type:"boolean"},{name:"ROTATION_OVER_TIME_MODULE_ENABLE",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_texCoord",defines:[],format:32,location:1},{name:"a_texCoord1",defines:[],format:32,location:2},{name:"a_texCoord2",defines:[],format:32,location:3},{name:"a_color",defines:[],format:44,location:4},{name:"a_color1",defines:["CC_RENDER_MODE"],format:32,location:8},{name:"a_texCoord3",defines:["CC_RENDER_MODE"],format:32,location:6},{name:"a_normal",defines:["CC_RENDER_MODE"],format:32,location:7}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:1,members:[{name:"mainTiling_Offset",type:16,count:1},{name:"frameTile_velLenScale",type:16,count:1},{name:"scale",type:16,count:1},{name:"nodeRotation",type:16,count:1}]},{name:"FragConstants",defines:[],binding:1,stageFlags:16,members:[{name:"tintColor",type:16,count:1}]}],samplerTextures:[{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:2}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"spine",techniques:[{passes:[{blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"spine|sprite-vs:vert|sprite-fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1},properties:{alphaThreshold:{value:[.5],type:13}}}]}],shaders:[{name:"spine|sprite-vs:vert|sprite-fs:frag",hash:2499219289,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:49,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:1},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:["USE_LOCAL"]}],samplerTextures:[{name:"cc_spriteTexture",defines:[]}],buffers:[],images:[]}},defines:[{name:"USE_LOCAL",type:"boolean"},{name:"TWO_COLORED",type:"boolean"},{name:"USE_ALPHA_TEST",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_texCoord",defines:[],format:21,location:1},{name:"a_color",defines:[],format:44,location:2},{name:"a_color2",defines:["TWO_COLORED"],format:44,location:3}],blocks:[{name:"ALPHA_TEST_DATA",defines:["USE_ALPHA_TEST"],binding:0,stageFlags:16,members:[{name:"alphaThreshold",type:13,count:1}]}],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"sprite",techniques:[{passes:[{blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"sprite|sprite-vs:vert|sprite-fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1},properties:{alphaThreshold:{value:[.5],type:13}}}]}],shaders:[{name:"sprite|sprite-vs:vert|sprite-fs:frag",hash:67215139,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:49,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:1},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:["USE_LOCAL"]}],samplerTextures:[{name:"cc_spriteTexture",defines:["USE_TEXTURE"]}],buffers:[],images:[]}},defines:[{name:"USE_LOCAL",type:"boolean"},{name:"SAMPLE_FROM_RT",type:"boolean"},{name:"USE_PIXEL_ALIGNMENT",type:"boolean"},{name:"CC_USE_EMBEDDED_ALPHA",type:"boolean"},{name:"USE_ALPHA_TEST",type:"boolean"},{name:"USE_TEXTURE",type:"boolean"},{name:"IS_GRAY",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_texCoord",defines:[],format:21,location:1},{name:"a_color",defines:[],format:44,location:2}],blocks:[{name:"ALPHA_TEST_DATA",defines:["USE_ALPHA_TEST"],binding:0,stageFlags:16,members:[{name:"alphaThreshold",type:13,count:1}]}],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"standard",techniques:[{name:"opaque",passes:[{program:"standard|standard-vs|standard-fs",properties:{tilingOffset:{value:[1,1,0,0],type:16},mainColor:{value:[1,1,1,1],linear:!0,type:16,handleInfo:["albedo",0,16]},albedoScale:{value:[1,1,1],type:15,handleInfo:["albedoScaleAndCutoff",0,15]},alphaThreshold:{value:[.5],type:13,handleInfo:["albedoScaleAndCutoff",3,13]},occlusion:{value:[1],type:13,handleInfo:["pbrParams",0,13]},roughness:{value:[.8],type:13,handleInfo:["pbrParams",1,13]},metallic:{value:[.6],type:13,handleInfo:["pbrParams",2,13]},specularIntensity:{value:[.5],type:13,handleInfo:["pbrParams",3,13]},emissive:{value:[0,0,0,1],linear:!0,type:16},emissiveScale:{value:[1,1,1],type:15,handleInfo:["emissiveScaleParam",0,15]},normalStrength:{value:[1],type:13,handleInfo:["emissiveScaleParam",3,13]},mainTexture:{value:"grey",type:28,handleInfo:["albedoMap",0,28]},normalMap:{value:"normal",type:28},pbrMap:{value:"grey",type:28},metallicRoughnessMap:{value:"grey",type:28},occlusionMap:{value:"white",type:28},emissiveMap:{value:"grey",type:28},albedo:{type:16,value:[1,1,1,1]},albedoScaleAndCutoff:{type:16,value:[1,1,1,.5]},pbrParams:{type:16,value:[1,.8,.6,.5]},emissiveScaleParam:{type:16,value:[1,1,1,1]},albedoMap:{type:28,value:"grey"}}},{phase:"forward-add",propertyIndex:0,embeddedMacros:{CC_FORWARD_ADD:!0},blendState:{targets:[{blend:!0,blendSrc:1,blendDst:1,blendSrcAlpha:0,blendDstAlpha:1}]},program:"standard|standard-vs|standard-fs",depthStencilState:{depthFunc:2,depthTest:!0,depthWrite:!1}},{phase:"shadow-caster",propertyIndex:0,rasterizerState:{cullMode:1},program:"standard|shadow-caster-vs:vert|shadow-caster-fs:frag",properties:{tilingOffset:{value:[1,1,0,0],type:16},mainColor:{value:[1,1,1,1],type:16,handleInfo:["albedo",0,16]},albedoScale:{value:[1,1,1],type:15,handleInfo:["albedoScaleAndCutoff",0,15]},alphaThreshold:{value:[.5],type:13,handleInfo:["albedoScaleAndCutoff",3,13]},mainTexture:{value:"grey",type:28,handleInfo:["albedoMap",0,28]},albedo:{type:16,value:[1,1,1,1]},albedoScaleAndCutoff:{type:16,value:[1,1,1,.5]},albedoMap:{type:28,value:"grey"}}}]}],shaders:[{name:"standard|standard-vs|standard-fs",hash:4079105024,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:223,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:75},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]},{name:"CCShadow",defines:[]}],samplerTextures:[{name:"cc_shadowMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_spotLightingMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_environment",defines:["CC_USE_IBL"]},{name:"cc_diffuseMap",defines:["CC_USE_DIFFUSEMAP"]}],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]},{name:"CCLocalBatched",defines:["!USE_INSTANCING","USE_BATCHING"]},{name:"CCLocal",defines:["!USE_INSTANCING","!USE_BATCHING"]},{name:"CCForwardLight",defines:["CC_FORWARD_ADD","CC_ENABLE_CLUSTERED_LIGHT_CULLING"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"cc_lightingMap",defines:["CC_USE_LIGHTMAP","!USE_BATCHING","!CC_FORWARD_ADD"]}],buffers:[],images:[]}},defines:[{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"CC_USE_LIGHTMAP",type:"boolean"},{name:"CC_RECEIVE_SHADOW",type:"boolean"},{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_FOG",type:"number",range:[0,4]},{name:"CC_USE_ACCURATE_FOG",type:"boolean"},{name:"USE_VERTEX_COLOR",type:"boolean"},{name:"HAS_SECOND_UV",type:"boolean"},{name:"USE_NORMAL_MAP",type:"boolean"},{name:"CC_FORWARD_ADD",type:"boolean"},{name:"USE_TWOSIDE",type:"boolean"},{name:"SAMPLE_FROM_RT",type:"boolean"},{name:"CC_USE_IBL",type:"number",range:[0,2]},{name:"CC_USE_DIFFUSEMAP",type:"number",range:[0,2]},{name:"USE_REFLECTION_DENOISE",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"},{name:"USE_ALBEDO_MAP",type:"boolean"},{name:"ALBEDO_UV",type:"string",options:["v_uv","v_uv1"]},{name:"NORMAL_UV",type:"string",options:["v_uv","v_uv1"]},{name:"PBR_UV",type:"string",options:["v_uv","v_uv1"]},{name:"USE_PBR_MAP",type:"boolean"},{name:"USE_METALLIC_ROUGHNESS_MAP",type:"boolean"},{name:"USE_OCCLUSION_MAP",type:"boolean"},{name:"USE_EMISSIVE_MAP",type:"boolean"},{name:"EMISSIVE_UV",type:"string",options:["v_uv","v_uv1"]},{name:"USE_ALPHA_TEST",type:"boolean"},{name:"ALPHA_TEST_CHANNEL",type:"string",options:["a","r"]},{name:"CC_PIPELINE_TYPE",type:"number",range:[0,1]},{name:"CC_FORCE_FORWARD_SHADING",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["USE_INSTANCING","CC_USE_BAKED_ANIMATION"],format:44,isInstanced:!0,location:6},{name:"a_matWorld0",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:7},{name:"a_matWorld1",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:8},{name:"a_matWorld2",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:9},{name:"a_lightingMapUVParam",defines:["USE_INSTANCING","CC_USE_LIGHTMAP"],format:44,isInstanced:!0,location:10},{name:"a_localShadowBias",defines:["USE_INSTANCING","CC_RECEIVE_SHADOW"],format:21,isInstanced:!0,location:11},{name:"a_dyn_batch_id",defines:["!USE_INSTANCING","USE_BATCHING"],format:11,location:12},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:13},{name:"a_color",defines:["USE_VERTEX_COLOR"],format:44,location:14},{name:"a_texCoord1",defines:[],format:21,location:15}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:17,members:[{name:"tilingOffset",type:16,count:1},{name:"albedo",type:16,count:1},{name:"albedoScaleAndCutoff",type:16,count:1},{name:"pbrParams",type:16,count:1},{name:"emissive",type:16,count:1},{name:"emissiveScaleParam",type:16,count:1}]}],samplerTextures:[{name:"albedoMap",type:28,count:1,defines:["USE_ALBEDO_MAP"],stageFlags:16,binding:1},{name:"normalMap",type:28,count:1,defines:["USE_NORMAL_MAP"],stageFlags:16,binding:2},{name:"pbrMap",type:28,count:1,defines:["USE_PBR_MAP"],stageFlags:16,binding:3},{name:"metallicRoughnessMap",type:28,count:1,defines:["USE_METALLIC_ROUGHNESS_MAP"],stageFlags:16,binding:4},{name:"occlusionMap",type:28,count:1,defines:["USE_OCCLUSION_MAP"],stageFlags:16,binding:5},{name:"emissiveMap",type:28,count:1,defines:["USE_EMISSIVE_MAP"],stageFlags:16,binding:6}],buffers:[{name:"b_ccLightsBuffer",memoryAccess:1,defines:["CC_FORWARD_ADD","CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:7},{name:"b_clusterLightIndicesBuffer",memoryAccess:1,defines:["CC_FORWARD_ADD","CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:8},{name:"b_clusterLightGridBuffer",memoryAccess:1,defines:["CC_FORWARD_ADD","CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:9}],images:[],textures:[],samplers:[],subpassInputs:[]},{name:"standard|shadow-caster-vs:vert|shadow-caster-fs:frag",hash:3928335406,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:184,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:75},globals:{blocks:[{name:"CCShadow",defines:[]},{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[{name:"cc_shadowMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_spotLightingMap",defines:["CC_RECEIVE_SHADOW"]}],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]},{name:"CCLocalBatched",defines:["!USE_INSTANCING","USE_BATCHING"]},{name:"CCLocal",defines:["!USE_INSTANCING","!USE_BATCHING"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}],buffers:[],images:[]}},defines:[{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"CC_USE_LIGHTMAP",type:"boolean"},{name:"CC_RECEIVE_SHADOW",type:"boolean"},{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"HAS_SECOND_UV",type:"boolean"},{name:"USE_ALBEDO_MAP",type:"boolean"},{name:"ALBEDO_UV",type:"string",options:["v_uv","v_uv1"]},{name:"USE_ALPHA_TEST",type:"boolean"},{name:"ALPHA_TEST_CHANNEL",type:"string",options:["a","r"]}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["USE_INSTANCING","CC_USE_BAKED_ANIMATION"],format:44,isInstanced:!0,location:6},{name:"a_matWorld0",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:7},{name:"a_matWorld1",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:8},{name:"a_matWorld2",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:9},{name:"a_lightingMapUVParam",defines:["USE_INSTANCING","CC_USE_LIGHTMAP"],format:44,isInstanced:!0,location:10},{name:"a_localShadowBias",defines:["USE_INSTANCING","CC_RECEIVE_SHADOW"],format:21,isInstanced:!0,location:11},{name:"a_dyn_batch_id",defines:["!USE_INSTANCING","USE_BATCHING"],format:11,location:12},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:13},{name:"a_texCoord1",defines:[],format:21,location:14}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:17,members:[{name:"tilingOffset",type:16,count:1},{name:"albedo",type:16,count:1},{name:"albedoScaleAndCutoff",type:16,count:1},{name:"pbrParams",type:16,count:1},{name:"emissive",type:16,count:1},{name:"emissiveScaleParam",type:16,count:1}]}],samplerTextures:[{name:"albedoMap",type:28,count:1,defines:["USE_ALBEDO_MAP"],stageFlags:16,binding:1}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"terrain",techniques:[{name:"opaque",passes:[{program:"terrain|terrain-vs|terrain-fs",properties:{UVScale:{value:[1,1,1,1],type:16},lightMapUVParam:{value:[0,0,0,0],type:16},metallic:{value:[0,0,0,0],type:16},roughness:{value:[1,1,1,1],type:16},weightMap:{value:"black",type:28},detailMap0:{value:"grey",type:28},detailMap1:{value:"grey",type:28},detailMap2:{value:"grey",type:28},detailMap3:{value:"grey",type:28},normalMap0:{value:"normal",type:28},normalMap1:{value:"normal",type:28},normalMap2:{value:"normal",type:28},normalMap3:{value:"normal",type:28},lightMap:{value:"grey",type:28}}},{phase:"forward-add",propertyIndex:0,embeddedMacros:{CC_FORWARD_ADD:!0},blendState:{targets:[{blend:!0,blendSrc:1,blendDst:1,blendSrcAlpha:0,blendDstAlpha:1}]},program:"terrain|terrain-vs|terrain-fs",depthStencilState:{depthFunc:2,depthTest:!0,depthWrite:!1},properties:{UVScale:{value:[1,1,1,1],type:16},lightMapUVParam:{value:[0,0,0,0],type:16},metallic:{value:[0,0,0,0],type:16},roughness:{value:[1,1,1,1],type:16},weightMap:{value:"black",type:28},detailMap0:{value:"grey",type:28},detailMap1:{value:"grey",type:28},detailMap2:{value:"grey",type:28},detailMap3:{value:"grey",type:28},normalMap0:{value:"normal",type:28},normalMap1:{value:"normal",type:28},normalMap2:{value:"normal",type:28},normalMap3:{value:"normal",type:28},lightMap:{value:"grey",type:28}}},{phase:"shadow-add",propertyIndex:0,rasterizerState:{cullMode:2},program:"terrain|shadow-caster-vs:vert|shadow-caster-fs:frag"}]}],shaders:[{name:"terrain|terrain-vs|terrain-fs",hash:3669699677,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:71,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:71},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]},{name:"CCShadow",defines:[]}],samplerTextures:[{name:"cc_shadowMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_spotLightingMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_environment",defines:["CC_USE_IBL"]},{name:"cc_diffuseMap",defines:["CC_USE_DIFFUSEMAP"]}],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:[]},{name:"CCForwardLight",defines:["CC_FORWARD_ADD","CC_ENABLE_CLUSTERED_LIGHT_CULLING"]}],samplerTextures:[{name:"cc_lightingMap",defines:["CC_USE_LIGHTMAP","!USE_BATCHING","!CC_FORWARD_ADD"]}],buffers:[],images:[]}},defines:[{name:"CC_USE_FOG",type:"number",range:[0,4]},{name:"CC_USE_ACCURATE_FOG",type:"boolean"},{name:"CC_RECEIVE_SHADOW",type:"boolean"},{name:"CC_USE_LIGHTMAP",type:"boolean"},{name:"CC_USE_IBL",type:"number",range:[0,2]},{name:"CC_USE_DIFFUSEMAP",type:"number",range:[0,2]},{name:"USE_REFLECTION_DENOISE",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"CC_FORWARD_ADD",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"},{name:"LAYERS",type:"number",range:[0,4]},{name:"USE_NORMALMAP",type:"boolean"},{name:"USE_PBR",type:"boolean"},{name:"CC_PIPELINE_TYPE",type:"number",range:[0,1]},{name:"CC_FORCE_FORWARD_SHADING",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2}],blocks:[{name:"TexCoords",defines:[],binding:0,stageFlags:1,members:[{name:"UVScale",type:16,count:1},{name:"lightMapUVParam",type:16,count:1}]},{name:"PbrParams",defines:[],binding:1,stageFlags:16,members:[{name:"metallic",type:16,count:1},{name:"roughness",type:16,count:1}]}],samplerTextures:[{name:"weightMap",type:28,count:1,defines:[],stageFlags:16,binding:2},{name:"detailMap0",type:28,count:1,defines:[],stageFlags:16,binding:3},{name:"detailMap1",type:28,count:1,defines:[],stageFlags:16,binding:4},{name:"detailMap2",type:28,count:1,defines:[],stageFlags:16,binding:5},{name:"detailMap3",type:28,count:1,defines:[],stageFlags:16,binding:6},{name:"normalMap0",type:28,count:1,defines:[],stageFlags:16,binding:7},{name:"normalMap1",type:28,count:1,defines:[],stageFlags:16,binding:8},{name:"normalMap2",type:28,count:1,defines:[],stageFlags:16,binding:9},{name:"normalMap3",type:28,count:1,defines:[],stageFlags:16,binding:10},{name:"lightMap",type:28,count:1,defines:[],stageFlags:16,binding:11}],buffers:[{name:"b_ccLightsBuffer",memoryAccess:1,defines:["CC_FORWARD_ADD","CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:12},{name:"b_clusterLightIndicesBuffer",memoryAccess:1,defines:["CC_FORWARD_ADD","CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:13},{name:"b_clusterLightGridBuffer",memoryAccess:1,defines:["CC_FORWARD_ADD","CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:14}],images:[],textures:[],samplers:[],subpassInputs:[]},{name:"terrain|shadow-caster-vs:vert|shadow-caster-fs:frag",hash:2218105608,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:69,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:0},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]},{name:"CCShadow",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplerTextures:[],buffers:[],images:[]}},defines:[],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2}],blocks:[],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"unlit",techniques:[{name:"opaque",passes:[{program:"unlit|unlit-vs:vert|unlit-fs:frag",properties:{mainTexture:{value:"grey",type:28},tilingOffset:{value:[1,1,0,0],type:16},mainColor:{value:[1,1,1,1],linear:!0,type:16},colorScale:{value:[1,1,1],type:15,handleInfo:["colorScaleAndCutoff",0,15]},alphaThreshold:{value:[.5],type:13,handleInfo:["colorScaleAndCutoff",3,13]},color:{linear:!0,type:16,handleInfo:["mainColor",0,16]},colorScaleAndCutoff:{type:16,value:[1,1,1,.5]}}}]}],shaders:[{name:"unlit|unlit-vs:vert|unlit-fs:frag",hash:3152709001,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:198,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:41},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]},{name:"CCLocalBatched",defines:["!USE_INSTANCING","USE_BATCHING"]},{name:"CCLocal",defines:["!USE_INSTANCING","!USE_BATCHING"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}],buffers:[],images:[]}},defines:[{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"CC_USE_LIGHTMAP",type:"boolean"},{name:"CC_RECEIVE_SHADOW",type:"boolean"},{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_FOG",type:"number",range:[0,4]},{name:"CC_USE_ACCURATE_FOG",type:"boolean"},{name:"USE_VERTEX_COLOR",type:"boolean"},{name:"USE_TEXTURE",type:"boolean"},{name:"SAMPLE_FROM_RT",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"},{name:"USE_ALPHA_TEST",type:"boolean"},{name:"ALPHA_TEST_CHANNEL",type:"string",options:["a","r","g","b"]}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["USE_INSTANCING","CC_USE_BAKED_ANIMATION"],format:44,isInstanced:!0,location:6},{name:"a_matWorld0",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:7},{name:"a_matWorld1",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:8},{name:"a_matWorld2",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:9},{name:"a_lightingMapUVParam",defines:["USE_INSTANCING","CC_USE_LIGHTMAP"],format:44,isInstanced:!0,location:10},{name:"a_localShadowBias",defines:["USE_INSTANCING","CC_RECEIVE_SHADOW"],format:21,isInstanced:!0,location:11},{name:"a_dyn_batch_id",defines:["!USE_INSTANCING","USE_BATCHING"],format:11,location:12},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:13},{name:"a_color",defines:["USE_VERTEX_COLOR"],format:44,location:14}],blocks:[{name:"TexCoords",defines:["USE_TEXTURE"],binding:0,stageFlags:1,members:[{name:"tilingOffset",type:16,count:1}]},{name:"Constant",defines:[],binding:1,stageFlags:16,members:[{name:"mainColor",type:16,count:1},{name:"colorScaleAndCutoff",type:16,count:1}]}],samplerTextures:[{name:"mainTexture",type:28,count:1,defines:["USE_TEXTURE"],stageFlags:16,binding:2}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"bloom",techniques:[{passes:[{phase:"bloom-prefilter",program:"bloom|bloom-vs|prefilter-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-downsample",program:"bloom|bloom-vs|downsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-downsample",program:"bloom|bloom-vs|downsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-downsample",program:"bloom|bloom-vs|downsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-downsample",program:"bloom|bloom-vs|downsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-downsample",program:"bloom|bloom-vs|downsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-downsample",program:"bloom|bloom-vs|downsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-upsample",program:"bloom|bloom-vs|upsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-upsample",program:"bloom|bloom-vs|upsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-upsample",program:"bloom|bloom-vs|upsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-upsample",program:"bloom|bloom-vs|upsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-upsample",program:"bloom|bloom-vs|upsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-upsample",program:"bloom|bloom-vs|upsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-combine",program:"bloom|bloom-vs|combine-fs",depthStencilState:{depthTest:!1,depthWrite:!1}}]}],shaders:[{name:"bloom|bloom-vs|prefilter-fs",hash:837263906,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:147,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:40},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}],buffers:[],images:[]}},defines:[{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"CC_USE_LIGHTMAP",type:"boolean"},{name:"CC_RECEIVE_SHADOW",type:"boolean"},{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["USE_INSTANCING","CC_USE_BAKED_ANIMATION"],format:44,isInstanced:!0,location:6},{name:"a_matWorld0",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:7},{name:"a_matWorld1",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:8},{name:"a_matWorld2",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:9},{name:"a_lightingMapUVParam",defines:["USE_INSTANCING","CC_USE_LIGHTMAP"],format:44,isInstanced:!0,location:10},{name:"a_localShadowBias",defines:["USE_INSTANCING","CC_RECEIVE_SHADOW"],format:21,isInstanced:!0,location:11},{name:"a_dyn_batch_id",defines:["!USE_INSTANCING","USE_BATCHING"],format:11,location:12},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:13}],blocks:[{name:"BloomUBO",defines:[],binding:0,stageFlags:16,members:[{name:"texSize",type:16,count:1}]}],samplerTextures:[{name:"outputResultMap",type:28,count:1,defines:[],stageFlags:16,binding:1}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]},{name:"bloom|bloom-vs|downsample-fs",hash:682261797,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:147,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:40},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}],buffers:[],images:[]}},defines:[{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"CC_USE_LIGHTMAP",type:"boolean"},{name:"CC_RECEIVE_SHADOW",type:"boolean"},{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["USE_INSTANCING","CC_USE_BAKED_ANIMATION"],format:44,isInstanced:!0,location:6},{name:"a_matWorld0",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:7},{name:"a_matWorld1",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:8},{name:"a_matWorld2",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:9},{name:"a_lightingMapUVParam",defines:["USE_INSTANCING","CC_USE_LIGHTMAP"],format:44,isInstanced:!0,location:10},{name:"a_localShadowBias",defines:["USE_INSTANCING","CC_RECEIVE_SHADOW"],format:21,isInstanced:!0,location:11},{name:"a_dyn_batch_id",defines:["!USE_INSTANCING","USE_BATCHING"],format:11,location:12},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:13}],blocks:[{name:"BloomUBO",defines:[],binding:0,stageFlags:16,members:[{name:"texSize",type:16,count:1}]}],samplerTextures:[{name:"bloomTexture",type:28,count:1,defines:[],stageFlags:16,binding:1}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]},{name:"bloom|bloom-vs|upsample-fs",hash:3663548873,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:147,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:40},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}],buffers:[],images:[]}},defines:[{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"CC_USE_LIGHTMAP",type:"boolean"},{name:"CC_RECEIVE_SHADOW",type:"boolean"},{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["USE_INSTANCING","CC_USE_BAKED_ANIMATION"],format:44,isInstanced:!0,location:6},{name:"a_matWorld0",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:7},{name:"a_matWorld1",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:8},{name:"a_matWorld2",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:9},{name:"a_lightingMapUVParam",defines:["USE_INSTANCING","CC_USE_LIGHTMAP"],format:44,isInstanced:!0,location:10},{name:"a_localShadowBias",defines:["USE_INSTANCING","CC_RECEIVE_SHADOW"],format:21,isInstanced:!0,location:11},{name:"a_dyn_batch_id",defines:["!USE_INSTANCING","USE_BATCHING"],format:11,location:12},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:13}],blocks:[{name:"BloomUBO",defines:[],binding:0,stageFlags:16,members:[{name:"texSize",type:16,count:1}]}],samplerTextures:[{name:"bloomTexture",type:28,count:1,defines:[],stageFlags:16,binding:1}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]},{name:"bloom|bloom-vs|combine-fs",hash:670444562,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:147,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:40},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}],buffers:[],images:[]}},defines:[{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"CC_USE_LIGHTMAP",type:"boolean"},{name:"CC_RECEIVE_SHADOW",type:"boolean"},{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["USE_INSTANCING","CC_USE_BAKED_ANIMATION"],format:44,isInstanced:!0,location:6},{name:"a_matWorld0",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:7},{name:"a_matWorld1",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:8},{name:"a_matWorld2",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:9},{name:"a_lightingMapUVParam",defines:["USE_INSTANCING","CC_USE_LIGHTMAP"],format:44,isInstanced:!0,location:10},{name:"a_localShadowBias",defines:["USE_INSTANCING","CC_RECEIVE_SHADOW"],format:21,isInstanced:!0,location:11},{name:"a_dyn_batch_id",defines:["!USE_INSTANCING","USE_BATCHING"],format:11,location:12},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:13}],blocks:[{name:"BloomUBO",defines:[],binding:0,stageFlags:16,members:[{name:"texSize",type:16,count:1}]}],samplerTextures:[{name:"outputResultMap",type:28,count:1,defines:[],stageFlags:16,binding:1},{name:"bloomTexture",type:28,count:1,defines:[],stageFlags:16,binding:2}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"deferred-lighting",techniques:[{passes:[{phase:"deferred-lighting",program:"deferred-lighting|lighting-vs|lighting-fs",depthStencilState:{depthFunc:4,depthTest:!0,depthWrite:!1}}]}],shaders:[{name:"deferred-lighting|lighting-vs|lighting-fs",hash:2587574837,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:39,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:69},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]},{name:"CCShadow",defines:[]}],samplerTextures:[{name:"cc_shadowMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_spotLightingMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_environment",defines:["CC_USE_IBL"]},{name:"cc_diffuseMap",defines:["CC_USE_DIFFUSEMAP"]}],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:[]},{name:"CCForwardLight",defines:["CC_ENABLE_CLUSTERED_LIGHT_CULLING"]}],samplerTextures:[],buffers:[],images:[]}},defines:[{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"CC_USE_LIGHTMAP",type:"boolean"},{name:"CC_RECEIVE_SHADOW",type:"boolean"},{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_USE_IBL",type:"number",range:[0,2]},{name:"CC_USE_DIFFUSEMAP",type:"number",range:[0,2]},{name:"USE_REFLECTION_DENOISE",type:"boolean"},{name:"CC_FORWARD_ADD",type:"boolean"},{name:"CC_PIPELINE_TYPE",type:"number",range:[0,1]},{name:"CC_FORCE_FORWARD_SHADING",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"},{name:"CC_USE_FOG",type:"number",range:[0,4]}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["USE_INSTANCING","CC_USE_BAKED_ANIMATION"],format:44,isInstanced:!0,location:6},{name:"a_matWorld0",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:7},{name:"a_matWorld1",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:8},{name:"a_matWorld2",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:9},{name:"a_lightingMapUVParam",defines:["USE_INSTANCING","CC_USE_LIGHTMAP"],format:44,isInstanced:!0,location:10},{name:"a_localShadowBias",defines:["USE_INSTANCING","CC_RECEIVE_SHADOW"],format:21,isInstanced:!0,location:11},{name:"a_dyn_batch_id",defines:["!USE_INSTANCING","USE_BATCHING"],format:11,location:12},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:13}],blocks:[],samplerTextures:[],buffers:[{name:"b_ccLightsBuffer",memoryAccess:1,defines:["CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:4},{name:"b_clusterLightIndicesBuffer",memoryAccess:1,defines:["CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:5},{name:"b_clusterLightGridBuffer",memoryAccess:1,defines:["CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:6}],images:[],textures:[],samplers:[],subpassInputs:[{name:"gbuffer_albedoMap",count:1,defines:["CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT"],stageFlags:16,binding:0},{name:"gbuffer_normalMap",count:1,defines:["CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT"],stageFlags:16,binding:1},{name:"gbuffer_emissiveMap",count:1,defines:["CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT"],stageFlags:16,binding:2},{name:"depth_stencil",count:1,defines:["CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT"],stageFlags:16,binding:3}]}]},{name:"planar-shadow",techniques:[{passes:[{phase:"planarShadow",blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},program:"planar-shadow|planar-shadow-vs:vert|planar-shadow-fs:frag",depthStencilState:{depthTest:!0,depthWrite:!1,stencilTestFront:!0,stencilFuncFront:5,stencilPassOpFront:2,stencilRefBack:128,stencilRefFront:128,stencilReadMaskBack:128,stencilReadMaskFront:128,stencilWriteMaskBack:128,stencilWriteMaskFront:128}}]}],shaders:[{name:"planar-shadow|planar-shadow-vs:vert|planar-shadow-fs:frag",hash:3542426468,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:217,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:59},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]},{name:"CCShadow",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]},{name:"CCLocalBatched",defines:["!USE_INSTANCING","USE_BATCHING"]},{name:"CCLocal",defines:["!USE_INSTANCING","!USE_BATCHING"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}],buffers:[],images:[]}},defines:[{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"CC_USE_LIGHTMAP",type:"boolean"},{name:"CC_RECEIVE_SHADOW",type:"boolean"},{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["USE_INSTANCING","CC_USE_BAKED_ANIMATION"],format:44,isInstanced:!0,location:6},{name:"a_matWorld0",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:7},{name:"a_matWorld1",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:8},{name:"a_matWorld2",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:9},{name:"a_lightingMapUVParam",defines:["USE_INSTANCING","CC_USE_LIGHTMAP"],format:44,isInstanced:!0,location:10},{name:"a_localShadowBias",defines:["USE_INSTANCING","CC_RECEIVE_SHADOW"],format:21,isInstanced:!0,location:11},{name:"a_dyn_batch_id",defines:["!USE_INSTANCING","USE_BATCHING"],format:11,location:12},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:13}],blocks:[],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"post-process",techniques:[{passes:[{phase:"post-process",blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendSrcAlpha:2,blendDstAlpha:4}]},program:"post-process|post-process-vs|post-process-fs",depthStencilState:{depthTest:!1,depthWrite:!1}}]}],shaders:[{name:"post-process|post-process-vs|post-process-fs",hash:2960965003,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:147,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:39},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}],buffers:[],images:[]}},defines:[{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"CC_USE_LIGHTMAP",type:"boolean"},{name:"CC_RECEIVE_SHADOW",type:"boolean"},{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"ANTIALIAS_TYPE",type:"number",range:[0,3]}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["USE_INSTANCING","CC_USE_BAKED_ANIMATION"],format:44,isInstanced:!0,location:6},{name:"a_matWorld0",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:7},{name:"a_matWorld1",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:8},{name:"a_matWorld2",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:9},{name:"a_lightingMapUVParam",defines:["USE_INSTANCING","CC_USE_LIGHTMAP"],format:44,isInstanced:!0,location:10},{name:"a_localShadowBias",defines:["USE_INSTANCING","CC_RECEIVE_SHADOW"],format:21,isInstanced:!0,location:11},{name:"a_dyn_batch_id",defines:["!USE_INSTANCING","USE_BATCHING"],format:11,location:12},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:13}],blocks:[],samplerTextures:[{name:"outputResultMap",type:28,count:1,defines:[],stageFlags:16,binding:0}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"skybox",techniques:[{passes:[{rasterizerState:{cullMode:0},program:"skybox|sky-vs:vert|sky-fs:frag",priority:245,depthStencilState:{depthTest:!0,depthWrite:!1}}]}],shaders:[{name:"skybox|sky-vs:vert|sky-fs:frag",hash:2207113861,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:39,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:39},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[{name:"cc_environment",defines:[]}],buffers:[],images:[]},locals:{blocks:[],samplerTextures:[],buffers:[],images:[]}},defines:[{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"CC_USE_LIGHTMAP",type:"boolean"},{name:"CC_RECEIVE_SHADOW",type:"boolean"},{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_USE_IBL",type:"number",range:[0,2]},{name:"CC_USE_HDR",type:"boolean"},{name:"USE_RGBE_CUBEMAP",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["USE_INSTANCING","CC_USE_BAKED_ANIMATION"],format:44,isInstanced:!0,location:6},{name:"a_matWorld0",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:7},{name:"a_matWorld1",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:8},{name:"a_matWorld2",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:9},{name:"a_lightingMapUVParam",defines:["USE_INSTANCING","CC_USE_LIGHTMAP"],format:44,isInstanced:!0,location:10},{name:"a_localShadowBias",defines:["USE_INSTANCING","CC_RECEIVE_SHADOW"],format:21,isInstanced:!0,location:11},{name:"a_dyn_batch_id",defines:["!USE_INSTANCING","USE_BATCHING"],format:11,location:12},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:13}],blocks:[],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"profiler",techniques:[{passes:[{blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"profiler|profiler-vs:vert|profiler-fs:frag",priority:255,depthStencilState:{depthTest:!1,depthWrite:!1}}]}],shaders:[{name:"profiler|profiler-vs:vert|profiler-fs:frag",hash:179162168,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:60,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:39},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[],samplerTextures:[],buffers:[],images:[]}},defines:[],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_color",defines:[],format:44,location:1}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:1,members:[{name:"offset",type:16,count:1}]},{name:"PerFrameInfo",defines:[],binding:1,stageFlags:1,members:[{name:"digits",type:16,count:20}]}],samplerTextures:[{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:2}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"splash-screen",techniques:[{name:"default",passes:[{blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"splash-screen|splash-screen-vs:vert|splash-screen-fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},resolution:{value:[640,960],type:14,handleInfo:["u_buffer0",0,14]},percent:{value:[.5],type:13,handleInfo:["u_percent",0,13]},scale:{value:[200,500],type:14,handleInfo:["u_buffer1",0,14]},translate:{value:[320,480],type:14,handleInfo:["u_buffer1",2,14]},u_buffer0:{type:16,value:[640,960,0,0]},u_percent:{type:13,value:[.5]},u_buffer1:{type:16,value:[200,500,320,480]}}}]}],shaders:[{name:"splash-screen|splash-screen-vs:vert|splash-screen-fs:frag",hash:3189094080,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:6,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:1},globals:{blocks:[],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[],samplerTextures:[],buffers:[],images:[]}},defines:[],attributes:[{name:"a_position",defines:[],format:21,location:0},{name:"a_texCoord",defines:[],format:21,location:1}],blocks:[{name:"Constant",defines:[],binding:0,stageFlags:1,members:[{name:"u_buffer0",type:16,count:1},{name:"u_buffer1",type:16,count:1},{name:"u_projection",type:25,count:1}]},{name:"Factor",defines:[],binding:1,stageFlags:16,members:[{name:"u_percent",type:13,count:1}]}],samplerTextures:[{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:2}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]}]),ev={glsl1:[[{vert:"\nprecision mediump float;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matViewInv;\nuniform highp mat4 cc_matViewProj;\nuniform highp mat4 cc_matWorld;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\nfloat x = angle.x / 2.;\nfloat y = angle.y / 2.;\nfloat z = angle.z / 2.;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat = vec4(0);\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nvarying mediump vec2 uv;\nvarying mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n, mat4 viewInv\n) {\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n}\nattribute vec3 a_position;\nattribute vec2 a_texCoord;\nattribute vec4 a_color;\nuniform vec4 cc_size_rotation;\nvec4 vs_main() {\nvec4 pos = vec4(a_position, 1);\npos = cc_matWorld * pos;\nvec2 vertOffset = a_texCoord.xy - 0.5;\ncomputeVertPos(pos, vertOffset, quaternionFromEuler(vec3(0., 0., cc_size_rotation.z)), vec3(cc_size_rotation.xy, 0.), cc_matViewInv);\npos = cc_matViewProj * pos;\nuv = a_texCoord.xy;\ncolor = a_color;\nreturn pos;\n}\nvoid main() { gl_Position = vs_main(); }",frag:"\nprecision mediump float;\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nvarying vec2 uv;\nvarying vec4 color;\nuniform sampler2D mainTexture;\nuniform vec4 tintColor;\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture2D(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nvoid main() { gl_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nattribute vec3 a_position;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 frag () {\nvec4 o = vec4(1.0);\nreturn o;\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nuniform highp mat4 cc_matViewProj;\nattribute highp vec3 a_position;\nattribute vec4 a_color;\nvarying vec4 v_color;\nvec4 vert () {\nvec4 pos = cc_matViewProj * vec4(a_position, 1);\npos.z -= 0.000001;\nv_color = a_color;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nvarying vec4 v_color;\nvec4 front() {\n#if USE_FORWARD_PIPELINE\nreturn CCFragOutput(v_color);\n#else\nreturn v_color;\n#endif\n}\nvoid main() { gl_FragColor = front(); }"},{vert:"\nprecision mediump float;\nuniform highp mat4 cc_matViewProj;\nattribute highp vec3 a_position;\nattribute vec4 a_color;\nvarying vec4 v_color;\nvec4 vert () {\nvec4 pos = cc_matViewProj * vec4(a_position, 1);\npos.z -= 0.000001;\nv_color = a_color;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nvarying vec4 v_color;\nvec4 back() {\n#if USE_FORWARD_PIPELINE\nreturn CCFragOutput(vec4(v_color.rgb, v_color.a * 0.2));\n#else\nreturn vec4(v_color.rgb, v_color.a * 0.2);\n#endif\n}\nvoid main() { gl_FragColor = back(); }"},{vert:"\nprecision mediump float;\nuniform highp mat4 cc_matViewProj;\nattribute highp vec3 a_position;\nattribute vec4 a_color;\nvarying vec4 v_color;\nvarying float v_distance;\nvec4 vert () {\nvec4 pos = cc_matViewProj * vec4(a_position, 1);\npos.z -= 0.000001;\nv_color = a_color;\nv_distance = dot(a_position, vec3(1.0, 1.0, 1.0));\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nvarying vec4 v_color;\nvarying float v_distance;\nvec4 front() {\nif (fract(v_distance) > 0.5) {\ndiscard;\n}\n#if USE_FORWARD_PIPELINE\nreturn CCFragOutput(v_color);\n#else\nreturn v_color;\n#endif\n}\nvoid main() { gl_FragColor = front(); }"},{vert:"\nprecision mediump float;\nuniform highp mat4 cc_matViewProj;\nattribute highp vec3 a_position;\nattribute vec4 a_color;\nvarying vec4 v_color;\nvarying float v_distance;\nvec4 vert () {\nvec4 pos = cc_matViewProj * vec4(a_position, 1);\npos.z -= 0.000001;\nv_color = a_color;\nv_distance = dot(a_position, vec3(1.0, 1.0, 1.0));\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nvarying vec4 v_color;\nvarying float v_distance;\nvec4 back() {\nif (fract(v_distance) > 0.5) {\ndiscard;\n}\n#if USE_FORWARD_PIPELINE\nreturn CCFragOutput(vec4(v_color.rgb, v_color.a * 0.2));\n#else\nreturn vec4(v_color.rgb, v_color.a * 0.2);\n#endif\n}\nvoid main() { gl_FragColor = back(); }"},{vert:"\nprecision mediump float;\nuniform highp mat4 cc_matViewProj;\nattribute highp vec3 a_position;\nattribute vec4 a_normal;\nattribute vec4 a_color;\nvarying vec4 v_color;\nvec4 vert () {\nvec4 pos = cc_matViewProj * vec4(a_position, 1);\nv_color = a_color;\nfloat intensity = dot(vec3(1, 2, 4), a_normal.xyz);\nv_color.rgb -= a_normal.w * intensity * 0.1;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nvarying vec4 v_color;\nvec4 front() {\n#if USE_FORWARD_PIPELINE\nreturn CCFragOutput(v_color);\n#else\nreturn v_color;\n#endif\n}\nvoid main() { gl_FragColor = front(); }"},{vert:"\nprecision mediump float;\nuniform highp mat4 cc_matViewProj;\nattribute highp vec3 a_position;\nattribute vec4 a_normal;\nattribute vec4 a_color;\nvarying vec4 v_color;\nvec4 vert () {\nvec4 pos = cc_matViewProj * vec4(a_position, 1);\nv_color = a_color;\nfloat intensity = dot(vec3(1, 2, 4), a_normal.xyz);\nv_color.rgb -= a_normal.w * intensity * 0.1;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nvarying vec4 v_color;\nvec4 back() {\n#if USE_FORWARD_PIPELINE\nreturn CCFragOutput(vec4(v_color.rgb, v_color.a * 0.2));\n#else\nreturn vec4(v_color.rgb, v_color.a * 0.2);\n#endif\n}\nvoid main() { gl_FragColor = back(); }"}],[{vert:"\nprecision highp float;\nuniform highp mat4 cc_matViewProj;\nuniform highp mat4 cc_matWorld;\nattribute vec3 a_position;\nattribute vec4 a_color;\nvarying vec4 v_color;\nattribute float a_dist;\nvarying float v_dist;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\npos = cc_matViewProj * cc_matWorld * pos;\nv_color = a_color;\nv_dist = a_dist;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\n#ifdef GL_OES_standard_derivatives\n#extension GL_OES_standard_derivatives: enable\n#endif\nprecision highp float;\nvarying vec4 v_color;\nvarying float v_dist;\nvec4 frag () {\nvec4 o = v_color;\n#ifdef GL_OES_standard_derivatives\nfloat aa = fwidth(v_dist);\n#else\nfloat aa = 0.05;\n#endif\nfloat alpha = 1. - smoothstep(-aa, 0., abs(v_dist) - 1.0);\no.rgb *= o.a;\no *= alpha;\nreturn o;\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_worldBoundCenter;\nuniform highp vec4 cc_worldBoundHalfExtents;\nattribute vec3 a_position;\nvec4 vert () {\nvec4 position;\nposition = vec4(a_position, 1.0);\nposition *= cc_worldBoundHalfExtents;\nposition += cc_worldBoundCenter;\nposition = cc_matViewProj * position;\nreturn position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nvec4 frag () {\nreturn vec4(1, 0, 0, 1);\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\nfloat x = angle.x / 2.;\nfloat y = angle.y / 2.;\nfloat z = angle.z / 2.;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat = vec4(0);\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nmat4 matrixFromRT (vec4 q, vec3 p){\nfloat x2 = q.x + q.x;\nfloat y2 = q.y + q.y;\nfloat z2 = q.z + q.z;\nfloat xx = q.x * x2;\nfloat xy = q.x * y2;\nfloat xz = q.x * z2;\nfloat yy = q.y * y2;\nfloat yz = q.y * z2;\nfloat zz = q.z * z2;\nfloat wx = q.w * x2;\nfloat wy = q.w * y2;\nfloat wz = q.w * z2;\nreturn mat4(\n1. - (yy + zz), xy + wz, xz - wy, 0,\nxy - wz, 1. - (xx + zz), yz + wx, 0,\nxz + wy, yz - wx, 1. - (xx + yy), 0,\np.x, p.y, p.z, 1\n);\n}\nmat4 matFromRTS (vec4 q, vec3 t, vec3 s){\nfloat x = q.x, y = q.y, z = q.z, w = q.w;\nfloat x2 = x + x;\nfloat y2 = y + y;\nfloat z2 = z + z;\nfloat xx = x * x2;\nfloat xy = x * y2;\nfloat xz = x * z2;\nfloat yy = y * y2;\nfloat yz = y * z2;\nfloat zz = z * z2;\nfloat wx = w * x2;\nfloat wy = w * y2;\nfloat wz = w * z2;\nfloat sx = s.x;\nfloat sy = s.y;\nfloat sz = s.z;\nreturn mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n(xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n(xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\nt.x, t.y, t.z, 1);\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nmat3 quatToMat3(vec4 q) {\nvec3 m0 = vec3(\n1.0 - 2.0 * q.y * q.y - 2.0 * q.z * q.z,\n2.0 * q.x * q.y + 2.0 * q.w * q.z,\n2.0 * q.x * q.z - 2.0 * q.w * q.y);\nvec3 m1 = vec3(\n2.0 * q.x * q.y - 2.0 * q.w * q.z,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.z * q.z,\n2.0 * q.y * q.z + 2.0 * q.w * q.x);\nvec3 m2 = vec3(\n2.0 * q.x * q.z + 2.0 * q.w * q.y,\n2.0 * q.y * q.z - 2.0 * q.w * q.x,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.y * q.y);\nreturn mat3(m0, m1, m2);\n}\nvec4 mat3ToQuat(mat3 mat) {\nfloat tr = mat[0][0] + mat[1][1] + mat[2][2];\nfloat qw, qx, qy, qz;\nif (tr > 0.0) {\nfloat S = sqrt(tr + 1.0) * 2.0;\nfloat invS = 1.0 / S;\nqw = 0.25 * S;\nqx = (mat[1][2] - mat[2][1]) * invS;\nqy = (mat[2][0] - mat[0][2]) * invS;\nqz = (mat[0][1] - mat[1][0]) * invS;\n} else if ((mat[0][0] > mat[1][1])&&(mat[0][0] > mat[2][2])) {\nfloat S = sqrt(1.0 + mat[0][0] - mat[1][1] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[1][2] - mat[2][1]) * invS;\nqx = 0.25 * S;\nqy = (mat[1][0] + mat[0][1]) * invS;\nqz = (mat[2][0] + mat[0][2]) * invS;\n} else if (mat[1][1] > mat[2][2]) {\nfloat S = sqrt(1.0 + mat[1][1] - mat[0][0] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[2][0] - mat[0][2]) * invS;\nqx = (mat[1][0] + mat[0][1]) * invS;\nqy = 0.25 * S;\nqz = (mat[2][1] + mat[1][2]) * invS;\n} else {\nfloat S = sqrt(1.0 + mat[2][2] - mat[0][0] - mat[1][1]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[0][1] - mat[1][0]) * invS;\nqx = (mat[2][0] + mat[0][2]) * invS;\nqy = (mat[2][1] + mat[1][2]) * invS;\nqz = 0.25 * S;\n}\nreturn vec4(qx, qy, qz, qw);\n}\nvec4 eulerToQuat(vec3 euler) {\nvec3 er = euler * 0.5;\nfloat x = er.x, y = er.y, z = er.z;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat;\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nuniform vec4 mainTiling_Offset;\nuniform vec4 frameTile_velLenScale;\nuniform vec4 scale;\nuniform vec4 nodeRotation;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matViewInv;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_cameraPos;\nuniform highp mat4 cc_matWorld;\nvarying mediump vec2 uv;\nvarying mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, mat4 viewInv\n#endif\n#if CC_RENDER_MODE == 1\n, vec3 eye\n, vec4 velocity\n, float velocityScale\n, float lengthScale\n, float xIndex\n#endif\n) {\n#if CC_RENDER_MODE == 0\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_RENDER_MODE == 1\nvec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\nvec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\npos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_RENDER_MODE == 2\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = vec3(1, 0, 0);\nvec3 camY = vec3(0, 0, -1);\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_RENDER_MODE == 3\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nrotateVecFromQuat(viewSpaceVert, q);\nvec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\nvec3 camY = vec3(0, 1, 0);\nvec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\npos.xyz += offset;\n#else\npos.x += vertOffset.x;\npos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV (float frameIndex, vec2 vertIndex, vec2 frameTile){\nvec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\naniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if CC_RENDER_MODE != 4\nvertIndex.y = 1. - vertIndex.y;\n#endif\nreturn (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nuniform vec4 u_sampleInfo;\nuniform vec4 u_worldRot;\nuniform vec4 u_timeDelta;\nattribute vec4 a_position_starttime;\nattribute vec4 a_size_uv;\nattribute vec4 a_rotation_uv;\nattribute vec4 a_color;\nattribute vec4 a_dir_life;\nattribute float a_rndSeed;\n#if CC_RENDER_MODE == 4\nattribute vec3 a_texCoord;\nattribute vec3 a_texCoord3;\nattribute vec3 a_normal;\nattribute vec4 a_color1;\n#endif\nvec3 unpackCurveData (sampler2D tex, vec2 coord) {\nvec4 a = texture2D(tex, coord);\nvec4 b = texture2D(tex, coord + u_sampleInfo.y);\nfloat c = fract(coord.x * u_sampleInfo.x);\nreturn mix(a.xyz, b.xyz, c);\n}\nvec3 unpackCurveData (sampler2D tex, vec2 coord, out float w) {\nvec4 a = texture2D(tex, coord);\nvec4 b = texture2D(tex, coord + u_sampleInfo.y);\nfloat c = fract(coord.x * u_sampleInfo.x);\nw = mix(a.w, b.w, c);\nreturn mix(a.xyz, b.xyz, c);\n}\nfloat pseudoRandom(float x) {\n#if USE_VK_SHADER\nfloat o = x;\nx = mod(x - 1.0, 2.0) - 1.0;\nfloat freqVar = 10.16640753482;\nfloat y = sin(freqVar * floor(o * 0.5 - 0.5));\nfloat v = max(0.0, 1.0-abs(x));\nv *= 0.7071067812;\nv = y < 0.0 ? -v : v;\nreturn v;\n#else\nfloat seed = mod(x, 233280.);\nfloat q = (seed * 9301. + 49297.) / 233280.;\nreturn fract(q);\n#endif\n}\n#if COLOR_OVER_TIME_MODULE_ENABLE\nuniform sampler2D color_over_time_tex0;\nuniform int u_color_mode;\n#endif\n#if ROTATION_OVER_TIME_MODULE_ENABLE\nuniform sampler2D rotation_over_time_tex0;\nuniform int u_rotation_mode;\n#endif\n#if SIZE_OVER_TIME_MODULE_ENABLE\nuniform sampler2D size_over_time_tex0;\nuniform int u_size_mode;\n#endif\n#if FORCE_OVER_TIME_MODULE_ENABLE\nuniform sampler2D force_over_time_tex0;\nuniform int u_force_mode;\nuniform int u_force_space;\n#endif\n#if VELOCITY_OVER_TIME_MODULE_ENABLE\nuniform sampler2D velocity_over_time_tex0;\nuniform int u_velocity_mode;\nuniform int u_velocity_space;\n#endif\n#if TEXTURE_ANIMATION_MODULE_ENABLE\nuniform sampler2D texture_animation_tex0;\nuniform vec4 u_anim_info;\n#endif\nfloat repeat (float t, float length) {\nreturn t - floor(t / length) * length;\n}\nvec4 rotateQuat (vec4 p, vec4 q) {\nvec3 iv = cross(q.xyz, p.xyz) + q.w * p.xyz;\nvec3 res = p.xyz + 2.0 * cross(q.xyz, iv);\nreturn vec4(res.xyz, p.w);\n}\nvec4 gpvs_main () {\nfloat activeTime = u_timeDelta.x - a_position_starttime.w;\nfloat normalizedTime = clamp(activeTime / a_dir_life.w, 0.0, 1.0);\nvec2 timeCoord0 = vec2(normalizedTime, 0.);\nvec2 timeCoord1 = vec2(normalizedTime, 1.);\n#if CC_RENDER_MODE == 4\nvec2 vertIdx = vec2(a_texCoord.x, a_texCoord.y);\n#else\nvec2 vertIdx = vec2(a_size_uv.w, a_rotation_uv.w);\n#endif\nvec4 velocity = vec4(a_dir_life.xyz, 0.);\nvec4 pos = vec4(a_position_starttime.xyz, 1.);\nvec3 size = a_size_uv.xyz;\n#if SIZE_OVER_TIME_MODULE_ENABLE\nif (u_size_mode == 1) {\nsize *= unpackCurveData(size_over_time_tex0, timeCoord0);\n} else {\nvec3 size_0 = unpackCurveData(size_over_time_tex0, timeCoord0);\nvec3 size_1 = unpackCurveData(size_over_time_tex0, timeCoord1);\nfloat factor_s = pseudoRandom(a_rndSeed + 39825.);\nsize *= mix(size_0, size_1, factor_s);\n}\n#endif\nvec3 compScale = scale.xyz * size;\n#if FORCE_OVER_TIME_MODULE_ENABLE\nvec3 forceAnim = vec3(0.);\nif (u_force_mode == 1) {\nforceAnim = unpackCurveData(force_over_time_tex0, timeCoord0);\n} else {\nvec3 force_0 = unpackCurveData(force_over_time_tex0, timeCoord0);\nvec3 force_1 = unpackCurveData(force_over_time_tex0, timeCoord1);\nfloat factor_f =  pseudoRandom(a_rndSeed + 212165.);\nforceAnim = mix(force_0, force_1, factor_f);\n}\nvec4 forceTrack = vec4(forceAnim, 0.);\nif (u_force_space == 0) {\nforceTrack = rotateQuat(forceTrack, u_worldRot);\n}\nvelocity.xyz += forceTrack.xyz;\n#endif\n#if VELOCITY_OVER_TIME_MODULE_ENABLE\nfloat speedModifier0 = 1.;\nfloat speedModifier1 = 1.;\nvec3 velocityAnim = vec3(0.);\nif (u_velocity_mode == 1) {\nvelocityAnim = unpackCurveData(velocity_over_time_tex0, timeCoord0, speedModifier0);\n} else {\nvec3 vectory_0 = unpackCurveData(velocity_over_time_tex0, timeCoord0, speedModifier0);\nvec3 vectory_1 = unpackCurveData(velocity_over_time_tex0, timeCoord1, speedModifier1);\nfloat factor_v = pseudoRandom(a_rndSeed + 197866.);\nvelocityAnim = mix(vectory_0, vectory_1, factor_v);\nspeedModifier0 = mix(speedModifier0, speedModifier1, factor_v);\n}\nvec4 velocityTrack = vec4(velocityAnim, 0.);\nif (u_velocity_space == 0) {\nvelocityTrack = rotateQuat(velocityTrack, u_worldRot);\n}\nvelocity.xyz += velocityTrack.xyz;\nvelocity.xyz *= speedModifier0;\n#endif\npos.xyz += velocity.xyz * normalizedTime * a_dir_life.w;\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\n#if CC_RENDER_MODE == 1\nvelocity = rotateQuat(velocity, u_worldRot);\n#endif\n#endif\nvec3 startRotation = a_rotation_uv.xyz;\n#if CC_RENDER_MODE != 4\n#if CC_RENDER_MODE == 0\nvec3 rotEuler = startRotation.xyz;\n#elif CC_RENDER_MODE == 1\nvec3 rotEuler = vec3(0.);\n#else\nvec3 rotEuler = vec3(0., 0., startRotation.z);\n#endif\nvec4 rot = quaternionFromEuler(rotEuler);\n#else\nvec4 rot = quaternionFromEuler(startRotation);\n#endif\n#if ROTATION_OVER_TIME_MODULE_ENABLE\nif (u_rotation_mode == 1) {\nvec3 euler = unpackCurveData(rotation_over_time_tex0, timeCoord0) * normalizedTime * a_dir_life.w;\nvec4 quat = eulerToQuat(euler);\nmat3 mLocal = quatToMat3(quat);\nmat3 mStart = quatToMat3(rot);\nrot = mat3ToQuat(mStart * mLocal);\n} else {\nvec3 rotation_0 = unpackCurveData(rotation_over_time_tex0, timeCoord0);\nvec3 rotation_1 = unpackCurveData(rotation_over_time_tex0, timeCoord1);\nfloat factor_r = pseudoRandom(a_rndSeed + 125292.);\nvec3 euler = mix(rotation_0, rotation_1, factor_r) * normalizedTime * a_dir_life.w;\n#if CC_RENDER_MODE == 3 || CC_RENDER_MODE == 2\neuler = vec3(0.0, 0.0, euler.z);\n#endif\nvec4 quat = eulerToQuat(euler);\nmat3 mLocal = quatToMat3(quat);\nmat3 mStart = quatToMat3(rot);\nrot = mat3ToQuat(mStart * mLocal);\n}\n#endif\n#if COLOR_OVER_TIME_MODULE_ENABLE\nif (u_color_mode == 1) {\ncolor = a_color * texture2D(color_over_time_tex0, timeCoord0);\n} else {\nvec4 color_0 = texture2D(color_over_time_tex0, timeCoord0);\nvec4 color_1 = texture2D(color_over_time_tex0, timeCoord1);\nfloat factor_c = pseudoRandom(a_rndSeed + 91041.);\ncolor = a_color * mix(color_0, color_1, factor_c);\n}\n#else\ncolor = a_color;\n#endif\n#if CC_RENDER_MODE != 4\nvec2 cornerOffset = vec2((vertIdx - 0.5));\n#if CC_RENDER_MODE == 1\nrot = vec4(0.0, 0.0, 0.0, 1.0);\n#endif\ncomputeVertPos(pos, cornerOffset, rot, compScale\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, cc_matViewInv\n#endif\n#if CC_RENDER_MODE == 1\n, cc_cameraPos.xyz\n, velocity\n, frameTile_velLenScale.z\n, frameTile_velLenScale.w\n, a_size_uv.w\n#endif\n);\n#else\nmat3 rotMat = quatToMat3(rot);\nmat3 nodeMat = quatToMat3(nodeRotation);\nrotMat = nodeMat * rotMat;\nrot = mat3ToQuat(rotMat);\nmat4 xformNoScale = matrixFromRT(rot, pos.xyz);\nmat4 xform = matFromRTS(rot, pos.xyz, compScale);\npos = xform * vec4(a_texCoord3, 1);\nvec4 normal = xformNoScale * vec4(a_normal, 0);\ncolor *= a_color1;\n#endif\npos = cc_matViewProj * pos;\nfloat frameIndex = 0.;\n#if TEXTURE_ANIMATION_MODULE_ENABLE\nfloat startFrame = 0.;\nvec3 frameInfo = vec3(0.);\nif (int(u_anim_info.x) == 1) {\nframeInfo = unpackCurveData(texture_animation_tex0, timeCoord0);\n} else {\nvec3 frameInfo0 = unpackCurveData(texture_animation_tex0, timeCoord0);\nvec3 frameInfo1 = unpackCurveData(texture_animation_tex0, timeCoord1);\nfloat factor_t = pseudoRandom(a_rndSeed + 90794.);\nframeInfo = mix(frameInfo0, frameInfo1, factor_t);\n}\nstartFrame = frameInfo.x / u_anim_info.y;\nframeIndex = repeat(u_anim_info.z * (frameInfo.y + startFrame), 1.);\n#endif\nuv = computeUV(frameIndex, vertIdx, frameTile_velLenScale.xy) * mainTiling_Offset.xy + mainTiling_Offset.zw;\nreturn pos;\n}\nvoid main() { gl_Position = gpvs_main(); }",frag:"\nprecision mediump float;\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nvarying vec2 uv;\nvarying vec4 color;\nuniform sampler2D mainTexture;\nuniform vec4 tintColor;\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture2D(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nvoid main() { gl_FragColor = add(); }"}],[{vert:"\nprecision mediump float;\nuniform vec4 mainTiling_Offset;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_cameraPos;\nuniform highp mat4 cc_matWorld;\nvarying mediump vec2 uv;\nvarying mediump vec4 color;\nattribute vec3 a_position;\nattribute vec4 a_texCoord;\nattribute vec3 a_texCoord1;\nattribute vec3 a_texCoord2;\nattribute vec4 a_color;\n#if CC_DRAW_WIRE_FRAME\nvarying vec3 vBarycentric;\n#endif\nvec4 vs_main() {\nhighp vec4 pos = vec4(a_position, 1);\nvec4 velocity = vec4(a_texCoord1.xyz, 0);\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\nvelocity = cc_matWorld * velocity;\n#endif\nfloat vertOffset = (a_texCoord.x - 0.5) * a_texCoord.y;\nvec3 camUp = normalize(cross(pos.xyz - cc_cameraPos.xyz, velocity.xyz));\npos.xyz += camUp * vertOffset;\npos = cc_matViewProj * pos;\nuv = a_texCoord.zw * mainTiling_Offset.xy + mainTiling_Offset.zw;;\ncolor = a_color;\n#if CC_DRAW_WIRE_FRAME\nvBarycentric = a_texCoord2;\n#endif\nreturn pos;\n}\nvoid main() { gl_Position = vs_main(); }",frag:"\nprecision mediump float;\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nvarying vec2 uv;\nvarying vec4 color;\n#if CC_DRAW_WIRE_FRAME\nvarying vec3 vBarycentric;\n#endif\nuniform sampler2D mainTexture;\nuniform vec4 tintColor;\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture2D(mainTexture, uv);\n#if CC_DRAW_WIRE_FRAME\nif (any(lessThan(vBarycentric, vec3(0.02)))) {\ncol = vec4(0., 1., 1., 1.);\n}\n#endif\nreturn CCFragOutput(col);\n}\nvoid main() { gl_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\nfloat x = angle.x / 2.;\nfloat y = angle.y / 2.;\nfloat z = angle.z / 2.;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat = vec4(0);\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nmat4 matrixFromRT (vec4 q, vec3 p){\nfloat x2 = q.x + q.x;\nfloat y2 = q.y + q.y;\nfloat z2 = q.z + q.z;\nfloat xx = q.x * x2;\nfloat xy = q.x * y2;\nfloat xz = q.x * z2;\nfloat yy = q.y * y2;\nfloat yz = q.y * z2;\nfloat zz = q.z * z2;\nfloat wx = q.w * x2;\nfloat wy = q.w * y2;\nfloat wz = q.w * z2;\nreturn mat4(\n1. - (yy + zz), xy + wz, xz - wy, 0,\nxy - wz, 1. - (xx + zz), yz + wx, 0,\nxz + wy, yz - wx, 1. - (xx + yy), 0,\np.x, p.y, p.z, 1\n);\n}\nmat4 matFromRTS (vec4 q, vec3 t, vec3 s){\nfloat x = q.x, y = q.y, z = q.z, w = q.w;\nfloat x2 = x + x;\nfloat y2 = y + y;\nfloat z2 = z + z;\nfloat xx = x * x2;\nfloat xy = x * y2;\nfloat xz = x * z2;\nfloat yy = y * y2;\nfloat yz = y * z2;\nfloat zz = z * z2;\nfloat wx = w * x2;\nfloat wy = w * y2;\nfloat wz = w * z2;\nfloat sx = s.x;\nfloat sy = s.y;\nfloat sz = s.z;\nreturn mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n(xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n(xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\nt.x, t.y, t.z, 1);\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nmat3 quatToMat3(vec4 q) {\nvec3 m0 = vec3(\n1.0 - 2.0 * q.y * q.y - 2.0 * q.z * q.z,\n2.0 * q.x * q.y + 2.0 * q.w * q.z,\n2.0 * q.x * q.z - 2.0 * q.w * q.y);\nvec3 m1 = vec3(\n2.0 * q.x * q.y - 2.0 * q.w * q.z,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.z * q.z,\n2.0 * q.y * q.z + 2.0 * q.w * q.x);\nvec3 m2 = vec3(\n2.0 * q.x * q.z + 2.0 * q.w * q.y,\n2.0 * q.y * q.z - 2.0 * q.w * q.x,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.y * q.y);\nreturn mat3(m0, m1, m2);\n}\nvec4 mat3ToQuat(mat3 mat) {\nfloat tr = mat[0][0] + mat[1][1] + mat[2][2];\nfloat qw, qx, qy, qz;\nif (tr > 0.0) {\nfloat S = sqrt(tr + 1.0) * 2.0;\nfloat invS = 1.0 / S;\nqw = 0.25 * S;\nqx = (mat[1][2] - mat[2][1]) * invS;\nqy = (mat[2][0] - mat[0][2]) * invS;\nqz = (mat[0][1] - mat[1][0]) * invS;\n} else if ((mat[0][0] > mat[1][1])&&(mat[0][0] > mat[2][2])) {\nfloat S = sqrt(1.0 + mat[0][0] - mat[1][1] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[1][2] - mat[2][1]) * invS;\nqx = 0.25 * S;\nqy = (mat[1][0] + mat[0][1]) * invS;\nqz = (mat[2][0] + mat[0][2]) * invS;\n} else if (mat[1][1] > mat[2][2]) {\nfloat S = sqrt(1.0 + mat[1][1] - mat[0][0] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[2][0] - mat[0][2]) * invS;\nqx = (mat[1][0] + mat[0][1]) * invS;\nqy = 0.25 * S;\nqz = (mat[2][1] + mat[1][2]) * invS;\n} else {\nfloat S = sqrt(1.0 + mat[2][2] - mat[0][0] - mat[1][1]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[0][1] - mat[1][0]) * invS;\nqx = (mat[2][0] + mat[0][2]) * invS;\nqy = (mat[2][1] + mat[1][2]) * invS;\nqz = 0.25 * S;\n}\nreturn vec4(qx, qy, qz, qw);\n}\nuniform vec4 mainTiling_Offset;\nuniform vec4 frameTile_velLenScale;\nuniform vec4 scale;\nuniform vec4 nodeRotation;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matViewInv;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_cameraPos;\nuniform highp mat4 cc_matWorld;\nvarying mediump vec2 uv;\nvarying mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, mat4 viewInv\n#endif\n#if CC_RENDER_MODE == 1\n, vec3 eye\n, vec4 velocity\n, float velocityScale\n, float lengthScale\n, float xIndex\n#endif\n) {\n#if CC_RENDER_MODE == 0\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_RENDER_MODE == 1\nvec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\nvec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\npos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_RENDER_MODE == 2\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = vec3(1, 0, 0);\nvec3 camY = vec3(0, 0, -1);\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_RENDER_MODE == 3\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nrotateVecFromQuat(viewSpaceVert, q);\nvec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\nvec3 camY = vec3(0, 1, 0);\nvec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\npos.xyz += offset;\n#else\npos.x += vertOffset.x;\npos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV (float frameIndex, vec2 vertIndex, vec2 frameTile){\nvec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\naniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if CC_RENDER_MODE != 4\nvertIndex.y = 1. - vertIndex.y;\n#endif\nreturn (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nattribute vec3 a_position;\nattribute vec3 a_texCoord;\nattribute vec3 a_texCoord1;\nattribute vec3 a_texCoord2;\nattribute vec4 a_color;\n#if CC_RENDER_MODE == 1\nattribute vec3 a_color1;\n#endif\n#if CC_RENDER_MODE == 4\nattribute vec3 a_texCoord3;\nattribute vec3 a_normal;\nattribute vec4 a_color1;\n#endif\nvec4 lpvs_main () {\nvec3 compScale = scale.xyz * a_texCoord1;\nvec4 pos = vec4(a_position, 1);\n#if CC_RENDER_MODE == 1\nvec4 velocity = vec4(a_color1.xyz, 0);\n#endif\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\n#if CC_RENDER_MODE == 1\nvelocity = cc_matWorld * velocity;\n#endif\n#endif\n#if ROTATION_OVER_TIME_MODULE_ENABLE\nvec3 rotTmp = a_texCoord2;\nfloat mulFactor = 1.0;\nif (rotTmp.x > 10.0 * 0.5) {\nrotTmp.x -= 10.0;\nmulFactor = -1.0;\n}\nvec4 rot = vec4(rotTmp, 0.0);\nrot.w = mulFactor * sqrt(abs(1.0 - rot.x * rot.x - rot.y * rot.y - rot.z * rot.z));\n#else\n#if CC_RENDER_MODE != 4\n#if CC_RENDER_MODE == 0\nvec3 rotEuler = a_texCoord2;\n#elif CC_RENDER_MODE == 1\nvec3 rotEuler = vec3(0.);\n#else\nvec3 rotEuler = vec3(0., 0., a_texCoord2.z);\n#endif\nvec4 rot = quaternionFromEuler(rotEuler);\n#else\nvec4 rot = quaternionFromEuler(a_texCoord2);\n#endif\n#endif\n#if CC_RENDER_MODE != 4\nvec2 cornerOffset = vec2((a_texCoord.xy - 0.5));\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\ncomputeVertPos(pos, cornerOffset, rot, compScale, cc_matViewInv);\n#elif CC_RENDER_MODE == 1\ncomputeVertPos(pos, cornerOffset, rot, compScale, cc_cameraPos.xyz, velocity, frameTile_velLenScale.z, frameTile_velLenScale.w, a_texCoord.x);\n#elif 2\ncomputeVertPos(pos, cornerOffset, rot, compScale);\n#endif\ncolor = a_color;\n#else\nmat3 rotMat = quatToMat3(rot);\nmat3 nodeMat = quatToMat3(nodeRotation);\nrotMat = nodeMat * rotMat;\nrot = mat3ToQuat(rotMat);\nmat4 xformNoScale = matrixFromRT(rot, pos.xyz);\nmat4 xform = matFromRTS(rot, pos.xyz, compScale);\npos = xform * vec4(a_texCoord3, 1);\nvec4 normal = xformNoScale * vec4(a_normal, 0);\ncolor = a_color * a_color1;\n#endif\nuv = computeUV(a_texCoord.z, a_texCoord.xy, frameTile_velLenScale.xy) * mainTiling_Offset.xy + mainTiling_Offset.zw;\npos = cc_matViewProj * pos;\nreturn pos;\n}\nvoid main() { gl_Position = lpvs_main(); }",frag:"\nprecision mediump float;\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nvarying vec2 uv;\nvarying vec4 color;\nuniform sampler2D mainTexture;\nuniform vec4 tintColor;\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture2D(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nvoid main() { gl_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nuniform highp mat4 cc_matViewProj;\n#if USE_LOCAL\nuniform highp mat4 cc_matWorld;\n#endif\nattribute vec3 a_position;\nattribute vec2 a_texCoord;\nattribute vec4 a_color;\nvarying vec4 v_light;\nvarying vec2 uv0;\n#if TWO_COLORED\nattribute vec4 a_color2;\nvarying vec4 v_dark;\n#endif\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\n#if USE_LOCAL\npos = cc_matWorld * pos;\n#endif\npos = cc_matViewProj * pos;\nuv0 = a_texCoord;\nv_light = a_color;\n#if TWO_COLORED\nv_dark = a_color2;\n#endif\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\n#if USE_ALPHA_TEST\nuniform float alphaThreshold;\n#endif\nvoid ALPHA_TEST (in vec4 color) {\n#if USE_ALPHA_TEST\nif (color.a < alphaThreshold) discard;\n#endif\n}\nvoid ALPHA_TEST (in float alpha) {\n#if USE_ALPHA_TEST\nif (alpha < alphaThreshold) discard;\n#endif\n}\nvarying vec4 v_light;\n#if TWO_COLORED\nvarying vec4 v_dark;\n#endif\nvarying vec2 uv0;\nuniform sampler2D cc_spriteTexture;\nvec4 frag () {\nvec4 o = vec4(1, 1, 1, 1);\n#if TWO_COLORED\nvec4 texColor = vec4(1, 1, 1, 1);\ntexColor *= texture2D(cc_spriteTexture, uv0);\no.a = texColor.a * v_light.a;\no.rgb = ((texColor.a - 1.0) * v_dark.a + 1.0 - texColor.rgb) * v_dark.rgb + texColor.rgb * v_light.rgb;\n#else\no *= texture2D(cc_spriteTexture, uv0);\no *= v_light;\n#endif\nALPHA_TEST(o);\nreturn o;\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_cameraPos;\n#if USE_LOCAL\nuniform highp mat4 cc_matWorld;\n#endif\n#if SAMPLE_FROM_RT\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\n#endif\nattribute vec3 a_position;\nattribute vec2 a_texCoord;\nattribute vec4 a_color;\nvarying vec4 color;\nvarying vec2 uv0;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\n#if USE_LOCAL\npos = cc_matWorld * pos;\n#endif\n#if USE_PIXEL_ALIGNMENT\npos = cc_matView * pos;\npos.xyz = floor(pos.xyz);\npos = cc_matProj * pos;\n#else\npos = cc_matViewProj * pos;\n#endif\nuv0 = a_texCoord;\n#if SAMPLE_FROM_RT\nuv0 = cc_cameraPos.w > 1.0 ? vec2(uv0.x, 1.0 - uv0.y) : uv0;\n#endif\ncolor = a_color;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 CCSampleWithAlphaSeparated(sampler2D tex, vec2 uv) {\n#if CC_USE_EMBEDDED_ALPHA\nreturn vec4(texture2D(tex, uv).rgb, texture2D(tex, uv + vec2(0.0, 0.5)).r);\n#else\nreturn texture2D(tex, uv);\n#endif\n}\n#if USE_ALPHA_TEST\nuniform float alphaThreshold;\n#endif\nvoid ALPHA_TEST (in vec4 color) {\n#if USE_ALPHA_TEST\nif (color.a < alphaThreshold) discard;\n#endif\n}\nvoid ALPHA_TEST (in float alpha) {\n#if USE_ALPHA_TEST\nif (alpha < alphaThreshold) discard;\n#endif\n}\nvarying vec4 color;\n#if USE_TEXTURE\nvarying vec2 uv0;\nuniform sampler2D cc_spriteTexture;\n#endif\nvec4 frag () {\nvec4 o = vec4(1, 1, 1, 1);\n#if USE_TEXTURE\no *= CCSampleWithAlphaSeparated(cc_spriteTexture, uv0);\n#if IS_GRAY\nfloat gray  = 0.2126 * o.r + 0.7152 * o.g + 0.0722 * o.b;\no.r = o.g = o.b = gray;\n#endif\n#endif\no *= color;\nALPHA_TEST(o);\nreturn o;\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#endif\n#if USE_INSTANCING\n#if CC_USE_BAKED_ANIMATION\nattribute highp vec4 a_jointAnimInfo;\n#endif\nattribute vec4 a_matWorld0;\nattribute vec4 a_matWorld1;\nattribute vec4 a_matWorld2;\n#if CC_USE_LIGHTMAP\nattribute vec4 a_lightingMapUVParam;\n#endif\n#if CC_RECEIVE_SHADOW\nattribute vec2 a_localShadowBias;\n#endif\n#elif USE_BATCHING\nattribute float a_dyn_batch_id;\n#endif\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\n#endif\n#if CC_USE_MORPH\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nnormal.xyz = normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\ntangent.xyz = tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\n#if CC_USE_BAKED_ANIMATION\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\nvoid CCGetJointTextureCoords(float pixelsPerJoint, float jointIdx, out highp float x, out highp float y, out highp float invSize)\n{\n#if USE_INSTANCING\nhighp float temp = pixelsPerJoint * (a_jointAnimInfo.x * a_jointAnimInfo.y + jointIdx) + a_jointAnimInfo.z;\n#else\nhighp float temp = pixelsPerJoint * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + jointIdx) + cc_jointTextureInfo.z;\n#endif\ninvSize = cc_jointTextureInfo.w;\nhighp float tempY = floor(temp * invSize);\nx = floor(temp - tempY * cc_jointTextureInfo.x);\ny = (tempY + 0.5) * invSize;\n}\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(3.0, i, x, y, invSize);\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(12.0, i, x, y, invSize);\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nmat4 m = skinMatrix();\nposition = m * position;\nnormal = (m * vec4(normal, 0.0)).xyz;\ntangent.xyz = (m * vec4(tangent.xyz, 0.0)).xyz;\n}\n#endif\nvoid CCVertInput(inout StandardVertInput In)\n{\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In.position, In.normal, In.tangent);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In.position, In.normal, In.tangent);\n#endif\n}\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\n#if !USE_INSTANCING\n#if USE_BATCHING\nuniform highp mat4 cc_matWorlds[10];\n#else\nuniform highp mat4 cc_matWorld;\nuniform highp mat4 cc_matWorldIT;\nuniform highp vec4 cc_lightingMapUVParam;\nuniform highp vec4 cc_localShadowBias;\n#endif\n#endif\nvoid CCGetWorldMatrixFull(out mat4 matWorld, out mat4 matWorldIT)\n{\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\nmatWorldIT = matWorld;\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\nmatWorldIT = matWorld;\n#else\nmatWorld = cc_matWorld;\nmatWorldIT = cc_matWorldIT;\n#endif\n}\nuniform vec4 tilingOffset;\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\n#if !CC_USE_ACCURATE_FOG\nvarying float v_fog_factor;\n#endif\nvoid CC_TRANSFER_FOG(vec4 pos) {\n#if !CC_USE_ACCURATE_FOG\nCC_TRANSFER_FOG_BASE(pos, v_fog_factor);\n#endif\n}\nvarying highp vec4 v_shadowPos;\nuniform highp mat4 cc_matLightViewProj;\nuniform mediump vec4 cc_shadowWHPBInfo;\nuniform mediump vec4 cc_shadowLPNNInfo;\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\n#endif\n#if CC_RECEIVE_SHADOW\nvec2 CCGetShadowBias()\n{\n#if USE_INSTANCING\nreturn vec2(a_localShadowBias.x + cc_shadowWHPBInfo.w, a_localShadowBias.y + cc_shadowLPNNInfo.z);\n#elif !USE_BATCHING\nreturn vec2(cc_localShadowBias.x + cc_shadowWHPBInfo.w, cc_localShadowBias.y + cc_shadowLPNNInfo.z);\n#else\nreturn vec2(cc_shadowWHPBInfo.w, cc_shadowLPNNInfo.z);\n#endif\n}\n#endif\n#if USE_VERTEX_COLOR\nattribute vec4 a_color;\nvarying lowp vec4 v_color;\n#endif\nvarying vec3 v_position;\nvarying mediump vec3 v_normal;\nvarying vec2 v_uv;\n#if HAS_SECOND_UV\nvarying mediump vec2 v_uv1;\n#endif\n#if CC_RECEIVE_SHADOW\nvarying mediump vec2 v_shadowBias;\n#endif\n#if USE_NORMAL_MAP\nvarying mediump vec4 v_tangent;\n#endif\n#if HAS_SECOND_UV || CC_USE_LIGHTMAP\nattribute vec2 a_texCoord1;\n#endif\n#if CC_USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvarying vec3 v_luv;\nvoid CCLightingMapCaclUV()\n{\n#if !USE_INSTANCING\nv_luv.xy = cc_lightingMapUVParam.xy + a_texCoord1 * cc_lightingMapUVParam.z;\nv_luv.z = cc_lightingMapUVParam.w;\n#else\nv_luv.xy = a_lightingMapUVParam.xy + a_texCoord1 * a_lightingMapUVParam.z;\nv_luv.z = a_lightingMapUVParam.w;\n#endif\n}\n#endif\nvoid main () {\nStandardVertInput In;\nCCVertInput(In);\nmat4 matWorld, matWorldIT;\nCCGetWorldMatrixFull(matWorld, matWorldIT);\nvec4 pos = matWorld * In.position;\nv_position = pos.xyz;\nv_normal = normalize((matWorldIT * vec4(In.normal, 0.0)).xyz);\n#if CC_RECEIVE_SHADOW\nv_shadowBias = CCGetShadowBias();\n#endif\n#if USE_TWOSIDE\nvec3 viewDirect = normalize(cc_cameraPos.xyz - v_position);\nv_normal *= dot(v_normal, viewDirect) < 0.0 ? -1.0 : 1.0;\n#endif\n#if USE_NORMAL_MAP\nv_tangent.xyz = normalize((matWorld * vec4(In.tangent.xyz, 0.0)).xyz);\nv_tangent.w = In.tangent.w;\n#endif\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv = cc_cameraPos.w > 1.0 ? vec2(v_uv.x, 1.0 - v_uv.y) : v_uv;\n#endif\n#if HAS_SECOND_UV\nv_uv1 = a_texCoord1 * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv1 = cc_cameraPos.w > 1.0 ? vec2(v_uv1.x, 1.0 - v_uv1.y) : v_uv1;\n#endif\n#endif\n#if USE_VERTEX_COLOR\nv_color = a_color;\n#endif\nCC_TRANSFER_FOG(pos);\nv_shadowPos = cc_matLightViewProj * pos;\n#if CC_USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nCCLightingMapCaclUV();\n#endif\ngl_Position = cc_matProj * (cc_matView * matWorld) * In.position;\n}",frag:"\n#ifdef GL_EXT_draw_buffers\n#extension GL_EXT_draw_buffers: enable\n#endif\n#ifdef GL_OES_standard_derivatives\n#extension GL_OES_standard_derivatives: enable\n#endif\n#ifdef GL_EXT_shader_texture_lod\n#extension GL_EXT_shader_texture_lod: enable\n#endif\nprecision highp float;\nuniform highp mat4 cc_matView;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_mainLitDir;\nuniform mediump vec4 cc_mainLitColor;\nuniform mediump vec4 cc_ambientSky;\nuniform mediump vec4 cc_ambientGround;\nuniform mediump vec4 cc_fogColor;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\nuniform mediump vec4 cc_nearFar;\nuniform mediump vec4 cc_viewPort;\nuniform vec4 albedo;\nuniform vec4 albedoScaleAndCutoff;\nuniform vec4 pbrParams;\nuniform vec4 emissive;\nuniform vec4 emissiveScaleParam;\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\nvoid CC_APPLY_FOG_BASE(inout vec4 color, float factor) {\ncolor = vec4(mix(cc_fogColor.rgb, color.rgb, factor), color.a);\n}\n#if !CC_USE_ACCURATE_FOG\nvarying float v_fog_factor;\n#endif\nvoid CC_APPLY_FOG(inout vec4 color) {\n#if !CC_USE_ACCURATE_FOG\nCC_APPLY_FOG_BASE(color, v_fog_factor);\n#endif\n}\nvoid CC_APPLY_FOG(inout vec4 color, vec3 worldPos) {\n#if CC_USE_ACCURATE_FOG\nfloat factor;\nCC_TRANSFER_FOG_BASE(vec4(worldPos, 1.0), factor);\n#else\nfloat factor = v_fog_factor;\n#endif\nCC_APPLY_FOG_BASE(color, factor);\n}\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nuniform highp mat4 cc_matLightView;\nuniform highp vec4 cc_shadowInvProjDepthInfo;\nuniform highp vec4 cc_shadowProjDepthInfo;\nuniform highp vec4 cc_shadowProjInfo;\nuniform mediump vec4 cc_shadowNFLSInfo;\nuniform mediump vec4 cc_shadowWHPBInfo;\nuniform mediump vec4 cc_shadowLPNNInfo;\nhighp float unpackHighpData (float mainPart, float modPart) {\nhighp float data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out float mainPart, out float modPart, highp float data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp float unpackHighpData (float mainPart, float modPart, const float modValue) {\nhighp float data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out float mainPart, out float modPart, highp float data, const float modValue) {\nhighp float divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart) {\nhighp vec2 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec2 mainPart, out vec2 modPart, highp vec2 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart, const float modValue) {\nhighp vec2 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec2 mainPart, out vec2 modPart, highp vec2 data, const float modValue) {\nhighp vec2 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart) {\nhighp vec3 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec3 mainPart, out vec3 modPart, highp vec3 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart, const float modValue) {\nhighp vec3 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec3 mainPart, out vec3 modPart, highp vec3 data, const float modValue) {\nhighp vec3 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart) {\nhighp vec4 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec4 mainPart, out vec4 modPart, highp vec4 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart, const float modValue) {\nhighp vec4 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec4 mainPart, out vec4 modPart, highp vec4 data, const float modValue) {\nhighp vec4 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\nvec4 ApplyShadowDepthBias_FaceNormal(vec4 shadowPos, vec3 worldNormal, float normalBias)\n{\nvec4 newShadowPos = shadowPos;\nif(normalBias > EPSILON_LOWP)\n{\nvec4 viewNormal = cc_matLightView * vec4(worldNormal, 0.0);\nif(viewNormal.z < 0.1)\nnewShadowPos.xy += viewNormal.xy * cc_shadowProjInfo.xy * normalBias * clamp(viewNormal.z, 0.001, 0.1);\n}\nreturn newShadowPos;\n}\nvec4 ApplyShadowDepthBias_Perspective(vec4 shadowPos, float viewspaceDepthBias)\n{\nvec3 viewSpacePos;\nviewSpacePos.xy = shadowPos.xy * cc_shadowProjInfo.zw;\nviewSpacePos.z = shadowPos.z * cc_shadowInvProjDepthInfo.x + shadowPos.w * cc_shadowInvProjDepthInfo.y;\nviewSpacePos.xyz += cc_shadowProjDepthInfo.z * normalize(viewSpacePos.xyz) * viewspaceDepthBias;\nvec4 clipSpacePos;\nclipSpacePos.xy = viewSpacePos.xy * cc_shadowProjInfo.xy;\nclipSpacePos.zw = viewSpacePos.z * cc_shadowProjDepthInfo.xz + vec2(cc_shadowProjDepthInfo.y, 0.0);\nif (cc_shadowNFLSInfo.z > EPSILON) {\nclipSpacePos.z = CCGetLinearDepthFromViewSpace(viewSpacePos.xyz);\nclipSpacePos.z = (clipSpacePos.z * 2.0 - 1.0) * clipSpacePos.w;\n}\nreturn clipSpacePos;\n}\nvec4 ApplyShadowDepthBias_Orthographic(vec4 shadowPos, float viewspaceDepthBias)\n{\nfloat coeffA = cc_shadowProjDepthInfo.x;\nfloat coeffB = cc_shadowProjDepthInfo.y;\nfloat viewSpacePos_z = (shadowPos.z - coeffB) / coeffA;\nviewSpacePos_z += viewspaceDepthBias;\nvec4 result = shadowPos;\nresult.z = viewSpacePos_z * coeffA + coeffB;\nreturn result;\n}\nfloat CCGetShadowFactorHard (vec4 shadowPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nclosestDepth = dot(texture2D(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture2D(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(clipPos.z, closestDepth);\nreturn shadow;\n}\nfloat CCGetShadowFactorSoft (vec4 shadowPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nblock0 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * mapSize.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetShadowFactorSoft2X (vec4 shadowPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nblock0 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCGetSpotLightShadowFactorHard (vec4 shadowPos, vec3 worldPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = clipPos.z;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nclosestDepth = dot(texture2D(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture2D(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(depth, closestDepth);\nreturn shadow;\n}\nfloat CCGetSpotLightShadowFactorSoft (vec4 shadowPos, vec3 worldPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > EPSILON) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nvec2 oneTap = 1.0 / cc_shadowWHPBInfo.xy;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nblock0 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * cc_shadowWHPBInfo.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * cc_shadowWHPBInfo.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetSpotLightShadowFactorSoft2X (vec4 shadowPos, vec3 worldPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > EPSILON) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nblock0 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCSpotShadowFactorBase(vec4 shadowPos, vec3 worldPos, vec2 shadowBias)\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) {\nreturn CCGetSpotLightShadowFactorSoft2X(shadowPos, worldPos, shadowBias.x);\n}else if (pcf > 0.9) {\nreturn CCGetSpotLightShadowFactorSoft(shadowPos, worldPos, shadowBias.x);\n}else {\nreturn CCGetSpotLightShadowFactorHard(shadowPos, worldPos, shadowBias.x);\n}\n}\nfloat CCShadowFactorBase(vec4 shadowPos, vec3 N, vec2 shadowBias)\n{\nfloat realtimeShadow = 1.0;\nvec4 pos = ApplyShadowDepthBias_FaceNormal(shadowPos, N, shadowBias.y);\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) {\nrealtimeShadow =  CCGetShadowFactorSoft2X(pos, shadowBias.x);\n}else if (pcf > 0.9) {\nrealtimeShadow = CCGetShadowFactorSoft(pos, shadowBias.x);\n}else {\nrealtimeShadow = CCGetShadowFactorHard(pos, shadowBias.x);\n}\nreturn mix(realtimeShadow, 1.0, cc_shadowNFLSInfo.w);\n}\n#endif\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\n#ifdef GL_EXT_shader_texture_lod\nreturn texture2DLodEXT(tex, coord, lod);\n#else\nreturn texture2D(tex, coord, lod);\n#endif\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\n#ifdef GL_EXT_shader_texture_lod\nreturn textureCubeLodEXT(tex, coord, lod);\n#else\nreturn textureCube(tex, coord, lod);\n#endif\n}\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\n#if CC_USE_DIFFUSEMAP\nuniform samplerCube cc_diffuseMap;\n#endif\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\n#if USE_REFLECTION_DENOISE\nvec3 GetEnvReflectionWithMipFiltering(vec3 R, float roughness, float mipCount, float denoiseIntensity) {\n#if CC_USE_IBL\nfloat mip = roughness * mipCount;\nfloat delta = (dot(dFdx(R), dFdy(R))) * 1000.0;\nfloat mipBias = mix(0.0, 5.0, clamp(delta, 0.0, 1.0));\nvec4 biased = fragTextureLod(cc_environment, R, mip + mipBias);\nvec4 filtered = textureCube(cc_environment, R);\n#if CC_USE_IBL == 2\nbiased.rgb = unpackRGBE(biased);\nfiltered.rgb = unpackRGBE(filtered);\n#else\nbiased.rgb = SRGBToLinear(biased.rgb);\nfiltered.rgb = SRGBToLinear(filtered.rgb);\n#endif\nreturn mix(biased.rgb, filtered.rgb, denoiseIntensity);\n#else\nreturn vec3(0.0, 0.0, 0.0);\n#endif\n}\n#endif\nstruct StandardSurface {\nvec4 albedo;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nvec3 position, position_fract_part;\n#else\nvec3 position;\n#endif\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\nfloat specularIntensity;\n#if CC_RECEIVE_SHADOW\nvec2 shadowBias;\n#endif\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.08 * s.specularIntensity), s.albedo.rgb, s.metallic);\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.0);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse / PI;\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nvec3 dirlightContrib = (diffuseContrib + specularContrib);\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (NL > 0.0 && cc_mainLitDir.w > 0.0) {\nshadow = CCShadowFactorBase(shadowPos, N, s.shadowBias);\n}\n#endif\ndirlightContrib *= shadow;\nfinalColor *= dirlightContrib;\n#if CC_USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > EPSILON_LOWP) {\nfinalColor = diffuse * s.lightmap.rgb * shadow;\n}\n#endif\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb);\n#if CC_USE_IBL\n#if CC_USE_DIFFUSEMAP\nvec4 diffuseMap = textureCube(cc_diffuseMap, N);\n#if CC_USE_DIFFUSEMAP == 2\nambDiff = unpackRGBE(diffuseMap);\n#else\nambDiff = SRGBToLinear(diffuseMap.rgb);\n#endif\n#endif\nvec3 R = normalize(reflect(-V, N));\n#if USE_REFLECTION_DENOISE\nvec3 env = GetEnvReflectionWithMipFiltering(R, s.roughness, cc_ambientGround.w, 0.6);\n#else\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\n#endif\nfinalColor += env * cc_ambientSky.w * specular * s.occlusion;\n#endif\nfinalColor += ambDiff.rgb * cc_ambientSky.w * diffuse * s.occlusion;\nfinalColor += s.emissive;\nreturn vec4(finalColor, s.albedo.a);\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nvarying highp vec4 v_shadowPos;\n#if CC_RECEIVE_SHADOW\n#endif\n#if CC_USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvarying vec3 v_luv;\nuniform sampler2D cc_lightingMap;\n#endif\nvarying vec3 v_position;\nvarying vec2 v_uv;\n#if HAS_SECOND_UV\nvarying mediump vec2 v_uv1;\n#endif\nvarying mediump vec3 v_normal;\n#if CC_RECEIVE_SHADOW\nvarying mediump vec2 v_shadowBias;\n#endif\n#if USE_VERTEX_COLOR\nvarying lowp vec4 v_color;\n#endif\n#if USE_ALBEDO_MAP\nuniform sampler2D albedoMap;\n#endif\n#if USE_NORMAL_MAP\nvarying mediump vec4 v_tangent;\nuniform sampler2D normalMap;\n#endif\n#if USE_PBR_MAP\nuniform sampler2D pbrMap;\n#endif\n#if USE_METALLIC_ROUGHNESS_MAP\nuniform sampler2D metallicRoughnessMap;\n#endif\n#if USE_OCCLUSION_MAP\nuniform sampler2D occlusionMap;\n#endif\n#if USE_EMISSIVE_MAP\nuniform sampler2D emissiveMap;\n#endif\n#if USE_ALPHA_TEST\n#endif\nvoid surf (out StandardSurface s) {\nvec4 baseColor = albedo;\n#if USE_VERTEX_COLOR\nbaseColor.rgb *= SRGBToLinear(v_color.rgb);\nbaseColor.a *= v_color.a;\n#endif\n#if USE_ALBEDO_MAP\nvec4 texColor = texture2D(albedoMap, ALBEDO_UV);\ntexColor.rgb = SRGBToLinear(texColor.rgb);\nbaseColor *= texColor;\n#endif\ns.albedo = baseColor;\ns.albedo.rgb *= albedoScaleAndCutoff.xyz;\n#if USE_ALPHA_TEST\nif (s.albedo.ALPHA_TEST_CHANNEL < albedoScaleAndCutoff.w) discard;\n#endif\n#if CC_USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvec4 lightColor = texture2D(cc_lightingMap, v_luv.xy);\ns.lightmap = lightColor.xyz * v_luv.z;\ns.lightmap_test = v_luv.z;\n#endif\ns.normal = v_normal;\n#if CC_RECEIVE_SHADOW\ns.shadowBias = v_shadowBias;\n#endif\n#if USE_NORMAL_MAP\nvec3 nmmp = texture2D(normalMap, NORMAL_UV).xyz - vec3(0.5);\nvec3 bitangent = cross(v_normal, v_tangent.xyz) * v_tangent.w;\ns.normal =\n(nmmp.x * emissiveScaleParam.w) * normalize(v_tangent.xyz) +\n(nmmp.y * emissiveScaleParam.w) * normalize(bitangent) +\nnmmp.z * normalize(s.normal);\n#endif\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\npackHighpData(s.position, s.position_fract_part, v_position);\n#else\ns.position = v_position;\n#endif\nvec4 pbr = pbrParams;\n#if USE_PBR_MAP\nvec4 res = texture2D(pbrMap, PBR_UV);\npbr.x *= res.r;\npbr.y *= res.g;\npbr.z *= res.b;\npbr.w *= res.a;\n#endif\n#if USE_METALLIC_ROUGHNESS_MAP\nvec4 metallicRoughness = texture2D(metallicRoughnessMap, PBR_UV);\npbr.z *= metallicRoughness.b;\npbr.y *= metallicRoughness.g;\n#endif\n#if USE_OCCLUSION_MAP\npbr.x *= texture2D(occlusionMap, PBR_UV).r;\n#endif\ns.occlusion = pbr.x;\ns.roughness = pbr.y;\ns.specularIntensity = 0.5;\ns.metallic = pbr.z;\ns.emissive = emissive.rgb * emissiveScaleParam.xyz;\n#if USE_EMISSIVE_MAP\ns.emissive *= SRGBToLinear(texture2D(emissiveMap, EMISSIVE_UV).rgb);\n#endif\n}\n#if CC_FORWARD_ADD\n#if CC_PIPELINE_TYPE == 0\n#define LIGHTS_PER_PASS 1\n#else\n#define LIGHTS_PER_PASS 10\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nuniform highp vec4 cc_lightPos[LIGHTS_PER_PASS];\nuniform vec4 cc_lightColor[LIGHTS_PER_PASS];\nuniform vec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nuniform vec4 cc_lightDir[LIGHTS_PER_PASS];\n#endif\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / PI;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.0);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = litRadiusSqr / max(litRadiusSqr, distSqr);\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0 && cc_lightSizeRangeAngle[i].w > 0.0) {\nshadow = CCSpotShadowFactorBase(shadowPos, position, s.shadowBias);\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nreadonly buffer b_ccLightsBuffer { vec4 b_ccLights[]; };\nreadonly buffer b_clusterLightIndicesBuffer { uint b_clusterLightIndices[]; };\nreadonly buffer b_clusterLightGridBuffer { uvec4 b_clusterLightGrid[]; };\nstruct CCLight\n{\nvec4 cc_lightPos;\nvec4 cc_lightColor;\nvec4 cc_lightSizeRangeAngle;\nvec4 cc_lightDir;\n};\nstruct Cluster\n{\nvec3 minBounds;\nvec3 maxBounds;\n};\nstruct LightGrid\n{\nuint offset;\nuint ccLights;\n};\nCCLight getCCLight(uint i)\n{\nCCLight light;\nlight.cc_lightPos = b_ccLights[4u * i + 0u];\nlight.cc_lightColor = b_ccLights[4u * i + 1u];\nlight.cc_lightSizeRangeAngle = b_ccLights[4u * i + 2u];\nlight.cc_lightDir = b_ccLights[4u * i + 3u];\nreturn light;\n}\nLightGrid getLightGrid(uint cluster)\n{\nuvec4 gridvec = b_clusterLightGrid[cluster];\nLightGrid grid;\ngrid.offset = gridvec.x;\ngrid.ccLights = gridvec.y;\nreturn grid;\n}\nuint getGridLightIndex(uint start, uint offset)\n{\nreturn b_clusterLightIndices[start + offset];\n}\nuint getClusterZIndex(vec4 worldPos)\n{\nfloat scale = float(24) / log(cc_nearFar.y / cc_nearFar.x);\nfloat bias = -(float(24) * log(cc_nearFar.x) / log(cc_nearFar.y / cc_nearFar.x));\nfloat eyeDepth = -(cc_matView * worldPos).z;\nuint zIndex = uint(max(log(eyeDepth) * scale + bias, 0.0));\nreturn zIndex;\n}\nuint getClusterIndex(vec4 fragCoord, vec4 worldPos)\n{\nuint zIndex = getClusterZIndex(worldPos);\nfloat clusterSizeX = ceil(cc_viewPort.z / float(16));\nfloat clusterSizeY = ceil(cc_viewPort.w / float(8));\nuvec3 indices = uvec3(uvec2(fragCoord.xy / vec2(clusterSizeX, clusterSizeY)), zIndex);\nuint cluster = (16u * 8u) * indices.z + 16u * indices.y + indices.x;\nreturn cluster;\n}\nvec4 CCClusterShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / PI;\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nuint cluster = getClusterIndex(gl_FragCoord, vec4(position, 1.0));\nLightGrid grid = getLightGrid(cluster);\nuint numLights = grid.ccLights;\nfor (uint i = 0u; i < 100u; i++) {\nif (i >= numLights) break;\nuint lightIndex = getGridLightIndex(grid.offset, i);\nCCLight light = getCCLight(lightIndex);\nvec3 SLU = light.cc_lightPos.xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.001);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = light.cc_lightSizeRangeAngle.x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = PI * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(light.cc_lightSizeRangeAngle.y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (light.cc_lightPos.w > 0.0) {\nfloat cosInner = max(dot(-light.cc_lightDir.xyz, SL), 0.01);\nfloat cosOuter = light.cc_lightSizeRangeAngle.z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -light.cc_lightDir.xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = light.cc_lightColor.rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (light.cc_lightPos.w > 0.0) {\nshadow = CCSpotShadowFactorBase(shadowPos, position, s.shadowBias);\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * light.cc_lightColor.w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\nvoid main () {\nStandardSurface s; surf(s);\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nvec4 color = CCClusterShadingAdditive(s, v_shadowPos);\n#else\nvec4 color = CCStandardShadingAdditive(s, v_shadowPos);\n#endif\ngl_FragData[0] = CCFragOutput(color);\n}\n#elif (CC_PIPELINE_TYPE == 0 || CC_FORCE_FORWARD_SHADING)\nvoid main () {\nStandardSurface s; surf(s);\nvec4 color = CCStandardShadingBase(s, v_shadowPos);\nCC_APPLY_FOG(color, s.position.xyz);\ngl_FragData[0] = CCFragOutput(color);\n}\n#elif CC_PIPELINE_TYPE == 1\nvec2 signNotZero(vec2 v) {\nreturn vec2((v.x >= 0.0) ? +1.0 : -1.0, (v.y >= 0.0) ? +1.0 : -1.0);\n}\nvec2 float32x3_to_oct(in vec3 v) {\nvec2 p = v.xy * (1.0 / (abs(v.x) + abs(v.y) + abs(v.z)));\nreturn (v.z <= 0.0) ? ((1.0 - abs(p.yx)) * signNotZero(p)) : p;\n}\nvoid main () {\nStandardSurface s; surf(s);\ngl_FragData[0] = s.albedo;\ngl_FragData[1] = vec4(float32x3_to_oct(s.normal), s.roughness, s.metallic);\ngl_FragData[2] = vec4(s.emissive, s.occlusion);\n}\n#endif"},{vert:"\nprecision highp float;\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#endif\n#if USE_INSTANCING\n#if CC_USE_BAKED_ANIMATION\nattribute highp vec4 a_jointAnimInfo;\n#endif\nattribute vec4 a_matWorld0;\nattribute vec4 a_matWorld1;\nattribute vec4 a_matWorld2;\n#if CC_USE_LIGHTMAP\nattribute vec4 a_lightingMapUVParam;\n#endif\n#if CC_RECEIVE_SHADOW\nattribute vec2 a_localShadowBias;\n#endif\n#elif USE_BATCHING\nattribute float a_dyn_batch_id;\n#endif\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\n#endif\n#if CC_USE_MORPH\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nnormal.xyz = normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\ntangent.xyz = tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\n#if CC_USE_BAKED_ANIMATION\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\nvoid CCGetJointTextureCoords(float pixelsPerJoint, float jointIdx, out highp float x, out highp float y, out highp float invSize)\n{\n#if USE_INSTANCING\nhighp float temp = pixelsPerJoint * (a_jointAnimInfo.x * a_jointAnimInfo.y + jointIdx) + a_jointAnimInfo.z;\n#else\nhighp float temp = pixelsPerJoint * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + jointIdx) + cc_jointTextureInfo.z;\n#endif\ninvSize = cc_jointTextureInfo.w;\nhighp float tempY = floor(temp * invSize);\nx = floor(temp - tempY * cc_jointTextureInfo.x);\ny = (tempY + 0.5) * invSize;\n}\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(3.0, i, x, y, invSize);\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(12.0, i, x, y, invSize);\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nmat4 m = skinMatrix();\nposition = m * position;\nnormal = (m * vec4(normal, 0.0)).xyz;\ntangent.xyz = (m * vec4(tangent.xyz, 0.0)).xyz;\n}\n#endif\nvoid CCVertInput(inout StandardVertInput In)\n{\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In.position, In.normal, In.tangent);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In.position, In.normal, In.tangent);\n#endif\n}\n#if !USE_INSTANCING\n#if USE_BATCHING\nuniform highp mat4 cc_matWorlds[10];\n#else\nuniform highp mat4 cc_matWorld;\nuniform highp mat4 cc_matWorldIT;\n#endif\n#endif\nvoid CCGetWorldMatrixFull(out mat4 matWorld, out mat4 matWorldIT)\n{\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\nmatWorldIT = matWorld;\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\nmatWorldIT = matWorld;\n#else\nmatWorld = cc_matWorld;\nmatWorldIT = cc_matWorldIT;\n#endif\n}\nuniform vec4 tilingOffset;\nuniform highp mat4 cc_matLightViewProj;\n#if HAS_SECOND_UV || CC_USE_LIGHTMAP\nattribute vec2 a_texCoord1;\n#endif\nvarying vec2 v_uv;\n#if HAS_SECOND_UV\nvarying vec2 v_uv1;\n#endif\nvarying vec4 v_worldPos;\nvarying float v_clip_depth;\nvec4 vert () {\nStandardVertInput In;\nCCVertInput(In);\nmat4 matWorld, matWorldIT;\nCCGetWorldMatrixFull(matWorld, matWorldIT);\nv_worldPos = matWorld * In.position;\nvec4 clipPos = cc_matLightViewProj * v_worldPos;\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if HAS_SECOND_UV\nv_uv1 = a_texCoord1 * tilingOffset.xy + tilingOffset.zw;\n#endif\nv_clip_depth = clipPos.z / clipPos.w * 0.5 + 0.5;\nreturn clipPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nuniform vec4 albedo;\nuniform vec4 albedoScaleAndCutoff;\nvec4 packDepthToRGBA (float depth) {\nvec4 ret = vec4(1.0, 255.0, 65025.0, 16581375.0) * depth;\nret = fract(ret);\nret -= vec4(ret.yzw, 0.0) / 255.0;\nreturn ret;\n}\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nuniform highp mat4 cc_matLightView;\nuniform mediump vec4 cc_shadowNFLSInfo;\nuniform mediump vec4 cc_shadowLPNNInfo;\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\n#endif\nvarying vec2 v_uv;\n#if HAS_SECOND_UV\nvarying vec2 v_uv1;\n#endif\nvarying vec4 v_worldPos;\nvarying float v_clip_depth;\n#if USE_ALBEDO_MAP\nuniform sampler2D albedoMap;\n#endif\n#if USE_ALPHA_TEST\n#endif\nvec4 frag () {\nvec4 baseColor = albedo;\n#if USE_ALBEDO_MAP\nbaseColor *= texture2D(albedoMap, ALBEDO_UV);\n#endif\n#if USE_ALPHA_TEST\nif (baseColor.ALPHA_TEST_CHANNEL < albedoScaleAndCutoff.w) discard;\n#endif\nif(cc_shadowLPNNInfo.x > 0.000001 && cc_shadowLPNNInfo.x < 1.999999) {\nif (cc_shadowNFLSInfo.z > 0.000001) {\nreturn vec4(CCGetLinearDepth(v_worldPos.xyz), 1.0, 1.0, 1.0);\n}\n}\nif (cc_shadowLPNNInfo.y > 0.000001) {\nreturn packDepthToRGBA(v_clip_depth);\n}\nreturn vec4(v_clip_depth, 1.0, 1.0, 1.0);\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\nuniform highp mat4 cc_matWorld;\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\n#if !CC_USE_ACCURATE_FOG\nvarying float v_fog_factor;\n#endif\nvoid CC_TRANSFER_FOG(vec4 pos) {\n#if !CC_USE_ACCURATE_FOG\nCC_TRANSFER_FOG_BASE(pos, v_fog_factor);\n#endif\n}\nvarying highp vec4 v_shadowPos;\nuniform highp mat4 cc_matLightViewProj;\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\n#endif\n#if CC_RECEIVE_SHADOW\n#endif\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\n#if CC_RECEIVE_SHADOW\nvarying vec2 v_shadowBias;\n#endif\nvarying highp vec3 v_position;\nvarying mediump vec3 v_normal;\nvarying mediump vec2 uvw;\nvarying mediump vec2 uv0;\nvarying mediump vec2 uv1;\nvarying mediump vec2 uv2;\nvarying mediump vec2 uv3;\nvarying mediump vec3 luv;\nvarying mediump vec3 diffuse;\nuniform vec4 UVScale;\nuniform vec4 lightMapUVParam;\nvoid main () {\nvec3 worldPos;\nworldPos.x = cc_matWorld[3][0] + a_position.x;\nworldPos.y = cc_matWorld[3][1] + a_position.y;\nworldPos.z = cc_matWorld[3][2] + a_position.z;\nvec4 pos = vec4(worldPos, 1.0);\npos = cc_matViewProj * pos;\nuvw = a_texCoord;\nuv0 = a_position.xz * UVScale.x;\nuv1 = a_position.xz * UVScale.y;\nuv2 = a_position.xz * UVScale.z;\nuv3 = a_position.xz * UVScale.w;\n#if CC_USE_LIGHTMAP\nluv.xy = lightMapUVParam.xy + a_texCoord * lightMapUVParam.z;\nluv.z = lightMapUVParam.w;\n#endif\nv_position = worldPos;\nv_normal = a_normal;\nCC_TRANSFER_FOG(vec4(worldPos, 1.0));\n#if CC_RECEIVE_SHADOW\nv_shadowBias = vec2(0.0, 0.0);\n#endif\nv_shadowPos = cc_matLightViewProj * vec4(worldPos, 1.0);\ngl_Position = pos;\n}",frag:"\n#ifdef GL_EXT_draw_buffers\n#extension GL_EXT_draw_buffers: enable\n#endif\n#ifdef GL_OES_standard_derivatives\n#extension GL_OES_standard_derivatives: enable\n#endif\n#ifdef GL_EXT_shader_texture_lod\n#extension GL_EXT_shader_texture_lod: enable\n#endif\nprecision highp float;\nuniform highp mat4 cc_matView;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_mainLitDir;\nuniform mediump vec4 cc_mainLitColor;\nuniform mediump vec4 cc_ambientSky;\nuniform mediump vec4 cc_ambientGround;\nuniform mediump vec4 cc_fogColor;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\nuniform mediump vec4 cc_nearFar;\nuniform mediump vec4 cc_viewPort;\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nuniform highp mat4 cc_matLightView;\nuniform highp vec4 cc_shadowInvProjDepthInfo;\nuniform highp vec4 cc_shadowProjDepthInfo;\nuniform highp vec4 cc_shadowProjInfo;\nuniform mediump vec4 cc_shadowNFLSInfo;\nuniform mediump vec4 cc_shadowWHPBInfo;\nuniform mediump vec4 cc_shadowLPNNInfo;\nhighp float unpackHighpData (float mainPart, float modPart) {\nhighp float data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out float mainPart, out float modPart, highp float data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp float unpackHighpData (float mainPart, float modPart, const float modValue) {\nhighp float data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out float mainPart, out float modPart, highp float data, const float modValue) {\nhighp float divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart) {\nhighp vec2 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec2 mainPart, out vec2 modPart, highp vec2 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart, const float modValue) {\nhighp vec2 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec2 mainPart, out vec2 modPart, highp vec2 data, const float modValue) {\nhighp vec2 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart) {\nhighp vec3 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec3 mainPart, out vec3 modPart, highp vec3 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart, const float modValue) {\nhighp vec3 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec3 mainPart, out vec3 modPart, highp vec3 data, const float modValue) {\nhighp vec3 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart) {\nhighp vec4 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec4 mainPart, out vec4 modPart, highp vec4 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart, const float modValue) {\nhighp vec4 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec4 mainPart, out vec4 modPart, highp vec4 data, const float modValue) {\nhighp vec4 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\nvec4 ApplyShadowDepthBias_FaceNormal(vec4 shadowPos, vec3 worldNormal, float normalBias)\n{\nvec4 newShadowPos = shadowPos;\nif(normalBias > EPSILON_LOWP)\n{\nvec4 viewNormal = cc_matLightView * vec4(worldNormal, 0.0);\nif(viewNormal.z < 0.1)\nnewShadowPos.xy += viewNormal.xy * cc_shadowProjInfo.xy * normalBias * clamp(viewNormal.z, 0.001, 0.1);\n}\nreturn newShadowPos;\n}\nvec4 ApplyShadowDepthBias_Perspective(vec4 shadowPos, float viewspaceDepthBias)\n{\nvec3 viewSpacePos;\nviewSpacePos.xy = shadowPos.xy * cc_shadowProjInfo.zw;\nviewSpacePos.z = shadowPos.z * cc_shadowInvProjDepthInfo.x + shadowPos.w * cc_shadowInvProjDepthInfo.y;\nviewSpacePos.xyz += cc_shadowProjDepthInfo.z * normalize(viewSpacePos.xyz) * viewspaceDepthBias;\nvec4 clipSpacePos;\nclipSpacePos.xy = viewSpacePos.xy * cc_shadowProjInfo.xy;\nclipSpacePos.zw = viewSpacePos.z * cc_shadowProjDepthInfo.xz + vec2(cc_shadowProjDepthInfo.y, 0.0);\nif (cc_shadowNFLSInfo.z > EPSILON) {\nclipSpacePos.z = CCGetLinearDepthFromViewSpace(viewSpacePos.xyz);\nclipSpacePos.z = (clipSpacePos.z * 2.0 - 1.0) * clipSpacePos.w;\n}\nreturn clipSpacePos;\n}\nvec4 ApplyShadowDepthBias_Orthographic(vec4 shadowPos, float viewspaceDepthBias)\n{\nfloat coeffA = cc_shadowProjDepthInfo.x;\nfloat coeffB = cc_shadowProjDepthInfo.y;\nfloat viewSpacePos_z = (shadowPos.z - coeffB) / coeffA;\nviewSpacePos_z += viewspaceDepthBias;\nvec4 result = shadowPos;\nresult.z = viewSpacePos_z * coeffA + coeffB;\nreturn result;\n}\nfloat CCGetShadowFactorHard (vec4 shadowPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nclosestDepth = dot(texture2D(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture2D(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(clipPos.z, closestDepth);\nreturn shadow;\n}\nfloat CCGetShadowFactorSoft (vec4 shadowPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nblock0 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * mapSize.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetShadowFactorSoft2X (vec4 shadowPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nblock0 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCGetSpotLightShadowFactorHard (vec4 shadowPos, vec3 worldPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = clipPos.z;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nclosestDepth = dot(texture2D(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture2D(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(depth, closestDepth);\nreturn shadow;\n}\nfloat CCGetSpotLightShadowFactorSoft (vec4 shadowPos, vec3 worldPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > EPSILON) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nvec2 oneTap = 1.0 / cc_shadowWHPBInfo.xy;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nblock0 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * cc_shadowWHPBInfo.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * cc_shadowWHPBInfo.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetSpotLightShadowFactorSoft2X (vec4 shadowPos, vec3 worldPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > EPSILON) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nblock0 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCSpotShadowFactorBase(vec4 shadowPos, vec3 worldPos, vec2 shadowBias)\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) {\nreturn CCGetSpotLightShadowFactorSoft2X(shadowPos, worldPos, shadowBias.x);\n}else if (pcf > 0.9) {\nreturn CCGetSpotLightShadowFactorSoft(shadowPos, worldPos, shadowBias.x);\n}else {\nreturn CCGetSpotLightShadowFactorHard(shadowPos, worldPos, shadowBias.x);\n}\n}\nfloat CCShadowFactorBase(vec4 shadowPos, vec3 N, vec2 shadowBias)\n{\nfloat realtimeShadow = 1.0;\nvec4 pos = ApplyShadowDepthBias_FaceNormal(shadowPos, N, shadowBias.y);\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) {\nrealtimeShadow =  CCGetShadowFactorSoft2X(pos, shadowBias.x);\n}else if (pcf > 0.9) {\nrealtimeShadow = CCGetShadowFactorSoft(pos, shadowBias.x);\n}else {\nrealtimeShadow = CCGetShadowFactorHard(pos, shadowBias.x);\n}\nreturn mix(realtimeShadow, 1.0, cc_shadowNFLSInfo.w);\n}\n#endif\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\n#ifdef GL_EXT_shader_texture_lod\nreturn texture2DLodEXT(tex, coord, lod);\n#else\nreturn texture2D(tex, coord, lod);\n#endif\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\n#ifdef GL_EXT_shader_texture_lod\nreturn textureCubeLodEXT(tex, coord, lod);\n#else\nreturn textureCube(tex, coord, lod);\n#endif\n}\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\n#if CC_USE_DIFFUSEMAP\nuniform samplerCube cc_diffuseMap;\n#endif\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\n#if USE_REFLECTION_DENOISE\nvec3 GetEnvReflectionWithMipFiltering(vec3 R, float roughness, float mipCount, float denoiseIntensity) {\n#if CC_USE_IBL\nfloat mip = roughness * mipCount;\nfloat delta = (dot(dFdx(R), dFdy(R))) * 1000.0;\nfloat mipBias = mix(0.0, 5.0, clamp(delta, 0.0, 1.0));\nvec4 biased = fragTextureLod(cc_environment, R, mip + mipBias);\nvec4 filtered = textureCube(cc_environment, R);\n#if CC_USE_IBL == 2\nbiased.rgb = unpackRGBE(biased);\nfiltered.rgb = unpackRGBE(filtered);\n#else\nbiased.rgb = SRGBToLinear(biased.rgb);\nfiltered.rgb = SRGBToLinear(filtered.rgb);\n#endif\nreturn mix(biased.rgb, filtered.rgb, denoiseIntensity);\n#else\nreturn vec3(0.0, 0.0, 0.0);\n#endif\n}\n#endif\nstruct StandardSurface {\nvec4 albedo;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nvec3 position, position_fract_part;\n#else\nvec3 position;\n#endif\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\nfloat specularIntensity;\n#if CC_RECEIVE_SHADOW\nvec2 shadowBias;\n#endif\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.08 * s.specularIntensity), s.albedo.rgb, s.metallic);\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.0);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse / PI;\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nvec3 dirlightContrib = (diffuseContrib + specularContrib);\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (NL > 0.0 && cc_mainLitDir.w > 0.0) {\nshadow = CCShadowFactorBase(shadowPos, N, s.shadowBias);\n}\n#endif\ndirlightContrib *= shadow;\nfinalColor *= dirlightContrib;\n#if CC_USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > EPSILON_LOWP) {\nfinalColor = diffuse * s.lightmap.rgb * shadow;\n}\n#endif\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb);\n#if CC_USE_IBL\n#if CC_USE_DIFFUSEMAP\nvec4 diffuseMap = textureCube(cc_diffuseMap, N);\n#if CC_USE_DIFFUSEMAP == 2\nambDiff = unpackRGBE(diffuseMap);\n#else\nambDiff = SRGBToLinear(diffuseMap.rgb);\n#endif\n#endif\nvec3 R = normalize(reflect(-V, N));\n#if USE_REFLECTION_DENOISE\nvec3 env = GetEnvReflectionWithMipFiltering(R, s.roughness, cc_ambientGround.w, 0.6);\n#else\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\n#endif\nfinalColor += env * cc_ambientSky.w * specular * s.occlusion;\n#endif\nfinalColor += ambDiff.rgb * cc_ambientSky.w * diffuse * s.occlusion;\nfinalColor += s.emissive;\nreturn vec4(finalColor, s.albedo.a);\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\nvoid CC_APPLY_FOG_BASE(inout vec4 color, float factor) {\ncolor = vec4(mix(cc_fogColor.rgb, color.rgb, factor), color.a);\n}\n#if !CC_USE_ACCURATE_FOG\nvarying float v_fog_factor;\n#endif\nvoid CC_APPLY_FOG(inout vec4 color) {\n#if !CC_USE_ACCURATE_FOG\nCC_APPLY_FOG_BASE(color, v_fog_factor);\n#endif\n}\nvoid CC_APPLY_FOG(inout vec4 color, vec3 worldPos) {\n#if CC_USE_ACCURATE_FOG\nfloat factor;\nCC_TRANSFER_FOG_BASE(vec4(worldPos, 1.0), factor);\n#else\nfloat factor = v_fog_factor;\n#endif\nCC_APPLY_FOG_BASE(color, factor);\n}\nvarying highp vec4 v_shadowPos;\n#if CC_RECEIVE_SHADOW\n#endif\n#if CC_USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvarying vec3 v_luv;\nuniform sampler2D cc_lightingMap;\n#endif\nvarying highp vec3 v_position;\nvarying mediump vec3 v_normal;\n#if CC_RECEIVE_SHADOW\nvarying vec2 v_shadowBias;\n#endif\nvarying mediump vec2 uvw;\nvarying mediump vec2 uv0;\nvarying mediump vec2 uv1;\nvarying mediump vec2 uv2;\nvarying mediump vec2 uv3;\nvarying mediump vec3 diffuse;\nvarying mediump vec3 luv;\nuniform vec4 metallic;\nuniform vec4 roughness;\nuniform sampler2D weightMap;\nuniform sampler2D detailMap0;\nuniform sampler2D detailMap1;\nuniform sampler2D detailMap2;\nuniform sampler2D detailMap3;\nuniform sampler2D normalMap0;\nuniform sampler2D normalMap1;\nuniform sampler2D normalMap2;\nuniform sampler2D normalMap3;\nuniform sampler2D lightMap;\nvoid surf (out StandardSurface s) {\n#if LAYERS > 1\nvec4 w = texture2D(weightMap, uvw);\n#endif\nvec4 baseColor = vec4(0, 0, 0, 0);\n#if LAYERS == 1\nbaseColor = texture2D(detailMap0, uv0);\n#elif LAYERS == 2\nbaseColor += texture2D(detailMap0, uv0) * w.r;\nbaseColor += texture2D(detailMap1, uv1) * w.g;\n#elif LAYERS == 3\nbaseColor += texture2D(detailMap0, uv0) * w.r;\nbaseColor += texture2D(detailMap1, uv1) * w.g;\nbaseColor += texture2D(detailMap2, uv2) * w.b;\n#elif LAYERS == 4\nbaseColor += texture2D(detailMap0, uv0) * w.r;\nbaseColor += texture2D(detailMap1, uv1) * w.g;\nbaseColor += texture2D(detailMap2, uv2) * w.b;\nbaseColor += texture2D(detailMap3, uv3) * w.a;\n#else\nbaseColor = texture2D(detailMap0, uv0);\n#endif\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\npackHighpData(s.position, s.position_fract_part, v_position);\n#else\ns.position = v_position;\n#endif\n#if USE_NORMALMAP\nvec4 baseNormal = vec4(0, 0, 0, 0);\n#if LAYERS == 1\nbaseNormal = texture2D(normalMap0, uv0);\n#elif LAYERS == 2\nbaseNormal += texture2D(normalMap0, uv0) * w.r;\nbaseNormal += texture2D(normalMap1, uv1) * w.g;\n#elif LAYERS == 3\nbaseNormal += texture2D(normalMap0, uv0) * w.r;\nbaseNormal += texture2D(normalMap1, uv1) * w.g;\nbaseNormal += texture2D(normalMap2, uv2) * w.b;\n#elif LAYERS == 4\nbaseNormal += texture2D(normalMap0, uv0) * w.r;\nbaseNormal += texture2D(normalMap1, uv1) * w.g;\nbaseNormal += texture2D(normalMap2, uv2) * w.b;\nbaseNormal += texture2D(normalMap3, uv3) * w.a;\n#else\nbaseNormal = texture2D(normalMap0, uv0);\n#endif\nvec3 tangent = vec3(1.0, 0.0, 0.0);\nvec3 binormal = vec3(0.0, 0.0, 1.0);\nbinormal = cross(tangent, v_normal);\ntangent = cross(v_normal, binormal);\nvec3 nmmp = baseNormal.xyz - vec3(0.5);\ns.normal =\nnmmp.x * normalize(tangent) +\nnmmp.y * normalize(binormal) +\nnmmp.z * normalize(v_normal);\n#else\ns.normal = v_normal;\n#endif\n#if CC_RECEIVE_SHADOW\ns.shadowBias = v_shadowBias;\n#endif\ns.albedo = vec4(SRGBToLinear(baseColor.rgb), 1.0);\ns.occlusion = 1.0;\n#if USE_PBR\ns.roughness = 0.0;\n#if LAYERS == 1\ns.roughness = roughness.x;\n#elif LAYERS == 2\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\n#elif LAYERS == 3\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\ns.roughness += roughness.z * w.b;\n#elif LAYERS == 4\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\ns.roughness += roughness.z * w.b;\ns.roughness += roughness.w * w.a;\n#else\ns.roughness = 1.0;\n#endif\ns.specularIntensity = 0.5;\ns.metallic = 0.0;\n#if LAYERS == 1\ns.specularIntensity = 0.5;\ns.metallic = metallic.x;\n#elif LAYERS == 2\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\n#elif LAYERS == 3\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\ns.metallic += metallic.z * w.b;\n#elif LAYERS == 4\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\ns.metallic += metallic.z * w.b;\ns.metallic += metallic.w * w.a;\n#else\ns.specularIntensity = 0.5;\ns.metallic = 0.0;\n#endif\n#else\ns.roughness = 1.0;\ns.specularIntensity = 0.5;\ns.metallic = 0.0;\n#endif\ns.emissive = vec3(0.0, 0.0, 0.0);\n#if CC_USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvec4 lightColor = texture2D(lightMap, luv.xy);\ns.lightmap = lightColor.xyz * luv.z;\ns.lightmap_test = luv.z;\n#endif\n}\n#if CC_FORWARD_ADD\n#if CC_PIPELINE_TYPE == 0\n#define LIGHTS_PER_PASS 1\n#else\n#define LIGHTS_PER_PASS 10\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nuniform highp vec4 cc_lightPos[LIGHTS_PER_PASS];\nuniform vec4 cc_lightColor[LIGHTS_PER_PASS];\nuniform vec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nuniform vec4 cc_lightDir[LIGHTS_PER_PASS];\n#endif\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / PI;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.0);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = litRadiusSqr / max(litRadiusSqr, distSqr);\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0 && cc_lightSizeRangeAngle[i].w > 0.0) {\nshadow = CCSpotShadowFactorBase(shadowPos, position, s.shadowBias);\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nreadonly buffer b_ccLightsBuffer { vec4 b_ccLights[]; };\nreadonly buffer b_clusterLightIndicesBuffer { uint b_clusterLightIndices[]; };\nreadonly buffer b_clusterLightGridBuffer { uvec4 b_clusterLightGrid[]; };\nstruct CCLight\n{\nvec4 cc_lightPos;\nvec4 cc_lightColor;\nvec4 cc_lightSizeRangeAngle;\nvec4 cc_lightDir;\n};\nstruct Cluster\n{\nvec3 minBounds;\nvec3 maxBounds;\n};\nstruct LightGrid\n{\nuint offset;\nuint ccLights;\n};\nCCLight getCCLight(uint i)\n{\nCCLight light;\nlight.cc_lightPos = b_ccLights[4u * i + 0u];\nlight.cc_lightColor = b_ccLights[4u * i + 1u];\nlight.cc_lightSizeRangeAngle = b_ccLights[4u * i + 2u];\nlight.cc_lightDir = b_ccLights[4u * i + 3u];\nreturn light;\n}\nLightGrid getLightGrid(uint cluster)\n{\nuvec4 gridvec = b_clusterLightGrid[cluster];\nLightGrid grid;\ngrid.offset = gridvec.x;\ngrid.ccLights = gridvec.y;\nreturn grid;\n}\nuint getGridLightIndex(uint start, uint offset)\n{\nreturn b_clusterLightIndices[start + offset];\n}\nuint getClusterZIndex(vec4 worldPos)\n{\nfloat scale = float(24) / log(cc_nearFar.y / cc_nearFar.x);\nfloat bias = -(float(24) * log(cc_nearFar.x) / log(cc_nearFar.y / cc_nearFar.x));\nfloat eyeDepth = -(cc_matView * worldPos).z;\nuint zIndex = uint(max(log(eyeDepth) * scale + bias, 0.0));\nreturn zIndex;\n}\nuint getClusterIndex(vec4 fragCoord, vec4 worldPos)\n{\nuint zIndex = getClusterZIndex(worldPos);\nfloat clusterSizeX = ceil(cc_viewPort.z / float(16));\nfloat clusterSizeY = ceil(cc_viewPort.w / float(8));\nuvec3 indices = uvec3(uvec2(fragCoord.xy / vec2(clusterSizeX, clusterSizeY)), zIndex);\nuint cluster = (16u * 8u) * indices.z + 16u * indices.y + indices.x;\nreturn cluster;\n}\nvec4 CCClusterShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / PI;\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nuint cluster = getClusterIndex(gl_FragCoord, vec4(position, 1.0));\nLightGrid grid = getLightGrid(cluster);\nuint numLights = grid.ccLights;\nfor (uint i = 0u; i < 100u; i++) {\nif (i >= numLights) break;\nuint lightIndex = getGridLightIndex(grid.offset, i);\nCCLight light = getCCLight(lightIndex);\nvec3 SLU = light.cc_lightPos.xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.001);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = light.cc_lightSizeRangeAngle.x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = PI * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(light.cc_lightSizeRangeAngle.y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (light.cc_lightPos.w > 0.0) {\nfloat cosInner = max(dot(-light.cc_lightDir.xyz, SL), 0.01);\nfloat cosOuter = light.cc_lightSizeRangeAngle.z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -light.cc_lightDir.xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = light.cc_lightColor.rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (light.cc_lightPos.w > 0.0) {\nshadow = CCSpotShadowFactorBase(shadowPos, position, s.shadowBias);\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * light.cc_lightColor.w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\nvoid main () {\nStandardSurface s; surf(s);\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nvec4 color = CCClusterShadingAdditive(s, v_shadowPos);\n#else\nvec4 color = CCStandardShadingAdditive(s, v_shadowPos);\n#endif\ngl_FragData[0] = CCFragOutput(color);\n}\n#elif (CC_PIPELINE_TYPE == 0 || CC_FORCE_FORWARD_SHADING)\nvoid main () {\nStandardSurface s; surf(s);\nvec4 color = CCStandardShadingBase(s, v_shadowPos);\nCC_APPLY_FOG(color, s.position.xyz);\ngl_FragData[0] = CCFragOutput(color);\n}\n#elif CC_PIPELINE_TYPE == 1\nvec2 signNotZero(vec2 v) {\nreturn vec2((v.x >= 0.0) ? +1.0 : -1.0, (v.y >= 0.0) ? +1.0 : -1.0);\n}\nvec2 float32x3_to_oct(in vec3 v) {\nvec2 p = v.xy * (1.0 / (abs(v.x) + abs(v.y) + abs(v.z)));\nreturn (v.z <= 0.0) ? ((1.0 - abs(p.yx)) * signNotZero(p)) : p;\n}\nvoid main () {\nStandardSurface s; surf(s);\ngl_FragData[0] = s.albedo;\ngl_FragData[1] = vec4(float32x3_to_oct(s.normal), s.roughness, s.metallic);\ngl_FragData[2] = vec4(s.emissive, s.occlusion);\n}\n#endif"},{vert:"\nprecision highp float;\nuniform highp mat4 cc_matWorld;\nuniform highp mat4 cc_matLightViewProj;\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nvarying vec2 v_clip_depth;\nvec4 vert () {\nvec4 worldPos;\nworldPos.x = cc_matWorld[3][0] + a_position.x;\nworldPos.y = cc_matWorld[3][1] + a_position.y;\nworldPos.z = cc_matWorld[3][2] + a_position.z;\nworldPos.w = 1.0;\nvec4 clipPos = cc_matLightViewProj * worldPos;\nv_clip_depth = clipPos.zw;\nreturn clipPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 packDepthToRGBA (float depth) {\nvec4 ret = vec4(1.0, 255.0, 65025.0, 16581375.0) * depth;\nret = fract(ret);\nret -= vec4(ret.yzw, 0.0) / 255.0;\nreturn ret;\n}\nvarying vec2 v_clip_depth;\nvec4 frag () {\nreturn packDepthToRGBA(v_clip_depth.x / v_clip_depth.y * 0.5 + 0.5);\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#endif\n#if USE_INSTANCING\n#if CC_USE_BAKED_ANIMATION\nattribute highp vec4 a_jointAnimInfo;\n#endif\nattribute vec4 a_matWorld0;\nattribute vec4 a_matWorld1;\nattribute vec4 a_matWorld2;\n#if CC_USE_LIGHTMAP\nattribute vec4 a_lightingMapUVParam;\n#endif\n#if CC_RECEIVE_SHADOW\nattribute vec2 a_localShadowBias;\n#endif\n#elif USE_BATCHING\nattribute float a_dyn_batch_id;\n#endif\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\n#endif\n#if CC_USE_MORPH\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nnormal.xyz = normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\ntangent.xyz = tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\n#if CC_USE_BAKED_ANIMATION\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\nvoid CCGetJointTextureCoords(float pixelsPerJoint, float jointIdx, out highp float x, out highp float y, out highp float invSize)\n{\n#if USE_INSTANCING\nhighp float temp = pixelsPerJoint * (a_jointAnimInfo.x * a_jointAnimInfo.y + jointIdx) + a_jointAnimInfo.z;\n#else\nhighp float temp = pixelsPerJoint * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + jointIdx) + cc_jointTextureInfo.z;\n#endif\ninvSize = cc_jointTextureInfo.w;\nhighp float tempY = floor(temp * invSize);\nx = floor(temp - tempY * cc_jointTextureInfo.x);\ny = (tempY + 0.5) * invSize;\n}\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(3.0, i, x, y, invSize);\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(12.0, i, x, y, invSize);\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nmat4 m = skinMatrix();\nposition = m * position;\nnormal = (m * vec4(normal, 0.0)).xyz;\ntangent.xyz = (m * vec4(tangent.xyz, 0.0)).xyz;\n}\n#endif\nvoid CCVertInput(inout vec4 In)\n{\nIn = vec4(a_position, 1.0);\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\n}\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\n#if !USE_INSTANCING\n#if USE_BATCHING\nuniform highp mat4 cc_matWorlds[10];\n#else\nuniform highp mat4 cc_matWorld;\n#endif\n#endif\nvoid CCGetWorldMatrix(out mat4 matWorld)\n{\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\n#else\nmatWorld = cc_matWorld;\n#endif\n}\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\n#if !CC_USE_ACCURATE_FOG\nvarying float v_fog_factor;\n#endif\nvoid CC_TRANSFER_FOG(vec4 pos) {\n#if !CC_USE_ACCURATE_FOG\nCC_TRANSFER_FOG_BASE(pos, v_fog_factor);\n#endif\n}\n#if USE_VERTEX_COLOR\nattribute lowp vec4 a_color;\nvarying lowp vec4 v_color;\n#endif\n#if USE_TEXTURE\nvarying vec2 v_uv;\nuniform vec4 tilingOffset;\n#endif\nvec4 vert () {\nvec4 position;\nCCVertInput(position);\nmat4 matWorld;\nCCGetWorldMatrix(matWorld);\n#if USE_TEXTURE\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv = cc_cameraPos.w > 1.0 ? vec2(v_uv.x, 1.0 - v_uv.y) : v_uv;\n#endif\n#endif\n#if USE_VERTEX_COLOR\nv_color = a_color;\n#endif\nCC_TRANSFER_FOG(matWorld * position);\nreturn cc_matProj * (cc_matView * matWorld) * position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_fogColor;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\nvoid CC_APPLY_FOG_BASE(inout vec4 color, float factor) {\ncolor = vec4(mix(cc_fogColor.rgb, color.rgb, factor), color.a);\n}\n#if !CC_USE_ACCURATE_FOG\nvarying float v_fog_factor;\n#endif\nvoid CC_APPLY_FOG(inout vec4 color) {\n#if !CC_USE_ACCURATE_FOG\nCC_APPLY_FOG_BASE(color, v_fog_factor);\n#endif\n}\nvoid CC_APPLY_FOG(inout vec4 color, vec3 worldPos) {\n#if CC_USE_ACCURATE_FOG\nfloat factor;\nCC_TRANSFER_FOG_BASE(vec4(worldPos, 1.0), factor);\n#else\nfloat factor = v_fog_factor;\n#endif\nCC_APPLY_FOG_BASE(color, factor);\n}\n#if USE_ALPHA_TEST\n#endif\n#if USE_TEXTURE\nvarying vec2 v_uv;\nuniform sampler2D mainTexture;\n#endif\nuniform vec4 mainColor;\nuniform vec4 colorScaleAndCutoff;\n#if USE_VERTEX_COLOR\nvarying lowp vec4 v_color;\n#endif\nvec4 frag () {\nvec4 o = mainColor;\no.rgb *= colorScaleAndCutoff.xyz;\n#if USE_VERTEX_COLOR\no.rgb *= SRGBToLinear(v_color.rgb);\no.a *= v_color.a;\n#endif\n#if USE_TEXTURE\nvec4 texColor = texture2D(mainTexture, v_uv);\ntexColor.rgb = SRGBToLinear(texColor.rgb);\no *= texColor;\n#endif\n#if USE_ALPHA_TEST\nif (o.ALPHA_TEST_CHANNEL < colorScaleAndCutoff.w) discard;\n#endif\nCC_APPLY_FOG(o);\nreturn CCFragOutput(o);\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#endif\n#if USE_INSTANCING\n#if CC_USE_BAKED_ANIMATION\nattribute highp vec4 a_jointAnimInfo;\n#endif\nattribute vec4 a_matWorld0;\nattribute vec4 a_matWorld1;\nattribute vec4 a_matWorld2;\n#if CC_USE_LIGHTMAP\nattribute vec4 a_lightingMapUVParam;\n#endif\n#if CC_RECEIVE_SHADOW\nattribute vec2 a_localShadowBias;\n#endif\n#elif USE_BATCHING\nattribute float a_dyn_batch_id;\n#endif\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\n#endif\n#if CC_USE_MORPH\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nnormal.xyz = normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\ntangent.xyz = tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\n#if CC_USE_BAKED_ANIMATION\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\nvoid CCGetJointTextureCoords(float pixelsPerJoint, float jointIdx, out highp float x, out highp float y, out highp float invSize)\n{\n#if USE_INSTANCING\nhighp float temp = pixelsPerJoint * (a_jointAnimInfo.x * a_jointAnimInfo.y + jointIdx) + a_jointAnimInfo.z;\n#else\nhighp float temp = pixelsPerJoint * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + jointIdx) + cc_jointTextureInfo.z;\n#endif\ninvSize = cc_jointTextureInfo.w;\nhighp float tempY = floor(temp * invSize);\nx = floor(temp - tempY * cc_jointTextureInfo.x);\ny = (tempY + 0.5) * invSize;\n}\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(3.0, i, x, y, invSize);\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(12.0, i, x, y, invSize);\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nmat4 m = skinMatrix();\nposition = m * position;\nnormal = (m * vec4(normal, 0.0)).xyz;\ntangent.xyz = (m * vec4(tangent.xyz, 0.0)).xyz;\n}\n#endif\nvoid CCVertInput(inout StandardVertInput In)\n{\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In.position, In.normal, In.tangent);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In.position, In.normal, In.tangent);\n#endif\n}\nuniform highp vec4 cc_cameraPos;\nvarying vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nCCVertInput(In);\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvarying vec2 v_uv;\nuniform mediump vec4 texSize;\nuniform sampler2D outputResultMap;\nfloat luminance(vec3 color) {\nreturn dot(color, vec3(0.2126, 0.7152, 0.0722));\n}\nvoid main() {\nvec3 color = texture2D(outputResultMap, v_uv).xyz;\nif (luminance(SRGBToLinear(color)) > texSize.z) {\ngl_FragColor = vec4(color, 1.0);\n} else {\ngl_FragColor = vec4(0.0, 0.0, 0.0, 1.0);\n}\n}"},{vert:"\nprecision highp float;\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#endif\n#if USE_INSTANCING\n#if CC_USE_BAKED_ANIMATION\nattribute highp vec4 a_jointAnimInfo;\n#endif\nattribute vec4 a_matWorld0;\nattribute vec4 a_matWorld1;\nattribute vec4 a_matWorld2;\n#if CC_USE_LIGHTMAP\nattribute vec4 a_lightingMapUVParam;\n#endif\n#if CC_RECEIVE_SHADOW\nattribute vec2 a_localShadowBias;\n#endif\n#elif USE_BATCHING\nattribute float a_dyn_batch_id;\n#endif\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\n#endif\n#if CC_USE_MORPH\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nnormal.xyz = normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\ntangent.xyz = tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\n#if CC_USE_BAKED_ANIMATION\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\nvoid CCGetJointTextureCoords(float pixelsPerJoint, float jointIdx, out highp float x, out highp float y, out highp float invSize)\n{\n#if USE_INSTANCING\nhighp float temp = pixelsPerJoint * (a_jointAnimInfo.x * a_jointAnimInfo.y + jointIdx) + a_jointAnimInfo.z;\n#else\nhighp float temp = pixelsPerJoint * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + jointIdx) + cc_jointTextureInfo.z;\n#endif\ninvSize = cc_jointTextureInfo.w;\nhighp float tempY = floor(temp * invSize);\nx = floor(temp - tempY * cc_jointTextureInfo.x);\ny = (tempY + 0.5) * invSize;\n}\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(3.0, i, x, y, invSize);\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(12.0, i, x, y, invSize);\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nmat4 m = skinMatrix();\nposition = m * position;\nnormal = (m * vec4(normal, 0.0)).xyz;\ntangent.xyz = (m * vec4(tangent.xyz, 0.0)).xyz;\n}\n#endif\nvoid CCVertInput(inout StandardVertInput In)\n{\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In.position, In.normal, In.tangent);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In.position, In.normal, In.tangent);\n#endif\n}\nuniform highp vec4 cc_cameraPos;\nvarying vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nCCVertInput(In);\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nvarying vec2 v_uv;\nuniform mediump vec4 texSize;\nuniform sampler2D bloomTexture;\nvec3 downsample4taps(vec2 uv, vec2 halfpixel) {\nvec3 sum = texture2D(bloomTexture, uv + vec2(-halfpixel.x, halfpixel.y)).xyz;\nsum += texture2D(bloomTexture, uv + vec2(halfpixel.x, halfpixel.y)).xyz;\nsum += texture2D(bloomTexture, uv + vec2(halfpixel.x, -halfpixel.y)).xyz;\nsum += texture2D(bloomTexture, uv + vec2(-halfpixel.x, -halfpixel.y)).xyz;\nreturn sum / 4.0;\n}\nvoid main()\n{\nvec3 result = downsample4taps(v_uv, 1.0 / texSize.xy).rgb;\ngl_FragColor = vec4(result, 1.0);\n}"},{vert:"\nprecision highp float;\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#endif\n#if USE_INSTANCING\n#if CC_USE_BAKED_ANIMATION\nattribute highp vec4 a_jointAnimInfo;\n#endif\nattribute vec4 a_matWorld0;\nattribute vec4 a_matWorld1;\nattribute vec4 a_matWorld2;\n#if CC_USE_LIGHTMAP\nattribute vec4 a_lightingMapUVParam;\n#endif\n#if CC_RECEIVE_SHADOW\nattribute vec2 a_localShadowBias;\n#endif\n#elif USE_BATCHING\nattribute float a_dyn_batch_id;\n#endif\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\n#endif\n#if CC_USE_MORPH\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nnormal.xyz = normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\ntangent.xyz = tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\n#if CC_USE_BAKED_ANIMATION\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\nvoid CCGetJointTextureCoords(float pixelsPerJoint, float jointIdx, out highp float x, out highp float y, out highp float invSize)\n{\n#if USE_INSTANCING\nhighp float temp = pixelsPerJoint * (a_jointAnimInfo.x * a_jointAnimInfo.y + jointIdx) + a_jointAnimInfo.z;\n#else\nhighp float temp = pixelsPerJoint * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + jointIdx) + cc_jointTextureInfo.z;\n#endif\ninvSize = cc_jointTextureInfo.w;\nhighp float tempY = floor(temp * invSize);\nx = floor(temp - tempY * cc_jointTextureInfo.x);\ny = (tempY + 0.5) * invSize;\n}\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(3.0, i, x, y, invSize);\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(12.0, i, x, y, invSize);\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nmat4 m = skinMatrix();\nposition = m * position;\nnormal = (m * vec4(normal, 0.0)).xyz;\ntangent.xyz = (m * vec4(tangent.xyz, 0.0)).xyz;\n}\n#endif\nvoid CCVertInput(inout StandardVertInput In)\n{\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In.position, In.normal, In.tangent);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In.position, In.normal, In.tangent);\n#endif\n}\nuniform highp vec4 cc_cameraPos;\nvarying vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nCCVertInput(In);\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nvarying vec2 v_uv;\nuniform mediump vec4 texSize;\nuniform sampler2D bloomTexture;\nvec3 upsample4taps(vec2 uv, vec2 halfpixel) {\nvec3 sum = texture2D(bloomTexture, uv + vec2(-halfpixel.x, halfpixel.y)).xyz;\nsum += texture2D(bloomTexture, uv + vec2(halfpixel.x, halfpixel.y)).xyz;\nsum += texture2D(bloomTexture, uv + vec2(halfpixel.x, -halfpixel.y)).xyz;\nsum += texture2D(bloomTexture, uv + vec2(-halfpixel.x, -halfpixel.y)).xyz;\nreturn sum / 4.0;\n}\nvoid main() {\nvec3 result = upsample4taps(v_uv, 0.5 / texSize.xy).rgb;\ngl_FragColor = vec4(result, 1.0);\n}"},{vert:"\nprecision highp float;\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#endif\n#if USE_INSTANCING\n#if CC_USE_BAKED_ANIMATION\nattribute highp vec4 a_jointAnimInfo;\n#endif\nattribute vec4 a_matWorld0;\nattribute vec4 a_matWorld1;\nattribute vec4 a_matWorld2;\n#if CC_USE_LIGHTMAP\nattribute vec4 a_lightingMapUVParam;\n#endif\n#if CC_RECEIVE_SHADOW\nattribute vec2 a_localShadowBias;\n#endif\n#elif USE_BATCHING\nattribute float a_dyn_batch_id;\n#endif\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\n#endif\n#if CC_USE_MORPH\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nnormal.xyz = normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\ntangent.xyz = tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\n#if CC_USE_BAKED_ANIMATION\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\nvoid CCGetJointTextureCoords(float pixelsPerJoint, float jointIdx, out highp float x, out highp float y, out highp float invSize)\n{\n#if USE_INSTANCING\nhighp float temp = pixelsPerJoint * (a_jointAnimInfo.x * a_jointAnimInfo.y + jointIdx) + a_jointAnimInfo.z;\n#else\nhighp float temp = pixelsPerJoint * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + jointIdx) + cc_jointTextureInfo.z;\n#endif\ninvSize = cc_jointTextureInfo.w;\nhighp float tempY = floor(temp * invSize);\nx = floor(temp - tempY * cc_jointTextureInfo.x);\ny = (tempY + 0.5) * invSize;\n}\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(3.0, i, x, y, invSize);\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(12.0, i, x, y, invSize);\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nmat4 m = skinMatrix();\nposition = m * position;\nnormal = (m * vec4(normal, 0.0)).xyz;\ntangent.xyz = (m * vec4(tangent.xyz, 0.0)).xyz;\n}\n#endif\nvoid CCVertInput(inout StandardVertInput In)\n{\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In.position, In.normal, In.tangent);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In.position, In.normal, In.tangent);\n#endif\n}\nuniform highp vec4 cc_cameraPos;\nvarying vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nCCVertInput(In);\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nvarying vec2 v_uv;\nuniform mediump vec4 texSize;\nuniform sampler2D outputResultMap;\nuniform sampler2D bloomTexture;\nvoid main() {\nvec4 hdrColor = texture2D(outputResultMap, v_uv);\nvec3 bloomColor = texture2D(bloomTexture, v_uv).rgb;\nvec3 result = hdrColor.rgb + bloomColor * texSize.w * hdrColor.a;\ngl_FragColor = vec4(result, hdrColor.a);\n}"}],[{vert:"\nprecision highp float;\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#endif\n#if USE_INSTANCING\n#if CC_USE_BAKED_ANIMATION\nattribute highp vec4 a_jointAnimInfo;\n#endif\nattribute vec4 a_matWorld0;\nattribute vec4 a_matWorld1;\nattribute vec4 a_matWorld2;\n#if CC_USE_LIGHTMAP\nattribute vec4 a_lightingMapUVParam;\n#endif\n#if CC_RECEIVE_SHADOW\nattribute vec2 a_localShadowBias;\n#endif\n#elif USE_BATCHING\nattribute float a_dyn_batch_id;\n#endif\n#if CC_USE_MORPH\nattribute float a_vertexId;\n#endif\nuniform highp vec4 cc_cameraPos;\nvarying vec2 v_uv;\nvoid main () {\nvec4 position;\nposition = vec4(a_position, 1.0);\nposition.xy = cc_cameraPos.w == 0.0 ? vec2(position.xy.x, -position.xy.y) : position.xy;\ngl_Position = vec4(position.x, position.y, 1.0, 1.0);\nv_uv = a_texCoord;\n}",frag:"\n#ifdef GL_EXT_shader_framebuffer_fetch\n#extension GL_EXT_shader_framebuffer_fetch: enable\n#endif\n#ifdef GL_OES_standard_derivatives\n#extension GL_OES_standard_derivatives: enable\n#endif\n#ifdef GL_EXT_shader_texture_lod\n#extension GL_EXT_shader_texture_lod: enable\n#endif\nprecision highp float;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matViewProjInv;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_mainLitDir;\nuniform mediump vec4 cc_mainLitColor;\nuniform mediump vec4 cc_ambientSky;\nuniform mediump vec4 cc_ambientGround;\nuniform mediump vec4 cc_fogColor;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\nuniform mediump vec4 cc_nearFar;\nuniform mediump vec4 cc_viewPort;\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nuniform highp mat4 cc_matLightView;\nuniform highp mat4 cc_matLightViewProj;\nuniform highp vec4 cc_shadowInvProjDepthInfo;\nuniform highp vec4 cc_shadowProjDepthInfo;\nuniform highp vec4 cc_shadowProjInfo;\nuniform mediump vec4 cc_shadowNFLSInfo;\nuniform mediump vec4 cc_shadowWHPBInfo;\nuniform mediump vec4 cc_shadowLPNNInfo;\nhighp float unpackHighpData (float mainPart, float modPart) {\nhighp float data = mainPart;\nreturn data + modPart;\n}\nhighp float unpackHighpData (float mainPart, float modPart, const float modValue) {\nhighp float data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart) {\nhighp vec2 data = mainPart;\nreturn data + modPart;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart, const float modValue) {\nhighp vec2 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart) {\nhighp vec3 data = mainPart;\nreturn data + modPart;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart, const float modValue) {\nhighp vec3 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart) {\nhighp vec4 data = mainPart;\nreturn data + modPart;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart, const float modValue) {\nhighp vec4 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\nvec4 ApplyShadowDepthBias_FaceNormal(vec4 shadowPos, vec3 worldNormal, float normalBias)\n{\nvec4 newShadowPos = shadowPos;\nif(normalBias > EPSILON_LOWP)\n{\nvec4 viewNormal = cc_matLightView * vec4(worldNormal, 0.0);\nif(viewNormal.z < 0.1)\nnewShadowPos.xy += viewNormal.xy * cc_shadowProjInfo.xy * normalBias * clamp(viewNormal.z, 0.001, 0.1);\n}\nreturn newShadowPos;\n}\nvec4 ApplyShadowDepthBias_Perspective(vec4 shadowPos, float viewspaceDepthBias)\n{\nvec3 viewSpacePos;\nviewSpacePos.xy = shadowPos.xy * cc_shadowProjInfo.zw;\nviewSpacePos.z = shadowPos.z * cc_shadowInvProjDepthInfo.x + shadowPos.w * cc_shadowInvProjDepthInfo.y;\nviewSpacePos.xyz += cc_shadowProjDepthInfo.z * normalize(viewSpacePos.xyz) * viewspaceDepthBias;\nvec4 clipSpacePos;\nclipSpacePos.xy = viewSpacePos.xy * cc_shadowProjInfo.xy;\nclipSpacePos.zw = viewSpacePos.z * cc_shadowProjDepthInfo.xz + vec2(cc_shadowProjDepthInfo.y, 0.0);\nif (cc_shadowNFLSInfo.z > EPSILON) {\nclipSpacePos.z = CCGetLinearDepthFromViewSpace(viewSpacePos.xyz);\nclipSpacePos.z = (clipSpacePos.z * 2.0 - 1.0) * clipSpacePos.w;\n}\nreturn clipSpacePos;\n}\nvec4 ApplyShadowDepthBias_Orthographic(vec4 shadowPos, float viewspaceDepthBias)\n{\nfloat coeffA = cc_shadowProjDepthInfo.x;\nfloat coeffB = cc_shadowProjDepthInfo.y;\nfloat viewSpacePos_z = (shadowPos.z - coeffB) / coeffA;\nviewSpacePos_z += viewspaceDepthBias;\nvec4 result = shadowPos;\nresult.z = viewSpacePos_z * coeffA + coeffB;\nreturn result;\n}\nfloat CCGetShadowFactorHard (vec4 shadowPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nclosestDepth = dot(texture2D(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture2D(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(clipPos.z, closestDepth);\nreturn shadow;\n}\nfloat CCGetShadowFactorSoft (vec4 shadowPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nblock0 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * mapSize.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetShadowFactorSoft2X (vec4 shadowPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nblock0 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCGetSpotLightShadowFactorHard (vec4 shadowPos, vec3 worldPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = clipPos.z;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nclosestDepth = dot(texture2D(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture2D(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(depth, closestDepth);\nreturn shadow;\n}\nfloat CCGetSpotLightShadowFactorSoft (vec4 shadowPos, vec3 worldPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > EPSILON) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nvec2 oneTap = 1.0 / cc_shadowWHPBInfo.xy;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nblock0 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * cc_shadowWHPBInfo.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * cc_shadowWHPBInfo.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetSpotLightShadowFactorSoft2X (vec4 shadowPos, vec3 worldPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > EPSILON) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nblock0 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCSpotShadowFactorBase(vec4 shadowPos, vec3 worldPos, vec2 shadowBias)\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) {\nreturn CCGetSpotLightShadowFactorSoft2X(shadowPos, worldPos, shadowBias.x);\n}else if (pcf > 0.9) {\nreturn CCGetSpotLightShadowFactorSoft(shadowPos, worldPos, shadowBias.x);\n}else {\nreturn CCGetSpotLightShadowFactorHard(shadowPos, worldPos, shadowBias.x);\n}\n}\nfloat CCShadowFactorBase(vec4 shadowPos, vec3 N, vec2 shadowBias)\n{\nfloat realtimeShadow = 1.0;\nvec4 pos = ApplyShadowDepthBias_FaceNormal(shadowPos, N, shadowBias.y);\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) {\nrealtimeShadow =  CCGetShadowFactorSoft2X(pos, shadowBias.x);\n}else if (pcf > 0.9) {\nrealtimeShadow = CCGetShadowFactorSoft(pos, shadowBias.x);\n}else {\nrealtimeShadow = CCGetShadowFactorHard(pos, shadowBias.x);\n}\nreturn mix(realtimeShadow, 1.0, cc_shadowNFLSInfo.w);\n}\n#endif\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\n#ifdef GL_EXT_shader_texture_lod\nreturn texture2DLodEXT(tex, coord, lod);\n#else\nreturn texture2D(tex, coord, lod);\n#endif\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\n#ifdef GL_EXT_shader_texture_lod\nreturn textureCubeLodEXT(tex, coord, lod);\n#else\nreturn textureCube(tex, coord, lod);\n#endif\n}\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\n#if CC_USE_DIFFUSEMAP\nuniform samplerCube cc_diffuseMap;\n#endif\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\n#if USE_REFLECTION_DENOISE\nvec3 GetEnvReflectionWithMipFiltering(vec3 R, float roughness, float mipCount, float denoiseIntensity) {\n#if CC_USE_IBL\nfloat mip = roughness * mipCount;\nfloat delta = (dot(dFdx(R), dFdy(R))) * 1000.0;\nfloat mipBias = mix(0.0, 5.0, clamp(delta, 0.0, 1.0));\nvec4 biased = fragTextureLod(cc_environment, R, mip + mipBias);\nvec4 filtered = textureCube(cc_environment, R);\n#if CC_USE_IBL == 2\nbiased.rgb = unpackRGBE(biased);\nfiltered.rgb = unpackRGBE(filtered);\n#else\nbiased.rgb = SRGBToLinear(biased.rgb);\nfiltered.rgb = SRGBToLinear(filtered.rgb);\n#endif\nreturn mix(biased.rgb, filtered.rgb, denoiseIntensity);\n#else\nreturn vec3(0.0, 0.0, 0.0);\n#endif\n}\n#endif\nstruct StandardSurface {\nvec4 albedo;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nvec3 position, position_fract_part;\n#else\nvec3 position;\n#endif\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\nfloat specularIntensity;\n#if CC_RECEIVE_SHADOW\nvec2 shadowBias;\n#endif\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.08 * s.specularIntensity), s.albedo.rgb, s.metallic);\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.0);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse / PI;\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nvec3 dirlightContrib = (diffuseContrib + specularContrib);\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (NL > 0.0 && cc_mainLitDir.w > 0.0) {\nshadow = CCShadowFactorBase(shadowPos, N, s.shadowBias);\n}\n#endif\ndirlightContrib *= shadow;\nfinalColor *= dirlightContrib;\n#if CC_USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > EPSILON_LOWP) {\nfinalColor = diffuse * s.lightmap.rgb * shadow;\n}\n#endif\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb);\n#if CC_USE_IBL\n#if CC_USE_DIFFUSEMAP\nvec4 diffuseMap = textureCube(cc_diffuseMap, N);\n#if CC_USE_DIFFUSEMAP == 2\nambDiff = unpackRGBE(diffuseMap);\n#else\nambDiff = SRGBToLinear(diffuseMap.rgb);\n#endif\n#endif\nvec3 R = normalize(reflect(-V, N));\n#if USE_REFLECTION_DENOISE\nvec3 env = GetEnvReflectionWithMipFiltering(R, s.roughness, cc_ambientGround.w, 0.6);\n#else\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\n#endif\nfinalColor += env * cc_ambientSky.w * specular * s.occlusion;\n#endif\nfinalColor += ambDiff.rgb * cc_ambientSky.w * diffuse * s.occlusion;\nfinalColor += s.emissive;\nreturn vec4(finalColor, s.albedo.a);\n}\n#if CC_PIPELINE_TYPE == 0\n#define LIGHTS_PER_PASS 1\n#else\n#define LIGHTS_PER_PASS 10\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nuniform highp vec4 cc_lightPos[LIGHTS_PER_PASS];\nuniform vec4 cc_lightColor[LIGHTS_PER_PASS];\nuniform vec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nuniform vec4 cc_lightDir[LIGHTS_PER_PASS];\n#endif\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / PI;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.0);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = litRadiusSqr / max(litRadiusSqr, distSqr);\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0 && cc_lightSizeRangeAngle[i].w > 0.0) {\nshadow = CCSpotShadowFactorBase(shadowPos, position, s.shadowBias);\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nreadonly buffer b_ccLightsBuffer { vec4 b_ccLights[]; };\nreadonly buffer b_clusterLightIndicesBuffer { uint b_clusterLightIndices[]; };\nreadonly buffer b_clusterLightGridBuffer { uvec4 b_clusterLightGrid[]; };\nstruct CCLight\n{\nvec4 cc_lightPos;\nvec4 cc_lightColor;\nvec4 cc_lightSizeRangeAngle;\nvec4 cc_lightDir;\n};\nstruct Cluster\n{\nvec3 minBounds;\nvec3 maxBounds;\n};\nstruct LightGrid\n{\nuint offset;\nuint ccLights;\n};\nCCLight getCCLight(uint i)\n{\nCCLight light;\nlight.cc_lightPos = b_ccLights[4u * i + 0u];\nlight.cc_lightColor = b_ccLights[4u * i + 1u];\nlight.cc_lightSizeRangeAngle = b_ccLights[4u * i + 2u];\nlight.cc_lightDir = b_ccLights[4u * i + 3u];\nreturn light;\n}\nLightGrid getLightGrid(uint cluster)\n{\nuvec4 gridvec = b_clusterLightGrid[cluster];\nLightGrid grid;\ngrid.offset = gridvec.x;\ngrid.ccLights = gridvec.y;\nreturn grid;\n}\nuint getGridLightIndex(uint start, uint offset)\n{\nreturn b_clusterLightIndices[start + offset];\n}\nuint getClusterZIndex(vec4 worldPos)\n{\nfloat scale = float(24) / log(cc_nearFar.y / cc_nearFar.x);\nfloat bias = -(float(24) * log(cc_nearFar.x) / log(cc_nearFar.y / cc_nearFar.x));\nfloat eyeDepth = -(cc_matView * worldPos).z;\nuint zIndex = uint(max(log(eyeDepth) * scale + bias, 0.0));\nreturn zIndex;\n}\nuint getClusterIndex(vec4 fragCoord, vec4 worldPos)\n{\nuint zIndex = getClusterZIndex(worldPos);\nfloat clusterSizeX = ceil(cc_viewPort.z / float(16));\nfloat clusterSizeY = ceil(cc_viewPort.w / float(8));\nuvec3 indices = uvec3(uvec2(fragCoord.xy / vec2(clusterSizeX, clusterSizeY)), zIndex);\nuint cluster = (16u * 8u) * indices.z + 16u * indices.y + indices.x;\nreturn cluster;\n}\nvec4 CCClusterShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / PI;\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nuint cluster = getClusterIndex(gl_FragCoord, vec4(position, 1.0));\nLightGrid grid = getLightGrid(cluster);\nuint numLights = grid.ccLights;\nfor (uint i = 0u; i < 100u; i++) {\nif (i >= numLights) break;\nuint lightIndex = getGridLightIndex(grid.offset, i);\nCCLight light = getCCLight(lightIndex);\nvec3 SLU = light.cc_lightPos.xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.001);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = light.cc_lightSizeRangeAngle.x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = PI * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(light.cc_lightSizeRangeAngle.y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (light.cc_lightPos.w > 0.0) {\nfloat cosInner = max(dot(-light.cc_lightDir.xyz, SL), 0.01);\nfloat cosOuter = light.cc_lightSizeRangeAngle.z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -light.cc_lightDir.xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = light.cc_lightColor.rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (light.cc_lightPos.w > 0.0) {\nshadow = CCSpotShadowFactorBase(shadowPos, position, s.shadowBias);\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * light.cc_lightColor.w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\nvoid CC_APPLY_FOG_BASE(inout vec4 color, float factor) {\ncolor = vec4(mix(cc_fogColor.rgb, color.rgb, factor), color.a);\n}\nvec2 signNotZero(vec2 v) {\nreturn vec2((v.x >= 0.0) ? +1.0 : -1.0, (v.y >= 0.0) ? +1.0 : -1.0);\n}\nvec3 oct_to_float32x3(vec2 e) {\nvec3 v = vec3(e.xy, 1.0 - abs(e.x) - abs(e.y));\nif (v.z < 0.0) v.xy = (1.0 - abs(v.yx)) * signNotZero(v.xy);\nreturn normalize(v);\n}\nvec4 screen2WS(vec3 coord) {\nvec3 ndc = vec3(\n2.0 * (coord.x - cc_viewPort.x) / cc_viewPort.z - 1.0,\n2.0 * (coord.y - cc_viewPort.y) / cc_viewPort.w - 1.0,\n2.0 * coord.z - 1.0);\nvec4 world = ((cc_matViewProjInv) * (vec4(ndc, 1.0)));\nworld      = world / world.w;\nreturn world;\n}\nvarying vec2 v_uv;\n#if CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT\nuniform sampler2D depth_stencil;\n#else\nuniform sampler2D gbuffer_albedoMap;\nuniform sampler2D gbuffer_normalMap;\nuniform sampler2D gbuffer_emissiveMap;\nuniform sampler2D depth_stencil;\n#endif\n#if !CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT || __VERSION__ >= 450\n#endif\nvoid main () {\nStandardSurface s;\n#if CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT\nvec4 albedoMap = gl_LastFragData[0];\nvec4 normalMap = gl_LastFragData[1];\nvec4 emissiveMap = gl_LastFragData[2];\nfloat depth = texture2D(depth_stencil, v_uv).x;\n#else\nvec4 albedoMap = texture2D(gbuffer_albedoMap,v_uv);\nvec4 normalMap = texture2D(gbuffer_normalMap,v_uv);\nvec4 emissiveMap = texture2D(gbuffer_emissiveMap,v_uv);\nfloat depth = texture2D(depth_stencil, v_uv).x;\n#endif\ns.albedo = albedoMap;\nvec3 position = screen2WS(vec3(gl_FragCoord.xy, depth)).xyz;\ns.position = position;\ns.roughness = normalMap.z;\ns.normal = oct_to_float32x3(normalMap.xy);\ns.specularIntensity = 0.5;\ns.metallic = normalMap.w;\ns.emissive = emissiveMap.xyz;\ns.occlusion = emissiveMap.w;\nfloat fogFactor;\nCC_TRANSFER_FOG_BASE(vec4(position, 1), fogFactor);\nvec4 shadowPos;\nshadowPos = cc_matLightViewProj * vec4(position, 1);\nvec4 color = CCStandardShadingBase(s, shadowPos) +\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nCCClusterShadingAdditive(s, shadowPos);\n#else\nCCStandardShadingAdditive(s, shadowPos);\n#endif\nCC_APPLY_FOG_BASE(color, fogFactor);\ncolor = CCFragOutput(color);\n#if CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT\ngl_FragData[2] = color;\n#else\ngl_FragColor = color;\n#endif\n}"}],[{vert:"\nprecision highp float;\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#endif\n#if USE_INSTANCING\n#if CC_USE_BAKED_ANIMATION\nattribute highp vec4 a_jointAnimInfo;\n#endif\nattribute vec4 a_matWorld0;\nattribute vec4 a_matWorld1;\nattribute vec4 a_matWorld2;\n#if CC_USE_LIGHTMAP\nattribute vec4 a_lightingMapUVParam;\n#endif\n#if CC_RECEIVE_SHADOW\nattribute vec2 a_localShadowBias;\n#endif\n#elif USE_BATCHING\nattribute float a_dyn_batch_id;\n#endif\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\n#endif\n#if CC_USE_MORPH\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nnormal.xyz = normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\ntangent.xyz = tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\n#if CC_USE_BAKED_ANIMATION\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\nvoid CCGetJointTextureCoords(float pixelsPerJoint, float jointIdx, out highp float x, out highp float y, out highp float invSize)\n{\n#if USE_INSTANCING\nhighp float temp = pixelsPerJoint * (a_jointAnimInfo.x * a_jointAnimInfo.y + jointIdx) + a_jointAnimInfo.z;\n#else\nhighp float temp = pixelsPerJoint * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + jointIdx) + cc_jointTextureInfo.z;\n#endif\ninvSize = cc_jointTextureInfo.w;\nhighp float tempY = floor(temp * invSize);\nx = floor(temp - tempY * cc_jointTextureInfo.x);\ny = (tempY + 0.5) * invSize;\n}\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(3.0, i, x, y, invSize);\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(12.0, i, x, y, invSize);\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nmat4 m = skinMatrix();\nposition = m * position;\nnormal = (m * vec4(normal, 0.0)).xyz;\ntangent.xyz = (m * vec4(tangent.xyz, 0.0)).xyz;\n}\n#endif\nvoid CCVertInput(inout vec4 In)\n{\nIn = vec4(a_position, 1.0);\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\n}\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_mainLitDir;\n#if !USE_INSTANCING\n#if USE_BATCHING\nuniform highp mat4 cc_matWorlds[10];\n#else\nuniform highp mat4 cc_matWorld;\n#endif\n#endif\nvoid CCGetWorldMatrix(out mat4 matWorld)\n{\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\n#else\nmatWorld = cc_matWorld;\n#endif\n}\nuniform mediump vec4 cc_planarNDInfo;\nvarying float v_dist;\nvec4 vert () {\nvec4 position;\nCCVertInput(position);\nmat4 matWorld;\nCCGetWorldMatrix(matWorld);\nvec3 P = (matWorld * position).xyz;\nvec3 L = cc_mainLitDir.xyz;\nvec3 N = cc_planarNDInfo.xyz;\nfloat d = cc_planarNDInfo.w + 0.001;\nfloat dist = (-d - dot(P, N)) / (dot(L, N) + 0.0001);\nvec3 shadowPos = P + L * dist;\nvec3 view = normalize(cc_cameraPos.xyz - shadowPos);\nfloat viewLength = length(cc_cameraPos.xyz - shadowPos);\nshadowPos += view * min(1.0, 0.005 * viewLength);\nposition = cc_matProj * cc_matView * vec4(shadowPos, 1.0);\nv_dist = dist;\nreturn position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nuniform lowp vec4 cc_shadowColor;\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nvarying float v_dist;\nvec4 frag () {\nif(v_dist < 0.0)\ndiscard;\nreturn CCFragOutput(cc_shadowColor);\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#endif\n#if USE_INSTANCING\n#if CC_USE_BAKED_ANIMATION\nattribute highp vec4 a_jointAnimInfo;\n#endif\nattribute vec4 a_matWorld0;\nattribute vec4 a_matWorld1;\nattribute vec4 a_matWorld2;\n#if CC_USE_LIGHTMAP\nattribute vec4 a_lightingMapUVParam;\n#endif\n#if CC_RECEIVE_SHADOW\nattribute vec2 a_localShadowBias;\n#endif\n#elif USE_BATCHING\nattribute float a_dyn_batch_id;\n#endif\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\n#endif\n#if CC_USE_MORPH\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nnormal.xyz = normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\ntangent.xyz = tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\n#if CC_USE_BAKED_ANIMATION\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\nvoid CCGetJointTextureCoords(float pixelsPerJoint, float jointIdx, out highp float x, out highp float y, out highp float invSize)\n{\n#if USE_INSTANCING\nhighp float temp = pixelsPerJoint * (a_jointAnimInfo.x * a_jointAnimInfo.y + jointIdx) + a_jointAnimInfo.z;\n#else\nhighp float temp = pixelsPerJoint * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + jointIdx) + cc_jointTextureInfo.z;\n#endif\ninvSize = cc_jointTextureInfo.w;\nhighp float tempY = floor(temp * invSize);\nx = floor(temp - tempY * cc_jointTextureInfo.x);\ny = (tempY + 0.5) * invSize;\n}\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(3.0, i, x, y, invSize);\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(12.0, i, x, y, invSize);\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nmat4 m = skinMatrix();\nposition = m * position;\nnormal = (m * vec4(normal, 0.0)).xyz;\ntangent.xyz = (m * vec4(tangent.xyz, 0.0)).xyz;\n}\n#endif\nvoid CCVertInput(inout StandardVertInput In)\n{\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In.position, In.normal, In.tangent);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In.position, In.normal, In.tangent);\n#endif\n}\nuniform highp vec4 cc_cameraPos;\nvarying vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nCCVertInput(In);\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nuniform mediump vec4 cc_screenSize;\n#if ANTIALIAS_TYPE == 1\nvec4 fxaa(sampler2D tex, vec2 fragCoord, vec2 resolution,\nvec2 v_rgbNW, vec2 v_rgbNE,\nvec2 v_rgbSW, vec2 v_rgbSE,\nvec2 v_rgbM) {\nvec4 color;\nmediump vec2 inverseVP = vec2(1.0 / resolution.x, 1.0 / resolution.y);\nvec3 rgbNW = texture2D(tex, v_rgbNW).xyz;\nvec3 rgbNE = texture2D(tex, v_rgbNE).xyz;\nvec3 rgbSW = texture2D(tex, v_rgbSW).xyz;\nvec3 rgbSE = texture2D(tex, v_rgbSE).xyz;\nvec4 texColor = texture2D(tex, v_rgbM);\nvec3 rgbM  = texColor.xyz;\nvec3 luma = vec3(0.299, 0.587, 0.114);\nfloat lumaNW = dot(rgbNW, luma);\nfloat lumaNE = dot(rgbNE, luma);\nfloat lumaSW = dot(rgbSW, luma);\nfloat lumaSE = dot(rgbSE, luma);\nfloat lumaM  = dot(rgbM,  luma);\nfloat lumaMin = min(lumaM, min(min(lumaNW, lumaNE), min(lumaSW, lumaSE)));\nfloat lumaMax = max(lumaM, max(max(lumaNW, lumaNE), max(lumaSW, lumaSE)));\nmediump vec2 dir;\ndir.x = -((lumaNW + lumaNE) - (lumaSW + lumaSE));\ndir.y =  ((lumaNW + lumaSW) - (lumaNE + lumaSE));\nfloat dirReduce = max((lumaNW + lumaNE + lumaSW + lumaSE) *\n(0.25 * (1.0 / 8.0)), (1.0/ 128.0));\nfloat rcpDirMin = 1.0 / (min(abs(dir.x), abs(dir.y)) + dirReduce);\ndir = min(vec2(8.0, 8.0),\nmax(vec2(-8.0, -8.0),\ndir * rcpDirMin)) * inverseVP;\nvec3 rgbA = 0.5 * (\ntexture2D(tex, fragCoord * inverseVP + dir * (1.0 / 3.0 - 0.5)).xyz +\ntexture2D(tex, fragCoord * inverseVP + dir * (2.0 / 3.0 - 0.5)).xyz);\nvec3 rgbB = rgbA * 0.5 + 0.25 * (\ntexture2D(tex, fragCoord * inverseVP + dir * -0.5).xyz +\ntexture2D(tex, fragCoord * inverseVP + dir * 0.5).xyz);\nfloat lumaB = dot(rgbB, luma);\nif ((lumaB < lumaMin) || (lumaB > lumaMax))\ncolor = vec4(rgbA, texColor.a);\nelse\ncolor = vec4(rgbB, texColor.a);\nreturn color;\n}\n#endif\nvarying vec2 v_uv;\nuniform sampler2D outputResultMap;\nvoid texcoords(vec2 fragCoord, vec2 resolution,\nout vec2 v_rgbNW, out vec2 v_rgbNE,\nout vec2 v_rgbSW, out vec2 v_rgbSE,\nout vec2 v_rgbM) {\nvec2 inverseVP = 1.0 / resolution.xy;\nv_rgbNW = (fragCoord + vec2(-1.0, -1.0)) * inverseVP;\nv_rgbNE = (fragCoord + vec2(1.0, -1.0)) * inverseVP;\nv_rgbSW = (fragCoord + vec2(-1.0, 1.0)) * inverseVP;\nv_rgbSE = (fragCoord + vec2(1.0, 1.0)) * inverseVP;\nv_rgbM = vec2(fragCoord * inverseVP);\n}\nvoid main () {\nmediump vec2 v_rgbNW;\nmediump vec2 v_rgbNE;\nmediump vec2 v_rgbSW;\nmediump vec2 v_rgbSE;\nmediump vec2 v_rgbM;\n#if ANTIALIAS_TYPE == 1\nvec2 resolution = cc_screenSize.xy;\nvec2 fragCoord = v_uv * resolution;\ntexcoords(fragCoord, resolution, v_rgbNW, v_rgbNE, v_rgbSW, v_rgbSE, v_rgbM);\ngl_FragColor = fxaa(outputResultMap, fragCoord, resolution, v_rgbNW, v_rgbNE, v_rgbSW, v_rgbSE, v_rgbM);\n#else\ngl_FragColor = texture2D(outputResultMap, v_uv);\n#endif\n}"}],[{vert:"\nprecision highp float;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#endif\n#if USE_INSTANCING\n#if CC_USE_BAKED_ANIMATION\nattribute highp vec4 a_jointAnimInfo;\n#endif\nattribute vec4 a_matWorld0;\nattribute vec4 a_matWorld1;\nattribute vec4 a_matWorld2;\n#if CC_USE_LIGHTMAP\nattribute vec4 a_lightingMapUVParam;\n#endif\n#if CC_RECEIVE_SHADOW\nattribute vec2 a_localShadowBias;\n#endif\n#elif USE_BATCHING\nattribute float a_dyn_batch_id;\n#endif\n#if CC_USE_MORPH\nattribute float a_vertexId;\n#endif\nvarying mediump vec4 viewDir;\nvec4 vert () {\nviewDir = vec4(a_position, 1.0);\nmat4 matViewRotOnly = mat4(mat3(cc_matView));\nvec4 pos = matViewRotOnly * viewDir;\nif (cc_matProj[3].w > 0.0) {\nmat4 matProj = cc_matProj;\nmatProj[0].x = 5.2;\nmatProj[1].y = 2.6;\nmatProj[2].zw = vec2(-1.0);\nmatProj[3].zw = vec2(0.0);\npos = matProj * pos;\n} else {\npos = cc_matProj * pos;\n}\npos.z = 0.99999 * pos.w;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nuniform mediump vec4 cc_ambientSky;\nuniform samplerCube cc_environment;\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nvarying mediump vec4 viewDir;\nvec4 frag () {\n#if USE_RGBE_CUBEMAP\nvec3 c = unpackRGBE(textureCube(cc_environment, viewDir.xyz));\n#else\nvec3 c = SRGBToLinear(textureCube(cc_environment, viewDir.xyz).rgb);\n#endif\nreturn CCFragOutput(vec4(c * cc_ambientSky.w, 1.0));\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nuniform highp mat4 cc_matProj;\nattribute vec3 a_position;\nattribute vec4 a_color;\nvarying vec2 v_uv;\nuniform vec4 offset;\nuniform vec4 digits[20];\nfloat getComponent(vec4 v, float i) {\nif (i < 1.0) { return v.x; }\nelse if (i < 2.0) { return v.y; }\nelse if (i < 3.0) { return v.z; }\nelse { return v.w; }\n}\nvec4 vert () {\nmat2 proj = mat2(cc_matProj[0].xy, cc_matProj[1].xy);\nproj /= abs(proj[1].x + proj[1].y);\nvec2 position = proj * a_position.xy + offset.xy;\nv_uv = a_color.xy;\nif (a_color.z >= 0.0) {\nfloat n = getComponent(digits[int(a_color.z)], a_color.w);\nv_uv += vec2(offset.z * n, 0.0);\n}\nreturn vec4(position, 0.0, 1.0);\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nvarying vec2 v_uv;\nuniform sampler2D mainTexture;\nvec4 frag () {\nreturn CCFragOutput(texture2D(mainTexture, v_uv));\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nattribute vec2 a_position;\nattribute vec2 a_texCoord;\nvarying vec2 v_uv;\nuniform vec4 u_buffer0;\nuniform vec4 u_buffer1;\nuniform mat4 u_projection;\nvec4 vert () {\nvec2 worldPos = a_position * u_buffer1.xy + u_buffer1.zw;\nvec2 clipSpace = worldPos / u_buffer0.xy * 2.0 - 1.0;\nvec4 screenPos = u_projection * vec4(clipSpace, 0.0, 1.0);\nv_uv = a_texCoord;\nreturn screenPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nvarying vec2 v_uv;\nuniform float u_percent;\nuniform sampler2D mainTexture;\nvec4 frag () {\nvec4 color = texture2D(mainTexture, v_uv);\nfloat percent = clamp(u_percent, 0.0, 1.0);\ncolor.xyz *= percent;\nreturn color;\n}\nvoid main() { gl_FragColor = frag(); }"}]],glsl3:[[{vert:"\nprecision mediump float;\nlayout(std140) uniform Constants {\nvec4 mainTiling_Offset;\nvec4 frameTile_velLenScale;\nvec4 scale;\nvec4 nodeRotation;\n};\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\nhighp vec4 cc_localShadowBias;\n};\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\nfloat x = angle.x / 2.;\nfloat y = angle.y / 2.;\nfloat z = angle.z / 2.;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat = vec4(0);\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nout mediump vec2 uv;\nout mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n, mat4 viewInv\n) {\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n}\nin vec3 a_position;\nin vec2 a_texCoord;\nin vec4 a_color;\nlayout(std140) uniform builtin {\nvec4 cc_size_rotation;\n};\nvec4 vs_main() {\nvec4 pos = vec4(a_position, 1);\npos = cc_matWorld * pos;\nvec2 vertOffset = a_texCoord.xy - 0.5;\ncomputeVertPos(pos, vertOffset, quaternionFromEuler(vec3(0., 0., cc_size_rotation.z)), vec3(cc_size_rotation.xy, 0.), cc_matViewInv);\npos = cc_matViewProj * pos;\nuv = a_texCoord.xy;\ncolor = a_color;\nreturn pos;\n}\nvoid main() { gl_Position = vs_main(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nin vec2 uv;\nin vec4 color;\nuniform sampler2D mainTexture;\nlayout(std140) uniform FragConstants {\nvec4 tintColor;\n};\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nin vec3 a_position;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 frag () {\nvec4 o = vec4(1.0);\nreturn o;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nin highp vec3 a_position;\nin vec4 a_color;\nout vec4 v_color;\nvec4 vert () {\nvec4 pos = cc_matViewProj * vec4(a_position, 1);\npos.z -= 0.000001;\nv_color = a_color;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nin vec4 v_color;\nvec4 front() {\n#if USE_FORWARD_PIPELINE\nreturn CCFragOutput(v_color);\n#else\nreturn v_color;\n#endif\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = front(); }"},{vert:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nin highp vec3 a_position;\nin vec4 a_color;\nout vec4 v_color;\nvec4 vert () {\nvec4 pos = cc_matViewProj * vec4(a_position, 1);\npos.z -= 0.000001;\nv_color = a_color;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nin vec4 v_color;\nvec4 back() {\n#if USE_FORWARD_PIPELINE\nreturn CCFragOutput(vec4(v_color.rgb, v_color.a * 0.2));\n#else\nreturn vec4(v_color.rgb, v_color.a * 0.2);\n#endif\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = back(); }"},{vert:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nin highp vec3 a_position;\nin vec4 a_color;\nout vec4 v_color;\nout float v_distance;\nvec4 vert () {\nvec4 pos = cc_matViewProj * vec4(a_position, 1);\npos.z -= 0.000001;\nv_color = a_color;\nv_distance = dot(a_position, vec3(1.0, 1.0, 1.0));\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nin vec4 v_color;\nin float v_distance;\nvec4 front() {\nif (fract(v_distance) > 0.5) {\ndiscard;\n}\n#if USE_FORWARD_PIPELINE\nreturn CCFragOutput(v_color);\n#else\nreturn v_color;\n#endif\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = front(); }"},{vert:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nin highp vec3 a_position;\nin vec4 a_color;\nout vec4 v_color;\nout float v_distance;\nvec4 vert () {\nvec4 pos = cc_matViewProj * vec4(a_position, 1);\npos.z -= 0.000001;\nv_color = a_color;\nv_distance = dot(a_position, vec3(1.0, 1.0, 1.0));\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nin vec4 v_color;\nin float v_distance;\nvec4 back() {\nif (fract(v_distance) > 0.5) {\ndiscard;\n}\n#if USE_FORWARD_PIPELINE\nreturn CCFragOutput(vec4(v_color.rgb, v_color.a * 0.2));\n#else\nreturn vec4(v_color.rgb, v_color.a * 0.2);\n#endif\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = back(); }"},{vert:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nin highp vec3 a_position;\nin vec4 a_normal;\nin vec4 a_color;\nout vec4 v_color;\nvec4 vert () {\nvec4 pos = cc_matViewProj * vec4(a_position, 1);\nv_color = a_color;\nfloat intensity = dot(vec3(1, 2, 4), a_normal.xyz);\nv_color.rgb -= a_normal.w * intensity * 0.1;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nin vec4 v_color;\nvec4 front() {\n#if USE_FORWARD_PIPELINE\nreturn CCFragOutput(v_color);\n#else\nreturn v_color;\n#endif\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = front(); }"},{vert:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nin highp vec3 a_position;\nin vec4 a_normal;\nin vec4 a_color;\nout vec4 v_color;\nvec4 vert () {\nvec4 pos = cc_matViewProj * vec4(a_position, 1);\nv_color = a_color;\nfloat intensity = dot(vec3(1, 2, 4), a_normal.xyz);\nv_color.rgb -= a_normal.w * intensity * 0.1;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nin vec4 v_color;\nvec4 back() {\n#if USE_FORWARD_PIPELINE\nreturn CCFragOutput(vec4(v_color.rgb, v_color.a * 0.2));\n#else\nreturn vec4(v_color.rgb, v_color.a * 0.2);\n#endif\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = back(); }"}],[{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\nhighp vec4 cc_localShadowBias;\n};\nin vec3 a_position;\nin vec4 a_color;\nout vec4 v_color;\nin float a_dist;\nout float v_dist;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\npos = cc_matViewProj * cc_matWorld * pos;\nv_color = a_color;\nv_dist = a_dist;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nin vec4 v_color;\nin float v_dist;\nvec4 frag () {\nvec4 o = v_color;\nfloat aa = fwidth(v_dist);\nfloat alpha = 1. - smoothstep(-aa, 0., abs(v_dist) - 1.0);\no.rgb *= o.a;\no *= alpha;\nreturn o;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCWorldBound {\nhighp vec4 cc_worldBoundCenter;\nhighp vec4 cc_worldBoundHalfExtents;\n};\nin vec3 a_position;\nvec4 vert () {\nvec4 position;\nposition = vec4(a_position, 1.0);\nposition *= cc_worldBoundHalfExtents;\nposition += cc_worldBoundCenter;\nposition = cc_matViewProj * position;\nreturn position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nvec4 frag () {\nreturn vec4(1, 0, 0, 1);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\nfloat x = angle.x / 2.;\nfloat y = angle.y / 2.;\nfloat z = angle.z / 2.;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat = vec4(0);\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nmat4 matrixFromRT (vec4 q, vec3 p){\nfloat x2 = q.x + q.x;\nfloat y2 = q.y + q.y;\nfloat z2 = q.z + q.z;\nfloat xx = q.x * x2;\nfloat xy = q.x * y2;\nfloat xz = q.x * z2;\nfloat yy = q.y * y2;\nfloat yz = q.y * z2;\nfloat zz = q.z * z2;\nfloat wx = q.w * x2;\nfloat wy = q.w * y2;\nfloat wz = q.w * z2;\nreturn mat4(\n1. - (yy + zz), xy + wz, xz - wy, 0,\nxy - wz, 1. - (xx + zz), yz + wx, 0,\nxz + wy, yz - wx, 1. - (xx + yy), 0,\np.x, p.y, p.z, 1\n);\n}\nmat4 matFromRTS (vec4 q, vec3 t, vec3 s){\nfloat x = q.x, y = q.y, z = q.z, w = q.w;\nfloat x2 = x + x;\nfloat y2 = y + y;\nfloat z2 = z + z;\nfloat xx = x * x2;\nfloat xy = x * y2;\nfloat xz = x * z2;\nfloat yy = y * y2;\nfloat yz = y * z2;\nfloat zz = z * z2;\nfloat wx = w * x2;\nfloat wy = w * y2;\nfloat wz = w * z2;\nfloat sx = s.x;\nfloat sy = s.y;\nfloat sz = s.z;\nreturn mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n(xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n(xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\nt.x, t.y, t.z, 1);\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nmat3 quatToMat3(vec4 q) {\nvec3 m0 = vec3(\n1.0 - 2.0 * q.y * q.y - 2.0 * q.z * q.z,\n2.0 * q.x * q.y + 2.0 * q.w * q.z,\n2.0 * q.x * q.z - 2.0 * q.w * q.y);\nvec3 m1 = vec3(\n2.0 * q.x * q.y - 2.0 * q.w * q.z,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.z * q.z,\n2.0 * q.y * q.z + 2.0 * q.w * q.x);\nvec3 m2 = vec3(\n2.0 * q.x * q.z + 2.0 * q.w * q.y,\n2.0 * q.y * q.z - 2.0 * q.w * q.x,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.y * q.y);\nreturn mat3(m0, m1, m2);\n}\nvec4 mat3ToQuat(mat3 mat) {\nfloat tr = mat[0][0] + mat[1][1] + mat[2][2];\nfloat qw, qx, qy, qz;\nif (tr > 0.0) {\nfloat S = sqrt(tr + 1.0) * 2.0;\nfloat invS = 1.0 / S;\nqw = 0.25 * S;\nqx = (mat[1][2] - mat[2][1]) * invS;\nqy = (mat[2][0] - mat[0][2]) * invS;\nqz = (mat[0][1] - mat[1][0]) * invS;\n} else if ((mat[0][0] > mat[1][1])&&(mat[0][0] > mat[2][2])) {\nfloat S = sqrt(1.0 + mat[0][0] - mat[1][1] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[1][2] - mat[2][1]) * invS;\nqx = 0.25 * S;\nqy = (mat[1][0] + mat[0][1]) * invS;\nqz = (mat[2][0] + mat[0][2]) * invS;\n} else if (mat[1][1] > mat[2][2]) {\nfloat S = sqrt(1.0 + mat[1][1] - mat[0][0] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[2][0] - mat[0][2]) * invS;\nqx = (mat[1][0] + mat[0][1]) * invS;\nqy = 0.25 * S;\nqz = (mat[2][1] + mat[1][2]) * invS;\n} else {\nfloat S = sqrt(1.0 + mat[2][2] - mat[0][0] - mat[1][1]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[0][1] - mat[1][0]) * invS;\nqx = (mat[2][0] + mat[0][2]) * invS;\nqy = (mat[2][1] + mat[1][2]) * invS;\nqz = 0.25 * S;\n}\nreturn vec4(qx, qy, qz, qw);\n}\nvec4 eulerToQuat(vec3 euler) {\nvec3 er = euler * 0.5;\nfloat x = er.x, y = er.y, z = er.z;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat;\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nlayout(std140) uniform Constants {\nvec4 mainTiling_Offset;\nvec4 frameTile_velLenScale;\nvec4 scale;\nvec4 nodeRotation;\n};\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\nhighp vec4 cc_localShadowBias;\n};\nout mediump vec2 uv;\nout mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, mat4 viewInv\n#endif\n#if CC_RENDER_MODE == 1\n, vec3 eye\n, vec4 velocity\n, float velocityScale\n, float lengthScale\n, float xIndex\n#endif\n) {\n#if CC_RENDER_MODE == 0\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_RENDER_MODE == 1\nvec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\nvec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\npos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_RENDER_MODE == 2\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = vec3(1, 0, 0);\nvec3 camY = vec3(0, 0, -1);\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_RENDER_MODE == 3\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nrotateVecFromQuat(viewSpaceVert, q);\nvec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\nvec3 camY = vec3(0, 1, 0);\nvec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\npos.xyz += offset;\n#else\npos.x += vertOffset.x;\npos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV (float frameIndex, vec2 vertIndex, vec2 frameTile){\nvec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\naniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if CC_RENDER_MODE != 4\nvertIndex.y = 1. - vertIndex.y;\n#endif\nreturn (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nlayout(std140) uniform SampleConstants {\nvec4 u_sampleInfo;\n};\nlayout(std140) uniform TickConstants {\nvec4 u_worldRot;\nvec4 u_timeDelta;\n};\nin vec4 a_position_starttime;\nin vec4 a_size_uv;\nin vec4 a_rotation_uv;\nin vec4 a_color;\nin vec4 a_dir_life;\nin float a_rndSeed;\n#if CC_RENDER_MODE == 4\nin vec3 a_texCoord;\nin vec3 a_texCoord3;\nin vec3 a_normal;\nin vec4 a_color1;\n#endif\nvec3 unpackCurveData (sampler2D tex, vec2 coord) {\nvec4 a = texture(tex, coord);\nvec4 b = texture(tex, coord + u_sampleInfo.y);\nfloat c = fract(coord.x * u_sampleInfo.x);\nreturn mix(a.xyz, b.xyz, c);\n}\nvec3 unpackCurveData (sampler2D tex, vec2 coord, out float w) {\nvec4 a = texture(tex, coord);\nvec4 b = texture(tex, coord + u_sampleInfo.y);\nfloat c = fract(coord.x * u_sampleInfo.x);\nw = mix(a.w, b.w, c);\nreturn mix(a.xyz, b.xyz, c);\n}\nfloat pseudoRandom(float x) {\n#if USE_VK_SHADER\nfloat o = x;\nx = mod(x - 1.0, 2.0) - 1.0;\nfloat freqVar = 10.16640753482;\nfloat y = sin(freqVar * floor(o * 0.5 - 0.5));\nfloat v = max(0.0, 1.0-abs(x));\nv *= 0.7071067812;\nv = y < 0.0 ? -v : v;\nreturn v;\n#else\nfloat seed = mod(x, 233280.);\nfloat q = (seed * 9301. + 49297.) / 233280.;\nreturn fract(q);\n#endif\n}\n#if COLOR_OVER_TIME_MODULE_ENABLE\nuniform sampler2D color_over_time_tex0;\nlayout(std140) uniform ColorConstant {\nint u_color_mode;\n};\n#endif\n#if ROTATION_OVER_TIME_MODULE_ENABLE\nuniform sampler2D rotation_over_time_tex0;\nlayout(std140) uniform RotationConstant {\nint u_rotation_mode;\n};\n#endif\n#if SIZE_OVER_TIME_MODULE_ENABLE\nuniform sampler2D size_over_time_tex0;\nlayout(std140) uniform SizeConstant {\nint u_size_mode;\n};\n#endif\n#if FORCE_OVER_TIME_MODULE_ENABLE\nuniform sampler2D force_over_time_tex0;\nlayout(std140) uniform ForceConstant {\nint u_force_mode;\nint u_force_space;\n};\n#endif\n#if VELOCITY_OVER_TIME_MODULE_ENABLE\nuniform sampler2D velocity_over_time_tex0;\nlayout(std140) uniform VelocityConstant {\nint u_velocity_mode;\nint u_velocity_space;\n};\n#endif\n#if TEXTURE_ANIMATION_MODULE_ENABLE\nuniform sampler2D texture_animation_tex0;\nlayout(std140) uniform AnimationConstant {\nvec4 u_anim_info;\n};\n#endif\nfloat repeat (float t, float length) {\nreturn t - floor(t / length) * length;\n}\nvec4 rotateQuat (vec4 p, vec4 q) {\nvec3 iv = cross(q.xyz, p.xyz) + q.w * p.xyz;\nvec3 res = p.xyz + 2.0 * cross(q.xyz, iv);\nreturn vec4(res.xyz, p.w);\n}\nvec4 gpvs_main () {\nfloat activeTime = u_timeDelta.x - a_position_starttime.w;\nfloat normalizedTime = clamp(activeTime / a_dir_life.w, 0.0, 1.0);\nvec2 timeCoord0 = vec2(normalizedTime, 0.);\nvec2 timeCoord1 = vec2(normalizedTime, 1.);\n#if CC_RENDER_MODE == 4\nvec2 vertIdx = vec2(a_texCoord.x, a_texCoord.y);\n#else\nvec2 vertIdx = vec2(a_size_uv.w, a_rotation_uv.w);\n#endif\nvec4 velocity = vec4(a_dir_life.xyz, 0.);\nvec4 pos = vec4(a_position_starttime.xyz, 1.);\nvec3 size = a_size_uv.xyz;\n#if SIZE_OVER_TIME_MODULE_ENABLE\nif (u_size_mode == 1) {\nsize *= unpackCurveData(size_over_time_tex0, timeCoord0);\n} else {\nvec3 size_0 = unpackCurveData(size_over_time_tex0, timeCoord0);\nvec3 size_1 = unpackCurveData(size_over_time_tex0, timeCoord1);\nfloat factor_s = pseudoRandom(a_rndSeed + 39825.);\nsize *= mix(size_0, size_1, factor_s);\n}\n#endif\nvec3 compScale = scale.xyz * size;\n#if FORCE_OVER_TIME_MODULE_ENABLE\nvec3 forceAnim = vec3(0.);\nif (u_force_mode == 1) {\nforceAnim = unpackCurveData(force_over_time_tex0, timeCoord0);\n} else {\nvec3 force_0 = unpackCurveData(force_over_time_tex0, timeCoord0);\nvec3 force_1 = unpackCurveData(force_over_time_tex0, timeCoord1);\nfloat factor_f =  pseudoRandom(a_rndSeed + 212165.);\nforceAnim = mix(force_0, force_1, factor_f);\n}\nvec4 forceTrack = vec4(forceAnim, 0.);\nif (u_force_space == 0) {\nforceTrack = rotateQuat(forceTrack, u_worldRot);\n}\nvelocity.xyz += forceTrack.xyz;\n#endif\n#if VELOCITY_OVER_TIME_MODULE_ENABLE\nfloat speedModifier0 = 1.;\nfloat speedModifier1 = 1.;\nvec3 velocityAnim = vec3(0.);\nif (u_velocity_mode == 1) {\nvelocityAnim = unpackCurveData(velocity_over_time_tex0, timeCoord0, speedModifier0);\n} else {\nvec3 vectory_0 = unpackCurveData(velocity_over_time_tex0, timeCoord0, speedModifier0);\nvec3 vectory_1 = unpackCurveData(velocity_over_time_tex0, timeCoord1, speedModifier1);\nfloat factor_v = pseudoRandom(a_rndSeed + 197866.);\nvelocityAnim = mix(vectory_0, vectory_1, factor_v);\nspeedModifier0 = mix(speedModifier0, speedModifier1, factor_v);\n}\nvec4 velocityTrack = vec4(velocityAnim, 0.);\nif (u_velocity_space == 0) {\nvelocityTrack = rotateQuat(velocityTrack, u_worldRot);\n}\nvelocity.xyz += velocityTrack.xyz;\nvelocity.xyz *= speedModifier0;\n#endif\npos.xyz += velocity.xyz * normalizedTime * a_dir_life.w;\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\n#if CC_RENDER_MODE == 1\nvelocity = rotateQuat(velocity, u_worldRot);\n#endif\n#endif\nvec3 startRotation = a_rotation_uv.xyz;\n#if CC_RENDER_MODE != 4\n#if CC_RENDER_MODE == 0\nvec3 rotEuler = startRotation.xyz;\n#elif CC_RENDER_MODE == 1\nvec3 rotEuler = vec3(0.);\n#else\nvec3 rotEuler = vec3(0., 0., startRotation.z);\n#endif\nvec4 rot = quaternionFromEuler(rotEuler);\n#else\nvec4 rot = quaternionFromEuler(startRotation);\n#endif\n#if ROTATION_OVER_TIME_MODULE_ENABLE\nif (u_rotation_mode == 1) {\nvec3 euler = unpackCurveData(rotation_over_time_tex0, timeCoord0) * normalizedTime * a_dir_life.w;\nvec4 quat = eulerToQuat(euler);\nmat3 mLocal = quatToMat3(quat);\nmat3 mStart = quatToMat3(rot);\nrot = mat3ToQuat(mStart * mLocal);\n} else {\nvec3 rotation_0 = unpackCurveData(rotation_over_time_tex0, timeCoord0);\nvec3 rotation_1 = unpackCurveData(rotation_over_time_tex0, timeCoord1);\nfloat factor_r = pseudoRandom(a_rndSeed + 125292.);\nvec3 euler = mix(rotation_0, rotation_1, factor_r) * normalizedTime * a_dir_life.w;\n#if CC_RENDER_MODE == 3 || CC_RENDER_MODE == 2\neuler = vec3(0.0, 0.0, euler.z);\n#endif\nvec4 quat = eulerToQuat(euler);\nmat3 mLocal = quatToMat3(quat);\nmat3 mStart = quatToMat3(rot);\nrot = mat3ToQuat(mStart * mLocal);\n}\n#endif\n#if COLOR_OVER_TIME_MODULE_ENABLE\nif (u_color_mode == 1) {\ncolor = a_color * texture(color_over_time_tex0, timeCoord0);\n} else {\nvec4 color_0 = texture(color_over_time_tex0, timeCoord0);\nvec4 color_1 = texture(color_over_time_tex0, timeCoord1);\nfloat factor_c = pseudoRandom(a_rndSeed + 91041.);\ncolor = a_color * mix(color_0, color_1, factor_c);\n}\n#else\ncolor = a_color;\n#endif\n#if CC_RENDER_MODE != 4\nvec2 cornerOffset = vec2((vertIdx - 0.5));\n#if CC_RENDER_MODE == 1\nrot = vec4(0.0, 0.0, 0.0, 1.0);\n#endif\ncomputeVertPos(pos, cornerOffset, rot, compScale\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, cc_matViewInv\n#endif\n#if CC_RENDER_MODE == 1\n, cc_cameraPos.xyz\n, velocity\n, frameTile_velLenScale.z\n, frameTile_velLenScale.w\n, a_size_uv.w\n#endif\n);\n#else\nmat3 rotMat = quatToMat3(rot);\nmat3 nodeMat = quatToMat3(nodeRotation);\nrotMat = nodeMat * rotMat;\nrot = mat3ToQuat(rotMat);\nmat4 xformNoScale = matrixFromRT(rot, pos.xyz);\nmat4 xform = matFromRTS(rot, pos.xyz, compScale);\npos = xform * vec4(a_texCoord3, 1);\nvec4 normal = xformNoScale * vec4(a_normal, 0);\ncolor *= a_color1;\n#endif\npos = cc_matViewProj * pos;\nfloat frameIndex = 0.;\n#if TEXTURE_ANIMATION_MODULE_ENABLE\nfloat startFrame = 0.;\nvec3 frameInfo = vec3(0.);\nif (int(u_anim_info.x) == 1) {\nframeInfo = unpackCurveData(texture_animation_tex0, timeCoord0);\n} else {\nvec3 frameInfo0 = unpackCurveData(texture_animation_tex0, timeCoord0);\nvec3 frameInfo1 = unpackCurveData(texture_animation_tex0, timeCoord1);\nfloat factor_t = pseudoRandom(a_rndSeed + 90794.);\nframeInfo = mix(frameInfo0, frameInfo1, factor_t);\n}\nstartFrame = frameInfo.x / u_anim_info.y;\nframeIndex = repeat(u_anim_info.z * (frameInfo.y + startFrame), 1.);\n#endif\nuv = computeUV(frameIndex, vertIdx, frameTile_velLenScale.xy) * mainTiling_Offset.xy + mainTiling_Offset.zw;\nreturn pos;\n}\nvoid main() { gl_Position = gpvs_main(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nin vec2 uv;\nin vec4 color;\nuniform sampler2D mainTexture;\nlayout(std140) uniform FragConstants {\nvec4 tintColor;\n};\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"}],[{vert:"\nprecision mediump float;\nlayout(std140) uniform Constants {\nvec4 mainTiling_Offset;\nvec4 frameTile_velLenScale;\nvec4 scale;\nvec4 nodeRotation;\n};\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\nhighp vec4 cc_localShadowBias;\n};\nout mediump vec2 uv;\nout mediump vec4 color;\nin vec3 a_position;\nin vec4 a_texCoord;\nin vec3 a_texCoord1;\nin vec3 a_texCoord2;\nin vec4 a_color;\n#if CC_DRAW_WIRE_FRAME\nout vec3 vBarycentric;\n#endif\nvec4 vs_main() {\nhighp vec4 pos = vec4(a_position, 1);\nvec4 velocity = vec4(a_texCoord1.xyz, 0);\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\nvelocity = cc_matWorld * velocity;\n#endif\nfloat vertOffset = (a_texCoord.x - 0.5) * a_texCoord.y;\nvec3 camUp = normalize(cross(pos.xyz - cc_cameraPos.xyz, velocity.xyz));\npos.xyz += camUp * vertOffset;\npos = cc_matViewProj * pos;\nuv = a_texCoord.zw * mainTiling_Offset.xy + mainTiling_Offset.zw;;\ncolor = a_color;\n#if CC_DRAW_WIRE_FRAME\nvBarycentric = a_texCoord2;\n#endif\nreturn pos;\n}\nvoid main() { gl_Position = vs_main(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nin vec2 uv;\nin vec4 color;\n#if CC_DRAW_WIRE_FRAME\nin vec3 vBarycentric;\n#endif\nuniform sampler2D mainTexture;\nlayout(std140) uniform FragConstants {\nvec4 tintColor;\n};\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\n#if CC_DRAW_WIRE_FRAME\nif (any(lessThan(vBarycentric, vec3(0.02)))) {\ncol = vec4(0., 1., 1., 1.);\n}\n#endif\nreturn CCFragOutput(col);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\nfloat x = angle.x / 2.;\nfloat y = angle.y / 2.;\nfloat z = angle.z / 2.;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat = vec4(0);\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nmat4 matrixFromRT (vec4 q, vec3 p){\nfloat x2 = q.x + q.x;\nfloat y2 = q.y + q.y;\nfloat z2 = q.z + q.z;\nfloat xx = q.x * x2;\nfloat xy = q.x * y2;\nfloat xz = q.x * z2;\nfloat yy = q.y * y2;\nfloat yz = q.y * z2;\nfloat zz = q.z * z2;\nfloat wx = q.w * x2;\nfloat wy = q.w * y2;\nfloat wz = q.w * z2;\nreturn mat4(\n1. - (yy + zz), xy + wz, xz - wy, 0,\nxy - wz, 1. - (xx + zz), yz + wx, 0,\nxz + wy, yz - wx, 1. - (xx + yy), 0,\np.x, p.y, p.z, 1\n);\n}\nmat4 matFromRTS (vec4 q, vec3 t, vec3 s){\nfloat x = q.x, y = q.y, z = q.z, w = q.w;\nfloat x2 = x + x;\nfloat y2 = y + y;\nfloat z2 = z + z;\nfloat xx = x * x2;\nfloat xy = x * y2;\nfloat xz = x * z2;\nfloat yy = y * y2;\nfloat yz = y * z2;\nfloat zz = z * z2;\nfloat wx = w * x2;\nfloat wy = w * y2;\nfloat wz = w * z2;\nfloat sx = s.x;\nfloat sy = s.y;\nfloat sz = s.z;\nreturn mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n(xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n(xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\nt.x, t.y, t.z, 1);\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nmat3 quatToMat3(vec4 q) {\nvec3 m0 = vec3(\n1.0 - 2.0 * q.y * q.y - 2.0 * q.z * q.z,\n2.0 * q.x * q.y + 2.0 * q.w * q.z,\n2.0 * q.x * q.z - 2.0 * q.w * q.y);\nvec3 m1 = vec3(\n2.0 * q.x * q.y - 2.0 * q.w * q.z,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.z * q.z,\n2.0 * q.y * q.z + 2.0 * q.w * q.x);\nvec3 m2 = vec3(\n2.0 * q.x * q.z + 2.0 * q.w * q.y,\n2.0 * q.y * q.z - 2.0 * q.w * q.x,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.y * q.y);\nreturn mat3(m0, m1, m2);\n}\nvec4 mat3ToQuat(mat3 mat) {\nfloat tr = mat[0][0] + mat[1][1] + mat[2][2];\nfloat qw, qx, qy, qz;\nif (tr > 0.0) {\nfloat S = sqrt(tr + 1.0) * 2.0;\nfloat invS = 1.0 / S;\nqw = 0.25 * S;\nqx = (mat[1][2] - mat[2][1]) * invS;\nqy = (mat[2][0] - mat[0][2]) * invS;\nqz = (mat[0][1] - mat[1][0]) * invS;\n} else if ((mat[0][0] > mat[1][1])&&(mat[0][0] > mat[2][2])) {\nfloat S = sqrt(1.0 + mat[0][0] - mat[1][1] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[1][2] - mat[2][1]) * invS;\nqx = 0.25 * S;\nqy = (mat[1][0] + mat[0][1]) * invS;\nqz = (mat[2][0] + mat[0][2]) * invS;\n} else if (mat[1][1] > mat[2][2]) {\nfloat S = sqrt(1.0 + mat[1][1] - mat[0][0] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[2][0] - mat[0][2]) * invS;\nqx = (mat[1][0] + mat[0][1]) * invS;\nqy = 0.25 * S;\nqz = (mat[2][1] + mat[1][2]) * invS;\n} else {\nfloat S = sqrt(1.0 + mat[2][2] - mat[0][0] - mat[1][1]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[0][1] - mat[1][0]) * invS;\nqx = (mat[2][0] + mat[0][2]) * invS;\nqy = (mat[2][1] + mat[1][2]) * invS;\nqz = 0.25 * S;\n}\nreturn vec4(qx, qy, qz, qw);\n}\nlayout(std140) uniform Constants {\nvec4 mainTiling_Offset;\nvec4 frameTile_velLenScale;\nvec4 scale;\nvec4 nodeRotation;\n};\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\nhighp vec4 cc_localShadowBias;\n};\nout mediump vec2 uv;\nout mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, mat4 viewInv\n#endif\n#if CC_RENDER_MODE == 1\n, vec3 eye\n, vec4 velocity\n, float velocityScale\n, float lengthScale\n, float xIndex\n#endif\n) {\n#if CC_RENDER_MODE == 0\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_RENDER_MODE == 1\nvec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\nvec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\npos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_RENDER_MODE == 2\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = vec3(1, 0, 0);\nvec3 camY = vec3(0, 0, -1);\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_RENDER_MODE == 3\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nrotateVecFromQuat(viewSpaceVert, q);\nvec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\nvec3 camY = vec3(0, 1, 0);\nvec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\npos.xyz += offset;\n#else\npos.x += vertOffset.x;\npos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV (float frameIndex, vec2 vertIndex, vec2 frameTile){\nvec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\naniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if CC_RENDER_MODE != 4\nvertIndex.y = 1. - vertIndex.y;\n#endif\nreturn (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nin vec3 a_position;\nin vec3 a_texCoord;\nin vec3 a_texCoord1;\nin vec3 a_texCoord2;\nin vec4 a_color;\n#if CC_RENDER_MODE == 1\nin vec3 a_color1;\n#endif\n#if CC_RENDER_MODE == 4\nin vec3 a_texCoord3;\nin vec3 a_normal;\nin vec4 a_color1;\n#endif\nvec4 lpvs_main () {\nvec3 compScale = scale.xyz * a_texCoord1;\nvec4 pos = vec4(a_position, 1);\n#if CC_RENDER_MODE == 1\nvec4 velocity = vec4(a_color1.xyz, 0);\n#endif\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\n#if CC_RENDER_MODE == 1\nvelocity = cc_matWorld * velocity;\n#endif\n#endif\n#if ROTATION_OVER_TIME_MODULE_ENABLE\nvec3 rotTmp = a_texCoord2;\nfloat mulFactor = 1.0;\nif (rotTmp.x > 10.0 * 0.5) {\nrotTmp.x -= 10.0;\nmulFactor = -1.0;\n}\nvec4 rot = vec4(rotTmp, 0.0);\nrot.w = mulFactor * sqrt(abs(1.0 - rot.x * rot.x - rot.y * rot.y - rot.z * rot.z));\n#else\n#if CC_RENDER_MODE != 4\n#if CC_RENDER_MODE == 0\nvec3 rotEuler = a_texCoord2;\n#elif CC_RENDER_MODE == 1\nvec3 rotEuler = vec3(0.);\n#else\nvec3 rotEuler = vec3(0., 0., a_texCoord2.z);\n#endif\nvec4 rot = quaternionFromEuler(rotEuler);\n#else\nvec4 rot = quaternionFromEuler(a_texCoord2);\n#endif\n#endif\n#if CC_RENDER_MODE != 4\nvec2 cornerOffset = vec2((a_texCoord.xy - 0.5));\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\ncomputeVertPos(pos, cornerOffset, rot, compScale, cc_matViewInv);\n#elif CC_RENDER_MODE == 1\ncomputeVertPos(pos, cornerOffset, rot, compScale, cc_cameraPos.xyz, velocity, frameTile_velLenScale.z, frameTile_velLenScale.w, a_texCoord.x);\n#elif 2\ncomputeVertPos(pos, cornerOffset, rot, compScale);\n#endif\ncolor = a_color;\n#else\nmat3 rotMat = quatToMat3(rot);\nmat3 nodeMat = quatToMat3(nodeRotation);\nrotMat = nodeMat * rotMat;\nrot = mat3ToQuat(rotMat);\nmat4 xformNoScale = matrixFromRT(rot, pos.xyz);\nmat4 xform = matFromRTS(rot, pos.xyz, compScale);\npos = xform * vec4(a_texCoord3, 1);\nvec4 normal = xformNoScale * vec4(a_normal, 0);\ncolor = a_color * a_color1;\n#endif\nuv = computeUV(a_texCoord.z, a_texCoord.xy, frameTile_velLenScale.xy) * mainTiling_Offset.xy + mainTiling_Offset.zw;\npos = cc_matViewProj * pos;\nreturn pos;\n}\nvoid main() { gl_Position = lpvs_main(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nin vec2 uv;\nin vec4 color;\nuniform sampler2D mainTexture;\nlayout(std140) uniform FragConstants {\nvec4 tintColor;\n};\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\n#if USE_LOCAL\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\nhighp vec4 cc_localShadowBias;\n};\n#endif\nin vec3 a_position;\nin vec2 a_texCoord;\nin vec4 a_color;\nout vec4 v_light;\nout vec2 uv0;\n#if TWO_COLORED\nin vec4 a_color2;\nout vec4 v_dark;\n#endif\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\n#if USE_LOCAL\npos = cc_matWorld * pos;\n#endif\npos = cc_matViewProj * pos;\nuv0 = a_texCoord;\nv_light = a_color;\n#if TWO_COLORED\nv_dark = a_color2;\n#endif\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\n#if USE_ALPHA_TEST\nlayout(std140) uniform ALPHA_TEST_DATA {\nfloat alphaThreshold;\n};\n#endif\nvoid ALPHA_TEST (in vec4 color) {\n#if USE_ALPHA_TEST\nif (color.a < alphaThreshold) discard;\n#endif\n}\nvoid ALPHA_TEST (in float alpha) {\n#if USE_ALPHA_TEST\nif (alpha < alphaThreshold) discard;\n#endif\n}\nin vec4 v_light;\n#if TWO_COLORED\nin vec4 v_dark;\n#endif\nin vec2 uv0;\nuniform sampler2D cc_spriteTexture;\nvec4 frag () {\nvec4 o = vec4(1, 1, 1, 1);\n#if TWO_COLORED\nvec4 texColor = vec4(1, 1, 1, 1);\ntexColor *= texture(cc_spriteTexture, uv0);\no.a = texColor.a * v_light.a;\no.rgb = ((texColor.a - 1.0) * v_dark.a + 1.0 - texColor.rgb) * v_dark.rgb + texColor.rgb * v_light.rgb;\n#else\no *= texture(cc_spriteTexture, uv0);\no *= v_light;\n#endif\nALPHA_TEST(o);\nreturn o;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\n#if USE_LOCAL\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\nhighp vec4 cc_localShadowBias;\n};\n#endif\n#if SAMPLE_FROM_RT\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\n#endif\nin vec3 a_position;\nin vec2 a_texCoord;\nin vec4 a_color;\nout vec4 color;\nout vec2 uv0;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\n#if USE_LOCAL\npos = cc_matWorld * pos;\n#endif\n#if USE_PIXEL_ALIGNMENT\npos = cc_matView * pos;\npos.xyz = floor(pos.xyz);\npos = cc_matProj * pos;\n#else\npos = cc_matViewProj * pos;\n#endif\nuv0 = a_texCoord;\n#if SAMPLE_FROM_RT\nuv0 = cc_cameraPos.w > 1.0 ? vec2(uv0.x, 1.0 - uv0.y) : uv0;\n#endif\ncolor = a_color;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 CCSampleWithAlphaSeparated(sampler2D tex, vec2 uv) {\n#if CC_USE_EMBEDDED_ALPHA\nreturn vec4(texture(tex, uv).rgb, texture(tex, uv + vec2(0.0, 0.5)).r);\n#else\nreturn texture(tex, uv);\n#endif\n}\n#if USE_ALPHA_TEST\nlayout(std140) uniform ALPHA_TEST_DATA {\nfloat alphaThreshold;\n};\n#endif\nvoid ALPHA_TEST (in vec4 color) {\n#if USE_ALPHA_TEST\nif (color.a < alphaThreshold) discard;\n#endif\n}\nvoid ALPHA_TEST (in float alpha) {\n#if USE_ALPHA_TEST\nif (alpha < alphaThreshold) discard;\n#endif\n}\nin vec4 color;\n#if USE_TEXTURE\nin vec2 uv0;\nuniform sampler2D cc_spriteTexture;\n#endif\nvec4 frag () {\nvec4 o = vec4(1, 1, 1, 1);\n#if USE_TEXTURE\no *= CCSampleWithAlphaSeparated(cc_spriteTexture, uv0);\n#if IS_GRAY\nfloat gray  = 0.2126 * o.r + 0.7152 * o.g + 0.0722 * o.b;\no.r = o.g = o.b = gray;\n#endif\n#endif\no *= color;\nALPHA_TEST(o);\nreturn o;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#endif\n#if USE_INSTANCING\n#if CC_USE_BAKED_ANIMATION\nin highp vec4 a_jointAnimInfo;\n#endif\nin vec4 a_matWorld0;\nin vec4 a_matWorld1;\nin vec4 a_matWorld2;\n#if CC_USE_LIGHTMAP\nin vec4 a_lightingMapUVParam;\n#endif\n#if CC_RECEIVE_SHADOW\nin vec2 a_localShadowBias;\n#endif\n#elif USE_BATCHING\nin float a_dyn_batch_id;\n#endif\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\n#endif\n#if CC_USE_MORPH\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nnormal.xyz = normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\ntangent.xyz = tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\n#if CC_USE_BAKED_ANIMATION\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\nvoid CCGetJointTextureCoords(float pixelsPerJoint, float jointIdx, out highp float x, out highp float y, out highp float invSize)\n{\n#if USE_INSTANCING\nhighp float temp = pixelsPerJoint * (a_jointAnimInfo.x * a_jointAnimInfo.y + jointIdx) + a_jointAnimInfo.z;\n#else\nhighp float temp = pixelsPerJoint * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + jointIdx) + cc_jointTextureInfo.z;\n#endif\ninvSize = cc_jointTextureInfo.w;\nhighp float tempY = floor(temp * invSize);\nx = floor(temp - tempY * cc_jointTextureInfo.x);\ny = (tempY + 0.5) * invSize;\n}\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(3.0, i, x, y, invSize);\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(12.0, i, x, y, invSize);\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nmat4 m = skinMatrix();\nposition = m * position;\nnormal = (m * vec4(normal, 0.0)).xyz;\ntangent.xyz = (m * vec4(tangent.xyz, 0.0)).xyz;\n}\n#endif\nvoid CCVertInput(inout StandardVertInput In)\n{\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In.position, In.normal, In.tangent);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In.position, In.normal, In.tangent);\n#endif\n}\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\n#if !USE_INSTANCING\n#if USE_BATCHING\nlayout(std140) uniform CCLocalBatched {\nhighp mat4 cc_matWorlds[10];\n};\n#else\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\nhighp vec4 cc_localShadowBias;\n};\n#endif\n#endif\nvoid CCGetWorldMatrixFull(out mat4 matWorld, out mat4 matWorldIT)\n{\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\nmatWorldIT = matWorld;\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\nmatWorldIT = matWorld;\n#else\nmatWorld = cc_matWorld;\nmatWorldIT = cc_matWorldIT;\n#endif\n}\nlayout(std140) uniform Constants {\nvec4 tilingOffset;\nvec4 albedo;\nvec4 albedoScaleAndCutoff;\nvec4 pbrParams;\nvec4 emissive;\nvec4 emissiveScaleParam;\n};\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\n#if !CC_USE_ACCURATE_FOG\nout float v_fog_factor;\n#endif\nvoid CC_TRANSFER_FOG(vec4 pos) {\n#if !CC_USE_ACCURATE_FOG\nCC_TRANSFER_FOG_BASE(pos, v_fog_factor);\n#endif\n}\nout highp vec4 v_shadowPos;\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\n#endif\n#if CC_RECEIVE_SHADOW\nvec2 CCGetShadowBias()\n{\n#if USE_INSTANCING\nreturn vec2(a_localShadowBias.x + cc_shadowWHPBInfo.w, a_localShadowBias.y + cc_shadowLPNNInfo.z);\n#elif !USE_BATCHING\nreturn vec2(cc_localShadowBias.x + cc_shadowWHPBInfo.w, cc_localShadowBias.y + cc_shadowLPNNInfo.z);\n#else\nreturn vec2(cc_shadowWHPBInfo.w, cc_shadowLPNNInfo.z);\n#endif\n}\n#endif\n#if USE_VERTEX_COLOR\nin vec4 a_color;\nout lowp vec4 v_color;\n#endif\nout vec3 v_position;\nout mediump vec3 v_normal;\nout vec2 v_uv;\n#if HAS_SECOND_UV\nout mediump vec2 v_uv1;\n#endif\n#if CC_RECEIVE_SHADOW\nout mediump vec2 v_shadowBias;\n#endif\n#if USE_NORMAL_MAP\nout mediump vec4 v_tangent;\n#endif\n#if HAS_SECOND_UV || CC_USE_LIGHTMAP\nin vec2 a_texCoord1;\n#endif\n#if CC_USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nout vec3 v_luv;\nvoid CCLightingMapCaclUV()\n{\n#if !USE_INSTANCING\nv_luv.xy = cc_lightingMapUVParam.xy + a_texCoord1 * cc_lightingMapUVParam.z;\nv_luv.z = cc_lightingMapUVParam.w;\n#else\nv_luv.xy = a_lightingMapUVParam.xy + a_texCoord1 * a_lightingMapUVParam.z;\nv_luv.z = a_lightingMapUVParam.w;\n#endif\n}\n#endif\nvoid main () {\nStandardVertInput In;\nCCVertInput(In);\nmat4 matWorld, matWorldIT;\nCCGetWorldMatrixFull(matWorld, matWorldIT);\nvec4 pos = matWorld * In.position;\nv_position = pos.xyz;\nv_normal = normalize((matWorldIT * vec4(In.normal, 0.0)).xyz);\n#if CC_RECEIVE_SHADOW\nv_shadowBias = CCGetShadowBias();\n#endif\n#if USE_TWOSIDE\nvec3 viewDirect = normalize(cc_cameraPos.xyz - v_position);\nv_normal *= dot(v_normal, viewDirect) < 0.0 ? -1.0 : 1.0;\n#endif\n#if USE_NORMAL_MAP\nv_tangent.xyz = normalize((matWorld * vec4(In.tangent.xyz, 0.0)).xyz);\nv_tangent.w = In.tangent.w;\n#endif\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv = cc_cameraPos.w > 1.0 ? vec2(v_uv.x, 1.0 - v_uv.y) : v_uv;\n#endif\n#if HAS_SECOND_UV\nv_uv1 = a_texCoord1 * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv1 = cc_cameraPos.w > 1.0 ? vec2(v_uv1.x, 1.0 - v_uv1.y) : v_uv1;\n#endif\n#endif\n#if USE_VERTEX_COLOR\nv_color = a_color;\n#endif\nCC_TRANSFER_FOG(pos);\nv_shadowPos = cc_matLightViewProj * pos;\n#if CC_USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nCCLightingMapCaclUV();\n#endif\ngl_Position = cc_matProj * (cc_matView * matWorld) * In.position;\n}",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform Constants {\nvec4 tilingOffset;\nvec4 albedo;\nvec4 albedoScaleAndCutoff;\nvec4 pbrParams;\nvec4 emissive;\nvec4 emissiveScaleParam;\n};\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\nvoid CC_APPLY_FOG_BASE(inout vec4 color, float factor) {\ncolor = vec4(mix(cc_fogColor.rgb, color.rgb, factor), color.a);\n}\n#if !CC_USE_ACCURATE_FOG\nin float v_fog_factor;\n#endif\nvoid CC_APPLY_FOG(inout vec4 color) {\n#if !CC_USE_ACCURATE_FOG\nCC_APPLY_FOG_BASE(color, v_fog_factor);\n#endif\n}\nvoid CC_APPLY_FOG(inout vec4 color, vec3 worldPos) {\n#if CC_USE_ACCURATE_FOG\nfloat factor;\nCC_TRANSFER_FOG_BASE(vec4(worldPos, 1.0), factor);\n#else\nfloat factor = v_fog_factor;\n#endif\nCC_APPLY_FOG_BASE(color, factor);\n}\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\nhighp float unpackHighpData (float mainPart, float modPart) {\nhighp float data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out float mainPart, out float modPart, highp float data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp float unpackHighpData (float mainPart, float modPart, const float modValue) {\nhighp float data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out float mainPart, out float modPart, highp float data, const float modValue) {\nhighp float divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart) {\nhighp vec2 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec2 mainPart, out vec2 modPart, highp vec2 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart, const float modValue) {\nhighp vec2 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec2 mainPart, out vec2 modPart, highp vec2 data, const float modValue) {\nhighp vec2 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart) {\nhighp vec3 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec3 mainPart, out vec3 modPart, highp vec3 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart, const float modValue) {\nhighp vec3 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec3 mainPart, out vec3 modPart, highp vec3 data, const float modValue) {\nhighp vec3 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart) {\nhighp vec4 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec4 mainPart, out vec4 modPart, highp vec4 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart, const float modValue) {\nhighp vec4 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec4 mainPart, out vec4 modPart, highp vec4 data, const float modValue) {\nhighp vec4 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\nhighp vec4 cc_localShadowBias;\n};\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\nvec4 ApplyShadowDepthBias_FaceNormal(vec4 shadowPos, vec3 worldNormal, float normalBias)\n{\nvec4 newShadowPos = shadowPos;\nif(normalBias > EPSILON_LOWP)\n{\nvec4 viewNormal = cc_matLightView * vec4(worldNormal, 0.0);\nif(viewNormal.z < 0.1)\nnewShadowPos.xy += viewNormal.xy * cc_shadowProjInfo.xy * normalBias * clamp(viewNormal.z, 0.001, 0.1);\n}\nreturn newShadowPos;\n}\nvec4 ApplyShadowDepthBias_Perspective(vec4 shadowPos, float viewspaceDepthBias)\n{\nvec3 viewSpacePos;\nviewSpacePos.xy = shadowPos.xy * cc_shadowProjInfo.zw;\nviewSpacePos.z = shadowPos.z * cc_shadowInvProjDepthInfo.x + shadowPos.w * cc_shadowInvProjDepthInfo.y;\nviewSpacePos.xyz += cc_shadowProjDepthInfo.z * normalize(viewSpacePos.xyz) * viewspaceDepthBias;\nvec4 clipSpacePos;\nclipSpacePos.xy = viewSpacePos.xy * cc_shadowProjInfo.xy;\nclipSpacePos.zw = viewSpacePos.z * cc_shadowProjDepthInfo.xz + vec2(cc_shadowProjDepthInfo.y, 0.0);\nif (cc_shadowNFLSInfo.z > EPSILON) {\nclipSpacePos.z = CCGetLinearDepthFromViewSpace(viewSpacePos.xyz);\nclipSpacePos.z = (clipSpacePos.z * 2.0 - 1.0) * clipSpacePos.w;\n}\nreturn clipSpacePos;\n}\nvec4 ApplyShadowDepthBias_Orthographic(vec4 shadowPos, float viewspaceDepthBias)\n{\nfloat coeffA = cc_shadowProjDepthInfo.x;\nfloat coeffB = cc_shadowProjDepthInfo.y;\nfloat viewSpacePos_z = (shadowPos.z - coeffB) / coeffA;\nviewSpacePos_z += viewspaceDepthBias;\nvec4 result = shadowPos;\nresult.z = viewSpacePos_z * coeffA + coeffB;\nreturn result;\n}\nfloat CCGetShadowFactorHard (vec4 shadowPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nclosestDepth = dot(texture(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(clipPos.z, closestDepth);\nreturn shadow;\n}\nfloat CCGetShadowFactorSoft (vec4 shadowPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nblock0 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * mapSize.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetShadowFactorSoft2X (vec4 shadowPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nblock0 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCGetSpotLightShadowFactorHard (vec4 shadowPos, vec3 worldPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = clipPos.z;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nclosestDepth = dot(texture(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(depth, closestDepth);\nreturn shadow;\n}\nfloat CCGetSpotLightShadowFactorSoft (vec4 shadowPos, vec3 worldPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > EPSILON) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nvec2 oneTap = 1.0 / cc_shadowWHPBInfo.xy;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nblock0 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * cc_shadowWHPBInfo.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * cc_shadowWHPBInfo.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetSpotLightShadowFactorSoft2X (vec4 shadowPos, vec3 worldPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > EPSILON) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nblock0 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCSpotShadowFactorBase(vec4 shadowPos, vec3 worldPos, vec2 shadowBias)\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) {\nreturn CCGetSpotLightShadowFactorSoft2X(shadowPos, worldPos, shadowBias.x);\n}else if (pcf > 0.9) {\nreturn CCGetSpotLightShadowFactorSoft(shadowPos, worldPos, shadowBias.x);\n}else {\nreturn CCGetSpotLightShadowFactorHard(shadowPos, worldPos, shadowBias.x);\n}\n}\nfloat CCShadowFactorBase(vec4 shadowPos, vec3 N, vec2 shadowBias)\n{\nfloat realtimeShadow = 1.0;\nvec4 pos = ApplyShadowDepthBias_FaceNormal(shadowPos, N, shadowBias.y);\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) {\nrealtimeShadow =  CCGetShadowFactorSoft2X(pos, shadowBias.x);\n}else if (pcf > 0.9) {\nrealtimeShadow = CCGetShadowFactorSoft(pos, shadowBias.x);\n}else {\nrealtimeShadow = CCGetShadowFactorHard(pos, shadowBias.x);\n}\nreturn mix(realtimeShadow, 1.0, cc_shadowNFLSInfo.w);\n}\n#endif\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\n#if CC_USE_DIFFUSEMAP\nuniform samplerCube cc_diffuseMap;\n#endif\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\n#if USE_REFLECTION_DENOISE\nvec3 GetEnvReflectionWithMipFiltering(vec3 R, float roughness, float mipCount, float denoiseIntensity) {\n#if CC_USE_IBL\nfloat mip = roughness * mipCount;\nfloat delta = (dot(dFdx(R), dFdy(R))) * 1000.0;\nfloat mipBias = mix(0.0, 5.0, clamp(delta, 0.0, 1.0));\nvec4 biased = fragTextureLod(cc_environment, R, mip + mipBias);\nvec4 filtered = texture(cc_environment, R);\n#if CC_USE_IBL == 2\nbiased.rgb = unpackRGBE(biased);\nfiltered.rgb = unpackRGBE(filtered);\n#else\nbiased.rgb = SRGBToLinear(biased.rgb);\nfiltered.rgb = SRGBToLinear(filtered.rgb);\n#endif\nreturn mix(biased.rgb, filtered.rgb, denoiseIntensity);\n#else\nreturn vec3(0.0, 0.0, 0.0);\n#endif\n}\n#endif\nstruct StandardSurface {\nvec4 albedo;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nvec3 position, position_fract_part;\n#else\nvec3 position;\n#endif\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\nfloat specularIntensity;\n#if CC_RECEIVE_SHADOW\nvec2 shadowBias;\n#endif\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.08 * s.specularIntensity), s.albedo.rgb, s.metallic);\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.0);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse / PI;\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nvec3 dirlightContrib = (diffuseContrib + specularContrib);\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (NL > 0.0 && cc_mainLitDir.w > 0.0) {\nshadow = CCShadowFactorBase(shadowPos, N, s.shadowBias);\n}\n#endif\ndirlightContrib *= shadow;\nfinalColor *= dirlightContrib;\n#if CC_USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > EPSILON_LOWP) {\nfinalColor = diffuse * s.lightmap.rgb * shadow;\n}\n#endif\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb);\n#if CC_USE_IBL\n#if CC_USE_DIFFUSEMAP\nvec4 diffuseMap = texture(cc_diffuseMap, N);\n#if CC_USE_DIFFUSEMAP == 2\nambDiff = unpackRGBE(diffuseMap);\n#else\nambDiff = SRGBToLinear(diffuseMap.rgb);\n#endif\n#endif\nvec3 R = normalize(reflect(-V, N));\n#if USE_REFLECTION_DENOISE\nvec3 env = GetEnvReflectionWithMipFiltering(R, s.roughness, cc_ambientGround.w, 0.6);\n#else\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\n#endif\nfinalColor += env * cc_ambientSky.w * specular * s.occlusion;\n#endif\nfinalColor += ambDiff.rgb * cc_ambientSky.w * diffuse * s.occlusion;\nfinalColor += s.emissive;\nreturn vec4(finalColor, s.albedo.a);\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nin highp vec4 v_shadowPos;\n#if CC_RECEIVE_SHADOW\n#endif\n#if CC_USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nin vec3 v_luv;\nuniform sampler2D cc_lightingMap;\n#endif\nin vec3 v_position;\nin vec2 v_uv;\n#if HAS_SECOND_UV\nin mediump vec2 v_uv1;\n#endif\nin mediump vec3 v_normal;\n#if CC_RECEIVE_SHADOW\nin mediump vec2 v_shadowBias;\n#endif\n#if USE_VERTEX_COLOR\nin lowp vec4 v_color;\n#endif\n#if USE_ALBEDO_MAP\nuniform sampler2D albedoMap;\n#endif\n#if USE_NORMAL_MAP\nin mediump vec4 v_tangent;\nuniform sampler2D normalMap;\n#endif\n#if USE_PBR_MAP\nuniform sampler2D pbrMap;\n#endif\n#if USE_METALLIC_ROUGHNESS_MAP\nuniform sampler2D metallicRoughnessMap;\n#endif\n#if USE_OCCLUSION_MAP\nuniform sampler2D occlusionMap;\n#endif\n#if USE_EMISSIVE_MAP\nuniform sampler2D emissiveMap;\n#endif\n#if USE_ALPHA_TEST\n#endif\nvoid surf (out StandardSurface s) {\nvec4 baseColor = albedo;\n#if USE_VERTEX_COLOR\nbaseColor.rgb *= SRGBToLinear(v_color.rgb);\nbaseColor.a *= v_color.a;\n#endif\n#if USE_ALBEDO_MAP\nvec4 texColor = texture(albedoMap, ALBEDO_UV);\ntexColor.rgb = SRGBToLinear(texColor.rgb);\nbaseColor *= texColor;\n#endif\ns.albedo = baseColor;\ns.albedo.rgb *= albedoScaleAndCutoff.xyz;\n#if USE_ALPHA_TEST\nif (s.albedo.ALPHA_TEST_CHANNEL < albedoScaleAndCutoff.w) discard;\n#endif\n#if CC_USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvec4 lightColor = texture(cc_lightingMap, v_luv.xy);\ns.lightmap = lightColor.xyz * v_luv.z;\ns.lightmap_test = v_luv.z;\n#endif\ns.normal = v_normal;\n#if CC_RECEIVE_SHADOW\ns.shadowBias = v_shadowBias;\n#endif\n#if USE_NORMAL_MAP\nvec3 nmmp = texture(normalMap, NORMAL_UV).xyz - vec3(0.5);\nvec3 bitangent = cross(v_normal, v_tangent.xyz) * v_tangent.w;\ns.normal =\n(nmmp.x * emissiveScaleParam.w) * normalize(v_tangent.xyz) +\n(nmmp.y * emissiveScaleParam.w) * normalize(bitangent) +\nnmmp.z * normalize(s.normal);\n#endif\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\npackHighpData(s.position, s.position_fract_part, v_position);\n#else\ns.position = v_position;\n#endif\nvec4 pbr = pbrParams;\n#if USE_PBR_MAP\nvec4 res = texture(pbrMap, PBR_UV);\npbr.x *= res.r;\npbr.y *= res.g;\npbr.z *= res.b;\npbr.w *= res.a;\n#endif\n#if USE_METALLIC_ROUGHNESS_MAP\nvec4 metallicRoughness = texture(metallicRoughnessMap, PBR_UV);\npbr.z *= metallicRoughness.b;\npbr.y *= metallicRoughness.g;\n#endif\n#if USE_OCCLUSION_MAP\npbr.x *= texture(occlusionMap, PBR_UV).r;\n#endif\ns.occlusion = pbr.x;\ns.roughness = pbr.y;\ns.specularIntensity = 0.5;\ns.metallic = pbr.z;\ns.emissive = emissive.rgb * emissiveScaleParam.xyz;\n#if USE_EMISSIVE_MAP\ns.emissive *= SRGBToLinear(texture(emissiveMap, EMISSIVE_UV).rgb);\n#endif\n}\n#if CC_FORWARD_ADD\n#if CC_PIPELINE_TYPE == 0\n#define LIGHTS_PER_PASS 1\n#else\n#define LIGHTS_PER_PASS 10\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nlayout(std140) uniform CCForwardLight {\nhighp vec4 cc_lightPos[LIGHTS_PER_PASS];\nvec4 cc_lightColor[LIGHTS_PER_PASS];\nvec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nvec4 cc_lightDir[LIGHTS_PER_PASS];\n};\n#endif\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / PI;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.0);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = litRadiusSqr / max(litRadiusSqr, distSqr);\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0 && cc_lightSizeRangeAngle[i].w > 0.0) {\nshadow = CCSpotShadowFactorBase(shadowPos, position, s.shadowBias);\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nlayout(std430, binding = 4) readonly buffer b_ccLightsBuffer { vec4 b_ccLights[]; };\nlayout(std430, binding = 5) readonly buffer b_clusterLightIndicesBuffer { uint b_clusterLightIndices[]; };\nlayout(std430, binding = 6) readonly buffer b_clusterLightGridBuffer { uvec4 b_clusterLightGrid[]; };\nstruct CCLight\n{\nvec4 cc_lightPos;\nvec4 cc_lightColor;\nvec4 cc_lightSizeRangeAngle;\nvec4 cc_lightDir;\n};\nstruct Cluster\n{\nvec3 minBounds;\nvec3 maxBounds;\n};\nstruct LightGrid\n{\nuint offset;\nuint ccLights;\n};\nCCLight getCCLight(uint i)\n{\nCCLight light;\nlight.cc_lightPos = b_ccLights[4u * i + 0u];\nlight.cc_lightColor = b_ccLights[4u * i + 1u];\nlight.cc_lightSizeRangeAngle = b_ccLights[4u * i + 2u];\nlight.cc_lightDir = b_ccLights[4u * i + 3u];\nreturn light;\n}\nLightGrid getLightGrid(uint cluster)\n{\nuvec4 gridvec = b_clusterLightGrid[cluster];\nLightGrid grid;\ngrid.offset = gridvec.x;\ngrid.ccLights = gridvec.y;\nreturn grid;\n}\nuint getGridLightIndex(uint start, uint offset)\n{\nreturn b_clusterLightIndices[start + offset];\n}\nuint getClusterZIndex(vec4 worldPos)\n{\nfloat scale = float(24) / log(cc_nearFar.y / cc_nearFar.x);\nfloat bias = -(float(24) * log(cc_nearFar.x) / log(cc_nearFar.y / cc_nearFar.x));\nfloat eyeDepth = -(cc_matView * worldPos).z;\nuint zIndex = uint(max(log(eyeDepth) * scale + bias, 0.0));\nreturn zIndex;\n}\nuint getClusterIndex(vec4 fragCoord, vec4 worldPos)\n{\nuint zIndex = getClusterZIndex(worldPos);\nfloat clusterSizeX = ceil(cc_viewPort.z / float(16));\nfloat clusterSizeY = ceil(cc_viewPort.w / float(8));\nuvec3 indices = uvec3(uvec2(fragCoord.xy / vec2(clusterSizeX, clusterSizeY)), zIndex);\nuint cluster = (16u * 8u) * indices.z + 16u * indices.y + indices.x;\nreturn cluster;\n}\nvec4 CCClusterShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / PI;\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nuint cluster = getClusterIndex(gl_FragCoord, vec4(position, 1.0));\nLightGrid grid = getLightGrid(cluster);\nuint numLights = grid.ccLights;\nfor (uint i = 0u; i < 100u; i++) {\nif (i >= numLights) break;\nuint lightIndex = getGridLightIndex(grid.offset, i);\nCCLight light = getCCLight(lightIndex);\nvec3 SLU = light.cc_lightPos.xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.001);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = light.cc_lightSizeRangeAngle.x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = PI * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(light.cc_lightSizeRangeAngle.y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (light.cc_lightPos.w > 0.0) {\nfloat cosInner = max(dot(-light.cc_lightDir.xyz, SL), 0.01);\nfloat cosOuter = light.cc_lightSizeRangeAngle.z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -light.cc_lightDir.xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = light.cc_lightColor.rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (light.cc_lightPos.w > 0.0) {\nshadow = CCSpotShadowFactorBase(shadowPos, position, s.shadowBias);\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * light.cc_lightColor.w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\nlayout(location = 0) out vec4 fragColorX;\nvoid main () {\nStandardSurface s; surf(s);\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nvec4 color = CCClusterShadingAdditive(s, v_shadowPos);\n#else\nvec4 color = CCStandardShadingAdditive(s, v_shadowPos);\n#endif\nfragColorX = CCFragOutput(color);\n}\n#elif (CC_PIPELINE_TYPE == 0 || CC_FORCE_FORWARD_SHADING)\nlayout(location = 0) out vec4 fragColorX;\nvoid main () {\nStandardSurface s; surf(s);\nvec4 color = CCStandardShadingBase(s, v_shadowPos);\nCC_APPLY_FOG(color, s.position.xyz);\nfragColorX = CCFragOutput(color);\n}\n#elif CC_PIPELINE_TYPE == 1\nvec2 signNotZero(vec2 v) {\nreturn vec2((v.x >= 0.0) ? +1.0 : -1.0, (v.y >= 0.0) ? +1.0 : -1.0);\n}\nvec2 float32x3_to_oct(in vec3 v) {\nvec2 p = v.xy * (1.0 / (abs(v.x) + abs(v.y) + abs(v.z)));\nreturn (v.z <= 0.0) ? ((1.0 - abs(p.yx)) * signNotZero(p)) : p;\n}\nlayout(location = 0) out vec4 fragColor0;\nlayout(location = 1) out vec4 fragColor1;\nlayout(location = 2) out vec4 fragColor2;\nvoid main () {\nStandardSurface s; surf(s);\nfragColor0 = s.albedo;\nfragColor1 = vec4(float32x3_to_oct(s.normal), s.roughness, s.metallic);\nfragColor2 = vec4(s.emissive, s.occlusion);\n}\n#endif"},{vert:"\nprecision highp float;\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#endif\n#if USE_INSTANCING\n#if CC_USE_BAKED_ANIMATION\nin highp vec4 a_jointAnimInfo;\n#endif\nin vec4 a_matWorld0;\nin vec4 a_matWorld1;\nin vec4 a_matWorld2;\n#if CC_USE_LIGHTMAP\nin vec4 a_lightingMapUVParam;\n#endif\n#if CC_RECEIVE_SHADOW\nin vec2 a_localShadowBias;\n#endif\n#elif USE_BATCHING\nin float a_dyn_batch_id;\n#endif\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\n#endif\n#if CC_USE_MORPH\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nnormal.xyz = normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\ntangent.xyz = tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\n#if CC_USE_BAKED_ANIMATION\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\nvoid CCGetJointTextureCoords(float pixelsPerJoint, float jointIdx, out highp float x, out highp float y, out highp float invSize)\n{\n#if USE_INSTANCING\nhighp float temp = pixelsPerJoint * (a_jointAnimInfo.x * a_jointAnimInfo.y + jointIdx) + a_jointAnimInfo.z;\n#else\nhighp float temp = pixelsPerJoint * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + jointIdx) + cc_jointTextureInfo.z;\n#endif\ninvSize = cc_jointTextureInfo.w;\nhighp float tempY = floor(temp * invSize);\nx = floor(temp - tempY * cc_jointTextureInfo.x);\ny = (tempY + 0.5) * invSize;\n}\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(3.0, i, x, y, invSize);\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(12.0, i, x, y, invSize);\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nmat4 m = skinMatrix();\nposition = m * position;\nnormal = (m * vec4(normal, 0.0)).xyz;\ntangent.xyz = (m * vec4(tangent.xyz, 0.0)).xyz;\n}\n#endif\nvoid CCVertInput(inout StandardVertInput In)\n{\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In.position, In.normal, In.tangent);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In.position, In.normal, In.tangent);\n#endif\n}\n#if !USE_INSTANCING\n#if USE_BATCHING\nlayout(std140) uniform CCLocalBatched {\nhighp mat4 cc_matWorlds[10];\n};\n#else\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\nhighp vec4 cc_localShadowBias;\n};\n#endif\n#endif\nvoid CCGetWorldMatrixFull(out mat4 matWorld, out mat4 matWorldIT)\n{\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\nmatWorldIT = matWorld;\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\nmatWorldIT = matWorld;\n#else\nmatWorld = cc_matWorld;\nmatWorldIT = cc_matWorldIT;\n#endif\n}\nlayout(std140) uniform Constants {\nvec4 tilingOffset;\nvec4 albedo;\nvec4 albedoScaleAndCutoff;\nvec4 pbrParams;\nvec4 emissive;\nvec4 emissiveScaleParam;\n};\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\n#if HAS_SECOND_UV || CC_USE_LIGHTMAP\nin vec2 a_texCoord1;\n#endif\nout vec2 v_uv;\n#if HAS_SECOND_UV\nout vec2 v_uv1;\n#endif\nout vec4 v_worldPos;\nout float v_clip_depth;\nvec4 vert () {\nStandardVertInput In;\nCCVertInput(In);\nmat4 matWorld, matWorldIT;\nCCGetWorldMatrixFull(matWorld, matWorldIT);\nv_worldPos = matWorld * In.position;\nvec4 clipPos = cc_matLightViewProj * v_worldPos;\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if HAS_SECOND_UV\nv_uv1 = a_texCoord1 * tilingOffset.xy + tilingOffset.zw;\n#endif\nv_clip_depth = clipPos.z / clipPos.w * 0.5 + 0.5;\nreturn clipPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nlayout(std140) uniform Constants {\nvec4 tilingOffset;\nvec4 albedo;\nvec4 albedoScaleAndCutoff;\nvec4 pbrParams;\nvec4 emissive;\nvec4 emissiveScaleParam;\n};\nvec4 packDepthToRGBA (float depth) {\nvec4 ret = vec4(1.0, 255.0, 65025.0, 16581375.0) * depth;\nret = fract(ret);\nret -= vec4(ret.yzw, 0.0) / 255.0;\nreturn ret;\n}\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\nhighp vec4 cc_localShadowBias;\n};\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\n#endif\nin vec2 v_uv;\n#if HAS_SECOND_UV\nin vec2 v_uv1;\n#endif\nin vec4 v_worldPos;\nin float v_clip_depth;\n#if USE_ALBEDO_MAP\nuniform sampler2D albedoMap;\n#endif\n#if USE_ALPHA_TEST\n#endif\nvec4 frag () {\nvec4 baseColor = albedo;\n#if USE_ALBEDO_MAP\nbaseColor *= texture(albedoMap, ALBEDO_UV);\n#endif\n#if USE_ALPHA_TEST\nif (baseColor.ALPHA_TEST_CHANNEL < albedoScaleAndCutoff.w) discard;\n#endif\nif(cc_shadowLPNNInfo.x > 0.000001 && cc_shadowLPNNInfo.x < 1.999999) {\nif (cc_shadowNFLSInfo.z > 0.000001) {\nreturn vec4(CCGetLinearDepth(v_worldPos.xyz), 1.0, 1.0, 1.0);\n}\n}\nif (cc_shadowLPNNInfo.y > 0.000001) {\nreturn packDepthToRGBA(v_clip_depth);\n}\nreturn vec4(v_clip_depth, 1.0, 1.0, 1.0);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\nhighp vec4 cc_localShadowBias;\n};\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\n#if !CC_USE_ACCURATE_FOG\nout float v_fog_factor;\n#endif\nvoid CC_TRANSFER_FOG(vec4 pos) {\n#if !CC_USE_ACCURATE_FOG\nCC_TRANSFER_FOG_BASE(pos, v_fog_factor);\n#endif\n}\nout highp vec4 v_shadowPos;\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\n#endif\n#if CC_RECEIVE_SHADOW\n#endif\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\n#if CC_RECEIVE_SHADOW\nout vec2 v_shadowBias;\n#endif\nout highp vec3 v_position;\nout mediump vec3 v_normal;\nout mediump vec2 uvw;\nout mediump vec2 uv0;\nout mediump vec2 uv1;\nout mediump vec2 uv2;\nout mediump vec2 uv3;\nout mediump vec3 luv;\nout mediump vec3 diffuse;\nlayout(std140) uniform TexCoords {\nvec4 UVScale;\nvec4 lightMapUVParam;\n};\nvoid main () {\nvec3 worldPos;\nworldPos.x = cc_matWorld[3][0] + a_position.x;\nworldPos.y = cc_matWorld[3][1] + a_position.y;\nworldPos.z = cc_matWorld[3][2] + a_position.z;\nvec4 pos = vec4(worldPos, 1.0);\npos = cc_matViewProj * pos;\nuvw = a_texCoord;\nuv0 = a_position.xz * UVScale.x;\nuv1 = a_position.xz * UVScale.y;\nuv2 = a_position.xz * UVScale.z;\nuv3 = a_position.xz * UVScale.w;\n#if CC_USE_LIGHTMAP\nluv.xy = lightMapUVParam.xy + a_texCoord * lightMapUVParam.z;\nluv.z = lightMapUVParam.w;\n#endif\nv_position = worldPos;\nv_normal = a_normal;\nCC_TRANSFER_FOG(vec4(worldPos, 1.0));\n#if CC_RECEIVE_SHADOW\nv_shadowBias = vec2(0.0, 0.0);\n#endif\nv_shadowPos = cc_matLightViewProj * vec4(worldPos, 1.0);\ngl_Position = pos;\n}",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\nhighp float unpackHighpData (float mainPart, float modPart) {\nhighp float data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out float mainPart, out float modPart, highp float data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp float unpackHighpData (float mainPart, float modPart, const float modValue) {\nhighp float data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out float mainPart, out float modPart, highp float data, const float modValue) {\nhighp float divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart) {\nhighp vec2 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec2 mainPart, out vec2 modPart, highp vec2 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart, const float modValue) {\nhighp vec2 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec2 mainPart, out vec2 modPart, highp vec2 data, const float modValue) {\nhighp vec2 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart) {\nhighp vec3 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec3 mainPart, out vec3 modPart, highp vec3 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart, const float modValue) {\nhighp vec3 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec3 mainPart, out vec3 modPart, highp vec3 data, const float modValue) {\nhighp vec3 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart) {\nhighp vec4 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec4 mainPart, out vec4 modPart, highp vec4 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart, const float modValue) {\nhighp vec4 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec4 mainPart, out vec4 modPart, highp vec4 data, const float modValue) {\nhighp vec4 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\nhighp vec4 cc_localShadowBias;\n};\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\nvec4 ApplyShadowDepthBias_FaceNormal(vec4 shadowPos, vec3 worldNormal, float normalBias)\n{\nvec4 newShadowPos = shadowPos;\nif(normalBias > EPSILON_LOWP)\n{\nvec4 viewNormal = cc_matLightView * vec4(worldNormal, 0.0);\nif(viewNormal.z < 0.1)\nnewShadowPos.xy += viewNormal.xy * cc_shadowProjInfo.xy * normalBias * clamp(viewNormal.z, 0.001, 0.1);\n}\nreturn newShadowPos;\n}\nvec4 ApplyShadowDepthBias_Perspective(vec4 shadowPos, float viewspaceDepthBias)\n{\nvec3 viewSpacePos;\nviewSpacePos.xy = shadowPos.xy * cc_shadowProjInfo.zw;\nviewSpacePos.z = shadowPos.z * cc_shadowInvProjDepthInfo.x + shadowPos.w * cc_shadowInvProjDepthInfo.y;\nviewSpacePos.xyz += cc_shadowProjDepthInfo.z * normalize(viewSpacePos.xyz) * viewspaceDepthBias;\nvec4 clipSpacePos;\nclipSpacePos.xy = viewSpacePos.xy * cc_shadowProjInfo.xy;\nclipSpacePos.zw = viewSpacePos.z * cc_shadowProjDepthInfo.xz + vec2(cc_shadowProjDepthInfo.y, 0.0);\nif (cc_shadowNFLSInfo.z > EPSILON) {\nclipSpacePos.z = CCGetLinearDepthFromViewSpace(viewSpacePos.xyz);\nclipSpacePos.z = (clipSpacePos.z * 2.0 - 1.0) * clipSpacePos.w;\n}\nreturn clipSpacePos;\n}\nvec4 ApplyShadowDepthBias_Orthographic(vec4 shadowPos, float viewspaceDepthBias)\n{\nfloat coeffA = cc_shadowProjDepthInfo.x;\nfloat coeffB = cc_shadowProjDepthInfo.y;\nfloat viewSpacePos_z = (shadowPos.z - coeffB) / coeffA;\nviewSpacePos_z += viewspaceDepthBias;\nvec4 result = shadowPos;\nresult.z = viewSpacePos_z * coeffA + coeffB;\nreturn result;\n}\nfloat CCGetShadowFactorHard (vec4 shadowPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nclosestDepth = dot(texture(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(clipPos.z, closestDepth);\nreturn shadow;\n}\nfloat CCGetShadowFactorSoft (vec4 shadowPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nblock0 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * mapSize.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetShadowFactorSoft2X (vec4 shadowPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nblock0 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCGetSpotLightShadowFactorHard (vec4 shadowPos, vec3 worldPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = clipPos.z;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nclosestDepth = dot(texture(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(depth, closestDepth);\nreturn shadow;\n}\nfloat CCGetSpotLightShadowFactorSoft (vec4 shadowPos, vec3 worldPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > EPSILON) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nvec2 oneTap = 1.0 / cc_shadowWHPBInfo.xy;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nblock0 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * cc_shadowWHPBInfo.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * cc_shadowWHPBInfo.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetSpotLightShadowFactorSoft2X (vec4 shadowPos, vec3 worldPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > EPSILON) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nblock0 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCSpotShadowFactorBase(vec4 shadowPos, vec3 worldPos, vec2 shadowBias)\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) {\nreturn CCGetSpotLightShadowFactorSoft2X(shadowPos, worldPos, shadowBias.x);\n}else if (pcf > 0.9) {\nreturn CCGetSpotLightShadowFactorSoft(shadowPos, worldPos, shadowBias.x);\n}else {\nreturn CCGetSpotLightShadowFactorHard(shadowPos, worldPos, shadowBias.x);\n}\n}\nfloat CCShadowFactorBase(vec4 shadowPos, vec3 N, vec2 shadowBias)\n{\nfloat realtimeShadow = 1.0;\nvec4 pos = ApplyShadowDepthBias_FaceNormal(shadowPos, N, shadowBias.y);\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) {\nrealtimeShadow =  CCGetShadowFactorSoft2X(pos, shadowBias.x);\n}else if (pcf > 0.9) {\nrealtimeShadow = CCGetShadowFactorSoft(pos, shadowBias.x);\n}else {\nrealtimeShadow = CCGetShadowFactorHard(pos, shadowBias.x);\n}\nreturn mix(realtimeShadow, 1.0, cc_shadowNFLSInfo.w);\n}\n#endif\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\n#if CC_USE_DIFFUSEMAP\nuniform samplerCube cc_diffuseMap;\n#endif\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\n#if USE_REFLECTION_DENOISE\nvec3 GetEnvReflectionWithMipFiltering(vec3 R, float roughness, float mipCount, float denoiseIntensity) {\n#if CC_USE_IBL\nfloat mip = roughness * mipCount;\nfloat delta = (dot(dFdx(R), dFdy(R))) * 1000.0;\nfloat mipBias = mix(0.0, 5.0, clamp(delta, 0.0, 1.0));\nvec4 biased = fragTextureLod(cc_environment, R, mip + mipBias);\nvec4 filtered = texture(cc_environment, R);\n#if CC_USE_IBL == 2\nbiased.rgb = unpackRGBE(biased);\nfiltered.rgb = unpackRGBE(filtered);\n#else\nbiased.rgb = SRGBToLinear(biased.rgb);\nfiltered.rgb = SRGBToLinear(filtered.rgb);\n#endif\nreturn mix(biased.rgb, filtered.rgb, denoiseIntensity);\n#else\nreturn vec3(0.0, 0.0, 0.0);\n#endif\n}\n#endif\nstruct StandardSurface {\nvec4 albedo;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nvec3 position, position_fract_part;\n#else\nvec3 position;\n#endif\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\nfloat specularIntensity;\n#if CC_RECEIVE_SHADOW\nvec2 shadowBias;\n#endif\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.08 * s.specularIntensity), s.albedo.rgb, s.metallic);\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.0);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse / PI;\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nvec3 dirlightContrib = (diffuseContrib + specularContrib);\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (NL > 0.0 && cc_mainLitDir.w > 0.0) {\nshadow = CCShadowFactorBase(shadowPos, N, s.shadowBias);\n}\n#endif\ndirlightContrib *= shadow;\nfinalColor *= dirlightContrib;\n#if CC_USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > EPSILON_LOWP) {\nfinalColor = diffuse * s.lightmap.rgb * shadow;\n}\n#endif\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb);\n#if CC_USE_IBL\n#if CC_USE_DIFFUSEMAP\nvec4 diffuseMap = texture(cc_diffuseMap, N);\n#if CC_USE_DIFFUSEMAP == 2\nambDiff = unpackRGBE(diffuseMap);\n#else\nambDiff = SRGBToLinear(diffuseMap.rgb);\n#endif\n#endif\nvec3 R = normalize(reflect(-V, N));\n#if USE_REFLECTION_DENOISE\nvec3 env = GetEnvReflectionWithMipFiltering(R, s.roughness, cc_ambientGround.w, 0.6);\n#else\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\n#endif\nfinalColor += env * cc_ambientSky.w * specular * s.occlusion;\n#endif\nfinalColor += ambDiff.rgb * cc_ambientSky.w * diffuse * s.occlusion;\nfinalColor += s.emissive;\nreturn vec4(finalColor, s.albedo.a);\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\nvoid CC_APPLY_FOG_BASE(inout vec4 color, float factor) {\ncolor = vec4(mix(cc_fogColor.rgb, color.rgb, factor), color.a);\n}\n#if !CC_USE_ACCURATE_FOG\nin float v_fog_factor;\n#endif\nvoid CC_APPLY_FOG(inout vec4 color) {\n#if !CC_USE_ACCURATE_FOG\nCC_APPLY_FOG_BASE(color, v_fog_factor);\n#endif\n}\nvoid CC_APPLY_FOG(inout vec4 color, vec3 worldPos) {\n#if CC_USE_ACCURATE_FOG\nfloat factor;\nCC_TRANSFER_FOG_BASE(vec4(worldPos, 1.0), factor);\n#else\nfloat factor = v_fog_factor;\n#endif\nCC_APPLY_FOG_BASE(color, factor);\n}\nin highp vec4 v_shadowPos;\n#if CC_RECEIVE_SHADOW\n#endif\n#if CC_USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nin vec3 v_luv;\nuniform sampler2D cc_lightingMap;\n#endif\nin highp vec3 v_position;\nin mediump vec3 v_normal;\n#if CC_RECEIVE_SHADOW\nin vec2 v_shadowBias;\n#endif\nin mediump vec2 uvw;\nin mediump vec2 uv0;\nin mediump vec2 uv1;\nin mediump vec2 uv2;\nin mediump vec2 uv3;\nin mediump vec3 diffuse;\nin mediump vec3 luv;\nlayout(std140) uniform PbrParams {\nvec4 metallic;\nvec4 roughness;\n};\nuniform sampler2D weightMap;\nuniform sampler2D detailMap0;\nuniform sampler2D detailMap1;\nuniform sampler2D detailMap2;\nuniform sampler2D detailMap3;\nuniform sampler2D normalMap0;\nuniform sampler2D normalMap1;\nuniform sampler2D normalMap2;\nuniform sampler2D normalMap3;\nuniform sampler2D lightMap;\nvoid surf (out StandardSurface s) {\n#if LAYERS > 1\nvec4 w = texture(weightMap, uvw);\n#endif\nvec4 baseColor = vec4(0, 0, 0, 0);\n#if LAYERS == 1\nbaseColor = texture(detailMap0, uv0);\n#elif LAYERS == 2\nbaseColor += texture(detailMap0, uv0) * w.r;\nbaseColor += texture(detailMap1, uv1) * w.g;\n#elif LAYERS == 3\nbaseColor += texture(detailMap0, uv0) * w.r;\nbaseColor += texture(detailMap1, uv1) * w.g;\nbaseColor += texture(detailMap2, uv2) * w.b;\n#elif LAYERS == 4\nbaseColor += texture(detailMap0, uv0) * w.r;\nbaseColor += texture(detailMap1, uv1) * w.g;\nbaseColor += texture(detailMap2, uv2) * w.b;\nbaseColor += texture(detailMap3, uv3) * w.a;\n#else\nbaseColor = texture(detailMap0, uv0);\n#endif\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\npackHighpData(s.position, s.position_fract_part, v_position);\n#else\ns.position = v_position;\n#endif\n#if USE_NORMALMAP\nvec4 baseNormal = vec4(0, 0, 0, 0);\n#if LAYERS == 1\nbaseNormal = texture(normalMap0, uv0);\n#elif LAYERS == 2\nbaseNormal += texture(normalMap0, uv0) * w.r;\nbaseNormal += texture(normalMap1, uv1) * w.g;\n#elif LAYERS == 3\nbaseNormal += texture(normalMap0, uv0) * w.r;\nbaseNormal += texture(normalMap1, uv1) * w.g;\nbaseNormal += texture(normalMap2, uv2) * w.b;\n#elif LAYERS == 4\nbaseNormal += texture(normalMap0, uv0) * w.r;\nbaseNormal += texture(normalMap1, uv1) * w.g;\nbaseNormal += texture(normalMap2, uv2) * w.b;\nbaseNormal += texture(normalMap3, uv3) * w.a;\n#else\nbaseNormal = texture(normalMap0, uv0);\n#endif\nvec3 tangent = vec3(1.0, 0.0, 0.0);\nvec3 binormal = vec3(0.0, 0.0, 1.0);\nbinormal = cross(tangent, v_normal);\ntangent = cross(v_normal, binormal);\nvec3 nmmp = baseNormal.xyz - vec3(0.5);\ns.normal =\nnmmp.x * normalize(tangent) +\nnmmp.y * normalize(binormal) +\nnmmp.z * normalize(v_normal);\n#else\ns.normal = v_normal;\n#endif\n#if CC_RECEIVE_SHADOW\ns.shadowBias = v_shadowBias;\n#endif\ns.albedo = vec4(SRGBToLinear(baseColor.rgb), 1.0);\ns.occlusion = 1.0;\n#if USE_PBR\ns.roughness = 0.0;\n#if LAYERS == 1\ns.roughness = roughness.x;\n#elif LAYERS == 2\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\n#elif LAYERS == 3\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\ns.roughness += roughness.z * w.b;\n#elif LAYERS == 4\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\ns.roughness += roughness.z * w.b;\ns.roughness += roughness.w * w.a;\n#else\ns.roughness = 1.0;\n#endif\ns.specularIntensity = 0.5;\ns.metallic = 0.0;\n#if LAYERS == 1\ns.specularIntensity = 0.5;\ns.metallic = metallic.x;\n#elif LAYERS == 2\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\n#elif LAYERS == 3\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\ns.metallic += metallic.z * w.b;\n#elif LAYERS == 4\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\ns.metallic += metallic.z * w.b;\ns.metallic += metallic.w * w.a;\n#else\ns.specularIntensity = 0.5;\ns.metallic = 0.0;\n#endif\n#else\ns.roughness = 1.0;\ns.specularIntensity = 0.5;\ns.metallic = 0.0;\n#endif\ns.emissive = vec3(0.0, 0.0, 0.0);\n#if CC_USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvec4 lightColor = texture(lightMap, luv.xy);\ns.lightmap = lightColor.xyz * luv.z;\ns.lightmap_test = luv.z;\n#endif\n}\n#if CC_FORWARD_ADD\n#if CC_PIPELINE_TYPE == 0\n#define LIGHTS_PER_PASS 1\n#else\n#define LIGHTS_PER_PASS 10\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nlayout(std140) uniform CCForwardLight {\nhighp vec4 cc_lightPos[LIGHTS_PER_PASS];\nvec4 cc_lightColor[LIGHTS_PER_PASS];\nvec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nvec4 cc_lightDir[LIGHTS_PER_PASS];\n};\n#endif\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / PI;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.0);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = litRadiusSqr / max(litRadiusSqr, distSqr);\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0 && cc_lightSizeRangeAngle[i].w > 0.0) {\nshadow = CCSpotShadowFactorBase(shadowPos, position, s.shadowBias);\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nlayout(std430, binding = 4) readonly buffer b_ccLightsBuffer { vec4 b_ccLights[]; };\nlayout(std430, binding = 5) readonly buffer b_clusterLightIndicesBuffer { uint b_clusterLightIndices[]; };\nlayout(std430, binding = 6) readonly buffer b_clusterLightGridBuffer { uvec4 b_clusterLightGrid[]; };\nstruct CCLight\n{\nvec4 cc_lightPos;\nvec4 cc_lightColor;\nvec4 cc_lightSizeRangeAngle;\nvec4 cc_lightDir;\n};\nstruct Cluster\n{\nvec3 minBounds;\nvec3 maxBounds;\n};\nstruct LightGrid\n{\nuint offset;\nuint ccLights;\n};\nCCLight getCCLight(uint i)\n{\nCCLight light;\nlight.cc_lightPos = b_ccLights[4u * i + 0u];\nlight.cc_lightColor = b_ccLights[4u * i + 1u];\nlight.cc_lightSizeRangeAngle = b_ccLights[4u * i + 2u];\nlight.cc_lightDir = b_ccLights[4u * i + 3u];\nreturn light;\n}\nLightGrid getLightGrid(uint cluster)\n{\nuvec4 gridvec = b_clusterLightGrid[cluster];\nLightGrid grid;\ngrid.offset = gridvec.x;\ngrid.ccLights = gridvec.y;\nreturn grid;\n}\nuint getGridLightIndex(uint start, uint offset)\n{\nreturn b_clusterLightIndices[start + offset];\n}\nuint getClusterZIndex(vec4 worldPos)\n{\nfloat scale = float(24) / log(cc_nearFar.y / cc_nearFar.x);\nfloat bias = -(float(24) * log(cc_nearFar.x) / log(cc_nearFar.y / cc_nearFar.x));\nfloat eyeDepth = -(cc_matView * worldPos).z;\nuint zIndex = uint(max(log(eyeDepth) * scale + bias, 0.0));\nreturn zIndex;\n}\nuint getClusterIndex(vec4 fragCoord, vec4 worldPos)\n{\nuint zIndex = getClusterZIndex(worldPos);\nfloat clusterSizeX = ceil(cc_viewPort.z / float(16));\nfloat clusterSizeY = ceil(cc_viewPort.w / float(8));\nuvec3 indices = uvec3(uvec2(fragCoord.xy / vec2(clusterSizeX, clusterSizeY)), zIndex);\nuint cluster = (16u * 8u) * indices.z + 16u * indices.y + indices.x;\nreturn cluster;\n}\nvec4 CCClusterShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / PI;\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nuint cluster = getClusterIndex(gl_FragCoord, vec4(position, 1.0));\nLightGrid grid = getLightGrid(cluster);\nuint numLights = grid.ccLights;\nfor (uint i = 0u; i < 100u; i++) {\nif (i >= numLights) break;\nuint lightIndex = getGridLightIndex(grid.offset, i);\nCCLight light = getCCLight(lightIndex);\nvec3 SLU = light.cc_lightPos.xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.001);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = light.cc_lightSizeRangeAngle.x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = PI * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(light.cc_lightSizeRangeAngle.y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (light.cc_lightPos.w > 0.0) {\nfloat cosInner = max(dot(-light.cc_lightDir.xyz, SL), 0.01);\nfloat cosOuter = light.cc_lightSizeRangeAngle.z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -light.cc_lightDir.xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = light.cc_lightColor.rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (light.cc_lightPos.w > 0.0) {\nshadow = CCSpotShadowFactorBase(shadowPos, position, s.shadowBias);\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * light.cc_lightColor.w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\nlayout(location = 0) out vec4 fragColorX;\nvoid main () {\nStandardSurface s; surf(s);\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nvec4 color = CCClusterShadingAdditive(s, v_shadowPos);\n#else\nvec4 color = CCStandardShadingAdditive(s, v_shadowPos);\n#endif\nfragColorX = CCFragOutput(color);\n}\n#elif (CC_PIPELINE_TYPE == 0 || CC_FORCE_FORWARD_SHADING)\nlayout(location = 0) out vec4 fragColorX;\nvoid main () {\nStandardSurface s; surf(s);\nvec4 color = CCStandardShadingBase(s, v_shadowPos);\nCC_APPLY_FOG(color, s.position.xyz);\nfragColorX = CCFragOutput(color);\n}\n#elif CC_PIPELINE_TYPE == 1\nvec2 signNotZero(vec2 v) {\nreturn vec2((v.x >= 0.0) ? +1.0 : -1.0, (v.y >= 0.0) ? +1.0 : -1.0);\n}\nvec2 float32x3_to_oct(in vec3 v) {\nvec2 p = v.xy * (1.0 / (abs(v.x) + abs(v.y) + abs(v.z)));\nreturn (v.z <= 0.0) ? ((1.0 - abs(p.yx)) * signNotZero(p)) : p;\n}\nlayout(location = 0) out vec4 fragColor0;\nlayout(location = 1) out vec4 fragColor1;\nlayout(location = 2) out vec4 fragColor2;\nvoid main () {\nStandardSurface s; surf(s);\nfragColor0 = s.albedo;\nfragColor1 = vec4(float32x3_to_oct(s.normal), s.roughness, s.metallic);\nfragColor2 = vec4(s.emissive, s.occlusion);\n}\n#endif"},{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\nhighp vec4 cc_localShadowBias;\n};\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nout vec2 v_clip_depth;\nvec4 vert () {\nvec4 worldPos;\nworldPos.x = cc_matWorld[3][0] + a_position.x;\nworldPos.y = cc_matWorld[3][1] + a_position.y;\nworldPos.z = cc_matWorld[3][2] + a_position.z;\nworldPos.w = 1.0;\nvec4 clipPos = cc_matLightViewProj * worldPos;\nv_clip_depth = clipPos.zw;\nreturn clipPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 packDepthToRGBA (float depth) {\nvec4 ret = vec4(1.0, 255.0, 65025.0, 16581375.0) * depth;\nret = fract(ret);\nret -= vec4(ret.yzw, 0.0) / 255.0;\nreturn ret;\n}\nin vec2 v_clip_depth;\nvec4 frag () {\nreturn packDepthToRGBA(v_clip_depth.x / v_clip_depth.y * 0.5 + 0.5);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#endif\n#if USE_INSTANCING\n#if CC_USE_BAKED_ANIMATION\nin highp vec4 a_jointAnimInfo;\n#endif\nin vec4 a_matWorld0;\nin vec4 a_matWorld1;\nin vec4 a_matWorld2;\n#if CC_USE_LIGHTMAP\nin vec4 a_lightingMapUVParam;\n#endif\n#if CC_RECEIVE_SHADOW\nin vec2 a_localShadowBias;\n#endif\n#elif USE_BATCHING\nin float a_dyn_batch_id;\n#endif\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\n#endif\n#if CC_USE_MORPH\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nnormal.xyz = normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\ntangent.xyz = tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\n#if CC_USE_BAKED_ANIMATION\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\nvoid CCGetJointTextureCoords(float pixelsPerJoint, float jointIdx, out highp float x, out highp float y, out highp float invSize)\n{\n#if USE_INSTANCING\nhighp float temp = pixelsPerJoint * (a_jointAnimInfo.x * a_jointAnimInfo.y + jointIdx) + a_jointAnimInfo.z;\n#else\nhighp float temp = pixelsPerJoint * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + jointIdx) + cc_jointTextureInfo.z;\n#endif\ninvSize = cc_jointTextureInfo.w;\nhighp float tempY = floor(temp * invSize);\nx = floor(temp - tempY * cc_jointTextureInfo.x);\ny = (tempY + 0.5) * invSize;\n}\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(3.0, i, x, y, invSize);\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(12.0, i, x, y, invSize);\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nmat4 m = skinMatrix();\nposition = m * position;\nnormal = (m * vec4(normal, 0.0)).xyz;\ntangent.xyz = (m * vec4(tangent.xyz, 0.0)).xyz;\n}\n#endif\nvoid CCVertInput(inout vec4 In)\n{\nIn = vec4(a_position, 1.0);\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\n}\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\n#if !USE_INSTANCING\n#if USE_BATCHING\nlayout(std140) uniform CCLocalBatched {\nhighp mat4 cc_matWorlds[10];\n};\n#else\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\nhighp vec4 cc_localShadowBias;\n};\n#endif\n#endif\nvoid CCGetWorldMatrix(out mat4 matWorld)\n{\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\n#else\nmatWorld = cc_matWorld;\n#endif\n}\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\n#if !CC_USE_ACCURATE_FOG\nout float v_fog_factor;\n#endif\nvoid CC_TRANSFER_FOG(vec4 pos) {\n#if !CC_USE_ACCURATE_FOG\nCC_TRANSFER_FOG_BASE(pos, v_fog_factor);\n#endif\n}\n#if USE_VERTEX_COLOR\nin lowp vec4 a_color;\nout lowp vec4 v_color;\n#endif\n#if USE_TEXTURE\nout vec2 v_uv;\nlayout(std140) uniform TexCoords {\nvec4 tilingOffset;\n};\n#endif\nvec4 vert () {\nvec4 position;\nCCVertInput(position);\nmat4 matWorld;\nCCGetWorldMatrix(matWorld);\n#if USE_TEXTURE\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv = cc_cameraPos.w > 1.0 ? vec2(v_uv.x, 1.0 - v_uv.y) : v_uv;\n#endif\n#endif\n#if USE_VERTEX_COLOR\nv_color = a_color;\n#endif\nCC_TRANSFER_FOG(matWorld * position);\nreturn cc_matProj * (cc_matView * matWorld) * position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\nvoid CC_APPLY_FOG_BASE(inout vec4 color, float factor) {\ncolor = vec4(mix(cc_fogColor.rgb, color.rgb, factor), color.a);\n}\n#if !CC_USE_ACCURATE_FOG\nin float v_fog_factor;\n#endif\nvoid CC_APPLY_FOG(inout vec4 color) {\n#if !CC_USE_ACCURATE_FOG\nCC_APPLY_FOG_BASE(color, v_fog_factor);\n#endif\n}\nvoid CC_APPLY_FOG(inout vec4 color, vec3 worldPos) {\n#if CC_USE_ACCURATE_FOG\nfloat factor;\nCC_TRANSFER_FOG_BASE(vec4(worldPos, 1.0), factor);\n#else\nfloat factor = v_fog_factor;\n#endif\nCC_APPLY_FOG_BASE(color, factor);\n}\n#if USE_ALPHA_TEST\n#endif\n#if USE_TEXTURE\nin vec2 v_uv;\nuniform sampler2D mainTexture;\n#endif\nlayout(std140) uniform Constant {\nvec4 mainColor;\nvec4 colorScaleAndCutoff;\n};\n#if USE_VERTEX_COLOR\nin lowp vec4 v_color;\n#endif\nvec4 frag () {\nvec4 o = mainColor;\no.rgb *= colorScaleAndCutoff.xyz;\n#if USE_VERTEX_COLOR\no.rgb *= SRGBToLinear(v_color.rgb);\no.a *= v_color.a;\n#endif\n#if USE_TEXTURE\nvec4 texColor = texture(mainTexture, v_uv);\ntexColor.rgb = SRGBToLinear(texColor.rgb);\no *= texColor;\n#endif\n#if USE_ALPHA_TEST\nif (o.ALPHA_TEST_CHANNEL < colorScaleAndCutoff.w) discard;\n#endif\nCC_APPLY_FOG(o);\nreturn CCFragOutput(o);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#endif\n#if USE_INSTANCING\n#if CC_USE_BAKED_ANIMATION\nin highp vec4 a_jointAnimInfo;\n#endif\nin vec4 a_matWorld0;\nin vec4 a_matWorld1;\nin vec4 a_matWorld2;\n#if CC_USE_LIGHTMAP\nin vec4 a_lightingMapUVParam;\n#endif\n#if CC_RECEIVE_SHADOW\nin vec2 a_localShadowBias;\n#endif\n#elif USE_BATCHING\nin float a_dyn_batch_id;\n#endif\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\n#endif\n#if CC_USE_MORPH\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nnormal.xyz = normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\ntangent.xyz = tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\n#if CC_USE_BAKED_ANIMATION\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\nvoid CCGetJointTextureCoords(float pixelsPerJoint, float jointIdx, out highp float x, out highp float y, out highp float invSize)\n{\n#if USE_INSTANCING\nhighp float temp = pixelsPerJoint * (a_jointAnimInfo.x * a_jointAnimInfo.y + jointIdx) + a_jointAnimInfo.z;\n#else\nhighp float temp = pixelsPerJoint * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + jointIdx) + cc_jointTextureInfo.z;\n#endif\ninvSize = cc_jointTextureInfo.w;\nhighp float tempY = floor(temp * invSize);\nx = floor(temp - tempY * cc_jointTextureInfo.x);\ny = (tempY + 0.5) * invSize;\n}\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(3.0, i, x, y, invSize);\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(12.0, i, x, y, invSize);\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nmat4 m = skinMatrix();\nposition = m * position;\nnormal = (m * vec4(normal, 0.0)).xyz;\ntangent.xyz = (m * vec4(tangent.xyz, 0.0)).xyz;\n}\n#endif\nvoid CCVertInput(inout StandardVertInput In)\n{\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In.position, In.normal, In.tangent);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In.position, In.normal, In.tangent);\n#endif\n}\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nout vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nCCVertInput(In);\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nin vec2 v_uv;\nlayout(std140) uniform BloomUBO {\nmediump vec4 texSize;\n};\nuniform sampler2D outputResultMap;\nlayout(location = 0) out vec4 fragColor;\nfloat luminance(vec3 color) {\nreturn dot(color, vec3(0.2126, 0.7152, 0.0722));\n}\nvoid main() {\nvec3 color = texture(outputResultMap, v_uv).xyz;\nif (luminance(SRGBToLinear(color)) > texSize.z) {\nfragColor = vec4(color, 1.0);\n} else {\nfragColor = vec4(0.0, 0.0, 0.0, 1.0);\n}\n}"},{vert:"\nprecision highp float;\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#endif\n#if USE_INSTANCING\n#if CC_USE_BAKED_ANIMATION\nin highp vec4 a_jointAnimInfo;\n#endif\nin vec4 a_matWorld0;\nin vec4 a_matWorld1;\nin vec4 a_matWorld2;\n#if CC_USE_LIGHTMAP\nin vec4 a_lightingMapUVParam;\n#endif\n#if CC_RECEIVE_SHADOW\nin vec2 a_localShadowBias;\n#endif\n#elif USE_BATCHING\nin float a_dyn_batch_id;\n#endif\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\n#endif\n#if CC_USE_MORPH\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nnormal.xyz = normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\ntangent.xyz = tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\n#if CC_USE_BAKED_ANIMATION\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\nvoid CCGetJointTextureCoords(float pixelsPerJoint, float jointIdx, out highp float x, out highp float y, out highp float invSize)\n{\n#if USE_INSTANCING\nhighp float temp = pixelsPerJoint * (a_jointAnimInfo.x * a_jointAnimInfo.y + jointIdx) + a_jointAnimInfo.z;\n#else\nhighp float temp = pixelsPerJoint * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + jointIdx) + cc_jointTextureInfo.z;\n#endif\ninvSize = cc_jointTextureInfo.w;\nhighp float tempY = floor(temp * invSize);\nx = floor(temp - tempY * cc_jointTextureInfo.x);\ny = (tempY + 0.5) * invSize;\n}\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(3.0, i, x, y, invSize);\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(12.0, i, x, y, invSize);\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nmat4 m = skinMatrix();\nposition = m * position;\nnormal = (m * vec4(normal, 0.0)).xyz;\ntangent.xyz = (m * vec4(tangent.xyz, 0.0)).xyz;\n}\n#endif\nvoid CCVertInput(inout StandardVertInput In)\n{\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In.position, In.normal, In.tangent);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In.position, In.normal, In.tangent);\n#endif\n}\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nout vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nCCVertInput(In);\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nin vec2 v_uv;\nlayout(std140) uniform BloomUBO {\nmediump vec4 texSize;\n};\nuniform sampler2D bloomTexture;\nlayout(location = 0) out vec4 fragColor;\nvec3 downsample4taps(vec2 uv, vec2 halfpixel) {\nvec3 sum = texture(bloomTexture, uv + vec2(-halfpixel.x, halfpixel.y)).xyz;\nsum += texture(bloomTexture, uv + vec2(halfpixel.x, halfpixel.y)).xyz;\nsum += texture(bloomTexture, uv + vec2(halfpixel.x, -halfpixel.y)).xyz;\nsum += texture(bloomTexture, uv + vec2(-halfpixel.x, -halfpixel.y)).xyz;\nreturn sum / 4.0;\n}\nvoid main()\n{\nvec3 result = downsample4taps(v_uv, 1.0 / texSize.xy).rgb;\nfragColor = vec4(result, 1.0);\n}"},{vert:"\nprecision highp float;\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#endif\n#if USE_INSTANCING\n#if CC_USE_BAKED_ANIMATION\nin highp vec4 a_jointAnimInfo;\n#endif\nin vec4 a_matWorld0;\nin vec4 a_matWorld1;\nin vec4 a_matWorld2;\n#if CC_USE_LIGHTMAP\nin vec4 a_lightingMapUVParam;\n#endif\n#if CC_RECEIVE_SHADOW\nin vec2 a_localShadowBias;\n#endif\n#elif USE_BATCHING\nin float a_dyn_batch_id;\n#endif\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\n#endif\n#if CC_USE_MORPH\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nnormal.xyz = normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\ntangent.xyz = tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\n#if CC_USE_BAKED_ANIMATION\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\nvoid CCGetJointTextureCoords(float pixelsPerJoint, float jointIdx, out highp float x, out highp float y, out highp float invSize)\n{\n#if USE_INSTANCING\nhighp float temp = pixelsPerJoint * (a_jointAnimInfo.x * a_jointAnimInfo.y + jointIdx) + a_jointAnimInfo.z;\n#else\nhighp float temp = pixelsPerJoint * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + jointIdx) + cc_jointTextureInfo.z;\n#endif\ninvSize = cc_jointTextureInfo.w;\nhighp float tempY = floor(temp * invSize);\nx = floor(temp - tempY * cc_jointTextureInfo.x);\ny = (tempY + 0.5) * invSize;\n}\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(3.0, i, x, y, invSize);\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(12.0, i, x, y, invSize);\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nmat4 m = skinMatrix();\nposition = m * position;\nnormal = (m * vec4(normal, 0.0)).xyz;\ntangent.xyz = (m * vec4(tangent.xyz, 0.0)).xyz;\n}\n#endif\nvoid CCVertInput(inout StandardVertInput In)\n{\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In.position, In.normal, In.tangent);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In.position, In.normal, In.tangent);\n#endif\n}\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nout vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nCCVertInput(In);\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nin vec2 v_uv;\nlayout(std140) uniform BloomUBO {\nmediump vec4 texSize;\n};\nuniform sampler2D bloomTexture;\nlayout(location = 0) out vec4 fragColor;\nvec3 upsample4taps(vec2 uv, vec2 halfpixel) {\nvec3 sum = texture(bloomTexture, uv + vec2(-halfpixel.x, halfpixel.y)).xyz;\nsum += texture(bloomTexture, uv + vec2(halfpixel.x, halfpixel.y)).xyz;\nsum += texture(bloomTexture, uv + vec2(halfpixel.x, -halfpixel.y)).xyz;\nsum += texture(bloomTexture, uv + vec2(-halfpixel.x, -halfpixel.y)).xyz;\nreturn sum / 4.0;\n}\nvoid main() {\nvec3 result = upsample4taps(v_uv, 0.5 / texSize.xy).rgb;\nfragColor = vec4(result, 1.0);\n}"},{vert:"\nprecision highp float;\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#endif\n#if USE_INSTANCING\n#if CC_USE_BAKED_ANIMATION\nin highp vec4 a_jointAnimInfo;\n#endif\nin vec4 a_matWorld0;\nin vec4 a_matWorld1;\nin vec4 a_matWorld2;\n#if CC_USE_LIGHTMAP\nin vec4 a_lightingMapUVParam;\n#endif\n#if CC_RECEIVE_SHADOW\nin vec2 a_localShadowBias;\n#endif\n#elif USE_BATCHING\nin float a_dyn_batch_id;\n#endif\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\n#endif\n#if CC_USE_MORPH\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nnormal.xyz = normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\ntangent.xyz = tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\n#if CC_USE_BAKED_ANIMATION\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\nvoid CCGetJointTextureCoords(float pixelsPerJoint, float jointIdx, out highp float x, out highp float y, out highp float invSize)\n{\n#if USE_INSTANCING\nhighp float temp = pixelsPerJoint * (a_jointAnimInfo.x * a_jointAnimInfo.y + jointIdx) + a_jointAnimInfo.z;\n#else\nhighp float temp = pixelsPerJoint * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + jointIdx) + cc_jointTextureInfo.z;\n#endif\ninvSize = cc_jointTextureInfo.w;\nhighp float tempY = floor(temp * invSize);\nx = floor(temp - tempY * cc_jointTextureInfo.x);\ny = (tempY + 0.5) * invSize;\n}\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(3.0, i, x, y, invSize);\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(12.0, i, x, y, invSize);\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nmat4 m = skinMatrix();\nposition = m * position;\nnormal = (m * vec4(normal, 0.0)).xyz;\ntangent.xyz = (m * vec4(tangent.xyz, 0.0)).xyz;\n}\n#endif\nvoid CCVertInput(inout StandardVertInput In)\n{\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In.position, In.normal, In.tangent);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In.position, In.normal, In.tangent);\n#endif\n}\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nout vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nCCVertInput(In);\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nin vec2 v_uv;\nlayout(std140) uniform BloomUBO {\nmediump vec4 texSize;\n};\nuniform sampler2D outputResultMap;\nuniform sampler2D bloomTexture;\nlayout(location = 0) out vec4 fragColor;\nvoid main() {\nvec4 hdrColor = texture(outputResultMap, v_uv);\nvec3 bloomColor = texture(bloomTexture, v_uv).rgb;\nvec3 result = hdrColor.rgb + bloomColor * texSize.w * hdrColor.a;\nfragColor = vec4(result, hdrColor.a);\n}"}],[{vert:"\nprecision highp float;\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#endif\n#if USE_INSTANCING\n#if CC_USE_BAKED_ANIMATION\nin highp vec4 a_jointAnimInfo;\n#endif\nin vec4 a_matWorld0;\nin vec4 a_matWorld1;\nin vec4 a_matWorld2;\n#if CC_USE_LIGHTMAP\nin vec4 a_lightingMapUVParam;\n#endif\n#if CC_RECEIVE_SHADOW\nin vec2 a_localShadowBias;\n#endif\n#elif USE_BATCHING\nin float a_dyn_batch_id;\n#endif\n#if CC_USE_MORPH\nin float a_vertexId;\n#endif\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nout vec2 v_uv;\nvoid main () {\nvec4 position;\nposition = vec4(a_position, 1.0);\nposition.xy = cc_cameraPos.w == 0.0 ? vec2(position.xy.x, -position.xy.y) : position.xy;\ngl_Position = vec4(position.x, position.y, 1.0, 1.0);\nv_uv = a_texCoord;\n}",frag:"\n#ifdef GL_EXT_shader_framebuffer_fetch\n#extension GL_EXT_shader_framebuffer_fetch: enable\n#endif\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\nhighp float unpackHighpData (float mainPart, float modPart) {\nhighp float data = mainPart;\nreturn data + modPart;\n}\nhighp float unpackHighpData (float mainPart, float modPart, const float modValue) {\nhighp float data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart) {\nhighp vec2 data = mainPart;\nreturn data + modPart;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart, const float modValue) {\nhighp vec2 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart) {\nhighp vec3 data = mainPart;\nreturn data + modPart;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart, const float modValue) {\nhighp vec3 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart) {\nhighp vec4 data = mainPart;\nreturn data + modPart;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart, const float modValue) {\nhighp vec4 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\nhighp vec4 cc_localShadowBias;\n};\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\nvec4 ApplyShadowDepthBias_FaceNormal(vec4 shadowPos, vec3 worldNormal, float normalBias)\n{\nvec4 newShadowPos = shadowPos;\nif(normalBias > EPSILON_LOWP)\n{\nvec4 viewNormal = cc_matLightView * vec4(worldNormal, 0.0);\nif(viewNormal.z < 0.1)\nnewShadowPos.xy += viewNormal.xy * cc_shadowProjInfo.xy * normalBias * clamp(viewNormal.z, 0.001, 0.1);\n}\nreturn newShadowPos;\n}\nvec4 ApplyShadowDepthBias_Perspective(vec4 shadowPos, float viewspaceDepthBias)\n{\nvec3 viewSpacePos;\nviewSpacePos.xy = shadowPos.xy * cc_shadowProjInfo.zw;\nviewSpacePos.z = shadowPos.z * cc_shadowInvProjDepthInfo.x + shadowPos.w * cc_shadowInvProjDepthInfo.y;\nviewSpacePos.xyz += cc_shadowProjDepthInfo.z * normalize(viewSpacePos.xyz) * viewspaceDepthBias;\nvec4 clipSpacePos;\nclipSpacePos.xy = viewSpacePos.xy * cc_shadowProjInfo.xy;\nclipSpacePos.zw = viewSpacePos.z * cc_shadowProjDepthInfo.xz + vec2(cc_shadowProjDepthInfo.y, 0.0);\nif (cc_shadowNFLSInfo.z > EPSILON) {\nclipSpacePos.z = CCGetLinearDepthFromViewSpace(viewSpacePos.xyz);\nclipSpacePos.z = (clipSpacePos.z * 2.0 - 1.0) * clipSpacePos.w;\n}\nreturn clipSpacePos;\n}\nvec4 ApplyShadowDepthBias_Orthographic(vec4 shadowPos, float viewspaceDepthBias)\n{\nfloat coeffA = cc_shadowProjDepthInfo.x;\nfloat coeffB = cc_shadowProjDepthInfo.y;\nfloat viewSpacePos_z = (shadowPos.z - coeffB) / coeffA;\nviewSpacePos_z += viewspaceDepthBias;\nvec4 result = shadowPos;\nresult.z = viewSpacePos_z * coeffA + coeffB;\nreturn result;\n}\nfloat CCGetShadowFactorHard (vec4 shadowPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nclosestDepth = dot(texture(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(clipPos.z, closestDepth);\nreturn shadow;\n}\nfloat CCGetShadowFactorSoft (vec4 shadowPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nblock0 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * mapSize.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetShadowFactorSoft2X (vec4 shadowPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nblock0 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCGetSpotLightShadowFactorHard (vec4 shadowPos, vec3 worldPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = clipPos.z;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nclosestDepth = dot(texture(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(depth, closestDepth);\nreturn shadow;\n}\nfloat CCGetSpotLightShadowFactorSoft (vec4 shadowPos, vec3 worldPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > EPSILON) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nvec2 oneTap = 1.0 / cc_shadowWHPBInfo.xy;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nblock0 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * cc_shadowWHPBInfo.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * cc_shadowWHPBInfo.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetSpotLightShadowFactorSoft2X (vec4 shadowPos, vec3 worldPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > EPSILON) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nblock0 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCSpotShadowFactorBase(vec4 shadowPos, vec3 worldPos, vec2 shadowBias)\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) {\nreturn CCGetSpotLightShadowFactorSoft2X(shadowPos, worldPos, shadowBias.x);\n}else if (pcf > 0.9) {\nreturn CCGetSpotLightShadowFactorSoft(shadowPos, worldPos, shadowBias.x);\n}else {\nreturn CCGetSpotLightShadowFactorHard(shadowPos, worldPos, shadowBias.x);\n}\n}\nfloat CCShadowFactorBase(vec4 shadowPos, vec3 N, vec2 shadowBias)\n{\nfloat realtimeShadow = 1.0;\nvec4 pos = ApplyShadowDepthBias_FaceNormal(shadowPos, N, shadowBias.y);\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) {\nrealtimeShadow =  CCGetShadowFactorSoft2X(pos, shadowBias.x);\n}else if (pcf > 0.9) {\nrealtimeShadow = CCGetShadowFactorSoft(pos, shadowBias.x);\n}else {\nrealtimeShadow = CCGetShadowFactorHard(pos, shadowBias.x);\n}\nreturn mix(realtimeShadow, 1.0, cc_shadowNFLSInfo.w);\n}\n#endif\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\n#if CC_USE_DIFFUSEMAP\nuniform samplerCube cc_diffuseMap;\n#endif\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\n#if USE_REFLECTION_DENOISE\nvec3 GetEnvReflectionWithMipFiltering(vec3 R, float roughness, float mipCount, float denoiseIntensity) {\n#if CC_USE_IBL\nfloat mip = roughness * mipCount;\nfloat delta = (dot(dFdx(R), dFdy(R))) * 1000.0;\nfloat mipBias = mix(0.0, 5.0, clamp(delta, 0.0, 1.0));\nvec4 biased = fragTextureLod(cc_environment, R, mip + mipBias);\nvec4 filtered = texture(cc_environment, R);\n#if CC_USE_IBL == 2\nbiased.rgb = unpackRGBE(biased);\nfiltered.rgb = unpackRGBE(filtered);\n#else\nbiased.rgb = SRGBToLinear(biased.rgb);\nfiltered.rgb = SRGBToLinear(filtered.rgb);\n#endif\nreturn mix(biased.rgb, filtered.rgb, denoiseIntensity);\n#else\nreturn vec3(0.0, 0.0, 0.0);\n#endif\n}\n#endif\nstruct StandardSurface {\nvec4 albedo;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nvec3 position, position_fract_part;\n#else\nvec3 position;\n#endif\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\nfloat specularIntensity;\n#if CC_RECEIVE_SHADOW\nvec2 shadowBias;\n#endif\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.08 * s.specularIntensity), s.albedo.rgb, s.metallic);\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.0);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse / PI;\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nvec3 dirlightContrib = (diffuseContrib + specularContrib);\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (NL > 0.0 && cc_mainLitDir.w > 0.0) {\nshadow = CCShadowFactorBase(shadowPos, N, s.shadowBias);\n}\n#endif\ndirlightContrib *= shadow;\nfinalColor *= dirlightContrib;\n#if CC_USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > EPSILON_LOWP) {\nfinalColor = diffuse * s.lightmap.rgb * shadow;\n}\n#endif\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb);\n#if CC_USE_IBL\n#if CC_USE_DIFFUSEMAP\nvec4 diffuseMap = texture(cc_diffuseMap, N);\n#if CC_USE_DIFFUSEMAP == 2\nambDiff = unpackRGBE(diffuseMap);\n#else\nambDiff = SRGBToLinear(diffuseMap.rgb);\n#endif\n#endif\nvec3 R = normalize(reflect(-V, N));\n#if USE_REFLECTION_DENOISE\nvec3 env = GetEnvReflectionWithMipFiltering(R, s.roughness, cc_ambientGround.w, 0.6);\n#else\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\n#endif\nfinalColor += env * cc_ambientSky.w * specular * s.occlusion;\n#endif\nfinalColor += ambDiff.rgb * cc_ambientSky.w * diffuse * s.occlusion;\nfinalColor += s.emissive;\nreturn vec4(finalColor, s.albedo.a);\n}\n#if CC_PIPELINE_TYPE == 0\n#define LIGHTS_PER_PASS 1\n#else\n#define LIGHTS_PER_PASS 10\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nlayout(std140) uniform CCForwardLight {\nhighp vec4 cc_lightPos[LIGHTS_PER_PASS];\nvec4 cc_lightColor[LIGHTS_PER_PASS];\nvec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nvec4 cc_lightDir[LIGHTS_PER_PASS];\n};\n#endif\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / PI;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.0);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = litRadiusSqr / max(litRadiusSqr, distSqr);\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0 && cc_lightSizeRangeAngle[i].w > 0.0) {\nshadow = CCSpotShadowFactorBase(shadowPos, position, s.shadowBias);\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nlayout(std430, binding = 4) readonly buffer b_ccLightsBuffer { vec4 b_ccLights[]; };\nlayout(std430, binding = 5) readonly buffer b_clusterLightIndicesBuffer { uint b_clusterLightIndices[]; };\nlayout(std430, binding = 6) readonly buffer b_clusterLightGridBuffer { uvec4 b_clusterLightGrid[]; };\nstruct CCLight\n{\nvec4 cc_lightPos;\nvec4 cc_lightColor;\nvec4 cc_lightSizeRangeAngle;\nvec4 cc_lightDir;\n};\nstruct Cluster\n{\nvec3 minBounds;\nvec3 maxBounds;\n};\nstruct LightGrid\n{\nuint offset;\nuint ccLights;\n};\nCCLight getCCLight(uint i)\n{\nCCLight light;\nlight.cc_lightPos = b_ccLights[4u * i + 0u];\nlight.cc_lightColor = b_ccLights[4u * i + 1u];\nlight.cc_lightSizeRangeAngle = b_ccLights[4u * i + 2u];\nlight.cc_lightDir = b_ccLights[4u * i + 3u];\nreturn light;\n}\nLightGrid getLightGrid(uint cluster)\n{\nuvec4 gridvec = b_clusterLightGrid[cluster];\nLightGrid grid;\ngrid.offset = gridvec.x;\ngrid.ccLights = gridvec.y;\nreturn grid;\n}\nuint getGridLightIndex(uint start, uint offset)\n{\nreturn b_clusterLightIndices[start + offset];\n}\nuint getClusterZIndex(vec4 worldPos)\n{\nfloat scale = float(24) / log(cc_nearFar.y / cc_nearFar.x);\nfloat bias = -(float(24) * log(cc_nearFar.x) / log(cc_nearFar.y / cc_nearFar.x));\nfloat eyeDepth = -(cc_matView * worldPos).z;\nuint zIndex = uint(max(log(eyeDepth) * scale + bias, 0.0));\nreturn zIndex;\n}\nuint getClusterIndex(vec4 fragCoord, vec4 worldPos)\n{\nuint zIndex = getClusterZIndex(worldPos);\nfloat clusterSizeX = ceil(cc_viewPort.z / float(16));\nfloat clusterSizeY = ceil(cc_viewPort.w / float(8));\nuvec3 indices = uvec3(uvec2(fragCoord.xy / vec2(clusterSizeX, clusterSizeY)), zIndex);\nuint cluster = (16u * 8u) * indices.z + 16u * indices.y + indices.x;\nreturn cluster;\n}\nvec4 CCClusterShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / PI;\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nuint cluster = getClusterIndex(gl_FragCoord, vec4(position, 1.0));\nLightGrid grid = getLightGrid(cluster);\nuint numLights = grid.ccLights;\nfor (uint i = 0u; i < 100u; i++) {\nif (i >= numLights) break;\nuint lightIndex = getGridLightIndex(grid.offset, i);\nCCLight light = getCCLight(lightIndex);\nvec3 SLU = light.cc_lightPos.xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.001);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = light.cc_lightSizeRangeAngle.x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = PI * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(light.cc_lightSizeRangeAngle.y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (light.cc_lightPos.w > 0.0) {\nfloat cosInner = max(dot(-light.cc_lightDir.xyz, SL), 0.01);\nfloat cosOuter = light.cc_lightSizeRangeAngle.z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -light.cc_lightDir.xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = light.cc_lightColor.rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (light.cc_lightPos.w > 0.0) {\nshadow = CCSpotShadowFactorBase(shadowPos, position, s.shadowBias);\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * light.cc_lightColor.w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\nvoid CC_APPLY_FOG_BASE(inout vec4 color, float factor) {\ncolor = vec4(mix(cc_fogColor.rgb, color.rgb, factor), color.a);\n}\nvec2 signNotZero(vec2 v) {\nreturn vec2((v.x >= 0.0) ? +1.0 : -1.0, (v.y >= 0.0) ? +1.0 : -1.0);\n}\nvec3 oct_to_float32x3(vec2 e) {\nvec3 v = vec3(e.xy, 1.0 - abs(e.x) - abs(e.y));\nif (v.z < 0.0) v.xy = (1.0 - abs(v.yx)) * signNotZero(v.xy);\nreturn normalize(v);\n}\nvec4 screen2WS(vec3 coord) {\nvec3 ndc = vec3(\n2.0 * (coord.x - cc_viewPort.x) / cc_viewPort.z - 1.0,\n2.0 * (coord.y - cc_viewPort.y) / cc_viewPort.w - 1.0,\n2.0 * coord.z - 1.0);\nvec4 world = ((cc_matViewProjInv) * (vec4(ndc, 1.0)));\nworld      = world / world.w;\nreturn world;\n}\nin vec2 v_uv;\n#if CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT\nlayout(location = 0) inout vec4 gbuffer_albedoMap;\nlayout(location = 1) inout vec4 gbuffer_normalMap;\nlayout(location = 2) inout vec4 gbuffer_emissiveMap;\nuniform sampler2D depth_stencil;\n#else\nuniform sampler2D gbuffer_albedoMap;\nuniform sampler2D gbuffer_normalMap;\nuniform sampler2D gbuffer_emissiveMap;\nuniform sampler2D depth_stencil;\n#endif\n#if !CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT || __VERSION__ >= 450\nlayout(location = 0) out vec4 fragColor;\n#endif\nvoid main () {\nStandardSurface s;\n#if CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT\nvec4 albedoMap = gbuffer_albedoMap;\nvec4 normalMap = gbuffer_normalMap;\nvec4 emissiveMap = gbuffer_emissiveMap;\nfloat depth = texture(depth_stencil, v_uv).x;\n#else\nvec4 albedoMap = texture(gbuffer_albedoMap,v_uv);\nvec4 normalMap = texture(gbuffer_normalMap,v_uv);\nvec4 emissiveMap = texture(gbuffer_emissiveMap,v_uv);\nfloat depth = texture(depth_stencil, v_uv).x;\n#endif\ns.albedo = albedoMap;\nvec3 position = screen2WS(vec3(gl_FragCoord.xy, depth)).xyz;\ns.position = position;\ns.roughness = normalMap.z;\ns.normal = oct_to_float32x3(normalMap.xy);\ns.specularIntensity = 0.5;\ns.metallic = normalMap.w;\ns.emissive = emissiveMap.xyz;\ns.occlusion = emissiveMap.w;\nfloat fogFactor;\nCC_TRANSFER_FOG_BASE(vec4(position, 1), fogFactor);\nvec4 shadowPos;\nshadowPos = cc_matLightViewProj * vec4(position, 1);\nvec4 color = CCStandardShadingBase(s, shadowPos) +\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nCCClusterShadingAdditive(s, shadowPos);\n#else\nCCStandardShadingAdditive(s, shadowPos);\n#endif\nCC_APPLY_FOG_BASE(color, fogFactor);\ncolor = CCFragOutput(color);\n#if CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT\ngbuffer_emissiveMap = color;\n#else\nfragColor = color;\n#endif\n}"}],[{vert:"\nprecision highp float;\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#endif\n#if USE_INSTANCING\n#if CC_USE_BAKED_ANIMATION\nin highp vec4 a_jointAnimInfo;\n#endif\nin vec4 a_matWorld0;\nin vec4 a_matWorld1;\nin vec4 a_matWorld2;\n#if CC_USE_LIGHTMAP\nin vec4 a_lightingMapUVParam;\n#endif\n#if CC_RECEIVE_SHADOW\nin vec2 a_localShadowBias;\n#endif\n#elif USE_BATCHING\nin float a_dyn_batch_id;\n#endif\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\n#endif\n#if CC_USE_MORPH\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nnormal.xyz = normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\ntangent.xyz = tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\n#if CC_USE_BAKED_ANIMATION\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\nvoid CCGetJointTextureCoords(float pixelsPerJoint, float jointIdx, out highp float x, out highp float y, out highp float invSize)\n{\n#if USE_INSTANCING\nhighp float temp = pixelsPerJoint * (a_jointAnimInfo.x * a_jointAnimInfo.y + jointIdx) + a_jointAnimInfo.z;\n#else\nhighp float temp = pixelsPerJoint * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + jointIdx) + cc_jointTextureInfo.z;\n#endif\ninvSize = cc_jointTextureInfo.w;\nhighp float tempY = floor(temp * invSize);\nx = floor(temp - tempY * cc_jointTextureInfo.x);\ny = (tempY + 0.5) * invSize;\n}\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(3.0, i, x, y, invSize);\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(12.0, i, x, y, invSize);\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nmat4 m = skinMatrix();\nposition = m * position;\nnormal = (m * vec4(normal, 0.0)).xyz;\ntangent.xyz = (m * vec4(tangent.xyz, 0.0)).xyz;\n}\n#endif\nvoid CCVertInput(inout vec4 In)\n{\nIn = vec4(a_position, 1.0);\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\n}\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\n#if !USE_INSTANCING\n#if USE_BATCHING\nlayout(std140) uniform CCLocalBatched {\nhighp mat4 cc_matWorlds[10];\n};\n#else\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\nhighp vec4 cc_localShadowBias;\n};\n#endif\n#endif\nvoid CCGetWorldMatrix(out mat4 matWorld)\n{\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\n#else\nmatWorld = cc_matWorld;\n#endif\n}\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\nout float v_dist;\nvec4 vert () {\nvec4 position;\nCCVertInput(position);\nmat4 matWorld;\nCCGetWorldMatrix(matWorld);\nvec3 P = (matWorld * position).xyz;\nvec3 L = cc_mainLitDir.xyz;\nvec3 N = cc_planarNDInfo.xyz;\nfloat d = cc_planarNDInfo.w + 0.001;\nfloat dist = (-d - dot(P, N)) / (dot(L, N) + 0.0001);\nvec3 shadowPos = P + L * dist;\nvec3 view = normalize(cc_cameraPos.xyz - shadowPos);\nfloat viewLength = length(cc_cameraPos.xyz - shadowPos);\nshadowPos += view * min(1.0, 0.005 * viewLength);\nposition = cc_matProj * cc_matView * vec4(shadowPos, 1.0);\nv_dist = dist;\nreturn position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nin float v_dist;\nvec4 frag () {\nif(v_dist < 0.0)\ndiscard;\nreturn CCFragOutput(cc_shadowColor);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#endif\n#if USE_INSTANCING\n#if CC_USE_BAKED_ANIMATION\nin highp vec4 a_jointAnimInfo;\n#endif\nin vec4 a_matWorld0;\nin vec4 a_matWorld1;\nin vec4 a_matWorld2;\n#if CC_USE_LIGHTMAP\nin vec4 a_lightingMapUVParam;\n#endif\n#if CC_RECEIVE_SHADOW\nin vec2 a_localShadowBias;\n#endif\n#elif USE_BATCHING\nin float a_dyn_batch_id;\n#endif\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\n#endif\n#if CC_USE_MORPH\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nnormal.xyz = normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\ntangent.xyz = tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\n#if CC_USE_BAKED_ANIMATION\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\nvoid CCGetJointTextureCoords(float pixelsPerJoint, float jointIdx, out highp float x, out highp float y, out highp float invSize)\n{\n#if USE_INSTANCING\nhighp float temp = pixelsPerJoint * (a_jointAnimInfo.x * a_jointAnimInfo.y + jointIdx) + a_jointAnimInfo.z;\n#else\nhighp float temp = pixelsPerJoint * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + jointIdx) + cc_jointTextureInfo.z;\n#endif\ninvSize = cc_jointTextureInfo.w;\nhighp float tempY = floor(temp * invSize);\nx = floor(temp - tempY * cc_jointTextureInfo.x);\ny = (tempY + 0.5) * invSize;\n}\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(3.0, i, x, y, invSize);\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(12.0, i, x, y, invSize);\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nmat4 m = skinMatrix();\nposition = m * position;\nnormal = (m * vec4(normal, 0.0)).xyz;\ntangent.xyz = (m * vec4(tangent.xyz, 0.0)).xyz;\n}\n#endif\nvoid CCVertInput(inout StandardVertInput In)\n{\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In.position, In.normal, In.tangent);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In.position, In.normal, In.tangent);\n#endif\n}\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nout vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nCCVertInput(In);\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\n#if ANTIALIAS_TYPE == 1\nvec4 fxaa(sampler2D tex, vec2 fragCoord, vec2 resolution,\nvec2 v_rgbNW, vec2 v_rgbNE,\nvec2 v_rgbSW, vec2 v_rgbSE,\nvec2 v_rgbM) {\nvec4 color;\nmediump vec2 inverseVP = vec2(1.0 / resolution.x, 1.0 / resolution.y);\nvec3 rgbNW = texture(tex, v_rgbNW).xyz;\nvec3 rgbNE = texture(tex, v_rgbNE).xyz;\nvec3 rgbSW = texture(tex, v_rgbSW).xyz;\nvec3 rgbSE = texture(tex, v_rgbSE).xyz;\nvec4 texColor = texture(tex, v_rgbM);\nvec3 rgbM  = texColor.xyz;\nvec3 luma = vec3(0.299, 0.587, 0.114);\nfloat lumaNW = dot(rgbNW, luma);\nfloat lumaNE = dot(rgbNE, luma);\nfloat lumaSW = dot(rgbSW, luma);\nfloat lumaSE = dot(rgbSE, luma);\nfloat lumaM  = dot(rgbM,  luma);\nfloat lumaMin = min(lumaM, min(min(lumaNW, lumaNE), min(lumaSW, lumaSE)));\nfloat lumaMax = max(lumaM, max(max(lumaNW, lumaNE), max(lumaSW, lumaSE)));\nmediump vec2 dir;\ndir.x = -((lumaNW + lumaNE) - (lumaSW + lumaSE));\ndir.y =  ((lumaNW + lumaSW) - (lumaNE + lumaSE));\nfloat dirReduce = max((lumaNW + lumaNE + lumaSW + lumaSE) *\n(0.25 * (1.0 / 8.0)), (1.0/ 128.0));\nfloat rcpDirMin = 1.0 / (min(abs(dir.x), abs(dir.y)) + dirReduce);\ndir = min(vec2(8.0, 8.0),\nmax(vec2(-8.0, -8.0),\ndir * rcpDirMin)) * inverseVP;\nvec3 rgbA = 0.5 * (\ntexture(tex, fragCoord * inverseVP + dir * (1.0 / 3.0 - 0.5)).xyz +\ntexture(tex, fragCoord * inverseVP + dir * (2.0 / 3.0 - 0.5)).xyz);\nvec3 rgbB = rgbA * 0.5 + 0.25 * (\ntexture(tex, fragCoord * inverseVP + dir * -0.5).xyz +\ntexture(tex, fragCoord * inverseVP + dir * 0.5).xyz);\nfloat lumaB = dot(rgbB, luma);\nif ((lumaB < lumaMin) || (lumaB > lumaMax))\ncolor = vec4(rgbA, texColor.a);\nelse\ncolor = vec4(rgbB, texColor.a);\nreturn color;\n}\n#endif\nin vec2 v_uv;\nuniform sampler2D outputResultMap;\nlayout(location = 0) out vec4 fragColor;\nvoid texcoords(vec2 fragCoord, vec2 resolution,\nout vec2 v_rgbNW, out vec2 v_rgbNE,\nout vec2 v_rgbSW, out vec2 v_rgbSE,\nout vec2 v_rgbM) {\nvec2 inverseVP = 1.0 / resolution.xy;\nv_rgbNW = (fragCoord + vec2(-1.0, -1.0)) * inverseVP;\nv_rgbNE = (fragCoord + vec2(1.0, -1.0)) * inverseVP;\nv_rgbSW = (fragCoord + vec2(-1.0, 1.0)) * inverseVP;\nv_rgbSE = (fragCoord + vec2(1.0, 1.0)) * inverseVP;\nv_rgbM = vec2(fragCoord * inverseVP);\n}\nvoid main () {\nmediump vec2 v_rgbNW;\nmediump vec2 v_rgbNE;\nmediump vec2 v_rgbSW;\nmediump vec2 v_rgbSE;\nmediump vec2 v_rgbM;\n#if ANTIALIAS_TYPE == 1\nvec2 resolution = cc_screenSize.xy;\nvec2 fragCoord = v_uv * resolution;\ntexcoords(fragCoord, resolution, v_rgbNW, v_rgbNE, v_rgbSW, v_rgbSE, v_rgbM);\nfragColor = fxaa(outputResultMap, fragCoord, resolution, v_rgbNW, v_rgbNE, v_rgbSW, v_rgbSE, v_rgbM);\n#else\nfragColor = texture(outputResultMap, v_uv);\n#endif\n}"}],[{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#endif\n#if USE_INSTANCING\n#if CC_USE_BAKED_ANIMATION\nin highp vec4 a_jointAnimInfo;\n#endif\nin vec4 a_matWorld0;\nin vec4 a_matWorld1;\nin vec4 a_matWorld2;\n#if CC_USE_LIGHTMAP\nin vec4 a_lightingMapUVParam;\n#endif\n#if CC_RECEIVE_SHADOW\nin vec2 a_localShadowBias;\n#endif\n#elif USE_BATCHING\nin float a_dyn_batch_id;\n#endif\n#if CC_USE_MORPH\nin float a_vertexId;\n#endif\nout mediump vec4 viewDir;\nvec4 vert () {\nviewDir = vec4(a_position, 1.0);\nmat4 matViewRotOnly = mat4(mat3(cc_matView));\nvec4 pos = matViewRotOnly * viewDir;\nif (cc_matProj[3].w > 0.0) {\nmat4 matProj = cc_matProj;\nmatProj[0].x = 5.2;\nmatProj[1].y = 2.6;\nmatProj[2].zw = vec2(-1.0);\nmatProj[3].zw = vec2(0.0);\npos = matProj * pos;\n} else {\npos = cc_matProj * pos;\n}\npos.z = 0.99999 * pos.w;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nuniform samplerCube cc_environment;\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nin mediump vec4 viewDir;\nvec4 frag () {\n#if USE_RGBE_CUBEMAP\nvec3 c = unpackRGBE(texture(cc_environment, viewDir.xyz));\n#else\nvec3 c = SRGBToLinear(texture(cc_environment, viewDir.xyz).rgb);\n#endif\nreturn CCFragOutput(vec4(c * cc_ambientSky.w, 1.0));\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nin vec3 a_position;\nin vec4 a_color;\nout vec2 v_uv;\nlayout(std140) uniform Constants {\nvec4 offset;\n};\nlayout(std140) uniform PerFrameInfo {\nvec4 digits[8 * 10 / 4];\n};\nfloat getComponent(vec4 v, float i) {\nif (i < 1.0) { return v.x; }\nelse if (i < 2.0) { return v.y; }\nelse if (i < 3.0) { return v.z; }\nelse { return v.w; }\n}\nvec4 vert () {\nmat2 proj = mat2(cc_matProj[0].xy, cc_matProj[1].xy);\nproj /= abs(proj[1].x + proj[1].y);\nvec2 position = proj * a_position.xy + offset.xy;\nv_uv = a_color.xy;\nif (a_color.z >= 0.0) {\nfloat n = getComponent(digits[int(a_color.z)], a_color.w);\nv_uv += vec2(offset.z * n, 0.0);\n}\nreturn vec4(position, 0.0, 1.0);\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nin vec2 v_uv;\nuniform sampler2D mainTexture;\nvec4 frag () {\nreturn CCFragOutput(texture(mainTexture, v_uv));\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nin vec2 a_position;\nin vec2 a_texCoord;\nout vec2 v_uv;\nlayout(std140) uniform Constant {\nvec4 u_buffer0;\nvec4 u_buffer1;\nmat4 u_projection;\n};\nvec4 vert () {\nvec2 worldPos = a_position * u_buffer1.xy + u_buffer1.zw;\nvec2 clipSpace = worldPos / u_buffer0.xy * 2.0 - 1.0;\nvec4 screenPos = u_projection * vec4(clipSpace, 0.0, 1.0);\nv_uv = a_texCoord;\nreturn screenPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nin vec2 v_uv;\nlayout(std140) uniform Factor {\nfloat u_percent;\n};\nuniform sampler2D mainTexture;\nvec4 frag () {\nvec4 color = texture(mainTexture, v_uv);\nfloat percent = clamp(u_percent, 0.0, 1.0);\ncolor.xyz *= percent;\nreturn color;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}]]},tv=function(){function e(){this._device=null,this._resources={}}var t=e.prototype;return t.initBuiltinRes=function(e){var t=this;this._device=e;for(var n=this._resources,i=new Uint8Array(16),r=new Uint8Array(16),o=new Uint8Array(16),a=new Uint8Array(16),s=new Uint8Array(16),c=0,l=0;l<4;l++)i[c]=0,i[c+1]=0,i[c+2]=0,i[c+3]=255,r[c]=0,r[c+1]=0,r[c+2]=0,r[c+3]=0,o[c]=119,o[c+1]=119,o[c+2]=119,o[c+3]=255,a[c]=255,a[c+1]=255,a[c+2]=255,a[c+3]=255,s[c]=127,s[c+1]=127,s[c+2]=255,s[c+3]=255,c+=4;var u=new Uint8Array(1024);c=0;for(var h=0;h<256;h++)u[c]=221,u[c+1]=221,u[c+2]=221,u[c+3]=255,c+=4;c=0;for(var _=0;_<8;_++){for(var f=0;f<8;f++)u[c]=85,u[c+1]=85,u[c+2]=85,u[c+3]=255,c+=4;c+=32}c+=32;for(var d=0;d<8;d++){for(var p=0;p<8;p++)u[c]=85,u[c+1]=85,u[c+2]=85,u[c+3]=255,c+=4;c+=32}var m={width:2,height:2,_data:i,_compressed:!1,format:Xm.PixelFormat.RGBA8888},v={width:2,height:2,_data:r,_compressed:!1,format:Xm.PixelFormat.RGBA8888},g={width:2,height:2,_data:o,_compressed:!1,format:Xm.PixelFormat.RGBA8888},y={width:2,height:2,_data:a,_compressed:!1,format:Xm.PixelFormat.RGBA8888},x={width:2,height:2,_data:s,_compressed:!1,format:Xm.PixelFormat.RGBA8888},S={width:16,height:16,_data:u,_compressed:!1,format:Xm.PixelFormat.RGBA8888},E=new Cm(m),T=new Xm;T._uuid="black-texture",T.image=E,n[T._uuid]=T;var C=new Cm(v),A=new Xm;A._uuid="empty-texture",A.image=C,n[A._uuid]=A;var w=new Ym;w._uuid="black-cube-texture",w.setMipFilter(Ym.Filter.NEAREST),w.image={front:new Cm(m),back:new Cm(m),left:new Cm(m),right:new Cm(m),top:new Cm(m),bottom:new Cm(m)},n[w._uuid]=w;var I=new Cm(g),P=new Xm;P._uuid="grey-texture",P.image=I,n[P._uuid]=P;var R=new Cm(y),D=new Xm;D._uuid="white-texture",D.image=R,n[D._uuid]=D;var O=new Ym;O._uuid="white-cube-texture",O.setMipFilter(Ym.Filter.NEAREST),O.image={front:new Cm(y),back:new Cm(y),left:new Cm(y),right:new Cm(y),top:new Cm(y),bottom:new Cm(y)},n[O._uuid]=O;var N=new Cm(x),M=new Xm;M._uuid="normal-texture",M.image=N,n[M._uuid]=M;var L=new Cm(S),F=new Xm;F._uuid="default-texture",F.image=L,n[F._uuid]=F;var B=new Ym;if(B.setMipFilter(Ym.Filter.NEAREST),B._uuid="default-cube-texture",B.image={front:new Cm(S),back:new Cm(S),left:new Cm(S),right:new Cm(S),top:new Cm(S),bottom:new Cm(S)},n[B._uuid]=B,b.SpriteFrame){var z=new b.SpriteFrame,U=E,k=new Xm;k.image=U,z.texture=k,z._uuid="default-spriteframe",n[z._uuid]=z}var G=Wp(e);if(!G)return Promise.reject(Error("Failed to initialize builtin shaders: unknown device."));var H=ev[G];return H?Promise.resolve().then((function(){$m.forEach((function(e,t){var n=Object.assign(new b.EffectAsset,e);n.shaders.forEach((function(e,n){var i=H[t][n];i&&(e[G]=i)})),n.hideInEditor=!0,n.onLoaded()})),t._initMaterials()})):Promise.reject(Error("Current device is requiring builtin shaders of version "+G+" but shaders of that version are not assembled in this build."))},t.get=function(e){return this._resources[e]},t._initMaterials=function(){var e=this._resources,t=[],n=new b.Material;n._uuid="standard-material",n.initialize({effectName:"standard"}),e[n._uuid]=n,t.push(n);var i=new b.Material;i._uuid="missing-effect-material",i.initialize({effectName:"unlit",defines:{USE_COLOR:!0}}),i.setProperty("mainColor",b.color("#ffff00")),e[i._uuid]=i,t.push(i);var r=new b.Material;r._uuid="missing-material",r.initialize({effectName:"unlit",defines:{USE_COLOR:!0}}),r.setProperty("mainColor",b.color("#ff00ff")),e[r._uuid]=r,t.push(r);var o=new b.Material;o._uuid="default-clear-stencil",o.initialize({defines:{USE_TEXTURE:!1},effectName:"clear-stencil"}),e[o._uuid]=o,t.push(o);var a=new b.Material;a._uuid="ui-base-material",a.initialize({defines:{USE_TEXTURE:!1},effectName:"sprite"}),e[a._uuid]=a,t.push(a);var s=new b.Material;s._uuid="ui-sprite-material",s.initialize({defines:{USE_TEXTURE:!0,CC_USE_EMBEDDED_ALPHA:!1,IS_GRAY:!1},effectName:"sprite"}),e[s._uuid]=s,t.push(s);var c=new b.Material;c._uuid="ui-alpha-test-material",c.initialize({defines:{USE_TEXTURE:!0,USE_ALPHA_TEST:!0,CC_USE_EMBEDDED_ALPHA:!1,IS_GRAY:!1},effectName:"sprite"}),e[c._uuid]=c,t.push(c);var l=new b.Material;l._uuid="ui-sprite-gray-material",l.initialize({defines:{USE_TEXTURE:!0,CC_USE_EMBEDDED_ALPHA:!1,IS_GRAY:!0},effectName:"sprite"}),e[l._uuid]=l,t.push(l);var u=new b.Material;u._uuid="ui-sprite-alpha-sep-material",u.initialize({defines:{USE_TEXTURE:!0,CC_USE_EMBEDDED_ALPHA:!0,IS_GRAY:!1},effectName:"sprite"}),e[u._uuid]=u,t.push(u);var h=new b.Material;h._uuid="ui-sprite-gray-alpha-sep-material",h.initialize({defines:{USE_TEXTURE:!0,CC_USE_EMBEDDED_ALPHA:!0,IS_GRAY:!0},effectName:"sprite"}),e[h._uuid]=h,t.push(h);var _=new b.Material;_._uuid="ui-graphics-material",_.initialize({effectName:"graphics"}),e[_._uuid]=_,t.push(_);var f=new b.Material;f._uuid="default-particle-material",f.initialize({effectName:"particle"}),e[f._uuid]=f,t.push(f);var d=new b.Material;d._uuid="default-particle-gpu-material",d.initialize({effectName:"particle-gpu"}),e[d._uuid]=d,t.push(d);var p=new b.Material;p._uuid="default-trail-material",p.initialize({effectName:"particle-trail"}),e[p._uuid]=p,t.push(p);var m=new b.Material;m._uuid="default-billboard-material",m.initialize({effectName:"billboard"}),e[m._uuid]=m,t.push(m);var v=new b.Material;v._uuid="default-spine-material",v.initialize({defines:{USE_TEXTURE:!0,CC_USE_EMBEDDED_ALPHA:!1,IS_GRAY:!1},effectName:"spine"}),e[v._uuid]=v,t.push(v),b.game.on(b.Game.EVENT_GAME_INITED,(function(){for(var e=0;e<t.length;++e)for(var n=t[e],i=0;i<n.passes.length;++i)n.passes[i].tryCompile()}))},e}(),nv=e("builtinResMgr",b.builtinResMgr=new tv),iv=e("getPhaseID",(Qm=new Map,Jm=0,function(e){return"number"==typeof e?e:(Qm.has(e)||(Qm.set(e,1<<Jm),Jm++),Qm.get(e))})),rv=e("InstancedBuffer",function(){function e(e){this.instances=[],this.pass=void 0,this.hasPendingModels=!1,this.dynamicOffsets=[],this._device=void 0,this._device=e.device,this.pass=e}var t=e.prototype;return t.destroy=function(){for(var e=0;e<this.instances.length;++e){var t=this.instances[e];t.vb.destroy(),t.ia.destroy()}this.instances.length=0},t.merge=function(e,t,n,i){void 0===i&&(i=null);var r=t.buffer.length;if(r){var o=e.inputAssembler,a=e.descriptorSet.getTexture(ap),s=i;s||(s=e.shaders[n]);for(var c=e.descriptorSet,l=0;l<this.instances.length;++l){var u=this.instances[l];if(!(u.ia.indexBuffer!==o.indexBuffer||u.count>=1024)&&u.lightingMap===a&&u.stride===r){if(u.count>=u.capacity){u.capacity<<=1;var h=u.stride*u.capacity,_=u.data;u.data=new Uint8Array(h),u.data.set(_),u.vb.resize(h)}return u.shader!==s&&(u.shader=s),u.descriptorSet!==c&&(u.descriptorSet=c),u.data.set(t.buffer,u.stride*u.count++),void(this.hasPendingModels=!0)}}for(var f=this._device.createBuffer(new cr(li.VERTEX|li.TRANSFER_DST,_i.HOST|_i.DEVICE,32*r,r)),d=new Uint8Array(32*r),p=o.vertexBuffers.slice(),m=o.attributes.slice(),v=o.indexBuffer,g=0;g<t.attributes.length;g++){var y=t.attributes[g],x=new br(y.name,y.format,y.isNormalized,p.length,!0);m.push(x)}d.set(t.buffer),p.push(f);var S=new wr(m,p,v),E=this._device.createInputAssembler(S);this.instances.push({count:1,capacity:32,vb:f,data:d,ia:E,stride:r,shader:s,descriptorSet:c,lightingMap:a}),this.hasPendingModels=!0}},t.uploadBuffers=function(e){for(var t=0;t<this.instances.length;++t){var n=this.instances[t];n.count&&(n.ia.instanceCount=n.count,e.updateBuffer(n.vb,n.data))}},t.clear=function(){for(var e=0;e<this.instances.length;++e)this.instances[e].count=0;this.hasPendingModels=!1},e}()),ov=function(){function e(e){this.batches=[],this.dynamicOffsets=[],this._device=void 0,this._device=e.device}var t=e.prototype;return t.destroy=function(){for(var e=0;e<this.batches.length;++e){for(var t=this.batches[e],n=0;n<t.vbs.length;++n)t.vbs[n].destroy();t.vbIdx.destroy(),t.ia.destroy(),t.ubo.destroy()}this.batches.length=0},t.merge=function(e,t,n){var i=e.subMesh.flatBuffers;if(0!==i.length){for(var r=0,o=0,a=i[0].count,s=e.passes[t],c=e.shaders[t],l=e.descriptorSet,u=!1,h=0;h<this.batches.length;++h){var _=this.batches[h];if(_.vbs.length===i.length&&_.mergeCount<Ud.BATCHING_COUNT){u=!0;for(var f=0;f<_.vbs.length;++f)if(_.vbs[f].stride!==i[f].stride){u=!1;break}if(u){for(var d=0;d<_.vbs.length;++d){var p=i[d],m=_.vbs[d],v=_.vbDatas[d];(r=(a+_.vbCount)*p.stride)>m.size&&(m.resize(r),_.vbDatas[d]=new Uint8Array(r),_.vbDatas[d].set(v)),_.vbDatas[d].set(p.buffer,_.vbCount*p.stride)}var g=_.vbIdxData;(o=4*(a+_.vbCount))>_.vbIdx.size&&(_.vbIdx.resize(o),_.vbIdxData=new Float32Array(o/Float32Array.BYTES_PER_ELEMENT),_.vbIdxData.set(g),g=_.vbIdxData);var y=_.vbCount,x=y+a,S=_.mergeCount;if(g[y]!==S||g[x-1]!==S)for(var E=y;E<x;E++)g[E]=S+.1;return kn.toArray(_.uboData,n.transform.worldMatrix,Ud.MAT_WORLDS_OFFSET+16*_.mergeCount),_.mergeCount||(l.bindBuffer(Ud.BINDING,_.ubo),l.update(),_.pass=s,_.shader=c,_.descriptorSet=l),++_.mergeCount,_.vbCount+=a,void(_.ia.vertexCount+=a)}}}for(var T=[],C=[],b=[],A=0;A<i.length;++A){var w=i[A],I=this._device.createBuffer(new cr(li.VERTEX|li.TRANSFER_DST,_i.HOST|_i.DEVICE,w.count*w.stride,w.stride));I.update(w.buffer.buffer),T.push(I),C.push(new Uint8Array(I.size)),b.push(I)}var P=this._device.createBuffer(new cr(li.VERTEX|li.TRANSFER_DST,_i.HOST|_i.DEVICE,4*a,4)),R=new Float32Array(a);R.fill(0),P.update(R),b.push(P);for(var D=e.inputAssembler.attributes,O=new Array(D.length+1),N=0;N<D.length;++N)O[N]=D[N];O[D.length]=new br("a_dyn_batch_id",ai.R32F,!1,i.length);var M=new wr(O,b),L=this._device.createInputAssembler(M),F=this._device.createBuffer(new cr(li.UNIFORM|li.TRANSFER_DST,_i.HOST|_i.DEVICE,Ud.SIZE,Ud.SIZE));l.bindBuffer(Ud.BINDING,F),l.update();var B=new Float32Array(Ud.COUNT);kn.toArray(B,n.transform.worldMatrix,Ud.MAT_WORLDS_OFFSET),this.batches.push({mergeCount:1,vbs:T,vbDatas:C,vbIdx:P,vbIdxData:R,vbCount:a,ia:L,ubo:F,uboData:B,pass:s,shader:c,descriptorSet:l})}},t.clear=function(){for(var e=0;e<this.batches.length;++e){var t=this.batches[e];t.vbCount=0,t.mergeCount=0,t.ia.vertexCount=0}},e}(),av=new cr(li.UNIFORM|li.TRANSFER_DST,_i.DEVICE),sv=new lr(null),cv=new zr(null);!function(e){e[e.NONE=0]="NONE",e[e.INSTANCING=1]="INSTANCING",e[e.VB_MERGING=2]="VB_MERGING"}(Zm||(Zm={}));var lv=function(){function e(e){this._rootBuffer=null,this._buffers=[],this._descriptorSet=null,this._pipelineLayout=null,this._passIndex=0,this._propertyIndex=0,this._programName="",this._dynamics={},this._propertyHandleMap={},this._rootBlock=null,this._blocksInt=[],this._blocks=[],this._shaderInfo=null,this._defines={},this._properties={},this._shader=null,this._bs=new To,this._dss=new So,this._rs=new xo,this._priority=ad.DEFAULT,this._stage=od.DEFAULT,this._phase=iv("default"),this._primitive=Oi.TRIANGLE_LIST,this._batchingScheme=Zm.NONE,this._dynamicStates=Fi.NONE,this._instancedBuffers={},this._batchedBuffers={},this._hash=0,this._root=void 0,this._device=void 0,this._passHandle=0,this._rootBufferDirty=!1,this._root=e,this._device=e.device}e.fillPipelineInfo=function(e,t){void 0!==t.priority&&e._setPriority(t.priority),void 0!==t.primitive&&e._setPrimitive(t.primitive),void 0!==t.stage&&e._setStage(t.stage),void 0!==t.dynamicStates&&e._setDynamicState(t.dynamicStates),void 0!==t.phase&&e._setPhase(iv(t.phase));var n=e._bs;if(t.blendState){var i=t.blendState,r=i.targets;r&&r.forEach((function(e,t){n.setTarget(t,e)})),void 0!==i.isA2C&&(n.isA2C=i.isA2C),void 0!==i.isIndepend&&(n.isIndepend=i.isIndepend),void 0!==i.blendColor&&(n.blendColor=i.blendColor)}e._rs.assign(t.rasterizerState),e._dss.assign(t.depthStencilState)},e.getPassHash=function(e){var t,n=$p.getKey(e.program,e.defines)+","+e._primitive+","+e._dynamicStates;return n+=function(e){for(var t,n=",bs,"+e.isA2C,i=S(e.targets);!(t=i()).done;){var r=t.value;n+=",bt,"+r.blend+","+r.blendEq+","+r.blendAlphaEq+","+r.blendColorMask,n+=","+r.blendSrc+","+r.blendDst+","+r.blendSrcAlpha+","+r.blendDstAlpha}return n}(e._bs),n+=function(e){var t=",dss,"+e.depthTest+","+e.depthWrite+","+e.depthFunc;return t+=","+e.stencilTestFront+","+e.stencilFuncFront+","+e.stencilRefFront+","+e.stencilReadMaskFront,t+=","+e.stencilFailOpFront+","+e.stencilZFailOpFront+","+e.stencilPassOpFront+","+e.stencilWriteMaskFront,(t+=","+e.stencilTestBack+","+e.stencilFuncBack+","+e.stencilRefBack+","+e.stencilReadMaskBack)+","+e.stencilFailOpBack+","+e.stencilZFailOpBack+","+e.stencilPassOpBack+","+e.stencilWriteMaskBack}(e._dss),po(n+=",rs,"+(t=e._rs).cullMode+","+t.depthBias+","+t.isFrontFaceCCW,666)};var t=e.prototype;return t.initialize=function(e){this._doInit(e),this.resetUBOs(),this.resetTextures(),this.tryCompile()},t.getHandle=function(e,t,n){void 0===t&&(t=0),void 0===n&&(n=ci.UNKNOWN);var i=this._propertyHandleMap[e];return i?(n?i=Op(i,n):t&&(i=Op(i,Ip(i)-t)),i+t):0},t.getBinding=function(t){var n=this.getHandle(t);return n?e.getBindingFromHandle(n):-1},t.setUniform=function(t,n){var i=e.getBindingFromHandle(t),r=e.getTypeFromHandle(t),o=e.getOffsetFromHandle(t),a=this._getBlockView(r,i);Mp[r](a,n,o),this._setRootBufferDirty(!0)},t.getUniform=function(t,n){var i=e.getBindingFromHandle(t),r=e.getTypeFromHandle(t),o=e.getOffsetFromHandle(t),a=this._getBlockView(r,i);return Np[r](a,n,o)},t.setUniformArray=function(t,n){for(var i=e.getBindingFromHandle(t),r=e.getTypeFromHandle(t),o=ro(r)>>2,a=this._getBlockView(r,i),s=e.getOffsetFromHandle(t),c=0;c<n.length;c++,s+=o)null!==n[c]&&Mp[r](a,n[c],s);this._setRootBufferDirty(!0)},t.bindTexture=function(e,t,n){this._descriptorSet.bindTexture(e,t,n||0)},t.bindSampler=function(e,t,n){this._descriptorSet.bindSampler(e,t,n||0)},t.setDynamicState=function(e,t){var n=this._dynamics[e];n&&n.value===t||(n.value=t,n.dirty=!0)},t.overridePipelineStates=function(){console.warn("base pass cannot override states, please use pass instance instead.")},t._setRootBufferDirty=function(e){this._rootBufferDirty=e},t.update=function(){this._descriptorSet?(this._rootBuffer&&this._rootBufferDirty&&(this._rootBuffer.update(this._rootBlock),this._setRootBufferDirty(!1)),this._descriptorSet.update()):Y(12006)},t.getInstancedBuffer=function(e){return void 0===e&&(e=0),this._instancedBuffers[e]||(this._instancedBuffers[e]=new rv(this))},t.getBatchedBuffer=function(e){return void 0===e&&(e=0),this._batchedBuffers[e]||(this._batchedBuffers[e]=new ov(this))},t._initNative=function(){},t._destroy=function(){},t.destroy=function(){for(var e=0;e<this._shaderInfo.blocks.length;e++){var t=this._shaderInfo.blocks[e];this._buffers[t.binding].destroy()}for(var n in this._buffers=[],this._rootBuffer&&(this._rootBuffer.destroy(),this._rootBuffer=null),this._instancedBuffers)this._instancedBuffers[n].destroy();for(var i in this._batchedBuffers)this._batchedBuffers[i].destroy();this._descriptorSet.destroy(),this._rs.destroy(),this._dss.destroy(),this._bs.destroy(),this._destroy()},t.resetUniform=function(t){var n=this.getHandle(t);if(n){for(var i=e.getTypeFromHandle(n),r=e.getBindingFromHandle(n),o=e.getOffsetFromHandle(n),a=e.getCountFromHandle(n),s=this._getBlockView(i,r),c=this._properties[t],l=c&&c.value||Fp(i),u=(ro(i)>>2)*a,h=0;h+l.length<=u;h+=l.length)s.set(l,o+h);this._setRootBufferDirty(!0)}},t.resetTexture=function(t,n){var i=this.getHandle(t);if(i){var r=e.getTypeFromHandle(i),o=e.getBindingFromHandle(i),a=this._properties[t],s=a&&a.value,c=s?s+"-texture":Fp(r),l=nv.get(c),u=l&&l.getGFXTexture(),h=a&&void 0!==a.samplerHash?Io.unpackFromHash(a.samplerHash):l&&l.getSamplerInfo(),_=this._device.getSampler(h);this._descriptorSet.bindSampler(o,_,n),this._descriptorSet.bindTexture(o,u,n)}},t.resetUBOs=function(){for(var e=0;e<this._shaderInfo.blocks.length;e++)for(var t=this._shaderInfo.blocks[e],n=0,i=0;i<t.members.length;i++){for(var r=t.members[i],o=this._getBlockView(r.type,t.binding),a=this._properties[r.name],s=a&&a.value||Fp(r.type),c=(ro(r.type)>>2)*r.count,l=0;l+s.length<=c;l+=s.length)o.set(s,n+l);n+=c}this._setRootBufferDirty(!0)},t.resetTextures=function(){for(var e=0;e<this._shaderInfo.samplerTextures.length;e++)for(var t=this._shaderInfo.samplerTextures[e],n=0;n<t.count;n++)this.resetTexture(t.name,n)},t.tryCompile=function(){var t=this._root.pipeline;if(!t)return!1;this._syncBatchingScheme();var n=$p.getGFXShader(this._device,this._programName,this._defines,t);return n?(this._shader=n,this._setPipelineLayout($p.getTemplateInfo(this._programName).pipelineLayout),this._setHash(e.getPassHash(this)),!0):(console.warn("create shader "+this._programName+" failed"),!1)},t.getShaderVariant=function(e){if(void 0===e&&(e=null),!this._shader&&!this.tryCompile())return console.warn("pass resources incomplete"),null;if(!e)return this._shader;for(var t=this._root.pipeline,n=0;n<e.length;n++){var i=e[n];this._defines[i.name]=i.value}for(var r=$p.getGFXShader(this._device,this._programName,this._defines,t),o=0;o<e.length;o++){var a=e[o];delete this._defines[a.name]}return r},t.beginChangeStatesSilently=function(){},t.endChangeStatesSilently=function(){},t._setPriority=function(e){this._priority=e},t._setStage=function(e){this._stage=e},t._setPhase=function(e){this._phase=e},t._setPrimitive=function(e){this._primitive=e},t._setState=function(e,t,n,i){this._bs=e,this._dss=t,this._rs=n,this._descriptorSet=i},t._doInit=function(t,n){void 0===n&&(n=!1),this._initNative(),this._setPriority(ad.DEFAULT),this._setStage(od.DEFAULT),this._setPhase(iv("default")),this._setPrimitive(Oi.TRIANGLE_LIST),this._passIndex=t.passIndex,this._propertyIndex=void 0!==t.propertyIndex?t.propertyIndex:t.passIndex,this._programName=t.program,this._defines=n?_({},t.defines):t.defines,this._shaderInfo=$p.getTemplate(t.program),this._properties=t.properties||this._properties;var i=this._device;e.fillPipelineInfo(this,t),t.stateOverrides&&e.fillPipelineInfo(this,t.stateOverrides),cv.layout=$p.getDescriptorSetLayout(this._device,t.program),this._descriptorSet=this._device.createDescriptorSet(cv),this._setState(this._bs,this._dss,this._rs,this._descriptorSet);for(var r=this._shaderInfo.blocks,o=$p.getTemplateInfo(t.program),a=o.blockSizes,s=o.handleMap,c=i.capabilities.uboOffsetAlignment,l=[],u=0,h=0,f=0;f<r.length;f++){var d=a[f];l.push(h),h+=Math.ceil(d/c)*c,u=d}var p=l[l.length-1]+u;p&&(av.size=16*Math.ceil(p/16),this._rootBuffer=i.createBuffer(av),this._rootBlock=new ArrayBuffer(p));for(var m=0,v=0;m<r.length;m++){var g=r[m].binding,y=a[m];sv.buffer=this._rootBuffer,sv.offset=l[v++],sv.range=16*Math.ceil(y/16);var x=this._buffers[g]=i.createBuffer(sv);this._blocks[g]=new Float32Array(this._rootBlock,sv.offset,y/Float32Array.BYTES_PER_ELEMENT),this._blocksInt[g]=new Int32Array(this._blocks[g].buffer,this._blocks[g].byteOffset,this._blocks[g].length),this._descriptorSet.bindBuffer(g,x)}var S=this._propertyHandleMap=s,E={};for(var T in this._properties){var C=this._properties[T];C.handleInfo&&(E[T]=this.getHandle.apply(this,C.handleInfo))}Object.assign(S,E)},t._syncBatchingScheme=function(){this._defines.USE_INSTANCING?this._device.hasFeature(oi.INSTANCED_ARRAYS)?this._setBatchingScheme(Zm.INSTANCING):(this._defines.USE_INSTANCING=!1,this._setBatchingScheme(Zm.NONE)):this._defines.USE_BATCHING?this._setBatchingScheme(Zm.VB_MERGING):this._setBatchingScheme(Zm.NONE)},t._setBatchingScheme=function(e){this._batchingScheme=e},t._setDynamicState=function(e){this._dynamicStates=e},t._setHash=function(e){this._hash=e},t._getBlockView=function(e,t){return e<ci.FLOAT?this._blocksInt[t]:this._blocks[t]},t._setPipelineLayout=function(e){this._pipelineLayout=e},t._initPassFromTarget=function(e,t,n,i){this._initNative(),this._setPriority(e.priority),this._setStage(e.stage),this._setPhase(e.phase),this._setBatchingScheme(e.batchingScheme),this._setPrimitive(e.primitive),this._setDynamicState(e.dynamicStates),this._setState(n,t,e.rasterizerState,e.descriptorSet),this._passIndex=e.passIndex,this._propertyIndex=e.propertyIndex,this._programName=e.program,this._defines=e.defines,this._shaderInfo=e._shaderInfo,this._properties=e._properties,this._blocks=e._blocks,this._blocksInt=e._blocksInt,this._dynamics=e._dynamics,this._shader=e._shader,this._setPipelineLayout($p.getTemplateInfo(this._programName).pipelineLayout),this._setHash(e._hash^i)},h(e,[{key:"native",get:function(){return this._nativeObj}},{key:"root",get:function(){return this._root}},{key:"device",get:function(){return this._device}},{key:"shaderInfo",get:function(){return this._shaderInfo}},{key:"localSetLayout",get:function(){return $p.getDescriptorSetLayout(this._device,this._programName,!0)}},{key:"program",get:function(){return this._programName}},{key:"properties",get:function(){return this._properties}},{key:"defines",get:function(){return this._defines}},{key:"passIndex",get:function(){return this._passIndex}},{key:"propertyIndex",get:function(){return this._propertyIndex}},{key:"dynamics",get:function(){return this._dynamics}},{key:"blocks",get:function(){return this._blocks}},{key:"blocksInt",get:function(){return this._blocksInt}},{key:"rootBufferDirty",get:function(){return this._rootBufferDirty}},{key:"priority",get:function(){return this._priority}},{key:"primitive",get:function(){return this._primitive}},{key:"stage",get:function(){return this._stage}},{key:"phase",get:function(){return this._phase}},{key:"rasterizerState",get:function(){return this._rs}},{key:"depthStencilState",get:function(){return this._dss}},{key:"blendState",get:function(){return this._bs}},{key:"dynamicStates",get:function(){return this._dynamicStates}},{key:"batchingScheme",get:function(){return this._batchingScheme}},{key:"descriptorSet",get:function(){return this._descriptorSet}},{key:"hash",get:function(){return this._hash}},{key:"pipelineLayout",get:function(){return this._pipelineLayout}}]),e}();lv.getTypeFromHandle=Ip,lv.getBindingFromHandle=Pp,lv.getCountFromHandle=Rp,lv.getOffsetFromHandle=Dp;var uv=e("PipelineStateManager",function(){function e(){}return e.getOrCreatePipelineState=function(e,t,n,i,r){var o=t.hash^i.hash^r.attributesHash^n.typedID,a=this._PSOHashMap.get(o);if(!a){var s=t.pipelineLayout,c=new kr(r.attributes),l=new Co(n,s,i,c,t.rasterizerState,t.depthStencilState,t.blendState,t.primitive,t.dynamicStates);a=e.createPipelineState(l),this._PSOHashMap.set(o,a)}return a},e}());uv._PSOHashMap=new Map;var hv=new ir,_v=new Qi;function fv(e,t){e.x=t.x*t.x,e.y=t.y*t.y,e.z=t.z*t.z}var dv,pv,mv,vv,gv,yv,xv,Sv,Ev,Tv,Cv=null;function bv(e,t,n,i,r){if(i&&i.enabled&&r===Cv){var o=i.subModels[0],a=o.inputAssembler,s=o.passes,c=o.shaders,l=o.descriptorSet;hv.width=_v.width=r.window.width,hv.height=_v.height=r.window.height;var u=uv.getOrCreatePipelineState(e,s[0],c[0],t,a);n.setViewport(hv),n.setScissor(_v),n.bindPipelineState(u),n.bindDescriptorSet(md.MATERIAL,s[0].descriptorSet),n.bindDescriptorSet(md.LOCAL,l),n.bindInputAssembler(a),n.draw(a)}}var Av,wv,Iv,Pv,Rv,Dv=new wn,Ov=e("Material",(dv=dc("cc.Material"),pv=Jc(em),dv((Tv=function(e){function t(){var t;return E(t=e.call(this)||this,"_effectAsset",gv,y(t)),E(t,"_techIdx",yv,y(t)),E(t,"_defines",xv,y(t)),E(t,"_states",Sv,y(t)),E(t,"_props",Ev,y(t)),t._passes=[],t._hash=0,t}f(t,e),t.getHash=function(e){for(var t,n=0,i=S(e.passes);!(t=i()).done;)n^=t.value.hash;return n};var n=t.prototype;return n.initialize=function(e){this._passes.length?q(12005):(this._defines||(this._defines=[]),this._states||(this._states=[]),this._props||(this._props=[]),this._fillInfo(e),this._update())},n.reset=function(e){this.initialize(e)},n.destroy=function(){return this._doDestroy(),e.prototype.destroy.call(this)},n.recompileShaders=function(){console.warn("Shaders in material asset '"+this.name+"' cannot be modified at runtime, please instantiate the material first.")},n.overridePipelineStates=function(){console.warn("Pipeline states in material asset '"+this.name+"' cannot be modified at runtime, please instantiate the material first.")},n.onLoaded=function(){this._update()},n.resetUniforms=function(e){void 0===e&&(e=!0),this._props.length=this._passes.length;for(var t=0;t<this._props.length;t++)this._props[t]={};if(e)for(var n,i=S(this._passes);!(n=i()).done;){var r=n.value;r.resetUBOs(),r.resetTextures()}},n.setProperty=function(e,t,n){var i=!1;if(void 0===n)for(var r=this._passes,o=r.length,a=0;a<o;a++){var s=r[a];this._uploadProperty(s,e,t)&&(this._props[s.propertyIndex][e]=t,i=!0)}else{if(n>=this._passes.length)return void console.warn("illegal pass index: "+n+".");var c=this._passes[n];this._uploadProperty(c,e,t)&&(this._props[c.propertyIndex][e]=t,i=!0)}i||console.warn("illegal property name: "+e+".")},n.getProperty=function(e,t){if(void 0===t)for(var n=this._props,i=n.length,r=0;r<i;r++){var o=n[r];if(e in o)return o[e]}else{if(t>=this._props.length)return console.warn("illegal pass index: "+t+"."),null;var a=this._props[this._passes[t].propertyIndex];if(e in a)return a[e]}return null},n.copy=function(e,t){this._techIdx=e._techIdx,this._props.length=e._props.length;for(var n=0;n<e._props.length;n++)this._props[n]=_({},e._props[n]);this._defines.length=e._defines.length;for(var i=0;i<e._defines.length;i++)this._defines[i]=_({},e._defines[i]);this._states.length=e._states.length;for(var r=0;r<e._states.length;r++)this._states[r]=_({},e._states[r]);this._effectAsset=e._effectAsset,t&&this._fillInfo(t),this._update()},n._fillInfo=function(e){void 0!==e.technique&&(this._techIdx=e.technique),e.effectAsset?this._effectAsset=e.effectAsset:e.effectName&&(this._effectAsset=em.get(e.effectName)),e.defines&&this._prepareInfo(e.defines,this._defines),e.states&&this._prepareInfo(e.states,this._states)},n._prepareInfo=function(e,t){var n=e;if(!Array.isArray(n)){var i=this._effectAsset?this._effectAsset.techniques[this._techIdx].passes.length:1;n=Array(i).fill(n)}for(var r=0;r<n.length;++r)Object.assign(t[r]||(t[r]={}),n[r])},n._createPasses=function(){var e=this._effectAsset.techniques[this._techIdx||0];if(!e)return[];for(var t=e.passes.length,n=[],i=0;i<t;++i){var r=e.passes[i],o=r.passIndex=i,a=r.defines=this._defines[o]||(this._defines[o]={});if(r.stateOverrides=this._states[o]||(this._states[o]={}),void 0!==r.propertyIndex&&Object.assign(a,this._defines[r.propertyIndex]),void 0!==r.embeddedMacros&&Object.assign(a,r.embeddedMacros),!r.switch||a[r.switch]){var s=new lv(b.director.root);s.initialize(r),n.push(s)}}return n},n._update=function(e){var n=this;if(void 0===e&&(e=!0),this._effectAsset){this._passes=this._createPasses();var i=this._effectAsset.techniques[this._techIdx].passes.length;if(this._props.length=i,e)this._passes.forEach((function(e,t){var i=n._props[t];for(var r in i||(i=n._props[t]={}),void 0!==e.propertyIndex&&Object.assign(i,n._props[e.propertyIndex]),i)n._uploadProperty(e,r,i[r])}));else for(var r=0;r<this._props.length;r++)this._props[r]={}}this._hash=t.getHash(this)},n._uploadProperty=function(e,t,n){var i=e.getHandle(t);if(!i)return!1;if(lv.getTypeFromHandle(i)<ci.SAMPLER1D)if(Array.isArray(n))e.setUniformArray(i,n);else if(null!==n){var r;if(null===(r=e.properties[t])||void 0===r?void 0:r.linear){var o=n;fv(Dv,o),Dv.w=o.w,n=Dv}e.setUniform(i,n)}else e.resetUniform(t);else if(Array.isArray(n))for(var a=0;a<n.length;a++)this._bindTexture(e,i,n[a],a);else n?this._bindTexture(e,i,n):e.resetTexture(t);return!0},n._bindTexture=function(e,t,n,i){var r=lv.getBindingFromHandle(t);if(n instanceof Ro)e.bindTexture(r,n,i);else if(n instanceof Em){var o=n.getGFXTexture();if(!o||!o.width||!o.height)return;e.bindTexture(r,o,i),e.bindSampler(r,n.getGFXSampler(),i)}},n._doDestroy=function(){if(this._passes&&this._passes.length)for(var e,t=S(this._passes);!(e=t()).done;)e.value.destroy();this._passes.length=0},n.initDefault=function(t){e.prototype.initDefault.call(this,t),this.initialize({effectName:"unlit",defines:{USE_COLOR:!0},technique:0}),this.setProperty("mainColor",new Qn("#ff00ff"))},n.validate=function(){return!!this._effectAsset&&!this._effectAsset.isDefault&&this.passes.length>0},h(t,[{key:"effectAsset",get:function(){return this._effectAsset}},{key:"effectName",get:function(){return this._effectAsset?this._effectAsset.name:""}},{key:"technique",get:function(){return this._techIdx}},{key:"passes",get:function(){return this._passes}},{key:"hash",get:function(){return this._hash}},{key:"parent",get:function(){return null}},{key:"owner",get:function(){return null}}]),t}(yu),gv=T((vv=Tv).prototype,"_effectAsset",[pv],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),yv=T(vv.prototype,"_techIdx",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),xv=T(vv.prototype,"_defines",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Sv=T(vv.prototype,"_states",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Ev=T(vv.prototype,"_props",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),mv=vv))||mv));b.Material=Ov,function(e){e[e.VERTICAL=0]="VERTICAL",e[e.HORIZONTAL=1]="HORIZONTAL"}(Av||(Av={})),function(e){e[e.ORTHO=0]="ORTHO",e[e.PERSPECTIVE=1]="PERSPECTIVE"}(wv||(wv={})),function(e){e[e.F1_8=0]="F1_8",e[e.F2_0=1]="F2_0",e[e.F2_2=2]="F2_2",e[e.F2_5=3]="F2_5",e[e.F2_8=4]="F2_8",e[e.F3_2=5]="F3_2",e[e.F3_5=6]="F3_5",e[e.F4_0=7]="F4_0",e[e.F4_5=8]="F4_5",e[e.F5_0=9]="F5_0",e[e.F5_6=10]="F5_6",e[e.F6_3=11]="F6_3",e[e.F7_1=12]="F7_1",e[e.F8_0=13]="F8_0",e[e.F9_0=14]="F9_0",e[e.F10_0=15]="F10_0",e[e.F11_0=16]="F11_0",e[e.F13_0=17]="F13_0",e[e.F14_0=18]="F14_0",e[e.F16_0=19]="F16_0",e[e.F18_0=20]="F18_0",e[e.F20_0=21]="F20_0",e[e.F22_0=22]="F22_0"}(Iv||(Iv={})),function(e){e[e.ISO100=0]="ISO100",e[e.ISO200=1]="ISO200",e[e.ISO400=2]="ISO400",e[e.ISO800=3]="ISO800"}(Pv||(Pv={})),function(e){e[e.D1=0]="D1",e[e.D2=1]="D2",e[e.D4=2]="D4",e[e.D8=3]="D8",e[e.D15=4]="D15",e[e.D30=5]="D30",e[e.D60=6]="D60",e[e.D125=7]="D125",e[e.D250=8]="D250",e[e.D500=9]="D500",e[e.D1000=10]="D1000",e[e.D2000=11]="D2000",e[e.D4000=12]="D4000"}(Rv||(Rv={}));var Nv=[1.8,2,2.2,2.5,2.8,3.2,3.5,4,4.5,5,5.6,6.3,7.1,8,9,10,11,13,14,16,18,20,22],Mv=[1,.5,1/4,1/8,1/15,1/30,1/60,.008,.004,.002,.001,5e-4,1/4e3],Lv=[100,200,400,800],Fv=new yn,Bv=new yn,zv=new kn,Uv=Hi.STENCIL<<1,kv=[],Gv=function(){function e(e){if(this.isWindowSize=!0,this.screenScale=void 0,this._device=void 0,this._scene=null,this._node=null,this._name=null,this._enabled=!1,this._proj=-1,this._aspect=void 0,this._orthoHeight=10,this._fovAxis=Av.VERTICAL,this._fov=rn(45),this._nearClip=1,this._farClip=1e3,this._clearColor=new rr(.2,.2,.2,1),this._viewport=new Xn(0,0,1,1),this._orientedViewport=new Xn(0,0,1,1),this._curTransform=ri.IDENTITY,this._isProjDirty=!0,this._matView=new kn,this._matProj=new kn,this._matProjInv=new kn,this._matViewProj=new kn,this._matViewProjInv=new kn,this._frustum=new Js,this._forward=new yn,this._position=new yn,this._priority=0,this._aperture=Iv.F16_0,this._apertureValue=void 0,this._shutter=Rv.D125,this._shutterValue=0,this._iso=Pv.ISO100,this._isoValue=0,this._window=null,this._width=1,this._height=1,this._clearFlag=Hi.NONE,this._clearDepth=1,this._visibility=xp,this._exposure=0,this._clearStencil=0,this._device=e,this._apertureValue=Nv[this._aperture],this._shutterValue=Mv[this._shutter],this._isoValue=Lv[this._iso],this._aspect=this.screenScale=1,this._frustum.accurate=!0,!kv.length){var t=e.capabilities.clipSpaceSignY;kv[ri.IDENTITY]=new kn(1,0,0,0,0,t),kv[ri.ROTATE_90]=new kn(0,1,0,0,-t,0),kv[ri.ROTATE_180]=new kn(-1,0,0,0,0,-t),kv[ri.ROTATE_270]=new kn(0,-1,0,0,t,0)}}var t=e.prototype;return t._setWidth=function(e){this._width=e},t._setHeight=function(e){this._height=e},t._setScene=function(e){this._scene=e},t._updateAspect=function(e){if(void 0===e&&(e=!0),this._aspect=this.window.width*this._viewport.width/(this.window.height*this._viewport.height),e){var t=this.window.swapchain;(t&&t.surfaceTransform||ri.IDENTITY)%2&&(this._aspect=1/this._aspect)}this._isProjDirty=!0},t._init=function(){},t._destroy=function(){},t.initialize=function(e){this._init(e),this.node=e.node,this._setWidth(1),this._setHeight(1),this.clearFlag=Hi.NONE,this.clearDepth=1,this.visibility=xp,this._name=e.name,this._proj=e.projection,this._priority=e.priority||0,this._aspect=this.screenScale=1,this.updateExposure(),this.changeTargetWindow(e.window)},t.destroy=function(){this._node=null,this.detachFromScene(),this._window&&(this._window.detachCamera(this),this.window=null),this._name=null,this._destroy()},t.attachToScene=function(e){this._enabled=!0,this._setScene(e)},t.detachFromScene=function(){this._enabled=!1,this._setScene(null)},t.resize=function(e,t){this._window&&(this._setWidth(e),this._setHeight(t),this._updateAspect())},t.setFixedSize=function(e,t){this._setWidth(e),this._setHeight(t),this._updateAspect(!1),this.isWindowSize=!1},t.syncCameraEditor=function(){},t.update=function(e){var t;if(void 0===e&&(e=!1),this._node){var n=!1;(this._node.hasChangedFlags||e)&&(kn.invert(this._matView,this._node.worldMatrix),this._forward.x=-this._matView.m02,this._forward.y=-this._matView.m06,this._forward.z=-this._matView.m10,this._node.getWorldPosition(this._position),n=!0);var i=null===(t=this.window)||void 0===t?void 0:t.swapchain,r=i&&i.surfaceTransform||ri.IDENTITY;if(this._isProjDirty||this._curTransform!==r){this._curTransform=r;var o=this._device.capabilities.clipSpaceSignY;if(this._proj===wv.PERSPECTIVE)kn.perspective(this._matProj,this._fov,this._aspect,this._nearClip,this._farClip,this._fovAxis===Av.VERTICAL,this._device.capabilities.clipSpaceMinZ,o,r);else{var a=this._orthoHeight*this._aspect,s=this._orthoHeight;kn.ortho(this._matProj,-a,a,-s,s,this._nearClip,this._farClip,this._device.capabilities.clipSpaceMinZ,o,r)}kn.invert(this._matProjInv,this._matProj),n=!0,this._isProjDirty=!1}n&&(kn.multiply(this._matViewProj,this._matProj,this._matView),kn.invert(this._matViewProjInv,this._matViewProj),this._frustum.update(this._matViewProj,this._matViewProjInv))}},t.setViewportInOrientedSpace=function(e){var t,n=e.x,i=e.width,r=e.height,o=this._device.capabilities.screenSpaceSignY<0?1-e.y-r:e.y,a=null===(t=this.window)||void 0===t?void 0:t.swapchain;switch(a&&a.surfaceTransform||ri.IDENTITY){case ri.ROTATE_90:this._viewport.x=1-o-r,this._viewport.y=n,this._viewport.width=r,this._viewport.height=i;break;case ri.ROTATE_180:this._viewport.x=1-n-i,this._viewport.y=1-o-r,this._viewport.width=i,this._viewport.height=r;break;case ri.ROTATE_270:this._viewport.x=o,this._viewport.y=1-n-i,this._viewport.width=r,this._viewport.height=i;break;case ri.IDENTITY:this._viewport.x=n,this._viewport.y=o,this._viewport.width=i,this._viewport.height=r}this._orientedViewport.x=n,this._orientedViewport.y=o,this._orientedViewport.width=i,this._orientedViewport.height=r,this.resize(this.width,this.height)},t.changeTargetWindow=function(e){void 0===e&&(e=null),this._window&&this._window.detachCamera(this);var t=e||b.director.root.mainWindow;if(t){t.attachCamera(this),this.window=t;var n=t.swapchain;(n&&n.surfaceTransform||ri.IDENTITY)%2?this.resize(t.height,t.width):this.resize(t.width,t.height)}},t.detachCamera=function(){this._window&&this._window.detachCamera(this)},t.screenPointToRay=function(e,t,n){if(!this._node)return null;var i=this.width,r=this.height,o=this._orientedViewport.x*i,a=this._orientedViewport.y*r,s=this._orientedViewport.width*i,c=this._orientedViewport.height*r,l=this._proj===wv.PERSPECTIVE,u=this._device.capabilities.clipSpaceSignY,h=Un[this._curTransform];yn.set(Fv,(t-o)/s*2-1,(n-a)/c*2-1,l?1:-1);var _=Fv.x,f=Fv.y;return Fv.x=_*h[0]+f*h[2]*u,Fv.y=_*h[1]+f*h[3]*u,yn.transformMat4(l?Fv:e.o,Fv,this._matViewProjInv),l?(this._node.getWorldPosition(Bv),Xo.fromPoints(e,Bv,Fv)):yn.transformQuat(e.d,yn.FORWARD,this._node.worldRotation),e},t.screenToWorld=function(e,t){var n=this.width,i=this.height,r=this._orientedViewport.x*n,o=this._orientedViewport.y*i,a=this._orientedViewport.width*n,s=this._orientedViewport.height*i,c=this._device.capabilities.clipSpaceSignY,l=Un[this._curTransform];if(this._proj===wv.PERSPECTIVE){yn.set(e,(t.x-r)/a*2-1,(t.y-o)/s*2-1,1);var u=e.x,h=e.y;e.x=u*l[0]+h*l[2]*c,e.y=u*l[1]+h*l[3]*c,yn.transformMat4(e,e,this._matViewProjInv),this._node&&this._node.getWorldPosition(Fv),yn.lerp(e,Fv,e,nn(this._nearClip/this._farClip,1,t.z))}else{yn.set(e,(t.x-r)/a*2-1,(t.y-o)/s*2-1,2*t.z-1);var _=e.x,f=e.y;e.x=_*l[0]+f*l[2]*c,e.y=_*l[1]+f*l[3]*c,yn.transformMat4(e,e,this._matViewProjInv)}return e},t.worldToScreen=function(e,t){var n=this._device.capabilities.clipSpaceSignY,i=Un[this._curTransform];yn.transformMat4(e,t,this._matViewProj);var r=e.x,o=e.y;e.x=r*i[0]+o*i[2]*n,e.y=r*i[1]+o*i[3]*n;var a=this.width,s=this.height,c=this._orientedViewport.x*a,l=this._orientedViewport.y*s,u=this._orientedViewport.width*a,h=this._orientedViewport.height*s;return e.x=c+.5*(e.x+1)*u,e.y=l+.5*(e.y+1)*h,e.z=.5*e.z+.5,e},t.worldMatrixToScreen=function(e,t,n,i){kn.multiply(e,this._matViewProj,t),kn.multiply(e,kv[this._curTransform],e);var r=n/2,o=i/2;return kn.identity(zv),kn.transform(zv,zv,yn.set(Fv,r,o,0)),kn.scale(zv,zv,yn.set(Fv,r,o,1)),kn.multiply(e,zv,e),e},t.setExposure=function(e){this._exposure=.833333/Math.pow(2,e)},t.updateExposure=function(){var e=Math.log2(this._apertureValue*this._apertureValue/this._shutterValue*100/this._isoValue);this.setExposure(e)},h(e,[{key:"name",get:function(){return this._name}},{key:"scene",get:function(){return this._scene}},{key:"node",get:function(){return this._node},set:function(e){this._node=e}},{key:"window",get:function(){return this._window},set:function(e){this._window=e}},{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled=e}},{key:"visibility",get:function(){return this._visibility},set:function(e){this._visibility=e}},{key:"priority",get:function(){return this._priority},set:function(e){this._priority=e}},{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"position",get:function(){return this._position},set:function(e){this._position=e}},{key:"forward",get:function(){return this._forward},set:function(e){this._forward=e}},{key:"aperture",get:function(){return this._aperture},set:function(e){this._aperture=e,this._apertureValue=Nv[this._aperture],this.updateExposure()}},{key:"apertureValue",get:function(){return this._apertureValue}},{key:"shutter",get:function(){return this._shutter},set:function(e){this._shutter=e,this._shutterValue=Mv[this._shutter],this.updateExposure()}},{key:"shutterValue",get:function(){return this._shutterValue}},{key:"iso",get:function(){return this._iso},set:function(e){this._iso=e,this._isoValue=Lv[this._iso],this.updateExposure()}},{key:"isoValue",get:function(){return this._isoValue}},{key:"exposure",get:function(){return this._exposure}},{key:"clearFlag",get:function(){return this._clearFlag},set:function(e){this._clearFlag=e}},{key:"clearColor",get:function(){return this._clearColor},set:function(e){this._clearColor.x=e.x,this._clearColor.y=e.y,this._clearColor.z=e.z,this._clearColor.w=e.w}},{key:"clearDepth",get:function(){return this._clearDepth},set:function(e){this._clearDepth=e}},{key:"clearStencil",get:function(){return this._clearStencil},set:function(e){this._clearStencil=e}},{key:"projectionType",get:function(){return this._proj},set:function(e){this._proj=e,this._isProjDirty=!0}},{key:"aspect",get:function(){return this._aspect}},{key:"orthoHeight",get:function(){return this._orthoHeight},set:function(e){this._orthoHeight=e,this._isProjDirty=!0}},{key:"fovAxis",get:function(){return this._fovAxis},set:function(e){this._fovAxis=e,this._isProjDirty=!0}},{key:"fov",get:function(){return this._fov},set:function(e){this._fov=e,this._isProjDirty=!0}},{key:"nearClip",get:function(){return this._nearClip},set:function(e){this._nearClip=e,this._isProjDirty=!0}},{key:"farClip",get:function(){return this._farClip},set:function(e){this._farClip=e,this._isProjDirty=!0}},{key:"viewport",get:function(){return this._viewport},set:function(e){q(8302),this.setViewportInOrientedSpace(e)}},{key:"frustum",get:function(){return this._frustum},set:function(e){this._frustum=e}},{key:"matView",get:function(){return this._matView}},{key:"matProj",get:function(){return this._matProj}},{key:"matProjInv",get:function(){return this._matProjInv}},{key:"matViewProj",get:function(){return this._matViewProj}},{key:"matViewProjInv",get:function(){return this._matViewProjInv}},{key:"native",get:function(){return this._nativeObj}}],[{key:"standardExposureValue",get:function(){return 1/38400}},{key:"standardLightMeterScale",get:function(){return 1e4}}]),e}(),Hv=Je({Low_256x256:256,Medium_512x512:512,High_1024x1024:1024,Ultra_2048x2048:2048}),Vv=Je({Planar:0,ShadowMap:1}),Wv=Je({HARD:0,SOFT:1,SOFT_2X:2}),jv=Vv.ShadowMap+1,qv=function(){function e(){this.fixedSphere=new ea(0,0,0,.01),this.maxReceived=4,this.firstSetCSM=!1,this.shadowCameraFar=0,this.matShadowView=new kn,this.matShadowProj=new kn,this.matShadowViewProj=new kn,this._enabled=!1,this._type=jv,this._distance=0,this._normal=new yn(0,1,0),this._shadowColor=new Qn(0,0,0,76),this._size=new Tn(512,512),this._shadowMapDirty=!1,this._matLight=new kn,this._material=null,this._instancingMaterial=null}var t=e.prototype;return t.getPlanarShader=function(e){return this._material||(this._material=new Ov,this._material.initialize({effectName:"planar-shadow"})),this._material.passes[0].getShaderVariant(e)},t.getPlanarInstanceShader=function(e){return this._instancingMaterial||(this._instancingMaterial=new Ov,this._instancingMaterial.initialize({effectName:"planar-shadow",defines:{USE_INSTANCING:!0}})),this._instancingMaterial.passes[0].getShaderVariant(e)},t._setEnable=function(e){this._enabled=e},t._setType=function(e){this._type=this.enabled?e:jv},t.initialize=function(e){this._setEnable(e.enabled),this._setType(e.type),this.normal=e.planeDirection,this.distance=e.planeHeight,this.shadowColor=e.shadowColor,this.maxReceived=e.maxReceived,this.size=e.size},t.activate=function(){this.enabled&&this.type===Vv.Planar&&this._updatePlanarInfo()},t._updatePlanarInfo=function(){this._material||(this._material=new Ov,this._material.initialize({effectName:"planar-shadow"})),this._instancingMaterial||(this._instancingMaterial=new Ov,this._instancingMaterial.initialize({effectName:"planar-shadow",defines:{USE_INSTANCING:!0}}))},t._destroy=function(){},t.destroy=function(){this._destroy(),this._material&&this._material.destroy(),this._instancingMaterial&&this._instancingMaterial.destroy(),this.fixedSphere.destroy()},h(e,[{key:"enabled",get:function(){return this._enabled},set:function(e){this._setEnable(e),this.activate()}},{key:"type",get:function(){return this._type},set:function(e){this._setType(e),this.activate()}},{key:"normal",get:function(){return this._normal},set:function(e){yn.copy(this._normal,e)}},{key:"distance",get:function(){return this._distance},set:function(e){this._distance=e}},{key:"shadowColor",get:function(){return this._shadowColor},set:function(e){this._shadowColor=e}},{key:"size",get:function(){return this._size},set:function(e){this._size.set(e)}},{key:"shadowMapDirty",get:function(){return this._shadowMapDirty},set:function(e){this._shadowMapDirty=e}},{key:"matLight",get:function(){return this._matLight}},{key:"material",get:function(){return this._material}},{key:"instancingMaterial",get:function(){return this._instancingMaterial}},{key:"native",get:function(){return this._nativeObj}}]),e}();qv.MAX_FAR=2e3,qv.COEFFICIENT_OF_EXPANSION=2*Math.sqrt(3),b.Shadows=qv;var Xv=new yn,Yv=(new yn,new yn,new yn),Kv=new kn,Qv=new Us,Jv=new Us,Zv=!1,$v=ea.create(0,0,0,1),eg=new ea,tg=new Js;tg.accurate=!0;var ng=new Js;ng.accurate=!0;var ig=new Js,rg=new kn,og=new kn,ag=new kn,sg=new kn,cg=new kn,lg=new kn,ug=new kn,hg=new yn,_g=new Tn,fg=new yn,dg=new yn,pg=new yn(0,0,0),mg=(new Us,new Ml((function(){return{model:null,depth:0}}),128)),vg=new Ml((function(){return{model:null,depth:0}}),128),gg=new Ml((function(){return{model:null,depth:0}}),128);function yg(e,t){var n=0;e.node&&(yn.subtract(Xv,e.node.worldPosition,t.position),n=yn.dot(Xv,t.forward));var i=mg.alloc();return i.model=e,i.depth=n,i}function xg(e,t){var n=0;e.node&&(yn.subtract(Xv,e.node.worldPosition,t.position),n=yn.dot(Xv,t.forward));var i=vg.alloc();return i.model=e,i.depth=n,i}function Sg(e,t){var n=0;e.node&&(yn.subtract(Xv,e.node.worldPosition,t.position),n=yn.dot(Xv,t.forward));var i=gg.alloc();return i.model=e,i.depth=n,i}function Eg(e,t,n){var i=t.direction,r=e.normal,o=e.distance+.001,a=1/yn.dot(r,i),s=i.x*a,c=i.y*a,l=i.z*a,u=r.x,h=r.y,_=r.z,f=e.matLight;f.m00=1-u*s,f.m01=-u*c,f.m02=-u*l,f.m03=0,f.m04=-h*s,f.m05=1-h*c,f.m06=-h*l,f.m07=0,f.m08=-_*s,f.m09=-_*c,f.m10=1-_*l,f.m11=0,f.m12=s*o,f.m13=c*o,f.m14=l*o,f.m15=1,kn.toArray(n,f,Td.MAT_LIGHT_PLANE_PROJ_OFFSET)}function Tg(e,t){yn.normalize(Xv,e.normal),t[Td.PLANAR_NORMAL_DISTANCE_INFO_OFFSET+0]=Xv.x,t[Td.PLANAR_NORMAL_DISTANCE_INFO_OFFSET+1]=Xv.y,t[Td.PLANAR_NORMAL_DISTANCE_INFO_OFFSET+2]=Xv.z,t[Td.PLANAR_NORMAL_DISTANCE_INFO_OFFSET+3]=e.distance}function Cg(e,t){var n=e.pipelineSceneData.validPunctualLights;n.length=0;for(var i=t.scene.spotLights,r=0;r<i.length;r++){var o=i[r];o.baked||(ea.set($v,o.position.x,o.position.y,o.position.z,o.range),rs.sphereFrustum($v,t.frustum)&&n.push(o))}for(var a=t.scene.sphereLights,s=0;s<a.length;s++){var c=a[s];c.baked||(ea.set($v,c.position.x,c.position.y,c.position.z,c.range),rs.sphereFrustum($v,t.frustum)&&n.push(c))}}function bg(e,t){var n=t.scene,i=n.mainLight,r=e.pipelineSceneData,o=r.shadows,a=r.skybox,s=r.renderObjects;mg.freeArray(s),s.length=0;var c=r.castShadowObjects;gg.freeArray(c),c.length=0,Zv=!1;var l=null;if(o.enabled&&(e.pipelineUBO.updateShadowUBORange(Td.SHADOW_COLOR_OFFSET,o.shadowColor),o.type===Vv.ShadowMap))if(l=e.pipelineSceneData.dirShadowObjects,vg.freeArray(l),l.length=0,i&&i.node)!function(e,t,n,i,r){var o=t.device;if(n.shadowFixedArea){var a=n.shadowOrthoSize,s=n.shadowOrthoSize,c=n.shadowNear,l=n.shadowFar;kn.fromRT(rg,n.node.getWorldRotation(),n.node.getWorldPosition()),kn.invert(og,rg),kn.ortho(sg,-a,a,-s,s,c,l,o.capabilities.clipSpaceMinZ,o.capabilities.clipSpaceSignY),kn.multiply(cg,sg,og),kn.invert(ag,og),r.matShadowView=og,r.matShadowProj=sg,r.matShadowViewProj=cg,Js.createOrtho(e,2*a,2*s,c,l,ag)}else{var u=n.shadowInvisibleOcclusionRange,h=r.size.x;!function(e,t){if(t.node){var n=t.node,i=n.getWorldPosition(),r=n.getWorldRotation();kn.fromRT(e,r,i),e.m08*=-1,e.m09*=-1,e.m10*=-1}}(Kv,i),Js.split(tg,i,Kv,.1,n.shadowDistance),ng=Js.clone(tg),kn.fromRT(rg,n.node.rotation,pg),kn.invert(og,rg),kn.invert(ag,og);var _=og.clone();ng.transform(og),Us.fromPoints(Qv,new yn(1e7,1e7,1e7),new yn(-1e7,-1e7,-1e7)),Qv.mergeFrustum(ng);var f=2*Qv.halfExtents.z;Yv.set(Qv.center.x,Qv.center.y,Qv.center.z+Qv.halfExtents.z+u),yn.transformMat4(Yv,Yv,ag),kn.fromRT(rg,n.node.rotation,Yv),kn.invert(og,rg),kn.invert(ag,og);var d=yn.distance(tg.vertices[0],tg.vertices[6]);eg.center.set(0,0,0),eg.radius=-1,eg.mergePoints(tg.vertices);var p=.8*d+.4*eg.radius;r.shadowCameraFar=f+u;var m=.5*p;if(kn.ortho(sg,-m,m,-m,m,.1,r.shadowCameraFar,o.capabilities.clipSpaceMinZ,o.capabilities.clipSpaceSignY),h>0){kn.multiply(lg,sg,_),yn.transformMat4(hg,Yv,lg);var v=2/h;_g.set(v,v);var g=hg.x%_g.x,y=hg.y%_g.y;fg.set(hg.x-g,hg.y-y,hg.z),kn.invert(ug,lg),yn.transformMat4(dg,fg,ug),kn.fromRT(rg,n.node.rotation,dg),kn.invert(og,rg),kn.invert(ag,og),Js.createOrtho(e,p,p,.1,r.shadowCameraFar,ag)}else{for(var x=0;x<8;x++)e.vertices[x].set(0,0,0);e.updatePlanes()}kn.multiply(cg,sg,og),r.matShadowView=og,r.matShadowProj=sg,r.matShadowViewProj=cg}}(ig,e,i,t,o);else{for(var u=0;u<8;u++)ig.vertices[u].set(0,0,0);ig.updatePlanes()}i&&o.type===Vv.Planar&&function(e,t){var n=e.pipelineSceneData.shadows,i=t.direction,r=n.normal,o=n.distance+.001,a=1/yn.dot(r,i),s=i.x*a,c=i.y*a,l=i.z*a,u=r.x,h=r.y,_=r.z,f=n.matLight;f.m00=1-u*s,f.m01=-u*c,f.m02=-u*l,f.m03=0,f.m04=-h*s,f.m05=1-h*c,f.m06=-h*l,f.m07=0,f.m08=-_*s,f.m09=-_*c,f.m10=1-_*l,f.m11=0,f.m12=s*o,f.m13=c*o,f.m14=l*o,f.m15=1,e.pipelineUBO.updateShadowUBORange(Td.MAT_LIGHT_PLANE_PROJ_OFFSET,n.matLight)}(e,i),a.enabled&&a.model&&t.clearFlag&Uv&&s.push(yg(a.model,t));for(var h=n.models,_=t.visibility,f=0;f<h.length;f++){var d=h[f];if(d.enabled&&(d.castShadow&&c.push(Sg(d,t)),o.firstSetCSM&&d.worldBounds&&(Zv||(Jv.copy(d.worldBounds),Zv=!0),Us.merge(Jv,Jv,d.worldBounds)),d.node&&(_&d.node.layer)===d.node.layer||_&d.visFlags)){if(null!=l&&d.castShadow&&d.worldBounds&&rs.aabbFrustum(d.worldBounds,ig)&&l.push(xg(d,t)),d.worldBounds&&!rs.aabbFrustum(d.worldBounds,t.frustum))continue;s.push(yg(d,t))}}}var Ag,wg=new pr(yi.LINEAR,yi.LINEAR,yi.NONE,xi.CLAMP,xi.CLAMP,xi.CLAMP),Ig=new pr(yi.POINT,yi.POINT,yi.NONE,xi.CLAMP,xi.CLAMP,xi.CLAMP),Pg=function(){function e(e){this._device=void 0,this._descriptorSetMap=new Map,this._globalDescriptorSet=void 0,this._descriptorSetLayout=void 0,this._linearSampler=void 0,this._pointSampler=void 0,this._device=e.device,this._linearSampler=this._device.getSampler(wg),this._pointSampler=this._device.getSampler(Ig);var t=new Br(hd.bindings);this._descriptorSetLayout=this._device.createDescriptorSetLayout(t),this._globalDescriptorSet=this._device.createDescriptorSet(new zr(this._descriptorSetLayout))}var t=e.prototype;return t.bindBuffer=function(e,t){this._globalDescriptorSet.bindBuffer(e,t);for(var n=this._descriptorSetMap.values(),i=n.next();!i.done;)i.value.bindBuffer(e,t),i=n.next()},t.bindSampler=function(e,t){this._globalDescriptorSet.bindSampler(e,t);for(var n=this._descriptorSetMap.values(),i=n.next();!i.done;)i.value.bindSampler(e,t),i=n.next()},t.bindTexture=function(e,t){this._globalDescriptorSet.bindTexture(e,t);for(var n=this._descriptorSetMap.values(),i=n.next();!i.done;)i.value.bindTexture(e,t),i=n.next()},t.update=function(){this._globalDescriptorSet.update();for(var e=this._descriptorSetMap.values(),t=e.next();!t.done;)t.value.update(),t=e.next()},t.getOrCreateDescriptorSet=function(e){var t=this._device;if(!this._descriptorSetMap.has(e)){var n=this._globalDescriptorSet,i=t.createDescriptorSet(new zr(this._descriptorSetLayout));this._descriptorSetMap.set(e,i);for(var r=ud.UBO_GLOBAL;r<ud.COUNT;r++)i.bindBuffer(r,n.getBuffer(r)),i.bindSampler(r,n.getSampler(r)),i.bindTexture(r,n.getTexture(r));var o=t.createBuffer(new cr(li.UNIFORM|li.TRANSFER_DST,_i.HOST|_i.DEVICE,Td.SIZE,Td.SIZE));i.bindBuffer(Td.BINDING,o),i.update()}return this._descriptorSetMap.get(e)},t.destroy=function(){this._descriptorSetLayout.destroy()},h(e,[{key:"descriptorSetMap",get:function(){return this._descriptorSetMap}},{key:"linearSampler",get:function(){return this._linearSampler}},{key:"pointSampler",get:function(){return this._pointSampler}},{key:"descriptorSetLayout",get:function(){return this._descriptorSetLayout}},{key:"globalDescriptorSet",get:function(){return this._globalDescriptorSet}}]),e}(),Rg=0,Dg={},Og=new zr(null),Ng=function(){function e(){this._device=null,this._passes=null,this._shaders=null,this._subMesh=null,this._patches=null,this._priority=ad.DEFAULT,this._inputAssembler=null,this._descriptorSet=null,this._worldBoundDescriptorSet=null,this._planarInstanceShader=null,this._planarShader=null,this._reflectionTex=null,this._reflectionSampler=null}var t=e.prototype;return t._destroyDescriptorSet=function(){this._descriptorSet.destroy(),this._descriptorSet=null},t._destroyWorldBoundDescriptorSet=function(){this._worldBoundDescriptorSet.destroy(),this._worldBoundDescriptorSet=null},t._destroyInputAssembler=function(){this._inputAssembler.destroy(),this._inputAssembler=null},t._createDescriptorSet=function(e){this._descriptorSet=this._device.createDescriptorSet(e)},t._createWorldBoundDescriptorSet=function(e){this._worldBoundDescriptorSet=this._device.createDescriptorSet(e)},t._setInputAssembler=function(e){this._inputAssembler=this._device.createInputAssembler(e)},t._setSubMesh=function(e){this._subMesh=e},t._init=function(){},t.initialize=function(e,t,n){void 0===n&&(n=null);var i=b.director.root;this._device=i.device,Og.layout=t[0].localSetLayout,this._init(),this._setInputAssembler(e.iaInfo),this._createDescriptorSet(Og);var r=b.director.root.pipeline.pipelineSceneData.getOcclusionQueryPass(),o=new zr(null);if(o.layout=r.localSetLayout,this._createWorldBoundDescriptorSet(o),this._setSubMesh(e),this._patches=n,this._passes=t,this._flushPassInfo(),t[0].batchingScheme===Zm.VB_MERGING&&(this.subMesh.genFlatBuffers(),this._setSubMesh(this.subMesh)),this.priority=ad.DEFAULT,t[0].phase===iv("reflection")){var a=i.mainWindow.width,s=i.mainWindow.height,c=512;s<a?(a=c*a/s,s=c):s=c*s/(a=c),this._reflectionTex=this._device.createTexture(new fr(fi.TEX2D,di.STORAGE|di.TRANSFER_SRC|di.SAMPLED,ai.RGBA8,a,s)),this.descriptorSet.bindTexture(_p,this._reflectionTex),this._reflectionSampler=this._device.getSampler(new pr(yi.LINEAR,yi.LINEAR,yi.NONE,xi.CLAMP,xi.CLAMP,xi.CLAMP)),this.descriptorSet.bindSampler(_p,this._reflectionSampler),this.descriptorSet.bindTexture(pp,this._reflectionTex)}},t._initNativePlanarShadowShader=function(e){this._planarShader=e.getPlanarShader(this._patches)},t.initPlanarShadowShader=function(){var e=b.director.root.pipeline.pipelineSceneData.shadows;this._initNativePlanarShadowShader(e)},t._initNativePlanarShadowInstanceShader=function(e){this._planarInstanceShader=e.getPlanarInstanceShader(this._patches)},t.initPlanarShadowInstanceShader=function(){var e=b.director.root.pipeline.pipelineSceneData.shadows;this._initNativePlanarShadowInstanceShader(e)},t._destroy=function(){},t.destroy=function(){this._destroyDescriptorSet(),this._destroyWorldBoundDescriptorSet(),this._destroyInputAssembler(),this.priority=ad.DEFAULT,this._patches=null,this._subMesh=null,this._passes=null,this._shaders=null,this._reflectionTex&&this._reflectionTex.destroy(),this._reflectionTex=null,this._reflectionSampler=null,this._destroy()},t.update=function(){for(var e=0;e<this._passes.length;++e)this._passes[e].update();this._descriptorSet.update(),this._worldBoundDescriptorSet.update()},t.onPipelineStateChanged=function(){var e=this._passes;if(e){for(var t=0;t<e.length;t++){var n=e[t];n.beginChangeStatesSilently(),n.tryCompile(),n.endChangeStatesSilently()}this._flushPassInfo()}},t.onMacroPatchesStateChanged=function(e){this._patches=e;var t=this._passes;if(t){for(var n=0;n<t.length;n++){var i=t[n];i.beginChangeStatesSilently(),i.tryCompile(),i.endChangeStatesSilently()}this._flushPassInfo()}},t._flushPassInfo=function(){var e=this._passes;if(e){this._shaders||(this._shaders=[]),this._shaders.length=e.length;for(var t=0,n=e.length;t<n;t++)this._shaders[t]=e[t].getShaderVariant(this.patches)}},h(e,[{key:"passes",get:function(){return this._passes},set:function(e){e.length>8?Y(12004,8):(this._passes=e,this._flushPassInfo(),this._passes[0].batchingScheme===Zm.VB_MERGING&&(this.subMesh.genFlatBuffers(),this._setSubMesh(this.subMesh)),this._descriptorSet&&(this._destroyDescriptorSet(),Og.layout=e[0].localSetLayout,this._createDescriptorSet(Og)))}},{key:"shaders",get:function(){return this._shaders}},{key:"subMesh",get:function(){return this._subMesh},set:function(e){this._inputAssembler.destroy(),this._inputAssembler.initialize(e.iaInfo),this._passes[0].batchingScheme===Zm.VB_MERGING&&this.subMesh.genFlatBuffers(),this._setSubMesh(e)}},{key:"priority",get:function(){return this._priority},set:function(e){this._priority=e}},{key:"inputAssembler",get:function(){return this._inputAssembler}},{key:"descriptorSet",get:function(){return this._descriptorSet}},{key:"worldBoundDescriptorSet",get:function(){return this._worldBoundDescriptorSet}},{key:"patches",get:function(){return this._patches}},{key:"planarInstanceShader",get:function(){return this._planarInstanceShader}},{key:"planarShader",get:function(){return this._planarShader}},{key:"native",get:function(){return this._nativeObj}}]),e}(),Mg=new kn,Lg=[{name:"CC_RECEIVE_SHADOW",value:!0}],Fg=[{name:"CC_USE_LIGHTMAP",value:!0}];!function(e){e[e.DEFAULT=0]="DEFAULT",e[e.SKINNING=1]="SKINNING",e[e.BAKED_SKINNING=2]="BAKED_SKINNING",e[e.BATCH_2D=3]="BATCH_2D",e[e.PARTICLE_BATCH=4]="PARTICLE_BATCH",e[e.LINE=5]="LINE"}(Ag||(Ag={}));var Bg=new pr(yi.LINEAR,yi.LINEAR,yi.NONE,xi.CLAMP,xi.CLAMP,xi.CLAMP),zg=new pr(yi.LINEAR,yi.LINEAR,yi.LINEAR,xi.CLAMP,xi.CLAMP,xi.CLAMP),Ug=function(){function e(){this.type=Ag.DEFAULT,this.scene=null,this.isDynamicBatching=!1,this.instancedAttributes={buffer:null,views:[],attributes:[]},this._worldBounds=null,this._modelBounds=null,this._subModels=[],this._node=null,this._transform=null,this._device=void 0,this._inited=!1,this._descriptorSetCount=1,this._updateStamp=-1,this._localDataUpdated=!0,this._localData=new Float32Array(Fd.COUNT),this._localBuffer=null,this._instMatWorldIdx=-1,this._lightmap=null,this._lightmapUVParam=new wn,this._worldBoundBuffer=null,this._receiveShadow=!1,this._castShadow=!1,this._shadowBias=0,this._shadowNormalBias=0,this._enabled=!0,this._visFlags=rd.Enum.NONE,this._device=b.director.root.device}var t=e.prototype;return t._setReceiveShadow=function(e){this._receiveShadow=e},t._init=function(){},t.initialize=function(){this._inited||(this._init(),this._setReceiveShadow(!0),this.castShadow=!1,this.enabled=!0,this.visFlags=rd.Enum.NONE,this._inited=!0)},t._destroySubmodel=function(e){e.destroy()},t._destroy=function(){},t.destroy=function(){for(var e=this._subModels,t=0;t<e.length;t++){var n=this._subModels[t];this._destroySubmodel(n)}this._localBuffer&&(this._localBuffer.destroy(),this._localBuffer=null),this._worldBoundBuffer&&(this._worldBoundBuffer.destroy(),this._worldBoundBuffer=null),this._worldBounds=null,this._modelBounds=null,this._subModels.length=0,this._inited=!1,this._localDataUpdated=!0,this._transform=null,this._node=null,this.isDynamicBatching=!1,this._destroy()},t.attachToScene=function(e){this.scene=e,this._localDataUpdated=!0},t.detachFromScene=function(){this.scene=null},t.updateTransform=function(){var e=this.transform;if(e.hasChangedFlags||e._dirtyFlags){e.updateWorldTransform(),this._localDataUpdated=!0;var t=this._worldBounds;this._modelBounds&&t&&this._modelBounds.transform(e._mat,e._pos,e._rot,e._scale,t)}},t.updateWorldBound=function(){var e=this.transform;if(null!==e){e.updateWorldTransform(),this._localDataUpdated=!0;var t=this._worldBounds;this._modelBounds&&t&&this._modelBounds.transform(e._mat,e._pos,e._rot,e._scale,t)}},t._applyLocalData=function(){},t._applyLocalBuffer=function(){},t._applyWorldBoundBuffer=function(){},t.updateUBOs=function(e){for(var t=this._subModels,n=0;n<t.length;n++)t[n].update();if(this._updateStamp=e,this._localDataUpdated){this._localDataUpdated=!1;var i=this.transform._mat,r=this._instMatWorldIdx;if(r>=0){var o=this.instancedAttributes.views;!function(e,t,n,i){t[0]=e.m00,t[1]=e.m01,t[2]=e.m02,t[3]=e.m12,n[0]=e.m04,n[1]=e.m05,n[2]=e.m06,n[3]=e.m13,i[0]=e.m08,i[1]=e.m09,i[2]=e.m10,i[3]=e.m14}(i,o[r],o[r+1],o[r+2])}else if(this._localBuffer){kn.toArray(this._localData,i,Fd.MAT_WORLD_OFFSET),kn.inverseTranspose(Mg,i);var a=Math.abs(kn.determinant(Mg)),s=1/Math.sqrt(a);kn.multiplyScalar(Mg,Mg,s),kn.toArray(this._localData,Mg,Fd.MAT_WORLD_IT_OFFSET),this._localBuffer.update(this._localData),this._applyLocalData(),this._applyLocalBuffer()}}},t._updateNativeBounds=function(){},t.createBoundingShape=function(e,t){e&&t&&(this._modelBounds=Us.fromPoints(Us.create(),e,t),this._worldBounds=Us.clone(this._modelBounds),this._updateNativeBounds())},t._createSubModel=function(){return new Ng},t.initSubModel=function(e,t,n){this.initialize(),null==this._subModels[e]?this._subModels[e]=this._createSubModel():this._subModels[e].destroy(),this._subModels[e].initialize(t,n.passes,this.getMacroPatches(e)),this._subModels[e].initPlanarShadowShader(),this._subModels[e].initPlanarShadowInstanceShader(),this._updateAttributesAndBinding(e)},t.setSubModelMesh=function(e,t){this._subModels[e]&&(this._subModels[e].subMesh=t)},t.setSubModelMaterial=function(e,t){this._subModels[e]&&(this._subModels[e].passes=t.passes,this._updateAttributesAndBinding(e))},t.onGlobalPipelineStateChanged=function(){for(var e=this._subModels,t=0;t<e.length;t++)e[t].onPipelineStateChanged()},t.onMacroPatchesStateChanged=function(){for(var e=this._subModels,t=0;t<e.length;t++)e[t].onMacroPatchesStateChanged(this.getMacroPatches(t))},t.updateLightingmap=function(e,t){wn.toArray(this._localData,t,Fd.LIGHTINGMAP_UVPARAM),this._localDataUpdated=!0,this._lightmap=e,this._lightmapUVParam=t,this.onMacroPatchesStateChanged(),null===e&&(e=nv.get("empty-texture"));var n=e.getGFXTexture();if(n)for(var i=this._device.getSampler(e.mipmaps.length>1?zg:Bg),r=this._subModels,o=0;o<r.length;o++){var a=r[o].descriptorSet;a.bindTexture(ap,n),a.bindSampler(ap,i),a.update()}},t.updateLocalShadowBias=function(){var e=this._localData;e[Fd.LOCAL_SHADOW_BIAS+0]=this._shadowBias,e[Fd.LOCAL_SHADOW_BIAS+1]=this._shadowNormalBias,e[Fd.LOCAL_SHADOW_BIAS+2]=0,e[Fd.LOCAL_SHADOW_BIAS+3]=0,this._localDataUpdated=!0},t.getMacroPatches=function(){var e=this.receiveShadow?Lg:null;return null!=this._lightmap&&(e=e?e.concat(Fg):Fg),e},t._updateAttributesAndBinding=function(e){var t=this._subModels[e];if(t){this._initLocalDescriptors(e),this._updateLocalDescriptors(e,t.descriptorSet),this._initWorldBoundDescriptors(e),this._updateWorldBoundDescriptors(e,t.worldBoundDescriptorSet);var n=t.passes[0].getShaderVariant(t.patches);this._updateInstancedAttributes(n.attributes,t.passes[0])}},t._getInstancedAttributeIndex=function(e){for(var t=this.instancedAttributes.attributes,n=0;n<t.length;n++)if(t[n].name===e)return n;return-1},t._setInstMatWorldIdx=function(e){this._instMatWorldIdx=e},t._updateInstancedAttributes=function(e,t){if(t.device.hasFeature(oi.INSTANCED_ARRAYS)){for(var n=0,i=0;i<e.length;i++){var r=e[i];r.isInstanced&&(n+=Kr[r.format].size)}var o=this.instancedAttributes;o.buffer=new Uint8Array(n),o.views.length=o.attributes.length=0;for(var a=0,s=0;s<e.length;s++){var c=e[s];if(c.isInstanced){var l=new br;l.format=c.format,l.name=c.name,l.isNormalized=c.isNormalized,l.location=c.location,o.attributes.push(l);var u=Kr[c.format],h=new(oo(u))(o.buffer.buffer,a,u.count);o.views.push(h),a+=u.size}}t.batchingScheme===Zm.INSTANCING&&t.getInstancedBuffer().destroy(),this._setInstMatWorldIdx(this._getInstancedAttributeIndex(zd)),this._localDataUpdated=!0}},t._initLocalDescriptors=function(){this._localBuffer||(this._localBuffer=this._device.createBuffer(new cr(li.UNIFORM|li.TRANSFER_DST,_i.DEVICE,Fd.SIZE,Fd.SIZE)),this._applyLocalBuffer())},t._initWorldBoundDescriptors=function(){this._worldBoundBuffer||(this._worldBoundBuffer=this._device.createBuffer(new cr(li.UNIFORM|li.TRANSFER_DST,_i.DEVICE,Bd.SIZE,Bd.SIZE)),this._applyWorldBoundBuffer())},t._updateLocalDescriptors=function(e,t){this._localBuffer&&t.bindBuffer(Fd.BINDING,this._localBuffer)},t._updateWorldBoundDescriptors=function(e,t){this._worldBoundBuffer&&t.bindBuffer(Bd.BINDING,this._worldBoundBuffer)},h(e,[{key:"subModels",get:function(){return this._subModels}},{key:"inited",get:function(){return this._inited}},{key:"worldBounds",get:function(){return this._worldBounds}},{key:"modelBounds",get:function(){return this._modelBounds}},{key:"localBuffer",get:function(){return this._localBuffer}},{key:"worldBoundBuffer",get:function(){return this._worldBoundBuffer}},{key:"updateStamp",get:function(){return this._updateStamp}},{key:"isInstancingEnabled",get:function(){return this._instMatWorldIdx>=0}},{key:"shadowBias",get:function(){return this._shadowBias},set:function(e){this._shadowBias=e}},{key:"shadowNormalBias",get:function(){return this._shadowNormalBias},set:function(e){this._shadowNormalBias=e}},{key:"receiveShadow",get:function(){return this._receiveShadow},set:function(e){this._setReceiveShadow(e),this.onMacroPatchesStateChanged()}},{key:"castShadow",get:function(){return this._castShadow},set:function(e){this._castShadow=e}},{key:"node",get:function(){return this._node},set:function(e){this._node=e}},{key:"transform",get:function(){return this._transform},set:function(e){this._transform=e}},{key:"visFlags",get:function(){return this._visFlags},set:function(e){this._visFlags=e}},{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled=e}},{key:"native",get:function(){return this._nativeObj}}]),e}(),kg=function(){function e(){this._groundAlbedoHDR=new wn(.2,.2,.2,1),this._skyColorHDR=new wn(.2,.5,.8,1),this._skyIllumHDR=0,this._groundAlbedoLDR=new wn(.2,.2,.2,1),this._skyColorLDR=new wn(.2,.5,.8,1),this._skyIllumLDR=0,this._enabled=!1}var t=e.prototype;return t.initialize=function(e){this._skyColorHDR=e.skyColorHDR,this._groundAlbedoHDR.set(e.groundAlbedoHDR),this._skyIllumHDR=e.skyIllumHDR,this._skyColorLDR=e.skyColorLDR,this._groundAlbedoLDR.set(e.groundAlbedoLDR),this._skyIllumLDR=e.skyIllumLDR},t._destroy=function(){},t.destroy=function(){this._destroy()},h(e,[{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled=e}},{key:"skyColor",get:function(){return b.director.root.pipeline.pipelineSceneData.isHDR?this._skyColorHDR:this._skyColorLDR},set:function(e){b.director.root.pipeline.pipelineSceneData.isHDR?this._skyColorHDR.set(e):this._skyColorLDR.set(e)}},{key:"skyIllum",get:function(){return b.director.root.pipeline.pipelineSceneData.isHDR?this._skyIllumHDR:this._skyIllumLDR},set:function(e){b.director.root.pipeline.pipelineSceneData.isHDR?this._skyIllumHDR=e:this._skyIllumLDR=e}},{key:"groundAlbedo",get:function(){return b.director.root.pipeline.pipelineSceneData.isHDR?this._groundAlbedoHDR:this._groundAlbedoLDR},set:function(e){b.director.root.pipeline.pipelineSceneData.isHDR?this._groundAlbedoHDR.set(e):this._groundAlbedoLDR.set(e)}},{key:"native",get:function(){return this._nativeObj}}]),e}();kg.SUN_ILLUM=65e3,kg.SKY_ILLUM=2e4,b.Ambient=kg;var Gg=function(e){function t(t,n){var i;(i=e.call(this,t.root)||this)._parent=void 0,i._owner=void 0,i._dontNotify=!1,i._parent=t,i._owner=n,i._doInit(i._parent,!0);for(var r=0;r<i._shaderInfo.blocks.length;r++){var o=i._shaderInfo.blocks[r],a=i._blocks[o.binding],s=i._parent.blocks[o.binding];a.set(s)}i._setRootBufferDirty(!0);for(var c=i._parent,l=0;l<i._shaderInfo.samplerTextures.length;l++)for(var u=i._shaderInfo.samplerTextures[l],h=0;h<u.count;h++){var _=c._descriptorSet.getSampler(u.binding,h),f=c._descriptorSet.getTexture(u.binding,h);i._descriptorSet.bindSampler(u.binding,_,h),i._descriptorSet.bindTexture(u.binding,f,h)}return e.prototype.tryCompile.call(y(i)),i}f(t,e);var n=t.prototype;return n.overridePipelineStates=function(e,t){this._bs.reset(),this._rs.reset(),this._dss.reset(),lv.fillPipelineInfo(this,e),lv.fillPipelineInfo(this,t),this._onStateChange()},n.tryCompile=function(t){if(t&&!Bp(this._defines,t))return!1;var n=e.prototype.tryCompile.call(this);return this._onStateChange(),n},n.beginChangeStatesSilently=function(){this._dontNotify=!0},n.endChangeStatesSilently=function(){this._dontNotify=!1},n._syncBatchingScheme=function(){this._defines.USE_BATCHING=this._defines.USE_INSTANCING=!1,this._setBatchingScheme(Zm.NONE)},n._onStateChange=function(){this._setHash(lv.getPassHash(this)),this._owner.onPassStateChange(this._dontNotify)},h(t,[{key:"parent",get:function(){return this._parent}}]),t}(lv),Hg=function(e){function t(t){var n;return(n=e.call(this)||this)._passes=[],n._parent=void 0,n._owner=void 0,n._subModelIdx=0,n._parent=t.parent,n._owner=t.owner||null,n._subModelIdx=t.subModelIdx||0,n.copy(n._parent),n}f(t,e);var n=t.prototype;return n.recompileShaders=function(e,t){if(this._passes&&this.effectAsset)if(void 0===t)for(var n,i=S(this._passes);!(n=i()).done;)n.value.tryCompile(e);else this._passes[t].tryCompile(e)},n.overridePipelineStates=function(e,t){if(this._passes&&this.effectAsset){var n=this.effectAsset.techniques[this.technique].passes;if(void 0===t)for(var i=0;i<this._passes.length;i++){var r=this._passes[i],o=this._states[i]||(this._states[i]={});for(var a in e)o[a]=e[a];r.overridePipelineStates(n[r.passIndex],o)}else{var s=this._states[t]||(this._states[t]={});for(var c in e)s[c]=e[c];this._passes[t].overridePipelineStates(n[t],s)}}},n.destroy=function(){return this._doDestroy(),!0},n.onPassStateChange=function(e){this._hash=Ov.getHash(this),!e&&this._owner&&this._owner._onRebuildPSO(this._subModelIdx,this)},n._createPasses=function(){var e=[],t=this._parent.passes;if(!t)return e;for(var n=0;n<t.length;++n)e.push(new Gg(t[n],this));return e},h(t,[{key:"parent",get:function(){return this._parent}},{key:"owner",get:function(){return this._owner}}]),t}(Ov),Vg=null,Wg=null,jg=Je({HEMISPHERE_DIFFUSE:0,AUTOGEN_HEMISPHERE_DIFFUSE_WITH_REFLECTION:1,DIFFUSEMAP_WITH_REFLECTION:2}),qg=function(){function e(){this._envmapLDR=null,this._envmapHDR=null,this._diffuseMapLDR=null,this._diffuseMapHDR=null,this._globalDSManager=null,this._model=null,this._default=null,this._enabled=!1,this._useIBL=!1,this._useHDR=!0,this._useDiffuseMap=!1}var t=e.prototype;return t._setEnabled=function(e){this._enabled=e},t._setUseIBL=function(e){this._useIBL=e},t._setUseHDR=function(e){this._useHDR=e},t._setUseDiffuseMap=function(e){this._useDiffuseMap=e},t.initialize=function(e){this._setEnabled(e.enabled),this._setUseIBL(e.useIBL),this._setUseDiffuseMap(e.applyDiffuseMap),this._setUseHDR(e.useHDR)},t.setEnvMaps=function(e,t){this._envmapHDR=e,this._envmapLDR=t,this._updateGlobalBinding(),this._updatePipeline()},t.setDiffuseMaps=function(e,t){this._diffuseMapHDR=e,this._diffuseMapLDR=t,this._updateGlobalBinding(),this._updatePipeline()},t.activate=function(){var e=b.director.root.pipeline;this._globalDSManager=e.globalDSManager,this._default=nv.get("default-cube-texture"),this._model||(this._model=b.director.root.createModel(b.renderer.scene.Model),this._model._initLocalDescriptors=function(){},this._model._initWorldBoundDescriptors=function(){});var t=this._default.isRGBE;if(this.envmap&&(t=this.envmap.isRGBE),!Wg){var n=new Ov;n.initialize({effectName:"skybox",defines:{USE_RGBE_CUBEMAP:t}}),Wg=new Hg({parent:n})}this.enabled&&(Vg||(Vg=b.utils.createMesh(b.primitives.box({width:2,height:2,length:2}))),this._model.initSubModel(0,Vg.renderingSubMeshes[0],Wg)),this.envmap||(this.envmap=this._default),this.diffuseMap||(this.diffuseMap=this._default),this._updateGlobalBinding(),this._updatePipeline()},t._updatePipeline=function(){var e=b.director.root,t=e.pipeline,n=this.useIBL?this.isRGBE?2:1:0,i=this.useIBL&&this.useDiffuseMap&&this.diffuseMap?this.isRGBE?2:1:0,r=this.useHDR;t.macros.CC_USE_IBL===n&&t.macros.CC_USE_DIFFUSEMAP===i&&t.macros.CC_USE_HDR===r||(t.macros.CC_USE_IBL=n,t.macros.CC_USE_DIFFUSEMAP=i,t.macros.CC_USE_HDR=r,e.onGlobalPipelineStateChanged()),this.enabled&&Wg&&Wg.recompileShaders({USE_RGBE_CUBEMAP:this.isRGBE}),this._model&&this._model.setSubModelMaterial(0,Wg)},t._updateGlobalBinding=function(){if(this._globalDSManager){var e=b.director.root.device,t=this.envmap?this.envmap:this._default;if(t){var n=t.getGFXTexture(),i=e.getSampler(t.getSamplerInfo());this._globalDSManager.bindSampler(wd,i),this._globalDSManager.bindTexture(wd,n)}var r=this.diffuseMap?this.diffuseMap:this._default;if(r){var o=r.getGFXTexture(),a=e.getSampler(r.getSamplerInfo());this._globalDSManager.bindSampler(Rd,a),this._globalDSManager.bindTexture(Rd,o)}this._globalDSManager.update()}},t._destroy=function(){},t.destroy=function(){this._destroy()},h(e,[{key:"model",get:function(){return this._model}},{key:"enabled",get:function(){return this._enabled},set:function(e){this._setEnabled(e),e?this.activate():this._updatePipeline()}},{key:"useHDR",get:function(){return this._useHDR},set:function(e){this._setUseHDR(e),this.setEnvMaps(this._envmapHDR,this._envmapLDR)}},{key:"useIBL",get:function(){return this._useIBL},set:function(e){this._setUseIBL(e),this._updatePipeline()}},{key:"useDiffuseMap",get:function(){return this._useDiffuseMap},set:function(e){this._useDiffuseMap=e,this._updatePipeline()}},{key:"isRGBE",get:function(){return!!this.envmap&&this.envmap.isRGBE}},{key:"envmap",get:function(){return b.director.root.pipeline.pipelineSceneData.isHDR?this._envmapHDR:this._envmapLDR},set:function(e){b.director.root.pipeline.pipelineSceneData.isHDR?this.setEnvMaps(e,this._envmapLDR):this.setEnvMaps(this._envmapHDR,e)}},{key:"diffuseMap",get:function(){return b.director.root.pipeline.pipelineSceneData.isHDR?this._diffuseMapHDR:this._diffuseMapLDR},set:function(e){b.director.root.pipeline.pipelineSceneData.isHDR?this.setDiffuseMaps(e,this._diffuseMapLDR):this.setDiffuseMaps(this._diffuseMapHDR,e)}},{key:"native",get:function(){return this._nativeObj}}]),e}();b.Skybox=qg;var Xg=new wn,Yg=Je({LINEAR:0,EXP:1,EXP_SQUARED:2,LAYERED:3}),Kg=Yg.LAYERED+1,Qg=function(){function e(){this._fogColor=new Qn("#C8C8C8"),this._colorArray=new wn(.2,.2,.2,1),this._enabled=!1,this._accurate=!1,this._type=0,this._fogDensity=.3,this._fogStart=.5,this._fogEnd=300,this._fogAtten=5,this._fogTop=1.5,this._fogRange=1.2}var t=e.prototype;return t._setType=function(e){this._type=this.enabled?e:Kg},t._setEnable=function(e){this._enabled=e},t._setAccurate=function(e){this._accurate=e},t.initialize=function(e){this.fogColor=e.fogColor,this._setEnable(e.enabled),this._setAccurate(e.accurate),this._setType(e.type),this.fogDensity=e.fogDensity,this.fogStart=e.fogStart,this.fogEnd=e.fogEnd,this.fogAtten=e.fogAtten,this.fogTop=e.fogTop,this.fogRange=e.fogRange},t.activate=function(){this._updatePipeline()},t._updatePipeline=function(){var e=b.director.root,t=this.enabled?this.type:Kg,n=this.accurate?1:0,i=e.pipeline;i.macros.CC_USE_FOG===t&&i.macros.CC_USE_ACCURATE_FOG===n||(i.macros.CC_USE_FOG=t,i.macros.CC_USE_ACCURATE_FOG=n,e.onGlobalPipelineStateChanged())},t._destroy=function(){},t.destroy=function(){this._destroy()},h(e,[{key:"enabled",get:function(){return this._enabled},set:function(e){this._setEnable(e),e?this.activate():(this._type=Kg,this._updatePipeline())}},{key:"accurate",get:function(){return this._accurate},set:function(e){this._setAccurate(e),this._updatePipeline()}},{key:"fogColor",get:function(){return this._fogColor},set:function(e){this._fogColor.set(e),Xg.set(e.x,e.y,e.z,e.w),fv(this._colorArray,Xg)}},{key:"type",get:function(){return this._type},set:function(e){this._setType(e),this.enabled&&this._updatePipeline()}},{key:"fogDensity",get:function(){return this._fogDensity},set:function(e){this._fogDensity=e}},{key:"fogStart",get:function(){return this._fogStart},set:function(e){this._fogStart=e}},{key:"fogEnd",get:function(){return this._fogEnd},set:function(e){this._fogEnd=e}},{key:"fogAtten",get:function(){return this._fogAtten},set:function(e){this._fogAtten=e}},{key:"fogTop",get:function(){return this._fogTop},set:function(e){this._fogTop=e}},{key:"fogRange",get:function(){return this._fogRange},set:function(e){this._fogRange=e}},{key:"colorArray",get:function(){return this._colorArray}},{key:"native",get:function(){return this._nativeObj}}]),e}();b.Fog=Qg;var Jg,Zg,$g,ey=function(){function e(){this._enabled=!1,this._minPos=new yn(0,0,0),this._maxPos=new yn(0,0,0),this._depth=0}var t=e.prototype;return t.initialize=function(e){this._enabled=e.enabled,this._minPos=e.minPos,this._maxPos=e.maxPos,this._depth=e.depth},t._destroy=function(){},t.destroy=function(){this._destroy()},h(e,[{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled=e}},{key:"minPos",get:function(){return this._minPos},set:function(e){this._minPos=e}},{key:"maxPos",get:function(){return this._maxPos},set:function(e){this._maxPos=e}},{key:"depth",get:function(){return this._depth},set:function(e){this._depth=e}},{key:"native",get:function(){return this._nativeObj}}]),e}();function ty(e,t){t<1e3?t=1e3:t>15e3&&(t=15e3);var n=t*t,i=(.860117757+.000154118254*t+1.28641212e-7*n)/(1+.000842420235*t+7.08145163e-7*n),r=(.317398726+422806245e-13*t+4.20481691e-8*n)/(1-289741816e-13*t+1.61456053e-7*n),o=2*i-8*r+4,a=3*i/o,s=2*r/o,c=1/s*a,l=1/s*(1-a-s);e.x=3.2404542*c-1.5371385+-.4985314*l,e.y=-.969266*c+1.8760108+.041556*l,e.z=.0556434*c-.2040259+1.0572252*l}!function(e){e[e.LOCAL=0]="LOCAL",e[e.WORLD=1]="WORLD"}(Jg||(Jg=e("NodeSpace",{}))),function(e){e[e.NONE=0]="NONE",e[e.POSITION=1]="POSITION",e[e.ROTATION=2]="ROTATION",e[e.SCALE=4]="SCALE",e[e.RS=e.ROTATION|e.SCALE]="RS",e[e.TRS=e.POSITION|e.ROTATION|e.SCALE]="TRS",e[e.TRS_MASK=~e.TRS]="TRS_MASK"}(Zg||(Zg=e("TransformBit",{}))),b.internal.TransformBit=Zg,function(e){e[e.DIRECTIONAL=0]="DIRECTIONAL",e[e.SPHERE=1]="SPHERE",e[e.SPOT=2]="SPOT",e[e.UNKNOWN=3]="UNKNOWN"}($g||($g={}));var ny,iy,ry=function(e){return 4*Math.PI*Math.PI*e*e},oy=function(){function e(){this._baked=!1,this._color=new yn(1,1,1),this._colorTemp=6550,this._colorTempRGB=new yn(1,1,1),this._scene=null,this._node=null,this._name=null,this._useColorTemperature=!1,this._type=$g.UNKNOWN}var t=e.prototype;return t._init=function(){},t._destroy=function(){},t.initialize=function(){this._init(),this.color=new yn(1,1,1),this.colorTemperature=6550},t.attachToScene=function(e){this._scene=e},t.detachFromScene=function(){this._scene=null},t.destroy=function(){this._name=null,this._node=null,this._destroy()},t.update=function(){},h(e,[{key:"baked",get:function(){return this._baked},set:function(e){this._baked=e}},{key:"color",get:function(){return this._color},set:function(e){this._color.set(e)}},{key:"useColorTemperature",get:function(){return this._useColorTemperature},set:function(e){this._useColorTemperature=e}},{key:"colorTemperature",get:function(){return this._colorTemp},set:function(e){this._colorTemp=e,ty(this._colorTempRGB,this._colorTemp)}},{key:"colorTemperatureRGB",get:function(){return this._colorTempRGB}},{key:"node",get:function(){return this._node},set:function(e){this._node=e,this._node&&(this._node.hasChangedFlags|=Zg.ROTATION)}},{key:"type",get:function(){return this._type}},{key:"name",get:function(){return this._name},set:function(e){this._name=e}},{key:"scene",get:function(){return this._scene}},{key:"native",get:function(){return this._nativeObj}}]),e}(),ay=new yn(0,0,-1),sy=new yn,cy=function(e){function t(){var t;return(t=e.call(this)||this)._dir=new yn(1,-1,-1),t._illuminanceHDR=kg.SUN_ILLUM,t._illuminanceLDR=1,t._shadowEnabled=!1,t._shadowPcf=Wv.HARD,t._shadowBias=1e-5,t._shadowNormalBias=0,t._shadowSaturation=1,t._shadowDistance=100,t._shadowInvisibleOcclusionRange=200,t._shadowFixedArea=!1,t._shadowNear=.1,t._shadowFar=10,t._shadowOrthoSize=5,t._type=$g.DIRECTIONAL,t}f(t,e);var n=t.prototype;return n.initialize=function(){e.prototype.initialize.call(this),this.illuminance=kg.SUN_ILLUM,this.direction=new yn(1,-1,-1)},n.update=function(){this._node&&this._node.hasChangedFlags&&(this.direction=yn.transformQuat(sy,ay,this._node.worldRotation))},h(t,[{key:"direction",get:function(){return this._dir},set:function(e){yn.normalize(this._dir,e)}},{key:"illuminance",get:function(){return b.director.root.pipeline.pipelineSceneData.isHDR?this._illuminanceHDR:this._illuminanceLDR},set:function(e){b.director.root.pipeline.pipelineSceneData.isHDR?this.illuminanceHDR=e:this.illuminanceLDR=e}},{key:"illuminanceHDR",get:function(){return this._illuminanceHDR},set:function(e){this._illuminanceHDR=e}},{key:"illuminanceLDR",get:function(){return this._illuminanceLDR},set:function(e){this._illuminanceLDR=e}},{key:"shadowEnabled",get:function(){return this._shadowEnabled},set:function(e){this._shadowEnabled=e}},{key:"shadowPcf",get:function(){return this._shadowPcf},set:function(e){this._shadowPcf=e}},{key:"shadowBias",get:function(){return this._shadowBias},set:function(e){this._shadowBias=e}},{key:"shadowNormalBias",get:function(){return this._shadowNormalBias},set:function(e){this._shadowNormalBias=e}},{key:"shadowSaturation",get:function(){return this._shadowSaturation},set:function(e){this._shadowSaturation=e}},{key:"shadowDistance",get:function(){return this._shadowDistance},set:function(e){this._shadowDistance=Math.min(e,qv.MAX_FAR)}},{key:"shadowInvisibleOcclusionRange",get:function(){return this._shadowInvisibleOcclusionRange},set:function(e){this._shadowInvisibleOcclusionRange=Math.min(e,qv.MAX_FAR)}},{key:"shadowFixedArea",get:function(){return this._shadowFixedArea},set:function(e){this._shadowFixedArea=e}},{key:"shadowNear",get:function(){return this._shadowNear},set:function(e){this._shadowNear=e}},{key:"shadowFar",get:function(){return this._shadowFar},set:function(e){this._shadowFar=Math.min(e,qv.MAX_FAR)}},{key:"shadowOrthoSize",get:function(){return this._shadowOrthoSize},set:function(e){this._shadowOrthoSize=e}}]),t}(oy),ly=function(e){f(n,e);var t=n.prototype;function n(){var t;return(t=e.call(this)||this)._needUpdate=!1,t._size=.15,t._range=1,t._luminanceHDR=0,t._luminanceLDR=0,t._pos=void 0,t._aabb=void 0,t._aabb=Us.create(),t._pos=new yn,t._type=$g.SPHERE,t}return t._init=function(){e.prototype._init.call(this)},t._destroy=function(){e.prototype._destroy.call(this)},t.initialize=function(){e.prototype.initialize.call(this),this.size=.15,this.range=1,this.luminanceHDR=1700/ry(.15),this.luminanceLDR=1},t.update=function(){if(this._node&&(this._node.hasChangedFlags||this._needUpdate)){this._node.getWorldPosition(this._pos);var e=this._range;Us.set(this._aabb,this._pos.x,this._pos.y,this._pos.z,e,e,e),this._needUpdate=!1}},h(n,[{key:"position",get:function(){return this._pos}},{key:"size",get:function(){return this._size},set:function(e){this._size=e}},{key:"range",get:function(){return this._range},set:function(e){this._range=e,this._needUpdate=!0}},{key:"luminance",get:function(){return b.director.root.pipeline.pipelineSceneData.isHDR?this._luminanceHDR:this._luminanceLDR},set:function(e){b.director.root.pipeline.pipelineSceneData.isHDR?this.luminanceHDR=e:this.luminanceLDR=e}},{key:"luminanceHDR",get:function(){return this._luminanceHDR},set:function(e){this._luminanceHDR=e}},{key:"luminanceLDR",set:function(e){this._luminanceLDR=e}},{key:"aabb",get:function(){return this._aabb}}]),n}(oy),uy=new yn(0,0,-1),hy=new On,_y=new kn,fy=new kn,dy=new kn,py=new kn,my=function(e){f(n,e);var t=n.prototype;function n(){var t;return(t=e.call(this)||this)._dir=new yn(1,-1,-1),t._range=5,t._spotAngle=Math.cos(Math.PI/6),t._pos=void 0,t._aabb=void 0,t._frustum=void 0,t._angle=0,t._needUpdate=!1,t._size=.15,t._luminanceHDR=0,t._luminanceLDR=0,t._shadowEnabled=!1,t._shadowPcf=Wv.HARD,t._shadowBias=1e-5,t._shadowNormalBias=0,t._aabb=Us.create(),t._frustum=Js.create(),t._pos=new yn,t._type=$g.SPOT,t}return t._init=function(){e.prototype._init.call(this)},t._destroy=function(){e.prototype._destroy.call(this)},t._setDirection=function(e){this._dir.set(e)},t.initialize=function(){e.prototype.initialize.call(this),this.size=.15,this.luminanceHDR=1700/ry(.15),this.luminanceLDR=1,this.range=Math.cos(Math.PI/6),this._setDirection(new yn(1,-1,-1))},t.update=function(){this._node&&(this._node.hasChangedFlags||this._needUpdate)&&(this._node.getWorldPosition(this._pos),yn.transformQuat(this._dir,uy,this._node.getWorldRotation(hy)),yn.normalize(this._dir,this._dir),Us.set(this._aabb,this._pos.x,this._pos.y,this._pos.z,this._range,this._range,this._range),this._node.getWorldRT(_y),kn.invert(_y,_y),kn.perspective(fy,this._angle,1,.001,this._range),kn.multiply(dy,fy,_y),this._frustum.update(dy,py),this._needUpdate=!1)},h(n,[{key:"position",get:function(){return this._pos}},{key:"size",get:function(){return this._size},set:function(e){this._size=e}},{key:"range",get:function(){return this._range},set:function(e){this._range=e,this._needUpdate=!0}},{key:"luminance",get:function(){return b.director.root.pipeline.pipelineSceneData.isHDR?this._luminanceHDR:this._luminanceLDR},set:function(e){b.director.root.pipeline.pipelineSceneData.isHDR?this.luminanceHDR=e:this.luminanceLDR=e}},{key:"luminanceHDR",get:function(){return this._luminanceHDR},set:function(e){this._luminanceHDR=e}},{key:"luminanceLDR",get:function(){return this._luminanceLDR},set:function(e){this._luminanceLDR=e}},{key:"direction",get:function(){return this._dir}},{key:"spotAngle",get:function(){return this._spotAngle},set:function(e){this._angle=e,this._spotAngle=Math.cos(.5*e),this._needUpdate=!0}},{key:"angle",get:function(){return this._angle}},{key:"aabb",get:function(){return this._aabb}},{key:"frustum",get:function(){return this._frustum}},{key:"shadowEnabled",get:function(){return this._shadowEnabled},set:function(e){this._shadowEnabled=e}},{key:"shadowPcf",get:function(){return this._shadowPcf},set:function(e){this._shadowPcf=e}},{key:"shadowBias",get:function(){return this._shadowBias},set:function(e){this._shadowBias=e}},{key:"shadowNormalBias",get:function(){return this._shadowNormalBias},set:function(e){this._shadowNormalBias=e}}]),n}(oy),vy=function(){function e(e){this._root=void 0,this._name="",this._cameras=[],this._models=[],this._batches=[],this._directionalLights=[],this._sphereLights=[],this._spotLights=[],this._mainLight=null,this._modelId=0,this._root=e,this._createNativeObject()}e.registerCreateFunc=function(t){t._createSceneFun=function(t){return new e(t)}};var t=e.prototype;return t.initialize=function(e){return this._name=e.name,!0},t.activate=function(){},t.update=function(e){var t=this._mainLight;t&&t.update();for(var n=this._sphereLights,i=0;i<n.length;i++)n[i].update();for(var r=this._spotLights,o=0;o<r.length;o++)r[o].update();for(var a=this._models,s=0;s<a.length;s++){var c=a[s];c.enabled&&(c.updateTransform(e),c.updateUBOs(e))}},t.destroy=function(){this.removeCameras(),this.removeSphereLights(),this.removeSpotLights(),this.removeModels(),this._destroy()},t.addCamera=function(e){e.attachToScene(this),this._cameras.push(e)},t.removeCamera=function(e){for(var t=0;t<this._cameras.length;++t)if(this._cameras[t]===e)return this._cameras.splice(t,1),void e.detachFromScene()},t.removeCameras=function(){for(var e,t=S(this._cameras);!(e=t()).done;)e.value.detachFromScene();this._cameras.splice(0)},t.setMainLight=function(e){this._mainLight=e},t.unsetMainLight=function(e){if(this._mainLight===e){var t=this._directionalLights;if(t.length)return this.setMainLight(t[t.length-1]),void(this._mainLight.node&&(this._mainLight.node.hasChangedFlags|=Zg.ROTATION));this.setMainLight(null)}},t.addDirectionalLight=function(e){e.attachToScene(this),this._directionalLights.push(e)},t.removeDirectionalLight=function(e){for(var t=0;t<this._directionalLights.length;++t)if(this._directionalLights[t]===e)return e.detachFromScene(),void this._directionalLights.splice(t,1)},t.addSphereLight=function(e){e.attachToScene(this),this._sphereLights.push(e)},t.removeSphereLight=function(e){for(var t=0;t<this._sphereLights.length;++t)if(this._sphereLights[t]===e)return e.detachFromScene(),void this._sphereLights.splice(t,1)},t.addSpotLight=function(e){e.attachToScene(this),this._spotLights.push(e)},t.removeSpotLight=function(e){for(var t=0;t<this._spotLights.length;++t)if(this._spotLights[t]===e)return e.detachFromScene(),void this._spotLights.splice(t,1)},t.removeSphereLights=function(){for(var e=0;e<this._sphereLights.length;++e)this._sphereLights[e].detachFromScene();this._sphereLights.length=0},t.removeSpotLights=function(){for(var e=0;e<this._spotLights.length;++e)this._spotLights[e].detachFromScene();this._spotLights=[]},t.addModel=function(e){e.attachToScene(this),this._models.push(e)},t.removeModel=function(e){for(var t=0;t<this._models.length;++t)if(this._models[t]===e)return e.detachFromScene(),void this._models.splice(t,1)},t.removeModels=function(){for(var e,t=S(this._models);!(e=t()).done;){var n=e.value;n.detachFromScene(),n.destroy()}this._models.length=0},t.addBatch=function(e){this._batches.push(e)},t.removeBatch=function(e){for(var t=0;t<this._batches.length;++t)if(this._batches[t]===e)return void this._batches.splice(t,1)},t.removeBatches=function(){this._batches.length=0},t.onGlobalPipelineStateChanged=function(){for(var e,t=S(this._models);!(e=t()).done;)e.value.onGlobalPipelineStateChanged()},t.generateModelId=function(){return this._modelId++},t._destroy=function(){},t._createNativeObject=function(){},h(e,[{key:"root",get:function(){return this._root}},{key:"name",get:function(){return this._name}},{key:"cameras",get:function(){return this._cameras}},{key:"mainLight",get:function(){return this._mainLight}},{key:"sphereLights",get:function(){return this._sphereLights}},{key:"spotLights",get:function(){return this._spotLights}},{key:"models",get:function(){return this._models}},{key:"batches",get:function(){return this._batches}},{key:"native",get:function(){return this._nativeObj}}]),e}(),gy=Object.freeze({__proto__:null,get CameraFOVAxis(){return Av},get CameraProjection(){return wv},get CameraAperture(){return Iv},get CameraISO(){return Pv},get CameraShutter(){return Rv},SKYBOX_FLAG:Uv,Camera:Gv,get ModelType(){return Ag},Model:Ug,SubModel:Ng,Ambient:kg,EnvironmentLightingType:jg,Skybox:qg,ShadowSize:Hv,ShadowType:Vv,PCFType:Wv,Shadows:qv,FogType:Yg,Fog:Qg,Octree:ey,ColorTemperatureToRGB:ty,get LightType(){return $g},nt2lm:ry,Light:oy,DirectionalLight:cy,SphereLight:ly,SpotLight:my,RenderScene:vy});function yy(e){return--e,e|=e>>16,e|=e>>8,e|=e>>4,e|=e>>2,e|=e>>1,++e}function xy(e,t){return Math.ceil(e/t)*t}!function(e){e[e.OPAQUE=0]="OPAQUE",e[e.TRANSPARENT=1]="TRANSPARENT",e[e.OVERLAY=2]="OVERLAY"}(ny||(ny={})),function(e){e[e.DEFAULT=1]="DEFAULT",e[e.FORWARD=2]="FORWARD",e[e.SHADOWCAST=4]="SHADOWCAST"}(iy||(iy={}));var Sy=function(){function e(e){this._device=void 0,this._format=ai.UNKNOWN,this._formatSize=0,this._chunks=[],this._chunkCount=0,this._handles=[],this._region0=new nr,this._region1=new nr,this._region2=new nr,this._roundUpFn=null,this._bufferViewCtor=Uint8Array,this._channels=4,this._alignment=1,this._device=e}var t=e.prototype;return t.initialize=function(e){var t=Kr[e.format];this._format=e.format,this._formatSize=t.size,this._channels=t.count,this._bufferViewCtor=oo(t),this._roundUpFn=e.roundUpFn||null,this._alignment=e.alignment||1,e.inOrderFree&&(this.alloc=this._McDonaldAlloc)},t.destroy=function(){for(var e=0;e<this._chunkCount;++e)this._chunks[e].texture.destroy();this._chunks.length=0,this._handles.length=0},t.alloc=function(e,t){e=xy(e,this._alignment);var n=-1,i=-1;if(void 0!==t&&(n=t,i=this._findAvailableSpace(e,n)),i<0)for(var r=0;r<this._chunkCount&&(n=r,!((i=this._findAvailableSpace(e,n))>=0));++r);if(i>=0){var o=this._chunks[n];o.start+=e;var a={chunkIdx:n,start:i,end:i+e,texture:o.texture};return this._handles.push(a),a}var s=Math.sqrt(e/this._formatSize),c=this._roundUpFn&&this._roundUpFn(s,this._formatSize)||Math.max(1024,yy(s)),l=this._chunks[this.createChunk(c)];l.start+=e;var u={chunkIdx:this._chunkCount-1,start:0,end:e,texture:l.texture};return this._handles.push(u),u},t.free=function(e){for(var t=0;t<this._handles.length;++t)if(this._handles[t]===e)return this._chunks[e.chunkIdx].end=e.end,void this._handles.splice(t,1)},t.createChunk=function(e){var t=e*e*this._formatSize;U("TextureBufferPool: Allocate chunk "+this._chunkCount+", size: "+t+", format: "+this._format);var n={texture:this._device.createTexture(new fr(fi.TEX2D,di.SAMPLED|di.TRANSFER_DST,this._format,e,e)),size:t,start:0,end:t};return this._chunks[this._chunkCount]=n,this._chunkCount++},t.update=function(e,t){var n=[],i=[],r=e.start/this._formatSize,o=t.byteLength/this._formatSize,a=r%e.texture.width,s=Math.floor(r/e.texture.width),c=Math.min(e.texture.width-a,o),l=0;a>0&&(this._region0.texOffset.x=a,this._region0.texOffset.y=s,this._region0.texExtent.width=c,this._region0.texExtent.height=1,n.push(new this._bufferViewCtor(t,l*this._formatSize,c*this._channels)),i.push(this._region0),a=0,s+=1,o-=c,l+=c),o>0&&(this._region1.texOffset.x=a,this._region1.texOffset.y=s,o>e.texture.width?(this._region1.texExtent.width=e.texture.width,this._region1.texExtent.height=Math.floor(o/e.texture.width),c=this._region1.texExtent.width*this._region1.texExtent.height):(c=o,this._region1.texExtent.width=c,this._region1.texExtent.height=1),n.push(new this._bufferViewCtor(t,l*this._formatSize,c*this._channels)),i.push(this._region1),a=0,s+=this._region1.texExtent.height,o-=c,l+=c),o>0&&(this._region2.texOffset.x=a,this._region2.texOffset.y=s,this._region2.texExtent.width=o,this._region2.texExtent.height=1,n.push(new this._bufferViewCtor(t,l*this._formatSize,o*this._channels)),i.push(this._region2)),this._device.copyBuffersToTexture(n,e.texture,i)},t._findAvailableSpace=function(e,t){var n=this._chunks[t],i=!1,r=n.start;if(r+e<=n.size)i=!0;else{r=0;for(var o=this._handles.filter((function(e){return e.chunkIdx===t})).sort((function(e,t){return e.start-t.start})),a=0;a<o.length;a++){var s=o[a];if(r+e<=s.start){i=!0;break}r=s.end}!i&&r+e<=n.size&&(i=!0)}return i?r:-1},t._McDonaldAlloc=function(e){e=xy(e,this._alignment);for(var t=0;t<this._chunkCount;++t){var n=this._chunks[t],i=!1,r=n.start;if(r+e<=n.end?i=!0:r>n.end?r+e<=n.size?i=!0:e<=n.end&&(n.start=r=0,i=!0):r===n.end&&(n.start=r=0,n.end=n.size,e<=n.end&&(i=!0)),i){n.start+=e;var o={chunkIdx:t,start:r,end:r+e,texture:n.texture};return this._handles.push(o),o}}var a=Math.sqrt(e/this._formatSize),s=this._roundUpFn&&this._roundUpFn(a,this._formatSize)||Math.max(1024,yy(a)),c=this._chunks[this.createChunk(s)];c.start+=e;var l={chunkIdx:this._chunkCount,start:0,end:e,texture:c.texture};return this._handles.push(l),l},e}(),Ey=function(e){if(void 0===Dg[e]){var t=1<<Rg;Dg[e]=t,Rg+=1}},Ty=Object.freeze({__proto__:null,addStage:Ey,scene:gy,createIA:function(e,t){if(!t.positions)return console.error("The data must have positions field"),null;for(var n=[],i=t.positions.length/3,r=0;r<i;++r)n.push(t.positions[3*r],t.positions[3*r+1],t.positions[3*r+2]),t.normals&&n.push(t.normals[3*r],t.normals[3*r+1],t.normals[3*r+2]),t.uvs&&n.push(t.uvs[2*r],t.uvs[2*r+1]),t.colors&&n.push(t.colors[3*r],t.colors[3*r+1],t.colors[3*r+2]);var o=[];o.push(new br(qi.ATTR_POSITION,ai.RGB32F)),t.normals&&o.push(new br(qi.ATTR_NORMAL,ai.RGB32F)),t.uvs&&o.push(new br(qi.ATTR_TEX_COORD,ai.RG32F)),t.colors&&o.push(new br(qi.ATTR_COLOR,ai.RGB32F));var a=e.createBuffer(new cr(li.VERTEX|li.TRANSFER_DST,_i.DEVICE,4*n.length,4*n.length/i));a.update(new Float32Array(n));var s=null;return t.indices&&(s=e.createBuffer(new cr(li.INDEX|li.TRANSFER_DST,_i.DEVICE,2*t.indices.length,2))).update(new Uint16Array(t.indices)),e.createInputAssembler(new wr(o,[a],s))},get RenderQueue(){return ny},get PassStage(){return iy},genHandle:wp,getTypeFromHandle:Ip,getBindingFromHandle:Pp,getCountFromHandle:Rp,getOffsetFromHandle:Dp,customizeType:Op,type2reader:Np,type2writer:Mp,getDefaultFromType:Fp,overrideMacros:Bp,get BatchingSchemes(){return Zm},Pass:lv,getDeviceShaderVersion:Wp,programLib:$p,nearestPOT:yy,TextureBufferPool:Sy,MaterialInstance:Hg,PassInstance:Gg,get PoolType(){return ys},NULL_HANDLE:0,get NodeView(){return xs},NodePool:bs,get PassView(){return Es},PassPool:Ps,get AABBView(){return As},AABBPool:Os,RenderScene:vy,NativeNode:null,NativeScene:null,NativeAABB:null,NativeModel:null,NativeSkinningModel:null,NativeBakedAnimInfo:null,NativeBakedJointInfo:null,NativeBakedSkinningModel:null,NativeLight:null,NativeDirectionalLight:null,NativeSphereLight:null,NativeSpotLight:null,NaitveSkybox:null,NativeFog:null,NativeRenderWindow:null,NativeCamera:null,NativePass:null,NativeSubModel:null,NativeDrawBatch2D:null,NativeRenderScene:null,NativeOctree:null,NativeAmbient:null,NativeShadow:null,NativeRoot:null,NativeJointTransform:null,NativeJointInfo:null,NativePipelineSharedSceneData:null,NativeGeometryRenderer:null});e("renderer",Ty);var Cy,by=new yn,Ay=new yn,wy=new yn,Iy=new yn,Py=new yn,Ry=new yn,Dy=new yn,Oy=new yn,Ny=new yn,My=new yn;!function(e){e[e.LINE=0]="LINE",e[e.DASHED_LINE=1]="DASHED_LINE",e[e.TRIANGLE=2]="TRIANGLE"}(Cy||(Cy={}));var Ly,Fy,By,zy,Uy,ky,Gy,Hy,Vy,Wy,jy=function(){function e(){this._maxVertices=0,this._vertexCount=0,this._stride=0}var t=e.prototype;return t.init=function(e,t,n,i){this._maxVertices=t,this._vertexCount=0,this._stride=n,this._vertices=new Float32Array(t*n/Float32Array.BYTES_PER_ELEMENT),this._buffer=e.createBuffer(new cr(li.VERTEX|li.TRANSFER_DST,_i.DEVICE,t*n,n)),this._inputAssembler=e.createInputAssembler(new wr(i,[this._buffer],null))},t.empty=function(){return 0===this._vertexCount},t.reset=function(){this._vertexCount=0},t.update=function(){if(!this.empty()){var e=Math.min(this._vertexCount,this._maxVertices)*this._stride;this._buffer.update(this._vertices,e)}},t.destroy=function(){this._inputAssembler&&this._inputAssembler.destroy(),this._buffer&&this._buffer.destroy()},e}(),qy=function(){this.lines=[],this.dashedLines=[],this.triangles=[];for(var e=0;e<2;e++)this.lines[e]=new jy,this.dashedLines[e]=new jy,this.triangles[e]=new jy},Xy=function(){function e(){this._device=null,this._pipeline=null,this._buffers=void 0,this._nativeObj=null,this._buffers=new qy}var t=e.prototype;return t.activate=function(e,t,n){this._device=e,this._pipeline=t;for(var i=[new br(qi.ATTR_POSITION,ai.RGB32F),new br(qi.ATTR_COLOR,ai.RGBA32F)],r=[new br(qi.ATTR_POSITION,ai.RGB32F),new br(qi.ATTR_NORMAL,ai.RGBA32F),new br(qi.ATTR_COLOR,ai.RGBA32F)],o=n?n.maxLines:1e5,a=n?n.maxDashedLines:1e4,s=n?n.maxTriangles:1e4,c=Float32Array.BYTES_PER_ELEMENT*(yn.length+Qn.length),l=Float32Array.BYTES_PER_ELEMENT*(yn.length+wn.length+Qn.length),u=0;u<2;u++)this._buffers.lines[u].init(this._device,2*o,c,i),this._buffers.dashedLines[u].init(this._device,2*a,c,i),this._buffers.triangles[u].init(this._device,3*s,l,r)},t.flush=function(){},t.render=function(e,t){this.update();for(var n=this._pipeline.pipelineSceneData.geometryRendererPasses,i=this._pipeline.pipelineSceneData.geometryRendererShaders,r=0,o=[1,2],a=0;a<2;a++){var s=this._buffers.lines[a];if(!s.empty()){var c=new ur;c.vertexCount=s._vertexCount;for(var l=0;l<o[a];l++){var u=n[r+l],h=i[r+l],_=uv.getOrCreatePipelineState(this._device,u,h,e,s._inputAssembler);t.bindPipelineState(_),t.bindDescriptorSet(md.MATERIAL,u.descriptorSet),t.bindInputAssembler(s._inputAssembler),t.draw(c)}}r+=o[a]}for(var f=0;f<2;f++){var d=this._buffers.dashedLines[f];if(!d.empty()){var p=new ur;p.vertexCount=d._vertexCount;for(var m=0;m<o[f];m++){var v=n[r+m],g=i[r+m],y=uv.getOrCreatePipelineState(this._device,v,g,e,d._inputAssembler);t.bindPipelineState(y),t.bindDescriptorSet(md.MATERIAL,v.descriptorSet),t.bindInputAssembler(d._inputAssembler),t.draw(p)}}r+=o[f]}for(var x=0;x<2;x++){var S=this._buffers.triangles[x];if(!S.empty()){var E=new ur;E.vertexCount=S._vertexCount;for(var T=0;T<o[x];T++){var C=n[r+T],b=i[r+T],A=uv.getOrCreatePipelineState(this._device,C,b,e,S._inputAssembler);t.bindPipelineState(A),t.bindDescriptorSet(md.MATERIAL,C.descriptorSet),t.bindInputAssembler(S._inputAssembler),t.draw(E)}}r+=o[x]}this.reset()},t.destroy=function(){for(var e=0;e<2;e++)this._buffers.lines[e].destroy(),this._buffers.dashedLines[e].destroy(),this._buffers.triangles[e].destroy()},t.empty=function(){for(var e=0;e<2;e++)if(!this._buffers.lines[e].empty()||!this._buffers.dashedLines[e].empty()||!this._buffers.triangles[e].empty())return!1;return!0},t.update=function(){for(var e=0;e<2;e++)this._buffers.lines[e].update(),this._buffers.dashedLines[e].update(),this._buffers.triangles[e].update()},t.reset=function(){for(var e=0;e<2;e++)this._buffers.lines[e].reset(),this._buffers.dashedLines[e].reset(),this._buffers.triangles[e].reset()},t.addDashedLine=function(e,t,n,i){void 0===i&&(i=!0);var r=this._buffers.dashedLines[i?1:0];if(r._vertexCount+2>r._maxVertices)q(12008);else{var o=r._vertexCount*(yn.length+Qn.length);yn.toArray(r._vertices,e,o),o+=yn.length,Qn.toArray(r._vertices,n,o),o+=Qn.length,yn.toArray(r._vertices,t,o),o+=yn.length,Qn.toArray(r._vertices,n,o),r._vertexCount+=2}},t.addLine=function(e,t,n,i){void 0===i&&(i=!0);var r=this._buffers.lines[i?1:0];if(r._vertexCount+2>r._maxVertices)q(12008);else{var o=r._vertexCount*(yn.length+Qn.length);yn.toArray(r._vertices,e,o),o+=yn.length,Qn.toArray(r._vertices,n,o),o+=Qn.length,yn.toArray(r._vertices,t,o),o+=yn.length,Qn.toArray(r._vertices,n,o),r._vertexCount+=2}},t.addTriangle=function(e,t,n,i,r,o,a){if(void 0===r&&(r=!0),void 0===o&&(o=!0),void 0===a&&(a=!1),r)return this.addLine(e,t,i,o),this.addLine(t,n,i,o),void this.addLine(n,e,i,o);var s=this._buffers.triangles[o?1:0];if(s._vertexCount+3>s._maxVertices)q(12009);else{var c=new wn(wn.ZERO);if(!a){var l=new yn(t.x-e.x,t.y-e.y,t.z-e.z),u=new yn(n.x-e.x,n.y-e.y,n.z-e.z),h=new yn;yn.normalize(h,yn.cross(h,l,u)),c.set(h.x,h.y,h.z,1)}var _=s._vertexCount*(yn.length+wn.length+Qn.length);yn.toArray(s._vertices,e,_),_+=yn.length,wn.toArray(s._vertices,c,_),_+=wn.length,Qn.toArray(s._vertices,i,_),_+=Qn.length,yn.toArray(s._vertices,t,_),_+=yn.length,wn.toArray(s._vertices,c,_),_+=wn.length,Qn.toArray(s._vertices,i,_),_+=Qn.length,yn.toArray(s._vertices,n,_),_+=yn.length,wn.toArray(s._vertices,c,_),_+=wn.length,Qn.toArray(s._vertices,i,_),s._vertexCount+=3}},t.addQuad=function(e,t,n,i,r,o,a,s){void 0===o&&(o=!0),void 0===a&&(a=!0),void 0===s&&(s=!1),o?(this.addLine(e,t,r,a),this.addLine(t,n,r,a),this.addLine(n,i,r,a),this.addLine(i,e,r,a)):(this.addTriangle(e,t,n,r,o,a,s),this.addTriangle(e,n,i,r,o,a,s))},t.addBoundingBox=function(e,t,n,i,r,o,a){void 0===n&&(n=!0),void 0===i&&(i=!0),void 0===r&&(r=!1),void 0===o&&(o=!1),void 0===a&&(a=new kn),by.set(e.center.x-e.halfExtents.x,e.center.y-e.halfExtents.y,e.center.z-e.halfExtents.z),Ay.set(e.center.x+e.halfExtents.x,e.center.y+e.halfExtents.y,e.center.z+e.halfExtents.z),wy.set(by.x,by.y,by.z),Iy.set(Ay.x,by.y,by.z),Py.set(by.x,Ay.y,by.z),Ry.set(Ay.x,Ay.y,by.z),Dy.set(by.x,by.y,Ay.z),Oy.set(Ay.x,by.y,Ay.z),Ny.set(by.x,Ay.y,Ay.z),My.set(Ay.x,Ay.y,Ay.z),o&&(yn.transformMat4(wy,wy,a),yn.transformMat4(Iy,Iy,a),yn.transformMat4(Py,Py,a),yn.transformMat4(Ry,Ry,a),yn.transformMat4(Dy,Dy,a),yn.transformMat4(Oy,Oy,a),yn.transformMat4(Ny,Ny,a),yn.transformMat4(My,My,a)),n?(this.addLine(Ny,My,t,i),this.addLine(My,Ry,t,i),this.addLine(Ry,Py,t,i),this.addLine(Py,Ny,t,i),this.addLine(Dy,Oy,t,i),this.addLine(Oy,Iy,t,i),this.addLine(Iy,wy,t,i),this.addLine(wy,Dy,t,i),this.addLine(Ny,Dy,t,i),this.addLine(My,Oy,t,i),this.addLine(Ry,Iy,t,i),this.addLine(Py,wy,t,i)):(this.addQuad(Dy,Oy,My,Ny,t,n,i,r),this.addQuad(Oy,Iy,Ry,My,t,n,i,r),this.addQuad(Iy,wy,Py,Ry,t,n,i,r),this.addQuad(wy,Dy,Ny,Py,t,n,i,r),this.addQuad(Ny,My,Ry,Py,t,n,i,r),this.addQuad(wy,Iy,Oy,Dy,t,n,i,r))},t.addCross=function(e,t,n,i){void 0===i&&(i=!0);var r=.5*t,o=new yn(e.x-r,e.y,e.z),a=new yn(e.x+r,e.y,e.z);this.addLine(o,a,n,i),o.set(e.x,e.y-r,e.z),a.set(e.x,e.y+r,e.z),this.addLine(o,a,n,i),o.set(e.x,e.y,e.z-r),a.set(e.x,e.y,e.z+r),this.addLine(o,a,n,i)},t.addFrustum=function(e,t,n){void 0===n&&(n=!0);var i=e.vertices;this.addLine(i[0],i[1],t,n),this.addLine(i[1],i[2],t,n),this.addLine(i[2],i[3],t,n),this.addLine(i[3],i[0],t,n),this.addLine(i[4],i[5],t,n),this.addLine(i[5],i[6],t,n),this.addLine(i[6],i[7],t,n),this.addLine(i[7],i[4],t,n),this.addLine(i[0],i[4],t,n),this.addLine(i[1],i[5],t,n),this.addLine(i[2],i[6],t,n),this.addLine(i[3],i[7],t,n)},t.addCapsule=function(e,t,n,i,r,o,a,s,c,l,u){void 0===r&&(r=32),void 0===o&&(o=8),void 0===a&&(a=!0),void 0===s&&(s=!0),void 0===c&&(c=!1),void 0===l&&(l=!1),void 0===u&&(u=new kn);for(var h=2*Math.PI/r,_=Math.PI/2/o,f=new yn(e.x,e.y-n/2,e.z),d=new yn(e.x,e.y+n/2,e.z),p=new Array,m=new Array,v=0;v<o+1;v++){for(var g=new Array,y=new Array,x=v*_,S=Math.sin(x),E=Math.cos(x),T=0;T<r+1;T++){var C=T*h,b=Math.sin(C),A=Math.cos(C),w=new yn(t*S*A,t*E,t*S*b),I=new yn(f.x+w.x,f.y-w.y,f.z+w.z),P=new yn(d.x+w.x,d.y+w.y,d.z+w.z);g.push(I),y.push(P)}p.push(g),m.push(y)}if(l)for(var R=0;R<o+1;R++)for(var D=0;D<r+1;D++)yn.transformMat4(p[R][D],p[R][D],u),yn.transformMat4(m[R][D],m[R][D],u);for(var O=0;O<o;O++)for(var N=0;N<r;N++)this.addTriangle(p[O+1][N],p[O][N+1],p[O][N],i,a,s,c),this.addTriangle(p[O+1][N],p[O+1][N+1],p[O][N+1],i,a,s,c),this.addTriangle(m[O][N],m[O+1][N+1],m[O+1][N],i,a,s,c),this.addTriangle(m[O][N],m[O][N+1],m[O+1][N+1],i,a,s,c);for(var M=p[o],L=m[o],F=0;F<r;F++)this.addTriangle(L[F],M[F+1],M[F],i,a,s,c),this.addTriangle(L[F],L[F+1],M[F+1],i,a,s,c)},t.addCylinder=function(e,t,n,i,r,o,a,s,c,l){void 0===r&&(r=32),void 0===o&&(o=!0),void 0===a&&(a=!0),void 0===s&&(s=!1),void 0===c&&(c=!1),void 0===l&&(l=new kn);for(var u=2*Math.PI/r,h=new yn(e.x,e.y-n/2,e.z),_=new yn(e.x,e.y+n/2,e.z),f=new Array,d=new Array,p=0;p<r+1;p++){var m=p*u,v=new yn(t*Math.cos(m),0,t*Math.sin(m)),g=new yn(v.x+h.x,v.y+h.y,v.z+h.z),y=new yn(v.x+_.x,v.y+_.y,v.z+_.z);f.push(g),d.push(y)}if(c){yn.transformMat4(h,h,l),yn.transformMat4(_,_,l);for(var x=0;x<r+1;x++)yn.transformMat4(f[x],f[x],l),yn.transformMat4(d[x],d[x],l)}for(var S=0;S<r;S++)this.addTriangle(_,d[S+1],d[S],i,o,a,s),this.addTriangle(h,f[S],f[S+1],i,o,a,s),this.addTriangle(d[S],f[S+1],f[S],i,o,a,s),this.addTriangle(d[S],d[S+1],f[S+1],i,o,a,s)},t.addCone=function(e,t,n,i,r,o,a,s,c,l){void 0===r&&(r=32),void 0===o&&(o=!0),void 0===a&&(a=!0),void 0===s&&(s=!1),void 0===c&&(c=!1),void 0===l&&(l=new kn);for(var u=2*Math.PI/r,h=new yn(e.x,e.y-n/2,e.z),_=new yn(e.x,e.y+n/2,e.z),f=new Array,d=0;d<r+1;d++){var p=new yn(t*Math.cos(d*u),0,t*Math.sin(d*u)),m=new yn(p.x+h.x,p.y+h.y,p.z+h.z);f.push(m)}if(c){yn.transformMat4(h,h,l),yn.transformMat4(_,_,l);for(var v=0;v<r+1;v++)yn.transformMat4(f[v],f[v],l)}for(var g=0;g<r;g++)this.addTriangle(_,f[g+1],f[g],i,o,a,s),this.addTriangle(h,f[g],f[g+1],i,o,a,s)},t.addCircle=function(e,t,n,i,r,o,a){void 0===i&&(i=32),void 0===r&&(r=!0),void 0===o&&(o=!1),void 0===a&&(a=new kn);for(var s=2*Math.PI/i,c=new Array,l=0;l<i+1;l++){var u=new yn(t*Math.cos(l*s),0,t*Math.sin(l*s)),h=new yn(u.x+e.x,u.y+e.y,u.z+e.z);c.push(h)}if(o)for(var _=0;_<i+1;_++)yn.transformMat4(c[_],c[_],a);for(var f=0;f<i;f++)this.addLine(c[f],c[f+1],n,r)},t.addArc=function(e,t,n,i,r,o,a,s,c){void 0===o&&(o=32),void 0===a&&(a=!0),void 0===s&&(s=!1),void 0===c&&(c=new kn);for(var l=rn(i),u=(rn(r)-l)/o,h=new Array,_=0;_<o+1;_++){var f=new yn(t*Math.cos(_*u+l),0,t*Math.sin(_*u+l)),d=new yn(f.x+e.x,f.y+e.y,f.z+e.z);h.push(d)}if(s)for(var p=0;p<o+1;p++)yn.transformMat4(h[p],h[p],c);for(var m=0;m<o;m++)this.addLine(h[m],h[m+1],n,a)},t.addPolygon=function(e,t,n,i,r,o,a,s,c){void 0===i&&(i=6),void 0===r&&(r=!0),void 0===o&&(o=!0),void 0===a&&(a=!1),void 0===s&&(s=!1),void 0===c&&(c=new kn),r?this.addCircle(e,t,n,i,o,s,c):this.addDisc(e,t,n,i,r,o,a,s,c)},t.addDisc=function(e,t,n,i,r,o,a,s,c){void 0===i&&(i=32),void 0===r&&(r=!0),void 0===o&&(o=!0),void 0===a&&(a=!1),void 0===s&&(s=!1),void 0===c&&(c=new kn);for(var l=2*Math.PI/i,u=new Array,h=new yn(e),_=0;_<i+1;_++){var f=new yn(t*Math.cos(_*l),0,t*Math.sin(_*l)),d=new yn(f.x+h.x,f.y+h.y,f.z+h.z);u.push(d)}if(s){yn.transformMat4(h,h,c);for(var p=0;p<i+1;p++)yn.transformMat4(u[p],u[p],c)}for(var m=0;m<i;m++)this.addTriangle(h,u[m],u[m+1],n,r,o,a);if(!r)for(var v=0;v<i;v++)this.addTriangle(h,u[v+1],u[v],n,r,o,a)},t.addSector=function(e,t,n,i,r,o,a,s,c,l,u){void 0===o&&(o=32),void 0===a&&(a=!0),void 0===s&&(s=!0),void 0===c&&(c=!1),void 0===l&&(l=!1),void 0===u&&(u=new kn);for(var h=rn(i),_=(rn(r)-h)/o,f=new Array,d=new yn(e),p=0;p<o+1;p++){var m=new yn(t*Math.cos(p*_),0,t*Math.sin(p*_)),v=new yn(m.x+d.x,m.y+d.y,m.z+d.z);f.push(v)}if(l){yn.transformMat4(d,d,u);for(var g=0;g<o+1;g++)yn.transformMat4(f[g],f[g],u)}for(var y=0;y<o;y++)this.addTriangle(d,f[y],f[y+1],n,a,s,c);if(!a)for(var x=0;x<o;x++)this.addTriangle(d,f[x+1],f[x],n,a,s,c)},t.addSphere=function(e,t,n,i,r,o,a,s,c,l){void 0===i&&(i=32),void 0===r&&(r=16),void 0===o&&(o=!0),void 0===a&&(a=!0),void 0===s&&(s=!1),void 0===c&&(c=!1),void 0===l&&(l=new kn);for(var u=2*Math.PI/i,h=Math.PI/r,_=new Array,f=0;f<r+1;f++){for(var d=new Array,p=f*h,m=Math.sin(p),v=Math.cos(p),g=0;g<i+1;g++){var y=g*u,x=Math.sin(y),S=Math.cos(y),E=new yn(t*m*S,t*v,t*m*x),T=new yn(e.x+E.x,e.y+E.y,e.z+E.z);d.push(T)}_.push(d)}if(c)for(var C=0;C<r+1;C++)for(var b=0;b<i+1;b++)yn.transformMat4(_[C][b],_[C][b],l);for(var A=0;A<r;A++)for(var w=0;w<i;w++)this.addTriangle(_[A][w],_[A+1][w+1],_[A+1][w],n,o,a,s),this.addTriangle(_[A][w],_[A][w+1],_[A+1][w+1],n,o,a,s)},t.addTorus=function(e,t,n,i,r,o,a,s,c,l,u){void 0===r&&(r=32),void 0===o&&(o=16),void 0===a&&(a=!0),void 0===s&&(s=!0),void 0===c&&(c=!1),void 0===l&&(l=!1),void 0===u&&(u=new kn);for(var h=2*Math.PI/r,_=2*Math.PI/o,f=new Array,d=0;d<r+1;d++){for(var p=new Array,m=d*h,v=Math.sin(m),g=Math.cos(m),y=0;y<o+1;y++){var x=y*_,S=Math.sin(x),E=Math.cos(x),T=new yn((t+n*E)*g,n*S,(t+n*E)*v),C=new yn(e.x+T.x,e.y+T.y,e.z+T.z);p.push(C)}f.push(p)}if(l)for(var b=0;b<r+1;b++)for(var A=0;A<o+1;A++)yn.transformMat4(f[b][A],f[b][A],u);for(var w=0;w<r;w++)for(var I=0;I<o;I++)this.addTriangle(f[w][I+1],f[w+1][I],f[w][I],i,a,s,c),this.addTriangle(f[w][I+1],f[w+1][I+1],f[w+1][I],i,a,s,c)},t.addOctahedron=function(e,t,n,i,r,o,a,s){void 0===i&&(i=!0),void 0===r&&(r=!0),void 0===o&&(o=!1),void 0===a&&(a=!1),void 0===s&&(s=new kn);var c=new Array;if(c.push(new yn(t+e.x,e.y,e.z)),c.push(new yn(e.x,e.y,e.z-t)),c.push(new yn(-t+e.x,e.y,e.z)),c.push(new yn(e.x,e.y,e.z+t)),c.push(new yn(e.x,e.y+t,e.z)),c.push(new yn(e.x,e.y-t,e.z)),a)for(var l=0;l<c.length;l++)yn.transformMat4(c[l],c[l],s);i?(this.addLine(c[0],c[1],n,r),this.addLine(c[1],c[2],n,r),this.addLine(c[2],c[3],n,r),this.addLine(c[3],c[0],n,r),this.addLine(c[0],c[4],n,r),this.addLine(c[1],c[4],n,r),this.addLine(c[2],c[4],n,r),this.addLine(c[3],c[4],n,r),this.addLine(c[0],c[5],n,r),this.addLine(c[1],c[5],n,r),this.addLine(c[2],c[5],n,r),this.addLine(c[3],c[5],n,r)):(this.addTriangle(c[0],c[1],c[4],n,i,r,o),this.addTriangle(c[1],c[2],c[4],n,i,r,o),this.addTriangle(c[2],c[3],c[4],n,i,r,o),this.addTriangle(c[3],c[0],c[4],n,i,r,o),this.addTriangle(c[0],c[3],c[5],n,i,r,o),this.addTriangle(c[3],c[2],c[5],n,i,r,o),this.addTriangle(c[2],c[1],c[5],n,i,r,o),this.addTriangle(c[1],c[0],c[5],n,i,r,o))},t.addBezier=function(e,t,n,i,r,o,a,s,c){void 0===o&&(o=32),void 0===a&&(a=!0),void 0===s&&(s=!1),void 0===c&&(c=new kn);var l=1/o,u=new Array,h=new yn(e),_=new yn(t),f=new yn(n),d=new yn(i);s&&(yn.transformMat4(h,h,c),yn.transformMat4(_,_,c),yn.transformMat4(f,f,c),yn.transformMat4(d,d,c));for(var p=0;p<o+1;p++){var m=p*l,v=(1-m)*(1-m)*(1-m),g=3*m*(1-m)*(1-m),y=3*m*m*(1-m),x=m*m*m,S=new yn(v*h.x+g*_.x+y*f.x+x*d.x,v*h.y+g*_.y+y*f.y+x*d.y,v*h.z+g*_.z+y*f.z+x*d.z);u.push(S)}for(var E=0;E<o;E++)this.addLine(u[E],u[E+1],r,a)},t.addMesh=function(e,t,n,i,r,o){void 0===i&&(i=!0),void 0===r&&(r=!1),void 0===o&&(o=new kn);for(var a=0;a<t.length;a+=3){var s=new yn(e.x+t[a].x,e.y+t[a].y,e.z+t[a].z),c=new yn(e.x+t[a+1].x,e.y+t[a+1].y,e.z+t[a+1].z),l=new yn(e.x+t[a+2].x,e.y+t[a+2].y,e.z+t[a+2].z);r&&(yn.transformMat4(s,s,o),yn.transformMat4(c,c,o),yn.transformMat4(l,l,o)),this.addLine(s,c,n,i),this.addLine(c,l,n,i),this.addLine(l,s,n,i)}},t.addIndexedMesh=function(e,t,n,i,r,o,a){void 0===r&&(r=!0),void 0===o&&(o=!1),void 0===a&&(a=new kn);for(var s=0;s<n.length;s+=3){var c=new yn(e.x+t[n[s]].x,e.y+t[n[s]].y,e.z+t[n[s]].z),l=new yn(e.x+t[n[s+1]].x,e.y+t[n[s+1]].y,e.z+t[n[s+1]].z),u=new yn(e.x+t[n[s+2]].x,e.y+t[n[s+2]].y,e.z+t[n[s+2]].z);o&&(yn.transformMat4(c,c,a),yn.transformMat4(l,l,a),yn.transformMat4(u,u,a)),this.addLine(c,l,i,r),this.addLine(l,u,i,r),this.addLine(u,c,i,r)}},h(e,[{key:"native",get:function(){return this._nativeObj}}]),e}(),Yy=new kn,Ky=new kn,Qy=new kn,Jy=new wn,Zy=new wn(0,0,1,0),$y=function(){function e(){this._globalUBO=new Float32Array(Sd.COUNT),this._cameraUBO=new Float32Array(Ed.COUNT),this._shadowUBO=new Float32Array(Td.COUNT)}e.updateGlobalUBOView=function(e,t){var n=b.director.root,i=t,r=Math.floor(e.width),o=Math.floor(e.height);i[Sd.TIME_OFFSET]=n.cumulativeTime,i[Sd.TIME_OFFSET+1]=n.frameTime,i[Sd.TIME_OFFSET+2]=b.director.getTotalFrames(),i[Sd.SCREEN_SIZE_OFFSET]=r,i[Sd.SCREEN_SIZE_OFFSET+1]=o,i[Sd.SCREEN_SIZE_OFFSET+2]=1/r,i[Sd.SCREEN_SIZE_OFFSET+3]=1/o,i[Sd.NATIVE_SIZE_OFFSET]=r,i[Sd.NATIVE_SIZE_OFFSET+1]=o,i[Sd.NATIVE_SIZE_OFFSET+2]=1/i[Sd.NATIVE_SIZE_OFFSET],i[Sd.NATIVE_SIZE_OFFSET+3]=1/i[Sd.NATIVE_SIZE_OFFSET+1]},e.updateCameraUBOView=function(e,t,n){var i,r=(n.scene?n.scene:b.director.getScene().renderScene).mainLight,o=e.pipelineSceneData,a=o.ambient,s=o.skybox,c=o.fog,l=o.shadows,u=t,h=n.exposure,_=o.isHDR;if(u[Ed.SCREEN_SCALE_OFFSET]=o.shadingScale,u[Ed.SCREEN_SCALE_OFFSET+1]=o.shadingScale,u[Ed.SCREEN_SCALE_OFFSET+2]=1/u[Ed.SCREEN_SCALE_OFFSET],u[Ed.SCREEN_SCALE_OFFSET+3]=1/u[Ed.SCREEN_SCALE_OFFSET+1],u[Ed.EXPOSURE_OFFSET]=h,u[Ed.EXPOSURE_OFFSET+1]=1/h,u[Ed.EXPOSURE_OFFSET+2]=_?1:0,u[Ed.EXPOSURE_OFFSET+3]=1/Gv.standardExposureValue,r){var f=r.shadowEnabled&&l.type===Vv.ShadowMap?1:0,d=r.direction;if(Zy.set(d.x,d.y,d.z,f),wn.toArray(u,Zy,Ed.MAIN_LIT_DIR_OFFSET),yn.toArray(u,r.color,Ed.MAIN_LIT_COLOR_OFFSET),r.useColorTemperature){var p=r.colorTemperatureRGB;u[Ed.MAIN_LIT_COLOR_OFFSET]*=p.x,u[Ed.MAIN_LIT_COLOR_OFFSET+1]*=p.y,u[Ed.MAIN_LIT_COLOR_OFFSET+2]*=p.z}u[Ed.MAIN_LIT_COLOR_OFFSET+3]=_?r.illuminance*h:r.illuminance}else Zy.set(0,0,1,0),wn.toArray(u,Zy,Ed.MAIN_LIT_DIR_OFFSET),wn.toArray(u,wn.ZERO,Ed.MAIN_LIT_COLOR_OFFSET);var m=a.skyColor;m.w=_?a.skyIllum*h:a.skyIllum,u[Ed.AMBIENT_SKY_OFFSET+0]=m.x,u[Ed.AMBIENT_SKY_OFFSET+1]=m.y,u[Ed.AMBIENT_SKY_OFFSET+2]=m.z,u[Ed.AMBIENT_SKY_OFFSET+3]=m.w,u[Ed.AMBIENT_GROUND_OFFSET+0]=a.groundAlbedo.x,u[Ed.AMBIENT_GROUND_OFFSET+1]=a.groundAlbedo.y,u[Ed.AMBIENT_GROUND_OFFSET+2]=a.groundAlbedo.z,u[Ed.AMBIENT_GROUND_OFFSET+3]=s.envmap?null===(i=s.envmap)||void 0===i?void 0:i.mipmapLevel:1,kn.toArray(u,n.matView,Ed.MAT_VIEW_OFFSET),kn.toArray(u,n.node.worldMatrix,Ed.MAT_VIEW_INV_OFFSET),yn.toArray(u,n.position,Ed.CAMERA_POS_OFFSET),kn.toArray(u,n.matProj,Ed.MAT_PROJ_OFFSET),kn.toArray(u,n.matProjInv,Ed.MAT_PROJ_INV_OFFSET),kn.toArray(u,n.matViewProj,Ed.MAT_VIEW_PROJ_OFFSET),kn.toArray(u,n.matViewProjInv,Ed.MAT_VIEW_PROJ_INV_OFFSET),u[Ed.CAMERA_POS_OFFSET+3]=this.getCombineSignY();var v=c.colorArray;u[Ed.GLOBAL_FOG_COLOR_OFFSET]=v.x,u[Ed.GLOBAL_FOG_COLOR_OFFSET+1]=v.y,u[Ed.GLOBAL_FOG_COLOR_OFFSET+2]=v.z,u[Ed.GLOBAL_FOG_COLOR_OFFSET+3]=v.z,u[Ed.GLOBAL_FOG_BASE_OFFSET]=c.fogStart,u[Ed.GLOBAL_FOG_BASE_OFFSET+1]=c.fogEnd,u[Ed.GLOBAL_FOG_BASE_OFFSET+2]=c.fogDensity,u[Ed.GLOBAL_FOG_ADD_OFFSET]=c.fogTop,u[Ed.GLOBAL_FOG_ADD_OFFSET+1]=c.fogRange,u[Ed.GLOBAL_FOG_ADD_OFFSET+2]=c.fogAtten,u[Ed.NEAR_FAR_OFFSET]=n.nearClip,u[Ed.NEAR_FAR_OFFSET+1]=n.farClip,u[Ed.VIEW_PORT_OFFSET]=o.shadingScale*n.window.width*n.viewport.x,u[Ed.VIEW_PORT_OFFSET+1]=o.shadingScale*n.window.height*n.viewport.y,u[Ed.VIEW_PORT_OFFSET+2]=o.shadingScale*n.window.width*n.viewport.z,u[Ed.VIEW_PORT_OFFSET+3]=o.shadingScale*n.window.height*n.viewport.w},e.updateShadowUBOView=function(e,t,n){var i=e.device,r=n.scene.mainLight,o=e.pipelineSceneData.shadows,a=t;if(o.enabled){if(r&&r.shadowEnabled&&o.type===Vv.ShadowMap){var s=.1,c=0,l=o.matShadowView,u=o.matShadowProj,h=o.matShadowViewProj;r.shadowFixedArea?(s=r.shadowNear,c=r.shadowFar):(s=.1,c=o.shadowCameraFar),kn.toArray(t,l,Td.MAT_LIGHT_VIEW_OFFSET),a[Td.SHADOW_PROJ_DEPTH_INFO_OFFSET+0]=u.m10,a[Td.SHADOW_PROJ_DEPTH_INFO_OFFSET+1]=u.m14,a[Td.SHADOW_PROJ_DEPTH_INFO_OFFSET+2]=u.m11,a[Td.SHADOW_PROJ_DEPTH_INFO_OFFSET+3]=u.m15,a[Td.SHADOW_PROJ_INFO_OFFSET+0]=u.m00,a[Td.SHADOW_PROJ_INFO_OFFSET+1]=u.m05,a[Td.SHADOW_PROJ_INFO_OFFSET+2]=1/u.m00,a[Td.SHADOW_PROJ_INFO_OFFSET+3]=1/u.m05,kn.toArray(t,h,Td.MAT_LIGHT_VIEW_PROJ_OFFSET);var _=Tp(i)?0:1;a[Td.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+0]=s,a[Td.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+1]=c,a[Td.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+2]=0,a[Td.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+3]=1-r.shadowSaturation,a[Td.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+0]=o.size.x,a[Td.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+1]=o.size.y,a[Td.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+2]=r.shadowPcf,a[Td.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+3]=r.shadowBias,a[Td.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+0]=0,a[Td.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+1]=_,a[Td.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+2]=r.shadowNormalBias,a[Td.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+3]=0}else r&&o.type===Vv.Planar&&(Eg(o,r,a),Tg(o,a));Qn.toArray(a,o.shadowColor,Td.SHADOW_COLOR_OFFSET)}},e.updateShadowUBOLightView=function(e,t,n){var i=e.device,r=e.pipelineSceneData.shadows,o=t,a=Tp(i)?0:1,s=.1,c=0,l=r.matShadowView,u=r.matShadowProj,h=r.matShadowViewProj;switch(n.type){case $g.DIRECTIONAL:var _=n;_.shadowFixedArea?(s=_.shadowNear,c=_.shadowFar):(s=.1,c=r.shadowCameraFar),kn.toArray(t,l,Td.MAT_LIGHT_VIEW_OFFSET),o[Td.SHADOW_PROJ_DEPTH_INFO_OFFSET+0]=u.m10,o[Td.SHADOW_PROJ_DEPTH_INFO_OFFSET+1]=u.m14,o[Td.SHADOW_PROJ_DEPTH_INFO_OFFSET+2]=u.m11,o[Td.SHADOW_PROJ_DEPTH_INFO_OFFSET+3]=u.m15,o[Td.SHADOW_PROJ_INFO_OFFSET+0]=u.m00,o[Td.SHADOW_PROJ_INFO_OFFSET+1]=u.m05,o[Td.SHADOW_PROJ_INFO_OFFSET+2]=1/u.m00,o[Td.SHADOW_PROJ_INFO_OFFSET+3]=1/u.m05,kn.toArray(t,h,Td.MAT_LIGHT_VIEW_PROJ_OFFSET),Jy.set(s,c,0,1-_.shadowSaturation),wn.toArray(o,Jy,Td.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET),Jy.set(0,a,_.shadowNormalBias,0),wn.toArray(o,Jy,Td.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET),Jy.set(r.size.x,r.size.y,_.shadowPcf,_.shadowBias),wn.toArray(o,Jy,Td.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET);break;case $g.SPOT:var f=n;kn.invert(Yy,n.node.getWorldMatrix()),kn.toArray(o,Yy,Td.MAT_LIGHT_VIEW_OFFSET),kn.perspective(Ky,n.angle,1,.001,n.range),kn.multiply(Qy,Ky,Yy),kn.toArray(o,Qy,Td.MAT_LIGHT_VIEW_PROJ_OFFSET),Jy.set(.01,n.range,0,0),wn.toArray(o,Jy,Td.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET),Jy.set(1,a,f.shadowNormalBias,0),wn.toArray(o,Jy,Td.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET),Jy.set(r.size.x,r.size.y,f.shadowPcf,f.shadowBias),wn.toArray(o,Jy,Td.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET)}Qn.toArray(o,r.shadowColor,Td.SHADOW_COLOR_OFFSET)},e.getCombineSignY=function(){return e._combineSignY};var t=e.prototype;return t._initCombineSignY=function(){var t=this._device;e._combineSignY=.5*t.capabilities.screenSpaceSignY+.5<<1|.5*t.capabilities.clipSpaceSignY+.5},t.activate=function(e,t){this._device=e,this._pipeline=t;var n=this._pipeline.descriptorSet;this._initCombineSignY();var i=e.createBuffer(new cr(li.UNIFORM|li.TRANSFER_DST,_i.HOST|_i.DEVICE,Sd.SIZE,Sd.SIZE));n.bindBuffer(Sd.BINDING,i);var r=e.createBuffer(new cr(li.UNIFORM|li.TRANSFER_DST,_i.HOST|_i.DEVICE,Ed.SIZE,Ed.SIZE));n.bindBuffer(Ed.BINDING,r);var o=e.createBuffer(new cr(li.UNIFORM|li.TRANSFER_DST,_i.HOST|_i.DEVICE,Td.SIZE,Td.SIZE));n.bindBuffer(Td.BINDING,o)},t.updateGlobalUBO=function(t){var n=this._pipeline.globalDSManager,i=this._pipeline.descriptorSet,r=this._pipeline.commandBuffers;i.update(),e.updateGlobalUBOView(t,this._globalUBO),r[0].updateBuffer(i.getBuffer(Sd.BINDING),this._globalUBO),n.bindBuffer(Sd.BINDING,i.getBuffer(Sd.BINDING)),n.update()},t.updateCameraUBO=function(t){var n=this._pipeline.globalDSManager,i=this._pipeline.descriptorSet,r=this._pipeline.commandBuffers;e.updateCameraUBOView(this._pipeline,this._cameraUBO,t),r[0].updateBuffer(i.getBuffer(Ed.BINDING),this._cameraUBO),n.bindBuffer(Ed.BINDING,i.getBuffer(Ed.BINDING)),n.update()},t.updateShadowUBO=function(t){var n=this._pipeline.pipelineSceneData;if(n.shadows.enabled){var i=this._pipeline.descriptorSet,r=this._pipeline.commandBuffers,o=n.shadowFrameBufferMap,a=t.scene.mainLight;a&&o.has(a)&&i.bindTexture(Cd,o.get(a).colorTextures[0]),e.updateShadowUBOView(this._pipeline,this._shadowUBO,t),i.update(),r[0].updateBuffer(i.getBuffer(Td.BINDING),this._shadowUBO)}},t.updateShadowUBOLight=function(t,n){e.updateShadowUBOLightView(this._pipeline,this._shadowUBO,n),t.bindTexture(Cd,nv.get("default-texture").getGFXTexture()),t.bindTexture(Nd,nv.get("default-texture").getGFXTexture()),t.update(),t.getBuffer(Td.BINDING).update(this._shadowUBO)},t.updateShadowUBORange=function(e,t){t instanceof kn?kn.toArray(this._shadowUBO,t,e):t instanceof Qn&&Qn.toArray(this._shadowUBO,t,e)},t.destroy=function(){},e}();$y._combineSignY=0;var ex,tx,nx,ix,rx,ox,ax,sx,cx,lx,ux,hx,_x,fx=e("RenderStage",(Ly=dc("RenderStage"),Fy=Vc(),By=Vc(),zy=Vc(),Ly((Wy=function(){function e(){E(this,"_name",Gy,this),E(this,"_priority",Hy,this),this._enabled=!0,E(this,"_tag",Vy,this)}var t=e.prototype;return t.initialize=function(e){return this._name=e.name,this._priority=e.priority,e.tag&&(this._tag=e.tag),!0},t.activate=function(e,t){this._pipeline=e,this._flow=t},h(e,[{key:"name",get:function(){return this._name}},{key:"priority",get:function(){return this._priority}},{key:"tag",get:function(){return this._tag}},{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled=e}}]),e}(),Gy=T((ky=Wy).prototype,"_name",[Fy,Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Hy=T(ky.prototype,"_priority",[By,Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Vy=T(ky.prototype,"_tag",[zy,Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Uy=ky))||Uy));b.RenderStage=fx;var dx,px=e("RenderFlow",(ex=dc("RenderFlow"),tx=Vc(),nx=Vc(),ix=Vc(),rx=Vc(),ox=Jc([fx]),ex((_x=function(){function e(){E(this,"_name",cx,this),E(this,"_priority",lx,this),E(this,"_tag",ux,this),E(this,"_stages",hx,this)}var t=e.prototype;return t.initialize=function(e){return this._name=e.name,this._priority=e.priority,this._stages=e.stages,e.tag&&(this._tag=e.tag),!0},t.activate=function(e){this._pipeline=e,this._stages.sort((function(e,t){return e.priority-t.priority}));for(var t=0,n=this._stages.length;t<n;t++)this._stages[t].activate(e,this)},t.render=function(e){for(var t=0,n=this._stages.length;t<n;t++)this._stages[t].enabled&&this._stages[t].render(e)},t.destroy=function(){for(var e=0,t=this._stages.length;e<t;e++)this._stages[e].destroy();this._stages.length=0},h(e,[{key:"name",get:function(){return this._name}},{key:"priority",get:function(){return this._priority}},{key:"tag",get:function(){return this._tag}},{key:"stages",get:function(){return this._stages}},{key:"pipeline",get:function(){return this._pipeline}}]),e}(),cx=T((sx=_x).prototype,"_name",[tx,Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),lx=T(sx.prototype,"_priority",[nx,Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),ux=T(sx.prototype,"_tag",[ix,Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),hx=T(sx.prototype,"_stages",[rx,ox,Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),ax=sx))||ax));b.RenderFlow=px,function(e){e.RENDER_FRAME_BEGIN="render-frame-begin",e.RENDER_FRAME_END="render-frame-end",e.RENDER_CAMERA_BEGIN="render-camera-begin",e.RENDER_CAMERA_END="render-camera-end",e.ATTACHMENT_SCALE_CAHNGED="attachment-scale-changed"}(dx||(dx=e("PipelineEventType",{})));var mx,vx,gx,yx,xx,Sx,Ex,Tx,Cx,bx,Ax,wx,Ix,Px,Rx,Dx=e("PipelineEventProcessor",function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).eventTargetOn=e.prototype.on,t.eventTargetOnce=e.prototype.once,t}f(t,e);var n=t.prototype;return n.on=function(e,t,n,i){return this.eventTargetOn(e,t,n,i)},n.once=function(e,t,n){return this.eventTargetOnce(e,t,n)},t}(Jl)),Ox=new Qi,Nx=new ir,Mx=function(){this.renderPass=null,this.sampler=null,this.prefiterTex=null,this.downsampleTexs=[],this.upsampleTexs=[],this.combineTex=null,this.prefilterFramebuffer=null,this.downsampleFramebuffers=[],this.upsampleFramebuffers=[],this.combineFramebuffer=null},Lx=function(){this.quadIB=null,this.quadVB=null,this.quadIA=null},Fx=e("RenderPipeline",(mx=dc("cc.RenderPipeline"),vx=Vc(),gx=Vc(),yx=Jc([px]),mx((Cx=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return E(t=e.call.apply(e,[this].concat(i))||this,"_tag",Ex,y(t)),E(t,"_flows",Tx,y(t)),t._quadIB=null,t._quadVBOnscreen=null,t._quadVBOffscreen=null,t._quadIAOnscreen=null,t._quadIAOffscreen=null,t._eventProcessor=new Dx,t._commandBuffers=[],t._pipelineUBO=new $y,t._macros={},t._constantMacros="",t._profiler=null,t._geometryRenderer=new Xy,t._pipelineRenderData=null,t._renderPasses=new Map,t._width=0,t._height=0,t._lastUsedRenderArea=new Qi,t._clusterEnabled=!1,t._bloomEnabled=!1,t}f(t,e);var n=t.prototype;return n.getPipelineRenderData=function(){return this._pipelineRenderData},n.initialize=function(e){return this._flows=e.flows,e.tag&&(this._tag=e.tag),!0},n.createRenderPass=function(e,t,n){var i=this._device,r=new Ir,o=new Pr;r.format=t,o.format=n,o.stencilStoreOp=Ii.DISCARD,o.depthStoreOp=Ii.DISCARD,e&Hi.COLOR||(e&Uv?r.loadOp=wi.DISCARD:(r.loadOp=wi.LOAD,r.barrier=i.getGeneralBarrier(new Nr(Pi.COLOR_ATTACHMENT_WRITE,Pi.COLOR_ATTACHMENT_WRITE)))),(e&Hi.DEPTH_STENCIL)!==Hi.DEPTH_STENCIL&&(e&Hi.DEPTH||(o.depthLoadOp=wi.LOAD),e&Hi.STENCIL||(o.stencilLoadOp=wi.LOAD)),o.barrier=i.getGeneralBarrier(new Nr(Pi.DEPTH_STENCIL_ATTACHMENT_WRITE,Pi.DEPTH_STENCIL_ATTACHMENT_WRITE));var a=new Or([r],o);return i.createRenderPass(a)},n.getRenderPass=function(e,t){var n=this._renderPasses.get(e);return n||(n=this.createRenderPass(e,t.colorTextures[0].format,t.depthStencilTexture.format),this._renderPasses.set(e,n),n)},n.applyFramebufferRatio=function(e){for(var t=this.pipelineSceneData,n=this._width*t.shadingScale,i=this._height*t.shadingScale,r=e.colorTextures,o=0;o<r.length;o++)r[o].resize(n,i);e.depthStencilTexture&&e.depthStencilTexture.resize(n,i),e.destroy(),e.initialize(new Lr(e.renderPass,r,e.depthStencilTexture))},n.generateRenderArea=function(e,t){var n=e.viewport,i=e.window.width,r=e.window.height;t.x=n.x*i,t.y=n.y*r,t.width=n.width*i,t.height=n.height*r},n.generateViewport=function(e,t){this.generateRenderArea(e,Ox),t||(t=Nx);var n=this.pipelineSceneData.shadingScale;return t.left=Ox.x*n,t.top=Ox.y*n,t.width=Ox.width*n,t.height=Ox.height*n,t},n.generateScissor=function(e,t){t||(t=Ox),this.generateRenderArea(e,t);var n=this.pipelineSceneData.shadingScale;return t.x*=n,t.y*=n,t.width*=n,t.height*=n,t},n.activate=function(){var e=b.director.root;this._device=e.device,this._generateConstantMacros(),this._globalDSManager=new Pg(this),this._descriptorSet=this._globalDSManager.globalDescriptorSet,this._pipelineUBO.activate(this._device,this),this._macros.CC_USE_HDR=this._pipelineSceneData.isHDR,this._generateConstantMacros(),this._pipelineSceneData.activate(this._device,this),this._geometryRenderer.activate(this._device,this);for(var t=0;t<this._flows.length;t++)this._flows[t].activate(this);return!0},n._ensureEnoughSize=function(){},n.render=function(e){if(0!==e.length){this._commandBuffers[0].begin(),this.emit(dx.RENDER_FRAME_BEGIN,e),this._ensureEnoughSize(e),function(e){for(var t=e.length-1;t>=0;--t){var n=e[t];if(n.window.swapchain)return void(Cv=n)}Cv=null}(e);for(var t=0;t<e.length;t++){var n=e[t];if(n.scene){this.emit(dx.RENDER_CAMERA_BEGIN,n),Cg(this,n),bg(this,n),this._pipelineUBO.updateGlobalUBO(n.window),this._pipelineUBO.updateCameraUBO(n);for(var i=0;i<this._flows.length;i++)this._flows[i].render(n);this.emit(dx.RENDER_CAMERA_END,n)}}this.emit(dx.RENDER_FRAME_END,e),this._commandBuffers[0].end(),this._device.queue.submit(this._commandBuffers)}},n._destroyQuadInputAssembler=function(){this._quadIB&&(this._quadIB.destroy(),this._quadIB=null),this._quadVBOnscreen&&(this._quadVBOnscreen.destroy(),this._quadVBOnscreen=null),this._quadVBOffscreen&&(this._quadVBOffscreen.destroy(),this._quadVBOffscreen=null),this._quadIAOnscreen&&(this._quadIAOnscreen.destroy(),this._quadIAOnscreen=null),this._quadIAOffscreen&&(this._quadIAOffscreen.destroy(),this._quadIAOffscreen=null)},n._destroyBloomData=function(){var e,t=this._pipelineRenderData.bloom;if(null!==t){t.prefiterTex&&t.prefiterTex.destroy(),t.prefilterFramebuffer&&t.prefilterFramebuffer.destroy();for(var n=0;n<t.downsampleTexs.length;++n)t.downsampleTexs[n].destroy(),t.downsampleFramebuffers[n].destroy();t.downsampleTexs.length=0,t.downsampleFramebuffers.length=0;for(var i=0;i<t.upsampleTexs.length;++i)t.upsampleTexs[i].destroy(),t.upsampleFramebuffers[i].destroy();t.upsampleTexs.length=0,t.upsampleFramebuffers.length=0,t.combineTex&&t.combineTex.destroy(),t.combineFramebuffer&&t.combineFramebuffer.destroy(),null===(e=t.renderPass)||void 0===e||e.destroy(),this._pipelineRenderData.bloom=null}},n._genQuadVertexData=function(e,t){var n=new Float32Array(16),i=t.x/this._width,r=(t.x+t.width)/this._width,o=t.y/this._height,a=(t.y+t.height)/this._height;if(this.device.capabilities.screenSpaceSignY>0){var s=a;a=o,o=s}var c=0;switch(e){case ri.IDENTITY:c=0,n[c++]=-1,n[c++]=-1,n[c++]=i,n[c++]=a,n[c++]=1,n[c++]=-1,n[c++]=r,n[c++]=a,n[c++]=-1,n[c++]=1,n[c++]=i,n[c++]=o,n[c++]=1,n[c++]=1,n[c++]=r,n[c++]=o;break;case ri.ROTATE_90:c=0,n[c++]=-1,n[c++]=-1,n[c++]=r,n[c++]=a,n[c++]=1,n[c++]=-1,n[c++]=r,n[c++]=o,n[c++]=-1,n[c++]=1,n[c++]=i,n[c++]=a,n[c++]=1,n[c++]=1,n[c++]=i,n[c++]=o;break;case ri.ROTATE_180:c=0,n[c++]=-1,n[c++]=-1,n[c++]=i,n[c++]=o,n[c++]=1,n[c++]=-1,n[c++]=r,n[c++]=o,n[c++]=-1,n[c++]=1,n[c++]=i,n[c++]=a,n[c++]=1,n[c++]=1,n[c++]=r,n[c++]=a;break;case ri.ROTATE_270:c=0,n[c++]=-1,n[c++]=-1,n[c++]=i,n[c++]=o,n[c++]=1,n[c++]=-1,n[c++]=i,n[c++]=a,n[c++]=-1,n[c++]=1,n[c++]=r,n[c++]=o,n[c++]=1,n[c++]=1,n[c++]=r,n[c++]=a}return n},n._createQuadInputAssembler=function(){var e=new Lx,t=4*Float32Array.BYTES_PER_ELEMENT,n=4*t,i=this._device.createBuffer(new cr(li.VERTEX|li.TRANSFER_DST,_i.DEVICE|_i.HOST,n,t));if(!i)return e;var r=Uint8Array.BYTES_PER_ELEMENT,o=6*r,a=this._device.createBuffer(new cr(li.INDEX|li.TRANSFER_DST,_i.DEVICE,o,r));if(!a)return e;var s=new Uint8Array(6);s[0]=0,s[1]=1,s[2]=2,s[3]=1,s[4]=3,s[5]=2,a.update(s);var c=new Array(2);c[0]=new br("a_position",ai.RG32F),c[1]=new br("a_texCoord",ai.RG32F);var l=this._device.createInputAssembler(new wr(c,[i],a));return e.quadIB=a,e.quadVB=i,e.quadIA=l,e},n.updateQuadVertexData=function(e,t){var n=this._lastUsedRenderArea;if(n.x!==e.x||n.y!==e.y||n.width!==e.width||n.height!==e.height){var i=this._genQuadVertexData(ri.IDENTITY,e);this._quadVBOffscreen.update(i);var r=this._genQuadVertexData(t.swapchain&&t.swapchain.surfaceTransform||ri.IDENTITY,e);this._quadVBOnscreen.update(r),n.copy(e)}},n.destroy=function(){for(var t,n,i=0;i<this._flows.length;i++)this._flows[i].destroy();this._flows.length=0,this._descriptorSet&&this._descriptorSet.destroy(),null===(t=this._globalDSManager)||void 0===t||t.destroy();for(var r=0;r<this._commandBuffers.length;r++)this._commandBuffers[r].destroy();return this._commandBuffers.length=0,this._pipelineUBO.destroy(),null===(n=this._pipelineSceneData)||void 0===n||n.destroy(),this._geometryRenderer.destroy(),e.prototype.destroy.call(this)},n._generateConstantMacros=function(){var e="";e+="#define CC_DEVICE_SUPPORT_FLOAT_TEXTURE "+(this.device.getFormatFeatures(ai.RGBA32F)&(mi.RENDER_TARGET|mi.SAMPLED_TEXTURE)?1:0)+"\n",e+="#define CC_ENABLE_CLUSTERED_LIGHT_CULLING "+(this._clusterEnabled?1:0)+"\n",e+="#define CC_DEVICE_MAX_VERTEX_UNIFORM_VECTORS "+this.device.capabilities.maxVertexUniformVectors+"\n",e+="#define CC_DEVICE_MAX_FRAGMENT_UNIFORM_VECTORS "+this.device.capabilities.maxFragmentUniformVectors+"\n",e+="#define CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT "+(this.device.hasFeature(oi.INPUT_ATTACHMENT_BENEFIT)?1:0)+"\n",e+="#define CC_PLATFORM_ANDROID_AND_WEBGL "+(nu.os===Yl.ANDROID&&nu.isBrowser?1:0)+"\n",e+="#define CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES "+(nt.ENABLE_WEBGL_HIGHP_STRUCT_VALUES?1:0)+"\n",this._constantMacros=e},n.generateBloomRenderData=function(){if(null==this._pipelineRenderData.bloom){var e=this._pipelineRenderData.bloom=new Mx,t=this.device,n=new Ir;n.format=ai.RGBA8,n.loadOp=wi.CLEAR,n.storeOp=Ii.STORE,n.barrier=t.getGeneralBarrier(new Nr(Pi.NONE,Pi.COLOR_ATTACHMENT_WRITE)),e.renderPass=t.createRenderPass(new Or([n]));var i=this._width,r=this._height;e.prefiterTex=t.createTexture(new fr(fi.TEX2D,di.COLOR_ATTACHMENT|di.SAMPLED,ai.RGBA8,i>>1,r>>1)),e.prefilterFramebuffer=t.createFramebuffer(new Lr(e.renderPass,[e.prefiterTex])),i>>=1,r>>=1;for(var o=0;o<6;++o)e.downsampleTexs.push(t.createTexture(new fr(fi.TEX2D,di.COLOR_ATTACHMENT|di.SAMPLED,ai.RGBA8,i>>1,r>>1))),e.downsampleFramebuffers[o]=t.createFramebuffer(new Lr(e.renderPass,[e.downsampleTexs[o]])),e.upsampleTexs.push(t.createTexture(new fr(fi.TEX2D,di.COLOR_ATTACHMENT|di.SAMPLED,ai.RGBA8,i,r))),e.upsampleFramebuffers[o]=t.createFramebuffer(new Lr(e.renderPass,[e.upsampleTexs[o]])),i>>=1,r>>=1;e.combineTex=t.createTexture(new fr(fi.TEX2D,di.COLOR_ATTACHMENT|di.SAMPLED,ai.RGBA8,this._width,this._height)),e.combineFramebuffer=t.createFramebuffer(new Lr(e.renderPass,[e.combineTex])),e.sampler=this.globalDSManager.linearSampler}},n.on=function(e,t,n,i){return this._eventProcessor.on(e,t,n,i)},n.once=function(e,t,n){return this._eventProcessor.once(e,t,n)},n.off=function(e,t,n){this._eventProcessor.off(e,t,n)},n.emit=function(e,t,n,i,r,o){this._eventProcessor.emit(e,t,n,i,r,o)},n.targetOff=function(e){this._eventProcessor.targetOff(e)},n.removeAll=function(e){this._eventProcessor.removeAll(e)},n.hasEventListener=function(e,t,n){return this._eventProcessor.hasEventListener(e,t,n)},h(t,[{key:"tag",get:function(){return this._tag}},{key:"flows",get:function(){return this._flows}},{key:"quadIAOnscreen",get:function(){return this._quadIAOnscreen}},{key:"quadIAOffscreen",get:function(){return this._quadIAOffscreen}},{key:"constantMacros",get:function(){return this._constantMacros}},{key:"macros",get:function(){return this._macros}},{key:"device",get:function(){return this._device}},{key:"globalDSManager",get:function(){return this._globalDSManager}},{key:"descriptorSetLayout",get:function(){return this._globalDSManager.descriptorSetLayout}},{key:"descriptorSet",get:function(){return this._descriptorSet}},{key:"commandBuffers",get:function(){return this._commandBuffers}},{key:"pipelineUBO",get:function(){return this._pipelineUBO}},{key:"pipelineSceneData",get:function(){return this._pipelineSceneData}},{key:"profiler",get:function(){return this._profiler},set:function(e){this._profiler=e}},{key:"geometryRenderer",get:function(){return this._geometryRenderer}},{key:"clusterEnabled",get:function(){return this._clusterEnabled},set:function(e){this._clusterEnabled=e}},{key:"bloomEnabled",get:function(){return this._bloomEnabled},set:function(e){this._bloomEnabled=e}}]),t}(yu),Ex=T((Sx=Cx).prototype,"_tag",[vx,Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Tx=T(Sx.prototype,"_flows",[gx,yx,Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),xx=Sx))||xx));b.RenderPipeline=Fx,function(e){e[e.BLOOM=18]="BLOOM",e[e.POST_PROCESS=19]="POST_PROCESS",e[e.UI=20]="UI"}(bx||(bx={})),function(e){e[e.FORWARD=10]="FORWARD"}(Ax||(Ax={})),function(e){e[e.SHADOW=0]="SHADOW",e[e.FORWARD=1]="FORWARD",e[e.UI=10]="UI"}(wx||(wx={})),function(e){e[e.GBUFFER=10]="GBUFFER",e[e.LIGHTING=15]="LIGHTING",e[e.TRANSPARENT=18]="TRANSPARENT"}(Ix||(Ix={})),function(e){e[e.SHADOW=0]="SHADOW",e[e.MAIN=1]="MAIN",e[e.UI=10]="UI"}(Px||(Px={}));var Bx=new Ir;Bx.format=ai.RGBA8;var zx=new Pr;zx.format=ai.DEPTH_STENCIL;var Ux,kx,Gx,Hx,Vx,Wx,jx,qx,Xx,Yx,Kx,Qx,Jx,Zx,$x,eS,tS,nS,iS,rS,oS,aS,sS,cS,lS,uS,hS,_S,fS,dS,pS,mS,vS,gS,yS,xS,SS,ES,TS,CS,bS,AS,wS,IS,PS,RS,DS,OS,NS,MS,LS,FS,BS,zS,US,kS,GS,HS,VS,WS,jS,qS,XS,YS,KS,QS,JS,ZS,$S,eE,tE,nE,iE,rE,oE,aE,sE,cE,lE,uE=new Or([Bx],zx),hE={width:1,height:1,renderPassInfo:uE},_E=e("RenderTexture",dc("cc.RenderTexture")(Rx=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._window=null,t}f(t,e);var n=t.prototype;return n.initialize=function(e){this._name=e.name||"",this._width=e.width,this._height=e.height,this._initWindow(e)},n.reset=function(e){this.initialize(e)},n.destroy=function(){if(this._window){var t=b.director.root;null==t||t.destroyWindow(this._window),this._window=null}return e.prototype.destroy.call(this)},n.resize=function(e,t){this._width=Math.floor(en(e,1,2048)),this._height=Math.floor(en(t,1,2048)),this._window&&this._window.resize(this._width,this._height),this.emit("resize",this._window)},n._serialize=function(){return{}},n._deserialize=function(t,n){var i=t;this._width=i.w,this._height=i.h,this._name=i.n,e.prototype._deserialize.call(this,i.base,n)},n.getGFXTexture=function(){return this._window&&this._window.framebuffer.colorTextures[0]},n.onLoaded=function(){this._initWindow()},n._initWindow=function(e){var t=b.director.root;hE.title=this._name,hE.width=this._width,hE.height=this._height,hE.renderPassInfo=e&&e.passInfo?e.passInfo:uE,Bx.barrier=t.device.getGeneralBarrier(new Nr(Pi.FRAGMENT_SHADER_READ_TEXTURE,Pi.FRAGMENT_SHADER_READ_TEXTURE)),this._window?(this._window.destroy(),this._window.initialize(t.device,hE)):this._window=t.createWindow(hE)},n.initDefault=function(t){e.prototype.initDefault.call(this,t),this._width=this._height=1,this._initWindow()},n.validate=function(){return this.width>=1&&this.width<=2048&&this.height>=1&&this.height<=2048},n.readPixels=function(e,t,n,i,r){void 0===e&&(e=0),void 0===t&&(t=0),n=n||this.width,i=i||this.height;var o=this.getGFXTexture();if(!o)return Y(7606),null;var a=4*n*i;if(void 0===r)r=new Uint8Array(a);else if(r.length<a)return Y(7607,a),null;var s=this._getGFXDevice(),c=[],l=[],u=new nr;return u.texOffset.x=e,u.texOffset.y=t,u.texExtent.width=n,u.texExtent.height=i,l.push(u),c.push(r),null==s||s.copyTextureToBuffers(o,c,l),r},h(t,[{key:"window",get:function(){return this._window}}]),t}(Em))||Rx);b.RenderTexture=_E,et(fi),et(di),et(Ii),et(wi),et(Pi),function(e){e[e.SCENE=0]="SCENE",e[e.POSTPROCESS=1]="POSTPROCESS",e[e.UI=2]="UI"}(lE||(lE={})),et(lE),Ux=dc("RenderTextureDesc"),kx=Jc(fi),Gx=Jc(di),Hx=Jc(ai),Ux((Wx=T((Vx=function(){E(this,"name",Wx,this),E(this,"type",jx,this),E(this,"usage",qx,this),E(this,"format",Xx,this),E(this,"width",Yx,this),E(this,"height",Kx,this)}).prototype,"name",[Ec,Nc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),jx=T(Vx.prototype,"type",[kx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return fi.TEX2D}}),qx=T(Vx.prototype,"usage",[Gx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return di.COLOR_ATTACHMENT}}),Xx=T(Vx.prototype,"format",[Hx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ai.UNKNOWN}}),Yx=T(Vx.prototype,"width",[Ec,Nc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),Kx=T(Vx.prototype,"height",[Ec,Nc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),Vx));var fE,dE=(Qx=dc("RenderTextureConfig"),Jx=Jc(_E),Qx((eS=T(($x=function(){E(this,"name",eS,this),E(this,"texture",tS,this)}).prototype,"name",[Ec,Nc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),tS=T($x.prototype,"texture",[Jx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Zx=$x))||Zx),pE=(nS=dc("MaterialConfig"),iS=Jc(Ov),nS((oS=T((rS=function(){E(this,"name",oS,this),E(this,"material",aS,this)}).prototype,"name",[Ec,Nc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),aS=T(rS.prototype,"material",[iS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),rS)),sS=dc("FrameBufferDesc"),cS=Jc([wt]),lS=Jc(_E),sS((hS=T((uS=function(){E(this,"name",hS,this),E(this,"renderPass",_S,this),E(this,"colorTextures",fS,this),E(this,"depthStencilTexture",dS,this),E(this,"texture",pS,this)}).prototype,"name",[Ec,Nc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),_S=T(uS.prototype,"renderPass",[Ec,Nc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),fS=T(uS.prototype,"colorTextures",[cS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),dS=T(uS.prototype,"depthStencilTexture",[Ec,Nc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),pS=T(uS.prototype,"texture",[lS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),uS)),mS=dc("ColorDesc"),vS=Jc(ai),gS=Jc(wi),yS=Jc(Ii),xS=Jc([Pi]),SS=Jc([Pi]),mS((CS=T((TS=function(){E(this,"format",CS,this),E(this,"loadOp",bS,this),E(this,"storeOp",AS,this),E(this,"sampleCount",wS,this),E(this,"beginAccesses",IS,this),E(this,"endAccesses",PS,this)}).prototype,"format",[vS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ai.UNKNOWN}}),bS=T(TS.prototype,"loadOp",[gS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return wi.CLEAR}}),AS=T(TS.prototype,"storeOp",[yS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ii.STORE}}),wS=T(TS.prototype,"sampleCount",[Ec,Nc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),IS=T(TS.prototype,"beginAccesses",[xS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Pi.NONE}}),PS=T(TS.prototype,"endAccesses",[SS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Pi.COLOR_ATTACHMENT_WRITE}}),ES=TS))||ES),mE=(RS=dc("DepthStencilDesc"),DS=Jc(ai),OS=Jc(wi),NS=Jc(Ii),MS=Jc(wi),LS=Jc(Ii),FS=Jc(Pi),BS=Jc(Pi),RS((kS=T((US=function(){E(this,"format",kS,this),E(this,"depthLoadOp",GS,this),E(this,"depthStoreOp",HS,this),E(this,"stencilLoadOp",VS,this),E(this,"stencilStoreOp",WS,this),E(this,"sampleCount",jS,this),E(this,"beginAccesses",qS,this),E(this,"endAccesses",XS,this)}).prototype,"format",[DS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ai.UNKNOWN}}),GS=T(US.prototype,"depthLoadOp",[OS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return wi.CLEAR}}),HS=T(US.prototype,"depthStoreOp",[NS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ii.STORE}}),VS=T(US.prototype,"stencilLoadOp",[MS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return wi.CLEAR}}),WS=T(US.prototype,"stencilStoreOp",[LS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ii.STORE}}),jS=T(US.prototype,"sampleCount",[Ec,Nc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),qS=T(US.prototype,"beginAccesses",[FS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Pi.NONE}}),XS=T(US.prototype,"endAccesses",[BS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Pi.DEPTH_STENCIL_ATTACHMENT_WRITE}}),zS=US))||zS);YS=dc("RenderPassDesc"),KS=Jc([pE]),QS=Jc(mE),YS((ZS=T((JS=function(){E(this,"index",ZS,this),E(this,"colorAttachments",$S,this),E(this,"depthStencilAttachment",eE,this)}).prototype,"index",[Ec,Nc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),$S=T(JS.prototype,"colorAttachments",[KS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),eE=T(JS.prototype,"depthStencilAttachment",[QS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new mE}}),JS)),function(e){e[e.FRONT_TO_BACK=0]="FRONT_TO_BACK",e[e.BACK_TO_FRONT=1]="BACK_TO_FRONT"}(fE||(fE={})),et(fE);var vE=(tE=dc("RenderQueueDesc"),nE=Jc(fE),iE=Jc([wt]),tE((aE=T((oE=function(){E(this,"isTransparent",aE,this),E(this,"sortMode",sE,this),E(this,"stages",cE,this)}).prototype,"isTransparent",[Ec,Nc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),sE=T(oE.prototype,"sortMode",[nE],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return fE.FRONT_TO_BACK}}),cE=T(oE.prototype,"stages",[iE],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),rE=oE))||rE);function gE(e,t){return e.hash-t.hash||e.depth-t.depth||e.shaderId-t.shaderId}function yE(e,t){return e.hash-t.hash||t.depth-e.depth||e.shaderId-t.shaderId}var xE=function(){function e(e){this.queue=void 0,this._passDesc=void 0,this._passPool=void 0,this._passDesc=e,this._passPool=new Ll((function(){return{hash:0,depth:0,shaderId:0,subModel:null,passIdx:0}}),64),this.queue=new Fl(64,this._passDesc.sortFunc)}var t=e.prototype;return t.clear=function(){this.queue.clear(),this._passPool.reset()},t.insertRenderPass=function(e,t,n){var i=e.model.subModels[t],r=i.passes[n],o=i.shaders[n];if(r.blendState.targets[0].blend!==this._passDesc.isTransparent||!(r.phase&this._passDesc.phases))return!1;var a=0|r.priority<<16|i.priority<<8|n,s=this._passPool.add();return s.hash=a,s.depth=e.depth||0,s.shaderId=o.typedID,s.subModel=i,s.passIdx=n,this.queue.push(s),!0},t.sort=function(){this.queue.sort()},t.recordCommandBuffer=function(e,t,n){for(var i=0;i<this.queue.length;++i){var r=this.queue.array[i],o=r.subModel,a=r.passIdx,s=o.inputAssembler,c=o.passes[a],l=o.shaders[a],u=uv.getOrCreatePipelineState(e,c,l,t,s);n.bindPipelineState(u),n.bindDescriptorSet(md.MATERIAL,c.descriptorSet),n.bindDescriptorSet(md.LOCAL,o.descriptorSet),n.bindInputAssembler(s),n.draw(s)}},e}();function SE(e){for(var t=0,n=0;n<e.stages.length;n++)t|=iv(e.stages[n]);var i=gE;switch(e.sortMode){case fE.BACK_TO_FRONT:i=yE;break;case fE.FRONT_TO_BACK:i=gE}return new xE({isTransparent:e.isTransparent,phases:t,sortFunc:i})}function EE(e){e.clear()}function TE(e){e.sort()}var CE=function(){function e(){this.queue=new Set}var t=e.prototype;return t.clear=function(){for(var e=this.queue.values(),t=e.next();!t.done;)t.value.clear(),t=e.next();this.queue.clear()},t.uploadBuffers=function(e){for(var t=this.queue.values(),n=t.next();!n.done;){for(var i=0;i<n.value.batches.length;++i){var r=n.value.batches[i];if(r.mergeCount){for(var o=0;o<r.vbs.length;++o)r.vbs[o].update(r.vbDatas[o]);e.updateBuffer(r.vbIdx,r.vbIdxData.buffer),e.updateBuffer(r.ubo,r.uboData)}}n=t.next()}},t.recordCommandBuffer=function(e,t,n,i){void 0===i&&(i=null);for(var r=this.queue.values(),o=r.next();!o.done;){for(var a=!1,s=0;s<o.value.batches.length;++s){var c=o.value.batches[s];if(c.mergeCount){if(!a){var l=c.shader,u=uv.getOrCreatePipelineState(e,c.pass,l,t,c.ia);n.bindPipelineState(u),n.bindDescriptorSet(md.MATERIAL,c.pass.descriptorSet),a=!0}i&&n.bindDescriptorSet(md.GLOBAL,i),n.bindDescriptorSet(md.LOCAL,c.descriptorSet,o.value.dynamicOffsets),n.bindInputAssembler(c.ia),n.draw(c.ia)}}o=r.next()}},e}(),bE=function(){function e(){this.queue=new Set}var t=e.prototype;return t.clear=function(){for(var e=this.queue.values(),t=e.next();!t.done;)t.value.clear(),t=e.next();this.queue.clear()},t.uploadBuffers=function(e){for(var t=this.queue.values(),n=t.next();!n.done;)n.value.hasPendingModels&&n.value.uploadBuffers(e),n=t.next()},t.recordCommandBuffer=function(e,t,n,i){void 0===i&&(i=null);for(var r=this.queue.values(),o=r.next();!o.done;){var a=o.value,s=a.instances,c=a.pass;if(a.hasPendingModels){n.bindDescriptorSet(md.MATERIAL,c.descriptorSet);for(var l=null,u=0;u<s.length;++u){var h=s[u];if(h.count){var _=h.shader,f=uv.getOrCreatePipelineState(e,c,_,t,h.ia);l!==f&&(n.bindPipelineState(f),l=f),i&&n.bindDescriptorSet(md.GLOBAL,i),n.bindDescriptorSet(md.LOCAL,h.descriptorSet,o.value.dynamicOffsets),n.bindInputAssembler(h.ia),n.draw(h.ia)}}}o=r.next()}},e}(),AE=new Ml((function(){return{subModel:null,passIdx:-1,dynamicOffsets:[],lights:[]}}),16),wE=new Float32Array(4),IE=[],PE=[],RE=new kn,DE=new kn;function OE(e,t){return!(!t.worldBounds||rs.aabbWithAABB(t.worldBounds,e.aabb))}function NE(e,t){return!(!t.worldBounds||rs.aabbWithAABB(t.worldBounds,e.aabb)&&rs.aabbFrustum(t.worldBounds,e.frustum))}var ME=iv("forward-add"),LE=[];function FE(e,t){t.length=0;for(var n=!1,i=0;i<e.length;i++){for(var r=e[i].passes,o=-1,a=0;a<r.length;a++)if(r[a].phase===ME){o=a,n=!0;break}t.push(o)}return n}var BE,zE,UE,kE,GE,HE,VE,WE,jE,qE,XE,YE=function(){function e(e){this._pipeline=void 0,this._device=void 0,this._lightPasses=[],this._shadowUBO=new Float32Array(Td.COUNT),this._lightBufferCount=16,this._lightBufferStride=void 0,this._lightBufferElementCount=void 0,this._lightBuffer=void 0,this._firstLightBufferView=void 0,this._lightBufferData=void 0,this._instancedQueue=void 0,this._batchedQueue=void 0,this._lightMeterScale=1e4,this._pipeline=e,this._device=e.device,this._instancedQueue=new bE,this._batchedQueue=new CE;var t=this._device.capabilities.uboOffsetAlignment;this._lightBufferStride=Math.ceil(kd.SIZE/t)*t,this._lightBufferElementCount=this._lightBufferStride/Float32Array.BYTES_PER_ELEMENT,this._lightBuffer=this._device.createBuffer(new cr(li.UNIFORM|li.TRANSFER_DST,_i.HOST|_i.DEVICE,this._lightBufferStride*this._lightBufferCount,this._lightBufferStride)),this._firstLightBufferView=this._device.createBuffer(new lr(this._lightBuffer,0,kd.SIZE)),this._lightBufferData=new Float32Array(this._lightBufferElementCount*this._lightBufferCount)}var t=e.prototype;return t.clear=function(){this._instancedQueue.clear(),this._batchedQueue.clear();for(var e=0;e<this._lightPasses.length;e++){var t=this._lightPasses[e];t.dynamicOffsets.length=0,t.lights.length=0}AE.freeArray(this._lightPasses),this._lightPasses.length=0},t.destroy=function(){for(var e=this._pipeline.globalDSManager.descriptorSetMap,t=e.keys,n=0;n<t.length;n++){var i=t[n],r=e.get(i);r&&(r.getBuffer(Td.BINDING).destroy(),r.getTexture(Cd).destroy(),r.getTexture(Nd).destroy(),r.destroy()),e.delete(i)}},t.gatherLightPasses=function(e,t){this.clear();var n=this._pipeline.pipelineSceneData.validPunctualLights;if(n.length){this._updateUBOs(e,t),this._updateLightDescriptorSet(e,t);for(var i=this._pipeline.pipelineSceneData.renderObjects,r=0;r<i.length;r++){var o=i[r].model,a=o.subModels;if(FE(a,LE)&&(PE.length=0,this._lightCulling(o,n),PE.length))for(var s=0;s<a.length;s++){var c=LE[s];if(!(c<0)){var l=a[s],u=l.passes[c];l.passes[0].blendState.targets[0].blend||(l.descriptorSet.bindBuffer(kd.BINDING,this._firstLightBufferView),l.descriptorSet.update(),this._addRenderQueue(u,l,o,c))}}}this._instancedQueue.uploadBuffers(t),this._batchedQueue.uploadBuffers(t)}},t.recordCommandBuffer=function(e,t,n){for(var i=this._pipeline.globalDSManager,r=0;r<PE.length;r++){var o=PE[r],a=i.getOrCreateDescriptorSet(o);this._instancedQueue.recordCommandBuffer(e,t,n,a),this._batchedQueue.recordCommandBuffer(e,t,n,a)}for(var s=0;s<this._lightPasses.length;s++){var c=this._lightPasses[s],l=c.subModel,u=c.passIdx,h=c.dynamicOffsets,_=c.lights,f=l.passes[u],d=l.shaders[u],p=l.inputAssembler,m=uv.getOrCreatePipelineState(e,f,d,t,p),v=f.descriptorSet,g=l.descriptorSet;n.bindPipelineState(m),n.bindDescriptorSet(md.MATERIAL,v),n.bindInputAssembler(p);for(var y=0;y<h.length;++y){var x=_[y],S=i.getOrCreateDescriptorSet(x);IE[0]=h[y],n.bindDescriptorSet(md.GLOBAL,S),n.bindDescriptorSet(md.LOCAL,g,IE),n.draw(p)}}},t._lightCulling=function(e,t){for(var n=!1,i=!function(e){for(var t=e.subModels,n=0;n<t.length;++n)for(var i=t[n].passes,r=0;r<i.length;++r){var o=i[r].batchingScheme;if(o===Zm.INSTANCING)return!0;if(o===Zm.VB_MERGING)return!0}return!1}(e),r=0;r<t.length;r++){var o=t[r];switch(o.type){case $g.SPHERE:i&&(n=OE(o,e));break;case $g.SPOT:i&&(n=NE(o,e))}n||PE.push(r)}},t._addRenderQueue=function(e,t,n,i){var r=e.batchingScheme;if(r===Zm.INSTANCING)for(var o=0;o<PE.length;o++){var a=PE[o],s=e.getInstancedBuffer(a);s.merge(t,n.instancedAttributes,i),s.dynamicOffsets[0]=this._lightBufferStride*a,this._instancedQueue.queue.add(s)}else if(r===Zm.VB_MERGING)for(var c=0;c<PE.length;c++){var l=PE[c],u=e.getBatchedBuffer(l);u.merge(t,i,n),u.dynamicOffsets[0]=this._lightBufferStride*l,this._batchedQueue.queue.add(u)}else{var h=AE.alloc();h.subModel=t,h.passIdx=i;for(var _=0;_<PE.length;_++){var f=PE[_];h.lights.push(f),h.dynamicOffsets.push(this._lightBufferStride*f)}this._lightPasses.push(h)}},t._updateLightDescriptorSet=function(e,t){for(var n=this._pipeline.device,i=this._pipeline.pipelineSceneData,r=i.shadows,o=i.shadowFrameBufferMap,a=e.scene.mainLight,s=Tp(n)?0:1,c=this._pipeline.globalDSManager,l=i.validPunctualLights,u=0;u<l.length;u++){var h=l[u],_=c.getOrCreateDescriptorSet(u);if(_){var f=void 0,d=void 0;switch(h.type){case $g.SPHERE:a&&(Eg(r,a,this._shadowUBO),Tg(r,this._shadowUBO)),this._shadowUBO[Td.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+0]=r.size.x,this._shadowUBO[Td.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+1]=r.size.y,this._shadowUBO[Td.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+2]=1,this._shadowUBO[Td.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+3]=0,this._shadowUBO[Td.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+0]=2,this._shadowUBO[Td.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+1]=s,this._shadowUBO[Td.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+2]=0,this._shadowUBO[Td.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+3]=0,Qn.toArray(this._shadowUBO,r.shadowColor,Td.SHADOW_COLOR_OFFSET);break;case $g.SPOT:var p=h;if(a&&(Eg(r,a,this._shadowUBO),Tg(r,this._shadowUBO)),kn.invert(RE,h.node.getWorldMatrix()),kn.perspective(DE,h.angle,1,.001,h.range),f=DE.clone(),d=DE.clone().invert(),kn.multiply(DE,DE,RE),kn.toArray(this._shadowUBO,RE,Td.MAT_LIGHT_VIEW_OFFSET),kn.toArray(this._shadowUBO,DE,Td.MAT_LIGHT_VIEW_PROJ_OFFSET),this._shadowUBO[Td.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+0]=.01,this._shadowUBO[Td.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+1]=h.range,this._shadowUBO[Td.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+2]=0,this._shadowUBO[Td.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+3]=0,this._shadowUBO[Td.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+0]=r.size.x,this._shadowUBO[Td.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+1]=r.size.y,this._shadowUBO[Td.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+2]=p.shadowPcf,this._shadowUBO[Td.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+3]=p.shadowBias,this._shadowUBO[Td.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+0]=1,this._shadowUBO[Td.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+1]=s,this._shadowUBO[Td.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+2]=p.shadowNormalBias,this._shadowUBO[Td.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+3]=0,this._shadowUBO[Td.SHADOW_PROJ_DEPTH_INFO_OFFSET+0]=f.m10,this._shadowUBO[Td.SHADOW_PROJ_DEPTH_INFO_OFFSET+1]=f.m14,this._shadowUBO[Td.SHADOW_PROJ_DEPTH_INFO_OFFSET+2]=f.m11,this._shadowUBO[Td.SHADOW_PROJ_DEPTH_INFO_OFFSET+3]=f.m15,this._shadowUBO[Td.SHADOW_INV_PROJ_DEPTH_INFO_OFFSET+0]=d.m10,this._shadowUBO[Td.SHADOW_INV_PROJ_DEPTH_INFO_OFFSET+1]=d.m14,this._shadowUBO[Td.SHADOW_INV_PROJ_DEPTH_INFO_OFFSET+2]=d.m11,this._shadowUBO[Td.SHADOW_INV_PROJ_DEPTH_INFO_OFFSET+3]=d.m15,this._shadowUBO[Td.SHADOW_PROJ_INFO_OFFSET+0]=f.m00,this._shadowUBO[Td.SHADOW_PROJ_INFO_OFFSET+1]=f.m05,this._shadowUBO[Td.SHADOW_PROJ_INFO_OFFSET+2]=1/f.m00,this._shadowUBO[Td.SHADOW_PROJ_INFO_OFFSET+3]=1/f.m05,Qn.toArray(this._shadowUBO,r.shadowColor,Td.SHADOW_COLOR_OFFSET),o.has(h)){var m,v=null===(m=o.get(h))||void 0===m?void 0:m.colorTextures[0];v&&_.bindTexture(Nd,v)}}_.update(),t.updateBuffer(_.getBuffer(Td.BINDING),this._shadowUBO)}}},t._updateUBOs=function(e,t){var n=e.exposure,i=this._pipeline.pipelineSceneData,r=i.isHDR,o=i.shadows,a=i.validPunctualLights;a.length>this._lightBufferCount&&(this._firstLightBufferView.destroy(),this._lightBufferCount=_n(a.length),this._lightBuffer.resize(this._lightBufferStride*this._lightBufferCount),this._lightBufferData=new Float32Array(this._lightBufferElementCount*this._lightBufferCount),this._firstLightBufferView.initialize(new lr(this._lightBuffer,0,kd.SIZE)));for(var s=0,c=0;s<a.length;s++,c+=this._lightBufferElementCount){var l=a[s];switch(l.type){case $g.SPHERE:if(yn.toArray(wE,l.position),wE[3]=0,this._lightBufferData.set(wE,c+kd.LIGHT_POS_OFFSET),wE[0]=l.size,wE[1]=l.range,wE[2]=0,wE[3]=0,this._lightBufferData.set(wE,c+kd.LIGHT_SIZE_RANGE_ANGLE_OFFSET),yn.toArray(wE,l.color),l.useColorTemperature){var u=l.colorTemperatureRGB;wE[0]*=u.x,wE[1]*=u.y,wE[2]*=u.z}wE[3]=r?l.luminance*n*this._lightMeterScale:l.luminance,this._lightBufferData.set(wE,c+kd.LIGHT_COLOR_OFFSET);break;case $g.SPOT:if(yn.toArray(wE,l.position),wE[3]=1,this._lightBufferData.set(wE,c+kd.LIGHT_POS_OFFSET),wE[0]=l.size,wE[1]=l.range,wE[2]=l.spotAngle,wE[3]=o.enabled&&l.shadowEnabled&&o.type===Vv.ShadowMap?1:0,this._lightBufferData.set(wE,c+kd.LIGHT_SIZE_RANGE_ANGLE_OFFSET),yn.toArray(wE,l.direction),this._lightBufferData.set(wE,c+kd.LIGHT_DIR_OFFSET),yn.toArray(wE,l.color),l.useColorTemperature){var h=l.colorTemperatureRGB;wE[0]*=h.x,wE[1]*=h.y,wE[2]*=h.z}wE[3]=r?l.luminance*n*this._lightMeterScale:l.luminance,this._lightBufferData.set(wE,c+kd.LIGHT_COLOR_OFFSET)}}t.updateBuffer(this._lightBuffer,this._lightBufferData)},e}(),KE=new Us,QE=function(){function e(e){this._pendingModels=[],this._castModels=[],this._instancedQueue=new bE,this._pipeline=void 0,this._pipeline=e}var t=e.prototype;return t.gatherShadowPasses=function(e,t){var n=this._pipeline.pipelineSceneData,i=(this._pipeline.pipelineUBO,n.shadows);if(this._instancedQueue.clear(),this._pendingModels.length=0,this._castModels.length=0,i.enabled&&i.type===Vv.Planar&&!(i.normal.length()<1e-6)){var r=e.scene,o=e.frustum,a=0!=(e.visibility&rd.BitMask.DEFAULT);if(r.mainLight&&a){for(var s=r.models,c=0;c<s.length;c++){var l=s[c];l.enabled&&l.node&&l.castShadow&&this._castModels.push(l)}var u=i.instancingMaterial.passes[0].getInstancedBuffer();this._instancedQueue.queue.add(u);for(var h=0;h<this._castModels.length;h++){var _=this._castModels[h];if(!_.worldBounds||(Us.transform(KE,_.worldBounds,i.matLight),rs.aabbFrustum(KE,o)))if(_.isInstancingEnabled)for(var f=_.subModels,d=0;d<f.length;d++){var p=f[d];u.merge(p,_.instancedAttributes,0,p.planarInstanceShader)}else this._pendingModels.push(_)}this._instancedQueue.uploadBuffers(t)}}},t.recordCommandBuffer=function(e,t,n){var i=this._pipeline.pipelineSceneData.shadows;if(i.enabled&&i.type===Vv.Planar&&(this._instancedQueue.recordCommandBuffer(e,t,n),this._pendingModels.length)){var r=i.material.passes[0],o=r.descriptorSet;n.bindDescriptorSet(md.MATERIAL,o);for(var a=this._pendingModels.length,s=0;s<a;s++)for(var c=this._pendingModels[s],l=0;l<c.subModels.length;l++){var u=c.subModels[l],h=u.planarShader,_=u.inputAssembler,f=uv.getOrCreatePipelineState(e,r,h,t,_);n.bindPipelineState(f),n.bindDescriptorSet(md.LOCAL,u.descriptorSet),n.bindInputAssembler(_),n.draw(_)}}},e}(),JE=function(){function e(){this._phaseID=iv("default")}var t=e.prototype;return t.activate=function(e){this._pipeline=e},t.render=function(e,t){for(var n=this._pipeline,i=n.device,r=n.commandBuffers[0],o=e.scene.batches,a=0;a<o.length;a++){var s=o[a],c=!1;if(e.visibility&s.visFlags&&(c=!0),c)for(var l=s.shaders.length,u=0;u<l;u++){var h=s.passes[u];if(h.phase===this._phaseID){var _=s.shaders[u],f=s.inputAssembler,d=uv.getOrCreatePipelineState(i,h,_,t,f);r.bindPipelineState(d),r.bindDescriptorSet(md.MATERIAL,h.descriptorSet);var p=s.descriptorSet;r.bindDescriptorSet(md.LOCAL,p),r.bindInputAssembler(f),r.draw(f)}}}},e}(),ZE=[new rr(0,0,0,1)],$E=e("ForwardStage",(BE=dc("ForwardStage"),zE=Jc([vE]),UE=Vc(),BE((WE=VE=function(e){function t(){var t;return E(t=e.call(this)||this,"renderQueues",HE,y(t)),t._renderQueues=[],t._renderArea=new Qi,t._batchedQueue=void 0,t._instancedQueue=void 0,t._phaseID=iv("default"),t._clearFlag=4294967295,t._batchedQueue=new CE,t._instancedQueue=new bE,t._uiPhase=new JE,t}f(t,e);var n=t.prototype;return n.initialize=function(t){return e.prototype.initialize.call(this,t),t.renderQueues&&(this.renderQueues=t.renderQueues),!0},n.activate=function(t,n){e.prototype.activate.call(this,t,n);for(var i=0;i<this.renderQueues.length;i++)this._renderQueues[i]=SE(this.renderQueues[i]);this._additiveLightQueue=new YE(this._pipeline),this._planarQueue=new QE(this._pipeline),this._uiPhase.activate(t)},n.destroy=function(){},n.render=function(e){this._instancedQueue.clear(),this._batchedQueue.clear();var t=this._pipeline,n=t.device;this._renderQueues.forEach(EE);for(var i=t.pipelineSceneData.renderObjects,r=0,o=0,a=0,s=0;s<i.length;++s){var c=i[s],l=c.model.subModels;for(r=0;r<l.length;++r){var u=l[r],h=u.passes;for(o=0;o<h.length;++o){var _=h[o];if(_.phase===this._phaseID){var f=_.batchingScheme;if(f===Zm.INSTANCING){var d=_.getInstancedBuffer();d.merge(u,c.model.instancedAttributes,o),this._instancedQueue.queue.add(d)}else if(f===Zm.VB_MERGING){var p=_.getBatchedBuffer();p.merge(u,o,c.model),this._batchedQueue.queue.add(p)}else for(a=0;a<this._renderQueues.length;a++)this._renderQueues[a].insertRenderPass(c,r,o)}}}}this._renderQueues.forEach(TE);var m=t.commandBuffers[0];t.pipelineUBO.updateShadowUBO(e),this._instancedQueue.uploadBuffers(m),this._batchedQueue.uploadBuffers(m),this._additiveLightQueue.gatherLightPasses(e,m),this._planarQueue.gatherShadowPasses(e,m),e.clearFlag&Hi.COLOR&&(ZE[0].x=e.clearColor.x,ZE[0].y=e.clearColor.y,ZE[0].z=e.clearColor.z,ZE[0].w=e.clearColor.w),t.generateRenderArea(e,this._renderArea);var v=e.window.framebuffer,g=t.getRenderPass(e.clearFlag&this._clearFlag,v);m.beginRenderPass(g,v,this._renderArea,ZE,e.clearDepth,e.clearStencil),m.bindDescriptorSet(md.GLOBAL,t.descriptorSet),this._renderQueues[0].recordCommandBuffer(n,g,m),this._instancedQueue.recordCommandBuffer(n,g,m),this._batchedQueue.recordCommandBuffer(n,g,m),this._additiveLightQueue.recordCommandBuffer(n,g,m),m.bindDescriptorSet(md.GLOBAL,t.descriptorSet),this._planarQueue.recordCommandBuffer(n,g,m),this._renderQueues[1].recordCommandBuffer(n,g,m),this._pipeline.geometryRenderer.render(g,m),this._uiPhase.render(e,g),bv(n,g,m,t.profiler,e),m.endRenderPass()},t}(fx),VE.initInfo={name:"ForwardStage",priority:Ax.FORWARD,tag:0,renderQueues:[{isTransparent:!1,sortMode:fE.FRONT_TO_BACK,stages:["default"]},{isTransparent:!0,sortMode:fE.BACK_TO_FRONT,stages:["default","planarShadow"]}]},HE=T((GE=WE).prototype,"renderQueues",[zE,Ec,UE],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),kE=GE))||kE)),eT=e("ForwardFlow",dc("ForwardFlow")((XE=qE=function(e){function t(){return e.apply(this,arguments)||this}f(t,e);var n=t.prototype;return n.initialize=function(t){if(e.prototype.initialize.call(this,t),0===this._stages.length){var n=new $E;n.initialize($E.initInfo),this._stages.push(n)}return!0},n.activate=function(t){e.prototype.activate.call(this,t)},n.render=function(t){e.prototype.render.call(this,t)},n.destroy=function(){e.prototype.destroy.call(this)},t}(px),qE.initInfo={name:cd,priority:wx.FORWARD,stages:[]},jE=XE))||jE),tT=new kn,nT=new kn,iT=new kn,rT=new Us,oT=iv("shadow-caster"),aT=[];function sT(e,t){t.length=0;for(var n=!1,i=0;i<e.length;i++){for(var r=e[i].passes,o=-1,a=0;a<r.length;a++)if(r[a].phase===oT){o=a,n=!0;break}t.push(o)}return n}var cT,lT,uT,hT,_T,fT,dT,pT,mT,vT,gT,yT=function(){function e(e){this._pipeline=void 0,this._subModelsArray=[],this._passArray=[],this._shaderArray=[],this._instancedQueue=void 0,this._batchedQueue=void 0,this._pipeline=e,this._instancedQueue=new bE,this._batchedQueue=new CE}var t=e.prototype;return t.gatherLightPasses=function(e,t,n,i){this.clear();var r=this._pipeline.pipelineSceneData,o=r.shadows;if(n&&o.enabled&&o.type===Vv.ShadowMap){var a=r.dirShadowObjects,s=r.castShadowObjects;switch(n.type){case $g.DIRECTIONAL:for(var c=0;c<a.length;c++){var l=a[c].model;sT(l.subModels,aT)&&this.add(l,aT)}break;case $g.SPOT:kn.invert(tT,n.node.getWorldMatrix()),kn.perspective(nT,n.angle,1,.001,n.range),kn.multiply(iT,nT,tT);for(var u=0;u<s.length;u++){var h=s[u].model;sT(h.subModels,aT)&&(h.worldBounds&&(Us.transform(rT,h.worldBounds,iT),!rs.aabbFrustum(rT,t.frustum))||this.add(h,aT))}}this._instancedQueue.uploadBuffers(i),this._batchedQueue.uploadBuffers(i)}},t.clear=function(){this._subModelsArray.length=0,this._shaderArray.length=0,this._passArray.length=0,this._instancedQueue.clear(),this._batchedQueue.clear()},t.add=function(e,t){for(var n=e.subModels,i=0;i<n.length;i++){var r=n[i],o=t[i],a=r.passes[o];if(a.batchingScheme===Zm.INSTANCING){var s=a.getInstancedBuffer();s.merge(r,e.instancedAttributes,o),this._instancedQueue.queue.add(s)}else if(a.batchingScheme===Zm.VB_MERGING){var c=a.getBatchedBuffer();c.merge(r,o,e),this._batchedQueue.queue.add(c)}else{var l=r.shaders[o];this._subModelsArray.push(r),l&&this._shaderArray.push(l),this._passArray.push(a)}}},t.recordCommandBuffer=function(e,t,n){this._instancedQueue.recordCommandBuffer(e,t,n),this._batchedQueue.recordCommandBuffer(e,t,n);for(var i=0;i<this._subModelsArray.length;++i){var r=this._subModelsArray[i],o=this._shaderArray[i],a=this._passArray[i],s=r.inputAssembler,c=uv.getOrCreatePipelineState(e,a,o,t,s),l=a.descriptorSet;n.bindPipelineState(c),n.bindDescriptorSet(md.MATERIAL,l),n.bindDescriptorSet(md.LOCAL,r.descriptorSet),n.bindInputAssembler(s),n.draw(s)}},e}(),xT=[new rr(1,1,1,1)],ST=e("ShadowStage",dc("ShadowStage")((uT=lT=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._shadowFrameBuffer=null,t._renderArea=new Qi,t._light=null,t._globalDS=null,t}f(t,e);var n=t.prototype;return n.setUsage=function(e,t,n){this._globalDS=e,this._light=t,this._shadowFrameBuffer=n},n.destroy=function(){var e;this._shadowFrameBuffer=null,this._globalDS=null,this._light=null,null===(e=this._additiveShadowQueue)||void 0===e||e.clear()},n.clearFramebuffer=function(e){if(this._light&&this._shadowFrameBuffer){xT[0].w=e.clearColor.w;var t=this._pipeline.commandBuffers[0],n=this._shadowFrameBuffer.renderPass;t.beginRenderPass(n,this._shadowFrameBuffer,this._renderArea,xT,e.clearDepth,e.clearStencil),t.endRenderPass()}},n.render=function(e){var t=this._pipeline,n=t.pipelineSceneData,i=n.shadows,r=n.shadingScale,o=this._globalDS,a=t.commandBuffers[0];if(this._light&&this._shadowFrameBuffer){this._pipeline.pipelineUBO.updateShadowUBOLight(o,this._light),this._additiveShadowQueue.gatherLightPasses(o,e,this._light,a);var s=e.viewport,c=i.size;this._renderArea.x=s.x*c.x,this._renderArea.y=s.y*c.y,this._renderArea.width=s.width*c.x*r,this._renderArea.height=s.height*c.y*r;var l=t.device,u=this._shadowFrameBuffer.renderPass;a.beginRenderPass(u,this._shadowFrameBuffer,this._renderArea,xT,e.clearDepth,e.clearStencil),a.bindDescriptorSet(md.GLOBAL,o),this._additiveShadowQueue.recordCommandBuffer(l,u,a),a.endRenderPass()}},n.activate=function(t,n){e.prototype.activate.call(this,t,n),this._additiveShadowQueue=new yT(t)},t}(fx),lT.initInfo={name:"ShadowStage",priority:Ax.FORWARD,tag:0},cT=uT))||cT),ET=[],TT=e("ShadowFlow",dc("ShadowFlow")((fT=_T=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._shadowRenderPass=null,t}f(t,e);var n=t.prototype;return n.initialize=function(t){if(e.prototype.initialize.call(this,t),0===this._stages.length){var n=new ST;n.initialize(ST.initInfo),this._stages.push(n)}return!0},n.render=function(e){var t=this._pipeline,n=t.pipelineSceneData.shadows,i=t.pipelineSceneData.shadowFrameBufferMap,r=t.pipelineSceneData.castShadowObjects,o=this._pipeline.pipelineSceneData.validPunctualLights;if(n.enabled&&n.type===Vv.ShadowMap){for(var a=0,s=0;a<n.maxReceived&&s<o.length;){var c=o[s];c.type===$g.SPOT&&(ET.push(c),a++),s++}if(0!==r.length){n.shadowMapDirty&&this.resizeShadowMap();var l=e.scene.mainLight;if(l){var u=t.descriptorSet;i.has(l)||this._initShadowFrameBuffer(t,l,e.window.swapchain);for(var h=i.get(l),_=0;_<this._stages.length;_++){var f=this._stages[_];f.setUsage(u,l,h),f.render(e)}}for(var d=0;d<ET.length;d++){var p=ET[d],m=t.globalDSManager.getOrCreateDescriptorSet(d);i.has(p)||this._initShadowFrameBuffer(t,p,e.window.swapchain);for(var v=i.get(p),g=0;g<this._stages.length;g++){var y=this._stages[g];y.setUsage(m,p,v),y.render(e)}}ET.length=0}else this.clearShadowMap(ET,e)}},n.destroy=function(){if(e.prototype.destroy.call(this),this._pipeline){for(var t=this._pipeline.pipelineSceneData.shadowFrameBufferMap,n=Array.from(t.values()),i=0;i<n.length;i++){var r=n[i];if(r){for(var o=r.colorTextures,a=0;a<o.length;a++){var s=o[i];s&&s.destroy()}o.length=0;var c=r.depthStencilTexture;c&&c.destroy(),r.destroy()}}t.clear()}this._shadowRenderPass&&this._shadowRenderPass.destroy()},n._initShadowFrameBuffer=function(e,t){var n=e.device,i=e.pipelineSceneData.shadows.size,r=e.pipelineSceneData.shadowFrameBufferMap,o=Tp(n)?ai.R32F:ai.RGBA8;if(!this._shadowRenderPass){var a=new Ir;a.format=o,a.loadOp=wi.CLEAR,a.storeOp=Ii.STORE,a.sampleCount=1;var s=new Pr;s.format=ai.DEPTH_STENCIL,s.depthLoadOp=wi.CLEAR,s.depthStoreOp=Ii.DISCARD,s.stencilLoadOp=wi.CLEAR,s.stencilStoreOp=Ii.DISCARD,s.sampleCount=1;var c=new Or([a],s);this._shadowRenderPass=n.createRenderPass(c)}var l=[];l.push(n.createTexture(new fr(fi.TEX2D,di.COLOR_ATTACHMENT|di.SAMPLED,o,i.x,i.y)));var u=n.createTexture(new fr(fi.TEX2D,di.DEPTH_STENCIL_ATTACHMENT,ai.DEPTH_STENCIL,i.x,i.y)),h=n.createFramebuffer(new Lr(this._shadowRenderPass,l,u));r.set(t,h)},n.clearShadowMap=function(e,t){var n=this._pipeline,i=n.pipelineSceneData,r=t.scene.mainLight;if(r){var o=this._pipeline.descriptorSet;i.shadowFrameBufferMap.has(r)||this._initShadowFrameBuffer(this._pipeline,r,t.window.swapchain);for(var a=i.shadowFrameBufferMap.get(r),s=0;s<this._stages.length;s++){var c=this._stages[s];c.setUsage(o,r,a),c.render(t)}}for(var l=0;l<e.length;l++){var u=e[l],h=i.shadowFrameBufferMap.get(u),_=n.globalDSManager.getOrCreateDescriptorSet(l);if(i.shadowFrameBufferMap.has(u))for(var f=0;f<this._stages.length;f++){var d=this._stages[f];d.setUsage(_,u,h),d.clearFramebuffer(t)}}},n.resizeShadowMap=function(){for(var e=this._pipeline.pipelineSceneData.shadows,t=e.size,n=this._pipeline,i=n.device,r=n.pipelineSceneData.shadowFrameBufferMap,o=Tp(i)?ai.R32F:ai.RGBA8,a=r.values(),s=a.next();!s.done;){var c=s.value;if(c){var l=[];l.push(n.device.createTexture(new fr(fi.TEX2D,di.COLOR_ATTACHMENT|di.SAMPLED,o,t.x,t.y)));var u=c.depthStencilTexture;u&&u.resize(t.x,t.y);var h=c.renderPass;c.destroy(),c.initialize(new Lr(h,l,u)),s=a.next()}else s=a.next()}e.shadowMapDirty=!1},t}(px),_T.initInfo={name:ld,priority:wx.SHADOW,tag:lE.SCENE,stages:[]},hT=fT))||hT),CT=10,bT=0,AT=new Map;function wT(e,t){for(var n,i=S(t);!(n=i()).done;){var r=n.value;Array.isArray(r)?wT(e,r):e.push(r)}}function IT(e){var t=[];return wT(t,e),t.join("")}mT=function(e,t,n,i,r,o,a){var s=AT.get(o);s&&s.logTimes>s.count&&(r("'%s' is deprecated, please use '%s' instead. "+a,e+"."+t,n+"."+i),s.count++)},dT=e("replaceProperty",(function(e,t,n){null!=e&&n.forEach((function(n){var i=bT++;AT.set(i,{id:i,count:0,logTimes:void 0!==n.logTimes?n.logTimes:CT});var r=null!=n.target?n.target:e,o=null!=n.newName?n.newName:n.name,a=null!=n.targetName?n.targetName:t,s=r===e,c=n.suggest?"("+n.suggest+")":"";if(null!=n.customFunction)e[n.name]=function(){var e;return mT(t,n.name,a,o,F,i,c),(e=n.customFunction).call.apply(e,[this].concat(Array.prototype.slice.call(arguments)))};else if(null!=n.customSetter||null!=n.customGetter){var l=null!=n.customSetter,u=null!=n.customGetter;l&&u?Object.defineProperty(e,n.name,{get:function(){return mT(t,n.name,a,o,F,i,c),n.customGetter.call(this)},set:function(e){mT(t,n.name,a,o,F,i,c),n.customSetter.call(this,e)},enumerable:!1}):l?Object.defineProperty(e,n.name,{set:function(e){mT(t,n.name,a,o,F,i,c),n.customSetter.call(this,e)},enumerable:!1}):u&&Object.defineProperty(e,n.name,{get:function(){return mT(t,n.name,a,o,F,i,c),n.customGetter.call(this)},enumerable:!1})}else Object.defineProperty(e,n.name,{get:function(){return mT(t,n.name,a,o,F,i,c),s?this[o]:r[o]},set:function(e){mT(t,n.name,a,o,F,i,c),s?this[o]=e:r[o]=e},enumerable:!1})}))})),gT=function(e,t,n,i,r){var o=AT.get(i);o&&o.logTimes>o.count&&(n("'%s' has been removed. "+r,e+"."+t),o.count++)},pT=e("removeProperty",(function(e,t,n){null!=e&&n.forEach((function(n){var i=bT++;AT.set(i,{id:i,count:0,logTimes:void 0!==n.logTimes?n.logTimes:CT});var r=n.suggest?"("+n.suggest+")":"";Object.defineProperty(e,n.name,{get:function(){return gT(t,n.name,B,i,r)},set:function(){gT(t,n.name,B,i,r)},enumerable:!1})}))})),vT=function(e,t,n,i,r){var o=AT.get(i);o&&o.logTimes>o.count&&(n("'%s' is deprecated. "+r,e+"."+t),o.count++)},e("markAsWarning",(function(e,t,n){null!=e&&n.forEach((function(n){var i=n.name,r=Object.getOwnPropertyDescriptor(e,i);if(r&&r.configurable){var o=bT++;AT.set(o,{id:o,count:0,logTimes:void 0!==n.logTimes?n.logTimes:CT});var a=n.suggest?"("+n.suggest+")":"";if(void 0!==r.value)if("function"==typeof r.value){var s=r.value;e[i]=function(){return vT(t,i,F,o,a),s.call.apply(s,[this].concat(Array.prototype.slice.call(arguments)))}}else{var c=r.value;Object.defineProperty(e,i,{configurable:!0,get:function(){return vT(t,i,F,o,a),c}}),r.writable&&Object.defineProperty(e,i,{set:function(e){vT(t,i,F,o,a),c=e}})}else!function(t,n,i,r,o,a){if(t.get){var s=t.get;t.get=function(){return vT(n,i,r,o,a),s.call(this)}}if(t.set){var c=t.set;t.set=function(e){vT(n,i,r,o,a),c.call(this,e)}}Object.defineProperty(e,i,t)}(r,t,i,F,o,a);Object.defineProperty(e,i,{enumerable:!1})}}))}));var PT=ol.Flags.Destroyed,RT=ol.Flags.PersistentMask,DT=jt.IDENTIFIER_RE,OT="var ",NT="o",MT={"cc.ClickEvent":!1,"cc.PrefabInfo":!1},LT=jt.escapeForJS,FT=function(){function e(e,t){this.varName=void 0,this.expression=void 0,this.varName=e,this.expression=t}return e.prototype.toString=function(){return OT+this.varName+"="+this.expression+";"},e}();function BT(e,t){return t instanceof FT?new FT(t.varName,e+t.expression):e+t}function zT(e,t,n){Array.isArray(n)?(n[0]=BT(t,n[0]),e.push(n)):e.push(BT(t,n)+";")}var UT=function(){function e(e){this._exps=void 0,this._targetExp=void 0,this._exps=[],this._targetExp=e}var t=e.prototype;return t.append=function(e,t){this._exps.push([e,t])},t.writeCode=function(e){var t;if(this._exps.length>1)e.push("t="+this._targetExp+";"),t="t";else{if(1!==this._exps.length)return;t=this._targetExp}for(var n=0;n<this._exps.length;n++){var i=this._exps[n];zT(e,t+kT(i[0])+"=",i[1])}},e}();function kT(e){return DT.test(e)?"."+e:"["+LT(e)+"]"}UT.pool=void 0,UT.pool=new Xe((function(e){e._exps.length=0,e._targetExp=null}),1),UT.pool.get=function(e){var t=this._get()||new UT;return t._targetExp=e,t};var GT=function(){function e(e,t){var n;this.parent=void 0,this.objsToClear_iN$t=void 0,this.codeArray=void 0,this.objs=void 0,this.funcs=void 0,this.funcModuleCache=void 0,this.globalVariables=void 0,this.globalVariableId=void 0,this.localVariableId=void 0,this.result=void 0,this.parent=t,this.objsToClear_iN$t=[],this.codeArray=[],this.objs=[],this.funcs=[],this.funcModuleCache=xe(),De(this.funcModuleCache,MT),this.globalVariables=[],this.globalVariableId=0,this.localVariableId=0,this.codeArray.push("var o,t;","if(R){","o=R;","}else{","o=R=new "+this.getFuncModule(e.constructor,!0)+"();","}"),e._iN$t={globalVar:"R"},this.objsToClear_iN$t.push(e),this.enumerateObject(this.codeArray,e),this.globalVariables.length>0&&(n=OT+this.globalVariables.join(",")+";");var i=IT(["return (function(R){",n||[],this.codeArray,"return o;","})"]);this.result=Function("O","F",i)(this.objs,this.funcs);for(var r=0,o=this.objsToClear_iN$t.length;r<o;++r)this.objsToClear_iN$t[r]._iN$t=null;this.objsToClear_iN$t.length=0}var t=e.prototype;return t.getFuncModule=function(e,t){var n=Se(e);if(n){var i=this.funcModuleCache[n];if(i)return i;if(void 0===i){var r=-1!==n.indexOf(".");if(r)try{if(r=e===Function("return "+n)())return this.funcModuleCache[n]=n,n}catch(e){}}}var o=this.funcs.indexOf(e);o<0&&(o=this.funcs.length,this.funcs.push(e));var a="F["+o+"]";return t&&(a="("+a+")"),this.funcModuleCache[n]=a,a},t.getObjRef=function(e){var t=this.objs.indexOf(e);return t<0&&(t=this.objs.length,this.objs.push(e)),"O["+t+"]"},t.setValueType=function(e,t,n,i){var r=UT.pool.get(i),o=t.constructor.__props__;o||(o=Object.keys(t));for(var a=0;a<o.length;a++){var s=o[a],c=n[s];if(t[s]!==c){var l=this.enumerateField(n,s,c);r.append(s,l)}}r.writeCode(e),UT.pool.put(r)},t.enumerateCCClass=function(e,t,n){for(var i=n.__values__,r=St(n),o=0;o<i.length;o++){var a=i[o],s=t[a],c=r[a+"$_$default"];if(!HT(c,s))if("object"==typeof s&&s instanceof b.ValueType&&(c=jt.getDefault(c))&&c.constructor===s.constructor){var l=NT+kT(a);this.setValueType(e,c,s,l)}else this.setObjProp(e,t,a,s)}},t.instantiateArray=function(e){if(0===e.length)return"[]";var t="a"+ ++this.localVariableId,n=[new FT(t,"new Array("+e.length+")")];e._iN$t={globalVar:"",source:n},this.objsToClear_iN$t.push(e);for(var i=0;i<e.length;++i)zT(n,t+"["+i+"]=",this.enumerateField(e,i,e[i]));return n},t.instantiateTypedArray=function(e){var t=e.constructor.name;if(0===e.length)return"new "+t;var n="a"+ ++this.localVariableId,i=[new FT(n,"new "+t+"("+e.length+")")];e._iN$t={globalVar:"",source:i},this.objsToClear_iN$t.push(e);for(var r=0;r<e.length;++r)0!==e[r]&&zT(i,n+"["+r+"]=",e[r]);return i},t.enumerateField=function(e,t,n){if("object"==typeof n&&n){var i=n._iN$t;if(i){var r=i.globalVar;if(!r){r=i.globalVar="v"+ ++this.globalVariableId,this.globalVariables.push(r);var o=i.source[0];i.source[0]=BT(r+"=",o)}return r}return ArrayBuffer.isView(n)?this.instantiateTypedArray(n):Array.isArray(n)?this.instantiateArray(n):this.instantiateObj(n)}return"function"==typeof n?this.getFuncModule(n):"string"==typeof n?LT(n):("_objFlags"===t&&e instanceof ol&&(n&=RT),n)},t.setObjProp=function(e,t,n,i){zT(e,NT+kT(n)+"=",this.enumerateField(t,n,i))},t.enumerateObject=function(e,t){var n=t.constructor;if(qt(n))this.enumerateCCClass(e,t,n);else for(var i in t)if(t.hasOwnProperty(i)&&(95!==i.charCodeAt(0)||95!==i.charCodeAt(1)||"__type__"===i)){var r=t[i];"object"==typeof r&&r&&r===t._iN$t||this.setObjProp(e,t,i,r)}},t.instantiateObj=function(e){if(e instanceof b.ValueType)return jt.getNewValueTypeCode(e);if(e instanceof b.Asset)return this.getObjRef(e);if(e._objFlags&PT)return null;var t,n=e.constructor;if(qt(n)){if(this.parent)if(this.parent instanceof b.Component){if(e instanceof b._BaseNode||e instanceof b.Component)return this.getObjRef(e)}else if(this.parent instanceof b._BaseNode)if(e instanceof b._BaseNode){if(!e.isChildOf(this.parent))return this.getObjRef(e)}else if(e instanceof b.Component){var i;if(!(null===(i=e.node)||void 0===i?void 0:i.isChildOf(this.parent)))return this.getObjRef(e)}t=new FT(NT,"new "+this.getFuncModule(n,!0)+"()")}else if(n===Object)t=new FT(NT,"{}");else{if(n)return this.getObjRef(e);t=new FT(NT,"Object.create(null)")}var r=[t];return e._iN$t={globalVar:"",source:r},this.objsToClear_iN$t.push(e),this.enumerateObject(r,e),["(function(){",r,"return o;})();"]},e}();function HT(e,t){if("function"==typeof e)try{e=e()}catch(e){return!1}if(e===t)return!0;if(e&&t&&"object"==typeof e&&"object"==typeof t&&e.constructor===t.constructor)if(e instanceof b.ValueType){if(e.equals(t))return!0}else{if(Array.isArray(e))return 0===e.length&&0===t.length;if(e.constructor===Object)return de(e)&&de(t)}return!1}var VT,WT,jT,qT,XT,YT,KT,QT,JT,ZT,$T=function(){function e(e){this._uiComp=null,this._opacity=1,this._localOpacity=1,this.colorDirty=!0,this._uiTransformComp=null,this._node=void 0,this._node=e}return e.prototype.applyOpacity=function(e){this._opacity=this._localOpacity*e},e.markOpacityTree=function(){},h(e,[{key:"uiTransformComp",get:function(){return this._uiTransformComp||(this._uiTransformComp=this._node.getComponent("cc.UITransform")),this._uiTransformComp},set:function(e){this._uiTransformComp=e}},{key:"uiComp",get:function(){return this._uiComp},set:function(e){this._uiComp&&e?q(12002):this._uiComp=e}},{key:"opacity",get:function(){return this._opacity}},{key:"localOpacity",get:function(){return this._localOpacity},set:function(e){this._localOpacity=e,this.colorDirty=!0}}]),e}();ol.Flags.Destroying,function(e){e.TOUCH_START="touch-start",e.TOUCH_MOVE="touch-move",e.TOUCH_END="touch-end",e.TOUCH_CANCEL="touch-cancel",e.MOUSE_DOWN="mouse-down",e.MOUSE_MOVE="mouse-move",e.MOUSE_UP="mouse-up",e.MOUSE_WHEEL="mouse-wheel",e.MOUSE_ENTER="mouse-enter",e.MOUSE_LEAVE="mouse-leave",e.KEY_DOWN="keydown",e.KEY_UP="keyup",e.DEVICEMOTION="devicemotion",e.TRANSFORM_CHANGED="transform-changed",e.SCENE_CHANGED_FOR_PERSISTS="scene-changed-for-persists",e.SIZE_CHANGED="size-changed",e.ANCHOR_CHANGED="anchor-changed",e.COLOR_CHANGED="color-changed",e.CHILD_ADDED="child-added",e.CHILD_REMOVED="child-removed",e.PARENT_CHANGED="parent-changed",e.NODE_DESTROYED="node-destroyed",e.LAYER_CHANGED="layer-changed",e.SIBLING_ORDER_CHANGED="sibling-order-changed",e.ACTIVE_IN_HIERARCHY_CHANGED="active-in-hierarchy-changed"}(VT||(VT=e("NodeEventType",{})));var eC=ol.Flags.Destroying,tC=ol.Flags.DontDestroy,nC=ol.Flags.Deactivating,iC=new ce("Node");function rC(e){return e?"string"==typeof e?je(e):e:(Y(3804),null)}var oC,aC,sC,cC,lC,uC,hC,_C,fC,dC,pC,mC=e("BaseNode",dc("cc.BaseNode")((ZT=JT=function(e){f(n,e),n._setScene=function(e){e._updateScene()},n._findComponent=function(e,t){var n=t,i=e._components;if(n._sealed)for(var r=0;r<i.length;++r){var o=i[r];if(o.constructor===t)return o}else for(var a=0;a<i.length;++a){var s=i[a];if(s instanceof t)return s}return null},n._findComponents=function(e,t,n){var i=t,r=e._components;if(i._sealed)for(var o=0;o<r.length;++o){var a=r[o];a.constructor===t&&n.push(a)}else for(var s=0;s<r.length;++s){var c=r[s];c instanceof t&&n.push(c)}},n._findChildComponent=function(e,t){for(var i=0;i<e.length;++i){var r=e[i],o=n._findComponent(r,t);if(o)return o;if(r._children.length>0&&(o=n._findChildComponent(r._children,t)))return o}return null},n._findChildComponents=function(e,t,i){for(var r=0;r<e.length;++r){var o=e[r];n._findComponents(o,t,i),o._children.length>0&&n._findChildComponents(o._children,t,i)}};var t=n.prototype;function n(t){var n;return E(n=e.call(this,t)||this,"_parent",qT,y(n)),E(n,"_children",XT,y(n)),E(n,"_active",YT,y(n)),E(n,"_components",KT,y(n)),E(n,"_prefab",QT,y(n)),n._scene=null,n._activeInHierarchy=!1,n._id=iC.getNewId(),n._name=void 0,n._eventProcessor=new b.NodeEventProcessor(y(n)),n._eventMask=0,n._siblingIndex=0,n._originalSceneId="",n._registerIfAttached=void 0,n._name=void 0!==t?t:"New Node",n}return t._updateScene=function(){null==this._parent?B("Node %s(%s) has not attached to a scene.",this.name,this.uuid):this._scene=this._parent._scene},t.attr=function(e){De(this,e)},t.getParent=function(){return this._parent},t.setParent=function(e,t){if(void 0===t&&(t=!1),this._parent!==e){var n=this._parent,i=e;if(this._parent=i,this._siblingIndex=0,this._onSetParent(n,t),this.emit&&this.emit(VT.PARENT_CHANGED,n),n&&!(n._objFlags&eC)){var r=n._children.indexOf(this);n._children.splice(r,1),n._updateSiblingIndex(),n.emit&&n.emit(VT.CHILD_REMOVED,this)}i&&(i._children.push(this),this._siblingIndex=i._children.length-1,i.emit&&i.emit(VT.CHILD_ADDED,this)),this._onHierarchyChanged(n)}},t.getChildByUuid=function(e){if(!e)return L("Invalid uuid"),null;for(var t=this._children,n=0,i=t.length;n<i;n++)if(t[n]._id===e)return t[n];return null},t.getChildByName=function(e){if(!e)return L("Invalid name"),null;for(var t=this._children,n=0,i=t.length;n<i;n++)if(t[n]._name===e)return t[n];return null},t.getChildByPath=function(e){for(var t=e.split("/"),n=this,i=function(e){var i=t[e];if(0===i.length)return"continue";var r=n.children.find((function(e){return e.name===i}));if(!r)return{v:null};n=r},r=0;r<t.length;++r){var o=i(r);if("continue"!==o&&"object"==typeof o)return o.v}return n},t.addChild=function(e){e.setParent(this)},t.insertChild=function(e,t){e.parent=this,e.setSiblingIndex(t)},t.getSiblingIndex=function(){return this._siblingIndex},t.setSiblingIndex=function(e){if(this._parent)if(this._parent._objFlags&nC)Y(3821);else{var t=this._parent._children;e=-1!==e?e:t.length-1;var n=t.indexOf(this);e!==n&&(t.splice(n,1),e<t.length?t.splice(e,0,this):t.push(this),this._parent._updateSiblingIndex(),this._onSiblingIndexChanged&&this._onSiblingIndexChanged(e))}},t.walk=function(e,t){var i=1,r=null,o=null,a=0,s=n._stacks[n._stackId];s||(s=[],n._stacks.push(s)),n._stackId++,s.length=0,s[0]=this;for(var c=null,l=!1;i;)if(o=s[--i])if(!l&&e?e(o):l&&t&&t(o),s[i]=null,l){if(c===this._parent)break;if(l=!1,r)if(r[++a])s[i]=r[a],i++;else if(c&&(s[i]=c,i++,l=!0,c._parent?(a=(r=c._parent._children).indexOf(c),c=c._parent):(c=null,r=null),a<0))break}else o._children.length>0?(c=o,r=o._children,a=0,s[i]=r[a],i++):(s[i]=o,i++,l=!0);s.length=0,n._stackId--},t.removeFromParent=function(){this._parent&&this._parent.removeChild(this)},t.removeChild=function(e){this._children.indexOf(e)>-1&&(e.parent=null)},t.removeAllChildren=function(){for(var e=this._children,t=e.length-1;t>=0;t--){var n=e[t];n&&(n.parent=null)}this._children.length=0},t.isChildOf=function(e){var t=this;do{if(t===e)return!0;t=t._parent}while(t);return!1},t.getComponent=function(e){var t=rC(e);return t?n._findComponent(this,t):null},t.getComponents=function(e){var t=rC(e),i=[];return t&&n._findComponents(this,t,i),i},t.getComponentInChildren=function(e){var t=rC(e);return t?n._findChildComponent(this._children,t):null},t.getComponentsInChildren=function(e){var t=rC(e),i=[];return t&&(n._findComponents(this,t,i),n._findChildComponents(this._children,t,i)),i},t.addComponent=function(e){var t;if("string"==typeof e){if(!(t=je(e)))throw b._RF.peek()&&Y(3808,e),TypeError(Z(3807,e))}else{if(!e)throw TypeError(Z(3804));t=e}if("function"!=typeof t)throw TypeError(Z(3809));if(!Me(t,b.Component))throw TypeError(Z(3810));var n=t._requireComponent;if(n)if(Array.isArray(n))for(var i=0;i<n.length;i++){var r=n[i];this.getComponent(r)||this.addComponent(r)}else{var o=n;this.getComponent(o)||this.addComponent(o)}var a=new t;return a.node=this,this._components.push(a),this._activeInHierarchy&&b.director._nodeActivator.activateComp(a),a},t.removeComponent=function(e){if(e){var t=null;(t=e instanceof ku?e:this.getComponent(e))&&t.destroy()}else Y(3813)},t.on=function(e,t,n,i){switch(void 0===i&&(i=!1),e){case VT.TRANSFORM_CHANGED:this._eventMask|=1}this._eventProcessor.on(e,t,n,i)},t.off=function(e,t,n,i){if(void 0===i&&(i=!1),this._eventProcessor.off(e,t,n,i),!this._eventProcessor.hasEventListener(e))switch(e){case VT.TRANSFORM_CHANGED:this._eventMask&=-2}},t.once=function(e,t,n,i){this._eventProcessor.once(e,t,n,i)},t.emit=function(e,t,n,i,r,o){this._eventProcessor.emit(e,t,n,i,r,o)},t.dispatchEvent=function(e){this._eventProcessor.dispatchEvent(e)},t.hasEventListener=function(e,t,n){return this._eventProcessor.hasEventListener(e,t,n)},t.targetOff=function(e){this._eventProcessor.targetOff(e),1&this._eventMask&&!this._eventProcessor.hasEventListener(VT.TRANSFORM_CHANGED)&&(this._eventMask&=-2)},t.destroy=function(){return!!e.prototype.destroy.call(this)&&(this.active=!1,!0)},t.destroyAllChildren=function(){for(var e=this._children,t=0;t<e.length;++t)e[t].destroy()},t._removeComponent=function(e){if(e){if(!(this._objFlags&eC)){var t=this._components.indexOf(e);-1!==t?this._components.splice(t,1):e.node!==this&&Y(3815)}}else Y(3814)},t._updateSiblingIndex=function(){for(var e=0;e<this._children.length;++e)this._children[e]._siblingIndex=e;this.emit(VT.SIBLING_ORDER_CHANGED)},t._onSetParent=function(e){this._parent&&(null!=e&&e._scene===this._parent._scene||null==this._parent._scene||this.walk(n._setScene))},t._onPostActivated=function(){},t._onBatchCreated=function(){this._parent&&(this._siblingIndex=this._parent.children.indexOf(this))},t._onPreDestroy=function(){this._onPreDestroyBase()},t._onHierarchyChanged=function(e){return this._onHierarchyChangedBase(e)},t._instantiate=function(e,t){return e||(e=b.instantiate._clone(this,this)),e._prefab,e._parent=null,e._onBatchCreated(t),e},t._onHierarchyChangedBase=function(){var e=this._parent;!this._persistNode||e instanceof b.Scene||b.game.removePersistRootNode(this);var t=this._active&&!(!e||!e._activeInHierarchy);this._activeInHierarchy!==t&&b.director._nodeActivator.activateNode(this,t)},t._onPreDestroyBase=function(){this._objFlags|=eC;var e=this._parent,t=!!e&&0!=(e._objFlags&eC);if(this._persistNode&&b.game.removePersistRootNode(this),!t&&e){this.emit(VT.PARENT_CHANGED,this);var n=e._children.indexOf(this);e._children.splice(n,1),this._siblingIndex=0,e._updateSiblingIndex(),e.emit&&e.emit(VT.CHILD_REMOVED,this)}this.emit(VT.NODE_DESTROYED,this),this._eventProcessor.destroy();for(var i=this._children,r=0;r<i.length;++r)i[r]._destroyImmediate();for(var o=this._components,a=0;a<o.length;++a)o[a]._destroyImmediate();return t},h(n,[{key:"components",get:function(){return this._components}},{key:"_persistNode",get:function(){return(this._objFlags&tC)>0},set:function(e){e?this._objFlags|=tC:this._objFlags&=~tC}},{key:"name",get:function(){return this._name},set:function(e){this._name=e}},{key:"uuid",get:function(){return this._id}},{key:"children",get:function(){return this._children}},{key:"active",get:function(){return this._active},set:function(e){if(e=!!e,this._active!==e){this._active=e;var t=this._parent;t&&t._activeInHierarchy&&b.director._nodeActivator.activateNode(this,e)}}},{key:"activeInHierarchy",get:function(){return this._activeInHierarchy}},{key:"parent",get:function(){return this._parent},set:function(e){this.setParent(e)}},{key:"scene",get:function(){return this._scene}},{key:"eventProcessor",get:function(){return this._eventProcessor}}]),n}(ol),JT.idGenerator=iC,JT._stacks=[[]],JT._stackId=0,T((jT=ZT).prototype,"_persistNode",[gc],Object.getOwnPropertyDescriptor(jT.prototype,"_persistNode"),jT.prototype),T(jT.prototype,"name",[Nc],Object.getOwnPropertyDescriptor(jT.prototype,"name"),jT.prototype),T(jT.prototype,"children",[Nc],Object.getOwnPropertyDescriptor(jT.prototype,"children"),jT.prototype),T(jT.prototype,"active",[Nc],Object.getOwnPropertyDescriptor(jT.prototype,"active"),jT.prototype),T(jT.prototype,"activeInHierarchy",[Nc],Object.getOwnPropertyDescriptor(jT.prototype,"activeInHierarchy"),jT.prototype),T(jT.prototype,"parent",[Nc],Object.getOwnPropertyDescriptor(jT.prototype,"parent"),jT.prototype),qT=T(jT.prototype,"_parent",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),XT=T(jT.prototype,"_children",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),YT=T(jT.prototype,"_active",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),KT=T(jT.prototype,"_components",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),QT=T(jT.prototype,"_prefab",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),WT=jT))||WT);b._BaseNode=mC;var vC=new yn,gC=new On,yC=new On,xC=new On,SC=new Pn,EC=new Pn,TC=new kn,CC=[],bC=[],AC=[],wC=function(){function e(){this._chunks=[],this._freelists=[],this._createChunk()}var t=e.prototype;return t.alloc=function(){for(var e=this._freelists.length,t=0;t<e;++t)if(this._freelists[t].length)return this._createView(t);return this._createChunk(),this._createView(e)},t.free=function(e,t){for(var n=this._freelists.length,i=0;i<n;++i)if(this._chunks[i]===e)return void this._freelists[i].push(t)},t.clear=function(){for(var e=this._chunks.length,t=0;t<e;++t)this._chunks[t].fill(0)},t._createChunk=function(){this._chunks.push(new Uint32Array(e.CAPACITY_PER_CHUNK));for(var t=[],n=e.CAPACITY_PER_CHUNK-1;n>=0;n--)t.push(n);this._freelists.push(t)},t._createView=function(e){return AC[0]=this._chunks[e],AC[1]=this._freelists[e].pop(),AC},e}();wC.CAPACITY_PER_CHUNK=256;var IC,PC,RC,DC,OC,NC,MC,LC,FC,BC,zC,UC,kC,GC,HC,VC,WC,jC,qC,XC,YC,KC,QC,JC,ZC,$C,eb,tb,nb,ib,rb,ob,ab,sb,cb,lb,ub,hb,_b,fb,db,pb,mb,vb,gb,yb,xb,Sb,Eb,Tb,Cb,bb,Ab,wb,Ib,Pb,Rb,Db,Ob,Nb,Mb,Lb,Fb,Bb,zb,Ub,kb,Gb,Hb,Vb=new wC,Wb=Symbol("ReserveContentsForAllSyncablePrefab"),jb=e("Node",(oC=dc("cc.Node"),aC=Jc(yn),oC((pC=dC=function(e){f(n,e);var t=n.prototype;function n(t){var n;return(n=e.call(this,t)||this)._uiProps=new $T(y(n)),n._static=!1,E(n,"_lpos",lC,y(n)),E(n,"_lrot",uC,y(n)),E(n,"_lscale",hC,y(n)),E(n,"_layer",_C,y(n)),E(n,"_euler",fC,y(n)),n._dirtyFlagsPri=Zg.NONE,n._eulerDirty=!1,n._nodeHandle=0,n._init(),n}return t._init=function(){var e=Vb.alloc(),t=e[0],n=e[1];this._hasChangedFlagsChunk=t,this._hasChangedFlagsOffset=n;var i=new Uint32Array(t.buffer,t.byteOffset+4*n,1);this._hasChangedFlags=i,this._pos=new yn,this._rot=new On,this._scale=new yn(1,1,1),this._mat=new kn},n.isNode=function(e){return e instanceof n&&(e.constructor===n||!(e instanceof b.Scene))},t._onPreDestroy=function(){var e=this._onPreDestroyBase();return Vb.free(this._hasChangedFlagsChunk,this._hasChangedFlagsOffset),e},t[Ju]=function(e){e.writeThis()},t.setParent=function(t,n){void 0===n&&(n=!1),n&&this.updateWorldTransform(),e.prototype.setParent.call(this,t,n)},t._onSetParent=function(t,n){if(e.prototype._onSetParent.call(this,t,n),n){var i=this._parent;i?(i.updateWorldTransform(),$t(kn.determinant(i._mat),0,Jt)?(q(14200),this._dirtyFlags|=Zg.TRS,this.updateWorldTransform()):(kn.multiply(TC,kn.invert(TC,i._mat),this._mat),kn.toRTS(TC,this._lrot,this._lpos,this._lscale))):(yn.copy(this._lpos,this._pos),On.copy(this._lrot,this._rot),yn.copy(this._lscale,this._scale)),this._eulerDirty=!0}this.invalidateChildren(Zg.TRS)},t._onHierarchyChanged=function(t){this.eventProcessor.reattach(),e.prototype._onHierarchyChangedBase.call(this,t)},t._onBatchCreated=function(e){this.hasChangedFlags=Zg.TRS,this._dirtyFlags|=Zg.TRS;for(var t=this._children.length,n=0;n<t;++n)this._children[n]._siblingIndex=n,this._children[n]._onBatchCreated(e)},t._onBeforeSerialize=function(){this.eulerAngles},t._onPostActivated=function(e){e?(this._eventProcessor.setEnabled(!0),this.invalidateChildren(Zg.TRS),this._uiProps&&this._uiProps.uiComp&&(this._uiProps.uiComp.setNodeDirty(),this._uiProps.uiComp.setTextureDirty(),this._uiProps.uiComp.markForUpdateRenderData())):this._eventProcessor.setEnabled(!1)},t.translate=function(e,t){var n=t||Jg.LOCAL;if(n===Jg.LOCAL)yn.transformQuat(vC,e,this._lrot),this._lpos.x+=vC.x,this._lpos.y+=vC.y,this._lpos.z+=vC.z;else if(n===Jg.WORLD)if(this._parent){On.invert(gC,this._parent.worldRotation),yn.transformQuat(vC,e,gC);var i=this.worldScale;this._lpos.x+=vC.x/i.x,this._lpos.y+=vC.y/i.y,this._lpos.z+=vC.z/i.z}else this._lpos.x+=e.x,this._lpos.y+=e.y,this._lpos.z+=e.z;this.invalidateChildren(Zg.POSITION),1&this._eventMask&&this.emit(VT.TRANSFORM_CHANGED,Zg.POSITION)},t.rotate=function(e,t){var n=t||Jg.LOCAL;if(On.normalize(gC,e),n===Jg.LOCAL)On.multiply(this._lrot,this._lrot,gC);else if(n===Jg.WORLD){var i=this.worldRotation;On.multiply(yC,gC,i),On.invert(gC,i),On.multiply(yC,gC,yC),On.multiply(this._lrot,this._lrot,yC)}this._eulerDirty=!0,this.invalidateChildren(Zg.ROTATION),1&this._eventMask&&this.emit(VT.TRANSFORM_CHANGED,Zg.ROTATION)},t.lookAt=function(e,t){this.getWorldPosition(vC),yn.subtract(vC,vC,e),yn.normalize(vC,vC),On.fromViewUp(gC,vC,t),this.setWorldRotation(gC)},t._setDirtyNode=function(e,t){CC[e]=t},t.invalidateChildren=function(e){var t,n,i,r=0,o=0,a=0,s=0,c=0,l=e|Zg.POSITION;for(CC[0]=this;r>=0;){if(c=(t=CC[r--])._hasChangedFlags[0],s=t._dirtyFlagsPri,t.isValid&&(s&c&e)!==e)for(s|=e,t._dirtyFlagsPri=s,t._hasChangedFlags[0]=c|e,a=(i=t._children).length,o=0;o<a;o++)n=i[o],CC[++r]=n;e=l}},t.updateWorldTransform=function(){if(this._dirtyFlags){for(var e,t=this,n=0;t&&t._dirtyFlags;)this._setDirtyNode(n++,t),t=t._parent;for(var i=0;n;)i|=(e=CC[--n])._dirtyFlags,t?(i&Zg.POSITION&&(yn.transformMat4(e._pos,e._lpos,t._mat),e._mat.m12=e._pos.x,e._mat.m13=e._pos.y,e._mat.m14=e._pos.z),i&Zg.RS&&(kn.fromRTS(e._mat,e._lrot,e._lpos,e._lscale),kn.multiply(e._mat,t._mat,e._mat),i&Zg.ROTATION&&On.multiply(e._rot,t._rot,e._lrot),Pn.fromQuat(SC,On.conjugate(xC,e._rot)),Pn.multiplyMat4(SC,SC,e._mat),e._scale.x=SC.m00,e._scale.y=SC.m04,e._scale.z=SC.m08)):(i&Zg.POSITION&&(yn.copy(e._pos,e._lpos),e._mat.m12=e._pos.x,e._mat.m13=e._pos.y,e._mat.m14=e._pos.z),i&Zg.RS&&(i&Zg.ROTATION&&On.copy(e._rot,e._lrot),i&Zg.SCALE&&(yn.copy(e._scale,e._lscale),kn.fromRTS(e._mat,e._rot,e._pos,e._scale)))),e._dirtyFlags=Zg.NONE,t=e}},t.setPosition=function(e,t,n){void 0===t&&void 0===n?yn.copy(this._lpos,e):void 0===n?yn.set(this._lpos,e,t,this._lpos.z):yn.set(this._lpos,e,t,n),this.invalidateChildren(Zg.POSITION),1&this._eventMask&&this.emit(VT.TRANSFORM_CHANGED,Zg.POSITION)},t.getPosition=function(e){return e?yn.set(e,this._lpos.x,this._lpos.y,this._lpos.z):yn.copy(new yn,this._lpos)},t.setRotation=function(e,t,n,i){void 0===t||void 0===n||void 0===i?On.copy(this._lrot,e):On.set(this._lrot,e,t,n,i),this._eulerDirty=!0,this.invalidateChildren(Zg.ROTATION),1&this._eventMask&&this.emit(VT.TRANSFORM_CHANGED,Zg.ROTATION)},t.setRotationFromEuler=function(e,t,n){var i=void 0===n?this._euler.z:n;void 0===t?(yn.copy(this._euler,e),On.fromEuler(this._lrot,e.x,e.y,e.z)):(yn.set(this._euler,e,t,i),On.fromEuler(this._lrot,e,t,i)),this._eulerDirty=!1,this.invalidateChildren(Zg.ROTATION),1&this._eventMask&&this.emit(VT.TRANSFORM_CHANGED,Zg.ROTATION)},t.getRotation=function(e){return e?On.set(e,this._lrot.x,this._lrot.y,this._lrot.z,this._lrot.w):On.copy(new On,this._lrot)},t.setScale=function(e,t,n){void 0===t&&void 0===n?yn.copy(this._lscale,e):void 0===n?yn.set(this._lscale,e,t,this._lscale.z):yn.set(this._lscale,e,t,n),this.invalidateChildren(Zg.SCALE),1&this._eventMask&&this.emit(VT.TRANSFORM_CHANGED,Zg.SCALE)},t.getScale=function(e){return e?yn.set(e,this._lscale.x,this._lscale.y,this._lscale.z):yn.copy(new yn,this._lscale)},t.inverseTransformPoint=function(e,t){yn.copy(e,t);for(var n=this,i=0;n._parent;)this._setDirtyNode(i++,n),n=n._parent;for(;i>=0;)yn.transformInverseRTS(e,e,n._lrot,n._lpos,n._lscale),n=CC[--i];return e},t.setWorldPosition=function(e,t,n){void 0===t||void 0===n?yn.copy(this._pos,e):yn.set(this._pos,e,t,n);var i=this._parent,r=this._lpos;i?(i.updateWorldTransform(),yn.transformMat4(r,this._pos,kn.invert(TC,i._mat))):yn.copy(r,this._pos),this.invalidateChildren(Zg.POSITION),1&this._eventMask&&this.emit(VT.TRANSFORM_CHANGED,Zg.POSITION)},t.getWorldPosition=function(e){return this.updateWorldTransform(),e?yn.copy(e,this._pos):yn.copy(new yn,this._pos)},t.setWorldRotation=function(e,t,n,i){void 0===t||void 0===n||void 0===i?On.copy(this._rot,e):On.set(this._rot,e,t,n,i),this._parent?(this._parent.updateWorldTransform(),On.multiply(this._lrot,On.conjugate(this._lrot,this._parent._rot),this._rot)):On.copy(this._lrot,this._rot),this._eulerDirty=!0,this.invalidateChildren(Zg.ROTATION),1&this._eventMask&&this.emit(VT.TRANSFORM_CHANGED,Zg.ROTATION)},t.setWorldRotationFromEuler=function(e,t,n){On.fromEuler(this._rot,e,t,n),this._parent?(this._parent.updateWorldTransform(),On.multiply(this._lrot,On.conjugate(this._lrot,this._parent._rot),this._rot)):On.copy(this._lrot,this._rot),this._eulerDirty=!0,this.invalidateChildren(Zg.ROTATION),1&this._eventMask&&this.emit(VT.TRANSFORM_CHANGED,Zg.ROTATION)},t.getWorldRotation=function(e){return this.updateWorldTransform(),e?On.copy(e,this._rot):On.copy(new On,this._rot)},t.setWorldScale=function(e,t,n){void 0===t||void 0===n?yn.copy(this._scale,e):yn.set(this._scale,e,t,n);var i=this._parent;i?(i.updateWorldTransform(),Pn.fromQuat(SC,On.conjugate(xC,i._rot)),Pn.multiplyMat4(SC,SC,i._mat),EC.m00=this._scale.x,EC.m04=this._scale.y,EC.m08=this._scale.z,Pn.multiply(SC,EC,Pn.invert(SC,SC)),this._lscale.x=yn.set(vC,SC.m00,SC.m01,SC.m02).length(),this._lscale.y=yn.set(vC,SC.m03,SC.m04,SC.m05).length(),this._lscale.z=yn.set(vC,SC.m06,SC.m07,SC.m08).length()):yn.copy(this._lscale,this._scale),this.invalidateChildren(Zg.SCALE),1&this._eventMask&&this.emit(VT.TRANSFORM_CHANGED,Zg.SCALE)},t.getWorldScale=function(e){return this.updateWorldTransform(),e?yn.copy(e,this._scale):yn.copy(new yn,this._scale)},t.getWorldMatrix=function(e){this.updateWorldTransform();var t=e||new kn;return kn.copy(t,this._mat)},t.getWorldRS=function(e){this.updateWorldTransform();var t=e||new kn;return kn.copy(t,this._mat),t.m12=0,t.m13=0,t.m14=0,t},t.getWorldRT=function(e){this.updateWorldTransform();var t=e||new kn;return kn.fromRT(t,this._rot,this._pos)},t.setRTS=function(e,t,n){var i=0;e&&(i|=Zg.ROTATION,void 0!==e.w?(On.copy(this._lrot,e),this._eulerDirty=!0):(yn.copy(this._euler,e),On.fromEuler(this._lrot,e.x,e.y,e.z),this._eulerDirty=!1)),t&&(yn.copy(this._lpos,t),i|=Zg.POSITION),n&&(yn.copy(this._lscale,n),i|=Zg.SCALE),i&&(this.invalidateChildren(i),1&this._eventMask&&this.emit(VT.TRANSFORM_CHANGED,i))},t.pauseSystemEvents=function(e){this._eventProcessor.setEnabled(!1,e)},t.resumeSystemEvents=function(e){this._eventProcessor.setEnabled(!0,e)},n.resetHasChangedFlags=function(){Vb.clear()},n.clearNodeArray=function(){n.ClearFrame<n.ClearRound?n.ClearFrame++:(n.ClearFrame=0,CC.length=0,bC.length=0)},t.getPathInHierarchy=function(){for(var e=this.name,t=this.parent;t&&t instanceof n;)e=t.name+"/"+e,t=t.parent;return e},h(n,[{key:"_dirtyFlags",get:function(){return this._dirtyFlagsPri},set:function(e){this._dirtyFlagsPri=e}},{key:"native",get:function(){return this._nativeObj}},{key:"position",get:function(){return this._lpos},set:function(e){this.setPosition(e)}},{key:"worldPosition",get:function(){return this.updateWorldTransform(),this._pos},set:function(e){this.setWorldPosition(e)}},{key:"rotation",get:function(){return this._lrot},set:function(e){this.setRotation(e)}},{key:"eulerAngles",get:function(){return this._eulerDirty&&(On.toEuler(this._euler,this._lrot),this._eulerDirty=!1),this._euler},set:function(e){this.setRotationFromEuler(e.x,e.y,e.z)}},{key:"angle",get:function(){return this._euler.z},set:function(e){yn.set(this._euler,0,0,e),On.fromAngleZ(this._lrot,e),this._eulerDirty=!1,this.invalidateChildren(Zg.ROTATION),1&this._eventMask&&this.emit(VT.TRANSFORM_CHANGED,Zg.ROTATION)}},{key:"worldRotation",get:function(){return this.updateWorldTransform(),this._rot},set:function(e){this.setWorldRotation(e)}},{key:"scale",get:function(){return this._lscale},set:function(e){this.setScale(e)}},{key:"worldScale",get:function(){return this.updateWorldTransform(),this._scale},set:function(e){this.setWorldScale(e)}},{key:"matrix",set:function(e){kn.toRTS(e,this._lrot,this._lpos,this._lscale),this.invalidateChildren(Zg.TRS),this._eulerDirty=!0,1&this._eventMask&&this.emit(VT.TRANSFORM_CHANGED,Zg.TRS)}},{key:"worldMatrix",get:function(){return this.updateWorldTransform(),this._mat}},{key:"forward",get:function(){return yn.transformQuat(new yn,yn.FORWARD,this.worldRotation)},set:function(e){var t=e.length();yn.multiplyScalar(vC,e,-1/t),On.fromViewUp(gC,vC),this.setWorldRotation(gC)}},{key:"up",get:function(){return yn.transformQuat(new yn,yn.UP,this.worldRotation)}},{key:"right",get:function(){return yn.transformQuat(new yn,yn.RIGHT,this.worldRotation)}},{key:"layer",get:function(){return this._layer},set:function(e){this._layer=e,this._uiProps&&this._uiProps.uiComp&&(this._uiProps.uiComp.setNodeDirty(),this._uiProps.uiComp.markForUpdateRenderData()),this.emit(VT.LAYER_CHANGED,this._layer)}},{key:"hasChangedFlags",get:function(){return this._hasChangedFlagsChunk[this._hasChangedFlagsOffset]},set:function(e){this._hasChangedFlagsChunk[this._hasChangedFlagsOffset]=e}}]),n}(mC),dC.EventType=VT,dC.NodeSpace=Jg,dC.TransformDirtyBit=Zg,dC.TransformBit=Zg,dC.reserveContentsForAllSyncablePrefabTag=Wb,dC.ClearFrame=0,dC.ClearRound=1e3,lC=T((cC=pC).prototype,"_lpos",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new yn}}),uC=T(cC.prototype,"_lrot",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new On}}),hC=T(cC.prototype,"_lscale",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new yn(1,1,1)}}),_C=T(cC.prototype,"_layer",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return rd.Enum.DEFAULT}}),fC=T(cC.prototype,"_euler",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new yn}}),T(cC.prototype,"eulerAngles",[aC],Object.getOwnPropertyDescriptor(cC.prototype,"eulerAngles"),cC.prototype),T(cC.prototype,"angle",[Nc],Object.getOwnPropertyDescriptor(cC.prototype,"angle"),cC.prototype),T(cC.prototype,"layer",[Nc],Object.getOwnPropertyDescriptor(cC.prototype,"layer"),cC.prototype),sC=cC))||sC));b.Node=jb;var qb=dc("cc.TargetInfo")((RC=T((PC=function(){E(this,"localID",RC,this)}).prototype,"localID",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),IC=PC))||IC,Xb=(DC=dc("cc.TargetOverrideInfo"),OC=Jc(ol),NC=Jc(qb),MC=Jc(jb),LC=Jc(qb),DC((zC=T((BC=function(){E(this,"source",zC,this),E(this,"sourceInfo",UC,this),E(this,"propertyPath",kC,this),E(this,"target",GC,this),E(this,"targetInfo",HC,this)}).prototype,"source",[Ec,OC],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),UC=T(BC.prototype,"sourceInfo",[Ec,NC],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),kC=T(BC.prototype,"propertyPath",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),GC=T(BC.prototype,"target",[Ec,MC],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),HC=T(BC.prototype,"targetInfo",[Ec,LC],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),FC=BC))||FC),Yb=dc("cc.CompPrefabInfo")((jC=T((WC=function(){E(this,"fileId",jC,this)}).prototype,"fileId",[Ec,Nc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),VC=WC))||VC,Kb=(qC=dc("CCPropertyOverrideInfo"),XC=Jc(qb),qC(($C=function(){function e(){E(this,"targetInfo",QC,this),E(this,"propertyPath",JC,this),E(this,"value",ZC,this)}return e.prototype.isTarget=function(){},e}(),QC=T((KC=$C).prototype,"targetInfo",[Ec,XC],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),JC=T(KC.prototype,"propertyPath",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),ZC=T(KC.prototype,"value",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),YC=KC))||YC),Qb=(eb=dc("cc.MountedChildrenInfo"),tb=Jc(qb),nb=Jc([jb]),eb((sb=function(){function e(){E(this,"targetInfo",ob,this),E(this,"nodes",ab,this)}return e.prototype.isTarget=function(){},e}(),ob=T((rb=sb).prototype,"targetInfo",[Ec,tb],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),ab=T(rb.prototype,"nodes",[Ec,nb],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),ib=rb))||ib),Jb=(cb=dc("cc.MountedComponentsInfo"),lb=Jc(qb),ub=Jc([ku]),cb((pb=function(){function e(){E(this,"targetInfo",fb,this),E(this,"components",db,this)}return e.prototype.isTarget=function(){},e}(),fb=T((_b=pb).prototype,"targetInfo",[Ec,lb],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),db=T(_b.prototype,"components",[Ec,ub],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),hb=_b))||hb),Zb=(mb=dc("cc.PrefabInstance"),vb=Jc(jb),gb=Jc([Qb]),yb=Jc([Jb]),xb=Jc([Kb]),Sb=Jc([qb]),mb((Rb=function(){function e(){E(this,"fileId",Cb,this),E(this,"prefabRootNode",bb,this),E(this,"mountedChildren",Ab,this),E(this,"mountedComponents",wb,this),E(this,"propertyOverrides",Ib,this),E(this,"removedComponents",Pb,this),this.targetMap={}}var t=e.prototype;return t.findPropertyOverride=function(){},t.removePropertyOverride=function(){},e}(),Cb=T((Tb=Rb).prototype,"fileId",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),bb=T(Tb.prototype,"prefabRootNode",[Ec,vb],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Ab=T(Tb.prototype,"mountedChildren",[Ec,gb],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),wb=T(Tb.prototype,"mountedComponents",[Ec,yb],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Ib=T(Tb.prototype,"propertyOverrides",[Ec,xb],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Pb=T(Tb.prototype,"removedComponents",[Ec,Sb],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Eb=Tb))||Eb),$b=(Db=dc("cc.PrefabInfo"),Ob=Jc(jb),Nb=Jc(Zb),Mb=Jc([Xb]),Db((Bb=T((Fb=function(){E(this,"root",Bb,this),E(this,"asset",zb,this),E(this,"fileId",Ub,this),E(this,"instance",kb,this),E(this,"targetOverrides",Gb,this),E(this,"nestedPrefabInstanceRoots",Hb,this)}).prototype,"root",[Ec,Ob],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),zb=T(Fb.prototype,"asset",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Ub=T(Fb.prototype,"fileId",[Ec,Nc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),kb=T(Fb.prototype,"instance",[Ec,Nb],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Gb=T(Fb.prototype,"targetOverrides",[Ec,Mb],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Hb=T(Fb.prototype,"nestedPrefabInstanceRoots",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Lb=Fb))||Lb);function eA(e){var t=e._prefab;if(t&&t.instance){if(!t.asset)return Y(3701,e.name),void(t.instance=void 0);var n=e._objFlags,i=e._parent,r=e._id,o=e._prefab;e[el],b.game._isCloning=!0,t.asset._doInstantiate(e),b.game._isCloning=!1,e._objFlags=n,e._parent=i,e._id=r,e._prefab&&(e._prefab.instance=null==o?void 0:o.instance)}}function tA(e,t,n){var i;if(t&&e){var r=t,o=null===(i=e._prefab)||void 0===i?void 0:i.instance;!n&&o&&(t[o.fileId]={},r=t[o.fileId]);var a=e._prefab;a&&(r[a.fileId]=e);for(var s=e.components,c=0;c<s.length;c++){var l=s[c];l.__prefab&&(r[l.__prefab.fileId]=l)}for(var u=0;u<e.children.length;u++)tA(e.children[u],r,!1)}}function nA(e,t){if(!e)return null;for(var n=t,i=0;i<e.length;i++){if(!n)return null;n=n[e[i]]}return n}function iA(e,t,n){if(t)for(var i=0;i<t.length;i++){var r=t[i];if(r&&r.targetInfo){var o=nA(r.targetInfo.localID,n);if(!o)continue;var a=n,s=r.targetInfo.localID;if(s.length>0)for(var c=0;c<s.length-1;c++)a=a[s[c]];if(r.nodes)for(var l=0;l<r.nodes.length;l++){var u=r.nodes[l];u&&!o._children.includes(u)&&(o._children.push(u),u._parent=o,tA(u,a,!1),u._siblingIndex=o._children.length-1,cA(u,!0))}}}}function rA(e,t,n){if(t)for(var i=0;i<t.length;i++){var r=t[i];if(r&&r.targetInfo){var o=nA(r.targetInfo.localID,n);if(!o)continue;if(r.components)for(var a=0;a<r.components.length;a++){var s=r.components[a];s&&(s.node=o,o._components.push(s))}}}}function oA(e,t,n){if(t)for(var i=0;i<t.length;i++){var r=t[i];if(r){var o=nA(r.localID,n);if(!o||!o.node)continue;var a=o.node.components.indexOf(o);a>=0&&o.node._components.splice(a,1)}}}function aA(e,t,n){if(!(t.length<=0))for(var i=null,r=0;r<t.length;r++){var o=t[r];if(o&&o.targetInfo){if(!(i=nA(o.targetInfo.localID,n)))continue;var a=i,s=o.propertyPath.slice();if(s.length>0){var c=s.pop();if(!c)continue;for(var l=0;l<s.length&&(a=a[s[l]]);l++);if(!a)continue;if(Array.isArray(a))if("length"===c)a[c]=o.value;else{var u=Number.parseInt(c);Number.isInteger(u)&&u<a.length&&(a[c]=o.value)}else a[c]instanceof tt?a[c].set(o.value):a[c]=o.value}}}}function sA(e){var t,n=null===(t=e._prefab)||void 0===t?void 0:t.targetOverrides;if(n)for(var i=0;i<n.length;i++){var r,o,a=n[i],s=a.source,c=a.sourceInfo;if(c){var l,u,h=null===(l=a.source)||void 0===l||null===(u=l._prefab)||void 0===u?void 0:u.instance;h&&h.targetMap&&(s=nA(c.localID,h.targetMap))}if(s){var _,f=a.targetInfo;if(f){var d=null===(r=a.target)||void 0===r||null===(o=r._prefab)||void 0===o?void 0:o.instance;if(d&&d.targetMap&&(_=nA(f.localID,d.targetMap))){var p=a.propertyPath.slice(),m=s;if(p.length>0){var v=p.pop();if(!v)return;for(var g=0;g<p.length&&(m=m[p[g]]);g++);if(!m)continue;m[v]=_}}}}}}function cA(e,t){void 0===t&&(t=!1);var n=e._prefab,i=null==n?void 0:n.instance;if(i){eA(e);var r={};i.targetMap=r,tA(e,r,!0),iA(0,i.mountedChildren,r),oA(0,i.removedComponents,r),rA(0,i.mountedComponents,r),aA(0,i.propertyOverrides,r)}t&&e&&e.children&&e.children.forEach((function(e){cA(e,!0)}))}function lA(e){var t=e._prefab;t&&t.nestedPrefabInstanceRoots&&t.nestedPrefabInstanceRoots.forEach((function(e){cA(e)}))}b._PrefabInfo=$b;var uA,hA,_A,fA,dA,pA,mA,vA,gA,yA,xA,SA,EA,TA,CA=Object.freeze({__proto__:null,TargetInfo:qb,TargetOverrideInfo:Xb,CompPrefabInfo:Yb,PropertyOverrideInfo:Kb,MountedChildrenInfo:Qb,MountedComponentsInfo:Jb,PrefabInstance:Zb,PrefabInfo:$b,createNodeWithPrefab:eA,generateTargetMap:tA,getTarget:nA,applyMountedChildren:iA,applyMountedComponents:rA,applyRemovedComponents:oA,applyPropertyOverrides:aA,applyTargetOverrides:sA,expandPrefabInstanceNode:cA,expandNestedPrefabInstanceNode:lA}),bA=Je({AUTO:0,SINGLE_INSTANCE:1,MULTI_INSTANCE:2}),AA=e("Prefab",dc("cc.Prefab")((mA=pA=function(e){function t(){var t;return E(t=e.call(this)||this,"data",_A,y(t)),E(t,"optimizationPolicy",fA,y(t)),E(t,"persistent",dA,y(t)),t._createFunction=void 0,t._instantiatedTimes=void 0,t._createFunction=null,t._instantiatedTimes=0,t}f(t,e);var n=t.prototype;return n.createNode=function(e){var t=b.instantiate(this);t.name=this.name,e(null,t)},n.compileCreateFunction=function(){var e,t;this._createFunction=(t=(e=this.data)instanceof b._BaseNode&&e,new GT(e,t).result)},n._doInstantiate=function(e){return this.data._prefab||q(3700),this._createFunction||this.compileCreateFunction(),this._createFunction(e)},n._instantiate=function(){var e;return this.optimizationPolicy!==bA.SINGLE_INSTANCE&&(this.optimizationPolicy===bA.MULTI_INSTANCE||this._instantiatedTimes+1>=t.OptimizationPolicyThreshold)?(e=this._doInstantiate(),this.data._instantiate(e)):e=this.data._instantiate(),++this._instantiatedTimes,e},n.initDefault=function(t){e.prototype.initDefault.call(this,t),this.data=new jb,this.data.name="(Missing Node)";var n=new b._PrefabInfo;n.asset=this,n.root=this.data,this.data._prefab=n},n.validate=function(){return!!this.data},n.onLoaded=function(){var e=this.data;lA(e),sA(e)},t}(yu),pA.OptimizationPolicy=bA,pA.OptimizationPolicyThreshold=3,_A=T((hA=mA).prototype,"data",[Ec,Nc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),fA=T(hA.prototype,"optimizationPolicy",[Ec,Nc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return bA.AUTO}}),dA=T(hA.prototype,"persistent",[Ec,Nc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),uA=hA))||uA);Ke.value(AA,"_utils",CA),b.Prefab=AA,Ee(b,"cc._Prefab","Prefab"),e("PrefabLink",(vA=dc("cc.PrefabLink"),gA=Jc(AA),yA=Mc(),vA((TA=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return E(t=e.call.apply(e,[this].concat(i))||this,"prefab",EA,y(t)),t}return f(t,e),t}(ku),EA=T((SA=TA).prototype,"prefab",[gA,Ec,yA],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),xA=SA))||xA));var wA=new yn;function IA(e,t,n,i){i||(i=new yn),e.convertToUINode(t,n,i);var r=n.position;return i.add(r),i}function PA(e,t,n){return n||(n=new yn),e.worldToScreen(t,n),n.x/=b.view.getScaleX(),n.y/=b.view.getScaleY(),n}var RA,DA,OA=e("convertUtils",{WorldNode3DToLocalNodeUI:IA,WorldNode3DToWorldNodeUI:PA});b.pipelineUtils=OA,dT(b.pipelineUtils,"cc.pipelineUtils",[{name:"WorldNode3DToLocalNodeUI",newName:"convertToUINode",targetName:"cc.Camera.prototype",customFunction:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];var i=t[0],r=t[3]||wA;return i.convertToUINode(t[1],t[2],r),r.add(t[2].position),t[3]||r.clone()}}]),pT(Em.prototype,"TextureBase.prototype",[{name:"hasPremultipliedAlpha"},{name:"setPremultiplyAlpha"},{name:"setFlipY"}]),dT(_E.prototype,"RenderTexture.prototype",[{name:"getGFXWindow",customFunction:function(){return this._window}}]);var NA,MA=e("BufferAsset",dc("cc.BufferAsset")((T((DA=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._buffer=null,t}f(t,e);var n=t.prototype;return n.buffer=function(){return this._buffer},n.validate=function(){return!!this.buffer},h(t,[{key:"_nativeAsset",get:function(){return this._buffer},set:function(e){e instanceof ArrayBuffer?this._buffer=e:this._buffer=e.buffer}}]),t}(yu)).prototype,"_nativeAsset",[$c],Object.getOwnPropertyDescriptor(DA.prototype,"_nativeAsset"),DA.prototype),RA=DA))||RA);b.BufferAsset=MA;var LA=((NA={})[si.UNORM]="Uint",NA[si.SNORM]="Int",NA[si.UINT]="Uint",NA[si.INT]="Int",NA[si.UFLOAT]="Float",NA[si.FLOAT]="Float",NA.default="Uint",NA);function FA(e){return""+(LA[e.type]||LA.default)+e.size/e.count*8}function BA(e,t,n,i,r){void 0===n&&(n=ai.R32F),void 0===i&&(i=0),void 0===r&&(r=0);var o=Kr[n];r||(r=o.size);for(var a="set"+FA(o),s=o.size/o.count,c=Math.floor(t.length/o.count),l=Qu.isLittleEndian,u=0;u<c;++u)for(var h=i+r*u,_=0;_<o.count;++_){var f=h+s*_;e[a](f,t[o.count*u+_],l)}}function zA(e,t,n,i,r,o){void 0===t&&(t=ai.R32F),void 0===n&&(n=0),void 0===i&&(i=e.byteLength-n),void 0===r&&(r=0),void 0===o&&(o=[]);var a=Kr[t];r||(r=a.size);for(var s="get"+FA(a),c=a.size/a.count,l=Math.floor(i/r),u=Qu.isLittleEndian,h=0;h<l;++h)for(var _=n+r*h,f=0;f<a.count;++f){var d=_+c*f;o[a.count*h+f]=e[s](d,u)}return o}function UA(e,t,n,i,r,o,a){void 0===n&&(n=ai.R32F),void 0===i&&(i=0),void 0===r&&(r=e.byteLength-i),void 0===o&&(o=0),a||(a=new DataView(e.buffer.slice(e.byteOffset,e.byteOffset+e.byteLength)));var s=Kr[n];o||(o=s.size);for(var c="set"+FA(s),l="get"+FA(s),u=s.size/s.count,h=Math.floor(r/o),_=Qu.isLittleEndian,f=0;f<h;++f)for(var d=i+o*f,p=0;p<s.count;++p){var m=d+u*p,v=e[l](m,_);a[c](m,t(v,p,e),_)}return a}var kA,GA,HA=e("RenderingSubMesh",function(){var e=t.prototype;function t(e,t,n,i,r,o){void 0===i&&(i=null),void 0===r&&(r=null),void 0===o&&(o=!0),this.mesh=void 0,this.subMeshIdx=void 0,this._flatBuffers=[],this._jointMappedBuffers=void 0,this._jointMappedBufferIndices=void 0,this._vertexIdChannel=void 0,this._geometricInfo=void 0,this._vertexBuffers=void 0,this._attributes=void 0,this._indexBuffer=null,this._indirectBuffer=null,this._primitiveMode=void 0,this._iaInfo=void 0,this._isOwnerOfIndexBuffer=!0,this._attributes=t,this._vertexBuffers=e,this._indexBuffer=i,this._indirectBuffer=r,this._primitiveMode=n,this._iaInfo=new wr(t,e,i,r),this._isOwnerOfIndexBuffer=o,this._init()}return e._init=function(){},e.genFlatBuffers=function(){if(!this._flatBuffers.length&&this.mesh&&void 0!==this.subMeshIdx){var e=this.mesh,t=0,n=e.struct.primitives[this.subMeshIdx];n.indexView&&(t=n.indexView.count);for(var i=0;i<n.vertexBundelIndices.length;i++){var r=n.vertexBundelIndices[i],o=e.struct.vertexBundles[r],a=n.indexView?n.indexView.count:o.view.count,s=o.view.stride,c=s*a,l=new Uint8Array(e.data.buffer,o.view.offset,o.view.length),u=new Uint8Array(n.indexView?c:o.view.length);if(n.indexView){for(var h=e.readIndices(this.subMeshIdx),_=0;_<t;++_)for(var f=_*s,d=h[_]*s,p=0;p<s;++p)u[f+p]=l[d+p];this._flatBuffers.push({stride:s,count:a,buffer:u})}else u.set(e.data.subarray(o.view.offset,o.view.offset+o.view.length)),this._flatBuffers.push({stride:s,count:a,buffer:u})}}},e.destroy=function(){for(var e=0;e<this.vertexBuffers.length;e++)this.vertexBuffers[e].destroy();if(this.vertexBuffers.length=0,this._indexBuffer&&(this._isOwnerOfIndexBuffer&&this._indexBuffer.destroy(),this._indexBuffer=null),this._jointMappedBuffers&&this._jointMappedBufferIndices){for(var t=0;t<this._jointMappedBufferIndices.length;t++)this._jointMappedBuffers[this._jointMappedBufferIndices[t]].destroy();this._jointMappedBuffers=void 0,this._jointMappedBufferIndices=void 0}this._indirectBuffer&&(this._indirectBuffer.destroy(),this._indirectBuffer=null)},e.enableVertexIdChannel=function(e){if(!this._vertexIdChannel){var t=this.vertexBuffers.length,n=this.attributes.length,i=this._allocVertexIdBuffer(e);this._vertexBuffers.push(i),this._attributes.push(new br("a_vertexId",ai.R32F,!1,t)),this._iaInfo.attributes=this._attributes,this._iaInfo.vertexBuffers=this._vertexBuffers,this._vertexIdChannel={stream:t,index:n}}},e._allocVertexIdBuffer=function(e){for(var t=0===this.vertexBuffers.length||0===this.vertexBuffers[0].stride?0:this.vertexBuffers[0].size/this.vertexBuffers[0].stride,n=new Float32Array(t),i=0;i<t;++i)n[i]=i+.5;var r=e.createBuffer(new cr(li.VERTEX|li.TRANSFER_DST,_i.DEVICE,n.byteLength,n.BYTES_PER_ELEMENT));return r.update(n),r},h(t,[{key:"attributes",get:function(){return this._attributes}},{key:"vertexBuffers",get:function(){return this._vertexBuffers}},{key:"indexBuffer",get:function(){return this._indexBuffer}},{key:"indirectBuffer",get:function(){return this._indirectBuffer}},{key:"primitiveMode",get:function(){return this._primitiveMode}},{key:"geometricInfo",get:function(){if(this._geometricInfo)return this._geometricInfo;if(void 0===this.mesh)return{positions:new Float32Array,indices:new Uint8Array,boundingBox:{min:yn.ZERO,max:yn.ZERO}};if(void 0===this.subMeshIdx)return{positions:new Float32Array,indices:new Uint8Array,boundingBox:{min:yn.ZERO,max:yn.ZERO}};var e=this.mesh,t=this.subMeshIdx,n=e.readAttribute(t,qi.ATTR_POSITION),i=e.readIndices(t),r=new yn,o=new yn,a=this.attributes.find((function(e){return e.name===qi.ATTR_POSITION}));if(a){var s=Kr[a.format].count;2===s?(r.set(n[0],n[1],0),o.set(n[0],n[1],0)):(r.set(n[0],n[1],n[2]),o.set(n[0],n[1],n[2]));for(var c=0;c<n.length;c+=s)2===s?(r.x=n[c]>r.x?n[c]:r.x,r.y=n[c+1]>r.y?n[c+1]:r.y,o.x=n[c]<o.x?n[c]:o.x,o.y=n[c+1]<o.y?n[c+1]:o.y):(r.x=n[c]>r.x?n[c]:r.x,r.y=n[c+1]>r.y?n[c+1]:r.y,r.z=n[c+2]>r.z?n[c+2]:r.z,o.x=n[c]<o.x?n[c]:o.x,o.y=n[c+1]<o.y?n[c+1]:o.y,o.z=n[c+2]<o.z?n[c+2]:o.z)}return this._geometricInfo={positions:n,indices:i,boundingBox:{max:r,min:o}},this._geometricInfo}},{key:"flatBuffers",get:function(){return this._flatBuffers}},{key:"jointMappedBuffers",get:function(){var e=this;if(this._jointMappedBuffers)return this._jointMappedBuffers;var t=this._jointMappedBuffers=[],n=this._jointMappedBufferIndices=[];if(!this.mesh||void 0===this.subMeshIdx)return this._jointMappedBuffers=this.vertexBuffers;var i,r,o=this.mesh.struct,a=o.primitives[this.subMeshIdx];if(!o.jointMaps||void 0===a.jointMapIndex||!o.jointMaps[a.jointMapIndex])return this._jointMappedBuffers=this.vertexBuffers;for(var s=b.director.root.device,c=0;c<a.vertexBundelIndices.length;c++){var l=o.vertexBundles[a.vertexBundelIndices[c]];r=0,i=ai.UNKNOWN;for(var u=0;u<l.attributes.length;u++){var h=l.attributes[u];if(h.name===qi.ATTR_JOINTS){i=h.format;break}r+=Kr[h.format].size}i?function(){var u=new Uint8Array(e.mesh.data.buffer,l.view.offset,l.view.length),h=new DataView(u.slice().buffer),_=o.jointMaps[a.jointMapIndex];UA(h,(function(e){return _.indexOf(e)}),i,r,l.view.length,l.view.stride,h);var f=s.createBuffer(new cr(li.VERTEX|li.TRANSFER_DST,_i.DEVICE,l.view.length,l.view.stride));f.update(h.buffer),t.push(f),n.push(c)}():t.push(this.vertexBuffers[a.vertexBundelIndices[c]])}return this._vertexIdChannel&&t.push(this._allocVertexIdBuffer(s)),t}},{key:"iaInfo",get:function(){return this._iaInfo}}]),t}());!function(e){e.TOUCH_START="touch-start",e.TOUCH_MOVE="touch-move",e.TOUCH_END="touch-end",e.TOUCH_CANCEL="touch-cancel",e.MOUSE_DOWN="mouse-down",e.MOUSE_MOVE="mouse-move",e.MOUSE_UP="mouse-up",e.MOUSE_WHEEL="mouse-wheel",e.MOUSE_ENTER="mouse-enter",e.MOUSE_LEAVE="mouse-leave",e.KEY_DOWN="keydown",e.KEY_UP="keyup",e.DEVICEMOTION="devicemotion",e.TRANSFORM_CHANGED="transform-changed",e.SCENE_CHANGED_FOR_PERSISTS="scene-changed-for-persists",e.SIZE_CHANGED="size-changed",e.ANCHOR_CHANGED="anchor-changed",e.COLOR_CHANGED="color-changed",e.CHILD_ADDED="child-added",e.CHILD_REMOVED="child-removed",e.PARENT_CHANGED="parent-changed",e.NODE_DESTROYED="node-destroyed",e.LAYER_CHANGED="layer-changed",e.SIBLING_ORDER_CHANGED="sibling-order-changed"}(kA||(kA=e("SystemEventType",{}))),function(e){e.TOUCH_START="touch-start",e.TOUCH_MOVE="touch-move",e.TOUCH_END="touch-end",e.TOUCH_CANCEL="touch-cancel",e.MOUSE_DOWN="mouse-down",e.MOUSE_MOVE="mouse-move",e.MOUSE_UP="mouse-up",e.MOUSE_WHEEL="mouse-wheel",e.KEY_DOWN="keydown",e.KEY_PRESSING="key-pressing",e.KEY_UP="keyup",e.DEVICEMOTION="devicemotion"}(GA||(GA={})),b.SystemEventType=kA;var VA,WA=new Array(16),jA=null,qA=new Tn,XA=[VT.TOUCH_START,VT.TOUCH_MOVE,VT.TOUCH_END,VT.TOUCH_CANCEL],YA=[VT.MOUSE_DOWN,VT.MOUSE_ENTER,VT.MOUSE_MOVE,VT.MOUSE_LEAVE,VT.MOUSE_UP,VT.MOUSE_WHEEL];!function(e){e[e.ADD_POINTER_EVENT_PROCESSOR=0]="ADD_POINTER_EVENT_PROCESSOR",e[e.REMOVE_POINTER_EVENT_PROCESSOR=1]="REMOVE_POINTER_EVENT_PROCESSOR",e[e.MARK_LIST_DIRTY=2]="MARK_LIST_DIRTY"}(VA||(VA={}));var KA,QA,JA,ZA,$A,ew,tw,nw,iw,rw,ow,aw,sw,cw,lw,uw,hw,_w,fw,dw,pw,mw,vw,gw,yw,xw,Sw,Ew,Tw,Cw,bw,Aw,ww,Iw,Pw,Rw,Dw,Ow,Nw,Mw,Lw,Fw,Bw,zw,Uw,kw,Gw,Hw,Vw,Ww,jw,qw,Xw,Yw,Kw,Qw,Jw,Zw,$w,eI,tI,nI,iI,rI,oI,aI,sI,cI,lI,uI,hI,_I,fI,dI,pI,mI,vI,gI,yI,xI,SI,EI,TI,CI,bI,AI,wI,II,PI,RI,DI,OI,NI,MI,LI,FI,BI,zI,UI,kI,GI,HI,VI,WI,jI,qI,XI,YI,KI,QI,JI,ZI,$I,eP,tP,nP,iP,rP,oP,aP,sP,cP,lP,uP,hP,_P,fP,dP,pP,mP,vP,gP,yP,xP,SP,EP,TP,CP,bP,AP,wP=function(){function e(e){this.claimedTouchIdList=[],this.maskList=null,this.cachedCameraPriority=0,this.previousMouseIn=!1,this.bubblingTarget=null,this.capturingTarget=null,this.shouldHandleEventMouse=!1,this.shouldHandleEventTouch=!1,this._isEnabled=!1,this._node=void 0,this._node=e}var t=e.prototype;return t.setEnabled=function(t,n){if(void 0===n&&(n=!1),this._isEnabled!==t){this._isEnabled=t;var i=this.node.children;if(t&&this._attachMask(),e.callbacksInvoker.emit(VA.MARK_LIST_DIRTY),n&&i.length>0)for(var r=0;r<i.length;++r)i[r]._eventProcessor.setEnabled(t,!0)}},t.reattach=function(){var t,n=this;this.node.walk((function(i){t||(t=n._searchComponentsInParent(e._maskComp)),i.eventProcessor.maskList=t}))},t.destroy=function(){jA===this._node&&(jA=null),this.capturingTarget&&this.capturingTarget.clear(),this.bubblingTarget&&this.bubblingTarget.clear(),e.callbacksInvoker.emit(VA.REMOVE_POINTER_EVENT_PROCESSOR,this)},t.on=function(e,t,n,i){var r,o;return this._tryEmittingAddEvent(e),((i=!!i)?null!==(r=this.capturingTarget)&&void 0!==r?r:this.capturingTarget=this._newCallbacksInvoker():null!==(o=this.bubblingTarget)&&void 0!==o?o:this.bubblingTarget=this._newCallbacksInvoker()).on(e,t,n),t},t.once=function(e,t,n,i){var r,o;return this._tryEmittingAddEvent(e),((i=!!i)?null!==(r=this.capturingTarget)&&void 0!==r?r:this.capturingTarget=this._newCallbacksInvoker():null!==(o=this.bubblingTarget)&&void 0!==o?o:this.bubblingTarget=this._newCallbacksInvoker()).on(e,t,n,!0),t},t.off=function(e,t,n,i){var r;null===(r=(i=!!i)?this.capturingTarget:this.bubblingTarget)||void 0===r||r.off(e,t,n)},t.targetOff=function(t){var n,i;null===(n=this.capturingTarget)||void 0===n||n.removeAll(t),null===(i=this.bubblingTarget)||void 0===i||i.removeAll(t),this.shouldHandleEventTouch&&!this._hasTouchListeners()&&(this.shouldHandleEventTouch=!1),this.shouldHandleEventMouse&&!this._hasMouseListeners()&&(this.shouldHandleEventMouse=!1),this._hasPointerListeners()||e.callbacksInvoker.emit(VA.REMOVE_POINTER_EVENT_PROCESSOR,this)},t.emit=function(e,t,n,i,r,o){var a;null===(a=this.bubblingTarget)||void 0===a||a.emit(e,t,n,i,r,o)},t.dispatchEvent=function(e){var t,n=this.node,i=0;for(e.target=n,WA.length=0,this.getCapturingTargets(e.type,WA),e.eventPhase=1,i=WA.length-1;i>=0;--i)if((t=WA[i]).eventProcessor.capturingTarget&&(e.currentTarget=t,t.eventProcessor.capturingTarget.emit(e.type,e,WA),e.propagationStopped))return void(WA.length=0);if(WA.length=0,e.eventPhase=2,e.currentTarget=n,this.capturingTarget&&this.capturingTarget.emit(e.type,e),!e.propagationImmediateStopped&&this.bubblingTarget&&this.bubblingTarget.emit(e.type,e),!e.propagationStopped&&e.bubbles)for(this.getBubblingTargets(e.type,WA),e.eventPhase=3,i=0;i<WA.length;++i)if((t=WA[i]).eventProcessor.bubblingTarget&&(e.currentTarget=t,t.eventProcessor.bubblingTarget.emit(e.type,e),e.propagationStopped))return void(WA.length=0);WA.length=0},t.hasEventListener=function(e,t,n){var i=!1;return this.bubblingTarget&&(i=this.bubblingTarget.hasEventListener(e,t,n)),!i&&this.capturingTarget&&(i=this.capturingTarget.hasEventListener(e,t,n)),i},t.getCapturingTargets=function(e,t){for(var n=this._node.parent;n;){var i;(null===(i=n.eventProcessor.capturingTarget)||void 0===i?void 0:i.hasEventListener(e))&&t.push(n),n=n.parent}},t.getBubblingTargets=function(e,t){for(var n=this._node.parent;n;){var i;(null===(i=n.eventProcessor.bubblingTarget)||void 0===i?void 0:i.hasEventListener(e))&&t.push(n),n=n.parent}},t._searchComponentsInParent=function(e){var t=this.node;if(e){for(var n=0,i=[],r=t;r&&jb.isNode(r);r=r.parent,++n){var o=r.getComponent(e);if(o){var a={index:n,comp:o};i?i.push(a):i=[a]}}return i.length>0?i:null}return null},t._attachMask=function(){this.maskList=this._searchComponentsInParent(e._maskComp)},t._isTouchEvent=function(e){return-1!==XA.indexOf(e)},t._isMouseEvent=function(e){return-1!==YA.indexOf(e)},t._hasTouchListeners=function(){for(var e=0;e<XA.length;++e){var t=XA[e];if(this.hasEventListener(t))return!0}return!1},t._hasMouseListeners=function(){for(var e=0;e<YA.length;++e){var t=YA[e];if(this.hasEventListener(t))return!0}return!1},t._hasPointerListeners=function(){return!!this._hasTouchListeners()||this._hasMouseListeners()},t._tryEmittingAddEvent=function(t){var n=this._isTouchEvent(t),i=this._isMouseEvent(t);n?this.shouldHandleEventTouch=!0:i&&(this.shouldHandleEventMouse=!0),!n&&!i||this._hasPointerListeners()||e.callbacksInvoker.emit(VA.ADD_POINTER_EVENT_PROCESSOR,this)},t._newCallbacksInvoker=function(){var t=this,n=new Vl;return n._registerOffCallback((function(){t.shouldHandleEventTouch&&!t._hasTouchListeners()&&(t.shouldHandleEventTouch=!1),t.shouldHandleEventMouse&&!t._hasMouseListeners()&&(t.shouldHandleEventMouse=!1),t._hasPointerListeners()||e.callbacksInvoker.emit(VA.REMOVE_POINTER_EVENT_PROCESSOR,t)})),n},t._handleEventMouse=function(e){switch(e.type){case GA.MOUSE_DOWN:return this._handleMouseDown(e);case GA.MOUSE_MOVE:return this._handleMouseMove(e);case GA.MOUSE_UP:return this._handleMouseUp(e);case GA.MOUSE_WHEEL:return this._handleMouseWheel(e);default:return!1}},t._handleMouseDown=function(e){var t=this._node;return!(!t||!t._uiProps.uiTransformComp||(e.getLocation(qA),!t._uiProps.uiTransformComp.hitTest(qA)||(e.type=VT.MOUSE_DOWN,e.bubbles=!0,t.dispatchEvent(e),e.propagationStopped=!0,0)))},t._handleMouseMove=function(e){var t=this._node;return!(!t||!t._uiProps.uiTransformComp||(e.getLocation(qA),t._uiProps.uiTransformComp.hitTest(qA)?(this.previousMouseIn||(jA&&jA!==t&&(e.type=VT.MOUSE_LEAVE,jA.dispatchEvent(e),jA.eventProcessor.previousMouseIn=!1),jA=t,e.type=VT.MOUSE_ENTER,t.dispatchEvent(e),this.previousMouseIn=!0),e.type=VT.MOUSE_MOVE,e.bubbles=!0,t.dispatchEvent(e),e.propagationStopped=!0,0):(this.previousMouseIn&&(e.type=VT.MOUSE_LEAVE,t.dispatchEvent(e),this.previousMouseIn=!1,jA=null),1)))},t._handleMouseUp=function(e){var t=this._node;return!(!t||!t._uiProps.uiTransformComp||(e.getLocation(qA),!t._uiProps.uiTransformComp.hitTest(qA)||(e.type=VT.MOUSE_UP,e.bubbles=!0,t.dispatchEvent(e),e.propagationStopped=!0,0)))},t._handleMouseWheel=function(e){var t=this._node;return!(!t||!t._uiProps.uiTransformComp||(e.getLocation(qA),!t._uiProps.uiTransformComp.hitTest(qA)||(e.type=VT.MOUSE_WHEEL,e.bubbles=!0,t.dispatchEvent(e),e.propagationStopped=!0,0)))},t._handleEventTouch=function(e){switch(e.type){case GA.TOUCH_START:return this._handleTouchStart(e);case GA.TOUCH_MOVE:return this._handleTouchMove(e);case GA.TOUCH_END:return this._handleTouchEnd(e);case GA.TOUCH_CANCEL:return this._handleTouchCancel(e);default:return!1}},t._handleTouchStart=function(e){var t=this.node;return!(!t||!t._uiProps.uiTransformComp||(e.getLocation(qA),!t._uiProps.uiTransformComp.hitTest(qA)||(e.type=VT.TOUCH_START,e.bubbles=!0,t.dispatchEvent(e),0)))},t._handleTouchMove=function(e){var t=this.node;return!(!t||!t._uiProps.uiTransformComp||(e.type=VT.TOUCH_MOVE,e.bubbles=!0,t.dispatchEvent(e),0))},t._handleTouchEnd=function(e){var t=this.node;t&&t._uiProps.uiTransformComp&&(e.getLocation(qA),t._uiProps.uiTransformComp.hitTest(qA)?e.type=VT.TOUCH_END:e.type=VT.TOUCH_CANCEL,e.bubbles=!0,t.dispatchEvent(e))},t._handleTouchCancel=function(e){var t=this.node;t&&t._uiProps.uiTransformComp&&(e.type=VT.TOUCH_CANCEL,e.bubbles=!0,t.dispatchEvent(e))},h(e,[{key:"isEnabled",get:function(){return this._isEnabled}},{key:"node",get:function(){return this._node}}]),e}();wP._maskComp=null,wP.callbacksInvoker=new Vl,b.NodeEventProcessor=wP;var IP=new yn(0,1,0),PP=new yn,RP=new wn,DP=new Qn,OP=new On,NP=function(e){var t=1/Math.max(Math.max(Math.max(e.x,e.y),e.z),1e-4);t<1&&(e.x*=t,e.y*=t,e.z*=t)},MP=e("AmbientInfo",(KA=dc("cc.AmbientInfo"),QA=Mc(),JA=Bc(),ZA=Jc(bt),$A=Bc(),ew=Mc(),tw=Bc(),nw=Tc("_skyColor"),iw=Tc("_skyIllum"),rw=Tc("_groundAlbedo"),KA((T((aw=function(){function e(){E(this,"_skyColorHDR",sw,this),E(this,"_skyIllumHDR",cw,this),E(this,"_groundAlbedoHDR",lw,this),E(this,"_skyColorLDR",uw,this),E(this,"_skyIllumLDR",hw,this),E(this,"_groundAlbedoLDR",_w,this),this._resource=null}return e.prototype.activate=function(e){this._resource=e,this._resource.initialize(this)},h(e,[{key:"skyColorHDR",get:function(){return this._skyColorHDR}},{key:"groundAlbedoHDR",get:function(){return this._groundAlbedoHDR}},{key:"skyIllumHDR",get:function(){return this._skyIllumHDR}},{key:"skyColorLDR",get:function(){return this._skyColorLDR}},{key:"groundAlbedoLDR",get:function(){return this._groundAlbedoLDR}},{key:"skyIllumLDR",get:function(){return this._skyIllumLDR}},{key:"skyLightingColor",get:function(){var e=b.director.root.pipeline.pipelineSceneData.isHDR;return RP.set(e?this._skyColorHDR:this._skyColorLDR),NP(RP),DP.set(255*RP.x,255*RP.y,255*RP.z,255)},set:function(e){RP.set(e.x,e.y,e.z,e.w),b.director.root.pipeline.pipelineSceneData.isHDR?this._skyColorHDR.set(RP):this._skyColorLDR.set(RP),this._resource&&this._resource.skyColor.set(RP)}},{key:"skyColor",set:function(e){b.director.root.pipeline.pipelineSceneData.isHDR?this._skyColorHDR.set(e):this._skyColorLDR.set(e),this._resource&&this._resource.skyColor.set(e)}},{key:"skyIllum",get:function(){return b.director.root.pipeline.pipelineSceneData.isHDR?this._skyIllumHDR:this._skyIllumLDR},set:function(e){b.director.root.pipeline.pipelineSceneData.isHDR?this._skyIllumHDR=e:this._skyIllumLDR=e,this._resource&&(this._resource.skyIllum=e)}},{key:"groundLightingColor",get:function(){var e=b.director.root.pipeline.pipelineSceneData.isHDR;return RP.set(e?this._groundAlbedoHDR:this._groundAlbedoLDR),NP(RP),DP.set(255*RP.x,255*RP.y,255*RP.z,255)},set:function(e){RP.set(e.x,e.y,e.z,e.w),b.director.root.pipeline.pipelineSceneData.isHDR?this._groundAlbedoHDR.set(RP):this._groundAlbedoLDR.set(RP),this._resource&&this._resource.groundAlbedo.set(RP)}},{key:"groundAlbedo",set:function(e){b.director.root.pipeline.pipelineSceneData.isHDR?this._groundAlbedoHDR.set(e):this._groundAlbedoLDR.set(e),this._resource&&this._resource.groundAlbedo.set(e)}}]),e}()).prototype,"skyLightingColor",[QA,Nc,JA],Object.getOwnPropertyDescriptor(aw.prototype,"skyLightingColor"),aw.prototype),T(aw.prototype,"skyIllum",[Nc,ZA,$A],Object.getOwnPropertyDescriptor(aw.prototype,"skyIllum"),aw.prototype),T(aw.prototype,"groundLightingColor",[ew,Nc,tw],Object.getOwnPropertyDescriptor(aw.prototype,"groundLightingColor"),aw.prototype),sw=T(aw.prototype,"_skyColorHDR",[Ec,nw],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new wn(.2,.5,.8,1)}}),cw=T(aw.prototype,"_skyIllumHDR",[Ec,iw],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return kg.SKY_ILLUM}}),lw=T(aw.prototype,"_groundAlbedoHDR",[Ec,rw],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new wn(.2,.2,.2,1)}}),uw=T(aw.prototype,"_skyColorLDR",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new wn(.2,.5,.8,1)}}),hw=T(aw.prototype,"_skyIllumLDR",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return kg.SKY_ILLUM}}),_w=T(aw.prototype,"_groundAlbedoLDR",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new wn(.2,.2,.2,1)}}),ow=aw))||ow));b.AmbientInfo=MP;var LP=e("SkyboxInfo",(fw=dc("cc.SkyboxInfo"),dw=Bc(),pw=Jc(jg),mw=Bc(),vw=Bc(),gw=Jc(Ym),yw=Bc(),xw=Mc(),Sw=Jc(Ym),Ew=Vc(),Tw=Jc(Ym),Cw=Tc("_envmap"),bw=Jc(Ym),Aw=Jc(Ym),ww=Jc(Ym),fw((T((Pw=function(){function e(){E(this,"_envLightingType",Rw,this),E(this,"_envmapHDR",Dw,this),E(this,"_envmapLDR",Ow,this),E(this,"_diffuseMapHDR",Nw,this),E(this,"_diffuseMapLDR",Mw,this),E(this,"_enabled",Lw,this),E(this,"_useHDR",Fw,this),this._resource=null}return e.prototype.activate=function(e){this.envLightingType=this._envLightingType,this._resource=e,this._resource.initialize(this),this._resource.setEnvMaps(this._envmapHDR,this._envmapLDR),this._resource.setDiffuseMaps(this._diffuseMapHDR,this._diffuseMapLDR),this._resource.activate()},h(e,[{key:"applyDiffuseMap",get:function(){return jg.DIFFUSEMAP_WITH_REFLECTION===this._envLightingType},set:function(e){this._resource&&(this._resource.useDiffuseMap=e)}},{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled!==e&&(this._enabled=e,this._resource&&(this._resource.enabled=this._enabled))}},{key:"envLightingType",get:function(){return this._envLightingType},set:function(e){this.envmap||jg.HEMISPHERE_DIFFUSE===e?(jg.HEMISPHERE_DIFFUSE===e?(this.useIBL=!1,this.applyDiffuseMap=!1):jg.AUTOGEN_HEMISPHERE_DIFFUSE_WITH_REFLECTION===e?(this.useIBL=!0,this.applyDiffuseMap=!1):jg.DIFFUSEMAP_WITH_REFLECTION===e&&(this.useIBL=!0,this.applyDiffuseMap=!0),this._envLightingType=e):(this.useIBL=!1,this.applyDiffuseMap=!1,this._envLightingType=jg.HEMISPHERE_DIFFUSE,q(15001))}},{key:"useIBL",get:function(){return jg.HEMISPHERE_DIFFUSE!==this._envLightingType},set:function(e){this._resource&&(this._resource.useIBL=e)}},{key:"useHDR",get:function(){return b.director.root.pipeline.pipelineSceneData.isHDR=this._useHDR,this._useHDR},set:function(e){b.director.root.pipeline.pipelineSceneData.isHDR=e,this._useHDR=e,this._resource&&(this.envmap=this._resource.envmap,this.diffuseMap=this._resource.diffuseMap,this.envLightingType===jg.DIFFUSEMAP_WITH_REFLECTION&&(null===this.diffuseMap?(this.envLightingType=jg.AUTOGEN_HEMISPHERE_DIFFUSE_WITH_REFLECTION,q(15e3)):this.diffuseMap.isDefault&&q(15002))),this._resource&&(this._resource.useHDR=this._useHDR)}},{key:"envmap",get:function(){return b.director.root.pipeline.pipelineSceneData.isHDR?this._envmapHDR:this._envmapLDR},set:function(e){var t=b.director.root.pipeline.pipelineSceneData.isHDR;t?this._envmapHDR=e:this._envmapLDR=e,e||(t?this._diffuseMapHDR=null:this._diffuseMapLDR=null,this.applyDiffuseMap=!1,this.useIBL=!1,this.envLightingType=jg.HEMISPHERE_DIFFUSE,q(15001)),this._resource&&(this._resource.setEnvMaps(this._envmapHDR,this._envmapLDR),this._resource.setDiffuseMaps(this._diffuseMapHDR,this._diffuseMapLDR),this._resource.useDiffuseMap=this.applyDiffuseMap,this._resource.envmap=e)}},{key:"diffuseMap",get:function(){return b.director.root.pipeline.pipelineSceneData.isHDR?this._diffuseMapHDR:this._diffuseMapLDR},set:function(e){b.director.root.pipeline.pipelineSceneData.isHDR?this._diffuseMapHDR=e:this._diffuseMapLDR=e,this._resource&&this._resource.setDiffuseMaps(this._diffuseMapHDR,this._diffuseMapLDR)}}]),e}()).prototype,"enabled",[Nc,dw],Object.getOwnPropertyDescriptor(Pw.prototype,"enabled"),Pw.prototype),T(Pw.prototype,"envLightingType",[Nc,pw,mw],Object.getOwnPropertyDescriptor(Pw.prototype,"envLightingType"),Pw.prototype),T(Pw.prototype,"useHDR",[Nc,vw],Object.getOwnPropertyDescriptor(Pw.prototype,"useHDR"),Pw.prototype),T(Pw.prototype,"envmap",[Nc,gw,yw],Object.getOwnPropertyDescriptor(Pw.prototype,"envmap"),Pw.prototype),T(Pw.prototype,"diffuseMap",[xw,Nc,Lc,Sw,Ew],Object.getOwnPropertyDescriptor(Pw.prototype,"diffuseMap"),Pw.prototype),Rw=T(Pw.prototype,"_envLightingType",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return jg.HEMISPHERE_DIFFUSE}}),Dw=T(Pw.prototype,"_envmapHDR",[Ec,Tw,Cw],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Ow=T(Pw.prototype,"_envmapLDR",[Ec,bw],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Nw=T(Pw.prototype,"_diffuseMapHDR",[Ec,Aw],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Mw=T(Pw.prototype,"_diffuseMapLDR",[Ec,ww],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Lw=T(Pw.prototype,"_enabled",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Fw=T(Pw.prototype,"_useHDR",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Iw=Pw))||Iw));b.SkyboxInfo=LP;var FP=e("FogInfo",(Bw=dc("cc.FogInfo"),zw=Bc(),Uw=Vc(),kw=Bc(),Gw=Vc(),Hw=Bc(),Vw=Jc(Yg),Ww=Vc(),jw=Bc(),qw=Mc(),Xw=Jc(bt),Yw=zc(),Kw=Gc(),Qw=Bc(),Jw=Mc(),Zw=Jc(bt),$w=Gc(),eI=Bc(),tI=Mc(),nI=Jc(bt),iI=Gc(),rI=Bc(),oI=Mc(),aI=Jc(bt),sI=Uc(),cI=Gc(),lI=Bc(),uI=Mc(),hI=Jc(bt),_I=Gc(),fI=Bc(),dI=Mc(),pI=Jc(bt),mI=Gc(),vI=Bc(),Bw((DI=RI=function(){function e(){E(this,"_type",xI,this),E(this,"_fogColor",SI,this),E(this,"_enabled",EI,this),E(this,"_fogDensity",TI,this),E(this,"_fogStart",CI,this),E(this,"_fogEnd",bI,this),E(this,"_fogAtten",AI,this),E(this,"_fogTop",wI,this),E(this,"_fogRange",II,this),E(this,"_accurate",PI,this),this._resource=null}return e.prototype.activate=function(e){this._resource=e,this._resource.initialize(this),this._resource.activate()},h(e,[{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled!==e&&(this._enabled=e,this._resource&&(this._resource.enabled=e,e&&(this._resource.type=this._type)))}},{key:"accurate",get:function(){return this._accurate},set:function(e){this._accurate!==e&&(this._accurate=e,this._resource&&(this._resource.accurate=e,e&&(this._resource.type=this._type)))}},{key:"fogColor",get:function(){return this._fogColor},set:function(e){this._fogColor.set(e),this._resource&&(this._resource.fogColor=this._fogColor)}},{key:"type",get:function(){return this._type},set:function(e){this._type=e,this._resource&&(this._resource.type=e)}},{key:"fogDensity",get:function(){return this._fogDensity},set:function(e){this._fogDensity=e,this._resource&&(this._resource.fogDensity=e)}},{key:"fogStart",get:function(){return this._fogStart},set:function(e){this._fogStart=e,this._resource&&(this._resource.fogStart=e)}},{key:"fogEnd",get:function(){return this._fogEnd},set:function(e){this._fogEnd=e,this._resource&&(this._resource.fogEnd=e)}},{key:"fogAtten",get:function(){return this._fogAtten},set:function(e){this._fogAtten=e,this._resource&&(this._resource.fogAtten=e)}},{key:"fogTop",get:function(){return this._fogTop},set:function(e){this._fogTop=e,this._resource&&(this._resource.fogTop=e)}},{key:"fogRange",get:function(){return this._fogRange},set:function(e){this._fogRange=e,this._resource&&(this._resource.fogRange=e)}}]),e}(),RI.FogType=Yg,T((yI=DI).prototype,"enabled",[Nc,zw,Uw],Object.getOwnPropertyDescriptor(yI.prototype,"enabled"),yI.prototype),T(yI.prototype,"accurate",[Nc,kw,Gw],Object.getOwnPropertyDescriptor(yI.prototype,"accurate"),yI.prototype),T(yI.prototype,"fogColor",[Nc,Hw],Object.getOwnPropertyDescriptor(yI.prototype,"fogColor"),yI.prototype),T(yI.prototype,"type",[Nc,Vw,Ww,jw],Object.getOwnPropertyDescriptor(yI.prototype,"type"),yI.prototype),T(yI.prototype,"fogDensity",[qw,Xw,Yw,Kw,Hc,Qw],Object.getOwnPropertyDescriptor(yI.prototype,"fogDensity"),yI.prototype),T(yI.prototype,"fogStart",[Jw,Zw,$w,eI],Object.getOwnPropertyDescriptor(yI.prototype,"fogStart"),yI.prototype),T(yI.prototype,"fogEnd",[tI,nI,iI,rI],Object.getOwnPropertyDescriptor(yI.prototype,"fogEnd"),yI.prototype),T(yI.prototype,"fogAtten",[oI,aI,sI,cI,lI],Object.getOwnPropertyDescriptor(yI.prototype,"fogAtten"),yI.prototype),T(yI.prototype,"fogTop",[uI,hI,_I,fI],Object.getOwnPropertyDescriptor(yI.prototype,"fogTop"),yI.prototype),T(yI.prototype,"fogRange",[dI,pI,mI,vI],Object.getOwnPropertyDescriptor(yI.prototype,"fogRange"),yI.prototype),xI=T(yI.prototype,"_type",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Yg.LINEAR}}),SI=T(yI.prototype,"_fogColor",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Qn("#C8C8C8")}}),EI=T(yI.prototype,"_enabled",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),TI=T(yI.prototype,"_fogDensity",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.3}}),CI=T(yI.prototype,"_fogStart",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.5}}),bI=T(yI.prototype,"_fogEnd",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 300}}),AI=T(yI.prototype,"_fogAtten",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 5}}),wI=T(yI.prototype,"_fogTop",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1.5}}),II=T(yI.prototype,"_fogRange",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1.2}}),PI=T(yI.prototype,"_accurate",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),gI=yI))||gI)),BP=e("ShadowsInfo",(OI=dc("cc.ShadowsInfo"),NI=Bc(),MI=Jc(Vv),LI=Mc(),FI=Mc(),BI=Bc(),zI=Jc(bt),UI=Mc(),kI=Bc(),GI=Jc(Ct),HI=Bc(),VI=Mc(),WI=Jc(Hv),jI=Bc(),qI=Mc(),OI((T((YI=function(){function e(){E(this,"_enabled",KI,this),E(this,"_type",QI,this),E(this,"_normal",JI,this),E(this,"_distance",ZI,this),E(this,"_shadowColor",$I,this),E(this,"_maxReceived",eP,this),E(this,"_size",tP,this),this._resource=null}var t=e.prototype;return t.setPlaneFromNode=function(e){e.getWorldRotation(OP),this.planeDirection=yn.transformQuat(PP,IP,OP),e.getWorldPosition(PP),this.planeHeight=yn.dot(this._normal,PP)},t.activate=function(e){this._resource=e,this._resource.initialize(this),this._resource.activate()},h(e,[{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled!==e&&(this._enabled=e,this._resource&&(this._resource.enabled=e,e&&(this._resource.type=this._type)))}},{key:"type",get:function(){return this._type},set:function(e){this._type=e,this._resource&&(this._resource.type=e)}},{key:"shadowColor",get:function(){return this._shadowColor},set:function(e){this._shadowColor.set(e),this._resource&&(this._resource.shadowColor=e)}},{key:"planeDirection",get:function(){return this._normal},set:function(e){yn.copy(this._normal,e),this._resource&&(this._resource.normal=e)}},{key:"planeHeight",get:function(){return this._distance},set:function(e){this._distance=e,this._resource&&(this._resource.distance=-e)}},{key:"maxReceived",get:function(){return this._maxReceived},set:function(e){this._maxReceived=e,this._resource&&(this._resource.maxReceived=e)}},{key:"shadowMapSize",get:function(){return this._size.x},set:function(e){this._size.set(e,e),this._resource&&(this._resource.size.set(e,e),this._resource.shadowMapDirty=!0)}},{key:"size",get:function(){return this._size}}]),e}()).prototype,"enabled",[Nc,NI],Object.getOwnPropertyDescriptor(YI.prototype,"enabled"),YI.prototype),T(YI.prototype,"type",[Nc,MI],Object.getOwnPropertyDescriptor(YI.prototype,"type"),YI.prototype),T(YI.prototype,"shadowColor",[LI],Object.getOwnPropertyDescriptor(YI.prototype,"shadowColor"),YI.prototype),T(YI.prototype,"planeDirection",[FI,BI],Object.getOwnPropertyDescriptor(YI.prototype,"planeDirection"),YI.prototype),T(YI.prototype,"planeHeight",[Nc,zI,UI,kI],Object.getOwnPropertyDescriptor(YI.prototype,"planeHeight"),YI.prototype),T(YI.prototype,"maxReceived",[GI,HI,VI],Object.getOwnPropertyDescriptor(YI.prototype,"maxReceived"),YI.prototype),T(YI.prototype,"shadowMapSize",[WI,jI,qI],Object.getOwnPropertyDescriptor(YI.prototype,"shadowMapSize"),YI.prototype),KI=T(YI.prototype,"_enabled",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),QI=T(YI.prototype,"_type",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Vv.Planar}}),JI=T(YI.prototype,"_normal",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new yn(0,1,0)}}),ZI=T(YI.prototype,"_distance",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),$I=T(YI.prototype,"_shadowColor",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Qn(0,0,0,76)}}),eP=T(YI.prototype,"_maxReceived",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 4}}),tP=T(YI.prototype,"_size",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Tn(512,512)}}),XI=YI))||XI));b.ShadowsInfo=BP;var zP,UP,kP,GP,HP=e("DEFAULT_WORLD_MIN_POS",new yn(-1024,-1024,-1024)),VP=e("DEFAULT_WORLD_MAX_POS",new yn(1024,1024,1024)),WP=e("DEFAULT_OCTREE_DEPTH",8),jP=e("OctreeInfo",(nP=dc("cc.OctreeInfo"),iP=Bc(),rP=Bc(),oP=Fc(),aP=Bc(),sP=Fc(),cP=zc(),lP=Jc(Ct),uP=Bc(),nP((T((_P=function(){function e(){E(this,"_enabled",fP,this),E(this,"_minPos",dP,this),E(this,"_maxPos",pP,this),E(this,"_depth",mP,this),this._resource=null}return e.prototype.activate=function(e){this._resource=e,this._resource.initialize(this)},h(e,[{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled!==e&&(this._enabled=e,this._resource&&(this._resource.enabled=e))}},{key:"minPos",get:function(){return this._minPos},set:function(e){this._minPos=e,this._resource&&(this._resource.minPos=e)}},{key:"maxPos",get:function(){return this._maxPos},set:function(e){this._maxPos=e,this._resource&&(this._resource.maxPos=e)}},{key:"depth",get:function(){return this._depth},set:function(e){this._depth=e,this._resource&&(this._resource.depth=e)}}]),e}()).prototype,"enabled",[Nc,iP],Object.getOwnPropertyDescriptor(_P.prototype,"enabled"),_P.prototype),T(_P.prototype,"minPos",[Nc,rP,oP],Object.getOwnPropertyDescriptor(_P.prototype,"minPos"),_P.prototype),T(_P.prototype,"maxPos",[Nc,aP,sP],Object.getOwnPropertyDescriptor(_P.prototype,"maxPos"),_P.prototype),T(_P.prototype,"depth",[Nc,cP,Hc,lP,uP],Object.getOwnPropertyDescriptor(_P.prototype,"depth"),_P.prototype),fP=T(_P.prototype,"_enabled",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),dP=T(_P.prototype,"_minPos",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new yn(HP)}}),pP=T(_P.prototype,"_maxPos",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new yn(VP)}}),mP=T(_P.prototype,"_depth",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return WP}}),hP=_P))||hP)),qP=e("SceneGlobals",(vP=dc("cc.SceneGlobals"),gP=Jc(LP),vP((AP=function(){function e(){E(this,"ambient",SP,this),E(this,"shadows",EP,this),E(this,"_skybox",TP,this),E(this,"fog",CP,this),E(this,"octree",bP,this)}return e.prototype.activate=function(){var e=b.director.root.pipeline.pipelineSceneData;this.skybox.activate(e.skybox),this.ambient.activate(e.ambient),this.shadows.activate(e.shadows),this.fog.activate(e.fog),this.octree.activate(e.octree)},h(e,[{key:"skybox",get:function(){return this._skybox},set:function(e){this._skybox=e}}]),e}(),SP=T((xP=AP).prototype,"ambient",[Ec,Nc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new MP}}),EP=T(xP.prototype,"shadows",[Ec,Nc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new BP}}),TP=T(xP.prototype,"_skybox",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new LP}}),CP=T(xP.prototype,"fog",[Nc,Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new FP}}),T(xP.prototype,"skybox",[Nc,gP],Object.getOwnPropertyDescriptor(xP.prototype,"skybox"),xP.prototype),bP=T(xP.prototype,"octree",[Nc,Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new jP}}),yP=xP))||yP));b.SceneGlobals=qP;var XP=e("Scene",dc("cc.Scene")((T((UP=function(e){f(n,e);var t=n.prototype;function n(t){var n;return E(n=e.call(this,t)||this,"autoReleaseAssets",kP,y(n)),E(n,"_globals",GP,y(n)),n.dependAssets=null,n._renderScene=null,n._inited=void 0,n._prefabSyncedInLiveReload=!1,n._pos=yn.ZERO,n._rot=On.IDENTITY,n._scale=yn.ONE,n._mat=kn.IDENTITY,n._dirtyFlags=0,n._lpos=yn.ZERO,n._lrot=On.IDENTITY,n._lscale=yn.ONE,n._activeInHierarchy=!1,b.director&&b.director.root&&(n._renderScene=b.director.root.createScene({})),n._inited=!b.game||!b.game._isCloning,n._init(),n}return t._updateScene=function(){this._scene=this},t._init=function(){},t.destroy=function(){var e=ol.prototype.destroy.call(this);if(e)for(var t=this._children,n=0;n<t.length;++n)t[n].active=!1;return this._renderScene&&b.director.root.destroyScene(this._renderScene),this._active=!1,this._activeInHierarchy=!1,e},t.addComponent=function(){throw new Error(Z(3822))},t._onHierarchyChanged=function(){},t._onBatchCreated=function(t){e.prototype._onBatchCreated.call(this,t);for(var n=this._children.length,i=0;i<n;++i)this.children[i]._siblingIndex=i,this._children[i]._onBatchCreated(t)},t.getPosition=function(e){return yn.copy(e||new yn,yn.ZERO)},t.getRotation=function(e){return On.copy(e||new On,On.IDENTITY)},t.getScale=function(e){return yn.copy(e||new yn,yn.ONE)},t.getWorldPosition=function(e){return yn.copy(e||new yn,yn.ZERO)},t.getWorldRotation=function(e){return On.copy(e||new On,On.IDENTITY)},t.getWorldScale=function(e){return yn.copy(e||new yn,yn.ONE)},t.getWorldMatrix=function(e){return kn.copy(e||new kn,kn.IDENTITY)},t.getWorldRS=function(e){return kn.copy(e||new kn,kn.IDENTITY)},t.getWorldRT=function(e){return kn.copy(e||new kn,kn.IDENTITY)},t.updateWorldTransform=function(){},t._instantiate=function(){},t._load=function(){this._inited||(lA(this),sA(this),this._onBatchCreated(false),this._inited=!0),this.walk(mC._setScene)},t._activate=function(e){e=!1!==e,b.director._nodeActivator.activateNode(this,e),this._globals.activate(),this._renderScene&&this._renderScene.activate()},h(n,[{key:"renderScene",get:function(){return this._renderScene}},{key:"globals",get:function(){return this._globals}},{key:"native",get:function(){return this._nativeObj}},{key:"position",get:function(){return yn.ZERO}},{key:"worldPosition",get:function(){return yn.ZERO}},{key:"rotation",get:function(){return On.IDENTITY}},{key:"worldRotation",get:function(){return On.IDENTITY}},{key:"scale",get:function(){return yn.ONE}},{key:"worldScale",get:function(){return yn.ONE}},{key:"eulerAngles",get:function(){return yn.ZERO}},{key:"worldMatrix",get:function(){return kn.IDENTITY}}]),n}(mC)).prototype,"globals",[Nc],Object.getOwnPropertyDescriptor(UP.prototype,"globals"),UP.prototype),kP=T(UP.prototype,"autoReleaseAssets",[Ec,Nc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),GP=T(UP.prototype,"_globals",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new qP}}),zP=UP))||zP);function YP(e,t){if(!t){var n=b.director.getScene();if(!n)return null;t=n}return t.getChildByPath(e)}b.Scene=XP,b.find=YP;var KP=Ye.fastRemoveAt,QP=ol.Flags.IsStartCalled,JP=ol.Flags.IsOnEnableCalled;function ZP(e,t){for(var n=t.constructor._executionOrder,i=t._id,r=0,o=e.length-1,a=o>>>1;r<=o;a=r+o>>>1){var s=e[a],c=s.constructor._executionOrder;if(c>n)o=a-1;else if(c<n)r=a+1;else{var l=s._id;if(l>i)o=a-1;else{if(!(l<i))return a;r=a+1}}}return~r}function $P(e,t){for(var n=e.array,i=e.i+1;i<n.length;){var r=n[i];r.node._activeInHierarchy?++i:(e.removeAt(i),t&&(r._objFlags&=~t))}}ol.Flags.IsEditorOnEnableCalled;var eR=function(e){this._zero=void 0,this._neg=void 0,this._pos=void 0,this._invoke=void 0;var t=ne;this._zero=new t([]),this._neg=new t([]),this._pos=new t([]),this._invoke=e};function tR(e,t){return e.constructor._executionOrder-t.constructor._executionOrder}eR.stableRemoveInactive=$P;var nR=function(e){function t(){return e.apply(this,arguments)||this}f(t,e);var n=t.prototype;return n.add=function(e){var t=e.constructor._executionOrder;(0===t?this._zero:t<0?this._neg:this._pos).array.push(e)},n.remove=function(e){var t=e.constructor._executionOrder;(0===t?this._zero:t<0?this._neg:this._pos).fastRemove(e)},n.cancelInactive=function(e){$P(this._zero,e),$P(this._neg,e),$P(this._pos,e)},n.invoke=function(){var e=this._neg;e.array.length>0&&(e.array.sort(tR),this._invoke(e),e.array.length=0),this._invoke(this._zero),this._zero.array.length=0;var t=this._pos;t.array.length>0&&(t.array.sort(tR),this._invoke(t),t.array.length=0)},t}(eR),iR=function(e){function t(){return e.apply(this,arguments)||this}f(t,e);var n=t.prototype;return n.add=function(e){var t=e.constructor._executionOrder;if(0===t)this._zero.array.push(e);else{var n=t<0?this._neg.array:this._pos.array,i=ZP(n,e);i<0&&n.splice(~i,0,e)}},n.remove=function(e){var t=e.constructor._executionOrder;if(0===t)this._zero.fastRemove(e);else{var n=t<0?this._neg:this._pos,i=ZP(n.array,e);i>=0&&n.removeAt(i)}},n.invoke=function(e){this._neg.array.length>0&&this._invoke(this._neg,e),this._invoke(this._zero,e),this._pos.array.length>0&&this._invoke(this._pos,e)},t}(eR);function rR(e,t,n){var i="var a=it.array;for(it.i=0;it.i<a.length;++it.i){var c=a[it.i];"+e+"}",r=t?Function("it","dt",i):Function("it",i);return function(e,t,n){return function(i,r){try{t(i,r)}catch(t){b._throw(t);var o=i.array;for(n&&(o[i.i]._objFlags|=n),++i.i;i.i<o.length;++i.i)try{e(o[i.i],r)}catch(e){b._throw(e),n&&(o[i.i]._objFlags|=n)}}}}(Function("c","dt",e),r,n)}var oR=rR("c.start();c._objFlags|="+QP,!1,QP),aR=rR("c.update(dt)",!0),sR=rR("c.lateUpdate(dt)",!0),cR=function(e){var t=b.director._compScheduler,n=e.array;for(e.i=0;e.i<n.length;++e.i){var i=n[e.i];i._enabled&&(i.onEnable(),!i.node._activeInHierarchy||t._onEnabled(i))}},lR=function(){function e(){this._deferredComps=[],this.unscheduleAll()}var t=e.prototype;return t.unscheduleAll=function(){this.startInvoker=new nR(oR),this.updateInvoker=new iR(aR),this.lateUpdateInvoker=new iR(sR),this._updating=!1},t._onEnabled=function(e){b.director.getScheduler().resumeTarget(e),e._objFlags|=JP,this._updating?this._deferredComps.push(e):this._scheduleImmediate(e)},t._onDisabled=function(e){b.director.getScheduler().pauseTarget(e),e._objFlags&=~JP;var t=this._deferredComps.indexOf(e);t>=0?KP(this._deferredComps,t):(!e.start||e._objFlags&QP||this.startInvoker.remove(e),e.update&&this.updateInvoker.remove(e),e.lateUpdate&&this.lateUpdateInvoker.remove(e))},t.enableComp=function(e,t){if(!(e._objFlags&JP)){if(e.onEnable){if(t)return void t.add(e);if(e.onEnable(),!e.node._activeInHierarchy)return}this._onEnabled(e)}},t.disableComp=function(e){e._objFlags&JP&&(e.onDisable&&e.onDisable(),this._onDisabled(e))},t.startPhase=function(){this._updating=!0,this.startInvoker.invoke(),this._startForNewComps()},t.updatePhase=function(e){this.updateInvoker.invoke(e)},t.lateUpdatePhase=function(e){this.lateUpdateInvoker.invoke(e),this._updating=!1,this._startForNewComps()},t._startForNewComps=function(){this._deferredComps.length>0&&(this._deferredSchedule(),this.startInvoker.invoke())},t._scheduleImmediate=function(e){"function"!=typeof e.start||e._objFlags&QP||this.startInvoker.add(e),"function"==typeof e.update&&this.updateInvoker.add(e),"function"==typeof e.lateUpdate&&this.lateUpdateInvoker.add(e)},t._deferredSchedule=function(){for(var e=this._deferredComps,t=0,n=e.length;t<n;t++)this._scheduleImmediate(e[t]);e.length=0},e}(),uR=ol.Flags.IsPreloadStarted,hR=ol.Flags.IsOnLoadStarted,_R=ol.Flags.IsOnLoadCalled,fR=ol.Flags.Deactivating,dR=function(e){function t(){return e.apply(this,arguments)||this}f(t,e);var n=t.prototype;return n.add=function(e){this._zero.array.push(e)},n.remove=function(e){this._zero.fastRemove(e)},n.cancelInactive=function(e){eR.stableRemoveInactive(this._zero,e)},n.invoke=function(){this._invoke(this._zero),this._zero.array.length=0},t}(eR),pR=rR("c.__preload();"),mR=rR("c.onLoad();c._objFlags|="+_R,!1,_R),vR=new Xe(4);function gR(e,t,n){Y(3817,e.name,n),console.log("Corrupted component value:",t),t?e._removeComponent(t):Ye.removeAt(e._components,n)}vR.get=function(){var e=this._get()||{preload:new dR(pR),onLoad:new nR(mR),onEnable:new nR(cR)};e.preload._zero.i=-1;var t=e.onLoad;return t._zero.i=-1,t._neg.i=-1,t._pos.i=-1,(t=e.onEnable)._zero.i=-1,t._neg.i=-1,t._pos.i=-1,e};var yR,xR,SR,ER,TR,CR,bR,AR,wR=e("NodeActivator",function(){function e(){this.resetComp=void 0,this.reset()}var t=e.prototype;return t.reset=function(){this._activatingStack=[]},t.activateNode=function(e,t){if(t){var n=vR.get();this._activatingStack.push(n),this._activateNodeRecursively(e,n.preload,n.onLoad,n.onEnable),n.preload.invoke(),n.onLoad.invoke(),n.onEnable.invoke(),this._activatingStack.pop(),vR.put(n)}else{this._deactivateNodeRecursively(e);for(var i,r=S(this._activatingStack);!(i=r()).done;){var o=i.value;o.preload.cancelInactive(uR),o.onLoad.cancelInactive(hR),o.onEnable.cancelInactive()}}e.emit(VT.ACTIVE_IN_HIERARCHY_CHANGED,e)},t.activateComp=function(e,t,n,i){if(sl(e,!0)&&(e._objFlags&uR||(e._objFlags|=uR,e.__preload&&(t?t.add(e):e.__preload())),e._objFlags&hR||(e._objFlags|=hR,e.onLoad?n?n.add(e):(e.onLoad(),e._objFlags|=_R):e._objFlags|=_R),e._enabled)){if(!e.node._activeInHierarchy)return;b.director._compScheduler.enableComp(e,i)}},t.destroyComp=function(e){b.director._compScheduler.disableComp(e),e.onDestroy&&e._objFlags&_R&&e.onDestroy()},t._activateNodeRecursively=function(e,t,n,i){if(e._objFlags&fR)Y(3816,e.name);else{e._activeInHierarchy=!0;for(var r=e._components.length,o=0;o<r;++o){var a=e._components[o];a instanceof b.Component?this.activateComp(a,t,n,i):(gR(e,a,o),--o,--r)}for(var s=0,c=e._children.length;s<c;++s){var l=e._children[s];l._active&&this._activateNodeRecursively(l,t,n,i)}e._onPostActivated(!0)}},t._deactivateNodeRecursively=function(e){e._objFlags|=fR,e._activeInHierarchy=!1;for(var t=e._components.length,n=0;n<t;++n){var i=e._components[n];if(i._enabled&&(b.director._compScheduler.disableComp(i),e._activeInHierarchy))return void(e._objFlags&=~fR)}for(var r=0,o=e._children.length;r<o;++r){var a=e._children[r];if(a._activeInHierarchy&&(this._deactivateNodeRecursively(a),e._activeInHierarchy))return void(e._objFlags&=~fR)}e._onPostActivated(!1),e._objFlags&=~fR},e}()),IR=e("SceneAsset",dc("cc.SceneAsset")((ER=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return E(t=e.call.apply(e,[this].concat(i))||this,"scene",SR,y(t)),t}f(t,e);var n=t.prototype;return n.initDefault=function(t){e.prototype.initDefault.call(this,t),this.scene=new XP("New Scene")},n.validate=function(){return!!this.scene},t}(yu),SR=T((xR=ER).prototype,"scene",[Nc,Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),yR=xR))||yR);b.SceneAsset=IR;var PR,RR,DR,OR,NR=e("TextAsset",dc("cc.TextAsset")((AR=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return E(t=e.call.apply(e,[this].concat(i))||this,"text",bR,y(t)),t}return f(t,e),t.prototype.toString=function(){return this.text},t}(yu),bR=T((CR=AR).prototype,"text",[Ec,Nc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),TR=CR))||TR);b.TextAsset=NR;var MR=e("JsonAsset",dc("cc.JsonAsset")((OR=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return E(t=e.call.apply(e,[this].concat(i))||this,"json",DR,y(t)),t}return f(t,e),t}(yu),DR=T((RR=OR).prototype,"json",[Ec,Nc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),PR=RR))||PR);b.JsonAsset=MR;var LR,FR,BR,zR,UR,kR,GR,HR,VR,WR,jR,qR,XR,YR,KR,QR,JR,ZR,$R,eD,tD,nD,iD,rD,oD,aD,sD,cD,lD,uD,hD,_D,fD,dD,pD,mD,vD,gD,yD=function(){var e=t.prototype;function t(){this.fog=new Qg,this.ambient=new kg,this.skybox=new qg,this.shadows=new qv,this.octree=new ey,this.validPunctualLights=[],this.renderObjects=[],this.castShadowObjects=[],this.dirShadowObjects=[],this.shadowFrameBufferMap=new Map,this._geometryRendererMaterials=[],this._geometryRendererPasses=[],this._geometryRendererShaders=[],this._occlusionQueryVertexBuffer=null,this._occlusionQueryIndicesBuffer=null,this._occlusionQueryInputAssembler=null,this._occlusionQueryMaterial=null,this._occlusionQueryShader=null,this._isHDR=!0,this._shadingScale=1,this._init(),this.shadingScale=1}return e._init=function(){},e.activate=function(e,t){return this._device=e,this._pipeline=t,this.initGeometryRendererMaterials(),this.initOcclusionQuery(),!0},e.initGeometryRendererMaterials=function(){for(var e=0,t=0;t<6;t++){this._geometryRendererMaterials[t]=new Ov,this._geometryRendererMaterials[t]._uuid="geometry-renderer-material-"+t,this._geometryRendererMaterials[t].initialize({effectName:"geometry-renderer",technique:t});for(var n=0;n<this._geometryRendererMaterials[t].passes.length;++n)this._geometryRendererPasses[e]=this._geometryRendererMaterials[t].passes[n],this._geometryRendererShaders[e]=this._geometryRendererMaterials[t].passes[n].getShaderVariant(),e++}},e.initOcclusionQuery=function(){if(this._occlusionQueryInputAssembler||(this._occlusionQueryInputAssembler=this._createOcclusionQueryIA()),!this._occlusionQueryMaterial){var e=new Ov;e._uuid="default-occlusion-query-material",e.initialize({effectName:"occlusion-query"}),this._occlusionQueryMaterial=e,this._occlusionQueryShader=e.passes[0].getShaderVariant()}},e.getOcclusionQueryPass=function(){return this._occlusionQueryMaterial.passes[0]},e.onGlobalPipelineStateChanged=function(){},e.destroy=function(){var e,t,n;this.ambient.destroy(),this.skybox.destroy(),this.fog.destroy(),this.shadows.destroy(),this.octree.destroy(),this.validPunctualLights.length=0,null===(e=this._occlusionQueryInputAssembler)||void 0===e||e.destroy(),this._occlusionQueryInputAssembler=null,null===(t=this._occlusionQueryVertexBuffer)||void 0===t||t.destroy(),this._occlusionQueryVertexBuffer=null,null===(n=this._occlusionQueryIndicesBuffer)||void 0===n||n.destroy(),this._occlusionQueryIndicesBuffer=null},e._createOcclusionQueryIA=function(){var e=this._device,t=new Float32Array([-1,-1,-1,1,-1,-1,-1,1,-1,1,1,-1,-1,-1,1,1,-1,1,-1,1,1,1,1,1]),n=3*Float32Array.BYTES_PER_ELEMENT,i=8*n;this._occlusionQueryVertexBuffer=e.createBuffer(new cr(li.VERTEX|li.TRANSFER_DST,_i.DEVICE,i,n)),this._occlusionQueryVertexBuffer.update(t);var r=new Uint16Array([0,2,1,1,2,3,4,5,6,5,7,6,1,3,7,1,7,5,0,4,6,0,6,2,0,1,5,0,5,4,2,6,7,2,7,3]),o=Uint16Array.BYTES_PER_ELEMENT,a=36*o;this._occlusionQueryIndicesBuffer=e.createBuffer(new cr(li.INDEX|li.TRANSFER_DST,_i.DEVICE,a,o)),this._occlusionQueryIndicesBuffer.update(r);var s=[new br("a_position",ai.RGB32F)],c=new wr(s,[this._occlusionQueryVertexBuffer],this._occlusionQueryIndicesBuffer);return e.createInputAssembler(c)},h(t,[{key:"native",get:function(){return this._nativeObj}},{key:"isHDR",get:function(){return this._isHDR},set:function(e){this._isHDR=e}},{key:"shadingScale",get:function(){return this._shadingScale},set:function(e){this._shadingScale!==e&&(this._shadingScale=e,this._pipeline.emit(dx.ATTACHMENT_SCALE_CAHNGED,e))}},{key:"geometryRendererPasses",get:function(){return this._geometryRendererPasses}},{key:"geometryRendererShaders",get:function(){return this._geometryRendererShaders}}]),t}(),xD=e("ForwardPipeline",(LR=dc("ForwardPipeline"),FR=Jc([dE]),BR=Vc(),LR((GR=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return E(t=e.call.apply(e,[this].concat(i))||this,"renderTextures",kR,y(t)),t._postRenderPass=null,t}f(t,e);var n=t.prototype;return n.initialize=function(t){if(e.prototype.initialize.call(this,t),0===this._flows.length){var n=new TT;n.initialize(TT.initInfo),this._flows.push(n);var i=new eT;i.initialize(eT.initInfo),this._flows.push(i)}return!0},n.activate=function(t){return this._macros={CC_PIPELINE_TYPE:0},this._pipelineSceneData=new yD,!(!e.prototype.activate.call(this,t)||!this._activeRenderer(t)&&(Y(2402),1))},n._ensureEnoughSize=function(e){for(var t=this._width,n=this._height,i=0;i<e.length;++i){var r=e[i].window;t=Math.max(r.width,t),n=Math.max(r.height,n)}t===this._width&&n===this._height||(this._width=t,this._height=n)},n.destroy=function(){this._destroyUBOs(),this._destroyQuadInputAssembler();for(var t=this._renderPasses.values(),n=t.next();!n.done;)n.value.destroy(),n=t.next();return this._commandBuffers.length=0,e.prototype.destroy.call(this)},n._activeRenderer=function(){var e=this.device;this._commandBuffers.push(e.commandBuffer);var t=this.globalDSManager.pointSampler;return this._descriptorSet.bindSampler(Cd,t),this._descriptorSet.bindTexture(Cd,nv.get("default-texture").getGFXTexture()),this._descriptorSet.bindSampler(Nd,t),this._descriptorSet.bindTexture(Nd,nv.get("default-texture").getGFXTexture()),this._descriptorSet.update(),!0},n._destroyUBOs=function(){this._descriptorSet&&(this._descriptorSet.getBuffer(Sd.BINDING).destroy(),this._descriptorSet.getBuffer(Td.BINDING).destroy(),this._descriptorSet.getBuffer(Ed.BINDING).destroy(),this._descriptorSet.getTexture(Cd).destroy(),this._descriptorSet.getTexture(Nd).destroy())},h(t,[{key:"postRenderPass",get:function(){return this._postRenderPass}}]),t}(Fx),kR=T((UR=GR).prototype,"renderTextures",[FR,Ec,BR],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),zR=UR))||zR)),SD=[new rr(0,0,0,0),new rr(0,0,0,0),new rr(0,0,0,0)],ED=e("GbufferStage",(HR=dc("GbufferStage"),VR=Jc([vE]),WR=Vc(),HR((KR=YR=function(e){function t(){var t;return E(t=e.call(this)||this,"renderQueues",XR,y(t)),t._renderQueues=[],t._renderArea=new Qi,t._batchedQueue=void 0,t._instancedQueue=void 0,t._phaseID=iv("default"),t._batchedQueue=new CE,t._instancedQueue=new bE,t}f(t,e);var n=t.prototype;return n.initialize=function(t){return e.prototype.initialize.call(this,t),t.renderQueues&&(this.renderQueues=t.renderQueues),!0},n.activate=function(t,n){e.prototype.activate.call(this,t,n);for(var i=0;i<this.renderQueues.length;i++)this._renderQueues[i]=SE(this.renderQueues[i])},n.destroy=function(){},n.render=function(e){this._instancedQueue.clear(),this._batchedQueue.clear();var t=this._pipeline,n=t.device;this._renderQueues.forEach(EE),t.generateRenderArea(e,this._renderArea),t.updateQuadVertexData(this._renderArea,e.window);for(var i=t.pipelineSceneData.renderObjects,r=0,o=0,a=0,s=0;s<i.length;++s){var c=i[s],l=c.model.subModels;for(r=0;r<l.length;++r){var u=l[r],h=u.passes;for(o=0;o<h.length;++o){var _=h[o];if(_.phase===this._phaseID){var f=_.batchingScheme;if(f===Zm.INSTANCING){var d=_.getInstancedBuffer();d.merge(u,c.model.instancedAttributes,o),this._instancedQueue.queue.add(d)}else if(f===Zm.VB_MERGING){var p=_.getBatchedBuffer();p.merge(u,o,c.model),this._batchedQueue.queue.add(p)}else for(a=0;a<this._renderQueues.length;a++)this._renderQueues[a].insertRenderPass(c,r,o)}}}}this._renderQueues.forEach(TE);var m=t.commandBuffers[0];this._instancedQueue.uploadBuffers(m),this._batchedQueue.uploadBuffers(m),e.clearFlag&Hi.COLOR&&(t.pipelineSceneData.isHDR?fv(SD[0],e.clearColor):(SD[0].x=e.clearColor.x,SD[0].y=e.clearColor.y,SD[0].z=e.clearColor.z)),SD[0].w=e.clearColor.w;var v=t.getPipelineRenderData().gbufferFrameBuffer,g=v.renderPass;m.beginRenderPass(g,v,this._renderArea,SD,e.clearDepth,e.clearStencil),m.setScissor(t.generateScissor(e)),m.setViewport(t.generateViewport(e)),m.bindDescriptorSet(md.GLOBAL,t.descriptorSet);for(var y=0;y<this.renderQueues.length;y++)this._renderQueues[y].recordCommandBuffer(n,g,m);this._instancedQueue.recordCommandBuffer(n,g,m),this._batchedQueue.recordCommandBuffer(n,g,m),m.endRenderPass()},t}(fx),YR.initInfo={name:"GbufferStage",priority:Ix.GBUFFER,tag:0,renderQueues:[{isTransparent:!1,sortMode:fE.FRONT_TO_BACK,stages:["default"]},{isTransparent:!0,sortMode:fE.BACK_TO_FRONT,stages:["default"]}]},XR=T((qR=KR).prototype,"renderQueues",[VR,Ec,WR],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),jR=qR))||jR)),TD=[new rr(0,0,0,1)],CD=e("LightingStage",(QR=dc("LightingStage"),JR=Jc(Ov),ZR=Vc(),$R=Jc([vE]),eD=Vc(),QR((aD=oD=function(e){function t(){var t;return(t=e.call(this)||this)._deferredLitsBufs=null,t._maxDeferredLights=Gd.LIGHTS_PER_PASS,t._lightMeterScale=1e4,t._descriptorSet=null,t._renderArea=new Qi,t._uiPhase=void 0,E(t,"_deferredMaterial",iD,y(t)),E(t,"renderQueues",rD,y(t)),t._phaseID=iv("default"),t._renderQueues=[],t._uiPhase=new JE,t}f(t,e);var n=t.prototype;return n.initialize=function(t){return e.prototype.initialize.call(this,t),!0},n.gatherLights=function(e){for(var t=this._pipeline,n=t.commandBuffers[0],i=e.scene.sphereLights,r=e.scene.spotLights,o=ea.create(0,0,0,1),a=new Float32Array(4),s=e.exposure,c=0,l=wn.length,u=l*this._maxDeferredLights,h=0;h<i.length&&c<this._maxDeferredLights;h++,++c){var _=i[h];if(ea.set(o,_.position.x,_.position.y,_.position.z,_.range),rs.sphereFrustum(o,e.frustum)){if(yn.toArray(a,_.position),a[3]=0,this._lightBufferData.set(a,c*l),yn.toArray(a,_.color),_.useColorTemperature){var f=_.colorTemperatureRGB;a[0]*=f.x,a[1]*=f.y,a[2]*=f.z}t.pipelineSceneData.isHDR?a[3]=_.luminance*s*this._lightMeterScale:a[3]=_.luminance,this._lightBufferData.set(a,c*l+1*u),a[0]=_.size,a[1]=_.range,a[2]=0,this._lightBufferData.set(a,c*l+2*u)}}for(var d=0;d<r.length&&c<this._maxDeferredLights;d++,++c){var p=r[d];if(ea.set(o,p.position.x,p.position.y,p.position.z,p.range),rs.sphereFrustum(o,e.frustum)){if(yn.toArray(a,p.position),a[3]=1,this._lightBufferData.set(a,c*l+0*u),yn.toArray(a,p.color),p.useColorTemperature){var m=p.colorTemperatureRGB;a[0]*=m.x,a[1]*=m.y,a[2]*=m.z}t.pipelineSceneData.isHDR?a[3]=p.luminance*s*this._lightMeterScale:a[3]=p.luminance,this._lightBufferData.set(a,c*l+1*u),a[0]=p.size,a[1]=p.range,a[2]=p.spotAngle,this._lightBufferData.set(a,c*l+2*u),yn.toArray(a,p.direction),this._lightBufferData.set(a,c*l+3*u)}}var v=3*u+3;this._lightBufferData.set([c],v),n.updateBuffer(this._deferredLitsBufs,this._lightBufferData)},n._createStageDescriptor=function(e){var t=this._pipeline.device,n=16*Float32Array.BYTES_PER_ELEMENT*this._maxDeferredLights;n=Math.ceil(n/t.capabilities.uboOffsetAlignment)*t.capabilities.uboOffsetAlignment,this._deferredLitsBufs=t.createBuffer(new cr(li.UNIFORM|li.TRANSFER_DST,_i.HOST|_i.DEVICE,n,t.capabilities.uboOffsetAlignment));var i=t.createBuffer(new lr(this._deferredLitsBufs,0,n));this._lightBufferData=new Float32Array(n/Float32Array.BYTES_PER_ELEMENT),this._descriptorSet=t.createDescriptorSet(new zr(e.localSetLayout)),this._descriptorSet.bindBuffer(kd.BINDING,i);var r=t.createBuffer(new cr(li.UNIFORM|li.TRANSFER_DST,_i.DEVICE,Fd.SIZE,Fd.SIZE));this._descriptorSet.bindBuffer(Fd.BINDING,r)},n.activate=function(t,n){e.prototype.activate.call(this,t,n),this._uiPhase.activate(t);for(var i=0;i<this.renderQueues.length;i++)this._renderQueues[i]=SE(this.renderQueues[i]);this._planarQueue=new QE(this._pipeline),this._deferredMaterial&&(t.pipelineSceneData.deferredLightingMaterial=this._deferredMaterial)},n.destroy=function(){var e;null===(e=this._deferredLitsBufs)||void 0===e||e.destroy(),this._deferredLitsBufs=null,this._descriptorSet=null},n.render=function(e){var t=this._pipeline,n=t.device,i=t.commandBuffers[0],r=t.pipelineSceneData,o=r.renderObjects;this._planarQueue.gatherShadowPasses(e,i),t.generateRenderArea(e,this._renderArea);for(var a=t.getPipelineRenderData(),s=r.deferredLightingMaterial.passes[0],c=s.getShaderVariant(),l=0;l<3;++l)s.descriptorSet.bindTexture(l,a.gbufferRenderTargets[l]),s.descriptorSet.bindSampler(l,a.sampler);s.descriptorSet.bindTexture(3,a.outputDepth),s.descriptorSet.bindSampler(3,a.sampler),s.descriptorSet.update(),this._descriptorSet||this._createStageDescriptor(s),this.gatherLights(e),e.clearFlag&Hi.COLOR&&(TD[0].x=e.clearColor.x,TD[0].y=e.clearColor.y,TD[0].z=e.clearColor.z),TD[0].w=0;var u=a.outputFrameBuffer,h=u.renderPass;t.pipelineUBO.updateShadowUBO(e),i.beginRenderPass(h,u,this._renderArea,TD,e.clearDepth,e.clearStencil),i.setScissor(t.generateScissor(e)),i.setViewport(t.generateViewport(e)),i.bindDescriptorSet(md.GLOBAL,t.descriptorSet);var _=t.quadIAOffscreen,f=null;null!=s&&null!=c&&null!=_&&(f=uv.getOrCreatePipelineState(n,s,c,h,_)),null!=f&&(this._descriptorSet.update(),i.bindPipelineState(f),i.bindDescriptorSet(md.MATERIAL,s.descriptorSet),i.bindDescriptorSet(md.LOCAL,this._descriptorSet),i.bindInputAssembler(_),i.draw(_)),this._renderQueues.forEach(EE);for(var d=0,p=0,m=0,v=0;v<o.length;++v){var g=o[v],y=g.model.subModels;for(d=0;d<y.length;++d){var x=y[d].passes;for(p=0;p<x.length;++p)if(x[p].phase===this._phaseID)for(m=0;m<this._renderQueues.length;m++)this._renderQueues[m].insertRenderPass(g,d,p)}}if(o.length>0){this._renderQueues.forEach(TE);for(var S=0;S<this._renderQueues.length;S++)this._renderQueues[S].recordCommandBuffer(n,h,i);this._planarQueue.recordCommandBuffer(n,h,i)}this._pipeline.geometryRenderer.render(h,i),this._uiPhase.render(e,h),i.endRenderPass()},t}(fx),oD.initInfo={name:"LightingStage",priority:Ix.LIGHTING,tag:0},iD=T((nD=aD).prototype,"_deferredMaterial",[JR,Ec,ZR],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),rD=T(nD.prototype,"renderQueues",[$R,Ec,eD],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),tD=nD))||tD)),bD=[new rr(0,0,0,1)],AD=e("PostProcessStage",(sD=dc("PostProcessStage"),cD=Jc(Ov),lD=Vc(),uD=Jc([vE]),hD=Vc(),sD((vD=mD=function(e){function t(){var t;return E(t=e.call(this)||this,"_postProcessMaterial",dD,y(t)),E(t,"renderQueues",pD,y(t)),t._renderArea=new Qi,t._stageDesc=void 0,t._localUBO=void 0,t._uiPhase=new JE,t}f(t,e);var n=t.prototype;return n.initialize=function(t){return e.prototype.initialize.call(this,t),!0},n.activate=function(t,n){e.prototype.activate.call(this,t,n),this._postProcessMaterial&&(t.pipelineSceneData.postprocessMaterial=this._postProcessMaterial),this._uiPhase.activate(t)},n.destroy=function(){},n.render=function(e){var t=this._pipeline,n=t.device,i=t.pipelineSceneData,r=t.commandBuffers[0];t.pipelineUBO.updateCameraUBO(e);var o=e.viewport;this._renderArea.x=o.x*e.window.width,this._renderArea.y=o.y*e.window.height,this._renderArea.width=o.width*e.window.width,this._renderArea.height=o.height*e.window.height;var a=t.getPipelineRenderData(),s=e.window.framebuffer,c=t.getRenderPass(e.clearFlag,s);e.clearFlag&Hi.COLOR&&(bD[0].x=e.clearColor.x,bD[0].y=e.clearColor.y,bD[0].z=e.clearColor.z),bD[0].w=e.clearColor.w,r.beginRenderPass(c,s,this._renderArea,bD,e.clearDepth,e.clearStencil),r.bindDescriptorSet(md.GLOBAL,t.descriptorSet);var l=i.postprocessMaterial.passes[0],u=l.getShaderVariant();t.bloomEnabled?l.descriptorSet.bindTexture(0,a.bloom.combineTex):l.descriptorSet.bindTexture(0,a.outputRenderTargets[0]),l.descriptorSet.bindSampler(0,a.sampler),l.descriptorSet.update();var h=e.window.swapchain?t.quadIAOnscreen:t.quadIAOffscreen,_=null;null!=l&&null!=u&&null!=h&&(_=uv.getOrCreatePipelineState(n,l,u,c,h));var f=t.pipelineSceneData.renderObjects;null!=_&&f.length>0&&(this._stageDesc||(this._stageDesc=n.createDescriptorSet(new zr(l.localSetLayout)),this._localUBO=n.createBuffer(new cr(li.UNIFORM|li.TRANSFER_DST,_i.DEVICE,Fd.SIZE,Fd.SIZE)),this._stageDesc.bindBuffer(Fd.BINDING,this._localUBO)),this._stageDesc.update(),r.bindPipelineState(_),r.bindDescriptorSet(md.MATERIAL,l.descriptorSet),r.bindDescriptorSet(md.LOCAL,this._stageDesc),r.bindInputAssembler(h),r.draw(h)),this._uiPhase.render(e,c),bv(n,c,r,t.profiler,e),r.endRenderPass()},t}(fx),mD.initInfo={name:"PostProcessStage",priority:bx.POST_PROCESS,tag:0},dD=T((fD=vD).prototype,"_postProcessMaterial",[cD,Ec,lD],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),pD=T(fD.prototype,"renderQueues",[uD,Ec,hD],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),_D=fD))||_D));!function(e){e[e.NONE=0]="NONE",e[e.FXAA=1]="FXAA"}(gD||(gD={}));var wD,ID,PD,RD,DD,OD,ND,MD,LD=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._antiAliasing=gD.NONE,t}f(t,e);var n=t.prototype;return n.onGlobalPipelineStateChanged=function(){this.updatePipelinePassInfo()},n.updateBloomPass=function(){if(this._bloomMaterial){var e=this._bloomMaterial.passes[0];e.beginChangeStatesSilently(),e.tryCompile(),e.endChangeStatesSilently();for(var t=[],n=[],i=0;i<6;++i){var r=this._bloomMaterial.passes[1+i];r.beginChangeStatesSilently(),r.tryCompile(),r.endChangeStatesSilently();var o=this._bloomMaterial.passes[7+i];o.beginChangeStatesSilently(),o.tryCompile(),o.endChangeStatesSilently(),t.push(r.native),n.push(o.native)}var a=this._bloomMaterial.passes[13];a.beginChangeStatesSilently(),a.tryCompile(),a.endChangeStatesSilently()}},n.updatePostProcessPass=function(){if(this.postprocessMaterial){var e=this.postprocessMaterial.passes[0];e.beginChangeStatesSilently(),e.tryCompile(),e.endChangeStatesSilently()}},n.initPipelinePassInfo=function(){var e=new Ov;e._uuid="builtin-deferred-material",e.initialize({effectName:"deferred-lighting"});for(var t=0;t<e.passes.length;++t)e.passes[t].tryCompile();this._deferredLightingMaterial=e;var n=new Ov;n._uuid="builtin-bloom-material",n.initialize({effectName:"bloom"});for(var i=0;i<n.passes.length;++i)n.passes[i].tryCompile();this._bloomMaterial=n;var r=new Ov;r._uuid="builtin-post-process-material",nt.ENABLE_ANTIALIAS_FXAA&&(this._antiAliasing=gD.FXAA),r.initialize({effectName:"post-process",defines:{ANTIALIAS_TYPE:this._antiAliasing}});for(var o=0;o<r.passes.length;++o)r.passes[o].tryCompile();this._postprocessMaterial=r,this.updatePipelinePassInfo()},n.updatePipelinePassInfo=function(){this.updateBloomPass(),this.updatePostProcessPass(),this.updateDeferredPassInfo()},n.activate=function(t,n){return e.prototype.activate.call(this,t,n),this.initPipelinePassInfo(),!0},n.updateDeferredPassInfo=function(){this.updateDeferredLightPass()},n.updateDeferredLightPass=function(){if(this._deferredLightingMaterial){this.shadows.enabled&&(this._pipeline.macros.CC_RECEIVE_SHADOW=1);var e=this._deferredLightingMaterial.passes[0];e.beginChangeStatesSilently(),e.tryCompile(),e.endChangeStatesSilently()}},h(t,[{key:"antiAliasing",get:function(){return this._antiAliasing},set:function(e){if(this._antiAliasing=e,this._postprocessMaterial){var t=this._postprocessMaterial.passes[0].defines;Object.assign(t,{ANTIALIAS_TYPE:e});var n=new Ov;n.initialize({effectAsset:this._postprocessMaterial.effectAsset,defines:t});for(var i=0;i<n.passes.length;++i)n.passes[i].tryCompile();this._postprocessMaterial=n}}},{key:"bloomMaterial",get:function(){return this._bloomMaterial},set:function(e){this._bloomMaterial!==e&&e&&(this._bloomMaterial=e,this.updatePipelinePassInfo())}},{key:"postprocessMaterial",get:function(){return this._postprocessMaterial},set:function(e){this._postprocessMaterial!==e&&e&&(this._postprocessMaterial=e,this.updatePipelinePassInfo())}},{key:"deferredLightingMaterial",get:function(){return this._deferredLightingMaterial},set:function(e){this._deferredLightingMaterial!==e&&e&&(this._deferredLightingMaterial=e,this.updatePipelinePassInfo())}}]),t}(yD),FD=[new rr(0,0,0,1)],BD=function(){};BD.SIZE=4*(BD.COUNT=4+(BD.TEXTURE_SIZE_OFFSET=0));var zD,UD,kD,GD,HD,VD,WD,jD,qD,XD,YD=e("BloomStage",(wD=dc("BloomStage"),ID=Jc(Ov),PD=Vc(),wD((MD=ND=function(e){function t(){var t;return(t=e.call(this)||this).threshold=1,t.intensity=.8,t.iterations=2,E(t,"_bloomMaterial",OD,y(t)),t._renderArea=new Qi,t._bloomUBO=[],t}f(t,e);var n=t.prototype;return n.initialize=function(t){return e.prototype.initialize.call(this,t),!0},n.activate=function(t,n){e.prototype.activate.call(this,t,n),this._bloomMaterial&&(t.pipelineSceneData.bloomMaterial=this._bloomMaterial)},n.destroy=function(){},n.render=function(e){var t,n=this._pipeline;if(n.generateBloomRenderData(),((null===(t=e.window)||void 0===t?void 0:t.swapchain)||n.macros.CC_PIPELINE_TYPE)&&n.bloomEnabled&&0!==n.pipelineSceneData.renderObjects.length){if(0===this._bloomUBO.length)for(var i=0;i<14;++i)this._bloomUBO[i]=n.device.createBuffer(new cr(li.UNIFORM|li.TRANSFER_DST,_i.HOST|_i.DEVICE,BD.SIZE,BD.SIZE));e.clearFlag&Hi.COLOR&&(FD[0].x=e.clearColor.x,FD[0].y=e.clearColor.y,FD[0].z=e.clearColor.z),FD[0].w=e.clearColor.w,this._prefilterPass(e,n),this._downsamplePass(e,n),this._upsamplePass(e,n),this._combinePass(e,n)}},n._prefilterPass=function(e,t){t.generateRenderArea(e,this._renderArea),this._renderArea.width>>=1,this._renderArea.height>>=1;var n=t.commandBuffers[0],i=t.pipelineSceneData.bloomMaterial.passes[0],r=t.getPipelineRenderData(),o=r.bloom,a=new Float32Array(BD.COUNT);a[BD.TEXTURE_SIZE_OFFSET+2]=this.threshold,n.updateBuffer(this._bloomUBO[0],a),n.beginRenderPass(o.renderPass,o.prefilterFramebuffer,this._renderArea,FD,0,0),n.bindDescriptorSet(md.GLOBAL,t.descriptorSet),i.descriptorSet.bindBuffer(0,this._bloomUBO[0]),i.descriptorSet.bindTexture(1,r.outputRenderTargets[0]),i.descriptorSet.bindSampler(1,o.sampler),i.descriptorSet.update(),n.bindDescriptorSet(md.MATERIAL,i.descriptorSet);var s=e.window.swapchain?t.quadIAOffscreen:t.quadIAOnscreen,c=null,l=i.getShaderVariant();null!=i&&null!=l&&null!=s&&(c=uv.getOrCreatePipelineState(t.device,i,l,o.renderPass,s)),null!=c&&(n.bindPipelineState(c),n.bindInputAssembler(s),n.draw(s)),n.endRenderPass()},n._downsamplePass=function(e,t){t.generateRenderArea(e,this._renderArea),this._renderArea.width>>=1,this._renderArea.height>>=1;for(var n=t.commandBuffers[0],i=t.pipelineSceneData.bloomMaterial,r=t.getPipelineRenderData().bloom,o=new Float32Array(BD.COUNT),a=0;a<this.iterations;++a){o[BD.TEXTURE_SIZE_OFFSET+0]=this._renderArea.width,o[BD.TEXTURE_SIZE_OFFSET+1]=this._renderArea.height,n.updateBuffer(this._bloomUBO[a+1],o),this._renderArea.width>>=1,this._renderArea.height>>=1,n.beginRenderPass(r.renderPass,r.downsampleFramebuffers[a],this._renderArea,FD,0,0);var s=i.passes[1+a],c=s.getShaderVariant();s.descriptorSet.bindBuffer(0,this._bloomUBO[a+1]),0===a?s.descriptorSet.bindTexture(1,r.prefiterTex):s.descriptorSet.bindTexture(1,r.downsampleTexs[a-1]),s.descriptorSet.bindSampler(1,r.sampler),s.descriptorSet.update(),n.bindDescriptorSet(md.MATERIAL,s.descriptorSet);var l=e.window.swapchain?t.quadIAOffscreen:t.quadIAOnscreen,u=null;null!=s&&null!=c&&null!=l&&(u=uv.getOrCreatePipelineState(t.device,s,c,r.renderPass,l)),null!=u&&(n.bindPipelineState(u),n.bindInputAssembler(l),n.draw(l)),n.endRenderPass()}},n._upsamplePass=function(e,t){var n=t.getPipelineRenderData().bloom;t.generateRenderArea(e,this._renderArea),this._renderArea.width>>=this.iterations+1,this._renderArea.height>>=this.iterations+1;for(var i=t.commandBuffers[0],r=t.pipelineSceneData.bloomMaterial,o=new Float32Array(BD.COUNT),a=0;a<this.iterations;++a){var s=a+6+1;o[BD.TEXTURE_SIZE_OFFSET+0]=this._renderArea.width,o[BD.TEXTURE_SIZE_OFFSET+1]=this._renderArea.height,i.updateBuffer(this._bloomUBO[s],o),this._renderArea.width<<=1,this._renderArea.height<<=1,i.beginRenderPass(n.renderPass,n.upsampleFramebuffers[this.iterations-1-a],this._renderArea,FD,0,0);var c=r.passes[7+a],l=c.getShaderVariant();c.descriptorSet.bindBuffer(0,this._bloomUBO[s]),0===a?c.descriptorSet.bindTexture(1,n.downsampleTexs[this.iterations-1]):c.descriptorSet.bindTexture(1,n.upsampleTexs[this.iterations-a]),c.descriptorSet.bindSampler(1,n.sampler),c.descriptorSet.update(),i.bindDescriptorSet(md.MATERIAL,c.descriptorSet);var u=e.window.swapchain?t.quadIAOffscreen:t.quadIAOnscreen,h=null;null!=c&&null!=l&&null!=u&&(h=uv.getOrCreatePipelineState(t.device,c,l,n.renderPass,u)),null!=h&&(i.bindPipelineState(h),i.bindInputAssembler(u),i.draw(u)),i.endRenderPass()}},n._combinePass=function(e,t){t.generateRenderArea(e,this._renderArea);var n=t.commandBuffers[0],i=t.pipelineSceneData.bloomMaterial,r=t.getPipelineRenderData(),o=r.bloom,a=new Float32Array(BD.COUNT);a[BD.TEXTURE_SIZE_OFFSET+3]=this.intensity,n.updateBuffer(this._bloomUBO[13],a),n.beginRenderPass(o.renderPass,o.combineFramebuffer,this._renderArea,FD,0,0),n.bindDescriptorSet(md.GLOBAL,t.descriptorSet);var s=i.passes[13];s.descriptorSet.bindBuffer(0,this._bloomUBO[13]),s.descriptorSet.bindTexture(1,r.outputRenderTargets[0]),s.descriptorSet.bindTexture(2,o.upsampleTexs[0]),s.descriptorSet.bindSampler(1,o.sampler),s.descriptorSet.bindSampler(2,o.sampler),s.descriptorSet.update(),n.bindDescriptorSet(md.MATERIAL,s.descriptorSet);var c=e.window.swapchain?t.quadIAOffscreen:t.quadIAOnscreen,l=null,u=s.getShaderVariant();null!=s&&null!=u&&null!=c&&(l=uv.getOrCreatePipelineState(t.device,s,u,o.renderPass,c)),null!=l&&(n.bindPipelineState(l),n.bindInputAssembler(c),n.draw(c)),n.endRenderPass()},t}(fx),ND.initInfo={name:"BloomStage",priority:bx.BLOOM,tag:0},OD=T((DD=MD).prototype,"_bloomMaterial",[ID,Ec,PD],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),RD=DD))||RD)),KD=e("MainFlow",dc("MainFlow")((kD=UD=function(e){function t(){return e.apply(this,arguments)||this}f(t,e);var n=t.prototype;return n.initialize=function(t){if(e.prototype.initialize.call(this,t),0===this._stages.length){var n=new ED;n.initialize(ED.initInfo),this._stages.push(n);var i=new CD;i.initialize(CD.initInfo),this._stages.push(i);var r=new YD;r.initialize(YD.initInfo),this._stages.push(r);var o=new AD;o.initialize(AD.initInfo),this._stages.push(o)}return!0},n.activate=function(t){e.prototype.activate.call(this,t)},n.render=function(t){e.prototype.render.call(this,t)},n.destroy=function(){e.prototype.destroy.call(this)},t}(px),UD.initInfo={name:sd,priority:Px.MAIN,stages:[]},zD=kD))||zD),QD=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).gbufferFrameBuffer=null,t.gbufferRenderTargets=[],t}return f(t,e),t}((function(){this.outputFrameBuffer=null,this.outputRenderTargets=[],this.outputDepth=null,this.sampler=null,this.bloom=null})),JD=e("DeferredPipeline",(GD=dc("DeferredPipeline"),HD=Jc([dE]),VD=Vc(),GD((XD=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gbufferRenderPass=null,t._lightingRenderPass=null,E(t,"renderTextures",qD,y(t)),t}f(t,e);var n=t.prototype;return n.initialize=function(t){if(e.prototype.initialize.call(this,t),0===this._flows.length){var n=new TT;n.initialize(TT.initInfo),this._flows.push(n);var i=new KD;i.initialize(KD.initInfo),this._flows.push(i)}return!0},n.activate=function(t){return this._macros={CC_PIPELINE_TYPE:1},this._pipelineSceneData=new LD,!(!e.prototype.activate.call(this,t)||!this._activeRenderer(t)&&(Y(2402),1))},n.destroy=function(){this._destroyUBOs(),this._destroyQuadInputAssembler(),this._destroyDeferredData();for(var t=this._renderPasses.values(),n=t.next();!n.done;)n.value.destroy(),n=t.next();return this._commandBuffers.length=0,e.prototype.destroy.call(this)},n.getPipelineRenderData=function(){return this._pipelineRenderData||this._generateDeferredRenderData(),this._pipelineRenderData},n._activeRenderer=function(e){var t=this.device;this._commandBuffers.push(t.commandBuffer);var n=this.globalDSManager.pointSampler;this._descriptorSet.bindSampler(Cd,n),this._descriptorSet.bindTexture(Cd,nv.get("default-texture").getGFXTexture()),this._descriptorSet.bindSampler(Nd,n),this._descriptorSet.bindTexture(Nd,nv.get("default-texture").getGFXTexture()),this._descriptorSet.update();var i=new Lx;if(!(i=this._createQuadInputAssembler()).quadIB||!i.quadVB||!i.quadIA)return!1;this._quadIB=i.quadIB,this._quadVBOffscreen=i.quadVB,this._quadIAOffscreen=i.quadIA;var r=this._createQuadInputAssembler();if(!r.quadIB||!r.quadVB||!r.quadIA)return!1;if(this._quadVBOnscreen=r.quadVB,this._quadIAOnscreen=r.quadIA,!this._gbufferRenderPass){var o=new Ir;o.format=ai.RGBA16F,o.loadOp=wi.CLEAR,o.storeOp=Ii.STORE;var a=new Ir;a.format=ai.RGBA16F,a.loadOp=wi.CLEAR,a.storeOp=Ii.STORE;var s=new Ir;s.format=ai.RGBA16F,s.loadOp=wi.CLEAR,s.storeOp=Ii.STORE;var c=new Pr;c.format=ai.DEPTH_STENCIL,c.depthLoadOp=wi.CLEAR,c.depthStoreOp=Ii.STORE,c.stencilLoadOp=wi.CLEAR,c.stencilStoreOp=Ii.STORE;var l=new Or([o,a,s],c);this._gbufferRenderPass=t.createRenderPass(l)}if(!this._lightingRenderPass){var u=new Ir;u.format=ai.RGBA8,u.loadOp=wi.CLEAR,u.storeOp=Ii.STORE,u.barrier=t.getGeneralBarrier(new Nr(Pi.NONE,Pi.COLOR_ATTACHMENT_WRITE));var h=new Pr;h.format=ai.DEPTH_STENCIL,h.depthLoadOp=wi.LOAD,h.depthStoreOp=Ii.DISCARD,h.stencilLoadOp=wi.LOAD,h.stencilStoreOp=Ii.DISCARD,u.barrier=t.getGeneralBarrier(new Nr(Pi.DEPTH_STENCIL_ATTACHMENT_WRITE,Pi.DEPTH_STENCIL_ATTACHMENT_WRITE));var _=new Or([u],h);this._lightingRenderPass=t.createRenderPass(_)}return this._width=e.width,this._height=e.height,this._generateDeferredRenderData(),!0},n._destroyUBOs=function(){this._descriptorSet&&(this._descriptorSet.getBuffer(Sd.BINDING).destroy(),this._descriptorSet.getBuffer(Td.BINDING).destroy(),this._descriptorSet.getBuffer(Ed.BINDING).destroy(),this._descriptorSet.getTexture(Cd).destroy(),this._descriptorSet.getTexture(Nd).destroy())},n._destroyDeferredData=function(){var e=this._pipelineRenderData;if(e){e.gbufferFrameBuffer&&e.gbufferFrameBuffer.destroy(),e.outputFrameBuffer&&e.outputFrameBuffer.destroy(),e.outputDepth&&e.outputDepth.destroy();for(var t=0;t<e.gbufferRenderTargets.length;t++)e.gbufferRenderTargets[t].destroy();e.gbufferRenderTargets.length=0;for(var n=0;n<e.outputRenderTargets.length;n++)e.outputRenderTargets[n].destroy();e.outputRenderTargets.length=0,this._destroyBloomData()}this._pipelineRenderData=null},n._ensureEnoughSize=function(e){for(var t=this._width,n=this._height,i=0;i<e.length;++i){var r=e[i].window;t=Math.max(r.width,t),n=Math.max(r.height,n)}t===this._width&&n===this._height||(this._width=t,this._height=n,this._destroyDeferredData(),this._generateDeferredRenderData())},n._generateDeferredRenderData=function(){for(var e=this,t=this.device,n=this._pipelineRenderData=new QD,i=this.pipelineSceneData,r=0;r<3;++r)n.gbufferRenderTargets.push(t.createTexture(new fr(fi.TEX2D,di.COLOR_ATTACHMENT|di.SAMPLED,ai.RGBA16F,this._width*i.shadingScale,this._height*i.shadingScale)));n.outputDepth=t.createTexture(new fr(fi.TEX2D,di.DEPTH_STENCIL_ATTACHMENT|di.SAMPLED,ai.DEPTH_STENCIL,this._width*i.shadingScale,this._height*i.shadingScale)),n.gbufferFrameBuffer=t.createFramebuffer(new Lr(this._gbufferRenderPass,n.gbufferRenderTargets,n.outputDepth)),n.outputRenderTargets.push(t.createTexture(new fr(fi.TEX2D,di.COLOR_ATTACHMENT|di.SAMPLED,ai.RGBA16F,this._width*i.shadingScale,this._height*i.shadingScale))),n.outputFrameBuffer=t.createFramebuffer(new Lr(this._lightingRenderPass,n.outputRenderTargets,null)),n.sampler=this.globalDSManager.pointSampler,this.on(dx.ATTACHMENT_SCALE_CAHNGED,(function(t){n.sampler=t<1?e.globalDSManager.pointSampler:e.globalDSManager.linearSampler,e.applyFramebufferRatio(n.gbufferFrameBuffer),e.applyFramebufferRatio(n.outputFrameBuffer)}))},t}(Fx),qD=T((jD=XD).prototype,"renderTextures",[HD,Ec,VD],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),WD=jD))||WD));function ZD(){var e=new xD;return e.initialize({flows:[]}),e}var $D=new Tn,eO=function(){var e=t.prototype;function t(){this.handle=0,this.callBack=null,this.cancelAnimate=!1,this.startTime=-1,this.isPause=!1,this._splashFinish=!1,this._loadFinish=!1,this._directCall=!1}return e.pauseRendering=function(){this.isPause=!0},e.resumeRendering=function(){this.isPause=!1},e.main=function(e){if(null!=e){if(window._CCSettings&&window._CCSettings.splashScreen){var t=this.settings=window._CCSettings.splashScreen;t.totalTime=null!=this.settings.totalTime?this.settings.totalTime:3e3,t.base64src=this.settings.base64src||"",t.effect=this.settings.effect||"FADE-INOUT",t.clearColor=this.settings.clearColor||new rr(.88,.88,.88,1),t.displayRatio=null!=this.settings.displayRatio?this.settings.displayRatio:.4,t.displayWatermark=null==this.settings.displayWatermark||this.settings.displayWatermark}else this.settings={totalTime:3e3,base64src:"",effect:"FADE-INOUT",clearColor:new rr(.88,.88,.88,1),displayRatio:.4,displayWatermark:!0};if(""===this.settings.base64src||this.settings.totalTime<=0)this.callBack&&this.callBack(),this.callBack=null,this.settings=null,this._directCall=!0;else{b.view.resizeWithBrowserSize(!0);var n=window._CCSettings.designResolution;n?b.view.setDesignResolutionSize(n.width,n.height,n.policy):b.view.setDesignResolutionSize(960,640,4),this.device=e.device,this.swapchain=e.mainWindow.swapchain,this.framebuffer=e.mainWindow.framebuffer,b.game.once(b.Game.EVENT_GAME_INITED,(function(){b.director._lateUpdate=performance.now()}),b.director),this.callBack=null,this.cancelAnimate=!1,this.startTime=-1,this.preInit(),this.logoImage=new Image,this.logoImage.onload=this.init.bind(this),this.logoImage.src=this.settings.base64src}}else B("RENDER ROOT IS NULL.")},e.setOnFinish=function(e){if(this._directCall&&e)return t._ins=void 0,void e();this.callBack=e},e._tryToStart=function(){this._splashFinish&&this._loadFinish&&this.callBack&&(this.callBack(),this.hide(),b.game.resume())},e.preInit=function(){var e=this.settings.clearColor;this.clearColors=[new rr(e.x,e.y,e.z,e.w)];var t=this.device,n=this.swapchain;this.renderArea=new Qi(0,0,n.width,n.height),this.cmdBuff=t.commandBuffer;var i=new Float32Array([.5,.5,1,0,-.5,.5,0,0,.5,-.5,1,1,-.5,-.5,0,1]),r=4*Float32Array.BYTES_PER_ELEMENT,o=4*r;this.vertexBuffers=t.createBuffer(new cr(li.VERTEX|li.TRANSFER_DST,_i.DEVICE,o,r)),this.vertexBuffers.update(i);var a=new Uint16Array([0,1,2,1,3,2]),s=Uint16Array.BYTES_PER_ELEMENT,c=6*s;this.indicesBuffers=t.createBuffer(new cr(li.INDEX|li.TRANSFER_DST,_i.DEVICE,c,s)),this.indicesBuffers.update(a);var l=[new br("a_position",ai.RG32F),new br("a_texCoord",ai.RG32F)],u=new wr(l,[this.vertexBuffers],this.indicesBuffers);this.quadAssmebler=t.createInputAssembler(u),this.projection=new kn,kn.ortho(this.projection,-1,1,-1,1,-1,1,t.capabilities.clipSpaceMinZ,t.capabilities.clipSpaceSignY,n.surfaceTransform)},e.init=function(){var e=this;this.initLogo(),this.settings.displayWatermark&&this.initWarterMark(),b.game.pause(),this.handle=requestAnimationFrame((function t(n){if(!e.cancelAnimate){var i=e.settings,r=e.device,o=e.swapchain;kn.ortho(e.projection,-1,1,-1,1,-1,1,r.capabilities.clipSpaceMinZ,r.capabilities.clipSpaceSignY,o.surfaceTransform);var a=o.width,s=o.height,c=a<s?a:s;e.startTime<0&&(e.startTime=n);var l=n-e.startTime,u=e_(tn(l/i.totalTime));"NONE"===i.effect&&(u=1);var h=e.logoTexture.width,_=e.logoTexture.height,f=c*i.displayRatio,d=f*h/_,p=f;if(o.surfaceTransform!==ri.ROTATE_90&&o.surfaceTransform!==ri.ROTATE_270||(d=f*a/s,p=f*_/h*s/a),e.logoMat.setProperty("resolution",$D.set(a,s),0),e.logoMat.setProperty("scale",$D.set(d,p),0),e.logoMat.setProperty("translate",$D.set(.5*a,.5*s),0),e.logoMat.setProperty("percent",u),e.logoMat.setProperty("u_projection",e.projection),e.logoMat.passes[0].update(),i.displayWatermark&&e.watermarkMat){var m=.5*c,v=e.watermarkTexture.width,g=m,y=m*e.watermarkTexture.height/v;o.surfaceTransform!==ri.ROTATE_90&&o.surfaceTransform!==ri.ROTATE_270||(g=.5*m,y=m*a/s*.5),e.watermarkMat.setProperty("resolution",$D.set(a,s),0),e.watermarkMat.setProperty("scale",$D.set(g,y),0),e.watermarkMat.setProperty("translate",$D.set(.5*a,.1*s),0),e.watermarkMat.setProperty("percent",u),e.watermarkMat.setProperty("u_projection",e.projection),e.watermarkMat.passes[0].update()}e.isPause||(e.frame(),l>i.totalTime&&(e.splashFinish=!0)),requestAnimationFrame(t)}}))},e.hide=function(){cancelAnimationFrame(this.handle),this.cancelAnimate=!0,setTimeout(this.destroy.bind(this))},e.initLogo=function(){var e=this.device;this.logoMat=new Ov,this.logoMat.initialize({effectName:"splash-screen"});var t=new pr;t.addressU=xi.CLAMP,t.addressV=xi.CLAMP,t.addressW=xi.CLAMP,this.sampler=e.getSampler(t),this.logoTexture=e.createTexture(new fr(fi.TEX2D,di.SAMPLED|di.TRANSFER_DST,ai.RGBA8,this.logoImage.width,this.logoImage.height));var n=this.logoMat.passes[0],i=n.getBinding("mainTexture");n.bindTexture(i,this.logoTexture),this.shader=n.getShaderVariant();var r=n.descriptorSet;r.bindSampler(i,this.sampler),r.update();var o=new nr;o.texExtent.width=this.logoImage.width,o.texExtent.height=this.logoImage.height,o.texExtent.depth=1,e.copyTexImagesToTexture([this.logoImage],this.logoTexture,[o])},e.initWarterMark=function(){var e=document.createElement("canvas");e.width=330,e.height=30,e.style.width=""+e.width,e.style.height=""+e.height;var t=e.getContext("2d");t.font="18px Arial",t.textBaseline="top",t.textAlign="left",t.fillStyle="`#424242`";var n="Powered by Cocos Creator",i=t.measureText(n);t.fillText(n,(330-i.width)/2,6);var r=new nr;r.texExtent.width=e.width,r.texExtent.height=e.height,r.texExtent.depth=1,this.watermarkTexture=this.device.createTexture(new fr(fi.TEX2D,di.SAMPLED|di.TRANSFER_DST,ai.RGBA8,e.width,e.height)),this.device.copyTexImagesToTexture([e],this.watermarkTexture,[r]),this.watermarkMat=new Ov,this.watermarkMat.initialize({effectName:"splash-screen"});var o=this.watermarkMat.passes[0],a=o.getBinding("mainTexture");o.bindTexture(a,this.watermarkTexture),o.descriptorSet.update()},e.frame=function(){var e=this.device,t=this.swapchain;e.acquire([t]);var n=this.cmdBuff,i=this.framebuffer,r=this.renderArea;r.width=t.width,r.height=t.height,n.begin(),n.beginRenderPass(i.renderPass,i,r,this.clearColors,1,0);var o=this.logoMat.passes[0],a=uv.getOrCreatePipelineState(e,o,this.shader,i.renderPass,this.quadAssmebler);if(n.bindPipelineState(a),n.bindDescriptorSet(md.MATERIAL,o.descriptorSet),n.bindInputAssembler(this.quadAssmebler),n.draw(this.quadAssmebler),this.settings.displayWatermark&&this.watermarkMat){var s=this.watermarkMat.passes[0],c=uv.getOrCreatePipelineState(e,s,this.shader,i.renderPass,this.quadAssmebler);n.bindPipelineState(c),n.bindDescriptorSet(md.MATERIAL,s.descriptorSet),n.bindInputAssembler(this.quadAssmebler),n.draw(this.quadAssmebler)}n.endRenderPass(),n.end(),e.flushCommands([n]),e.queue.submit([n]),e.present()},e.destroy=function(){this.callBack=null,this.device=null,this.swapchain=null,this.clearColors=null,this.logoImage.destroy&&this.logoImage.destroy(),this.logoImage=null,this.framebuffer=null,this.renderArea=null,this.cmdBuff=null,this.shader=null,this.logoMat.destroy(),this.logoMat=null,this.logoTexture.destroy(),this.logoTexture=null,this.quadAssmebler.destroy(),this.quadAssmebler=null,this.vertexBuffers.destroy(),this.vertexBuffers=null,this.indicesBuffers.destroy(),this.indicesBuffers=null,this.sampler=null,this.watermarkTexture&&(this.watermarkMat.destroy(),this.watermarkMat=null,this.watermarkTexture.destroy(),this.watermarkTexture=null),this.settings=null,t._ins=void 0},h(t,[{key:"splashFinish",set:function(e){this._splashFinish=e,this._tryToStart()}},{key:"loadFinish",set:function(e){this._loadFinish=e,this._tryToStart()}}],[{key:"instance",get:function(){return t._ins||(t._ins=new t),t._ins}}]),t}();eO._ins=void 0,b.internal.SplashScreen=eO;var tO={topLeft:b.v2(0,0),topRight:b.v2(0,0),top:b.v2(0,0),bottomLeft:b.v2(0,0),bottomRight:b.v2(0,0),bottom:b.v2(0,0),center:b.v2(0,0),left:b.v2(0,0),right:b.v2(0,0),width:0,height:0,init:function(e){var t=this.width=e.width,n=this.height=e.height,i=e.x,r=e.y,o=r+n,a=i+t;this.topLeft.x=i,this.topLeft.y=o,this.topRight.x=a,this.topRight.y=o,this.top.x=i+t/2,this.top.y=o,this.bottomLeft.x=i,this.bottomLeft.y=r,this.bottomRight.x=a,this.bottomRight.y=r,this.bottom.x=i+t/2,this.bottom.y=r,this.center.x=i+t/2,this.center.y=r+n/2,this.left.x=i,this.left.y=r+n/2,this.right.x=a,this.right.y=r+n/2}};b.visibleRect=tO;var nO=e("Event",function(){function e(e,t){this.type=void 0,this.bubbles=void 0,this.target=null,this.currentTarget=null,this.eventPhase=0,this.propagationStopped=!1,this.propagationImmediateStopped=!1,this.type=e,this.bubbles=!!t}var t=e.prototype;return t.unuse=function(){this.type=e.NO_TYPE,this.target=null,this.currentTarget=null,this.eventPhase=e.NONE,this.propagationStopped=!1,this.propagationImmediateStopped=!1},t.reuse=function(e,t){this.type=e,this.bubbles=t||!1},t.isStopped=function(){return this.propagationStopped||this.propagationImmediateStopped},t.getCurrentTarget=function(){return this.currentTarget},t.getType=function(){return this.type},e}());nO.NO_TYPE="no_type",nO.TOUCH="touch",nO.MOUSE="mouse",nO.KEYBOARD="keyboard",nO.ACCELERATION="acceleration",nO.NONE=0,nO.CAPTURING_PHASE=1,nO.AT_TARGET=2,nO.BUBBLING_PHASE=3,b.Event=nO;var iO=e("EventAcceleration",function(e){function t(t,n){var i;return(i=e.call(this,kA.DEVICEMOTION,n)||this).acc=void 0,i.acc=t,i}return f(t,e),t}(nO));nO.EventAcceleration=iO;var rO=e("EventKeyboard",function(e){function t(t,n,i){var r;return"boolean"==typeof n&&(n=n?kA.KEY_DOWN:kA.KEY_UP),(r=e.call(this,n,i)||this).keyCode=void 0,r.rawEvent=void 0,r._isPressed=void 0,r._isPressed=n!==kA.KEY_UP,"number"==typeof t?r.keyCode=t:(r.keyCode=t.keyCode,r.rawEvent=t),r}return f(t,e),h(t,[{key:"isPressed",get:function(){return this._isPressed}}]),t}(nO));nO.EventKeyboard=rO;var oO=e("EventMouse",function(e){function t(n,i,r){var o;return(o=e.call(this,n,i)||this).movementX=0,o.movementY=0,o.preventSwallow=!1,o._eventType=void 0,o._button=t.BUTTON_MISSING,o._x=0,o._y=0,o._prevX=0,o._prevY=0,o._scrollX=0,o._scrollY=0,o._eventType=n,r&&(o._prevX=r.x,o._prevY=r.y),o}f(t,e);var n=t.prototype;return n.setScrollData=function(e,t){this._scrollX=e,this._scrollY=t},n.getScrollX=function(){return this._scrollX},n.getScrollY=function(){return this._scrollY},n.setLocation=function(e,t){this._x=e,this._y=t},n.getLocation=function(e){return e||(e=new Tn),Tn.set(e,this._x,this._y),e},n.getLocationInView=function(e){return e||(e=new Tn),Tn.set(e,this._x,b.view._designResolutionSize.height-this._y),e},n.getUILocation=function(e){return e||(e=new Tn),Tn.set(e,this._x,this._y),b.view._convertToUISpace(e),e},n.getPreviousLocation=function(e){return e||(e=new Tn),Tn.set(e,this._prevX,this._prevY),e},n.getUIPreviousLocation=function(e){return e||(e=new Tn),Tn.set(e,this._prevX,this._prevY),b.view._convertToUISpace(e),e},n.getDelta=function(e){return e||(e=new Tn),Tn.set(e,this._x-this._prevX,this._y-this._prevY),e},n.getDeltaX=function(){return this._x-this._prevX},n.getDeltaY=function(){return this._y-this._prevY},n.getUIDelta=function(e){return e||(e=new Tn),Tn.set(e,(this._x-this._prevX)/b.view.getScaleX(),(this._y-this._prevY)/b.view.getScaleY()),e},n.getUIDeltaX=function(){return(this._x-this._prevX)/b.view.getScaleX()},n.getUIDeltaY=function(){return(this._y-this._prevY)/b.view.getScaleY()},n.setButton=function(e){this._button=e},n.getButton=function(){return this._button},n.getLocationX=function(){return this._x},n.getLocationY=function(){return this._y},n.getUILocationX=function(){var e=b.view.getViewportRect();return(this._x-e.x)/b.view.getScaleX()},n.getUILocationY=function(){var e=b.view.getViewportRect();return(this._y-e.y)/b.view.getScaleY()},h(t,[{key:"eventType",get:function(){return this._eventType}}]),t}(nO));oO.BUTTON_MISSING=-1,oO.BUTTON_LEFT=0,oO.BUTTON_RIGHT=2,oO.BUTTON_MIDDLE=1,oO.BUTTON_4=3,oO.BUTTON_5=4,oO.BUTTON_6=5,oO.BUTTON_7=6,oO.BUTTON_8=7,nO.EventMouse=oO;var aO=new Tn,sO=e("EventTouch",function(e){function t(t,n,i,r){var o;return void 0===r&&(r=[]),(o=e.call(this,i,n)||this).touch=null,o.simulate=!1,o.preventSwallow=!1,o._eventCode=void 0,o._touches=void 0,o._allTouches=void 0,o._eventCode=i,o._touches=t||[],o._allTouches=r,o}f(t,e);var n=t.prototype;return n.getEventCode=function(){return this._eventCode},n.getTouches=function(){return this._touches},n.getAllTouches=function(){return this._allTouches},n.setLocation=function(e,t){this.touch&&this.touch.setTouchInfo(this.touch.getID(),e,t)},n.getLocation=function(e){return this.touch?this.touch.getLocation(e):new Tn},n.getUILocation=function(e){return this.touch?this.touch.getUILocation(e):new Tn},n.getLocationInView=function(e){return this.touch?this.touch.getLocationInView(e):new Tn},n.getPreviousLocation=function(e){return this.touch?this.touch.getPreviousLocation(e):new Tn},n.getStartLocation=function(e){return this.touch?this.touch.getStartLocation(e):new Tn},n.getUIStartLocation=function(e){return this.touch?this.touch.getUIStartLocation(e):new Tn},n.getID=function(){return this.touch?this.touch.getID():null},n.getDelta=function(e){return this.touch?this.touch.getDelta(e):new Tn},n.getUIDelta=function(e){return this.touch?this.touch.getUIDelta(e):new Tn},n.getDeltaX=function(){return this.touch?this.touch.getDelta(aO).x:0},n.getDeltaY=function(){return this.touch?this.touch.getDelta(aO).y:0},n.getLocationX=function(){return this.touch?this.touch.getLocationX():0},n.getLocationY=function(){return this.touch?this.touch.getLocationY():0},t}(nO));sO.MAX_TOUCHES=5,nO.EventTouch=sO;var cO,lO=e("Acceleration",(function(e,t,n,i){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),this.x=void 0,this.y=void 0,this.z=void 0,this.timestamp=void 0,this.x=e,this.y=t,this.z=n,this.timestamp=i}));!function(e){e[e.NONE=0]="NONE",e[e.MOBILE_BACK=6]="MOBILE_BACK",e[e.BACKSPACE=8]="BACKSPACE",e[e.TAB=9]="TAB",e[e.ENTER=13]="ENTER",e[e.SHIFT_LEFT=16]="SHIFT_LEFT",e[e.CTRL_LEFT=17]="CTRL_LEFT",e[e.ALT_LEFT=18]="ALT_LEFT",e[e.PAUSE=19]="PAUSE",e[e.CAPS_LOCK=20]="CAPS_LOCK",e[e.ESCAPE=27]="ESCAPE",e[e.SPACE=32]="SPACE",e[e.PAGE_UP=33]="PAGE_UP",e[e.PAGE_DOWN=34]="PAGE_DOWN",e[e.END=35]="END",e[e.HOME=36]="HOME",e[e.ARROW_LEFT=37]="ARROW_LEFT",e[e.ARROW_UP=38]="ARROW_UP",e[e.ARROW_RIGHT=39]="ARROW_RIGHT",e[e.ARROW_DOWN=40]="ARROW_DOWN",e[e.INSERT=45]="INSERT",e[e.DELETE=46]="DELETE",e[e.DIGIT_0=48]="DIGIT_0",e[e.DIGIT_1=49]="DIGIT_1",e[e.DIGIT_2=50]="DIGIT_2",e[e.DIGIT_3=51]="DIGIT_3",e[e.DIGIT_4=52]="DIGIT_4",e[e.DIGIT_5=53]="DIGIT_5",e[e.DIGIT_6=54]="DIGIT_6",e[e.DIGIT_7=55]="DIGIT_7",e[e.DIGIT_8=56]="DIGIT_8",e[e.DIGIT_9=57]="DIGIT_9",e[e.KEY_A=65]="KEY_A",e[e.KEY_B=66]="KEY_B",e[e.KEY_C=67]="KEY_C",e[e.KEY_D=68]="KEY_D",e[e.KEY_E=69]="KEY_E",e[e.KEY_F=70]="KEY_F",e[e.KEY_G=71]="KEY_G",e[e.KEY_H=72]="KEY_H",e[e.KEY_I=73]="KEY_I",e[e.KEY_J=74]="KEY_J",e[e.KEY_K=75]="KEY_K",e[e.KEY_L=76]="KEY_L",e[e.KEY_M=77]="KEY_M",e[e.KEY_N=78]="KEY_N",e[e.KEY_O=79]="KEY_O",e[e.KEY_P=80]="KEY_P",e[e.KEY_Q=81]="KEY_Q",e[e.KEY_R=82]="KEY_R",e[e.KEY_S=83]="KEY_S",e[e.KEY_T=84]="KEY_T",e[e.KEY_U=85]="KEY_U",e[e.KEY_V=86]="KEY_V",e[e.KEY_W=87]="KEY_W",e[e.KEY_X=88]="KEY_X",e[e.KEY_Y=89]="KEY_Y",e[e.KEY_Z=90]="KEY_Z",e[e.NUM_0=96]="NUM_0",e[e.NUM_1=97]="NUM_1",e[e.NUM_2=98]="NUM_2",e[e.NUM_3=99]="NUM_3",e[e.NUM_4=100]="NUM_4",e[e.NUM_5=101]="NUM_5",e[e.NUM_6=102]="NUM_6",e[e.NUM_7=103]="NUM_7",e[e.NUM_8=104]="NUM_8",e[e.NUM_9=105]="NUM_9",e[e.NUM_MULTIPLY=106]="NUM_MULTIPLY",e[e.NUM_PLUS=107]="NUM_PLUS",e[e.NUM_SUBTRACT=109]="NUM_SUBTRACT",e[e.NUM_DECIMAL=110]="NUM_DECIMAL",e[e.NUM_DIVIDE=111]="NUM_DIVIDE",e[e.F1=112]="F1",e[e.F2=113]="F2",e[e.F3=114]="F3",e[e.F4=115]="F4",e[e.F5=116]="F5",e[e.F6=117]="F6",e[e.F7=118]="F7",e[e.F8=119]="F8",e[e.F9=120]="F9",e[e.F10=121]="F10",e[e.F11=122]="F11",e[e.F12=123]="F12",e[e.NUM_LOCK=144]="NUM_LOCK",e[e.SCROLL_LOCK=145]="SCROLL_LOCK",e[e.SEMICOLON=186]="SEMICOLON",e[e.EQUAL=187]="EQUAL",e[e.COMMA=188]="COMMA",e[e.DASH=189]="DASH",e[e.PERIOD=190]="PERIOD",e[e.SLASH=191]="SLASH",e[e.BACK_QUOTE=192]="BACK_QUOTE",e[e.BRACKET_LEFT=219]="BRACKET_LEFT",e[e.BACKSLASH=220]="BACKSLASH",e[e.BRACKET_RIGHT=221]="BRACKET_RIGHT",e[e.QUOTE=222]="QUOTE",e[e.SHIFT_RIGHT=2e3]="SHIFT_RIGHT",e[e.CTRL_RIGHT=2001]="CTRL_RIGHT",e[e.ALT_RIGHT=2002]="ALT_RIGHT",e[e.NUM_ENTER=2003]="NUM_ENTER"}(cO||(cO=e("KeyCode",{})));var uO=new Tn,hO=e("Touch",function(){function e(e,t,n){void 0===n&&(n=0),this._point=new Tn,this._prevPoint=new Tn,this._lastModified=0,this._id=0,this._startPoint=new Tn,this._startPointCaptured=!1,this.setTouchInfo(n,e,t)}var t=e.prototype;return t.getLocation=function(e){return e||(e=new Tn),e.set(this._point.x,this._point.y),e},t.getLocationX=function(){return this._point.x},t.getLocationY=function(){return this._point.y},t.getUILocation=function(e){return e||(e=new Tn),e.set(this._point.x,this._point.y),b.view._convertToUISpace(e),e},t.getUILocationX=function(){var e=b.view.getViewportRect();return(this._point.x-e.x)/b.view.getScaleX()},t.getUILocationY=function(){var e=b.view.getViewportRect();return(this._point.y-e.y)/b.view.getScaleY()},t.getPreviousLocation=function(e){return e||(e=new Tn),e.set(this._prevPoint.x,this._prevPoint.y),e},t.getUIPreviousLocation=function(e){return e||(e=new Tn),e.set(this._prevPoint.x,this._prevPoint.y),b.view._convertToUISpace(e),e},t.getStartLocation=function(e){return e||(e=new Tn),e.set(this._startPoint.x,this._startPoint.y),e},t.getUIStartLocation=function(e){return e||(e=new Tn),e.set(this._startPoint.x,this._startPoint.y),b.view._convertToUISpace(e),e},t.getDelta=function(e){return e||(e=new Tn),e.set(this._point),e.subtract(this._prevPoint),e},t.getUIDelta=function(e){return e||(e=new Tn),uO.set(this._point),uO.subtract(this._prevPoint),e.set(b.view.getScaleX(),b.view.getScaleY()),Tn.divide(e,uO,e),e},t.getLocationInView=function(e){return e||(e=new Tn),e.set(this._point.x,b.view._designResolutionSize.height-this._point.y),e},t.getPreviousLocationInView=function(e){return e||(e=new Tn),e.set(this._prevPoint.x,b.view._designResolutionSize.height-this._prevPoint.y),e},t.getStartLocationInView=function(e){return e||(e=new Tn),e.set(this._startPoint.x,b.view._designResolutionSize.height-this._startPoint.y),e},t.getID=function(){return this._id},t.setTouchInfo=function(e,t,n){void 0===e&&(e=0),this._prevPoint=this._point,this._point=new Tn(t||0,n||0),this._id=e,this._startPointCaptured||(this._startPoint=new Tn(this._point),this._startPointCaptured=!0)},t.setPoint=function(e,t){"object"==typeof e?(this._point.x=e.x,this._point.y=e.y):(this._point.x=e||0,this._point.y=t||0),this._lastModified=b.game.frameStartTime},t.setPrevPoint=function(e,t){this._prevPoint="object"==typeof e?new Tn(e.x,e.y):new Tn(e||0,t||0),this._lastModified=b.game.frameStartTime},h(e,[{key:"lastModified",get:function(){return this._lastModified}}]),e}());b.Touch=hO;var _O,fO,dO=function(){function e(){this._intervalInMileSeconds=200,this._accelTimer=0,this._eventTarget=new Jl,this._deviceEventName=void 0,this._globalEventClass=void 0,this._didAccelerateFunc=void 0,this._globalEventClass=window.DeviceMotionEvent||window.DeviceOrientationEvent,nu.browserType===jl.MOBILE_QQ&&(this._globalEventClass=window.DeviceOrientationEvent),this._deviceEventName=this._globalEventClass===window.DeviceMotionEvent?"devicemotion":"deviceorientation",this._didAccelerateFunc=this._didAccelerate.bind(this)}var t=e.prototype;return t._registerEvent=function(){this._accelTimer=performance.now(),window.addEventListener(this._deviceEventName,this._didAccelerateFunc,!1)},t._unregisterEvent=function(){this._accelTimer=0,window.removeEventListener(this._deviceEventName,this._didAccelerateFunc,!1)},t._didAccelerate=function(e){var t=performance.now();if(!(t-this._accelTimer<this._intervalInMileSeconds)){this._accelTimer=t;var n=0,i=0,r=0;if(this._globalEventClass===window.DeviceMotionEvent){var o=e.accelerationIncludingGravity;n=.1*((null==o?void 0:o.x)||0),i=.1*((null==o?void 0:o.y)||0),r=.1*((null==o?void 0:o.z)||0)}else{var a=e;n=(a.gamma||0)/90*.981,i=-(a.beta||0)/90*.981,r=(a.alpha||0)/90*.981}if(Xu.isFrameRotated){var s=n;n=-i,i=s}var c=n;90===window.orientation?(n=-i,i=c):-90===window.orientation?(n=i,i=-c):180===window.orientation&&(n=-n,i=-i),nu.os===Yl.ANDROID&&nu.browserType!==jl.MOBILE_QQ&&(n=-n,i=-i);var l=performance.now(),u=new lO(n,i,r,l),h=new iO(u);this._eventTarget.emit(GA.DEVICEMOTION,h)}},t.start=function(){var e=this;window.DeviceMotionEvent&&"function"==typeof DeviceMotionEvent.requestPermission?DeviceMotionEvent.requestPermission().then((function(t){"granted"===t&&e._registerEvent()})).catch((function(){})):this._registerEvent()},t.stop=function(){this._unregisterEvent()},t.setInterval=function(e){this._intervalInMileSeconds=e},t.on=function(e,t,n){this._eventTarget.on(e,t,n)},e}(),pO={Backspace:cO.BACKSPACE,Tab:cO.TAB,Enter:cO.ENTER,ShiftLeft:cO.SHIFT_LEFT,ControlLeft:cO.CTRL_LEFT,AltLeft:cO.ALT_LEFT,ShiftRight:cO.SHIFT_RIGHT,ControlRight:cO.CTRL_RIGHT,AltRight:cO.ALT_RIGHT,Pause:cO.PAUSE,CapsLock:cO.CAPS_LOCK,Escape:cO.ESCAPE,Space:cO.SPACE,PageUp:cO.PAGE_UP,PageDown:cO.PAGE_DOWN,End:cO.END,Home:cO.HOME,ArrowLeft:cO.ARROW_LEFT,ArrowUp:cO.ARROW_UP,ArrowRight:cO.ARROW_RIGHT,ArrowDown:cO.ARROW_DOWN,Insert:cO.INSERT,Delete:cO.DELETE,Digit0:cO.DIGIT_0,Digit1:cO.DIGIT_1,Digit2:cO.DIGIT_2,Digit3:cO.DIGIT_3,Digit4:cO.DIGIT_4,Digit5:cO.DIGIT_5,Digit6:cO.DIGIT_6,Digit7:cO.DIGIT_7,Digit8:cO.DIGIT_8,Digit9:cO.DIGIT_9,KeyA:cO.KEY_A,KeyB:cO.KEY_B,KeyC:cO.KEY_C,KeyD:cO.KEY_D,KeyE:cO.KEY_E,KeyF:cO.KEY_F,KeyG:cO.KEY_G,KeyH:cO.KEY_H,KeyI:cO.KEY_I,KeyJ:cO.KEY_J,KeyK:cO.KEY_K,KeyL:cO.KEY_L,KeyM:cO.KEY_M,KeyN:cO.KEY_N,KeyO:cO.KEY_O,KeyP:cO.KEY_P,KeyQ:cO.KEY_Q,KeyR:cO.KEY_R,KeyS:cO.KEY_S,KeyT:cO.KEY_T,KeyU:cO.KEY_U,KeyV:cO.KEY_V,KeyW:cO.KEY_W,KeyX:cO.KEY_X,KeyY:cO.KEY_Y,KeyZ:cO.KEY_Z,Numpad0:cO.NUM_0,Numpad1:cO.NUM_1,Numpad2:cO.NUM_2,Numpad3:cO.NUM_3,Numpad4:cO.NUM_4,Numpad5:cO.NUM_5,Numpad6:cO.NUM_6,Numpad7:cO.NUM_7,Numpad8:cO.NUM_8,Numpad9:cO.NUM_9,NumpadMultiply:cO.NUM_MULTIPLY,NumpadAdd:cO.NUM_PLUS,NumpadSubtract:cO.NUM_SUBTRACT,NumpadDecimal:cO.NUM_DECIMAL,NumpadDivide:cO.NUM_DIVIDE,NumpadEnter:cO.NUM_ENTER,F1:cO.F1,F2:cO.F2,F3:cO.F3,F4:cO.F4,F5:cO.F5,F6:cO.F6,F7:cO.F7,F8:cO.F8,F9:cO.F9,F10:cO.F10,F11:cO.F11,F12:cO.F12,NumLock:cO.NUM_LOCK,ScrollLock:cO.SCROLL_LOCK,Semicolon:cO.SEMICOLON,Equal:cO.EQUAL,Comma:cO.COMMA,Minus:cO.DASH,Period:cO.PERIOD,Slash:cO.SLASH,Backquote:cO.BACK_QUOTE,BracketLeft:cO.BRACKET_LEFT,Backslash:cO.BACKSLASH,BracketRight:cO.BRACKET_RIGHT,Quote:cO.QUOTE},mO=function(){function e(){this._eventTarget=new Jl,this._registerEvent()}var t=e.prototype;return t._registerEvent=function(){var e=this,t=document.getElementById("GameCanvas");null==t||t.addEventListener("keydown",(function(t){if(t.stopPropagation(),t.preventDefault(),t.repeat){var n=e._getInputEvent(t,GA.KEY_PRESSING);e._eventTarget.emit(GA.KEY_PRESSING,n)}else{var i=e._getInputEvent(t,GA.KEY_DOWN);e._eventTarget.emit(GA.KEY_DOWN,i)}})),null==t||t.addEventListener("keyup",(function(t){var n=e._getInputEvent(t,GA.KEY_UP);t.stopPropagation(),t.preventDefault(),e._eventTarget.emit(GA.KEY_UP,n)}))},t._getInputEvent=function(e,t){var n,i=(n=e.code,pO[n]||cO.NONE);return new rO(i,t)},t.on=function(e,t,n){this._eventTarget.on(e,t,n)},e}(),vO=function(){function e(){this._canvas=void 0,this._eventTarget=new Jl,this._pointLocked=!1,this._isPressed=!1,this._preMousePos=new Tn,nu.hasFeature(Ql.EVENT_MOUSE)&&(this._canvas=document.getElementById("GameCanvas"),this._canvas||console.warn("failed to access canvas"),this._registerEvent())}var t=e.prototype;return t._getCanvasRect=function(){var e=this._canvas,t=null==e?void 0:e.getBoundingClientRect();return t?new Xn(t.x,t.y,t.width,t.height):new Xn(0,0,0,0)},t._getLocation=function(e){var t=this._getCanvasRect(),n=Xu.devicePixelRatio,i=this._pointLocked?this._preMousePos.x/n+e.movementX:e.clientX-t.x,r=this._pointLocked?this._preMousePos.y/n-e.movementY:t.y+t.height-e.clientY;return new Tn(i*=n,r*=n)},t._registerEvent=function(){var e,t,n,i,r=this;window.addEventListener("mousedown",(function(){r._isPressed=!0})),null===(e=this._canvas)||void 0===e||e.addEventListener("mousedown",this._createCallback(GA.MOUSE_DOWN)),null===(t=this._canvas)||void 0===t||t.addEventListener("mousemove",this._createCallback(GA.MOUSE_MOVE));var o=this._createCallback(GA.MOUSE_UP);window.addEventListener("mouseup",o),null===(n=this._canvas)||void 0===n||n.addEventListener("mouseup",o),null===(i=this._canvas)||void 0===i||i.addEventListener("wheel",this._handleMouseWheel.bind(this)),this._registerPointerLockEvent()},t._registerPointerLockEvent=function(){var e=this,t=function(){var t=e._canvas;document.pointerLockElement===t||document.mozPointerLockElement===t?e._pointLocked=!0:e._pointLocked=!1};"onpointerlockchange"in document?document.addEventListener("pointerlockchange",t,!1):"onmozpointerlockchange"in document&&document.addEventListener("mozpointerlockchange",t,!1)},t._createCallback=function(e){var t=this;return function(n){var i,r=t._getLocation(n),o=n.button;switch(e){case GA.MOUSE_DOWN:null===(i=t._canvas)||void 0===i||i.focus(),t._isPressed=!0;break;case GA.MOUSE_UP:t._isPressed=!1;break;case GA.MOUSE_MOVE:t._isPressed||(o=oO.BUTTON_MISSING)}var a=new oO(e,!1,t._preMousePos);a.setLocation(r.x,r.y),a.setButton(o),a.movementX=n.movementX,a.movementY=n.movementY,t._preMousePos.set(r.x,r.y),n.stopPropagation(),n.target===t._canvas&&n.preventDefault(),t._eventTarget.emit(e,a)}},t._handleMouseWheel=function(e){var t=GA.MOUSE_WHEEL,n=this._getLocation(e),i=e.button,r=new oO(t,!1,this._preMousePos);r.setLocation(n.x,n.y),r.setButton(i),r.movementX=e.movementX,r.movementY=e.movementY,r.setScrollData(5*e.deltaX,5*-e.deltaY),this._preMousePos.set(n.x,n.y),e.stopPropagation(),e.target===this._canvas&&e.preventDefault(),this._eventTarget.emit(t,r)},t.on=function(e,t,n){this._eventTarget.on(e,t,n)},e}(),gO=new Tn,yO=new(function(){function e(){this._touchMap=void 0,this._maxTouches=8,this._touchMap=new Map}var t=e.prototype;return t._cloneTouch=function(e){var t=e.getID();e.getStartLocation(gO);var n=new hO(gO.x,gO.y,t);return e.getLocation(gO),n.setPoint(gO.x,gO.y),e.getPreviousLocation(gO),n.setPrevPoint(gO),n},t._createTouch=function(e,t,n){if(this._touchMap.has(e))console.log("Cannot create the same touch object.");else{if(!this._checkTouchMapSizeMoreThanMax(e)){var i=new hO(t,n,e);return this._touchMap.set(e,i),this._updateTouch(i,t,n),this._cloneTouch(i)}console.log("The touches is more than MAX_TOUCHES.")}},t.releaseTouch=function(e){this._touchMap.has(e)&&this._touchMap.delete(e)},t.getTouch=function(e,t,n){var i=this._touchMap.get(e);return i?this._updateTouch(i,t,n):i=this._createTouch(e,t,n),i?this._cloneTouch(i):void 0},t.getAllTouches=function(){var e=this,t=[];return this._touchMap.forEach((function(n){if(n){var i=e._cloneTouch(n);t.push(i)}})),t},t._updateTouch=function(e,t,n){e.getLocation(gO),e.setPrevPoint(gO),e.setPoint(t,n)},t._checkTouchMapSizeMoreThanMax=function(e){var t=this;if(this._touchMap.has(e))return!1;var n=nt.ENABLE_MULTI_TOUCH?this._maxTouches:1;if(this._touchMap.size<n)return!1;var i=performance.now();return this._touchMap.forEach((function(e){i-e.lastModified>nt.TOUCH_TIMEOUT&&(console.log("The touches is more than MAX_TOUCHES, release touch id "+e.getID()+"."),t.releaseTouch(e.getID()))})),n>=this._touchMap.size},e}()),xO=function(){function e(){this._canvas=void 0,this._eventTarget=new Jl,nu.hasFeature(Ql.INPUT_TOUCH)&&(this._canvas=document.getElementById("GameCanvas"),this._canvas||console.warn("failed to access canvas"),this._registerEvent())}var t=e.prototype;return t._registerEvent=function(){var e,t,n,i;null===(e=this._canvas)||void 0===e||e.addEventListener("touchstart",this._createCallback(GA.TOUCH_START)),null===(t=this._canvas)||void 0===t||t.addEventListener("touchmove",this._createCallback(GA.TOUCH_MOVE)),null===(n=this._canvas)||void 0===n||n.addEventListener("touchend",this._createCallback(GA.TOUCH_END)),null===(i=this._canvas)||void 0===i||i.addEventListener("touchcancel",this._createCallback(GA.TOUCH_CANCEL))},t._createCallback=function(e){var t=this;return function(n){for(var i,r=t._getCanvasRect(),o=[],a=n.changedTouches.length,s=0;s<a;++s){var c=n.changedTouches[s],l=c.identifier;if(null!==l){var u=t._getLocation(c,r),h=yO.getTouch(l,u.x,u.y);h&&(e!==GA.TOUCH_END&&e!==GA.TOUCH_CANCEL||yO.releaseTouch(l),o.push(h))}}if(n.stopPropagation(),n.target===t._canvas&&n.preventDefault(),e===GA.TOUCH_START&&(null===(i=t._canvas)||void 0===i||i.focus()),o.length>0){var _=new sO(o,!1,e,nt.ENABLE_MULTI_TOUCH?yO.getAllTouches():o);t._eventTarget.emit(e,_)}}},t._getCanvasRect=function(){var e=this._canvas,t=null==e?void 0:e.getBoundingClientRect();return t?new Xn(t.x,t.y,t.width,t.height):new Xn(0,0,0,0)},t._getLocation=function(e,t){var n=e.clientX-t.x,i=t.y+t.height-e.clientY;if(Xu.isFrameRotated){var r=n;n=t.height-i,i=r}var o=Xu.devicePixelRatio;return new Tn(n*=o,i*=o)},t.on=function(e,t,n){this._eventTarget.on(e,t,n)},e}();!function(e){e[e.GLOBAL=0]="GLOBAL",e[e.UI=1]="UI"}(fO||(fO={}));var SO=function(){function e(e){this.priority=fO.GLOBAL,this._inputEventTarget=void 0,this._inputEventTarget=e}return e.prototype.dispatchEvent=function(e){return this._inputEventTarget.emit(e.type,e),!0},e}(),EO=((_O={})[GA.MOUSE_DOWN]=GA.TOUCH_START,_O[GA.MOUSE_MOVE]=GA.TOUCH_MOVE,_O[GA.MOUSE_UP]=GA.TOUCH_END,_O),TO=e("Input",function(){function e(){this._dispatchImmediately=!0,this._eventTarget=new Jl,this._touchInput=new xO,this._mouseInput=new vO,this._keyboardInput=new mO,this._accelerometerInput=new dO,this._eventTouchList=[],this._eventMouseList=[],this._eventKeyboardList=[],this._eventAccelerationList=[],this._needSimulateTouchMoveEvent=!1,this._inputEventDispatcher=void 0,this._eventDispatcherList=[],this._registerEvent(),this._inputEventDispatcher=new SO(this._eventTarget),this._registerEventDispatcher(this._inputEventDispatcher)}var t=e.prototype;return t.on=function(e,t,n){return this._eventTarget.on(e,t,n),t},t.once=function(e,t,n){return this._eventTarget.once(e,t,n),t},t.off=function(e,t,n){this._eventTarget.off(e,t,n)},t.setAccelerometerEnabled=function(e){e?this._accelerometerInput.start():this._accelerometerInput.stop()},t.setAccelerometerInterval=function(e){this._accelerometerInput.setInterval(e)},t._simulateEventTouch=function(e){var t=EO[e.type],n=yO.getTouch(0,e.getLocationX(),e.getLocationY());if(n){var i=[n],r=new sO(i,!1,t,i);t===GA.TOUCH_END&&yO.releaseTouch(0),this._dispatchOrPushEventTouch(r,this._eventTouchList)}},t._registerEventDispatcher=function(e){this._eventDispatcherList.push(e),this._eventDispatcherList.sort((function(e,t){return t.priority-e.priority}))},t._emitEvent=function(e){for(var t=this._eventDispatcherList.length,n=0;n<t&&this._eventDispatcherList[n].dispatchEvent(e);++n);},t._registerEvent=function(){var e=this;if(Qu.hasFeature(Qu.Feature.INPUT_TOUCH)){var t=this._eventTouchList;this._touchInput.on(GA.TOUCH_START,(function(n){e._dispatchOrPushEventTouch(n,t)})),this._touchInput.on(GA.TOUCH_MOVE,(function(n){e._dispatchOrPushEventTouch(n,t)})),this._touchInput.on(GA.TOUCH_END,(function(n){e._dispatchOrPushEventTouch(n,t)})),this._touchInput.on(GA.TOUCH_CANCEL,(function(n){e._dispatchOrPushEventTouch(n,t)}))}if(Qu.hasFeature(Qu.Feature.EVENT_MOUSE)){var n=this._eventMouseList;this._mouseInput.on(GA.MOUSE_DOWN,(function(t){e._needSimulateTouchMoveEvent=!0,e._simulateEventTouch(t),e._dispatchOrPushEvent(t,n)})),this._mouseInput.on(GA.MOUSE_MOVE,(function(t){e._needSimulateTouchMoveEvent&&e._simulateEventTouch(t),e._dispatchOrPushEvent(t,n)})),this._mouseInput.on(GA.MOUSE_UP,(function(t){e._needSimulateTouchMoveEvent=!1,e._simulateEventTouch(t),e._dispatchOrPushEvent(t,n)})),this._mouseInput.on(GA.MOUSE_WHEEL,(function(t){e._dispatchOrPushEvent(t,n)}))}if(Qu.hasFeature(Qu.Feature.EVENT_KEYBOARD)){var i=this._eventKeyboardList;this._keyboardInput.on(GA.KEY_DOWN,(function(t){e._dispatchOrPushEvent(t,i)})),this._keyboardInput.on(GA.KEY_PRESSING,(function(t){e._dispatchOrPushEvent(t,i)})),this._keyboardInput.on(GA.KEY_UP,(function(t){e._dispatchOrPushEvent(t,i)}))}if(Qu.hasFeature(Qu.Feature.EVENT_ACCELEROMETER)){var r=this._eventAccelerationList;this._accelerometerInput.on(GA.DEVICEMOTION,(function(t){e._dispatchOrPushEvent(t,r)}))}},t._clearEvents=function(){this._eventMouseList.length=0,this._eventTouchList.length=0,this._eventKeyboardList.length=0,this._eventAccelerationList.length=0},t._dispatchOrPushEvent=function(e,t){this._dispatchImmediately?this._emitEvent(e):t.push(e)},t._dispatchOrPushEventTouch=function(e,t){if(this._dispatchImmediately)for(var n=e.getTouches(),i=n.length,r=0;r<i;++r)e.touch=n[r],e.propagationStopped=e.propagationImmediateStopped=!1,this._emitEvent(e);else t.push(e)},t._frameDispatchEvents=function(){for(var e=this._eventMouseList,t=0,n=e.length;t<n;++t){var i=e[t];this._emitEvent(i)}for(var r=this._eventTouchList,o=0,a=r.length;o<a;++o)for(var s=r[o],c=s.getTouches(),l=c.length,u=0;u<l;++u)s.touch=c[u],s.propagationStopped=s.propagationImmediateStopped=!1,this._emitEvent(s);for(var h=this._eventKeyboardList,_=0,f=h.length;_<f;++_){var d=h[_];this._emitEvent(d)}for(var p=this._eventAccelerationList,m=0,v=p.length;m<v;++m){var g=p[m];this._emitEvent(g)}this._clearEvents()},e}());TO.EventType=GA;var CO=e("input",new TO),bO=e("SystemEvent",function(e){function t(){var t;return t=e.call(this)||this,CO.on(GA.MOUSE_DOWN,(function(e){t.emit(kA.MOUSE_DOWN,e)})),CO.on(GA.MOUSE_MOVE,(function(e){t.emit(kA.MOUSE_MOVE,e)})),CO.on(GA.MOUSE_UP,(function(e){t.emit(kA.MOUSE_UP,e)})),CO.on(GA.MOUSE_WHEEL,(function(e){t.emit(kA.MOUSE_WHEEL,e)})),CO.on(GA.TOUCH_START,(function(e){t.emit(kA.TOUCH_START,e.touch,e)})),CO.on(GA.TOUCH_MOVE,(function(e){t.emit(kA.TOUCH_MOVE,e.touch,e)})),CO.on(GA.TOUCH_END,(function(e){t.emit(kA.TOUCH_END,e.touch,e)})),CO.on(GA.TOUCH_CANCEL,(function(e){t.emit(kA.TOUCH_CANCEL,e.touch,e)})),CO.on(GA.KEY_DOWN,(function(e){t.emit(kA.KEY_DOWN,e)})),CO.on(GA.KEY_PRESSING,(function(e){t.emit(kA.KEY_DOWN,e)})),CO.on(GA.KEY_UP,(function(e){t.emit(kA.KEY_UP,e)})),CO.on(GA.DEVICEMOTION,(function(e){t.emit(kA.DEVICEMOTION,e)})),t}f(t,e);var n=t.prototype;return n.setAccelerometerEnabled=function(e){CO.setAccelerometerEnabled(e)},n.setAccelerometerInterval=function(e){CO.setAccelerometerInterval(e)},n.on=function(t,n,i,r){return e.prototype.on.call(this,t,n,i,r),n},n.off=function(t,n,i){e.prototype.off.call(this,t,n,i)},t}(Jl));bO.EventType=kA,b.SystemEvent=bO;var AO=e("systemEvent",new bO);b.systemEvent=AO;var wO=e("Game",function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).frame=null,t.container=null,t.canvas=null,t.renderType=-1,t.eventTargetOn=e.prototype.on,t.eventTargetOnce=e.prototype.once,t.config={},t.onStart=null,t.frameTime=1e3/60,t.collisionMatrix=[],t.groupList=[],t._persistRootNodes={},t._gfxDevice=null,t._swapchain=null,t._configLoaded=!1,t._isCloning=!1,t._inited=!1,t._engineInited=!1,t._rendererInitialized=!1,t._paused=!0,t._frameRate=60,t._intervalId=0,t._initTime=0,t._startTime=0,t._deltaTime=0,t._onEngineInitedCallback=[],t}f(t,e);var n=t.prototype;return n.setFrameRate=function(e){this.frameRate=e},n.getFrameRate=function(){return this.frameRate},n.step=function(){b.director.tick(this.frameTime/1e3)},n.pause=function(){this._paused||(this._paused=!0,this._intervalId&&(window.cAF(this._intervalId),this._intervalId=0))},n.resume=function(){this._paused&&(CO._clearEvents(),this._intervalId&&(window.cAF(this._intervalId),this._intervalId=0),this._paused=!1,this._updateCallback(),this._intervalId=window.rAF(this._frameCB))},n.isPaused=function(){return this._paused},n.restart=function(){var e=this;return new Promise((function(e){return b.director.once(b.Director.EVENT_END_FRAME,(function(){return e()}))})).then((function(){for(var n in e._persistRootNodes)e.removePersistRootNode(e._persistRootNodes[n]);return b.director.getScene().destroy(),b.Object._deferredDestroy(),b.director.reset(),b.profiler.reset(),e.pause(),e._setRenderPipelineNShowSplash().then((function(){e.resume(),e._safeEmit(t.EVENT_RESTART)}))}))},n.end=function(){nu.close()},n.on=function(e,n,i,r){return(this._engineInited&&e===t.EVENT_ENGINE_INITED||this._inited&&e===t.EVENT_GAME_INITED||this._rendererInitialized&&e===t.EVENT_RENDERER_INITED)&&n.call(i),this.eventTargetOn(e,n,i,r)},n.once=function(e,n,i){return this._engineInited&&e===t.EVENT_ENGINE_INITED?n.call(i):this.eventTargetOnce(e,n,i)},n.init=function(e){var t=this;if(this._initConfig(e),Ku._init({configOrientation:e.orientation||"auto",exactFitScreen:e.exactFitScreen}),this.config.assetOptions&&b.assetManager.init(this.config.assetOptions),this.config.layers)for(var n=this.config.layers,i=0;i<n.length;i++){var o=n[i],a=r(o.value);rd.addLayer(o.name,a)}return this._initEngine().then((function(){return t._initEvents(),b.director.root&&b.director.root.dataPoolManager&&b.director.root.dataPoolManager.jointTexturePool.registerCustomTextureLayouts(e.customJointTextureLayouts),t._engineInited}))},n.run=function(e,t){var n,i=this;return"function"!=typeof e&&e?(n=this.init(e),this.onStart=null!=t?t:null):this.onStart=null!=e?e:null,Vi.init(),Promise.resolve(n).then((function(){return i._setRenderPipelineNShowSplash()})).then((function(){}))},n.addPersistRootNode=function(e){if(b.Node.isNode(e)&&e.uuid){var t=e.uuid;if(!this._persistRootNodes[t]){var n=b.director._scene;if(b.isValid(n))if(e.parent){if(!(e.parent instanceof b.Scene))return void q(3801);if(e.parent!==n)return void q(3802);e._originalSceneId=n.uuid}else e.parent=n;this._persistRootNodes[t]=e,e._persistNode=!0,b.assetManager._releaseManager._addPersistNodeRef(e)}}else q(3800)},n.removePersistRootNode=function(e){var t=e.uuid||"";e===this._persistRootNodes[t]&&(delete this._persistRootNodes[t],e._persistNode=!1,e._originalSceneId="",b.assetManager._releaseManager._removePersistNodeRef(e))},n.isPersistRootNode=function(e){return!!e._persistNode},n.onEngineInitedAsync=function(e){this._onEngineInitedCallback.push(e)},n._initEngine=function(){var e=this;this._initDevice();var n=b.director;return Promise.resolve(n._init()).then((function(){b.view.init(),L("Cocos Creator v"+A),e.emit(t.EVENT_ENGINE_INITED),e._engineInited=!0,b.internal.dynamicAtlasManager&&(b.internal.dynamicAtlasManager.enabled=!nt.CLEANUP_IMAGE_CACHE)})).then((function(){var t=e._onEngineInitedCallback.map((function(e){return e()})).filter(Boolean);return e._onEngineInitedCallback.length=0,Promise.all(t)}))},n._setAnimFrame=function(){var e=this._frameRate,t=window.requestAnimationFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame;60!==e&&30!==e?(window.rAF=this._stTime.bind(this),window.cAF=this._ctTime):(window.rAF=t||this._stTime.bind(this),window.cAF=window.cancelAnimationFrame||window.cancelRequestAnimationFrame||window.msCancelRequestAnimationFrame||window.mozCancelRequestAnimationFrame||window.oCancelRequestAnimationFrame||window.webkitCancelRequestAnimationFrame||window.msCancelAnimationFrame||window.mozCancelAnimationFrame||window.webkitCancelAnimationFrame||window.ocancelAnimationFrame||this._ctTime,this._updateCallback())},n._stTime=function(e){var t=performance.now(),n=Math.max(0,t-this._startTime),i=Math.max(0,this.frameTime-n);return window.setTimeout(e,i)},n._ctTime=function(e){window.clearTimeout(e)},n._calculateDT=function(e){return e||(e=performance.now()),this._deltaTime=e>this._startTime?(e-this._startTime)/1e3:0,this._deltaTime>t.DEBUG_DT_THRESHOLD&&(this._deltaTime=this.frameTime/1e3),this._startTime=e,this._deltaTime},n._updateCallback=function(){var e,t=this,n=b.director;if(30===this._frameRate){var i=!0;e=function(e){t._intervalId=window.rAF(t._frameCB),(i=!i)||n.tick(t._calculateDT(e))}}else e=function(e){n.tick(t._calculateDT(e)),t._intervalId=window.rAF(t._frameCB)};this._frameCB=e},n._runMainLoop=function(){if(this._inited){var e=this.config,t=b.director;ee(!!e.showFPS),t.startAnimation(),this.resume()}},n._initConfig=function(e){"number"!=typeof e.debugMode&&(e.debugMode=K.NONE),e.exposeClassName=!!e.exposeClassName,"number"!=typeof e.frameRate&&(e.frameRate=60);var t=e.renderMode;("number"!=typeof t||t>3||t<0)&&(e.renderMode=0),e.showFPS=!!e.showFPS,k(e.debugMode),this.config=e,this._configLoaded=!0,this.frameRate=e.frameRate},n._determineRenderType=function(){var e=this.config,n=parseInt(e.renderMode,10);this.renderType=t.RENDER_TYPE_CANVAS;var i=!1;if(1===n?(this.renderType=t.RENDER_TYPE_CANVAS,i=!0):0===n||2===n?(this.renderType=t.RENDER_TYPE_WEBGL,i=!0):3===n&&(this.renderType=t.RENDER_TYPE_HEADLESS,i=!0),!i)throw new Error(Z(3820,n))},n._initDevice=function(){if(!this._rendererInitialized){var e=this.config.adapter;if(e&&(this.canvas=e.canvas,this.frame=e.frame,this.container=e.container),this._determineRenderType(),this.renderType===t.RENDER_TYPE_WEBGL){var n=new sr(xd),i=!!window.WebGL2RenderingContext,r=window.navigator.userAgent.toLowerCase();(-1!==r.indexOf("safari")&&-1===r.indexOf("chrome")||Qu.browserType===jl.UC)&&(i=!1);var o=[];i&&b.WebGL2Device&&o.push(b.WebGL2Device),b.WebGLDevice&&o.push(b.WebGLDevice),b.EmptyDevice&&o.push(b.EmptyDevice),lo.canvas=this.canvas;for(var a=0;a<o.length&&(this._gfxDevice=new o[a],!this._gfxDevice.initialize(n));a++);}else this.renderType===t.RENDER_TYPE_HEADLESS&&b.EmptyDevice&&(this._gfxDevice=new b.EmptyDevice,this._gfxDevice.initialize(new sr(xd)));if(!this._gfxDevice)return B("can not support canvas rendering in 3D"),void(this.renderType=t.RENDER_TYPE_CANVAS);var s=new ar(this.canvas),c=Ku.windowSize;s.width=c.width,s.height=c.height,this._swapchain=this._gfxDevice.createSwapchain(s),this.canvas.oncontextmenu=function(){return!1}}},n._initEvents=function(){nu.on("show",this._onShow,this),nu.on("hide",this._onHide,this)},n._onHide=function(){this.emit(t.EVENT_HIDE),this.pause()},n._onShow=function(){this.emit(t.EVENT_SHOW),this.resume()},n._setRenderPipelineNShowSplash=function(){var e=this;return Promise.resolve(this._setupRenderPipeline()).then((function(){return Promise.resolve(e._showSplashScreen()).then((function(){e._inited=!0,e._initTime=performance.now(),e._runMainLoop(),e._safeEmit(t.EVENT_GAME_INITED),e.onStart&&e.onStart()}))}))},n._setupRenderPipeline=function(){var e=this,t=this.config.renderPipeline;return t?new Promise((function(e,n){b.assetManager.loadAny(t,(function(t,i){return!t&&i instanceof Fx?e(i):n(t)}))})).then((function(t){e._setRenderPipeline(t)})).catch((function(n){F(n),F("Failed load render pipeline: "+t+", engine failed to initialize, will fallback to default pipeline"),e._setRenderPipeline()})):this._setRenderPipeline()},n._showSplashScreen=function(){if(b.internal.SplashScreen){var e=b.internal.SplashScreen.instance;return e.main(b.director.root),new Promise((function(t){e.setOnFinish((function(){return t()})),e.loadFinish=!0}))}return null},n._setRenderPipeline=function(e){b.director.root.setRenderPipeline(e)||this._setRenderPipeline(),this._rendererInitialized=!0,this._safeEmit(t.EVENT_RENDERER_INITED)},n._safeEmit=function(e){this.emit(e)},h(t,[{key:"inited",get:function(){return this._inited}},{key:"frameRate",get:function(){return this._frameRate},set:function(e){"number"!=typeof e&&(e=parseInt(e,10),Number.isNaN(e)&&(e=60)),this._frameRate=e,this.frameTime=1e3/e,this._setAnimFrame()}},{key:"deltaTime",get:function(){return this._deltaTime}},{key:"totalTime",get:function(){return performance.now()-this._initTime}},{key:"frameStartTime",get:function(){return this._startTime}}]),t}(Jl));wO.EVENT_HIDE="game_on_hide",wO.EVENT_SHOW="game_on_show",wO.EVENT_LOW_MEMORY="game_on_low_memory",wO.EVENT_GAME_INITED="game_inited",wO.EVENT_ENGINE_INITED="engine_inited",wO.EVENT_RENDERER_INITED="renderer_inited",wO.EVENT_RESTART="game_on_restart",wO.RENDER_TYPE_CANVAS=0,wO.RENDER_TYPE_WEBGL=1,wO.RENDER_TYPE_OPENGL=2,wO.RENDER_TYPE_HEADLESS=3,wO.DEBUG_DT_THRESHOLD=1,b.Game=wO;var IO,PO=e("game",b.game=new wO),RO=new jn,DO=((IO={})[nt.ORIENTATION_AUTO]=Hu.AUTO,IO[nt.ORIENTATION_LANDSCAPE]=Hu.LANDSCAPE,IO[nt.ORIENTATION_PORTRAIT]=Hu.PORTRAIT,IO),OO=e("View",function(e){function t(){var t;(t=e.call(this)||this)._designResolutionSize=void 0,t._scaleX=void 0,t._scaleY=void 0,t._viewportRect=void 0,t._visibleRect=void 0,t._autoFullScreen=void 0,t._retinaEnabled=void 0,t._resizeCallback=void 0,t._resolutionPolicy=void 0,t._rpExactFit=void 0,t._rpShowAll=void 0,t._rpNoBorder=void 0,t._rpFixedHeight=void 0,t._rpFixedWidth=void 0;var n=NO,i=MO;return t._designResolutionSize=new jn(0,0),t._scaleX=1,t._scaleY=1,t._viewportRect=new Xn(0,0,0,0),t._visibleRect=new Xn(0,0,0,0),t._autoFullScreen=!1,t._retinaEnabled=!1,t._resizeCallback=null,t._rpExactFit=new LO(n.EQUAL_TO_FRAME,i.EXACT_FIT),t._rpShowAll=new LO(n.EQUAL_TO_FRAME,i.SHOW_ALL),t._rpNoBorder=new LO(n.EQUAL_TO_FRAME,i.NO_BORDER),t._rpFixedHeight=new LO(n.EQUAL_TO_FRAME,i.FIXED_HEIGHT),t._rpFixedWidth=new LO(n.EQUAL_TO_FRAME,i.FIXED_WIDTH),t._resolutionPolicy=t._rpShowAll,t}f(t,e);var n=t.prototype;return n.init=function(){var e=Ku.windowSize,t=e.width,n=e.height;this._designResolutionSize.width=t,this._designResolutionSize.height=n,this._viewportRect.width=t,this._viewportRect.height=n,this._visibleRect.width=t,this._visibleRect.height=n,RO.width=this._visibleRect.width,RO.height=this._visibleRect.height,tO&&tO.init(this._visibleRect),Xu.on("window-resize",this._updateAdaptResult,this),Xu.on("orientation-change",this._updateAdaptResult,this),Xu.on("fullscreen-change",this._updateAdaptResult,this)},n.resizeWithBrowserSize=function(e){Xu.handleResizeEvent=e},n.setResizeCallback=function(e){"function"!=typeof e&&null!=e||(this._resizeCallback=e)},n.setOrientation=function(e){Xu.orientation=DO[e]},n.adjustViewportMeta=function(){},n.enableRetina=function(e){this._retinaEnabled=!!e},n.isRetinaEnabled=function(){return this._retinaEnabled},n.enableAutoFullScreen=function(e){e!==this._autoFullScreen&&(this._autoFullScreen=e,e&&Ku.requestFullScreen().catch((function(){})))},n.isAutoFullScreenEnabled=function(){return this._autoFullScreen},n.setCanvasSize=function(e,t){Xu.resolutionScale=1;var n=Xu.devicePixelRatio,i=new jn(e*n,t*n);Ku.windowSize=i},n.getCanvasSize=function(){return Ku.windowSize},n.getFrameSize=function(){var e=Xu.devicePixelRatio,t=Ku.windowSize;return t.width/=e,t.height/=e,t},n.setFrameSize=function(e,t){var n=Xu.devicePixelRatio;Ku.windowSize=new jn(e*n,t*n)},n.getVisibleSize=function(){return new jn(this._visibleRect.width,this._visibleRect.height)},n.getVisibleSizeInPixel=function(){return new jn(this._visibleRect.width*this._scaleX,this._visibleRect.height*this._scaleY)},n.getVisibleOrigin=function(){return new Tn(this._visibleRect.x,this._visibleRect.y)},n.getVisibleOriginInPixel=function(){return new Tn(this._visibleRect.x*this._scaleX,this._visibleRect.y*this._scaleY)},n.getResolutionPolicy=function(){return this._resolutionPolicy},n._updateResolutionPolicy=function(e){if(e instanceof LO)this._resolutionPolicy=e;else{var t=LO;e===t.EXACT_FIT&&(this._resolutionPolicy=this._rpExactFit),e===t.SHOW_ALL&&(this._resolutionPolicy=this._rpShowAll),e===t.NO_BORDER&&(this._resolutionPolicy=this._rpNoBorder),e===t.FIXED_HEIGHT&&(this._resolutionPolicy=this._rpFixedHeight),e===t.FIXED_WIDTH&&(this._resolutionPolicy=this._rpFixedWidth)}},n.setResolutionPolicy=function(e){this._updateResolutionPolicy(e);var t=BO.getDesignResolutionSize();BO.setDesignResolutionSize(t.width,t.height,e)},n.setDesignResolutionSize=function(e,t,n){if(e>0&&t>0){this._updateResolutionPolicy(n);var i=this._resolutionPolicy;i&&i.preApply(this),this._designResolutionSize.width=e,this._designResolutionSize.height=t;var r=i.apply(this,this._designResolutionSize);if(r.scale&&2===r.scale.length&&(this._scaleX=r.scale[0],this._scaleY=r.scale[1]),r.viewport){var o=this._viewportRect,a=this._visibleRect,s=r.viewport;o.x=s.x,o.y=s.y,o.width=s.width,o.height=s.height,a.x=0,a.y=0,a.width=s.width/this._scaleX,a.height=s.height/this._scaleY}i.postApply(this),RO.width=this._visibleRect.width,RO.height=this._visibleRect.height,tO&&tO.init(this._visibleRect),this.emit("design-resolution-changed")}else Y(2200)},n.getDesignResolutionSize=function(){return new jn(this._designResolutionSize.width,this._designResolutionSize.height)},n.setRealPixelResolution=function(e,t,n){document.documentElement.style.width=e+"px",document.body.style.width=e+"px",document.body.style.left="0px",document.body.style.top="0px",this.setDesignResolutionSize(e,t,n)},n.getViewportRect=function(){return this._viewportRect},n.getScaleX=function(){return this._scaleX},n.getScaleY=function(){return this._scaleY},n.getDevicePixelRatio=function(){return Xu.devicePixelRatio},n.convertToLocationInView=function(e,t,n,i){void 0===i&&(i=new Tn);var r=Xu.devicePixelRatio*(e-n.left),o=Xu.devicePixelRatio*(n.top+n.height-t);return Xu.isFrameRotated?(i.x=Ku.windowSize.width-o,i.y=r):(i.x=r,i.y=o),i},n._convertToUISpace=function(e){var t=this._viewportRect;e.x=(e.x-t.x)/this._scaleX,e.y=(e.y-t.y)/this._scaleY},n._updateAdaptResult=function(){var e;b.director.root.resize(Ku.windowSize.width,Ku.windowSize.height);var t=this._designResolutionSize.width,n=this._designResolutionSize.height;t>0&&this.setDesignResolutionSize(t,n,this._resolutionPolicy),this.emit("canvas-resize"),null===(e=this._resizeCallback)||void 0===e||e.call(this)},t}(Jl));OO.instance=void 0;var NO=function(){function e(){this.name="ContainerStrategy"}var t=e.prototype;return t.preApply=function(){},t.apply=function(){},t.postApply=function(){},t._setupCanvas=function(){var e=PO.canvas;if(e){var t=Ku.windowSize;e.width=t.width,e.height=t.height}},e}();NO.EQUAL_TO_FRAME=void 0,NO.PROPORTION_TO_FRAME=void 0;var MO=function(){function e(){this.name="ContentStrategy",this._result=void 0,this._result={scale:[1,1],viewport:null}}var t=e.prototype;return t.preApply=function(){},t.apply=function(){return{scale:[1,1]}},t.postApply=function(){},t._buildResult=function(e,t,n,i,r,o){Math.abs(e-n)<2&&(n=e),Math.abs(t-i)<2&&(i=t);var a=new Xn(Math.round((e-n)/2),Math.round((t-i)/2),n,i);return this._result.scale=[r,o],this._result.viewport=a,this._result},e}();MO.EXACT_FIT=void 0,MO.SHOW_ALL=void 0,MO.NO_BORDER=void 0,MO.FIXED_HEIGHT=void 0,MO.FIXED_WIDTH=void 0,function(){var e=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).name="EqualToFrame",t}return f(t,e),t.prototype.apply=function(){Xu.isProportionalToFrame=!1,this._setupCanvas()},t}(NO),t=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).name="ProportionalToFrame",t}return f(t,e),t.prototype.apply=function(){Xu.isProportionalToFrame=!0,this._setupCanvas()},t}(NO);NO.EQUAL_TO_FRAME=new e,NO.PROPORTION_TO_FRAME=new t;var n=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).name="ExactFit",t}return f(t,e),t.prototype.apply=function(e,t){var n=Ku.windowSize,i=n.width,r=n.height,o=i/t.width,a=r/t.height;return this._buildResult(i,r,i,r,o,a)},t}(MO),i=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).name="ShowAll",t}return f(t,e),t.prototype.apply=function(e,t){var n,i,r=Ku.windowSize,o=r.width,a=r.height,s=t.width,c=t.height,l=o/s,u=a/c,h=0;return l<u?(n=o,i=c*(h=l)):(n=s*(h=u),i=a),this._buildResult(o,a,n,i,h,h)},t}(MO),r=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).name="NoBorder",t}return f(t,e),t.prototype.apply=function(e,t){var n,i,r,o=Ku.windowSize,a=o.width,s=o.height,c=t.width,l=t.height,u=a/c,h=s/l;return u<h?(i=c*(n=h),r=s):(i=a,r=l*(n=u)),this._buildResult(a,s,i,r,n,n)},t}(MO),o=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).name="FixedHeight",t}return f(t,e),t.prototype.apply=function(e,t){var n=Ku.windowSize,i=n.width,r=n.height,o=r/t.height,a=i,s=r;return this._buildResult(i,r,a,s,o,o)},t}(MO),a=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).name="FixedWidth",t}return f(t,e),t.prototype.apply=function(e,t){var n=Ku.windowSize,i=n.width,r=n.height,o=i/t.width,a=i,s=r;return this._buildResult(i,r,a,s,o,o)},t}(MO);MO.EXACT_FIT=new n,MO.SHOW_ALL=new i,MO.NO_BORDER=new r,MO.FIXED_HEIGHT=new o,MO.FIXED_WIDTH=new a}();var LO=e("ResolutionPolicy",function(){function e(e,t){this.name="ResolutionPolicy",this._containerStrategy=void 0,this._contentStrategy=void 0,this._containerStrategy=null,this._contentStrategy=null,this.setContainerStrategy(e),this.setContentStrategy(t)}var t=e.prototype;return t.preApply=function(e){this._contentStrategy.preApply(e)},t.apply=function(e,t){return this._containerStrategy.apply(e,t),this._contentStrategy.apply(e,t)},t.postApply=function(e){this._contentStrategy.postApply(e)},t.setContainerStrategy=function(e){e instanceof NO&&(this._containerStrategy=e)},t.setContentStrategy=function(e){e instanceof MO&&(this._contentStrategy=e)},h(e,[{key:"canvasSize",get:function(){return Ku.windowSize}}]),e}());LO.EXACT_FIT=0,LO.NO_BORDER=1,LO.SHOW_ALL=2,LO.FIXED_HEIGHT=3,LO.FIXED_WIDTH=4,LO.UNKNOWN=5,LO.ContainerStrategy=NO,LO.ContentStrategy=MO,b.ResolutionPolicy=LO;var FO,BO=e("view",OO.instance=b.view=new OO);b.winSize=RO;var zO=((FO={})[Hu.PORTRAIT]=ri.IDENTITY,FO[Hu.LANDSCAPE_RIGHT]=ri.ROTATE_90,FO[Hu.PORTRAIT_UPSIDE_DOWN]=ri.ROTATE_180,FO[Hu.LANDSCAPE_LEFT]=ri.ROTATE_270,FO),UO=function(){function e(){this._title="",this._width=1,this._height=1,this._swapchain=null,this._renderPass=null,this._colorTextures=[],this._depthStencilTexture=null,this._cameras=[],this._hasOnScreenAttachments=!1,this._hasOffScreenAttachments=!1,this._framebuffer=null}e.registerCreateFunc=function(t){t._createWindowFun=function(t){return new e(t)}};var t=e.prototype;return t.initialize=function(e,t){if(this._init(),void 0!==t.title&&(this._title=t.title),void 0!==t.swapchain&&(this._swapchain=t.swapchain),this._width=t.width,this._height=t.height,this._renderPass=e.createRenderPass(t.renderPassInfo),t.swapchain)this._setSwapchain(t.swapchain),this._colorTextures.push(t.swapchain.colorTexture),this._depthStencilTexture=t.swapchain.depthStencilTexture;else{for(var n=0;n<t.renderPassInfo.colorAttachments.length;n++)this._colorTextures.push(e.createTexture(new fr(fi.TEX2D,di.COLOR_ATTACHMENT|di.SAMPLED|di.TRANSFER_SRC,t.renderPassInfo.colorAttachments[n].format,this._width,this._height)));t.renderPassInfo.depthStencilAttachment.format!==ai.UNKNOWN&&(this._depthStencilTexture=e.createTexture(new fr(fi.TEX2D,di.DEPTH_STENCIL_ATTACHMENT|di.SAMPLED,t.renderPassInfo.depthStencilAttachment.format,this._width,this._height)))}return this._setFrameBuffer(e.createFramebuffer(new Lr(this._renderPass,this._colorTextures,this._depthStencilTexture))),!0},t.destroy=function(){this.clearCameras(),this._framebuffer&&(this._framebuffer.destroy(),this._framebuffer=null),this._depthStencilTexture&&(this._depthStencilTexture.destroy(),this._depthStencilTexture=null);for(var e=0;e<this._colorTextures.length;e++){var t=this._colorTextures[e];t&&t.destroy()}this._colorTextures.length=0,this._destroy()},t.resize=function(e,t){if(this._swapchain)this._swapchain.resize(e,t,zO[Xu.orientation]),this._width=this._swapchain.width,this._height=this._swapchain.height;else{for(var n=0;n<this._colorTextures.length;n++)this._colorTextures[n].resize(e,t);this._depthStencilTexture&&this._depthStencilTexture.resize(e,t),this._width=e,this._height=t}this.framebuffer&&(this.framebuffer.destroy(),this.framebuffer.initialize(new Lr(this._renderPass,this._colorTextures,this._depthStencilTexture)));for(var i,r=S(this._cameras);!(i=r()).done;)i.value.resize(e,t)},t.extractRenderCameras=function(e){for(var t=0;t<this._cameras.length;t++){var n=this._cameras[t];n.enabled&&(n.update(),e.push(n))}},t.attachCamera=function(e){for(var t=0;t<this._cameras.length;t++)if(this._cameras[t]===e)return;this._cameras.push(e),this.sortCameras()},t.detachCamera=function(e){for(var t=0;t<this._cameras.length;++t)if(this._cameras[t]===e)return void this._cameras.splice(t,1)},t.clearCameras=function(){this._cameras.length=0},t.sortCameras=function(){this._cameras.sort((function(e,t){return e.priority-t.priority}))},t._init=function(){},t._destroy=function(){},t._setSwapchain=function(e){this._swapchain=e},t._setFrameBuffer=function(e){this._framebuffer=e},h(e,[{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"swapchain",get:function(){return this._swapchain}},{key:"framebuffer",get:function(){return this._framebuffer}},{key:"cameras",get:function(){return this._cameras}},{key:"native",get:function(){return this._nativeObj}}]),e}(),kO=e("Root",function(){function e(e){var t=this;this._createSceneFun=null,this._createWindowFun=null,this._device=void 0,this._windows=[],this._mainWindow=null,this._curWindow=null,this._tempWindow=null,this._pipeline=null,this._batcher=null,this._dataPoolMgr=void 0,this._scenes=[],this._modelPools=new Map,this._cameraPool=null,this._lightPools=new Map,this._fpsTime=0,this._frameCount=0,this._fps=0,this._fixedFPS=0,this._useDeferredPipeline=!1,this._fixedFPSFrameTime=0,this._cumulativeTime=0,this._frameTime=0,this._device=e,this._dataPoolMgr=b.internal.DataPoolManager&&new b.internal.DataPoolManager(e),vy.registerCreateFunc(this),UO.registerCreateFunc(this),this._cameraPool=new Ml((function(){return new Gv(t._device)}),4,(function(e){return e.destroy()}))}var t=e.prototype;return t.initialize=function(){this._init();var e=b.game._swapchain,t=new Ir;t.format=e.colorTexture.format;var n=new Pr;n.format=e.depthStencilTexture.format,n.depthStoreOp=Ii.DISCARD,n.stencilStoreOp=Ii.DISCARD;var i=new Or([t],n);return this._mainWindow=this.createWindow({title:"rootMainWindow",width:e.width,height:e.height,renderPassInfo:i,swapchain:e}),this._curWindow=this._mainWindow,Promise.resolve(nv.initBuiltinRes(this._device))},t.destroy=function(){this.destroyScenes(),this._pipeline&&(this._pipeline.destroy(),this._pipeline=null),this._batcher&&(this._batcher.destroy(),this._batcher=null),this._curWindow=null,this._mainWindow=null,this.dataPoolManager.clear(),this._destroy()},t.resize=function(e,t){for(var n,i=S(this._windows);!(n=i()).done;){var r=n.value;r.swapchain&&r.resize(e,t)}},t.setRenderPipeline=function(e){e instanceof JD&&(this._useDeferredPipeline=!0);var t=!1;if(e||(e=ZD(),t=!0),this._pipeline=e,this._useDeferredPipeline&&this.device.hasFeature(oi.COMPUTE_SHADER)||(this._pipeline.clusterEnabled=!1),this._pipeline.bloomEnabled=!1,!this._pipeline.activate(this._mainWindow.swapchain))return t&&this._pipeline.destroy(),this._pipeline=null,!1;var n=b.director.getScene();return n&&n.globals.activate(),this.onGlobalPipelineStateChanged(),!(!this._batcher&&b.internal.Batcher2D&&(this._batcher=new b.internal.Batcher2D(this),!this._batcher.initialize())&&(this.destroy(),1))},t.onGlobalPipelineStateChanged=function(){for(var e=0;e<this._scenes.length;e++)this._scenes[e].onGlobalPipelineStateChanged();this._pipeline.pipelineSceneData.onGlobalPipelineStateChanged()},t.activeWindow=function(e){this._curWindow=e},t.resetCumulativeTime=function(){this._setCumulativeTime(0)},t.frameMove=function(e){this._setFrameTime(e),++this._frameCount,this._setCumulativeTime(e),this._fpsTime+=e,this._fpsTime>1&&(this._fps=this._frameCount,this._frameCount=0,this._fpsTime=0);for(var t=0;t<this._scenes.length;++t)this._scenes[t].removeBatches();for(var n=this._windows,i=[],r=0;r<n.length;r++)n[r].extractRenderCameras(i);if(this._pipeline&&i.length>0){this._device.acquire([b.game._swapchain]);var o=this._scenes,a=b.director.getTotalFrames();this._batcher&&(this._batcher.update(),this._batcher.uploadBuffers());for(var s=0;s<o.length;s++)o[s].update(a);b.director.emit(b.Director.EVENT_BEFORE_COMMIT),i.sort((function(e,t){return e.priority-t.priority})),this._pipeline.render(i),this._device.present()}this._batcher&&this._batcher.reset()},t.createWindow=function(e){var t=this._createWindowFun(this);return t.initialize(this.device,e),this._windows.push(t),t},t.destroyWindow=function(e){for(var t=0;t<this._windows.length;++t)if(this._windows[t]===e)return e.destroy(),void this._windows.splice(t,1)},t.destroyWindows=function(){for(var e,t=S(this._windows);!(e=t()).done;)e.value.destroy();this._windows.length=0},t.createScene=function(e){var t=this._createSceneFun(this);return t.initialize(e),this._scenes.push(t),t},t.destroyScene=function(e){for(var t=0;t<this._scenes.length;++t)if(this._scenes[t]===e)return e.destroy(),void this._scenes.splice(t,1)},t.destroyScenes=function(){for(var e,t=S(this._scenes);!(e=t()).done;)e.value.destroy();this._scenes.length=0},t.createModel=function(e){var t=this._modelPools.get(e);t||(this._modelPools.set(e,new Ml((function(){return new e}),10,(function(e){return e.destroy()}))),t=this._modelPools.get(e));var n=t.alloc();return n.initialize(),n},t.destroyModel=function(e){var t=this._modelPools.get(e.constructor);t?(t.free(e),e.scene&&e.scene.removeModel(e)):q(1300,e.constructor.name),e.destroy()},t.createCamera=function(){return this._cameraPool.alloc()},t.createLight=function(e){var t=this._lightPools.get(e);t||(this._lightPools.set(e,new Ml((function(){return new e}),4,(function(e){return e.destroy()}))),t=this._lightPools.get(e));var n=t.alloc();return n.initialize(),n},t.destroyLight=function(e){var t=this._lightPools.get(e.constructor);if(t&&(t.free(e),e.scene))switch(e.type){case $g.SPHERE:e.scene.removeSphereLight(e);break;case $g.SPOT:e.scene.removeSpotLight(e)}e.destroy()},t._init=function(){},t._destroy=function(){},t._setCumulativeTime=function(e){this._cumulativeTime+=e},t._setFrameTime=function(e){this._frameTime=e},h(e,[{key:"device",get:function(){return this._device}},{key:"mainWindow",get:function(){return this._mainWindow}},{key:"curWindow",get:function(){return this._curWindow},set:function(e){this._curWindow=e}},{key:"tempWindow",get:function(){return this._tempWindow},set:function(e){this._tempWindow=e}},{key:"windows",get:function(){return this._windows}},{key:"pipeline",get:function(){return this._pipeline}},{key:"batcher2D",get:function(){return this._batcher}},{key:"scenes",get:function(){return this._scenes}},{key:"cumulativeTime",get:function(){return this._cumulativeTime}},{key:"frameTime",get:function(){return this._frameTime}},{key:"frameCount",get:function(){return this._frameCount}},{key:"fps",get:function(){return this._fps}},{key:"fixedFPS",get:function(){return this._fixedFPS},set:function(e){e>0?(this._fixedFPS=e,this._fixedFPSFrameTime=1e3/e):this._fixedFPSFrameTime=0}},{key:"dataPoolManager",get:function(){return this._dataPoolMgr}},{key:"useDeferredPipeline",get:function(){return this._useDeferredPipeline}}]),e}());b.Root=kO;var GO=e("System",function(){function e(){this._id="",this._priority=0,this._executeInEditMode=!1}e.sortByPriority=function(e,t){return e._priority<t._priority?1:e._priority>t.priority?-1:0};var t=e.prototype;return t.init=function(){},t.update=function(){},t.postUpdate=function(){},h(e,[{key:"priority",get:function(){return this._priority},set:function(e){this._priority=e}},{key:"id",get:function(){return this._id},set:function(e){this._id=e}}]),e}());GO.Priority=Je({LOW:0,MEDIUM:100,HIGH:200,SCHEDULER:1<<31>>>0});var HO=new ce("Scheduler"),VO=function(e,t,n,i){this.target=void 0,this.priority=void 0,this.paused=void 0,this.markedForDeletion=void 0,this.target=e,this.priority=t,this.paused=n,this.markedForDeletion=i};VO.get=function(e,t,n,i){var r=VO._listEntries.pop();return r?(r.target=e,r.priority=t,r.paused=n,r.markedForDeletion=i):r=new VO(e,t,n,i),r},VO.put=function(e){VO._listEntries.length<20&&(e.target=null,VO._listEntries.push(e))},VO._listEntries=[];var WO=function(e,t,n,i){this.list=void 0,this.entry=void 0,this.target=void 0,this.callback=void 0,this.list=e,this.entry=t,this.target=n,this.callback=i};WO.get=function(e,t,n,i){var r=WO._hashUpdateEntries.pop();return r?(r.list=e,r.entry=t,r.target=n,r.callback=i):r=new WO(e,t,n,i),r},WO.put=function(e){WO._hashUpdateEntries.length<20&&(e.list=e.entry=e.target=e.callback=null,WO._hashUpdateEntries.push(e))},WO._hashUpdateEntries=[];var jO=function(e,t,n,i,r,o){this.timers=void 0,this.target=void 0,this.timerIndex=void 0,this.currentTimer=void 0,this.currentTimerSalvaged=void 0,this.paused=void 0,this.timers=e,this.target=t,this.timerIndex=n,this.currentTimer=i,this.currentTimerSalvaged=r,this.paused=o};jO.get=function(e,t,n,i,r,o){var a=jO._hashTimerEntries.pop();return a?(a.timers=e,a.target=t,a.timerIndex=n,a.currentTimer=i,a.currentTimerSalvaged=r,a.paused=o):a=new jO(e,t,n,i,r,o),a},jO.put=function(e){jO._hashTimerEntries.length<20&&(e.timers=e.target=e.currentTimer=null,jO._hashTimerEntries.push(e))},jO._hashTimerEntries=[];var qO=function(){function e(){this._lock=void 0,this._scheduler=void 0,this._elapsed=void 0,this._runForever=void 0,this._useDelay=void 0,this._timesExecuted=void 0,this._repeat=void 0,this._delay=void 0,this._interval=void 0,this._target=void 0,this._callback=void 0,this._lock=!1,this._scheduler=null,this._elapsed=-1,this._runForever=!1,this._useDelay=!1,this._timesExecuted=0,this._repeat=0,this._delay=0,this._interval=0,this._target=null,this._callback=null}var t=e.prototype;return t.initWithCallback=function(e,t,n,i,r,o){return this._lock=!1,this._scheduler=e,this._target=n,this._callback=t,this._elapsed=-1,this._interval=i,this._delay=o,this._useDelay=this._delay>0,this._repeat=r,this._runForever=this._repeat===b.macro.REPEAT_FOREVER,!0},t.getInterval=function(){return this._interval},t.setInterval=function(e){this._interval=e},t.update=function(e){-1===this._elapsed?(this._elapsed=0,this._timesExecuted=0):(this._elapsed+=e,this._runForever&&!this._useDelay?this._elapsed>=this._interval&&(this.trigger(),this._elapsed=0):(this._useDelay?this._elapsed>=this._delay&&(this.trigger(),this._elapsed-=this._delay,this._timesExecuted+=1,this._useDelay=!1):this._elapsed>=this._interval&&(this.trigger(),this._elapsed=0,this._timesExecuted+=1),this._callback&&!this._runForever&&this._timesExecuted>this._repeat&&this.cancel()))},t.getCallback=function(){return this._callback},t.trigger=function(){this._target&&this._callback&&(this._lock=!0,this._callback.call(this._target,this._elapsed),this._lock=!1)},t.cancel=function(){this._scheduler.unschedule(this._callback,this._target)},e}();qO._timers=[],qO.get=function(){return qO._timers.pop()||new qO},qO.put=function(e){qO._timers.length<20&&!e._lock&&(e._scheduler=e._target=e._callback=null,qO._timers.push(e))};var XO=e("Scheduler",function(e){function t(){var t;return(t=e.call(this)||this)._timeScale=void 0,t._updatesNegList=void 0,t._updates0List=void 0,t._updatesPosList=void 0,t._hashForUpdates=void 0,t._hashForTimers=void 0,t._currentTarget=void 0,t._currentTargetSalvaged=void 0,t._updateHashLocked=void 0,t._arrayForTimers=void 0,t._timeScale=1,t._updatesNegList=[],t._updates0List=[],t._updatesPosList=[],t._hashForUpdates=xe(!0),t._hashForTimers=xe(!0),t._currentTarget=null,t._currentTargetSalvaged=!1,t._updateHashLocked=!1,t._arrayForTimers=[],t}f(t,e),t.enableForTarget=function(e){var t=!1;(e.uuid||e.id)&&(t=!0),t||(e.__instanceId?q(1513):e.id=HO.getNewId())};var n=t.prototype;return n.setTimeScale=function(e){this._timeScale=e},n.getTimeScale=function(){return this._timeScale},n.update=function(e){var t,n,i,r,o;for(this._updateHashLocked=!0,1!==this._timeScale&&(e*=this._timeScale),t=0,i=(n=this._updatesNegList).length;t<i;t++)(r=n[t]).paused||r.markedForDeletion||r.target.update(e);for(t=0,i=(n=this._updates0List).length;t<i;t++)(r=n[t]).paused||r.markedForDeletion||r.target.update(e);for(t=0,i=(n=this._updatesPosList).length;t<i;t++)(r=n[t]).paused||r.markedForDeletion||r.target.update(e);var a=this._arrayForTimers;for(t=0;t<a.length;t++){if(o=a[t],this._currentTarget=o,this._currentTargetSalvaged=!1,!o.paused)for(o.timerIndex=0;o.timerIndex<o.timers.length;++o.timerIndex)o.currentTimer=o.timers[o.timerIndex],o.currentTimerSalvaged=!1,o.currentTimer.update(e),o.currentTimer=null;this._currentTargetSalvaged&&0===this._currentTarget.timers.length&&(this._removeHashElement(this._currentTarget),--t)}for(t=0,n=this._updatesNegList;t<n.length;)(r=n[t]).markedForDeletion?this._removeUpdateFromHash(r):t++;for(t=0,n=this._updates0List;t<n.length;)(r=n[t]).markedForDeletion?this._removeUpdateFromHash(r):t++;for(t=0,n=this._updatesPosList;t<n.length;)(r=n[t]).markedForDeletion?this._removeUpdateFromHash(r):t++;this._updateHashLocked=!1,this._currentTarget=null},n.schedule=function(e,t,n,i,r,o){if("function"!=typeof e){var a=e;e=t,t=a}3!==arguments.length&&4!==arguments.length&&5!==arguments.length||(o=!!i,i=b.macro.REPEAT_FOREVER,r=0),J(t,1502);var s=t.uuid||t.id;if(s){var c,l,u=this._hashForTimers[s];if(u?u.paused!==o&&q(1511):(u=jO.get(null,t,0,null,null,o),this._arrayForTimers.push(u),this._hashForTimers[s]=u),null==u.timers)u.timers=[];else for(l=0;l<u.timers.length;++l)if((c=u.timers[l])&&e===c._callback)return W(1507,c.getInterval(),n),void(c._interval=n);(c=qO.get()).initWithCallback(this,e,t,n,i,r),u.timers.push(c),this._currentTarget===u&&this._currentTargetSalvaged&&(this._currentTargetSalvaged=!1)}else Y(1510)},n.scheduleUpdate=function(e,t,n){var i=e.uuid||e.id;if(i){var r=this._hashForUpdates[i];if(r&&r.entry){if(r.entry.priority===t)return r.entry.markedForDeletion=!1,void(r.entry.paused=n);if(this._updateHashLocked)return W(1506),r.entry.markedForDeletion=!1,void(r.entry.paused=n);this.unscheduleUpdate(e)}var o,a=VO.get(e,t,n,!1);0===t?(o=this._updates0List,this._appendIn(o,a)):(o=t<0?this._updatesNegList:this._updatesPosList,this._priorityIn(o,a,t)),this._hashForUpdates[i]=WO.get(o,a,e,null)}else Y(1510)},n.unschedule=function(e,t){if(t&&e){var n=t.uuid||t.id;if(n){var i=this._hashForTimers[n];if(i)for(var r=i.timers,o=0,a=r.length;o<a;o++){var s=r[o];if(e===s._callback)return s!==i.currentTimer||i.currentTimerSalvaged||(i.currentTimerSalvaged=!0),r.splice(o,1),qO.put(s),i.timerIndex>=o&&i.timerIndex--,void(0===r.length&&(this._currentTarget===i?this._currentTargetSalvaged=!0:this._removeHashElement(i)))}}else Y(1510)}},n.unscheduleUpdate=function(e){if(e){var t=e.uuid||e.id;if(t){var n=this._hashForUpdates[t];n&&(this._updateHashLocked?n.entry.markedForDeletion=!0:this._removeUpdateFromHash(n.entry))}else Y(1510)}},n.unscheduleAllForTarget=function(e){if(e){var t=e.uuid||e.id;if(t){var n=this._hashForTimers[t];if(n){var i=n.timers;i.indexOf(n.currentTimer)>-1&&!n.currentTimerSalvaged&&(n.currentTimerSalvaged=!0);for(var r=0,o=i.length;r<o;r++)qO.put(i[r]);i.length=0,this._currentTarget===n?this._currentTargetSalvaged=!0:this._removeHashElement(n)}this.unscheduleUpdate(e)}else Y(1510)}},n.unscheduleAll=function(){this.unscheduleAllWithMinPriority(GO.Priority.SCHEDULER)},n.unscheduleAllWithMinPriority=function(e){var t,n,i,r=this._arrayForTimers;for(t=r.length-1;t>=0;t--)n=r[t],this.unscheduleAllForTarget(n.target);var o=0;if(e<0)for(t=0;t<this._updatesNegList.length;)o=this._updatesNegList.length,(i=this._updatesNegList[t])&&i.priority>=e&&this.unscheduleUpdate(i.target),o===this._updatesNegList.length&&t++;if(e<=0)for(t=0;t<this._updates0List.length;)o=this._updates0List.length,(i=this._updates0List[t])&&this.unscheduleUpdate(i.target),o===this._updates0List.length&&t++;for(t=0;t<this._updatesPosList.length;)o=this._updatesPosList.length,(i=this._updatesPosList[t])&&i.priority>=e&&this.unscheduleUpdate(i.target),o===this._updatesPosList.length&&t++},n.isScheduled=function(e,t){J(e,1508),J(t,1509);var n=t.uuid||t.id;if(!n)return Y(1510),!1;var i=this._hashForTimers[n];if(!i)return!1;if(null==i.timers)return!1;for(var r=i.timers,o=0;o<r.length;++o)if(e===r[o]._callback)return!0;return!1},n.pauseAllTargets=function(){return this.pauseAllTargetsWithMinPriority(GO.Priority.SCHEDULER)},n.pauseAllTargetsWithMinPriority=function(e){var t,n,i,r,o=[],a=this._arrayForTimers;for(n=0,i=a.length;n<i;n++)(t=a[n])&&(t.paused=!0,o.push(t.target));if(e<0)for(n=0;n<this._updatesNegList.length;n++)(r=this._updatesNegList[n])&&r.priority>=e&&(r.paused=!0,o.push(r.target));if(e<=0)for(n=0;n<this._updates0List.length;n++)(r=this._updates0List[n])&&(r.paused=!0,o.push(r.target));for(n=0;n<this._updatesPosList.length;n++)(r=this._updatesPosList[n])&&r.priority>=e&&(r.paused=!0,o.push(r.target));return o},n.resumeTargets=function(e){if(e)for(var t=0;t<e.length;t++)this.resumeTarget(e[t])},n.pauseTarget=function(e){J(e,1503);var t=e.uuid||e.id;if(t){var n=this._hashForTimers[t];n&&(n.paused=!0);var i=this._hashForUpdates[t];i&&(i.entry.paused=!0)}else Y(1510)},n.resumeTarget=function(e){J(e,1504);var t=e.uuid||e.id;if(t){var n=this._hashForTimers[t];n&&(n.paused=!1);var i=this._hashForUpdates[t];i&&(i.entry.paused=!1)}else Y(1510)},n.isTargetPaused=function(e){J(e,1505);var t=e.uuid||e.id;if(!t)return Y(1510),!1;var n=this._hashForTimers[t];if(n)return n.paused;var i=this._hashForUpdates[t];return!!i&&i.entry.paused},n._removeHashElement=function(e){var t=e.target.uuid||e.target.id;delete this._hashForTimers[t];for(var n=this._arrayForTimers,i=0,r=n.length;i<r;i++)if(n[i]===e){n.splice(i,1);break}jO.put(e)},n._removeUpdateFromHash=function(e){var t=e.target.uuid||e.target.id,n=this._hashForUpdates[t];if(n){for(var i=n.list,r=n.entry,o=0,a=i.length;o<a;o++)if(i[o]===r){i.splice(o,1);break}delete this._hashForUpdates[t],VO.put(r),WO.put(n)}},n._priorityIn=function(e,t,n){for(var i=0;i<e.length;i++)if(n<e[i].priority)return void e.splice(i,0,t);e.push(t)},n._appendIn=function(e,t){e.push(t)},t}(GO));XO.ID="scheduler",b.Scheduler=XO;var YO=e("Director",function(e){function t(){var t;return(t=e.call(this)||this)._compScheduler=void 0,t._nodeActivator=void 0,t._invalid=void 0,t._paused=void 0,t._root=void 0,t._loadingScene=void 0,t._scene=void 0,t._totalFrames=void 0,t._scheduler=void 0,t._systems=void 0,t._invalid=!1,t._paused=!1,t._root=null,t._loadingScene="",t._scene=null,t._totalFrames=0,t._scheduler=new XO,t._compScheduler=new lR,t._nodeActivator=new wR,t._systems=[],PO.once(wO.EVENT_RENDERER_INITED,t._initOnRendererInitialized,y(t)),t}f(t,e);var n=t.prototype;return n.calculateDeltaTime=function(){},n.end=function(){var e=this;this.once(t.EVENT_END_FRAME,(function(){e.purgeDirector()}))},n.pause=function(){this._paused||(this._paused=!0)},n.purgeDirector=function(){this._scheduler.unscheduleAll(),this._compScheduler.unscheduleAll(),this._nodeActivator.reset(),b.isValid(this._scene)&&this._scene.destroy(),this._scene=null,this.stopAnimation(),b.assetManager.releaseAll()},n.reset=function(){this.purgeDirector(),this.emit(t.EVENT_RESET),this.startAnimation()},n.runSceneImmediate=function(e,t,n){e instanceof IR&&(e=e.scene),J(e instanceof XP,1216),e._load();for(var i=Object.keys(PO._persistRootNodes).map((function(e){return PO._persistRootNodes[e]})),r=0;r<i.length;r++){var o=i[r];o.emit(b.Node.SCENE_CHANGED_FOR_PERSISTS,e.renderScene);var a=e.uuid===o._originalSceneId&&e.getChildByUuid(o.uuid);if(a){var s=a.getSiblingIndex();a._destroyImmediate(),e.insertChild(o,s)}else o.parent=e}var c=this._scene;b.isValid(c)&&c.destroy(),b.assetManager._releaseManager._autoRelease(c,e,PO._persistRootNodes),this._scene=null,ol._deferredDestroy(),t&&t(),this.emit(b.Director.EVENT_BEFORE_SCENE_LAUNCH,e),this._scene=e,e._activate(),this._root&&this._root.resetCumulativeTime(),this.startAnimation(),n&&n(null,e),this.emit(b.Director.EVENT_AFTER_SCENE_LAUNCH,e)},n.runScene=function(e,t,n){var i=this;e instanceof IR&&(e=e.scene),J(e,1205),J(e instanceof XP,1216),e._load(),this.once(b.Director.EVENT_END_FRAME,(function(){i.runSceneImmediate(e,t,n)}))},n.loadScene=function(e,t,n){var i=this;if(this._loadingScene)return q(1208,e,this._loadingScene),!1;var r=b.assetManager.bundles.find((function(t){return!!t.getSceneInfo(e)}));return r?(this.emit(b.Director.EVENT_BEFORE_SCENE_LOADING,e),this._loadingScene=e,console.time("LoadScene "+e),r.loadScene(e,(function(r,o){console.timeEnd("LoadScene "+e),i._loadingScene="",r?(B(r),t&&t(r)):i.runSceneImmediate(o,n,t)})),!0):(Y(1209,e),!1)},n.preloadScene=function(e,t,n){var i=b.assetManager.bundles.find((function(t){return!!t.getSceneInfo(e)}));if(i)i.preloadScene(e,null,t,n);else{var r='Can not preload the scene "'+e+'" because it is not in the build settings.';n&&n(new Error(r)),B("preloadScene: "+r)}},n.resume=function(){this._paused&&(this._paused=!1)},n.getScene=function(){return this._scene},n.getDeltaTime=function(){return PO.deltaTime},n.getTotalTime=function(){return PO.totalTime},n.getCurrentTime=function(){return PO.frameStartTime},n.getTotalFrames=function(){return this._totalFrames},n.isPaused=function(){return this._paused},n.getScheduler=function(){return this._scheduler},n.setScheduler=function(e){this._scheduler!==e&&(this.unregisterSystem(this._scheduler),this._scheduler=e,this.registerSystem(XO.ID,e,200))},n.registerSystem=function(e,t,n){t.id=e,t.priority=n,t.init(),this._systems.push(t),this._systems.sort(GO.sortByPriority)},n.unregisterSystem=function(e){Ye.fastRemove(this._systems,e),this._systems.sort(GO.sortByPriority)},n.getSystem=function(e){return this._systems.find((function(t){return t.id===e}))},n.getAnimationManager=function(){return this.getSystem(b.AnimationManager.ID)},n.startAnimation=function(){this._invalid=!1},n.stopAnimation=function(){this._invalid=!0},n.mainLoop=function(e){var t;t=PO._calculateDT(e),this.tick(t)},n.tick=function(e){if(!this._invalid){if(this.emit(t.EVENT_BEGIN_FRAME),CO._frameDispatchEvents(),!this._paused){this.emit(t.EVENT_BEFORE_UPDATE),this._compScheduler.startPhase(),this._compScheduler.updatePhase(e);for(var n=0;n<this._systems.length;++n)this._systems[n].update(e);this._compScheduler.lateUpdatePhase(e),this.emit(t.EVENT_AFTER_UPDATE),ol._deferredDestroy();for(var i=0;i<this._systems.length;++i)this._systems[i].postUpdate(e)}this.emit(t.EVENT_BEFORE_DRAW),this._root.frameMove(e),this.emit(t.EVENT_AFTER_DRAW),jb.resetHasChangedFlags(),jb.clearNodeArray(),Ol.update(e),this.emit(t.EVENT_END_FRAME),this._totalFrames++}},n._initOnRendererInitialized=function(){this._totalFrames=0,this._paused=!1,this.registerSystem(XO.ID,this._scheduler,200),this.emit(t.EVENT_INIT)},n._init=function(){return this._root=new kO(PO._gfxDevice),this._root.initialize({}).catch((function(e){return Y(1217),Promise.reject(e)}))},h(t,[{key:"root",get:function(){return this._root}}]),t}(Jl));YO.EVENT_INIT="director_init",YO.EVENT_RESET="director_reset",YO.EVENT_BEFORE_SCENE_LOADING="director_before_scene_loading",YO.EVENT_BEFORE_SCENE_LAUNCH="director_before_scene_launch",YO.EVENT_AFTER_SCENE_LAUNCH="director_after_scene_launch",YO.EVENT_BEFORE_UPDATE="director_before_update",YO.EVENT_AFTER_UPDATE="director_after_update",YO.EVENT_BEFORE_DRAW="director_before_draw",YO.EVENT_AFTER_DRAW="director_after_draw",YO.EVENT_BEFORE_COMMIT="director_before_commit",YO.EVENT_BEFORE_PHYSICS="director_before_physics",YO.EVENT_AFTER_PHYSICS="director_after_physics",YO.EVENT_BEGIN_FRAME="director_begin_frame",YO.EVENT_END_FRAME="director_end_frame",YO.instance=void 0,b.Director=YO;var KO=e("director",YO.instance=b.director=new YO),QO=function(){function e(){this.name="",this.base="",this.importBase="",this.nativeBase="",this.deps=null,this.assetInfos=new cl,this.scenes=new cl,this.paths=new cl}var t=e.prototype;return t.init=function(e){var t=this;!function(e){var t=e.uuids,n=e.paths,i=e.types,r=e.deps,o=e.paths=Object.create(null);if(!1===e.debug){for(var a=0,s=t.length;a<s;a++)t[a]=bl(t[a]);for(var c in n){var l=n[c],u=l[1];l[1]=i[u]}}else{for(var h=Object.create(null),_=0,f=t.length;_<f;_++){var d=t[_];t[_]=h[d]=bl(d)}t=h}for(var p in n){var m=n[p];o[t[p]]=m}var v=e.scenes;for(var g in v){var y=v[g];v[g]=t[y]}var x=e.packs;for(var S in x)for(var E=x[S],T=0;T<E.length;++T)E[T]=t[E[T]];var C=e.versions;if(C)for(var b in C)for(var A=C[b],w=0;w<A.length;w+=2){var I=A[w];A[w]=t[I]||I}var P=e.redirect;if(P)for(var R=0;R<P.length;R+=2)P[R]=t[P[R]],P[R+1]=r[P[R+1]];if(e.extensionMap){var D=function(n){if(!Object.prototype.hasOwnProperty.call(e.extensionMap,n))return"continue";e.extensionMap[n].forEach((function(i,r){e.extensionMap[n][r]=t[i]||i}))};for(var O in e.extensionMap)D(O)}}(e),this.importBase=e.importBase||"",this.nativeBase=e.nativeBase||"",this.base=e.base||"",this.name=e.name||"",this.deps=e.deps||[],this._initUuid(e.uuids),this._initPath(e.paths),this._initScene(e.scenes),this._initPackage(e.packs),this._initVersion(e.versions),this._initRedirect(e.redirect);var n=function(n){if(!Object.prototype.hasOwnProperty.call(e.extensionMap,n))return"continue";e.extensionMap[n].forEach((function(e){var i=t.assetInfos.get(e);i&&(i.extension=n)}))};for(var i in e.extensionMap)n(i)},t.getInfoWithPath=function(e,t){if(!e)return null;e=Pl(e);var n=this.paths.get(e);if(n){if(!t)return n[0];for(var i=0,r=n.length;i<r;i++){var o=n[i];if(Ke.isChildClassOf(o.ctor,t))return o}}return null},t.getDirWithPath=function(e,t,n){"/"===(e=Pl(e))[e.length-1]&&(e=e.slice(0,-1));var i=n||[];return this.paths.forEach((function(n,r){if(r.startsWith(e)&&function(e,t){return!(e.length>t.length)||47===e.charCodeAt(t.length)}(r,e)||!e)for(var o=0,a=n.length;o<a;o++){var s=n[o];t&&!Ke.isChildClassOf(s.ctor,t)||i.push(s)}})),i},t.getAssetInfo=function(e){return this.assetInfos.get(e)||null},t.getSceneInfo=function(e){return e.endsWith(".scene")||(e+=".scene"),"/"===e[0]||e.startsWith("db://")||(e="/"+e),this.scenes.find((function(t,n){return n.endsWith(e)}))},t.destroy=function(){this.paths.destroy(),this.scenes.destroy(),this.assetInfos.destroy()},t._initUuid=function(e){if(e){this.assetInfos.clear();for(var t=0,n=e.length;t<n;t++){var i=e[t];this.assetInfos.add(i,{uuid:i})}}},t._initPath=function(e){if(e){var t=this.paths;for(var n in t.clear(),e){var i=e[n],r=i[0],o=i[1],a=3===i.length,s=this.assetInfos.get(n);s.path=r,s.ctor=Ke._getClassById(o),t.has(r)?a?t.get(r).push(s):t.get(r).unshift(s):t.add(r,[s])}}},t._initScene=function(e){if(e){var t=this.scenes;t.clear();var n=this.assetInfos;for(var i in e){var r=e[i],o=n.get(r);o.url=i,t.add(i,o)}}},t._initPackage=function(e){if(e){var t=this.assetInfos;for(var n in e){var i=e[n],r={uuid:n,packedUuids:i,ext:".json"};t.add(n,r);for(var o=0,a=i.length;o<a;o++){var s=i[o],c=t.get(s),l=c.packs;l?1===a?l.unshift(r):l.push(r):c.packs=[r]}}}},t._initVersion=function(e){if(e){var t=this.assetInfos,n=e.import;if(n)for(var i=0,r=n.length;i<r;i+=2){var o=n[i];t.get(o).ver=n[i+1]}if(n=e.native)for(var a=0,s=n.length;a<s;a+=2){var c=n[a];t.get(c).nativeVer=n[a+1]}}},t._initRedirect=function(e){if(e)for(var t=this.assetInfos,n=0,i=e.length;n<i;n+=2){var r=e[n];t.get(r).redirect=e[n+1]}},e}();function JO(e,t){e._uuid&&t.push(e._uuid)}function ZO(e,t){for(var n=Object.getOwnPropertyNames(e),i=0;i<n.length;i++){var r=n[i];if("node"!==r&&"__eventTargets"!==r){var o=e[r];if("object"==typeof o&&o)if(Array.isArray(o))for(var a=0;a<o.length;a++){var s=o[a];s instanceof yu&&JO(s,t)}else if(o.constructor&&o.constructor!==Object)o instanceof yu&&JO(o,t);else for(var c=Object.getOwnPropertyNames(o),l=0;l<c.length;l++){var u=o[c[l]];u instanceof yu&&JO(u,t)}}}}function $O(e,t){for(var n=0;n<e._components.length;n++)ZO(e._components[n],t);for(var i=0;i<e._children.length;i++)$O(e._children[i],t)}function eN(e,t,n,i){n.push(e._uuid);for(var r=Rm.getDeps(e._uuid),o=0,a=r.length;o<a;o++){var s=hl.get(r[o]);if(s){var c=s._uuid;c in t?t[c]+=i:t[c]=s.refCount+i,n.includes(c)||eN(s,t,n,i)}}}var tN=[],nN=new(function(){function e(){this._persistNodeDeps=new cl,this._toDelete=new cl,this._eventListener=!1}var t=e.prototype;return t.init=function(){this._persistNodeDeps.clear(),this._toDelete.clear()},t._addPersistNodeRef=function(e){var t=[];$O(e,t);for(var n=0,i=t.length;n<i;n++){var r=hl.get(t[n]);r&&r.addRef()}this._persistNodeDeps.add(e.uuid,t)},t._removePersistNodeRef=function(e){if(this._persistNodeDeps.has(e.uuid)){for(var t=this._persistNodeDeps.get(e.uuid),n=0,i=t.length;n<i;n++){var r=hl.get(t[n]);r&&r.decRef()}this._persistNodeDeps.remove(e.uuid)}},t._autoRelease=function(e,t,n){if(e){for(var i=Rm.getDeps(e.uuid),r=0,o=i.length;r<o;r++){var a=hl.get(i[r]);a&&a.decRef(e.autoReleaseAssets)}var s=Rm._depends.get(e.uuid);if(s&&s.persistDeps)for(var c=s.persistDeps,l=0,u=c.length;l<u;l++){var h=hl.get(c[l]);h&&h.decRef(e.autoReleaseAssets)}e.uuid!==t.uuid&&Rm.remove(e.uuid)}var _=Rm._depends.get(t.uuid);for(var f in _&&(_.persistDeps=[]),n){for(var d,p,m=n[f],v=this._persistNodeDeps.get(m.uuid),g=S(v);!(p=g()).done;){var y=p.value,x=hl.get(y);x&&x.addRef()}_&&(d=_.persistDeps).push.apply(d,v)}},t.tryRelease=function(e,t){void 0===t&&(t=!1),e instanceof yu&&(t?this._free(e,t):(this._toDelete.add(e._uuid,e),this._eventListener||(this._eventListener=!0,_t(this._freeAssets.bind(this)))))},t._freeAssets=function(){var e=this;this._eventListener=!1,this._toDelete.forEach((function(t){e._free(t)})),this._toDelete.clear()},t._free=function(e,t){void 0===t&&(t=!1);var n=e._uuid;if(this._toDelete.remove(n),sl(e,!0)&&!(!t&&e.refCount>0&&function(e){var t=Object.create(null);if(t[e._uuid]=e.refCount,eN(e,t,tN,-1),tN.length=0,0!==t[e._uuid])return t[e._uuid];for(var n in t)0!==t[n]&&eN(hl.get(n),t,tN,1);return tN.length=0,t[e._uuid]}(e)>0)){hl.remove(n);for(var i=Rm.getDeps(n),r=0,o=i.length;r<o;r++){var a=hl.get(i[r]);a&&(a.decRef(!1),this._free(a,!1))}e.destroy(),Rm.remove(n)}},e}());function iN(e,t){for(var n=0,i=e.input.length;n<i;n++){var r=e.input[n];t&&!r.isNative&&r.content instanceof yu&&r.content.decRef(!1),r.recycle()}e.input=null}function rN(e,t){return t?/\?/.test(e)?e+"&_t="+Date.now():e+"?_t="+Date.now():e}function oN(e,t,n,i,r){void 0===r&&(r=0),e(r,(function(o,a){r++,!o||r>t?i&&i(o,a):setTimeout((function(){oN(e,t,n,i,r)}),n)}))}function aN(e,t,n,i,r){try{for(var o=Rm.parse(e,t),a=0,s=o.deps.length;a<s;a++){var c=o.deps[a];c in n||(n[c]=!0,i.push({uuid:c,bundle:r&&r.name}))}o.nativeDep&&(r&&(o.nativeDep.bundle=r.name),i.push(_({},o.nativeDep)))}catch(e){B(e.message,e.stack)}}function sN(e,t,n){t&&(n=void 0!==n?n:b.assetManager.cacheAsset,Il(t)||!n||t.isDefault||hl.add(e,t))}function cN(e,t,n){var i=0,r=[],o=e.length;0===o&&n&&n(r);for(var a=function(e){e&&r.push(e),++i===o&&n&&n(r)},s=0;s<o;s++)t(e[s],a)}function lN(e,t,n){var i=e,r=t,o=n;if(void 0===n){var a="function"==typeof e;t?(o=t,a||(r=null)):void 0===t&&a&&(o=e,i=null,r=null),void 0!==t&&a&&(r=e,i=null)}return{options:i||Object.create(null),onProgress:r,onComplete:o}}function uN(e,t,n){var i=e,r=t,o=n;if(void 0===n){var a=Ke.isChildClassOf(e,yu);t?(o=t,a&&(r=null)):void 0!==t||a||(o=e,r=null,i=null),void 0===t||a||(r=e,i=null)}return{type:i,onProgress:r||null,onComplete:o}}function hN(e,t,n,i){if(void 0===i&&(i={}),!n[t]||i[t])return!1;i[t]=!0;var r=!1,o=Rm.getDeps(t);if(o)for(var a=0,s=o.length;a<s;a++){var c=o[a];if(c===e||hN(e,c,n,i)){r=!0;break}}return r}function _N(e){return function(t,n){if(e){var i=[];Array.isArray(n)?n.forEach((function(e){return e instanceof yu&&i.push(e.addRef())})):n instanceof yu&&i.push(n.addRef()),_t((function(){i.forEach((function(e){return e.decRef(!1)})),e(t,n)}))}}}var fN=function(){function e(){this._config=new QO}var t=e.prototype;return t.getInfoWithPath=function(e,t){return this._config.getInfoWithPath(e,t)},t.getDirWithPath=function(e,t,n){return this._config.getDirWithPath(e,t,n)},t.getAssetInfo=function(e){return this._config.getAssetInfo(e)},t.getSceneInfo=function(e){return this._config.getSceneInfo(e)},t.init=function(e){this._config.init(e),dl.add(e.name,this)},t.load=function(e,t,n,i){var r=uN(t,n,i),o=r.type,a=r.onProgress,s=r.onComplete,c={__requestType__:ul.PATH,type:o,bundle:this.name,__outputAsArray__:Array.isArray(e)};b.assetManager.loadAny(e,c,a,s)},t.preload=function(e,t,n,i){var r=uN(t,n,i),o=r.type,a=r.onProgress,s=r.onComplete;b.assetManager.preloadAny(e,{__requestType__:ul.PATH,type:o,bundle:this.name},a,s)},t.loadDir=function(e,t,n,i){var r=uN(t,n,i),o=r.type,a=r.onProgress,s=r.onComplete;b.assetManager.loadAny(e,{__requestType__:ul.DIR,type:o,bundle:this.name,__outputAsArray__:!0},a,s)},t.preloadDir=function(e,t,n,i){var r=uN(t,n,i),o=r.type,a=r.onProgress,s=r.onComplete;b.assetManager.preloadAny(e,{__requestType__:ul.DIR,type:o,bundle:this.name},a,s)},t.loadScene=function(e,t,n,i){var r=lN(t,n,i),o=r.options,a=r.onProgress,s=r.onComplete;o.preset=o.preset||"scene",o.bundle=this.name,b.assetManager.loadAny({scene:e},o,a,(function(e,t){if(e)B(e.message,e.stack);else if(t instanceof IR&&t.scene){var n=t.scene;n._id=t._uuid,n.name=t.name}else e=new Error("The asset "+t._uuid+" is not a scene");s&&s(e,t)}))},t.preloadScene=function(e,t,n,i){var r=lN(t,n,i),o=r.options,a=r.onProgress,s=r.onComplete;o.bundle=this.name,b.assetManager.preloadAny({scene:e},o,a,(function(t){t&&Y(1210,e,t.message),s&&s(t)}))},t.get=function(e,t){var n=this.getInfoWithPath(e,t);return n&&hl.get(n.uuid)||null},t.release=function(e,t){var n=this.get(e,t);n&&nN.tryRelease(n,!0)},t.releaseUnusedAssets=function(){var e=this;hl.forEach((function(t){var n=e.getAssetInfo(t._uuid);n&&!n.redirect&&nN.tryRelease(t)}))},t.releaseAll=function(){var e=this;hl.forEach((function(t){var n=e.getAssetInfo(t._uuid);n&&!n.redirect&&nN.tryRelease(t,!0)}))},t._destroy=function(){this._config.destroy()},h(e,[{key:"config",get:function(){return this._config}},{key:"name",get:function(){return this._config.name}},{key:"deps",get:function(){return this._config.deps}},{key:"base",get:function(){return this._config.base}}]),e}(),dN=e("resources",new fN);function pN(e,t,n){var i=new Image;function r(){i.removeEventListener("load",r),i.removeEventListener("error",o),n&&n(null,i)}function o(){i.removeEventListener("load",r),i.removeEventListener("error",o),n&&n(new Error(Z(4930,e)))}return"file:"!==window.location.protocol&&(i.crossOrigin="anonymous"),i.addEventListener("load",r),i.addEventListener("error",o),i.src=e,i}function mN(e,t,n,i){var r=new XMLHttpRequest,o="download failed: "+e+", status: ";if(r.open("GET",e,!0),void 0!==t.xhrResponseType&&(r.responseType=t.xhrResponseType),void 0!==t.xhrWithCredentials&&(r.withCredentials=t.xhrWithCredentials),void 0!==t.xhrMimeType&&r.overrideMimeType&&r.overrideMimeType(t.xhrMimeType),void 0!==t.xhrTimeout&&(r.timeout=t.xhrTimeout),t.xhrHeader)for(var a in t.xhrHeader)r.setRequestHeader(a,t.xhrHeader[a]);return r.onload=function(){200===r.status||0===r.status?i&&i(null,r.response):i&&i(new Error(""+o+r.status+"(no response)"))},n&&(r.onprogress=function(e){e.lengthComputable&&n(e.loaded,e.total)}),r.onerror=function(){i&&i(new Error(""+o+r.status+"(error)"))},r.ontimeout=function(){i&&i(new Error(""+o+r.status+"(time out)"))},r.onabort=function(){i&&i(new Error(""+o+r.status+"(abort)"))},r.send(null),r}b.resources=dN;var vN={};function gN(e,t,n){if(vN[e])return n&&n(null),null;var i=document.createElement("script");function r(){i.parentNode.removeChild(i),i.removeEventListener("load",r,!1),i.removeEventListener("error",o,!1),vN[e]=!0,n&&n(null)}function o(){i.parentNode.removeChild(i),i.removeEventListener("load",r,!1),i.removeEventListener("error",o,!1),n&&n(new Error(Z(4928,e)))}return"file:"!==window.location.protocol&&(i.crossOrigin="anonymous"),i.async=t.scriptAsyncLoading||!1,i.src=e,i.addEventListener("load",r,!1),i.addEventListener("error",o,!1),document.body.appendChild(i),i}var yN=/^(?:\w+:\/\/|\.+\/).+/,xN=function(e,t,n){(Qu.hasFeature(Qu.Feature.IMAGE_BITMAP)&&b.assetManager.allowImageBitmap?SN:pN)(e,t,n)},SN=function(e,t,n){t.xhrResponseType="blob",mN(e,t,t.onFileProgress,n)},EN=function(e,t,n){t.xhrResponseType="json",mN(e,t,t.onFileProgress,n)},TN=function(e,t,n){t.xhrResponseType="arraybuffer",mN(e,t,t.onFileProgress,n)},CN=function(e,t,n){EN(e,t,(function(t,i){if(t)n(t);else{var r=eh(i);Promise.all(r.chunks.map((function(n){return new Promise((function(i,r){TN(""+cu(e)+n,{},(function(e,n){t?r(t):i(new Uint8Array(n))}))}))}))).then((function(e){var t=new $u(r.document,e);n(null,t)})).catch((function(e){n(e)}))}}))},bN=function(e,t,n){TN(e,t,(function(e,t){if(e)n(e);else try{var i=th(new Uint8Array(t));n(null,i)}catch(e){n(e)}}))},AN=function(e,t,n){t.xhrResponseType="text",mN(e,t,t.onFileProgress,n)},wN=function(e,t,n){var i=lu(e),r=e;yN.test(r)||(r=-1!==IN.remoteBundles.indexOf(i)?IN.remoteServerAddress+"remote/"+i:"assets/"+i);var o=t.version||IN.bundleVers[i],a=0,s=null,c=null;EN(r+"/config."+(o?o+".":"")+"json",t,(function(e,t){c=e,(s=t)&&(s.base=r+"/"),2==++a&&n(c,s)})),gN(r+"/index."+(o?o+".":"")+"js",t,(function(e){c=e,2==++a&&n(e,s)}))},IN=new(function(){function e(){this.maxConcurrency=6,this.maxRequestsPerFrame=6,this.maxRetryCount=3,this.appendTimeStamp=!1,this.limited=!0,this.retryInterval=2e3,this.bundleVers=null,this.remoteBundles=[],this.downloadDomImage=pN,this.downloadDomAudio=null,this.downloadFile=mN,this.downloadScript=gN,this._downloaders={".png":xN,".jpg":xN,".bmp":xN,".jpeg":xN,".gif":xN,".ico":xN,".tiff":xN,".webp":xN,".image":xN,".pvr":TN,".pkm":TN,".astc":TN,".txt":AN,".xml":AN,".vsh":AN,".fsh":AN,".atlas":AN,".tmx":AN,".tsx":AN,".json":EN,".ExportJson":EN,".plist":AN,".ccon":CN,".cconb":bN,".fnt":AN,".binary":TN,".bin":TN,".dbbin":TN,".skel":TN,".js":gN,bundle:wN,default:AN},this._downloading=new cl,this._queue=[],this._queueDirty=!1,this._totalNum=0,this._totalNumThisPeriod=0,this._lastDate=-1,this._checkNextPeriod=!1,this._remoteServerAddress="",this._maxInterval=1/30}var t=e.prototype;return t.init=function(e,t,n){void 0===e&&(e=""),void 0===t&&(t={}),void 0===n&&(n=[]),this._downloading.clear(),this._queue.length=0,this._remoteServerAddress=e,this.bundleVers=t,this.remoteBundles=n},t.register=function(e,t){"object"==typeof e?De(this._downloaders,e):this._downloaders[e]=t},t.download=function(e,t,n,i,r){var o=this,a=_l.get(e);if(a)r(null,a);else{var s=this._downloading.get(e);if(s){s.push(r);var c=this._queue.find((function(t){return t.id===e}));if(!c)return;var l=i.priority||0;c.priority<l&&(c.priority=l,this._queueDirty=!0)}else{var u=void 0!==i.maxRetryCount?i.maxRetryCount:this.maxRetryCount,h=void 0!==i.maxConcurrency?i.maxConcurrency:this.maxConcurrency,_=void 0!==i.maxRequestsPerFrame?i.maxRequestsPerFrame:this.maxRequestsPerFrame,f=this._downloaders[n]||this._downloaders.default;oN((function(n,a){if(0===n&&o._downloading.add(e,[r]),o.limited){o._updateTime();var s=function(e,t){o._totalNum--,o._handleQueueInNextFrame(h,_),a(e,t)};o._totalNum<h&&o._totalNumThisPeriod<_?(f(rN(t,o.appendTimeStamp),i,s),o._totalNum++,o._totalNumThisPeriod++):(o._queue.push({id:e,priority:i.priority||0,url:t,options:i,done:s,handler:f}),o._queueDirty=!0,o._totalNum<h&&o._handleQueueInNextFrame(h,_))}else f(rN(t,o.appendTimeStamp),i,a)}),u,this.retryInterval,(function(t,n){t||_l.add(e,n);for(var i=o._downloading.remove(e),r=0,a=i.length;r<a;r++)i[r](t,n)}))}}},t.loadSubpackage=function(e,t){b.assetManager.loadBundle(e,null,t)},t._updateTime=function(){var e=performance.now(),t=b.game.deltaTime,n=t>this._maxInterval?this._maxInterval:t;e-this._lastDate>1e3*n&&(this._totalNumThisPeriod=0,this._lastDate=e)},t._handleQueue=function(e,t){for(this._checkNextPeriod=!1,this._updateTime();this._queue.length>0&&this._totalNum<e&&this._totalNumThisPeriod<t;){this._queueDirty&&(this._queue.sort((function(e,t){return e.priority-t.priority})),this._queueDirty=!1);var n=this._queue.pop();if(!n)break;this._totalNum++,this._totalNumThisPeriod++,n.handler(rN(n.url,this.appendTimeStamp),n.options,n.done)}this._handleQueueInNextFrame(e,t)},t._handleQueueInNextFrame=function(e,t){!this._checkNextPeriod&&this._queue.length>0&&(_t(this._handleQueue.bind(this),e,t),this._checkNextPeriod=!0)},h(e,[{key:"remoteServerAddress",get:function(){return this._remoteServerAddress}}]),e}());function PN(e,t,n,i){var r=null,o=null;try{(r=new Cm)._nativeUrl=e,r._nativeAsset=t}catch(e){o=e}i(o,r)}function RN(e,t,n,i){var r=new MR;r.json=t,i(null,r)}function DN(e,t,n,i){var r=new NR;r.text=t,i(null,r)}function ON(e,t,n,i){var r=new MA;r._nativeUrl=e,r._nativeAsset=t,i(null,r)}function NN(e,t,n,i){var r=new yu;r._nativeUrl=e,r._nativeAsset=t,i(null,r)}function MN(e,n,i,r){var o=dl.get(n.name);o||(o=n.name===gl.RESOURCES?dN:new fN,n.base=n.base||e+"/",o.init(n)),t.import("virtual:///prerequisite-imports/"+o.name).then((function(){r(null,o)})).catch(r)}var LN=new(function(){function e(){this._creating=new cl,this._producers={".png":PN,".jpg":PN,".bmp":PN,".jpeg":PN,".gif":PN,".ico":PN,".tiff":PN,".webp":PN,".image":PN,".pvr":PN,".pkm":PN,".txt":DN,".xml":DN,".vsh":DN,".fsh":DN,".atlas":DN,".tmx":DN,".tsx":DN,".fnt":DN,".json":RN,".ExportJson":RN,".binary":ON,".bin":ON,".dbbin":ON,".skel":ON,bundle:MN,default:NN}}var t=e.prototype;return t.register=function(e,t){"object"==typeof e?Ke.mixin(this._producers,e):this._producers[e]=t},t.create=function(e,t,n,i,r){var o=this,a=this._producers[n]||this._producers.default,s=hl.get(e);if(i.reloadAsset||!s){var c=this._creating.get(e);c?c.push(r):(this._creating.add(e,[r]),a(e,t,i,(function(t,n){!t&&n instanceof yu&&(n._uuid=e,sN(e,n,i.cacheAsset));for(var r=o._creating.remove(e),a=0,s=r.length;a<s;a++)r[a](t,n)})))}else r(null,s)},e}()),FN=new(function(){function e(){this._loading=new cl,this._unpackers={".json":this.unpackJson}}var t=e.prototype;return t.unpackJson=function(e,t,n,i){var r=Ke.createMap(!0),o=null;if(Array.isArray(t)){(t=function(e){if(e[0]<1)throw new Error(Z(5304,e[0]));Sh(e,!0,void 0,Th.reportMissingClass),Eh(e);for(var t=new Ch(e[0]),n=e[1],i=e[2],r=e[3],o=e[4],a=e[5],s=0;s<a.length;++s)a[s].unshift(t,n,i,r,o);return a}(t)).length!==e.length&&Y(4915);for(var a=0;a<e.length;a++)r[e[a]+"@import"]=t[a]}else{var s=Ke._getClassId(Xm),c=Ke._getClassId(Cm);if(t.type===s&&t.data){var l=t.data;l.length!==e.length&&Y(4915);for(var u=0;u<e.length;u++)r[e[u]+"@import"]=bh(s,{base:l[u][0],mipmaps:l[u][1]})}else if(t.type===c&&t.data){var h=t.data;h.length!==e.length&&Y(4915);for(var _=0;_<e.length;_++)r[e[_]+"@import"]=h[_]}else o=new Error("unmatched type pack!"),r=null}i(o,r)},t.init=function(){this._loading.clear()},t.register=function(e,t){"object"==typeof e?Ke.mixin(this._unpackers,e):this._unpackers[e]=t},t.unpack=function(e,t,n,i,r){t?(0,this._unpackers[n])(e,t,i,r):r(new Error("package data is wrong!"))},t.load=function(e,t,n){var i=this;if(!e.isNative&&e.info&&e.info.packs)if(_l.has(e.id))n(null,_l.get(e.id));else{var r=e.info.packs,o=r.find((function(e){return i._loading.has(e.uuid)}));if(o)this._loading.get(o.uuid).push({onComplete:n,id:e.id});else{o=r[0],this._loading.add(o.uuid,[{onComplete:n,id:e.id}]);var a=Rl(o.uuid,{ext:o.ext,bundle:e.config.name});IN.download(o.uuid,a,o.ext,e.options,(function(t,n){_l.remove(o.uuid),t&&B(t.message,t.stack),i.unpack(o.packedUuids,n,o.ext,e.options,(function(e,n){if(!e)for(var r in n)_l.add(r,n[r]);for(var a=i._loading.remove(o.uuid),s=0,c=a.length;s<c;s++){var l=a[s];if(t||e)l.onComplete(t||e);else{var u=n[l.id];u?l.onComplete(null,u):l.onComplete(new Error("can not retrieve data from package"))}}}))}))}}else IN.download(e.id,e.url,e.ext,e.options,n)},e}());function BN(e,t){var n=!1;e.progress||(e.progress={finish:0,total:e.input.length,canInvoke:!0},n=!0);var i=e.options,r=e.progress,o=[],a=r.total,s=i.__exclude__=i.__exclude__||Object.create(null);e.output=[],cN(e.input,(function(i,c){if(!i.isNative&&hl.has(i.uuid)){var l=hl.get(i.uuid);return i.content=l.addRef(),e.output.push(i),r.canInvoke&&e.dispatch("progress",++r.finish,r.total,i),void c()}FN.load(i,e.options,(function(l,u){l?e.isFinish||(!b.assetManager.force||n?(B(l.message,l.stack),r.canInvoke=!1,t(l)):(e.output.push(i),r.canInvoke&&e.dispatch("progress",++r.finish,r.total,i))):e.isFinish||(i.file=u,e.output.push(i),i.isNative||(s[i.uuid]=!0,aN(i.uuid,u,s,o,i.config),r.total=a+o.length),r.canInvoke&&e.dispatch("progress",++r.finish,r.total,i)),c()}))}),(function(){if(e.isFinish)return iN(e,!0),void e.dispatch("error");if(o.length>0){var a=xl.create({input:o,progress:r,options:i,onProgress:e.onProgress,onError:xl.prototype.recycle,onComplete:function(i){var r;i||((r=e.output).push.apply(r,a.output),a.recycle()),n&&zN(e),t(i)}});ml.async(a)}else n&&zN(e),t()}))}function zN(e){for(var t=e.output,n=0,i=t.length;n<i;n++)t[n].content&&t[n].content.decRef(!1)}var UN=new(function(e){function t(){return e.apply(this,arguments)||this}f(t,e);var n=t.prototype;return n.parse=function(e){var t=this._parseXML(e).documentElement;if("plist"!==t.tagName)return q(5100),{};for(var n=null,i=0,r=t.childNodes.length;i<r&&1!==(n=t.childNodes[i]).nodeType;i++);return this._parseNode(n)},n._parseNode=function(e){var t=null,n=e.tagName;if("dict"===n)t=this._parseDict(e);else if("array"===n)t=this._parseArray(e);else if("string"===n)if(1===e.childNodes.length)t=e.firstChild.nodeValue;else{t="";for(var i=0;i<e.childNodes.length;i++)t+=e.childNodes[i].nodeValue}else"false"===n?t=!1:"true"===n?t=!0:"real"===n?t=parseFloat(e.firstChild.nodeValue):"integer"===n&&(t=parseInt(e.firstChild.nodeValue,10));return t},n._parseArray=function(e){for(var t=[],n=0,i=e.childNodes.length;n<i;n++){var r=e.childNodes[n];1===r.nodeType&&t.push(this._parseNode(r))}return t},n._parseDict=function(e){for(var t={},n="",i=0,r=e.childNodes.length;i<r;i++){var o=e.childNodes[i];1===o.nodeType&&("key"===o.tagName?n=o.firstChild.nodeValue:t[n]=this._parseNode(o))}return t},t}(function(){function e(){this._parser=null,window.DOMParser&&(this._parser=new DOMParser)}var t=e.prototype;return t.parse=function(e){return this._parseXML(e)},t._parseXML=function(e){if(this._parser)return this._parser.parseFromString(e,"text/xml");throw new Error("Dom parser is not supported in this platform!")},e}()));function kN(e,t){return e[t]<<8|e[t+1]}var GN=new(function(){function e(){this._parsing=new cl,this._parsers={".png":this.parseImage,".jpg":this.parseImage,".bmp":this.parseImage,".jpeg":this.parseImage,".gif":this.parseImage,".ico":this.parseImage,".tiff":this.parseImage,".webp":this.parseImage,".image":this.parseImage,".pvr":this.parsePVRTex,".pkm":this.parsePKMTex,".astc":this.parseASTCTex,".plist":this.parsePlist,import:this.parseImport,".ccon":this.parseImport,".cconb":this.parseImport}}var t=e.prototype;return t.parseImage=function(e,t,n){e instanceof HTMLImageElement?n(null,e):createImageBitmap(e,{premultiplyAlpha:"none"}).then((function(e){n(null,e)}),(function(e){n(e,null)}))},t.parsePVRTex=function(e,t,n){var i=null,r=null;try{var o=e instanceof ArrayBuffer?e:e.buffer,a=new Int32Array(o,0,13);if(55727696===a[0]){var s=a[7],c=a[6],l=a[12]+52;r={_data:new Uint8Array(o,l),_compressed:!0,width:s,height:c,format:0}}else{if(559044176!==a[11])throw new Error("Invalid magic number in PVR header");var u=a[0],h=a[1],_=a[2];r={_data:new Uint8Array(o,u),_compressed:!0,width:_,height:h,format:0}}}catch(e){i=e}n(i,r)},t.parsePKMTex=function(e,t,n){var i=null,r=null;try{var o=e instanceof ArrayBuffer?e:e.buffer,a=new Uint8Array(o),s=kN(a,6);if(0!==s&&1!==s&&3!==s)throw new Error("Invalid magic number in ETC header");var c=kN(a,12),l=kN(a,14);kN(a,8),kN(a,10),r={_data:new Uint8Array(o,16),_compressed:!0,width:c,height:l,format:0}}catch(e){i=e}n(i,r)},t.parseASTCTex=function(e,t,n){var i=null,r=null;try{var o=e instanceof ArrayBuffer?e:e.buffer,a=new Uint8Array(o);if(1554098963!==a[0]+(a[1]<<8)+(a[2]<<16)+(a[3]<<24))throw new Error("Invalid magic number in ASTC header");var s=a[4],c=a[5],l=a[6];if((s<3||s>6||c<3||c>6||l<3||l>6)&&(s<4||7===s||9===s||11===s||s>12||c<4||7===c||9===c||11===c||c>12||1!==l))throw new Error("Invalid block number in ASTC header");var u=function(e,t){return 4===e?tm.RGBA_ASTC_4x4:5===e?4===t?tm.RGBA_ASTC_5x4:tm.RGBA_ASTC_5x5:6===e?5===t?tm.RGBA_ASTC_6x5:tm.RGBA_ASTC_6x6:8===e?5===t?tm.RGBA_ASTC_8x5:6===t?tm.RGBA_ASTC_8x6:tm.RGBA_ASTC_8x8:10===e?5===t?tm.RGBA_ASTC_10x5:6===t?tm.RGBA_ASTC_10x6:8===t?tm.RGBA_ASTC_10x8:tm.RGBA_ASTC_10x10:10===t?tm.RGBA_ASTC_12x10:tm.RGBA_ASTC_12x12}(s,c),h=a[7]+(a[8]<<8)+(a[9]<<16),_=a[10]+(a[11]<<8)+(a[12]<<16);a[13],a[14],a[15],r={_data:new Uint8Array(o,16),_compressed:!0,width:h,height:_,format:u}}catch(e){i=e}n(i,r)},t.parsePlist=function(e,t,n){var i=null,r=UN.parse(e);r||(i=new Error("parse failed")),n(i,r)},t.parseImport=function(e,t,n){if(e){var i=null,r=null;try{i=Im(e,t)}catch(e){r=e}n(r,i)}else n(new Error("The json file of asset "+t.__uuid__+" is empty or missing"))},t.init=function(){this._parsing.clear()},t.register=function(e,t){"object"==typeof e?De(this._parsers,e):this._parsers[e]=t},t.parse=function(e,t,n,i,r){var o=this,a=fl.get(e);if(a)r(null,a);else{var s=this._parsing.get(e);if(s)s.push(r);else{var c=this._parsers[n];c?(this._parsing.add(e,[r]),c(t,i,(function(t,n){t?_l.remove(e):Il(n)||fl.add(e,n);for(var i=o._parsing.remove(e),r=0,a=i.length;r<a;r++)i[r](t,n)}))):r(null,t)}}},e}());function HN(e,t){var n=!1;e.progress||(e.progress={finish:0,total:e.input.length,canInvoke:!0},n=!0);var i=e.options,r=e.progress;i.__exclude__=i.__exclude__||Object.create(null),e.output=[],cN(e.input,(function(o,a){var s=xl.create({input:o,onProgress:e.onProgress,options:i,progress:r,onComplete:function(i,c){i&&!e.isFinish&&(!b.assetManager.force||n?(B(i.message,i.stack),r.canInvoke=!1,t(i)):r.canInvoke&&e.dispatch("progress",++r.finish,r.total,o)),e.output.push(c),s.recycle(),a(null)}});VN.async(s)}),(function(){if(i.__exclude__=null,e.isFinish)return iN(e,!0),void e.dispatch("error");!function(e){var t=e.source;if(e.options.__outputAsArray__||1!==t.length)for(var n=e.output=[],i=0,r=t.length;i<r;i++)n.push(t[i].content);else e.output=t[0].content}(e),iN(e,!0),t()}))}var VN=new ll("loadOneAsset",[function(e,t){var n=e.output=e.input,i=n.options,r=n.isNative,o=n.uuid,a=n.file,s=i.reloadAsset;a||!s&&!r&&hl.has(o)?t():FN.load(n,e.options,(function(e,i){n.file=i,t(e)}))},function(e,t){var n=e.output=e.input,i=e.progress,r=e.options.__exclude__,o=n.id,a=n.file,s=n.options;if(n.isNative)GN.parse(o,a,n.ext,s,(function(r,a){r?t(r):(n.content=a,i.canInvoke&&e.dispatch("progress",++i.finish,i.total,n),_l.remove(o),fl.remove(o),t())}));else{var c=n.uuid;if(c in r){var l=r[c],u=l.finish,h=l.content,_=l.err,f=l.callbacks;i.canInvoke&&e.dispatch("progress",++i.finish,i.total,n),u||hN(c,c,r)?(h&&h.addRef(),n.content=h,t(_)):f.push({done:t,item:n})}else if(!s.reloadAsset&&hl.has(c)){var d=hl.get(c);n.content=d.addRef(),i.canInvoke&&e.dispatch("progress",++i.finish,i.total,n),t()}else s.__uuid__=c,GN.parse(o,a,"import",s,(function(n,i){n?t(n):function(e,t,n){var i=e.input,r=e.progress,o=i,a=o.uuid,s=o.id,c=o.options,l=o.config,u=c.cacheAsset,h=[];t.addRef&&t.addRef(),aN(a,t,Object.create(null),h,l),r.canInvoke&&e.dispatch("progress",++r.finish,r.total+=h.length,i);var _=e.options.__exclude__[a]={content:t,finish:!1,callbacks:[{done:n,item:i}]},f=xl.create({input:h,options:e.options,onProgress:e.onProgress,onError:xl.prototype.recycle,progress:r,onComplete:function(e){if(t.decRef&&t.decRef(!1),_.finish=!0,_.err=e,!e){for(var n,i=Array.isArray(f.output)?f.output:[f.output],r=Object.create(null),o=S(i);!(n=o()).done;){var c=n.value;c&&(r[c instanceof yu?c._uuid+"@import":a+"@native"]=c)}!function(e,t,n){var i=bm.get(t);if(i){for(var r=0,o=i.length;r<o;r++){var a=i[r],s=n[a.uuid+"@import"];if(s)a.owner[a.prop]=s.addRef();else{if(B("The asset "+a.uuid+" is missing!"),a.type&&a.type!==yu){var c=new a.type;c.initDefault(a.uuid),a.owner[a.prop]=c}!0}}bm.delete(t)}Am.has(t)&&(n[e+"@native"]?t._nativeAsset=n[e+"@native"]:(!0,console.error("the native asset of "+e+" is missing!")),Am.delete(t))}(a,t,r);try{"function"!=typeof t.onLoaded||wm.has(t)||Am.has(t)||(t.onLoaded(),wm.add(t))}catch(e){B("The asset "+a+" is invalid for some reason, detail message: "+e.message+", stack: "+e.stack)}_l.remove(s),fl.remove(s),sN(a,t,u),f.recycle()}for(var l=_.callbacks,h=0,d=l.length;h<d;h++){var p=l[h];t.addRef&&t.addRef(),p.item.content=t,p.done(e)}l.length=0}});pl.async(f)}(e,i,t)}))}}]);function WN(e,t){var n=e.options,i=Object.create(null),r=Object.create(null);for(var o in n)switch(o){case ul.PATH:case ul.UUID:case ul.DIR:case ul.SCENE:case ul.URL:break;case"__requestType__":case"__isNative__":case"ext":case"type":case"__nativeName__":case"audioLoadMode":case"bundle":i[o]=n[o];break;case"__exclude__":case"__outputAsArray__":r[o]=n[o];break;default:i[o]=n[o],r[o]=n[o]}e.options=r;var a=xl.create({input:e.input,options:i}),s=null;try{e.output=e.source=vl.sync(a)}catch(e){s=e;for(var c=0,l=a.output.length;c<l;c++)a.output[c].recycle()}a.recycle(),t(s)}var jN=function(){function e(){this.uuid="",this.url="",this.ext=".json",this.content=null,this.file=null,this.info=null,this.config=null,this.isNative=!1,this.options=Object.create(null),this._id=""}return e.create=function(){return 0!==e._deadPool.length?e._deadPool.pop():new e},e.prototype.recycle=function(){e._deadPool.length!==e.MAX_DEAD_NUM&&(this._id="",this.uuid="",this.url="",this.ext=".json",this.content=null,this.file=null,this.info=null,this.config=null,this.isNative=!1,this.options=Object.create(null),e._deadPool.push(this))},h(e,[{key:"id",get:function(){return this._id||(this._id=this.uuid+"@"+(this.isNative?"native":"import")),this._id}}]),e}();jN.MAX_DEAD_NUM=500,jN._deadPool=[];var qN=[];function XN(e){var t=e.options,n=Array.isArray(e.input)?e.input:[e.input];e.output=[];for(var i=function(i){var r,o=n[i],a=jN.create(),s=null,c=null;if("string"==typeof o&&((o=Object.create(null))[t.__requestType__||ul.UUID]=n[i]),"object"==typeof o)for(var l in Re(o,t),o.preset&&Re(o,yl[o.preset]),o){switch(l){case ul.UUID:if("break"===function(){var e,t=a.uuid=bl(o.uuid);if(!o.bundle){var n=dl.find((function(e){return!!e.getAssetInfo(t)}));o.bundle=n&&n.name}if(dl.has(o.bundle)){if(s=dl.get(o.bundle).config,(c=s.getAssetInfo(t))&&c.redirect){if(!dl.has(c.redirect))throw new Error("Please load bundle "+c.redirect+" first");s=dl.get(c.redirect).config,c=s.getAssetInfo(t)}a.config=s,a.info=c}return a.ext=o.ext||(null===(e=c)||void 0===e?void 0:e.extension)||".json","break"}())break;case"__requestType__":case"ext":case"bundle":case"preset":case"type":break;case ul.DIR:if(dl.has(o.bundle)){dl.get(o.bundle).config.getDirWithPath(o.dir,o.type,qN);for(var u,h=S(qN);!(u=h()).done;){var _=u.value;n.push({uuid:_.uuid,__isNative__:!1,ext:_.extension||".json",bundle:o.bundle})}qN.length=0}a.recycle(),a=null;break;case ul.PATH:if(dl.has(o.bundle)){if(s=dl.get(o.bundle).config,(c=s.getInfoWithPath(o.path,o.type))&&c.redirect){if(!dl.has(c.redirect))throw new Error("you need to load bundle "+c.redirect+" first");s=dl.get(c.redirect).config,c=s.getAssetInfo(c.uuid)}if(!c)throw a.recycle(),new Error("Bundle "+o.bundle+" doesn't contain "+o.path);a.config=s,a.uuid=c.uuid,a.info=c}a.ext=o.ext||(null===(r=c)||void 0===r?void 0:r.extension)||".json";break;case ul.SCENE:if(!o.bundle){var f=dl.find((function(e){return!!e.getSceneInfo(o.scene)}));o.bundle=f&&f.name}if(dl.has(o.bundle)){if(s=dl.get(o.bundle).config,(c=s.getSceneInfo(o.scene))&&c.redirect){if(!dl.has(c.redirect))throw new Error("you need to load bundle "+c.redirect+" first");s=dl.get(c.redirect).config,c=s.getAssetInfo(c.uuid)}if(!c)throw a.recycle(),new Error("Bundle "+s.name+" doesn't contain scene "+o.scene);a.config=s,a.uuid=c.uuid,a.info=c}break;case"__isNative__":a.isNative=o.__isNative__;break;case ul.URL:a.url=o.url,a.uuid=o.uuid||o.url,a.ext=o.ext||su(o.url),a.isNative=void 0===o.__isNative__||o.__isNative__;break;default:a.options[l]=o[l]}if(!a)break}if(!a)return"continue";if(e.output.push(a),!a.uuid&&!a.url)throw new Error("Can not parse this input:"+JSON.stringify(o))},r=0;r<n.length;r++)i(r);return null}function YN(e){for(var t=e.output=e.input,n=0;n<t.length;n++){var i=t[n];if(!i.url){var r,o,a=i.config;o=i.isNative?a&&a.nativeBase?a.base+a.nativeBase:b.assetManager.generalNativeBase:a&&a.importBase?a.base+a.importBase:b.assetManager.generalImportBase;var s=i.uuid,c="";i.info&&(c=i.isNative?i.info.nativeVer?"."+i.info.nativeVer:"":i.info.ver?"."+i.info.ver:""),r=".ttf"===i.ext?o+"/"+s.slice(0,2)+"/"+s+c+"/"+i.options.__nativeName__:o+"/"+s.slice(0,2)+"/"+s+c+i.ext,i.url=r}}return null}var KN,QN,JN,ZN,$N,eM,tM,nM,iM,rM,oM,aM,sM,cM,lM=e("AssetManager",function(){function e(){this.pipeline=pl.append(WN).append(HN),this.fetchPipeline=ml.append(WN).append(BN),this.transformPipeline=vl.append(XN).append(YN),this.bundles=dl,this.assets=hl,this.generalImportBase="",this.generalNativeBase="",this.dependUtil=Rm,this.force=!1,this.allowImageBitmap=!Qu.isMobile,this.utils=Dl,this.downloader=IN,this.parser=GN,this.packManager=FN,this.cacheAsset=!0,this.cacheManager=null,this.presets=yl,this.factory=LN,this.preprocessPipe=WN,this.fetchPipe=BN,this.loadPipe=HN,this.references=null,this._releaseManager=nN,this._files=_l,this._parsed=fl,this._parsePipeline=null}var t=e.prototype;return t.init=function(e){void 0===e&&(e={}),this._files.clear(),this._parsed.clear(),this._releaseManager.init(),this.assets.clear(),this.bundles.clear(),this.packManager.init(),this.downloader.init(e.server,e.bundleVers,e.remoteBundles),this.parser.init(),this.dependUtil.init();var t=e.importBase||"";t&&t.endsWith("/")&&(t=t.substr(0,t.length-1));var n=e.nativeBase||"";n&&n.endsWith("/")&&(n=n.substr(0,n.length-1)),this.generalImportBase=t,this.generalNativeBase=n},t.getBundle=function(e){return dl.get(e)||null},t.removeBundle=function(e){e._destroy(),dl.remove(e.name)},t.loadAny=function(e,t,n,i){var r=lN(t,n,i),o=r.options,a=r.onProgress,s=r.onComplete;o.preset=o.preset||"default",e=Array.isArray(e)?e.slice():e;var c=xl.create({input:e,onProgress:a,onComplete:_N(s),options:o});pl.async(c)},t.preloadAny=function(e,t,n,i){var r=lN(t,n,i),o=r.options,a=r.onProgress,s=r.onComplete;o.preset=o.preset||"preload",e=Array.isArray(e)?e.slice():e;var c=xl.create({input:e,onProgress:a,onComplete:_N(s),options:o});ml.async(c)},t.loadRemote=function(e,t,n){var i=lN(t,void 0,n),r=i.options,o=i.onComplete;r.reloadAsset||!this.assets.has(e)?(r.__isNative__=!0,r.preset=r.preset||"remote",this.loadAny({url:e},r,null,(function(t,n){t?(B(t.message,t.stack),o&&o(t,n)):LN.create(e,n,r.ext||su(e),r,(function(e,t){o&&o(e,t)}))}))):_N(o)(null,this.assets.get(e))},t.loadBundle=function(e,t,n){var i=lN(t,void 0,n),r=i.options,o=i.onComplete,a=lu(e);this.bundles.has(a)?_N(o)(null,this.getBundle(a)):(r.preset=r.preset||"bundle",r.ext="bundle",r.__isNative__=!0,this.loadAny({url:e},r,null,(function(t,n){t?(B(t.message,t.stack),o&&o(t,n)):LN.create(e,n,"bundle",r,(function(e,t){o&&o(e,t)}))})))},t.releaseAsset=function(e){nN.tryRelease(e,!0)},t.releaseUnusedAssets=function(){hl.forEach((function(e){nN.tryRelease(e)}))},t.releaseAll=function(){hl.forEach((function(e){nN.tryRelease(e,!0)}))},t.loadWithJson=function(){throw new Error("Only valid in Editor")},h(e,[{key:"main",get:function(){return dl.get(gl.MAIN)||null}},{key:"resources",get:function(){return dl.get(gl.RESOURCES)||null}}]),e}());lM.Pipeline=ll,lM.Task=xl,lM.Cache=cl,lM.RequestItem=jN,lM.Bundle=fN,lM.BuiltinBundleName=gl,e("assetManager",b.assetManager=new lM),b.AssetManager=lM;var uM,hM,_M,fM,dM,pM,mM,vM,gM,yM,xM,SM,EM,TM,CM,bM,AM,wM,IM,PM,RM,DM,OM,NM,MM,LM,FM,BM,zM,UM,kM,GM,HM,VM,WM,jM,qM,XM,YM,KM,QM,JM,ZM,$M,eL,tL,nL,iL,rL,oL,aL,sL,cL,lL,uL,hL,_L,fL,dL,pL,mL,vL,gL,yL,xL,SL,EL,TL,CL,bL,AL=e("EventHandler",(KN=dc("cc.ClickEvent"),QN=Jc(b.Node),JN=Bc(),ZN=Bc(),$N=Bc(),eM=Bc(),KN((cM=function(){function e(){E(this,"target",iM,this),E(this,"component",rM,this),E(this,"_componentId",oM,this),E(this,"handler",aM,this),E(this,"customEventData",sM,this)}e.emitEvents=function(t){for(var n=arguments.length,i=new Array(n>1?n-1:0),r=1;r<n;r++)i[r-1]=arguments[r];for(var o=0,a=t.length;o<a;o++){var s=t[o];s instanceof e&&s.emit(i)}};var t=e.prototype;return t.emit=function(e){var t=this.target;if(b.isValid(t)){this._genCompIdIfNeeded();var n=b.js._getClassById(this._componentId),i=t.getComponent(n);if(b.isValid(i)){var r=i[this.handler];"function"==typeof r&&(null!=this.customEventData&&""!==this.customEventData&&(e=e.slice()).push(this.customEventData),r.apply(i,e))}}},t._compName2Id=function(e){var t=b.js.getClassByName(e);return b.js._getClassId(t)},t._compId2Name=function(e){var t=b.js._getClassById(e);return b.js.getClassName(t)},t._genCompIdIfNeeded=function(){this._componentId||(this._componentName=this.component,this.component="")},h(e,[{key:"_componentName",get:function(){return this._genCompIdIfNeeded(),this._compId2Name(this._componentId)},set:function(e){this._componentId=this._compName2Id(e)}}]),e}(),iM=T((nM=cM).prototype,"target",[Ec,QN,Ec,JN],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),rM=T(nM.prototype,"component",[Ec,Nc,ZN],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),oM=T(nM.prototype,"_componentId",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),aM=T(nM.prototype,"handler",[Ec,Nc,$N],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),sM=T(nM.prototype,"customEventData",[Ec,Nc,eM],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),tM=nM))||tM));b.Component.EventHandler=AL;var wL,IL,PL,RL,DL,OL,NL,ML,LL,FL=new yn,BL=Je(wv),zL=Je(Av),UL=Je(Iv),kL=Je(Rv),GL=Je(Pv),HL=Je({SKYBOX:Uv|Hi.DEPTH_STENCIL,SOLID_COLOR:Hi.ALL,DEPTH_ONLY:Hi.DEPTH_STENCIL,DONT_CLEAR:Hi.NONE}),VL=e("Camera",(uM=dc("cc.Camera"),hM=Oc(),_M=Ic(),fM=Vc(),dM=Bc(),pM=Jc(rd.BitMask),mM=Vc(),vM=Bc(),gM=Jc(HL),yM=Vc(),xM=Bc(),SM=Vc(),EM=Bc(),TM=Vc(),CM=Bc(),bM=Vc(),AM=Bc(),wM=Jc(BL),IM=Vc(),PM=Bc(),RM=Jc(zL),DM=Vc(),OM=Mc(),NM=Bc(),MM=Vc(),LM=Mc(),FM=Bc(),BM=Vc(),zM=Mc(),UM=Bc(),kM=Vc(),GM=Bc(),HM=Vc(),VM=Bc(),WM=Jc(UL),jM=Vc(),qM=Bc(),XM=Jc(kL),YM=Vc(),KM=Bc(),QM=Jc(GL),JM=Vc(),ZM=Bc(),$M=Vc(),eL=Bc(),tL=Jc(_E),nL=Vc(),iL=Bc(),uM(rL=hM(rL=_M(rL=wc((bL=CL=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return E(t=e.call.apply(e,[this].concat(i))||this,"_projection",aL,y(t)),E(t,"_priority",sL,y(t)),E(t,"_fov",cL,y(t)),E(t,"_fovAxis",lL,y(t)),E(t,"_orthoHeight",uL,y(t)),E(t,"_near",hL,y(t)),E(t,"_far",_L,y(t)),E(t,"_color",fL,y(t)),E(t,"_depth",dL,y(t)),E(t,"_stencil",pL,y(t)),E(t,"_clearFlags",mL,y(t)),E(t,"_rect",vL,y(t)),E(t,"_aperture",gL,y(t)),E(t,"_shutter",yL,y(t)),E(t,"_iso",xL,y(t)),E(t,"_screenScale",SL,y(t)),E(t,"_visibility",EL,y(t)),E(t,"_targetTexture",TL,y(t)),t._camera=null,t._inEditorMode=!1,t._flows=void 0,t}f(t,e);var n=t.prototype;return n.onLoad=function(){this._createCamera()},n.onEnable=function(){this.node.hasChangedFlags|=Zg.POSITION,this._camera&&this._attachToScene()},n.onDisable=function(){this._camera&&this._detachFromScene()},n.onDestroy=function(){this._camera&&(this._camera.destroy(),this._camera=null),this._targetTexture&&this._targetTexture.off("resize")},n.screenPointToRay=function(e,t,n){return n||(n=Xo.create()),this._camera&&this._camera.screenPointToRay(n,e,t),n},n.worldToScreen=function(e,t){return t||(t=new yn),this._camera&&this._camera.worldToScreen(t,e),t},n.screenToWorld=function(e,t){return t||(t=this.node.getWorldPosition()),this._camera&&this._camera.screenToWorld(t,e),t},n.convertToUINode=function(e,t,n){if(n||(n=new yn),!this._camera)return n;this.worldToScreen(e,FL);var i=t.getComponent("cc.UITransform"),r=BO.getVisibleSize(),o=FL.x-.5*this._camera.width,a=FL.y-.5*this._camera.height;return FL.x=o/b.view.getScaleX()+.5*r.width,FL.y=a/b.view.getScaleY()+.5*r.height,i&&i.convertToNodeSpaceAR(FL,n),n},n._createCamera=function(){this._camera||(this._camera=b.director.root.createCamera(),this._camera.initialize({name:this.node.name,node:this.node,projection:this._projection,window:this._inEditorMode?b.director.root&&b.director.root.mainWindow:b.director.root&&b.director.root.tempWindow,priority:this._priority}),this._camera.setViewportInOrientedSpace(this._rect),this._camera.fovAxis=this._fovAxis,this._camera.fov=rn(this._fov),this._camera.orthoHeight=this._orthoHeight,this._camera.nearClip=this._near,this._camera.farClip=this._far,this._camera.clearColor=this._color,this._camera.clearDepth=this._depth,this._camera.clearStencil=this._stencil,this._camera.clearFlag=this._clearFlags,this._camera.visibility=this._visibility,this._camera.aperture=this._aperture,this._camera.shutter=this._shutter,this._camera.iso=this._iso),this._updateTargetTexture()},n._attachToScene=function(){this.node.scene&&this._camera&&(this._camera&&this._camera.scene&&this._camera.scene.removeCamera(this._camera),this._getRenderScene().addCamera(this._camera))},n._detachFromScene=function(){this._camera&&this._camera.scene&&this._camera.scene.removeCamera(this._camera)},n._checkTargetTextureEvent=function(e){var t=this;e&&e.off("resize"),this._targetTexture&&this._targetTexture.on("resize",(function(e){t._camera&&t._camera.setFixedSize(e.width,e.height)}),this)},n._updateTargetTexture=function(){if(this._camera&&this._targetTexture){var e=this._targetTexture.window;this._camera.changeTargetWindow(e),this._camera.setFixedSize(e.width,e.height)}},h(t,[{key:"camera",get:function(){return this._camera}},{key:"priority",get:function(){return this._priority},set:function(e){this._priority=e,this._camera&&(this._camera.priority=e)}},{key:"visibility",get:function(){return this._visibility},set:function(e){this._visibility=e,this._camera&&(this._camera.visibility=e)}},{key:"clearFlags",get:function(){return this._clearFlags},set:function(e){this._clearFlags=e,this._camera&&(this._camera.clearFlag=e)}},{key:"clearColor",get:function(){return this._color},set:function(e){this._color.set(e),this._camera&&(this._camera.clearColor=this._color)}},{key:"clearDepth",get:function(){return this._depth},set:function(e){this._depth=e,this._camera&&(this._camera.clearDepth=e)}},{key:"clearStencil",get:function(){return this._stencil},set:function(e){this._stencil=e,this._camera&&(this._camera.clearStencil=e)}},{key:"projection",get:function(){return this._projection},set:function(e){this._projection=e,this._camera&&(this._camera.projectionType=e)}},{key:"fovAxis",get:function(){return this._fovAxis},set:function(e){e!==this._fovAxis&&(this._fovAxis=e,this._camera&&(this._camera.fovAxis=e,e===Av.VERTICAL?this.fov=this._fov*this._camera.aspect:this.fov=this._fov/this._camera.aspect))}},{key:"fov",get:function(){return this._fov},set:function(e){this._fov=e,this._camera&&(this._camera.fov=rn(e))}},{key:"orthoHeight",get:function(){return this._orthoHeight},set:function(e){this._orthoHeight=e,this._camera&&(this._camera.orthoHeight=e)}},{key:"near",get:function(){return this._near},set:function(e){this._near=e,this._camera&&(this._camera.nearClip=e)}},{key:"far",get:function(){return this._far},set:function(e){this._far=e,this._camera&&(this._camera.farClip=e)}},{key:"aperture",get:function(){return this._aperture},set:function(e){this._aperture=e,this._camera&&(this._camera.aperture=e)}},{key:"shutter",get:function(){return this._shutter},set:function(e){this._shutter=e,this._camera&&(this._camera.shutter=e)}},{key:"iso",get:function(){return this._iso},set:function(e){this._iso=e,this._camera&&(this._camera.iso=e)}},{key:"rect",get:function(){return this._rect},set:function(e){this._rect=e,this._camera&&this._camera.setViewportInOrientedSpace(e)}},{key:"targetTexture",get:function(){return this._targetTexture},set:function(e){if(this._targetTexture!==e){var n=this._targetTexture;this._targetTexture=e,this._checkTargetTextureEvent(n),this._updateTargetTexture(),!e&&this._camera&&(this._camera.changeTargetWindow(null),this._camera.isWindowSize=!0),this.node.emit(t.TARGET_TEXTURE_CHANGE,this)}}},{key:"screenScale",get:function(){return this._screenScale},set:function(e){this._screenScale=e,this._camera&&(this._camera.screenScale=e)}},{key:"inEditorMode",get:function(){return this._inEditorMode},set:function(e){this._inEditorMode=e,this._camera&&this._camera.changeTargetWindow(e?b.director.root&&b.director.root.mainWindow:b.director.root&&b.director.root.tempWindow)}}]),t}(ku),CL.ProjectionType=BL,CL.FOVAxis=zL,CL.ClearFlag=HL,CL.Aperture=UL,CL.Shutter=kL,CL.ISO=GL,CL.TARGET_TEXTURE_CHANGE="tex-change",aL=T((oL=bL).prototype,"_projection",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return BL.PERSPECTIVE}}),sL=T(oL.prototype,"_priority",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),cL=T(oL.prototype,"_fov",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 45}}),lL=T(oL.prototype,"_fovAxis",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return zL.VERTICAL}}),uL=T(oL.prototype,"_orthoHeight",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 10}}),hL=T(oL.prototype,"_near",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),_L=T(oL.prototype,"_far",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1e3}}),fL=T(oL.prototype,"_color",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Qn("#333333")}}),dL=T(oL.prototype,"_depth",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),pL=T(oL.prototype,"_stencil",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),mL=T(oL.prototype,"_clearFlags",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return HL.SOLID_COLOR}}),vL=T(oL.prototype,"_rect",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Xn(0,0,1,1)}}),gL=T(oL.prototype,"_aperture",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return UL.F16_0}}),yL=T(oL.prototype,"_shutter",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return kL.D125}}),xL=T(oL.prototype,"_iso",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return GL.ISO100}}),SL=T(oL.prototype,"_screenScale",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),EL=T(oL.prototype,"_visibility",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return xp}}),TL=T(oL.prototype,"_targetTexture",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),T(oL.prototype,"priority",[fM,dM],Object.getOwnPropertyDescriptor(oL.prototype,"priority"),oL.prototype),T(oL.prototype,"visibility",[pM,mM,vM],Object.getOwnPropertyDescriptor(oL.prototype,"visibility"),oL.prototype),T(oL.prototype,"clearFlags",[gM,yM,xM],Object.getOwnPropertyDescriptor(oL.prototype,"clearFlags"),oL.prototype),T(oL.prototype,"clearColor",[SM,EM],Object.getOwnPropertyDescriptor(oL.prototype,"clearColor"),oL.prototype),T(oL.prototype,"clearDepth",[TM,CM],Object.getOwnPropertyDescriptor(oL.prototype,"clearDepth"),oL.prototype),T(oL.prototype,"clearStencil",[bM,AM],Object.getOwnPropertyDescriptor(oL.prototype,"clearStencil"),oL.prototype),T(oL.prototype,"projection",[wM,IM,PM],Object.getOwnPropertyDescriptor(oL.prototype,"projection"),oL.prototype),T(oL.prototype,"fovAxis",[RM,DM,OM,NM],Object.getOwnPropertyDescriptor(oL.prototype,"fovAxis"),oL.prototype),T(oL.prototype,"fov",[MM,LM,FM],Object.getOwnPropertyDescriptor(oL.prototype,"fov"),oL.prototype),T(oL.prototype,"orthoHeight",[BM,zM,UM],Object.getOwnPropertyDescriptor(oL.prototype,"orthoHeight"),oL.prototype),T(oL.prototype,"near",[kM,GM],Object.getOwnPropertyDescriptor(oL.prototype,"near"),oL.prototype),T(oL.prototype,"far",[HM,VM],Object.getOwnPropertyDescriptor(oL.prototype,"far"),oL.prototype),T(oL.prototype,"aperture",[WM,jM,qM],Object.getOwnPropertyDescriptor(oL.prototype,"aperture"),oL.prototype),T(oL.prototype,"shutter",[XM,YM,KM],Object.getOwnPropertyDescriptor(oL.prototype,"shutter"),oL.prototype),T(oL.prototype,"iso",[QM,JM,ZM],Object.getOwnPropertyDescriptor(oL.prototype,"iso"),oL.prototype),T(oL.prototype,"rect",[$M,eL],Object.getOwnPropertyDescriptor(oL.prototype,"rect"),oL.prototype),T(oL.prototype,"targetTexture",[tL,nL,iL],Object.getOwnPropertyDescriptor(oL.prototype,"targetTexture"),oL.prototype),rL=oL))||rL)||rL)||rL)||rL));b.Camera=VL;var WL={parent:null,owner:null,subModelIdx:0},jL=e("RenderableComponent",(wL=dc("cc.RenderableComponent"),IL=Jc(Ov),PL=Vc(),RL=Fc(),DL=Jc([Ov]),wL((T((NL=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return E(t=e.call.apply(e,[this].concat(i))||this,"_visFlags",ML,y(t)),E(t,"_materials",LL,y(t)),t._materialInstances=[],t._models=[],t}f(t,e);var n=t.prototype;return n.getMaterial=function(e){return e<0||e>=this._materials.length?null:this._materials[e]},n.setMaterial=function(e,t){e&&e instanceof Hg&&console.error("Can't set a material instance to a sharedMaterial slot"),this._materials[t]=e;var n=this._materialInstances[t];n&&(n.destroy(),this._materialInstances[t]=null),this._onMaterialModified(t,this._materials[t])},n.getMaterialInstance=function(e){if(!this._materials[e])return null;if(!this._materialInstances[e]){WL.parent=this._materials[e],WL.owner=this,WL.subModelIdx=e;var t=new Hg(WL);WL.parent=null,WL.owner=null,WL.subModelIdx=0,this.setMaterialInstance(t,e)}return this._materialInstances[e]},n.setMaterialInstance=function(e,t){if("number"==typeof e){q(12007);var n=e;e=t,t=n}var i=this._materialInstances[t];e&&e.parent?e!==i&&(this._materialInstances[t]=e,this._onMaterialModified(t,e)):(e!==this._materials[t]||i)&&this.setMaterial(e,t)},n.getRenderMaterial=function(e){return this._materialInstances[e]||this._materials[e]},n._collectModels=function(){return this._models},n._attachToScene=function(){},n._detachFromScene=function(){},n._onMaterialModified=function(){},n._onRebuildPSO=function(){},n._clearMaterials=function(){},n._onVisibilityChange=function(){},h(t,[{key:"visibility",get:function(){return this._visFlags},set:function(e){this._visFlags=e,this._onVisibilityChange(e)}},{key:"sharedMaterial",get:function(){return this.getMaterial(0)}},{key:"sharedMaterials",get:function(){return this._materials},set:function(e){for(var t=0;t<e.length;t++)e[t]!==this._materials[t]&&this.setMaterial(e[t],t);if(e.length<this._materials.length){for(var n=e.length;n<this._materials.length;n++)this.setMaterial(null,n);this._materials.splice(e.length)}}},{key:"material",get:function(){return this.getMaterialInstance(0)},set:function(e){(1!==this._materials.length||this._materialInstances[0]||this._materials[0]!==e)&&this.setMaterialInstance(e,0)}},{key:"materials",get:function(){for(var e=0;e<this._materials.length;e++)this._materialInstances[e]=this.getMaterialInstance(e);return this._materialInstances},set:function(e){for(var t=e.length,n=this._materials.length,i=t;i<n;i++)this.setMaterialInstance(null,i);this._materials.length=t,this._materialInstances.length=t;for(var r=0;r<t;r++)this._materialInstances[r]!=e[r]&&this.setMaterialInstance(e[r],r)}}]),t}(ku)).prototype,"sharedMaterials",[IL,PL,RL],Object.getOwnPropertyDescriptor(NL.prototype,"sharedMaterials"),NL.prototype),ML=T(NL.prototype,"_visFlags",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return rd.Enum.NONE}}),LL=T(NL.prototype,"_materials",[DL],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),OL=NL))||OL));b.RenderableComponent=jL,b.math=ei,b.geometry=nd;var qL=new yn,XL=new kn;function YL(e,t,n,i){var r=n.chunk,o=n.data,a=r.vb,s=n.vertexCount;e.getWorldMatrix(XL);for(var c=0,l=0;l<s;l++){var u=o[l];yn.set(qL,u.x,u.y,0),yn.transformMat4(qL,qL,XL),a[c++]=qL.x,a[c++]=qL.y,a[c++]=qL.z,Qn.toArray(a,i,c+2),c+=6}for(var h=r.bufferId,_=r.vertexOffset,f=r.vertexAccessor.getMeshBuffer(r.bufferId),d=r.vertexAccessor.getIndexBuffer(h),p=f.indexOffset,m=0,v=s/4;m<v;m++){var g=_+4*m;d[p++]=g,d[p++]=g+1,d[p++]=g+2,d[p++]=g+1,d[p++]=g+3,d[p++]=g+2}f.indexOffset+=n.indexCount,f.setDirty()}var KL={},QL=function(){function e(e,t){this._texture=void 0,this._width=void 0,this._height=void 0,this._x=void 0,this._y=void 0,this._nexty=void 0,this._innerTextureInfos={},this._innerSpriteFrames=void 0,this._count=void 0;var n=new JL;n.initWithSize(e,t),this._texture=n,this._width=e,this._height=t,this._x=2,this._y=2,this._nexty=2,this._innerTextureInfos={},this._innerSpriteFrames=[],this._count=0}var t=e.prototype;return t.insertSpriteFrame=function(e){var t=e.rect,n=e.texture,i=this._innerTextureInfos[n.getId()],r=t.x,o=t.y;if(i)r+=i.x,o+=i.y;else{var a=n.width,s=n.height;if(this._x+a+2>this._width&&(this._x=2,this._y=this._nexty),this._y+s+2>this._nexty&&(this._nexty=this._y+s+2),this._nexty>this._height)return null;b.internal.dynamicAtlasManager.textureBleeding&&((a<=8||s<=8)&&(this._texture.drawTextureAt(n.image,this._x-1,this._y-1),this._texture.drawTextureAt(n.image,this._x-1,this._y+1),this._texture.drawTextureAt(n.image,this._x+1,this._y-1),this._texture.drawTextureAt(n.image,this._x+1,this._y+1)),this._texture.drawTextureAt(n.image,this._x-1,this._y),this._texture.drawTextureAt(n.image,this._x+1,this._y),this._texture.drawTextureAt(n.image,this._x,this._y-1),this._texture.drawTextureAt(n.image,this._x,this._y+1)),this._texture.drawTextureAt(n.image,this._x,this._y),this._innerTextureInfos[n.getId()]={x:this._x,y:this._y,texture:n},this._count++,r+=this._x,o+=this._y,this._x+=a+2}var c={x:r,y:o,texture:this._texture};return this._innerSpriteFrames.push(e),c},t.deleteInnerTexture=function(e){e&&this._innerTextureInfos[e.getId()]&&(delete this._innerTextureInfos[e.getId()],this._count--)},t.isEmpty=function(){return this._count<=0},t.reset=function(){this._x=2,this._y=2,this._nexty=2;for(var e=this._innerSpriteFrames,t=0,n=e.length;t<n;t++){var i=e[t];i.isValid&&i._resetDynamicAtlasFrame()}this._innerSpriteFrames.length=0,this._innerTextureInfos={}},t.destroy=function(){this.reset(),this._texture.destroy()},e}(),JL=function(e){function t(){return e.apply(this,arguments)||this}f(t,e);var n=t.prototype;return n.initWithSize=function(e,t,n){void 0===n&&(n=tm.RGBA8888),this.reset({width:e,height:t,format:n})},n.drawTextureAt=function(e,t,n){var i=this.getGFXTexture();if(e&&i){var r=this._getGFXDevice();if(r){var o=new nr;o.texOffset.x=t,o.texOffset.y=n,o.texExtent.width=e.width,o.texExtent.height=e.height,r.copyTexImagesToTexture([e.data],i,[o])}else console.warn("Unable to get device")}},t}(Xm),ZL=function(){function e(){this._atlases=[],this._atlasIndex=-1,this._maxAtlasCount=5,this._textureSize=2048,this._maxFrameSize=512,this._textureBleeding=!0,this._enabled=!1}var t=e.prototype;return t.newAtlas=function(){var e=this._atlases[++this._atlasIndex];return e||(e=new QL(this._textureSize,this._textureSize),this._atlases.push(e)),e},t.beforeSceneLoad=function(){this.reset()},t.insertSpriteFrame=function(e){if(!this._enabled||this._atlasIndex===this._maxAtlasCount||!e||e._original)return null;if(!e.packable)return null;var t=e.texture.getSamplerInfo();if(t.minFilter!==im.LINEAR||t.magFilter!==im.LINEAR||t.mipFilter!==im.NONE)return null;var n=this._atlases[this._atlasIndex];n||(n=this.newAtlas());var i=n.insertSpriteFrame(e);return i||this._atlasIndex===this._maxAtlasCount?i:(n=this.newAtlas()).insertSpriteFrame(e)},t.reset=function(){for(var e=0,t=this._atlases.length;e<t;e++)this._atlases[e].destroy();this._atlases.length=0,this._atlasIndex=-1},t.deleteAtlasSpriteFrame=function(e){if(e._original){for(var t,n=this._atlases.length-1;n>=0;n--)t=this._atlases[n],Ke.array.fastRemove(t._innerSpriteFrames,e);var i=e._original._texture;this.deleteAtlasTexture(i)}},t.deleteAtlasTexture=function(e){if(e)for(var t=this._atlases.length-1;t>=0;t--)this._atlases[t].deleteInnerTexture(e),this._atlases[t].isEmpty()&&(this._atlases[t].destroy(),this._atlases.splice(t,1),this._atlasIndex--)},t.packToDynamicAtlas=function(e,t){if(t&&!t._original&&t.packable&&t.texture&&t.texture.width>0&&t.texture.height>0){var n=this.insertSpriteFrame(t);n&&t._setDynamicAtlasFrame(n)}},h(e,[{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled!==e&&(e?(this.reset(),b.director.on(b.Director.EVENT_BEFORE_SCENE_LAUNCH,this.beforeSceneLoad,this)):(this.reset(),b.director.off(b.Director.EVENT_BEFORE_SCENE_LAUNCH,this.beforeSceneLoad,this)),this._enabled=e)}},{key:"maxAtlasCount",get:function(){return this._maxAtlasCount},set:function(e){this._maxAtlasCount=e}},{key:"atlasCount",get:function(){return this._atlases.length}},{key:"textureBleeding",get:function(){return this._textureBleeding},set:function(e){this._textureBleeding=e}},{key:"textureSize",get:function(){return this._textureSize},set:function(e){this._textureSize=e}},{key:"maxFrameSize",get:function(){return this._maxFrameSize},set:function(e){this._maxFrameSize=e}}]),e}();ZL.instance=void 0;var $L,eF,tF,nF=e("dynamicAtlasManager",ZL.instance=new ZL);b.internal.dynamicAtlasManager=nF;var iF,rF,oF,aF,sF=[{u:0,v:0},{u:0,v:0},{u:0,v:0},{u:0,v:0}],cF=e("SpriteFrame",dc("cc.SpriteFrame")((tF=eF=function(e){function t(){var t;return(t=e.call(this)||this).vertices=null,t.uv=[],t.unbiasUV=[],t.uvSliced=[],t._rect=new Xn,t._offset=new Tn,t._originalSize=new jn,t._rotated=!1,t._capInsets=[0,0,0,0],t._atlasUuid="",t._texture=void 0,t._isFlipUVY=!1,t._isFlipUVX=!1,t._original=null,t._packable=!0,t}f(t,e),t.createWithImage=function(e){var n=e instanceof Cm?e:new Cm(e),i=new Xm;i.image=n;var r=new t;return r.texture=i,r};var n=t.prototype;return n.textureLoaded=function(){return!!this.texture},n.isRotated=function(){return this._rotated},n.setRotated=function(e){this.rotated=e},n.getRect=function(e){return e?(e.set(this._rect),e):this._rect.clone()},n.setRect=function(e){this.rect=e},n.getOriginalSize=function(e){return e?(e.set(this._originalSize),e):this._originalSize.clone()},n.setOriginalSize=function(e){this.originalSize=e},n.getOffset=function(e){return e?(e.set(this._offset),e):this._offset.clone()},n.setOffset=function(e){this.offset=e},n.getGFXTexture=function(){return this._texture.getGFXTexture()},n.getGFXSampler=function(){return this._texture.getGFXSampler()},n.getHash=function(){return this._texture.getHash()},n.getSamplerInfo=function(){return this._texture.getSamplerInfo()},n.reset=function(e,t){void 0===t&&(t=!1);var n=!1;t&&(this._originalSize.set(0,0),this._rect.set(0,0,0,0),this._offset.set(0,0),this._capInsets=[0,0,0,0],this._rotated=!1,n=!0),e&&(e.texture&&(this._rect.x=this._rect.y=0,this._rect.width=e.texture.width,this._rect.height=e.texture.height,this._refreshTexture(e.texture),this.checkRect(this._texture)),e.originalSize&&this._originalSize.set(e.originalSize),e.rect&&this._rect.set(e.rect),e.offset&&this._offset.set(e.offset),void 0!==e.borderTop&&(this._capInsets[1]=e.borderTop),void 0!==e.borderBottom&&(this._capInsets[3]=e.borderBottom),void 0!==e.borderLeft&&(this._capInsets[0]=e.borderLeft),void 0!==e.borderRight&&(this._capInsets[2]=e.borderRight),void 0!==e.isRotate&&(this._rotated=!!e.isRotate),void 0!==e.isFlipUv&&(this._isFlipUVY=!!e.isFlipUv),n=!0),n&&this.texture&&this._calculateUV()},n.checkRect=function(e){var t=this._rect,n=t.x,i=t.y;return this._rotated?(n+=t.height,i+=t.width):(n+=t.width,i+=t.height),n>e.width?(Y(3300,this.name+"/"+e.name,n,e.width),!1):!(i>e.height&&(Y(3301,this.name+"/"+e.name,i,e.height),1))},n.destroy=function(){return this._packable&&nF&&nF.deleteAtlasSpriteFrame(this),e.prototype.destroy.call(this)},n._calculateSlicedUV=function(){var e=this._rect,n=this.texture,i=n.width,r=n.height,o=this._capInsets[0],a=this._capInsets[2],s=e.width-o-a,c=this._capInsets[1],l=this._capInsets[3],u=e.height-c-l,h=this.uvSliced;if(h.length=0,this._rotated){sF[0].u=e.x/i,sF[1].u=(e.x+l)/i,sF[2].u=(e.x+l+u)/i,sF[3].u=(e.x+e.height)/i,sF[3].v=e.y/r,sF[2].v=(e.y+o)/r,sF[1].v=(e.y+o+s)/r,sF[0].v=(e.y+e.width)/r;for(var _=0;_<4;++_)for(var f=sF[_],d=0;d<4;++d){var p=sF[3-d];h.push({u:f.u,v:p.v})}}else{sF[0].u=e.x/i,sF[1].u=(e.x+o)/i,sF[2].u=(e.x+o+s)/i,sF[3].u=(e.x+e.width)/i,sF[3].v=e.y/r,sF[2].v=(e.y+c)/r,sF[1].v=(e.y+c+u)/r,sF[0].v=(e.y+e.height)/r;for(var m=0;m<4;++m)for(var v=sF[m],g=0;g<4;++g){var y=sF[g];h.push({u:y.u,v:v.v})}}this.emit(t.EVENT_UV_UPDATED,this)},n._calculateUV=function(){var e=this._rect,t=this.uv,n=this.unbiasUV,i=this.texture,r=i.width,o=i.height;if(this._rotated){var a=0===r?0:e.x/r,s=0===r?1:(e.x+e.height)/r,c=0===o?0:e.y/o,l=0===o?1:(e.y+e.width)/o;this._isFlipUVX&&this._isFlipUVY?(t[0]=s,t[1]=l,t[2]=s,t[3]=c,t[4]=a,t[5]=l,t[6]=a,t[7]=c):this._isFlipUVX?(t[0]=s,t[1]=c,t[2]=s,t[3]=l,t[4]=a,t[5]=c,t[6]=a,t[7]=l):this._isFlipUVY?(t[0]=a,t[1]=l,t[2]=a,t[3]=c,t[4]=s,t[5]=l,t[6]=s,t[7]=c):(t[0]=a,t[1]=c,t[2]=a,t[3]=l,t[4]=s,t[5]=c,t[6]=s,t[7]=l);var u=0===r?0:e.x/r,h=0===r?1:(e.x+e.height)/r,_=0===o?0:e.y/o,f=0===o?1:(e.y+e.width)/o;this._isFlipUVX&&this._isFlipUVY?(n[0]=h,n[1]=f,n[2]=h,n[3]=_,n[4]=u,n[5]=f,n[6]=u,n[7]=_):this._isFlipUVX?(n[0]=h,n[1]=_,n[2]=h,n[3]=f,n[4]=u,n[5]=_,n[6]=u,n[7]=f):this._isFlipUVY?(n[0]=u,n[1]=f,n[2]=u,n[3]=_,n[4]=h,n[5]=f,n[6]=h,n[7]=_):(n[0]=u,n[1]=_,n[2]=u,n[3]=f,n[4]=h,n[5]=_,n[6]=h,n[7]=f)}else{var d=0===r?0:e.x/r,p=0===r?1:(e.x+e.width)/r,m=0===o?1:(e.y+e.height)/o,v=0===o?0:e.y/o;this._isFlipUVX&&this._isFlipUVY?(t[0]=p,t[1]=v,t[2]=d,t[3]=v,t[4]=p,t[5]=m,t[6]=d,t[7]=m):this._isFlipUVX?(t[0]=p,t[1]=m,t[2]=d,t[3]=m,t[4]=p,t[5]=v,t[6]=d,t[7]=v):this._isFlipUVY?(t[0]=d,t[1]=v,t[2]=p,t[3]=v,t[4]=d,t[5]=m,t[6]=p,t[7]=m):(t[0]=d,t[1]=m,t[2]=p,t[3]=m,t[4]=d,t[5]=v,t[6]=p,t[7]=v);var g=0===r?0:e.x/r,y=0===r?1:(e.x+e.width)/r,x=0===o?1:(e.y+e.height)/o,S=0===o?0:e.y/o;this._isFlipUVX&&this._isFlipUVY?(n[0]=y,n[1]=S,n[2]=g,n[3]=S,n[4]=y,n[5]=x,n[6]=g,n[7]=x):this._isFlipUVX?(n[0]=y,n[1]=x,n[2]=g,n[3]=x,n[4]=y,n[5]=S,n[6]=g,n[7]=S):this._isFlipUVY?(n[0]=g,n[1]=S,n[2]=y,n[3]=S,n[4]=g,n[5]=x,n[6]=y,n[7]=x):(n[0]=g,n[1]=x,n[2]=y,n[3]=x,n[4]=g,n[5]=S,n[6]=y,n[7]=S)}var E=this.vertices;if(E){E.nu.length=0,E.nv.length=0;for(var T=0;T<E.u.length;T++)E.nu[T]=E.u[T]/r,E.nv[T]=E.v[T]/o}this._calculateSlicedUV()},n._setDynamicAtlasFrame=function(e){e&&(this._original={_texture:this._texture,_x:this._rect.x,_y:this._rect.y},this._texture=e.texture,this._rect.x=e.x,this._rect.y=e.y,this._calculateUV())},n._resetDynamicAtlasFrame=function(){this._original&&(this._rect.x=this._original._x,this._rect.y=this._original._y,this._texture=this._original._texture,this._original=null,this._calculateUV())},n._checkPackable=function(){var e=nF;if(e){var t=this._texture;if(t instanceof Xm&&!t.isCompressed){var n=this.width,i=this.height;!t.image||n>e.maxFrameSize||i>e.maxFrameSize?this._packable=!1:t.image&&t.image instanceof HTMLCanvasElement&&(this._packable=!0)}else this._packable=!1}},n._serialize=function(){return null},n._deserialize=function(e){var t=e,n=t.rect;n&&(this._rect=new Xn(n.x,n.y,n.width,n.height));var i=t.offset;t.offset&&(this._offset=new Tn(i.x,i.y));var r=t.originalSize;t.originalSize&&(this._originalSize=new jn(r.width,r.height)),this._rotated=!!t.rotated,this._name=t.name,this._packable=!!t.packable;var o=t.capInsets;o&&(this._capInsets[0]=o[0],this._capInsets[1]=o[1],this._capInsets[2]=o[2],this._capInsets[3]=o[3]),this.vertices=t.vertices,this.vertices&&(this.vertices.nu=[],this.vertices.nv=[])},n.clone=function(){var e,n,i,r,o,a,s,c,l=new t,u=this.vertices;return l.vertices=u?{x:u.x,y:u.y,triangles:u.triangles,nu:null===(e=u.nu)||void 0===e?void 0:e.slice(0),u:null===(n=u.u)||void 0===n?void 0:n.slice(0),nv:null===(i=u.nv)||void 0===i?void 0:i.slice(0),v:null===(r=u.v)||void 0===r?void 0:r.slice(0)}:null,(o=l.uv).splice.apply(o,[0,l.uv.length].concat(this.uv)),(a=l.unbiasUV).splice.apply(a,[0,l.unbiasUV.length].concat(this.unbiasUV)),(s=l.uvSliced).splice.apply(s,[0,l.uvSliced.length].concat(this.uvSliced)),l._rect.set(this._rect),l._offset.set(this._offset),l._originalSize.set(this._originalSize),l._rotated=this._rotated,(c=l._capInsets).splice.apply(c,[0,l._capInsets.length].concat(this._capInsets)),l._atlasUuid=this._atlasUuid,l._texture=this._texture,l._isFlipUVX=this._isFlipUVX,l._isFlipUVY=this._isFlipUVY,l},n._refreshTexture=function(e){this._texture=e;var t=this._texture,n={},i=!1;0!==this._rect.width&&0!==this._rect.height&&this.checkRect(t)||(n.rect=new Xn(0,0,t.width,t.height),i=!0),(0===this._originalSize.width||0===this._originalSize.height||i)&&(n.originalSize=new jn(t.width,t.height),i=!0),i&&(this.reset(n),this.onLoaded()),this._checkPackable()},n.initDefault=function(t){e.prototype.initDefault.call(this,t);var n=new Xm;n.initDefault(),this._refreshTexture(n),this._calculateUV()},n.validate=function(){return this._texture&&this._rect&&0!==this._rect.width&&0!==this._rect.height},h(t,[{key:"insetTop",get:function(){return this._capInsets[1]},set:function(e){this._capInsets[1]!==e&&(this._capInsets[1]=e,this._texture&&this._calculateSlicedUV())}},{key:"insetBottom",get:function(){return this._capInsets[3]},set:function(e){this._capInsets[3]!==e&&(this._capInsets[3]=e,this._texture&&this._calculateSlicedUV())}},{key:"insetLeft",get:function(){return this._capInsets[0]},set:function(e){this._capInsets[0]!==e&&(this._capInsets[0]=e,this._texture&&this._calculateSlicedUV())}},{key:"insetRight",get:function(){return this._capInsets[2]},set:function(e){this._capInsets[2]!==e&&(this._capInsets[2]=e,this._texture&&this._calculateSlicedUV())}},{key:"rect",get:function(){return this._rect},set:function(e){this._rect.equals(e)||(this._rect.set(e),this._texture&&this._calculateUV())}},{key:"originalSize",get:function(){return this._originalSize},set:function(e){this._originalSize.equals(e)||(this._originalSize.set(e),this._texture&&this._calculateUV())}},{key:"offset",get:function(){return this._offset},set:function(e){this._offset.set(e)}},{key:"rotated",get:function(){return this._rotated},set:function(e){this._rotated!==e&&(this._rotated=e,this._texture&&this._calculateUV())}},{key:"texture",get:function(){return this._texture},set:function(e){e?e!==this._texture&&this.reset({texture:e},!0):q(3122,this.name)}},{key:"atlasUuid",get:function(){return this._atlasUuid},set:function(e){this._atlasUuid=e}},{key:"width",get:function(){return this._texture.width}},{key:"height",get:function(){return this._texture.height}},{key:"_textureSource",set:function(e){window.Build?this._texture=e:e&&(this._refreshTexture(e),this._calculateUV())}},{key:"flipUVX",get:function(){return this._isFlipUVX},set:function(e){this._isFlipUVX=e,this._calculateUV()}},{key:"flipUVY",get:function(){return this._isFlipUVY},set:function(e){this._isFlipUVY=e,this._calculateUV()}},{key:"packable",get:function(){return this._packable},set:function(e){this._packable=e}},{key:"original",get:function(){return this._original}}]),t}(yu),eF.EVENT_UV_UPDATED="uv_updated",$L=tF))||$L);b.SpriteFrame=cF;var lF,uF=e("SpriteAtlas",dc("cc.SpriteAtlas")((aF=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return E(t=e.call.apply(e,[this].concat(i))||this,"spriteFrames",oF,y(t)),t}f(t,e);var n=t.prototype;return n.getTexture=function(){var e=Object.keys(this.spriteFrames);if(e.length>0){var t=this.spriteFrames[e[0]];return t&&t.texture}return null},n.getSpriteFrame=function(e){var t=this.spriteFrames[e];return t?(t.name||(t.name=e),t):null},n.getSpriteFrames=function(){for(var e=[],t=this.spriteFrames,n=0,i=Object.keys(t);n<i.length;n++){var r=i[n];e.push(t[r])}return e},n._serialize=function(){},n._deserialize=function(e,t){var n=e;this._name=n.name;var i=n.spriteFrames;this.spriteFrames=xe();for(var r=0;r<i.length;r+=2)t.result.push(this.spriteFrames,i[r],i[r+1],qe(cF))},t}(yu),oF=T((rF=aF).prototype,"spriteFrames",[Ec,Nc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return xe()}}),iF=rF))||iF);b.SpriteAtlas=uF;var hF,_F,fF,dF,pF=e("Font",dc("cc.Font")(lF=function(e){function t(){return e.apply(this,arguments)||this}return f(t,e),t}(yu))||lF);b.Font=pF;var mF,vF,gF,yF,xF,SF,EF,TF,CF,bF=e("TTFFont",dc("cc.TTFFont")((dF=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return E(t=e.call.apply(e,[this].concat(i))||this,"_fontFamily",fF,y(t)),t}return f(t,e),t.prototype.initDefault=function(t){this._fontFamily="Arial",e.prototype.initDefault.call(this,t)},h(t,[{key:"_nativeAsset",get:function(){return this._fontFamily},set:function(e){this._fontFamily=e||"Arial"}},{key:"_nativeDep",get:function(){return{uuid:this._uuid,__nativeName__:this._native,ext:su(this._native),__isNative__:!0}}}]),t}(pF),fF=T((_F=dF).prototype,"_fontFamily",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),T(_F.prototype,"_nativeAsset",[$c,Qc],Object.getOwnPropertyDescriptor(_F.prototype,"_nativeAsset"),_F.prototype),T(_F.prototype,"_nativeDep",[$c],Object.getOwnPropertyDescriptor(_F.prototype,"_nativeDep"),_F.prototype),hF=_F))||hF);b.TTFFont=bF;var AF,wF=function(){this.u=0,this.v=0,this.w=0,this.h=0,this.offsetX=0,this.offsetY=0,this.textureID=0,this.valid=!1,this.xAdvance=0},IF=function(){function e(e){this.letterDefinitions={},this.texture=e}var t=e.prototype;return t.addLetterDefinitions=function(e,t){this.letterDefinitions[e]=t},t.cloneLetterDefinition=function(){for(var e={},t=0,n=Object.keys(this.letterDefinitions);t<n.length;t++){var i=n[t],r=new wF;De(r,this.letterDefinitions[i]),e[i]=r}return e},t.getTexture=function(){return this.texture},t.getLetter=function(e){return this.letterDefinitions[e]},t.getLetterDefinitionForChar=function(e){var t=e.charCodeAt(0);return this.letterDefinitions.hasOwnProperty(t)?this.letterDefinitions[t]:null},t.clear=function(){this.letterDefinitions={}},e}(),PF=e("BitmapFont",(mF=dc("cc.BitmapFont"),vF=Jc(cF),mF((CF=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return E(t=e.call.apply(e,[this].concat(i))||this,"fntDataStr",xF,y(t)),E(t,"spriteFrame",SF,y(t)),E(t,"fontSize",EF,y(t)),E(t,"fntConfig",TF,y(t)),t}return f(t,e),t.prototype.onLoaded=function(){var e=this.spriteFrame;!this.fontDefDictionary&&e&&(this.fontDefDictionary=new IF(e.texture));var t=this.fntConfig;if(t){var n=t.fontDefDictionary;for(var i in n){var r=new wF,o=n[i].rect;r.offsetX=n[i].xOffset,r.offsetY=n[i].yOffset,r.w=o.width,r.h=o.height,r.u=o.x,r.v=o.y,r.textureID=0,r.valid=!0,r.xAdvance=n[i].xAdvance,this.fontDefDictionary.addLetterDefinitions(i,r)}}else F("The fnt config is not exists!")},t}(pF),xF=T((yF=CF).prototype,"fntDataStr",[Ec,Nc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),SF=T(yF.prototype,"spriteFrame",[vF],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),EF=T(yF.prototype,"fontSize",[Ec,Nc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),TF=T(yF.prototype,"fntConfig",[Ec,Nc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),gF=yF))||gF));b.BitmapFont=PF;var RF=e("LabelAtlas",dc("cc.LabelAtlas")(AF=function(e){function t(){return e.apply(this,arguments)||this}return f(t,e),t}(PF))||AF);b.LabelAtlas=RF;var DF=e("BASELINE_RATIO",.26),OF=e("MIDDLE_RATIO",(DF+1)/2-DF);var NF=new Xe(2);NF.get=function(){return this._get()||{key:"",value:0,prev:null,next:null}};var MF,LF=new(function(){function e(e){this.count=0,this.limit=0,this.datas={},this.limit=e}var t=e.prototype;return t.moveToHead=function(e){e.next=this.head,e.prev=null,this.head&&(this.head.prev=e),this.head=e,this.tail||(this.tail=e),this.count++,this.datas[e.key]=e},t.put=function(e,t){var n=NF.get();if(n.key=e,n.value=t,this.count>=this.limit){var i=this.tail;delete this.datas[i.key],this.count--,this.tail=i.prev,this.tail.next=null,i.prev=null,i.next=null,NF.put(i)}this.moveToHead(n)},t.remove=function(e){e.prev?e.prev.next=e.next:this.head=e.next,e.next?e.next.prev=e.prev:this.tail=e.prev,delete this.datas[e.key],this.count--},t.get=function(e){var t=this.datas[e];return t?(this.remove(t),this.moveToHead(t),t.value):null},t.clear=function(){this.count=0,this.datas={},this.head=null,this.tail=null},t.has=function(e){return!!this.datas[e]},t.delete=function(e){var t=this.datas[e];this.remove(t)},e}())(100),FF=/([a-zA-Z0-9--]+|\S)/,BF=/^[!,.:;'}\]%\?>]/,zF=/([a-zA-Z0-9--iI]+|\S)$/,UF=/[a-zA-Z0-9--iI]+$/,kF=/^[a-zA-Z0-9--iI]/;function GF(e){return/^[\u4E00-\u9FFF\u3400-\u4DFF]+$/.test(e)||/[\u3000-\u303F]|[\u3040-\u309F]|[\u30A0-\u30FF]|[\uFF00-\uFFEF]|[\u4E00-\u9FAF]|[\u2605-\u2606]|[\u2190-\u2195]|\u203B/g.test(e)||/^[\u1100-\u11FF]|[\u3130-\u318F]|[\uA960-\uA97F]|[\uAC00-\uD7AF]|[\uD7B0-\uD7FF]+$/.test(e)}function HF(e){var t=e.charCodeAt(0);return t>=9&&t<=13||32===t||133===t||160===t||5760===t||t>=8192&&t<=8202||8232===t||8233===t||8239===t||8287===t||12288===t}function VF(e,t,n){var i=(n||e.font)+""+t,r=LF.get(i);if(null!==r)return r;var o=e.measureText(t),a=o&&o.width||0;return LF.put(i,a),a}function WF(e,t,n){var i=t,r=n,o=e[t];if(o>="\udc00"&&o<="\udfff"&&i--,void 0!==n)if(n-1!==t){var a=e[n-1];a>="\ud800"&&a<="\udbff"&&r--}else o>="\ud800"&&o<="\udbff"&&r++;return e.substring(i,r)}function jF(e){return kF.exec(e)}function qF(e){return UF.exec(e)}function XF(e,t,n,i){var r=[];if(0===e.length||n<0)return r.push(""),r;for(var o=e;t>n&&o.length>1;){for(var a=o.length*(n/t)|0,s=WF(o,a),c=t-i(s),l=s,u=0,h=0;c>n&&h++<100;)a*=n/c,c=t-i(s=WF(o,a|=0));for(h=0;s&&c<=n&&h++<100;){var _=FF.exec(s);l=s,c=t-i(s=WF(o,a+=u=_?_[0].length:1))}0==(a-=u)?(a=1,l=WF(o,1)):1===a&&o[0]>="\ud800"&&o[0]<="\udbff"&&(a=2,l=WF(o,2));var f=WF(o,0,a),d=void 0;BF.test(l||s)&&(0==(a-=(d=zF.exec(f))?d[0].length:0)&&(a=1),l=WF(o,a),f=WF(o,0,a)),kF.test(l)&&(d=UF.exec(f))&&f!==d[0]&&(l=WF(o,a-=d[0].length),f=WF(o,0,a)),(0===r.length||(f=f.trim()).length>0)&&r.push(f),t=i(o=l||s)}return(0===r.length||(o=o.trim()).length>0)&&r.push(o),r}var YF=e("CanvasPool",function(){function e(){this.pool=[]}e.getInstance=function(){return MF||(MF=new e),MF};var t=e.prototype;return t.get=function(){var e=this.pool.pop();if(!e){var t=document.createElement("canvas"),n=t.getContext("2d");e={canvas:t,context:n}}return e},t.put=function(e){this.pool.length>=nt.MAX_LABEL_CANVAS_POOL_SIZE||this.pool.push(e)},e}()),KF=Qn.WHITE.clone(),QF=function(){this.u=0,this.v=0,this.w=0,this.h=0,this.texture=null,this.offsetX=0,this.offsetY=0,this.valid=!1,this.xAdvance=0},JF="rgba(255, 255, 255, "+(1/255).toFixed(3)+")",ZF=function(){function e(e,t){this.image=null,this.labelInfo=void 0,this.char=void 0,this.data=null,this.canvas=null,this.context=null,this.width=0,this.height=0,this.offsetY=0,this.hash=void 0,this.char=e,this.labelInfo=t,this.hash=e.charCodeAt(0)+t.hash}var t=e.prototype;return t.updateRenderData=function(){this._updateProperties(),this._updateTexture()},t.destroy=function(){this.image=null},t._updateProperties=function(){if(this.data=YF.getInstance().get(),this.canvas=this.data.canvas,this.context=this.data.context,this.context){this.context.font=this.labelInfo.fontDesc;var e=VF(this.context,this.char,this.labelInfo.fontDesc),t=2*this.labelInfo.margin+2;this.width=parseFloat(e.toFixed(2))+t,this.height=(1+DF)*this.labelInfo.fontSize+t,this.offsetY=-this.labelInfo.fontSize*DF/2}this.canvas.width!==this.width&&(this.canvas.width=this.width),this.canvas.height!==this.height&&(this.canvas.height=this.height),this.image||(this.image=new Cm),this.image.reset(this.canvas)},t._updateTexture=function(){if(this.context&&this.canvas){var e=this.context,t=this.labelInfo,n=this.canvas.width,i=this.canvas.height;e.textAlign="center",e.textBaseline="alphabetic",e.clearRect(0,0,n,i),e.fillStyle=JF,e.fillRect(0,0,n,i),e.font=t.fontDesc;var r=t.fontSize,o=n/2,a=i/2+r*OF+0*r,s=t.color;if(e.lineJoin="round",e.fillStyle="rgba("+s.r+", "+s.g+", "+s.b+", 1)",t.isOutlined){var c=t.out||KF;e.strokeStyle="rgba("+c.r+", "+c.g+", "+c.b+", "+c.a/255+")",e.lineWidth=2*t.margin,e.strokeText(this.char,o,a)}e.fillText(this.char,o,a)}},e}(),$F=function(e){function t(){return e.apply(this,arguments)||this}f(t,e);var n=t.prototype;return n.initWithSize=function(e,t,n){void 0===n&&(n=tm.RGBA8888),this.reset({width:e,height:t,format:n})},n.drawTextureAt=function(e,t,n){var i=this.getGFXTexture();if(e&&i){var r=this._getGFXDevice();if(r){var o=new nr;o.texOffset.x=t,o.texOffset.y=n,o.texExtent.width=e.width,o.texExtent.height=e.height,r.copyTexImagesToTexture([e.data],i,[o])}else console.warn("Unable to get device")}},t}(Xm),eB=function(){function e(e,t){this._x=0,this._y=0,this._nextY=0,this._width=0,this._height=0,this._halfBleed=0,this._dirty=!1;var n=new $F;n.initWithSize(e,t),this.fontDefDictionary=new IF(n),this._halfBleed=1,this._width=e,this._height=t,KO.on(YO.EVENT_BEFORE_SCENE_LAUNCH,this.beforeSceneLoad,this)}var t=e.prototype;return t.insertLetterTexture=function(e){var t=e.image,n=KO.root.device;if(!t||!this.fontDefDictionary||!n)return null;var i=t.width,r=t.height;if(this._x+i+0>this._width&&(this._x=0,this._y=this._nextY),this._y+r>this._nextY&&(this._nextY=this._y+r+0),this._nextY>this._height)return q(12100),null;this.fontDefDictionary.texture.drawTextureAt(t,this._x,this._y),this._dirty=!0;var o=new QF;return o.u=this._x+this._halfBleed,o.v=this._y+this._halfBleed,o.texture=this.fontDefDictionary.texture,o.valid=!0,o.w=e.width-2,o.h=e.height-2,o.xAdvance=o.w,o.offsetY=e.offsetY,this._x+=i+0,this.fontDefDictionary.addLetterDefinitions(e.hash,o),o},t.update=function(){this._dirty&&(this._dirty=!1)},t.reset=function(){this._x=0,this._y=0,this._nextY=0,this.fontDefDictionary.clear()},t.destroy=function(){this.reset(),this.fontDefDictionary&&(this.fontDefDictionary.texture.destroy(),this.fontDefDictionary.texture=null)},t.getTexture=function(){return this.fontDefDictionary.getTexture()},t.beforeSceneLoad=function(){this.clearAllCache()},t.clearAllCache=function(){this.destroy();var e=new $F;e.initWithSize(this._width,this._height),this.fontDefDictionary.texture=e},t.getLetter=function(e){return this.fontDefDictionary.letterDefinitions[e]},t.getLetterDefinitionForChar=function(e,t){var n=e.charCodeAt(0)+t.hash,i=this.fontDefDictionary.letterDefinitions[n];if(!i){var r=new ZF(e,t);r.updateRenderData(),i=this.insertLetterTexture(r),r.destroy()}return i},h(e,[{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}}]),e}(),tB={fontAtlas:null,fontSize:0,lineHeight:0,hAlign:0,vAlign:0,hash:"",fontFamily:"",fontDesc:"Arial",color:Qn.WHITE.clone(),isOutlined:!1,out:Qn.WHITE.clone(),margin:0},nB=[new br(qi.ATTR_POSITION,ai.RGB32F)],iB=[new br(qi.ATTR_POSITION,ai.RGB32F),new br(qi.ATTR_COLOR,ai.RGBA32F)],rB=[new br(qi.ATTR_POSITION,ai.RGB32F),new br(qi.ATTR_TEX_COORD,ai.RG32F),new br(qi.ATTR_COLOR,ai.RGBA32F)],oB=[new br(qi.ATTR_POSITION,ai.RGB32F),new br(qi.ATTR_TEX_COORD,ai.RG32F),new br(qi.ATTR_COLOR,ai.RGBA32F),new br(qi.ATTR_COLOR2,ai.RGBA32F)];function aB(e){for(var t=0,n=0;n<e.length;n++){var i=e[n];t+=Kr[i.format].count}return t}function sB(e){for(var t=0,n=0;n<e.length;n++){var i=e[n];t+=Kr[i.format].size}return t}b.internal.vfmtPosUvColor=rB,b.internal.vfmtPosUvTwoColor=oB;var cB,lB,uB,hB,_B,fB,dB,pB,mB,vB,gB,yB,xB,SB,EB,TB=sB(rB)>>2,CB=new Ml((function(){return{x:0,y:0,z:0,u:0,v:0,color:Qn.WHITE.clone()}}),128),bB=null,AB=e("BaseRenderData",function(){function e(e){void 0===e&&(e=rB),this.material=null,this.chunk=null,this.dataHash=0,this.isMeshBuffer=!1,this._vc=0,this._ic=0,this._floatStride=0,this._vertexFormat=rB,this._floatStride=e===rB?TB:sB(e)>>2,this._vertexFormat=e}return e.prototype.isValid=function(){return this._ic>0&&this.chunk.vertexAccessor},h(e,[{key:"vertexCount",get:function(){return this._vc}},{key:"indexCount",get:function(){return this._ic}},{key:"stride",get:function(){return this._floatStride<<2}},{key:"floatStride",get:function(){return this._floatStride}},{key:"vertexFormat",get:function(){return this._vertexFormat}}]),e}()),wB=e("RenderData",function(e){function t(t,n){var i;return void 0===t&&(t=rB),(i=e.call(this,t)||this).indices=null,i.vertDirty=!0,i.frame=void 0,i.layer=0,i.blendHash=-1,i.textureHash=0,i.nodeDirty=!0,i.passDirty=!0,i.textureDirty=!0,i.hashDirty=!0,i._data=[],i._pivotX=0,i._pivotY=0,i._width=0,i._height=0,i._accessor=null,n||(n=KO.root.batcher2D.switchBufferAccessor(i._vertexFormat)),i._accessor=n,i}f(t,e),t.add=function(e,n){void 0===e&&(e=rB),bB||(bB=new Ll((function(){return new t}),32));var i=bB.add();return i._floatStride=e===rB?TB:sB(e)>>2,i._vertexFormat=e,n||(n=KO.root.batcher2D.switchBufferAccessor(i._vertexFormat)),i._accessor=n,i},t.remove=function(e){var t=bB.data.indexOf(e);-1!==t&&(e.clear(),e._accessor=null,bB.removeAt(t))};var n=t.prototype;return n.resize=function(e,t){e===this._vc&&t===this._ic&&this.chunk||(this._vc=e,this._ic=t,this.chunk&&(this._accessor.recycleChunk(this.chunk),this.chunk=null),this.chunk=this._accessor.allocateChunk(e,t),this.updateHash())},n.resizeAndCopy=function(e,t){if(e!==this._vc||t!==this._ic||!this.chunk){this._vc=e,this._ic=t;var n=this.chunk;this.chunk=this._accessor.allocateChunk(e,t),n&&(this.chunk.vb.set(n.vb),this._accessor.recycleChunk(n)),this.updateHash()}},n.getMeshBuffer=function(){return this.chunk&&this._accessor?this._accessor.getMeshBuffer(this.chunk.bufferId):null},n.updateNode=function(e){this.layer=e.node.layer,this.nodeDirty=!1,this.hashDirty=!0},n.updatePass=function(e){this.material=e.getRenderMaterial(0),this.blendHash=e.blendHash,this.passDirty=!1,this.hashDirty=!0},n.updateTexture=function(e){this.frame=e,this.textureHash=e.getHash(),this.textureDirty=!1,this.hashDirty=!0},n.updateHash=function(){var e=""+(this.chunk?this.chunk.bufferId:-1)+this.layer+" "+this.blendHash+" "+this.textureHash;this.dataHash=po(e,666),this.hashDirty=!1},n.updateRenderData=function(e,t){if(this.passDirty&&(this.material=e.getRenderMaterial(0),this.blendHash=e.blendHash,this.passDirty=!1,this.hashDirty=!0),this.nodeDirty){var n=e.node.scene?e._getRenderScene():null;this.layer=e.node.layer,null!==n&&(this.nodeDirty=!1),this.hashDirty=!0}this.textureDirty&&(this.frame=t,this.textureHash=t.getHash(),this.textureDirty=!1,this.hashDirty=!0),this.hashDirty&&this.updateHash()},n.updateSizeNPivot=function(e,t,n,i){e===this._width&&t===this._height&&n===this._pivotX&&i===this._pivotY||(this._width=e,this._height=t,this._pivotX=n,this._pivotY=i,this.vertDirty=!0)},n.clear=function(){this.resize(0,0),this._data.length=0,this._pivotX=0,this._pivotY=0,this._width=0,this._height=0,this.indices=null,this.vertDirty=!0,this.material=null,this.nodeDirty=!0,this.passDirty=!0,this.textureDirty=!0,this.hashDirty=!0,this.layer=0,this.blendHash=-1,this.frame=null,this.textureHash=0,this.dataHash=0},h(t,[{key:"dataLength",get:function(){return this._data.length},set:function(e){var t=this._data;if(t.length!==e){var n=t.length,i=0;for(i=e;i<n;i++)CB.free(t[i]);for(i=n;i<e;i++)t[i]=CB.alloc();t.length=e}}},{key:"data",get:function(){return this._data}}]),t}(AB)),IB=e("MeshRenderData",function(e){function t(t){var n;return void 0===t&&(t=rB),(n=e.call(this,t)||this).isMeshBuffer=!0,n.vData=void 0,n.iData=void 0,n.vertexStart=0,n.vertexRange=0,n.indexStart=0,n.indexRange=0,n.lastFilledIndex=0,n.lastFilledVertex=0,n._byteLength=0,n._vertexBuffers=[],n._indexBuffer=null,n._iaPool=null,n._iaInfo=null,n.vData=new Float32Array(256*n.stride),n.iData=new Uint16Array(1536),n}f(t,e),t.add=function(e){void 0===e&&(e=rB);var t=PB.add();return t._floatStride=e===rB?TB:sB(e)>>2,t._vertexFormat=e,t},t.remove=function(e){var t=PB.data.indexOf(e);-1!==t&&(PB.data[t].clear(),PB.removeAt(t))};var n=t.prototype;return n.request=function(e,t){var n=this._byteLength+e*this.stride;return!!this.reserve(e,t)&&(this._vc+=e,this._ic+=t,this._byteLength=n,this.vertexRange=this._vc,this.indexRange=this._ic,!0)},n.reserve=function(e,t){var n=this._byteLength+e*this.stride,i=this.indexCount+t;if(e+this.vertexCount>65535)return!1;var r=this.vData.byteLength,o=this.iData.length,a=this.vData.length,s=this.iData.length;if(n>r||i>o){for(;r<n||o<i;)r=4*(a*=2),o=s*=2;this._reallocBuffer(a,s)}return!0},n.resize=function(e,t){var n=e*this.stride;e>=0&&t>=0&&n<=this.vData.byteLength&&this.iData.length,this._vc=e,this._ic=t,this._byteLength=n,this.updateRange(0,e,0,t)},n.updateRange=function(e,t,n,i){t>=0&&i>=0&&t<=this._vc&&this._ic,this.vertexStart=e,this.indexStart=n,this.vertexRange=t,this.indexRange=i},n.requestIA=function(e){this._initIAInfo(e);var t=this._iaPool.add();return t.firstIndex=this.indexStart,t.indexCount=this.indexRange,t},n.uploadBuffers=function(){if(0!==this._byteLength&&this._vertexBuffers[0]&&this._indexBuffer){var e=this._ic,t=new Float32Array(this.vData.buffer,0,this._byteLength>>2),n=new Uint16Array(this.iData.buffer,0,e),i=this._vertexBuffers[0];this._byteLength>i.size&&i.resize(this._byteLength),i.update(t);var r=e<<1;r>this._indexBuffer.size&&this._indexBuffer.resize(r),this._indexBuffer.update(n)}},n.freeIAPool=function(){this._iaPool&&this._iaPool.reset()},n.reset=function(){this._vc=0,this._ic=0,this._byteLength=0,this.vertexStart=0,this.vertexRange=0,this.indexStart=0,this.indexRange=0,this.lastFilledIndex=0,this.lastFilledVertex=0,this.material=null,this.freeIAPool()},n.clear=function(){this.reset(),this._iaPool&&this._iaPool.destroy(),this._vertexBuffers[0]&&(this._vertexBuffers[0].destroy(),this._vertexBuffers=[]),this._iaInfo=null,this.vData=new Float32Array(256*this.stride),this.iData=new Uint16Array(1536)},n._initIAInfo=function(e){var t=this;if(!this._iaInfo){var n=this.stride,i=this._vertexBuffers;i.length||i.push(e.createBuffer(new cr(li.VERTEX|li.TRANSFER_DST,_i.DEVICE,n,n)));var r=Uint16Array.BYTES_PER_ELEMENT;this._indexBuffer||(this._indexBuffer=e.createBuffer(new cr(li.INDEX|li.TRANSFER_DST,_i.DEVICE,r,r))),this._iaInfo=new wr(this._vertexFormat,i,this._indexBuffer),this._iaPool=new Ll((function(){return e.createInputAssembler(t._iaInfo)}),1,(function(e){e.destroy()}))}},n._reallocBuffer=function(e,t){var n=this.vData;this.vData=new Float32Array(e),n&&this.vData.set(n,0);var i=this.iData;this.iData=new Uint16Array(t),i&&this.iData.set(i,0)},h(t,[{key:"formatByte",get:function(){return this.stride},set:function(){}},{key:"floatStride",get:function(){return this._floatStride}},{key:"vDataOffset",get:function(){return this._byteLength>>>2}}]),t}(AB)),PB=new Ll((function(){return new IB}),32),RB=new Tn,DB=new Tn,OB=new yn,NB=new kn,MB=new kn,LB=new kn,FB=new kn(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0),BB=new Xn,zB=e("UITransform",(cB=dc("cc.UITransform"),lB=Oc(),uB=mc(110),hB=Ic(),_B=Vc(),fB=Bc(),dB=Vc(),pB=Bc(),cB(mB=lB(mB=uB(mB=hB(mB=vc(mB=wc((SB=xB=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._priority=0,E(t,"_contentSize",gB,y(t)),E(t,"_anchorPoint",yB,y(t)),t}f(t,e);var n=t.prototype;return n.__preload=function(){this.node._uiProps.uiTransformComp=this},n.onLoad=function(){this.node.parent&&t.insertChangeMap(this.node.parent)},n.onEnable=function(){this.node.on(VT.PARENT_CHANGED,this._parentChanged,this),this._markRenderDataDirty()},n.onDisable=function(){this.node.off(VT.PARENT_CHANGED,this._parentChanged,this)},n.onDestroy=function(){this.node._uiProps.uiTransformComp=null},n.setContentSize=function(e,t){var n=this._contentSize;if(void 0===t){if($t((e=e).width,n.width,Jt)&&$t(e.height,n.height,Jt))return;n.width=e.width,n.height=e.height}else{if($t(e=e,n.width,Jt)&&$t(t,n.height,Jt))return;n.width=e,n.height=t}this.node.emit(VT.SIZE_CHANGED),this._markRenderDataDirty()},n.setAnchorPoint=function(e,t){var n=this._anchorPoint;if(void 0===t){if((e=e).x===n.x&&e.y===n.y)return;n.x=e.x,n.y=e.y}else{if(e===n.x&&t===n.y)return;n.x=e,n.y=t}this.node.emit(VT.ANCHOR_CHANGED,this._anchorPoint),this._markRenderDataDirty()},n.isHit=function(e){for(var t=this._contentSize.width,n=this._contentSize.height,i=RB,r=DB,o=this._getRenderScene().cameras,a=0;a<o.length;a++){var s=o[a];if(s.visibility&this.node.layer){s.node.getWorldRT(NB);var c=NB.m12,l=NB.m13,u=tO.center;if(NB.m12=u.x-(NB.m00*c+NB.m04*l),NB.m13=u.y-(NB.m01*c+NB.m05*l),kn.invert(NB,NB),Tn.transformMat4(i,e,NB),this.node.getWorldMatrix(LB),kn.invert(NB,LB),!kn.strictEquals(NB,FB)){Tn.transformMat4(r,i,NB),r.x+=this._anchorPoint.x*t,r.y+=this._anchorPoint.y*n;var h=!1;if(r.x>=0&&r.y>=0&&r.x<=t&&r.y<=n&&(h=this._maskTest(i)),h)return!0}}}return!1},n.hitTest=function(e){for(var t=this._contentSize.width,n=this._contentSize.height,i=OB,r=RB,o=DB,a=this._getRenderScene().cameras,s=0;s<a.length;s++){var c=a[s];if(c.visibility&this.node.layer&&(yn.set(i,e.x,e.y,0),c.screenToWorld(i,i),Tn.set(r,i.x,i.y),this.node.getWorldMatrix(LB),kn.invert(NB,LB),!kn.strictEquals(NB,FB))){Tn.transformMat4(o,r,NB),o.x+=this._anchorPoint.x*t,o.y+=this._anchorPoint.y*n;var l=!1;if(o.x>=0&&o.y>=0&&o.x<=t&&o.y<=n&&(l=this._maskTest(r)),l)return!0}}return!1},n._maskTest=function(e){var t,n,i=null===(t=this.node)||void 0===t||null===(n=t.eventProcessor)||void 0===n?void 0:n.maskList;if(i)for(var r=this.node,o=i.length,a=0,s=0;r&&s<o;++a,r=r.parent){var c=i[s];if(a===c.index){if(r!==c.comp.node){i.length=s;break}var l=c.comp;if(l&&l._enabled&&!l.isHit(e))return!1;s++}else if(a>c.index){i.length=s;break}}return!0},n.convertToNodeSpaceAR=function(e,t){return this.node.getWorldMatrix(LB),kn.invert(NB,LB),t||(t=new yn),yn.transformMat4(t,e,NB)},n.convertToWorldSpaceAR=function(e,t){return this.node.getWorldMatrix(LB),t||(t=new yn),yn.transformMat4(t,e,LB)},n.getBoundingBox=function(){kn.fromRTS(MB,this.node.getRotation(),this.node.getPosition(),this.node.getScale());var e=this._contentSize.width,t=this._contentSize.height,n=new Xn(-this._anchorPoint.x*e,-this._anchorPoint.y*t,e,t);return n.transformMat4(MB),n},n.getBoundingBoxToWorld=function(){return this.node.parent?(this.node.parent.getWorldMatrix(LB),this.getBoundingBoxTo(LB)):this.getBoundingBox()},n.getBoundingBoxTo=function(e){kn.fromRTS(MB,this.node.getRotation(),this.node.getPosition(),this.node.getScale());var n=this._contentSize.width,i=this._contentSize.height,r=new Xn(-this._anchorPoint.x*n,-this._anchorPoint.y*i,n,i);if(kn.multiply(LB,e,MB),r.transformMat4(LB),!this.node.children)return r;for(var o,a=S(this.node.children);!(o=a()).done;){var s=o.value;if(s&&s.active){var c=s.getComponent(t);if(c){var l=c.getBoundingBoxTo(e);l&&Xn.union(r,r,l)}}}return r},n.getComputeAABB=function(e){var t=this._contentSize.width,n=this._contentSize.height;BB.set(-this._anchorPoint.x*t,-this._anchorPoint.y*n,t,n),BB.transformMat4(this.node.worldMatrix);var i=BB.x+.5*BB.width,r=BB.y+.5*BB.height,o=this.node.worldPosition.z,a=BB.width/2,s=BB.height/2;return null!=e?(Us.set(e,i,r,o,a,s,.001),e):new Us(i,r,o,a,s,.001)},n._parentChanged=function(){this.node.getComponent("cc.RenderRoot2D")||this.node.parent&&t.insertChangeMap(this.node.parent)},n._markRenderDataDirty=function(){var e=this.node._uiProps.uiComp;e&&(e.markForUpdateRenderData(),e.renderData&&(e.renderData.vertDirty=!0))},t.insertChangeMap=function(e){var n=e.uuid;t.priorityChangeNodeMap.has(n)||t.priorityChangeNodeMap.set(n,e)},t._sortChildrenSibling=function(e){var t=e.children;t&&t.sort((function(e,t){var n=e._uiProps.uiTransformComp,i=t._uiProps.uiTransformComp,r=(n?n._priority:0)-(i?i._priority:0);return 0===r?e.getSiblingIndex()-t.getSiblingIndex():r}))},t._sortSiblings=function(){t.priorityChangeNodeMap.forEach((function(e){t._sortChildrenSibling(e),e._updateSiblingIndex(),e.emit("childrenSiblingOrderChanged")})),t.priorityChangeNodeMap.clear()},t._cleanChangeMap=function(){t.priorityChangeNodeMap.clear()},h(t,[{key:"contentSize",get:function(){return this._contentSize},set:function(e){this._contentSize.equals(e)||(this._contentSize.set(e),this.node.emit(VT.SIZE_CHANGED),this._markRenderDataDirty())}},{key:"width",get:function(){return this._contentSize.width},set:function(e){this._contentSize.width!==e&&(this._contentSize.width=e,this.node.emit(VT.SIZE_CHANGED),this._markRenderDataDirty())}},{key:"height",get:function(){return this._contentSize.height},set:function(e){this.contentSize.height!==e&&(this._contentSize.height=e,this.node.emit(VT.SIZE_CHANGED),this._markRenderDataDirty())}},{key:"anchorPoint",get:function(){return this._anchorPoint},set:function(e){this._anchorPoint.equals(e)||(this._anchorPoint.set(e),this.node.emit(VT.ANCHOR_CHANGED,this._anchorPoint),this._markRenderDataDirty())}},{key:"anchorX",get:function(){return this._anchorPoint.x},set:function(e){this._anchorPoint.x!==e&&(this._anchorPoint.x=e,this.node.emit(VT.ANCHOR_CHANGED,this._anchorPoint),this._markRenderDataDirty())}},{key:"anchorY",get:function(){return this._anchorPoint.y},set:function(e){this._anchorPoint.y!==e&&(this._anchorPoint.y=e,this.node.emit(VT.ANCHOR_CHANGED,this._anchorPoint),this._markRenderDataDirty())}},{key:"priority",get:function(){return this._priority},set:function(e){this._priority!==e&&(this.node.getComponent("cc.RenderRoot2D")?q(6706):(this._priority=e,this.node.parent&&t.insertChangeMap(this.node.parent)))}},{key:"visibility",get:function(){var e=KO.root.batcher2D.getFirstRenderCamera(this.node);return e?e.visibility:0}},{key:"cameraPriority",get:function(){var e=KO.root.batcher2D.getFirstRenderCamera(this.node);return e?e.priority:0}}]),t}(ku),xB.EventType=VT,xB.priorityChangeNodeMap=new Map,T((vB=SB).prototype,"contentSize",[_B,fB],Object.getOwnPropertyDescriptor(vB.prototype,"contentSize"),vB.prototype),T(vB.prototype,"anchorPoint",[dB,pB],Object.getOwnPropertyDescriptor(vB.prototype,"anchorPoint"),vB.prototype),gB=T(vB.prototype,"_contentSize",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new jn(100,100)}}),yB=T(vB.prototype,"_anchorPoint",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Tn(.5,.5)}}),mB=vB))||mB)||mB)||mB)||mB)||mB)||mB));KO.on(YO.EVENT_AFTER_UPDATE,zB._sortSiblings),KO.on(YO.EVENT_BEFORE_SCENE_LAUNCH,zB._cleanChangeMap),function(e){e[e.DISABLED=0]="DISABLED",e[e.CLEAR=1]="CLEAR",e[e.ENTER_LEVEL=2]="ENTER_LEVEL",e[e.ENABLED=3]="ENABLED",e[e.EXIT_LEVEL=4]="EXIT_LEVEL",e[e.CLEAR_INVERTED=5]="CLEAR_INVERTED",e[e.ENTER_LEVEL_INVERTED=6]="ENTER_LEVEL_INVERTED"}(EB||(EB={}));var UB,kB,GB,HB,VB,WB,jB,qB,XB,YB,KB,QB,JB,ZB,$B,ez,tz,nz,iz,rz,oz=e("StencilManager",function(){function e(){this.stage=EB.DISABLED,this._maskStack=[],this._stencilPattern={stencilTest:!0,func:Si.ALWAYS,stencilMask:65535,writeMask:65535,failOp:Ei.KEEP,zFailOp:Ei.KEEP,passOp:Ei.KEEP,ref:1},this.stencilStateMap=new Map,this.stencilStateMapWithDepth=new Map}var t=e.prototype;return t.pushMask=function(e){this._maskStack.push(e)},t.clear=function(e){e.stencilStage=e.inverted?EB.CLEAR_INVERTED:EB.CLEAR},t.enterLevel=function(e){e.graphics.stencilStage=e.inverted?EB.ENTER_LEVEL_INVERTED:EB.ENTER_LEVEL},t.enableMask=function(){this.stage=EB.ENABLED},t.exitMask=function(){0!==this._maskStack.length&&(this._maskStack.pop(),0===this._maskStack.length?this.stage=EB.DISABLED:this.stage=EB.ENABLED)},t.getWriteMask=function(){return 1<<this._maskStack.length-1},t.getExitWriteMask=function(){return 1<<this._maskStack.length},t.getStencilRef=function(){for(var e=0,t=0;t<this._maskStack.length;++t)e+=1<<t;return e},t.reset=function(){this._maskStack.length=0,this.stage=EB.DISABLED},t.destroy=function(){this.stencilStateMap.forEach((function(e){e.destroy()})),this.stencilStateMap.clear()},t.getStencilStage=function(e,t){var n=0,i=!1,r=!1,o=Si.LESS,a=this.stencilStateMap;if(t&&t.passes[0]){var s=t.passes[0].depthStencilState,c=0,l=0;s.depthTest&&(c=1),s.depthWrite&&(l=1),n=c|l<<1|s.depthFunc<<2|e<<6|this._maskStack.length<<9,i=s.depthTest,r=s.depthWrite,o=s.depthFunc,a=this.stencilStateMapWithDepth}else n=e<<16|this._maskStack.length;if(a&&a.has(n))return a.get(n);this.setStateFromStage(e);var u=new So(i,r,o,this._stencilPattern.stencilTest,this._stencilPattern.func,this._stencilPattern.stencilMask,this._stencilPattern.writeMask,this._stencilPattern.failOp,this._stencilPattern.zFailOp,this._stencilPattern.passOp,this._stencilPattern.ref,this._stencilPattern.stencilTest,this._stencilPattern.func,this._stencilPattern.stencilMask,this._stencilPattern.writeMask,this._stencilPattern.failOp,this._stencilPattern.zFailOp,this._stencilPattern.passOp,this._stencilPattern.ref);return a.set(n,u),u},t.getStencilHash=function(e){return e<<8|this._maskStack.length},t.setStateFromStage=function(e){var t=this._stencilPattern;e===EB.DISABLED?(t.stencilTest=!1,t.func=Si.ALWAYS,t.failOp=Ei.KEEP,t.stencilMask=t.writeMask=65535,t.ref=1):(t.stencilTest=!0,e===EB.ENABLED?(t.func=Si.EQUAL,t.failOp=Ei.KEEP,t.stencilMask=t.ref=this.getStencilRef(),t.writeMask=this.getWriteMask()):e===EB.CLEAR?(t.func=Si.NEVER,t.failOp=Ei.ZERO,t.writeMask=t.stencilMask=t.ref=this.getWriteMask()):e===EB.CLEAR_INVERTED||e===EB.ENTER_LEVEL?(t.func=Si.NEVER,t.failOp=Ei.REPLACE,t.writeMask=t.stencilMask=t.ref=this.getWriteMask()):e===EB.ENTER_LEVEL_INVERTED&&(t.func=Si.NEVER,t.failOp=Ei.ZERO,t.writeMask=t.stencilMask=t.ref=this.getWriteMask()))},h(e,[{key:"pattern",get:function(){return this._stencilPattern}}]),e}());oz.sharedManager=null,oz.sharedManager=new oz,et(Ti),function(e){e[e.ADD_COLOR=0]="ADD_COLOR",e[e.ADD_COLOR_AND_TEXTURE=1]="ADD_COLOR_AND_TEXTURE",e[e.GRAYSCALE=2]="GRAYSCALE",e[e.USE_ALPHA_SEPARATED=3]="USE_ALPHA_SEPARATED",e[e.USE_ALPHA_SEPARATED_AND_GRAY=4]="USE_ALPHA_SEPARATED_AND_GRAY"}(rz||(rz=e("InstanceMaterialType",{})));var az,sz,cz,lz,uz,hz,_z,fz,dz,pz,mz,vz,gz,yz,xz,Sz,Ez,Tz,Cz,bz,Az,wz,Iz,Pz,Rz,Dz,Oz,Nz,Mz,Lz,Fz,Bz,zz,Uz,kz,Gz,Hz,Vz,Wz,jz,qz,Xz,Yz,Kz,Qz,Jz,Zz,$z,eU,tU,nU,iU,rU,oU,aU,sU,cU,lU,uU,hU,_U,fU,dU,pU,mU,vU,gU,yU,xU,SU,EU=e("Renderable2D",(UB=dc("cc.Renderable2D"),kB=pc(zB),GB=Mc(),HB=Jc(Ov),VB=Jc(Ov),WB=Vc(),jB=Bc(),qB=Fc(),XB=Vc(),YB=Bc(),UB(KB=kB(KB=vc(KB=wc((iz=nz=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return E(t=e.call.apply(e,[this].concat(i))||this,"_materials",JB,y(t)),E(t,"_customMaterial",ZB,y(t)),t.stencilStage=EB.DISABLED,E(t,"_srcBlendFactor",$B,y(t)),E(t,"_dstBlendFactor",ez,y(t)),E(t,"_color",tz,y(t)),t._assembler=null,t._postAssembler=null,t._renderData=null,t._renderDataFlag=!0,t._renderFlag=!0,t._delegateSrc=null,t._instanceMaterialType=-1,t._blendState=new To,t._blendHash=0,t._useVertexOpacity=!1,t._lastParent=null,t}f(t,e);var n=t.prototype;return n.updateBlendHash=function(){var e=this._blendState.targets[0].blendDst<<4;this._blendHash=e|this._blendState.targets[0].blendSrc},n.__preload=function(){this.node._uiProps.uiComp=this,this._flushAssembler&&this._flushAssembler()},n.onEnable=function(){this.node.on(VT.ANCHOR_CHANGED,this._nodeStateChange,this),this.node.on(VT.SIZE_CHANGED,this._nodeStateChange,this),this.node.on(VT.PARENT_CHANGED,this._colorDirty,this),this.updateMaterial(),this._renderFlag=this._canRender(),this._colorDirty()},n.onRestore=function(){this.updateMaterial(),this.markForUpdateRenderData()},n.onDisable=function(){this.node.off(VT.ANCHOR_CHANGED,this._nodeStateChange,this),this.node.off(VT.SIZE_CHANGED,this._nodeStateChange,this),this.node.off(VT.PARENT_CHANGED,this._colorDirty,this),this._renderFlag=!1},n.onDestroy=function(){if(this.node._uiProps.uiComp===this&&(this.node._uiProps.uiComp=null),this.destroyRenderData(),this._materialInstances)for(var e=0;e<this._materialInstances.length;e++){var t=this._materialInstances[e];t&&t.destroy()}this._blendState&&this._blendState.destroy()},n.markForUpdateRenderData=function(e){if(void 0===e&&(e=!0),this._renderFlag=this._canRender(),e){var t=this._renderData;t&&(t.vertDirty=!0),this._renderDataFlag=e}else this._renderDataFlag=e},n.requestRenderData=function(){var e=wB.add();return this._renderData=e,e},n.destroyRenderData=function(){this._renderData&&(wB.remove(this._renderData),this._renderData=null)},n.updateAssembler=function(e){this._renderDataFlag&&(this._assembler.updateRenderData(this,e),this._renderDataFlag=!1),this._renderFlag&&this._render(e)},n.postUpdateAssembler=function(e){this._postAssembler&&this._renderFlag&&this._postRender(e)},n._render=function(){},n._postRender=function(){},n._canRender=function(){return this.isValid&&null!==this.getMaterial(0)&&this.enabled&&(this._delegateSrc?this._delegateSrc.activeInHierarchy:this.enabledInHierarchy)&&this._color.a>0},n._postCanRender=function(){},n.updateMaterial=function(){if(this._customMaterial)return this.setMaterial(this._customMaterial,0),this._renderData&&(this._renderData.material=this._customMaterial,this.markForUpdateRenderData(),this._renderData.passDirty=!0),void(this._blendHash=-1);var e=this._updateBuiltinMaterial();this.setMaterial(e,0),this._renderData&&(this._renderData.material=e,this.markForUpdateRenderData()),this._updateBlendFunc()},n._updateColor=function(){this.node._uiProps.colorDirty=!0,this._assembler&&(this._assembler.updateColor(this),this._renderFlag=this._canRender())},n._updateBlendFunc=function(){var e=this._blendState.targets[0];e||(e=new Eo,this._blendState.setTarget(0,e)),e.blendDst===this._dstBlendFactor&&e.blendSrc===this._srcBlendFactor||(e.blend=!0,e.blendDstAlpha=Ti.ONE_MINUS_SRC_ALPHA,e.blendDst=this._dstBlendFactor,e.blendSrc=this._srcBlendFactor,this.renderData&&(this.renderData.passDirty=!0)),this.updateBlendHash()},n.getBlendState=function(){return this._blendState},n._nodeStateChange=function(){this._renderData&&this.markForUpdateRenderData();for(var e=0;e<this.node.children.length;++e){var n=this.node.children[e].getComponent(t);n&&n.markForUpdateRenderData()}},n._colorDirty=function(){this.node._uiProps.colorDirty=!0},n._onMaterialModified=function(t,n){this._renderData&&(this.markForUpdateRenderData(),this._renderData.passDirty=!0),e.prototype._onMaterialModified.call(this,t,n)},n._updateBuiltinMaterial=function(){var e;switch(this._instanceMaterialType){case rz.ADD_COLOR:e=nv.get("ui-base-material");break;case rz.GRAYSCALE:e=nv.get("ui-sprite-gray-material");break;case rz.USE_ALPHA_SEPARATED:e=nv.get("ui-sprite-alpha-sep-material");break;case rz.USE_ALPHA_SEPARATED_AND_GRAY:e=nv.get("ui-sprite-gray-alpha-sep-material");break;default:e=nv.get("ui-sprite-material")}return e},n.setNodeDirty=function(){this.renderData&&(this.renderData.nodeDirty=!0)},n.setTextureDirty=function(){this.renderData&&(this.renderData.textureDirty=!0)},h(t,[{key:"sharedMaterials",get:function(){return this._materials},set:function(e){for(var t=0;t<e.length;t++)e[t]!==this._materials[t]&&this.setMaterial(e[t],t);if(e.length<this._materials.length){for(var n=e.length;n<this._materials.length;n++)this.setMaterial(null,n);this._materials.splice(e.length)}}},{key:"customMaterial",get:function(){return this._customMaterial},set:function(e){this._customMaterial=e,this.updateMaterial()}},{key:"color",get:function(){return this._color},set:function(e){this._color.equals(e)||(this._color.set(e),this._updateColor())}},{key:"renderData",get:function(){return this._renderData}},{key:"delegateSrc",set:function(e){this._delegateSrc=e}},{key:"blendHash",get:function(){return this._blendHash}},{key:"useVertexOpacity",get:function(){return this._useVertexOpacity}}]),t}(jL),nz.BlendState=Ti,nz.Assembler=null,nz.PostAssembler=null,JB=T((QB=iz).prototype,"_materials",[$c],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),T(QB.prototype,"sharedMaterials",[$c,GB],Object.getOwnPropertyDescriptor(QB.prototype,"sharedMaterials"),QB.prototype),ZB=T(QB.prototype,"_customMaterial",[HB],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),T(QB.prototype,"customMaterial",[VB,WB,jB,qB,qc],Object.getOwnPropertyDescriptor(QB.prototype,"customMaterial"),QB.prototype),T(QB.prototype,"color",[XB,YB],Object.getOwnPropertyDescriptor(QB.prototype,"color"),QB.prototype),$B=T(QB.prototype,"_srcBlendFactor",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ti.SRC_ALPHA}}),ez=T(QB.prototype,"_dstBlendFactor",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ti.ONE_MINUS_SRC_ALPHA}}),tz=T(QB.prototype,"_color",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Qn.WHITE.clone()}}),KB=QB))||KB)||KB)||KB)||KB));b.internal.Renderable2D=EU,function(e){e[e.LEFT=0]="LEFT",e[e.CENTER=1]="CENTER",e[e.RIGHT=2]="RIGHT"}(gU||(gU=e("HorizontalTextAlignment",{}))),et(gU),function(e){e[e.TOP=0]="TOP",e[e.CENTER=1]="CENTER",e[e.BOTTOM=2]="BOTTOM"}(yU||(yU=e("VerticalTextAlignment",{}))),et(yU),function(e){e[e.NONE=0]="NONE",e[e.CLAMP=1]="CLAMP",e[e.SHRINK=2]="SHRINK",e[e.RESIZE_HEIGHT=3]="RESIZE_HEIGHT"}(xU||(xU=e("Overflow",{}))),et(xU),function(e){e[e.NONE=0]="NONE",e[e.BITMAP=1]="BITMAP",e[e.CHAR=2]="CHAR"}(SU||(SU=e("CacheMode",{}))),et(SU);var TU,CU,bU,AU=e("Label",(az=dc("cc.Label"),sz=Oc(),cz=mc(110),lz=Ic(),uz=Vc(),hz=Bc(),_z=Jc(gU),fz=Vc(),dz=Bc(),pz=Jc(yU),mz=Vc(),vz=Bc(),gz=Vc(),yz=Bc(),xz=Vc(),Sz=Mc(),Ez=Bc(),Tz=Vc(),Cz=Bc(),bz=Mc(),Az=Vc(),wz=Bc(),Iz=Jc(xU),Pz=Vc(),Rz=Bc(),Dz=Vc(),Oz=Bc(),Nz=Jc(pF),Mz=Vc(),Lz=Mc(),Fz=Bc(),Bz=Vc(),zz=Bc(),Uz=Jc(SU),kz=Vc(),Gz=Bc(),Hz=Vc(),Vz=Bc(),Wz=Vc(),jz=Bc(),qz=Vc(),Xz=Bc(),Yz=Mc(),Kz=Vc(),Qz=Bc(),az(Jz=sz(Jz=cz(Jz=lz((vU=mU=function(e){function t(){var t;return E(t=e.call(this)||this,"_string",$z,y(t)),E(t,"_horizontalAlign",eU,y(t)),E(t,"_verticalAlign",tU,y(t)),E(t,"_actualFontSize",nU,y(t)),E(t,"_fontSize",iU,y(t)),E(t,"_fontFamily",rU,y(t)),E(t,"_lineHeight",oU,y(t)),E(t,"_overflow",aU,y(t)),E(t,"_enableWrapText",sU,y(t)),E(t,"_font",cU,y(t)),E(t,"_isSystemFontUsed",lU,y(t)),E(t,"_spacingX",uU,y(t)),E(t,"_isItalic",hU,y(t)),E(t,"_isBold",_U,y(t)),E(t,"_isUnderline",fU,y(t)),E(t,"_underlineHeight",dU,y(t)),E(t,"_cacheMode",pU,y(t)),t._N$file=null,t._texture=null,t._ttfSpriteFrame=null,t._userDefinedFont=null,t._assemblerData=null,t._fontAtlas=null,t._letterTexture=null,t._ttfSpriteFrame=null,t}f(t,e);var n=t.prototype;return n.onEnable=function(){e.prototype.onEnable.call(this),this._font||this._isSystemFontUsed||(this.useSystemFont=!0),this._isSystemFontUsed&&!this._fontFamily&&(this.fontFamily="Arial"),this._applyFontTexture()},n.onDestroy=function(){if(this._assembler&&this._assembler.resetAssemblerData&&this._assembler.resetAssemblerData(this._assemblerData),this._assemblerData=null,this._ttfSpriteFrame){this._ttfSpriteFrame._resetDynamicAtlasFrame();var t=this._ttfSpriteFrame.texture;if(this._ttfSpriteFrame.destroy(),t){var n=t;n.image&&n.image.destroy(),t.destroy()}this._ttfSpriteFrame=null}this._letterTexture=null,e.prototype.onDestroy.call(this)},n.updateRenderData=function(e){void 0===e&&(e=!1),this.markForUpdateRenderData(),e&&(this._flushAssembler(),this.renderData&&(this.renderData.vertDirty=!0),this._applyFontTexture(),this._assembler&&this._assembler.updateRenderData(this))},n._render=function(e){e.commitComp(this,this.renderData,this._texture,this._assembler,null)},n._updateColor=function(){e.prototype._updateColor.call(this),this.updateRenderData(!1)},n._canRender=function(){if(!e.prototype._canRender.call(this)||!this._string)return!1;var t=this._font;if(t&&t instanceof PF){var n=t.spriteFrame;if(!n||!n.texture)return!1}return!0},n._flushAssembler=function(){var e=t.Assembler.getAssembler(this);this._assembler!==e&&(this.destroyRenderData(),this._assembler=e),this._renderData||this._assembler&&this._assembler.createData&&(this._renderData=this._assembler.createData(this),this._renderData.material=this.material)},n._applyFontTexture=function(){this.markForUpdateRenderData();var e=this._font;if(e instanceof PF){var t=e.spriteFrame;t&&t.texture&&(this._texture=t,this.renderData&&(this.renderData.textureDirty=!0),this.changeMaterialForDefine(),this._assembler&&this._assembler.updateRenderData(this))}else{if(this.cacheMode===SU.CHAR)this._letterTexture=this._assembler.getAssemblerData(),this._texture=this._letterTexture;else if(!this._ttfSpriteFrame){this._ttfSpriteFrame=new cF,this._assemblerData=this._assembler.getAssemblerData();var n=new Cm(this._assemblerData.canvas),i=new Xm;i.image=n,this._ttfSpriteFrame.texture=i}this.cacheMode!==SU.CHAR&&(this._texture=this._ttfSpriteFrame),this.changeMaterialForDefine()}},n.changeMaterialForDefine=function(){if(this._texture){var e=!1;if(this.cacheMode!==SU.CHAR){var t=this._texture.texture;if(t instanceof Em){var n=t.getPixelFormat();e=n===tm.RGBA_ETC1||n===tm.RGB_A_PVRTC_4BPPV1||n===tm.RGB_A_PVRTC_2BPPV1}}this._instanceMaterialType=e?rz.USE_ALPHA_SEPARATED:rz.ADD_COLOR_AND_TEXTURE,this.updateMaterial()}},n._updateBlendFunc=function(){e.prototype._updateBlendFunc.call(this)},h(t,[{key:"string",get:function(){return this._string},set:function(e){e=null==e?"":e.toString(),this._string!==e&&(this._string=e,this.updateRenderData())}},{key:"horizontalAlign",get:function(){return this._horizontalAlign},set:function(e){this._horizontalAlign!==e&&(this._horizontalAlign=e,this.updateRenderData())}},{key:"verticalAlign",get:function(){return this._verticalAlign},set:function(e){this._verticalAlign!==e&&(this._verticalAlign=e,this.updateRenderData())}},{key:"actualFontSize",get:function(){return this._actualFontSize},set:function(e){this._actualFontSize=e}},{key:"fontSize",get:function(){return this._fontSize},set:function(e){this._fontSize!==e&&(this._fontSize=e,this.updateRenderData())}},{key:"fontFamily",get:function(){return this._fontFamily},set:function(e){this._fontFamily!==e&&(this._fontFamily=e,this.updateRenderData())}},{key:"lineHeight",get:function(){return this._lineHeight},set:function(e){this._lineHeight!==e&&(this._lineHeight=e,this.updateRenderData())}},{key:"spacingX",get:function(){return this._spacingX},set:function(e){this._spacingX!==e&&(this._spacingX=e,this.updateRenderData())}},{key:"overflow",get:function(){return this._overflow},set:function(e){this._overflow!==e&&(this._overflow=e,this.updateRenderData())}},{key:"enableWrapText",get:function(){return this._enableWrapText},set:function(e){this._enableWrapText!==e&&(this._enableWrapText=e,this.updateRenderData())}},{key:"font",get:function(){return this._font},set:function(e){this._font!==e&&(this._isSystemFontUsed=!e,this._font=e,this._renderData&&(this.destroyRenderData(),this._renderData=null),this._fontAtlas=null,this.updateRenderData(!0))}},{key:"useSystemFont",get:function(){return this._isSystemFontUsed},set:function(e){this._isSystemFontUsed!==e&&(this.destroyRenderData(),this._renderData=null,this._isSystemFontUsed=!!e,e&&(this.font=null),this._flushAssembler(),this.updateRenderData())}},{key:"cacheMode",get:function(){return this._cacheMode},set:function(e){this._cacheMode!==e&&(this._cacheMode!==SU.BITMAP||this._font instanceof PF||!this._ttfSpriteFrame||this._ttfSpriteFrame._resetDynamicAtlasFrame(),this._cacheMode===SU.CHAR&&(this._ttfSpriteFrame=null),this._cacheMode=e,this.updateRenderData(!0))}},{key:"isBold",get:function(){return this._isBold},set:function(e){this._isBold!==e&&(this._isBold=e,this.updateRenderData())}},{key:"isItalic",get:function(){return this._isItalic},set:function(e){this._isItalic!==e&&(this._isItalic=e,this.updateRenderData())}},{key:"isUnderline",get:function(){return this._isUnderline},set:function(e){this._isUnderline!==e&&(this._isUnderline=e,this.updateRenderData())}},{key:"underlineHeight",get:function(){return this._underlineHeight},set:function(e){this._underlineHeight!==e&&(this._underlineHeight=e,this.updateRenderData())}},{key:"spriteFrame",get:function(){return this._texture}},{key:"ttfSpriteFrame",get:function(){return this._ttfSpriteFrame}},{key:"assemblerData",get:function(){return this._assemblerData}},{key:"fontAtlas",get:function(){return this._fontAtlas},set:function(e){this._fontAtlas=e}},{key:"_bmFontOriginalSize",get:function(){return this._font instanceof PF?this._font.fontSize:-1}}]),t}(EU),mU.HorizontalAlign=gU,mU.VerticalAlign=yU,mU.Overflow=xU,mU.CacheMode=SU,mU._canvasPool=YF.getInstance(),T((Zz=vU).prototype,"string",[uz,hz,jc],Object.getOwnPropertyDescriptor(Zz.prototype,"string"),Zz.prototype),T(Zz.prototype,"horizontalAlign",[_z,fz,dz],Object.getOwnPropertyDescriptor(Zz.prototype,"horizontalAlign"),Zz.prototype),T(Zz.prototype,"verticalAlign",[pz,mz,vz],Object.getOwnPropertyDescriptor(Zz.prototype,"verticalAlign"),Zz.prototype),T(Zz.prototype,"fontSize",[gz,yz],Object.getOwnPropertyDescriptor(Zz.prototype,"fontSize"),Zz.prototype),T(Zz.prototype,"fontFamily",[xz,Sz,Ez],Object.getOwnPropertyDescriptor(Zz.prototype,"fontFamily"),Zz.prototype),T(Zz.prototype,"lineHeight",[Tz,Cz],Object.getOwnPropertyDescriptor(Zz.prototype,"lineHeight"),Zz.prototype),T(Zz.prototype,"spacingX",[bz,Az,wz],Object.getOwnPropertyDescriptor(Zz.prototype,"spacingX"),Zz.prototype),T(Zz.prototype,"overflow",[Iz,Pz,Rz],Object.getOwnPropertyDescriptor(Zz.prototype,"overflow"),Zz.prototype),T(Zz.prototype,"enableWrapText",[Dz,Oz],Object.getOwnPropertyDescriptor(Zz.prototype,"enableWrapText"),Zz.prototype),T(Zz.prototype,"font",[Nz,Mz,Lz,Fz],Object.getOwnPropertyDescriptor(Zz.prototype,"font"),Zz.prototype),T(Zz.prototype,"useSystemFont",[Bz,zz],Object.getOwnPropertyDescriptor(Zz.prototype,"useSystemFont"),Zz.prototype),T(Zz.prototype,"cacheMode",[Uz,kz,Gz],Object.getOwnPropertyDescriptor(Zz.prototype,"cacheMode"),Zz.prototype),T(Zz.prototype,"isBold",[Hz,Vz],Object.getOwnPropertyDescriptor(Zz.prototype,"isBold"),Zz.prototype),T(Zz.prototype,"isItalic",[Wz,jz],Object.getOwnPropertyDescriptor(Zz.prototype,"isItalic"),Zz.prototype),T(Zz.prototype,"isUnderline",[qz,Xz],Object.getOwnPropertyDescriptor(Zz.prototype,"isUnderline"),Zz.prototype),T(Zz.prototype,"underlineHeight",[Yz,Nc,Kz,Qz],Object.getOwnPropertyDescriptor(Zz.prototype,"underlineHeight"),Zz.prototype),$z=T(Zz.prototype,"_string",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"label"}}),eU=T(Zz.prototype,"_horizontalAlign",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return gU.CENTER}}),tU=T(Zz.prototype,"_verticalAlign",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return yU.CENTER}}),nU=T(Zz.prototype,"_actualFontSize",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),iU=T(Zz.prototype,"_fontSize",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 40}}),rU=T(Zz.prototype,"_fontFamily",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"Arial"}}),oU=T(Zz.prototype,"_lineHeight",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 40}}),aU=T(Zz.prototype,"_overflow",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return xU.NONE}}),sU=T(Zz.prototype,"_enableWrapText",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),cU=T(Zz.prototype,"_font",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),lU=T(Zz.prototype,"_isSystemFontUsed",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),uU=T(Zz.prototype,"_spacingX",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),hU=T(Zz.prototype,"_isItalic",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),_U=T(Zz.prototype,"_isBold",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),fU=T(Zz.prototype,"_isUnderline",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),dU=T(Zz.prototype,"_underlineHeight",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 2}}),pU=T(Zz.prototype,"_cacheMode",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return SU.NONE}}),Jz=Zz))||Jz)||Jz)||Jz)||Jz));b.Label=AU,function(e){e[e.BUTT=0]="BUTT",e[e.ROUND=1]="ROUND",e[e.SQUARE=2]="SQUARE"}(TU||(TU={})),et(TU),function(e){e[e.BEVEL=0]="BEVEL",e[e.ROUND=1]="ROUND",e[e.MITER=2]="MITER"}(CU||(CU={})),et(CU),function(e){e[e.PT_CORNER=1]="PT_CORNER",e[e.PT_LEFT=2]="PT_LEFT",e[e.PT_BEVEL=4]="PT_BEVEL",e[e.PT_INNERBEVEL=8]="PT_INNERBEVEL"}(bU||(bU={})),et(bU);var wU=Math.PI,IU=Math.min,PU=Math.max,RU=Math.cos,DU=Math.sin,OU=Math.abs,NU=Math.sign,MU=.5522847493;function LU(e,t,n,i,r){e.moveTo(t-i,n),e.bezierCurveTo(t-i,n+r*MU,t-i*MU,n+r,t,n+r),e.bezierCurveTo(t+i*MU,n+r,t+i,n+r*MU,t+i,n),e.bezierCurveTo(t+i,n-r*MU,t+i*MU,n-r,t,n-r),e.bezierCurveTo(t-i*MU,n-r,t-i,n-r*MU,t-i,n),e.close()}function FU(e,t,n,i,r,o,a,s,c,l,u){var h,_,f,d,p,m,v,g,y,x,S,E,T,C,b,A;l>10||(p=.5*(o+s),m=.5*(a+c),v=.5*((h=.5*(t+i))+(f=.5*(i+o))),g=.5*((_=.5*(n+r))+(d=.5*(r+a))),((b=OU((i-s)*(C=c-n)-(r-c)*(T=s-t)))+(A=OU((o-s)*C-(a-c)*T)))*(b+A)<e.tessTol*(T*T+C*C)?e.addPoint(s,c,0===u?u|bU.PT_BEVEL:u):(FU(e,t,n,h,_,v,g,S=.5*(v+(y=.5*(f+p))),E=.5*(g+(x=.5*(d+m))),l+1,0),FU(e,S,E,y,x,p,m,s,c,l+1,u)))}var BU,zU,UU,kU,GU,HU,VU,WU,jU,qU,XU,YU,KU,QU,JU,ZU,$U,ek,tk,nk,ik,rk,ok,ak,sk,ck,lk,uk,hk,_k,fk,dk,pk,mk,vk,gk,yk,xk,Sk,Ek,Tk,Ck,bk,Ak,wk,Ik,Pk,Rk=function(e){function t(t,n){var i;return(i=e.call(this,t,n)||this).dx=0,i.dy=0,i.dmx=0,i.dmy=0,i.flags=0,i.len=0,i.reset(),i}return f(t,e),t.prototype.reset=function(){this.dx=0,this.dy=0,this.dmx=0,this.dmy=0,this.flags=0,this.len=0},t}(Tn),Dk=function(){function e(){this.closed=!1,this.bevel=0,this.complex=!0,this.points=[],this.reset()}return e.prototype.reset=function(){this.closed=!1,this.bevel=0,this.complex=!0,this.points?this.points.length=0:this.points=[]},e}(),Ok=function(){function e(){this.dataOffset=0,this.updatePathOffset=!1,this.pathLength=0,this.pathOffset=0,this.paths=[],this.tessTol=.25,this.distTol=.01,this.fillColor=Qn.WHITE.clone(),this.lineCap=TU.BUTT,this.strokeColor=Qn.BLACK.clone(),this.lineJoin=CU.MITER,this.lineWidth=0,this.pointsOffset=0,this._commandX=0,this._commandY=0,this._points=[],this._renderDataList=[],this._curPath=null}var t=e.prototype;return t.moveTo=function(e,t){this.updatePathOffset&&(this.pathOffset=this.pathLength,this.updatePathOffset=!1),this._addPath(),this.addPoint(e,t,bU.PT_CORNER),this._commandX=e,this._commandY=t},t.lineTo=function(e,t){this.addPoint(e,t,bU.PT_CORNER),this._commandX=e,this._commandY=t},t.bezierCurveTo=function(e,t,n,i,r,o){var a=this._curPath,s=a.points[a.points.length-1];s&&(s.x!==e||s.y!==t||n!==r||i!==o?(FU(this,s.x,s.y,e,t,n,i,r,o,0,bU.PT_CORNER),this._commandX=r,this._commandY=o):this.lineTo(r,o))},t.quadraticCurveTo=function(e,t,n,i){var r=this._commandX,o=this._commandY;this.bezierCurveTo(r+2/3*(e-r),o+2/3*(t-o),n+2/3*(e-n),i+2/3*(t-i),n,i)},t.arc=function(e,t,n,i,r,o){!function(e,t,n,i,r,o,a){var s,c,l=0,u=0,h=0,_=0,f=0,d=0,p=0,m=0,v=0,g=0,y=0,x=0,S=0,E=0;if(u=o-r,a=a||!1)if(OU(u)>=2*wU)u=2*wU;else for(;u<0;)u+=2*wU;else if(OU(u)>=2*wU)u=2*-wU;else for(;u>0;)u-=2*wU;for(c=0|PU(1,IU(OU(u)/(.5*wU)+.5,5)),h=OU(4/3*(1-RU(s=u/c/2))/DU(s)),a||(h=-h),E=0;E<=c;E++)d=t+(_=RU(l=r+u*(E/c)))*i,p=n+(f=DU(l))*i,m=-f*i*h,v=_*i*h,0===E?e.moveTo(d,p):e.bezierCurveTo(g+x,y+S,d-m,p-v,d,p),g=d,y=p,x=m,S=v}(this,e,t,n,i,r,o)},t.ellipse=function(e,t,n,i){LU(this,e,t,n,i),this._curPath.complex=!1},t.circle=function(e,t,n){LU(this,e,t,n,n),this._curPath.complex=!1},t.rect=function(e,t,n,i){this.moveTo(e,t),this.lineTo(e+n,t),this.lineTo(e+n,t+i),this.lineTo(e,t+i),this.close(),this._curPath.complex=!1},t.roundRect=function(e,t,n,i,r){!function(e,t,n,i,r,o){if(o<.1)e.rect(t,n,i,r);else{var a=IU(o,.5*OU(i))*NU(i),s=IU(o,.5*OU(r))*NU(r);e.moveTo(t,n+s),e.lineTo(t,n+r-s),e.bezierCurveTo(t,n+r-s*(1-MU),t+a*(1-MU),n+r,t+a,n+r),e.lineTo(t+i-a,n+r),e.bezierCurveTo(t+i-a*(1-MU),n+r,t+i,n+r-s*(1-MU),t+i,n+r-s),e.lineTo(t+i,n+s),e.bezierCurveTo(t+i,n+s*(1-MU),t+i-a*(1-MU),n,t+i-a,n),e.lineTo(t+a,n),e.bezierCurveTo(t+a*(1-MU),n,t,n+s*(1-MU),t,n+s),e.close()}}(this,e,t,n,i,r),this._curPath.complex=!1},t.clear=function(){this.pathLength=0,this.pathOffset=0,this.pointsOffset=0,this.dataOffset=0,this._curPath=null,this.paths.length=0,this._points.length=0;for(var e=this._renderDataList,t=0,n=e.length;t<n;t++){var i=e[t];i&&IB.remove(i)}this._renderDataList.length=0},t.close=function(){this._curPath.closed=!0},t.requestRenderData=function(){var e=IB.add();return this._renderDataList.push(e),e},t.getRenderDataList=function(){return 0===this._renderDataList.length&&this.requestRenderData(),this._renderDataList},t.addPoint=function(e,t,n){var i=this._curPath;if(i){var r=this._points,o=i.points,a=r[this.pointsOffset++];a?(a.x=e,a.y=t):(a=new Rk(e,t),r.push(a)),a.flags=n,o.push(a)}},t._addPath=function(){var e=this.pathLength,t=this.paths[e];return t?t.reset():(t=new Dk,this.paths.push(t)),this.pathLength++,this._curPath=t,t},e}(),Nk=iB.concat([new br("a_dist",ai.R32F)]),Mk=aB(Nk),Lk=sB(Nk),Fk=e("Graphics",(BU=dc("cc.Graphics"),zU=Oc(),UU=mc(110),kU=Ic(),GU=Bc(),HU=Jc(CU),VU=Bc(),WU=Jc(TU),jU=Bc(),qU=Bc(),XU=Bc(),YU=Bc(),KU=Mc(),BU(QU=zU(QU=UU(QU=kU((ok=rk=function(e){function t(){var t;return(t=e.call(this)||this).impl=null,t.model=null,E(t,"_lineWidth",ZU,y(t)),E(t,"_strokeColor",$U,y(t)),E(t,"_lineJoin",ek,y(t)),E(t,"_lineCap",tk,y(t)),E(t,"_fillColor",nk,y(t)),E(t,"_miterLimit",ik,y(t)),t._isDrawing=!1,t._isNeedUploadData=!0,t._graphicsUseSubMeshes=[],t._instanceMaterialType=rz.ADD_COLOR,t.impl=new Ok,t}f(t,e);var n=t.prototype;return n.onRestore=function(){this.impl||this._flushAssembler()},n.onLoad=function(){this.model=KO.root.createModel(Ug),this.model.node=this.model.transform=this.node,this._flushAssembler()},n.onEnable=function(){e.prototype.onEnable.call(this),this._updateMtlForGraphics()},n.onDisable=function(){e.prototype.onDisable.call(this)},n.onDestroy=function(){this._sceneGetter=null,this.model&&(KO.root.destroyModel(this.model),this.model=null);var t=this._graphicsUseSubMeshes.length;if(t>0){for(var n=0;n<t;++n)this._graphicsUseSubMeshes[n].destroy();this._graphicsUseSubMeshes.length=0}this.impl&&(this._isDrawing=!1,this.impl.clear(),this.impl=null),e.prototype.onDestroy.call(this)},n.moveTo=function(e,t){this.impl&&this.impl.moveTo(e,t)},n.lineTo=function(e,t){this.impl&&this.impl.lineTo(e,t)},n.bezierCurveTo=function(e,t,n,i,r,o){this.impl&&this.impl.bezierCurveTo(e,t,n,i,r,o)},n.quadraticCurveTo=function(e,t,n,i){this.impl&&this.impl.quadraticCurveTo(e,t,n,i)},n.arc=function(e,t,n,i,r,o){this.impl&&this.impl.arc(e,t,n,i,r,o)},n.ellipse=function(e,t,n,i){this.impl&&this.impl.ellipse(e,t,n,i)},n.circle=function(e,t,n){this.impl&&this.impl.circle(e,t,n)},n.rect=function(e,t,n,i){this.impl&&this.impl.rect(e,t,n,i)},n.roundRect=function(e,t,n,i,r){this.impl&&this.impl.roundRect(e,t,n,i,r)},n.fillRect=function(e,t,n,i){this.rect(e,t,n,i),this.fill()},n.clear=function(){if(this.impl){if(this.impl.clear(),this._isDrawing=!1,this.model)for(var e=0;e<this.model.subModels.length;e++)this.model.subModels[e].inputAssembler.indexCount=0;this.markForUpdateRenderData()}},n.close=function(){this.impl&&this.impl.close()},n.stroke=function(){this._assembler||this._flushAssembler(),this._isDrawing=!0,this._isNeedUploadData=!0,this._assembler.stroke(this)},n.fill=function(){this._assembler||this._flushAssembler(),this._isDrawing=!0,this._isNeedUploadData=!0,this._assembler.fill(this)},n._updateMtlForGraphics=function(){var e;this._customMaterial?e=this.getMaterialInstance(0):(e=nv.get("ui-graphics-material"),this.setMaterial(e,0),(e=this.getMaterialInstance(0)).recompileShaders({USE_LOCAL:!0}))},n.activeSubModel=function(e){if(this.model){if(this.model.subModels.length<=e){var t=b.director.root.device,n=t.createBuffer(new cr(li.VERTEX|li.TRANSFER_DST,_i.DEVICE,65535*Lk,Lk)),i=t.createBuffer(new cr(li.INDEX|li.TRANSFER_DST,_i.DEVICE,131070*Uint16Array.BYTES_PER_ELEMENT,Uint16Array.BYTES_PER_ELEMENT)),r=new HA([n],Nk,Oi.TRIANGLE_LIST,i);r.subMeshIdx=0,this.model.initSubModel(e,r,this.getMaterialInstance(0)),this._graphicsUseSubMeshes.push(r)}}else q(4500,this.node.name)},n._uploadData=function(){var e=this.impl;if(e){var t=e&&e.getRenderDataList();if(!(t.length<=0)&&this.model){for(var n=this.model.subModels,i=0;i<t.length;i++){var r=t[i],o=n[i].inputAssembler;if(r.lastFilledVertex!==r.vertexStart){var a=new Float32Array(r.vData.buffer,0,r.vertexStart*Mk);o.vertexBuffers[0].update(a),o.vertexCount=r.vertexStart;var s=new Uint16Array(r.iData.buffer,0,r.indexStart);o.indexBuffer.update(s),o.indexCount=r.indexStart,r.lastFilledVertex=r.vertexStart,r.lastFilledIndex=r.indexStart}}this._isNeedUploadData=!1}}},n._render=function(e){if(this._isNeedUploadData){if(this.impl){var t=this.impl.getRenderDataList(),n=this.model.subModels.length;if(t.length>n)for(var i=n;i<t.length;i++)this.activeSubModel(i)}this._uploadData()}e.commitModel(this,this.model,this.getMaterialInstance(0))},n._flushAssembler=function(){var e=t.Assembler.getAssembler(this);this._assembler!==e&&(this._assembler=e)},n._canRender=function(){return!!e.prototype._canRender.call(this)&&!!this.model&&this._isDrawing},h(t,[{key:"lineWidth",get:function(){return this._lineWidth},set:function(e){this._lineWidth=e,this.impl&&(this.impl.lineWidth=e)}},{key:"lineJoin",get:function(){return this._lineJoin},set:function(e){this._lineJoin=e,this.impl&&(this.impl.lineJoin=e)}},{key:"lineCap",get:function(){return this._lineCap},set:function(e){this._lineCap=e,this.impl&&(this.impl.lineCap=e)}},{key:"strokeColor",get:function(){return this._strokeColor},set:function(e){this.impl&&(this._strokeColor.set(e),this.impl.strokeColor=this._strokeColor)}},{key:"fillColor",get:function(){return this._fillColor},set:function(e){this.impl&&(this._fillColor.set(e),this.impl.fillColor=this._fillColor)}},{key:"miterLimit",get:function(){return this._miterLimit},set:function(e){this._miterLimit=e}},{key:"color",get:function(){return this._color},set:function(e){this._color!==e&&this._color.set(e)}},{key:"srcBlendFactor",get:function(){return this._srcBlendFactor},set:function(){}},{key:"dstBlendFactor",get:function(){return this._dstBlendFactor},set:function(){}}]),t}(EU),rk.LineJoin=CU,rk.LineCap=TU,T((JU=ok).prototype,"lineWidth",[Nc,GU],Object.getOwnPropertyDescriptor(JU.prototype,"lineWidth"),JU.prototype),T(JU.prototype,"lineJoin",[HU,VU],Object.getOwnPropertyDescriptor(JU.prototype,"lineJoin"),JU.prototype),T(JU.prototype,"lineCap",[WU,jU],Object.getOwnPropertyDescriptor(JU.prototype,"lineCap"),JU.prototype),T(JU.prototype,"strokeColor",[qU],Object.getOwnPropertyDescriptor(JU.prototype,"strokeColor"),JU.prototype),T(JU.prototype,"fillColor",[XU],Object.getOwnPropertyDescriptor(JU.prototype,"fillColor"),JU.prototype),T(JU.prototype,"miterLimit",[YU],Object.getOwnPropertyDescriptor(JU.prototype,"miterLimit"),JU.prototype),T(JU.prototype,"color",[$c,KU],Object.getOwnPropertyDescriptor(JU.prototype,"color"),JU.prototype),ZU=T(JU.prototype,"_lineWidth",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),$U=T(JU.prototype,"_strokeColor",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Qn.BLACK.clone()}}),ek=T(JU.prototype,"_lineJoin",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return CU.MITER}}),tk=T(JU.prototype,"_lineCap",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return TU.BUTT}}),nk=T(JU.prototype,"_fillColor",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Qn.WHITE.clone()}}),ik=T(JU.prototype,"_miterLimit",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 10}}),QU=JU))||QU)||QU)||QU)||QU));b.Graphics=Fk;var Bk,zk=new kn,Uk=new Tn,kk=new kn,Gk=[];!function(e){e[e.RECT=0]="RECT",e[e.ELLIPSE=1]="ELLIPSE",e[e.GRAPHICS_STENCIL=2]="GRAPHICS_STENCIL",e[e.IMAGE_STENCIL=3]="IMAGE_STENCIL"}(Bk||(Bk={})),et(Bk);var Hk=e("Mask",(ak=dc("cc.Mask"),sk=Oc(),ck=mc(110),lk=Ic(),uk=Jc(Bk),hk=Bc(),_k=Vc(),fk=Bc(),dk=Mc(),pk=Jc(cF),mk=Mc(),vk=Mc(),gk=zc(),yk=Mc(),xk=Mc(),ak(Sk=sk(Sk=ck(Sk=lk((Pk=Ik=function(e){function t(){var t;return(t=e.call(this)||this)._clearStencilMtl=null,t._clearModel=null,E(t,"_type",Tk,y(t)),E(t,"_inverted",Ck,y(t)),E(t,"_segments",bk,y(t)),E(t,"_spriteFrame",Ak,y(t)),E(t,"_alphaThreshold",wk,y(t)),t._graphics=null,t._clearModelMesh=null,t._instanceMaterialType=rz.ADD_COLOR,t}f(t,e);var n=t.prototype;return n.onLoad=function(){this._createClearModel(),this._createGraphics(),this._graphics&&this._graphics.onLoad()},n.onEnable=function(){e.prototype.onEnable.call(this),this._updateGraphics(),this._enableGraphics()},n.onRestore=function(){this._createGraphics(),e.prototype.updateMaterial.call(this),this._updateGraphics(),this._renderFlag=this._canRender()},n.onDisable=function(){e.prototype.onDisable.call(this),this._disableGraphics()},n.onDestroy=function(){this._clearModel&&this._clearModelMesh&&(KO.root.destroyModel(this._clearModel),this._clearModelMesh.destroy()),this._clearStencilMtl&&this._clearStencilMtl.destroy(),this._removeGraphics(),e.prototype.onDestroy.call(this)},n.isHit=function(e){var t=this.node._uiProps.uiTransformComp,n=t.contentSize,i=n.width,r=n.height,o=Uk;this.node.getWorldMatrix(zk),kn.invert(kk,zk),Tn.transformMat4(o,e,kk);var a=t.anchorPoint;o.x+=a.x*i,o.y+=a.y*r;var s=!1;if(this.type===Bk.RECT||this.type===Bk.GRAPHICS_STENCIL||this.type===Bk.IMAGE_STENCIL)s=o.x>=0&&o.y>=0&&o.x<=i&&o.y<=r;else if(this.type===Bk.ELLIPSE){var c=i/2,l=r/2,u=o.x-.5*i,h=o.y-.5*r;s=u*u/(c*c)+h*h/(l*l)<1}return this._inverted&&(s=!s),s},n._render=function(e){e.commitComp(this,this.renderData,null,this._assembler,null)},n._postRender=function(e){this._postAssembler&&e.commitComp(this,null,null,this._postAssembler,null)},n._nodeStateChange=function(t){e.prototype._nodeStateChange.call(this,t),this._updateGraphics()},n._canRender=function(){return!!e.prototype._canRender.call(this)&&null!==this._graphics&&(this._type!==Bk.IMAGE_STENCIL||null!==this._spriteFrame)},n._flushAssembler=function(){var e=t.Assembler.getAssembler(this),n=t.PostAssembler.getAssembler(this);this._assembler!==e&&(this.destroyRenderData(),this._assembler=e),this._postAssembler!==n&&(this._postAssembler=n),this._useRenderData()},n._createGraphics=function(){if(!this._graphics){var e=this._graphics=new Fk;e._objFlags|=ol.Flags.IsOnLoadCalled,e.node=this.node,e.node.getWorldMatrix(),e.lineWidth=0;var t=Qn.WHITE.clone();t.a=0,e.fillColor=t}this._updateMaterial()},n._updateGraphics=function(){if(this._graphics&&(this._type===Bk.RECT||this._type===Bk.ELLIPSE)){var e=this.node._uiProps.uiTransformComp,t=this._graphics;t.clear();var n=e.contentSize,i=n.width,r=n.height,o=e.anchorPoint,a=-i*o.x,s=-r*o.y;if(this._type===Bk.RECT)t.rect(a,s,i,r);else if(this._type===Bk.ELLIPSE){for(var c=function(e,t,n){Gk.length=0;for(var i=2*Math.PI/n,r=0;r<n;++r)Gk.push(new yn(t.x*Math.cos(i*r)+e.x,t.y*Math.sin(i*r)+e.y,0));return Gk}(new yn(a+i/2,s+r/2,0),new yn(i/2,r/2,0),this._segments),l=0;l<c.length;++l){var u=c[l];0===l?t.moveTo(u.x,u.y):t.lineTo(u.x,u.y)}t.close()}t.fill()}},n._createClearModel=function(){if(!this._clearModel){var e=nv.get("default-clear-stencil");this._clearStencilMtl=new Hg({parent:e,owner:this,subModelIdx:0}),this._clearModel=KO.root.createModel(Ug),this._clearModel.node=this._clearModel.transform=this.node;var t=sB(nB),n=b.director.root.device,i=n.createBuffer(new cr(li.VERTEX|li.TRANSFER_DST,_i.DEVICE,4*t,t)),r=new Float32Array([-1,-1,0,1,-1,0,-1,1,0,1,1,0]);i.update(r);var o=n.createBuffer(new cr(li.INDEX|li.TRANSFER_DST,_i.DEVICE,6*Uint16Array.BYTES_PER_ELEMENT,Uint16Array.BYTES_PER_ELEMENT)),a=new Uint16Array([0,1,2,2,1,3]);o.update(a),this._clearModelMesh=new HA([i],nB,Oi.TRIANGLE_LIST,o),this._clearModelMesh.subMeshIdx=0,this._clearModel.initSubModel(0,this._clearModelMesh,this._clearStencilMtl)}},n._updateMaterial=function(){if(this._graphics){var e,t=this._graphics;t.stencilStage=EB.DISABLED,this._type===Bk.IMAGE_STENCIL?(e=nv.get("ui-alpha-test-material"),t.setMaterial(e,0),(e=t.getMaterialInstance(0)).setProperty("alphaThreshold",this._alphaThreshold)):(e=nv.get("ui-graphics-material"),t.setMaterial(e,0),t.getMaterialInstance(0))}},n._enableGraphics=function(){this._graphics&&(this._graphics._renderFlag=this._graphics._canRender())},n._disableGraphics=function(){this._graphics&&this._graphics.onDisable()},n._removeGraphics=function(){this._graphics&&(this._graphics.destroy(),this._graphics._destroyImmediate(),this._graphics=null)},n._useRenderData=function(){this._type!==Bk.IMAGE_STENCIL||this._renderData||this._assembler&&this._assembler.createData&&(this._renderData=this._assembler.createData(this),this.markForUpdateRenderData())},h(t,[{key:"type",get:function(){return this._type},set:function(e){this._type!==e&&(this._type=e,this.markForUpdateRenderData(!1),this._updateMaterial(),this._type!==Bk.IMAGE_STENCIL?(this._spriteFrame=null,this._updateGraphics(),this._renderData&&(this.destroyRenderData(),this._renderData=null)):(this._useRenderData(),this._graphics&&this._graphics.clear()))}},{key:"inverted",get:function(){return this._inverted},set:function(e){this._inverted=e,this.stencilStage=EB.DISABLED,this._graphics&&(this._graphics.stencilStage=EB.DISABLED)}},{key:"segments",get:function(){return this._segments},set:function(e){this._segments!==e&&(this._segments=en(e,3,1e4),this._updateGraphics())}},{key:"spriteFrame",get:function(){return this._spriteFrame},set:function(e){if(this._spriteFrame!==e){var t=this._spriteFrame;this._spriteFrame=e,this._type===Bk.IMAGE_STENCIL&&!t&&e&&this.markForUpdateRenderData()}}},{key:"alphaThreshold",get:function(){return this._alphaThreshold},set:function(e){this._alphaThreshold!==e&&(this._alphaThreshold=e,this.type===Bk.IMAGE_STENCIL&&this._graphics&&this._graphics.getMaterialInstance(0).setProperty("alphaThreshold",this._alphaThreshold))}},{key:"graphics",get:function(){return this._graphics}},{key:"dstBlendFactor",get:function(){return this._dstBlendFactor},set:function(e){this._dstBlendFactor!==e&&(this._dstBlendFactor=e,this._updateBlendFunc())}},{key:"srcBlendFactor",get:function(){return this._srcBlendFactor},set:function(e){this._srcBlendFactor!==e&&(this._srcBlendFactor=e,this._updateBlendFunc())}},{key:"color",get:function(){return this._color},set:function(e){this._color!==e&&(this._color.set(e),this.markForUpdateRenderData())}},{key:"customMaterial",get:function(){return this._customMaterial},set:function(){}}]),t}(EU),Ik.Type=Bk,T((Ek=Pk).prototype,"type",[uk,hk],Object.getOwnPropertyDescriptor(Ek.prototype,"type"),Ek.prototype),T(Ek.prototype,"inverted",[_k,fk],Object.getOwnPropertyDescriptor(Ek.prototype,"inverted"),Ek.prototype),T(Ek.prototype,"segments",[dk],Object.getOwnPropertyDescriptor(Ek.prototype,"segments"),Ek.prototype),T(Ek.prototype,"spriteFrame",[pk,mk],Object.getOwnPropertyDescriptor(Ek.prototype,"spriteFrame"),Ek.prototype),T(Ek.prototype,"alphaThreshold",[vk,gk,Hc],Object.getOwnPropertyDescriptor(Ek.prototype,"alphaThreshold"),Ek.prototype),T(Ek.prototype,"color",[$c,yk],Object.getOwnPropertyDescriptor(Ek.prototype,"color"),Ek.prototype),T(Ek.prototype,"customMaterial",[$c,xk],Object.getOwnPropertyDescriptor(Ek.prototype,"customMaterial"),Ek.prototype),Tk=T(Ek.prototype,"_type",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Bk.RECT}}),Ck=T(Ek.prototype,"_inverted",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),bk=T(Ek.prototype,"_segments",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 64}}),Ak=T(Ek.prototype,"_spriteFrame",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),wk=T(Ek.prototype,"_alphaThreshold",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),Sk=Ek))||Sk)||Sk)||Sk)||Sk));wP._maskComp=Hk,b.Mask=Hk;var Vk,Wk,jk,qk,Xk,Yk,Kk,Qk,Jk,Zk,$k,eG,tG,nG,iG,rG,oG,aG,sG,cG,lG,uG,hG,_G,fG,dG,pG,mG,vG,gG,yG,xG,SG,EG,TG,CG,bG,AG,wG,IG,PG,RG,DG,OG,NG,MG,LG,FG,BG,zG,UG,kG,GG,HG,VG,WG,jG,qG,XG,YG,KG,QG,JG=/^(click)(\s)*=|(param)(\s)*=/,ZG=/(\s)*src(\s)*=|(\s)*height(\s)*=|(\s)*width(\s)*=|(\s)*align(\s)*=|(\s)*offset(\s)*=|(\s)*click(\s)*=|(\s)*param(\s)*=/,$G=e("HtmlTextParser",function(){function e(){this._specialSymbolArray=[],this._stack=[],this._resultObjectArray=[],this._specialSymbolArray.push([/&lt;/g,"<"]),this._specialSymbolArray.push([/&gt;/g,">"]),this._specialSymbolArray.push([/&amp;/g,"&"]),this._specialSymbolArray.push([/&quot;/g,'"']),this._specialSymbolArray.push([/&apos;/g,"'"])}var t=e.prototype;return t.parse=function(e){this._resultObjectArray.length=0,this._stack.length=0;for(var t=0,n=e.length;t<n;){var i=e.indexOf(">",t),r=-1;if(i>=0&&(r=e.lastIndexOf("<",i))<t-1&&(r=e.indexOf("<",i+1),i=e.indexOf(">",r+1)),r<0)this._stack.pop(),this._processResult(e.substring(t)),t=n;else{var o=e.substring(t,r),a=e.substring(r+1,i);""===a&&(o=e.substring(t,i+1)),this._processResult(o),-1===i?i=r:"/"===e.charAt(r+1)?this._stack.pop():this._addToStack(a),t=i+1}}return this._resultObjectArray},t._attributeToObject=function(e){e=e.trim();var t={},n=/^(color|size)(\s)*=/.exec(e),i="",r=0,o="";if(n){if(i=n[0],""===(e=e.substring(i.length).trim()))return t;switch(r=e.indexOf(" "),i[0]){case"c":t.color=r>-1?e.substring(0,r).trim():e;break;case"s":t.size=parseInt(e)}return r>-1&&(o=e.substring(r+1).trim(),t.event=this._processEventHandler(o)),t}if((n=/^(br(\s)*\/)/.exec(e))&&n[0].length>0&&(i=n[0].trim()).startsWith("br")&&"/"===i[i.length-1])return t.isNewLine=!0,this._resultObjectArray.push({text:"",style:{isNewLine:!0}}),t;var a="",s=-1;if((n=/^(img(\s)*src(\s)*=[^>]+\/)/.exec(e))&&n[0].length>0&&(i=n[0].trim()).startsWith("img")&&"/"===i[i.length-1]){var c;n=ZG.exec(e);for(var l=!1;n;){var u=(i=(e=e.substring(e.indexOf(n[0]))).substr(0,n[0].length)).length;if(i=(i=i.replace(/[^a-zA-Z]/g,"").trim()).toLowerCase(),a=e.substring(u).trim(),s="src"===i?this.getRightQuotationIndex(a):-1,c=(r=a.indexOf(" ",s+1>=a.length?-1:s+1))>-1?a.substr(0,r):a,e=a.substring(r).trim(),c.endsWith("/")&&(c=c.slice(0,-1)),"src"===i){switch(c.charCodeAt(0)){case 34:case 39:l=!0,c=c.slice(1,-1)}t.isImage=!0,t.src=c}else if("height"===i)t.imageHeight=parseInt(c);else if("width"===i)t.imageWidth=parseInt(c);else if("align"===i){switch(c.charCodeAt(0)){case 34:case 39:c=c.slice(1,-1)}t.imageAlign=c.toLowerCase()}else"offset"===i?t.imageOffset=c:"click"===i&&(t.event=this._processEventHandler(i+"="+c));t.event&&"param"===i&&(t.event[i]=c.replace(/^"|"$/g,"")),n=ZG.exec(e)}return l&&t.isImage&&this._resultObjectArray.push({text:"",style:t}),{}}if(n=/^(outline(\s)*[^>]*)/.exec(e)){var h={color:"#ffffff",width:1};if(e=n[0].substring("outline".length).trim()){var _,f=/(\s)*color(\s)*=|(\s)*width(\s)*=|(\s)*click(\s)*=|(\s)*param(\s)*=/;for(n=f.exec(e);n;)i=(e=e.substring(e.indexOf(n[0]))).substr(0,n[0].length),_=(r=(a=e.substring(i.length).trim()).indexOf(" "))>-1?a.substr(0,r):a,i=(i=i.replace(/[^a-zA-Z]/g,"").trim()).toLowerCase(),e=a.substring(r).trim(),"click"===i?t.event=this._processEventHandler(i+"="+_):"color"===i?h.color=_:"width"===i&&(h.width=parseInt(_)),t.event&&"param"===i&&(t.event[i]=_.replace(/^"|"$/g,"")),n=f.exec(e)}t.outline=h}if((n=/^(on|u|b|i)(\s)*/.exec(e))&&n[0].length>0){switch(i=n[0],e=e.substring(i.length).trim(),i[0]){case"u":t.underline=!0;break;case"i":t.italic=!0;break;case"b":t.bold=!0}if(""===e)return t;t.event=this._processEventHandler(e)}return t},t.getRightQuotationIndex=function(e){var t=-1,n=-1,i=e.indexOf("'"),r=e.indexOf('"'),o=r>-1&&(r<i||-1===i);return i>-1&&(i<r||-1===r)?(t=i,n=e.indexOf("'",t+1>=e.length?-1:t+1)):o&&(t=r,n=e.indexOf('"',t+1>=e.length?-1:t+1)),n},t._processEventHandler=function(e){for(var t={},n=0,i=!1,r=JG.exec(e);r;){var o=r[0],a="";if(i=!1,'"'===(e=e.substring(o.length).trim()).charAt(0))(n=e.indexOf('"',1))>-1&&(a=e.substring(1,n).trim(),i=!0),n++;else if("'"===e.charAt(0))(n=e.indexOf("'",1))>-1&&(a=e.substring(1,n).trim(),i=!0),n++;else{var s=/(\S)+/.exec(e);n=(a=s?s[0]:"").length}i&&(t[o=o.substring(0,o.length-1).trim()]=a),e=e.substring(n).trim(),r=JG.exec(e)}return t},t._addToStack=function(e){var t=this._attributeToObject(e);if(0===this._stack.length)this._stack.push(t);else{if(t.isNewLine||t.isImage)return;var n=this._stack[this._stack.length-1];for(var i in n)t[i]||(t[i]=n[i]);this._stack.push(t)}},t._processResult=function(e){0!==e.length&&(e=this._escapeSpecialSymbol(e),this._stack.length>0?this._resultObjectArray.push({text:e,style:this._stack[this._stack.length-1]}):this._resultObjectArray.push({text:e}))},t._escapeSpecialSymbol=function(e){for(var t,n=S(this._specialSymbolArray);!(t=n()).done;){var i=t.value,r=i[0],o=i[1];e=e.replace(r,o)}return e},e}()),eH=e("LabelOutline",(Vk=dc("cc.LabelOutline"),Wk=Oc(),jk=mc(110),qk=Ic(),Xk=pc(AU),Yk=Bc(),Kk=Bc(),Vk(Qk=Wk(Qk=jk(Qk=qk(Qk=Xk(Qk=wc((eG=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return E(t=e.call.apply(e,[this].concat(i))||this,"_color",Zk,y(t)),E(t,"_width",$k,y(t)),t}f(t,e);var n=t.prototype;return n.onEnable=function(){this._updateRenderData()},n.onDisable=function(){this._updateRenderData()},n._updateRenderData=function(){var e=this.node.getComponent(AU);e&&e.updateRenderData(!0)},h(t,[{key:"color",get:function(){return this._color},set:function(e){this._color!==e&&(this._color.set(e),this._updateRenderData())}},{key:"width",get:function(){return this._width},set:function(e){this._width!==e&&(this._width=e,this._updateRenderData())}}]),t}(ku),Zk=T((Jk=eG).prototype,"_color",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Qn(0,0,0,255)}}),$k=T(Jk.prototype,"_width",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 2}}),T(Jk.prototype,"color",[Yk],Object.getOwnPropertyDescriptor(Jk.prototype,"color"),Jk.prototype),T(Jk.prototype,"width",[Kk],Object.getOwnPropertyDescriptor(Jk.prototype,"width"),Jk.prototype),Qk=Jk))||Qk)||Qk)||Qk)||Qk)||Qk)||Qk));b.LabelOutline=eH,function(e){e[e.SIMPLE=0]="SIMPLE",e[e.SLICED=1]="SLICED",e[e.TILED=2]="TILED",e[e.FILLED=3]="FILLED"}(XG||(XG={})),et(XG),function(e){e[e.HORIZONTAL=0]="HORIZONTAL",e[e.VERTICAL=1]="VERTICAL",e[e.RADIAL=2]="RADIAL"}(YG||(YG={})),et(YG),function(e){e[e.CUSTOM=0]="CUSTOM",e[e.TRIMMED=1]="TRIMMED",e[e.RAW=2]="RAW"}(KG||(KG={})),et(KG),function(e){e.SPRITE_FRAME_CHANGED="spriteframe-changed"}(QG||(QG={}));var tH,nH=e("Sprite",(tG=dc("cc.Sprite"),nG=Oc(),iG=mc(110),rG=Ic(),oG=Jc(uF),aG=Vc(),sG=Bc(),cG=Jc(cF),lG=Vc(),uG=Bc(),hG=Jc(XG),_G=Vc(),fG=Bc(),dG=Jc(YG),pG=Vc(),mG=Bc(),vG=Vc(),gG=Bc(),yG=zc(),xG=Vc(),SG=Bc(),EG=zc(),TG=Vc(),CG=Bc(),bG=Mc(),AG=Vc(),wG=Bc(),IG=Vc(),PG=Bc(),RG=Jc(KG),DG=Vc(),OG=Bc(),tG(NG=nG(NG=iG(NG=rG((qG=jG=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return E(t=e.call.apply(e,[this].concat(i))||this,"_spriteFrame",LG,y(t)),E(t,"_type",FG,y(t)),E(t,"_fillType",BG,y(t)),E(t,"_sizeMode",zG,y(t)),E(t,"_fillCenter",UG,y(t)),E(t,"_fillStart",kG,y(t)),E(t,"_fillRange",GG,y(t)),E(t,"_isTrimmedMode",HG,y(t)),E(t,"_useGrayscale",VG,y(t)),E(t,"_atlas",WG,y(t)),t}f(t,e);var n=t.prototype;return n.__preload=function(){this.changeMaterialForDefine(),e.prototype.__preload.call(this)},n.onEnable=function(){e.prototype.onEnable.call(this),this._activateMaterial();var t=this._spriteFrame;t&&(this._updateUVs(),this._type===XG.SLICED&&t.on(cF.EVENT_UV_UPDATED,this._updateUVs,this))},n.onDisable=function(){this._spriteFrame&&this._type===XG.SLICED&&this._spriteFrame.off(cF.EVENT_UV_UPDATED,this._updateUVs,this)},n.onDestroy=function(){e.prototype.onDestroy.call(this)},n.changeSpriteFrameFromAtlas=function(e){if(this._atlas){var t=this._atlas.getSpriteFrame(e);this.spriteFrame=t}else console.warn("SpriteAtlas is null.")},n.changeMaterialForDefine=function(){var e,t=this._instanceMaterialType;this._spriteFrame&&(e=this._spriteFrame.texture);var n=!1;if(e instanceof Em){var i=e.getPixelFormat();n=i===tm.RGBA_ETC1||i===tm.RGB_A_PVRTC_4BPPV1||i===tm.RGB_A_PVRTC_2BPPV1}n&&this.grayscale?this._instanceMaterialType=rz.USE_ALPHA_SEPARATED_AND_GRAY:n?this._instanceMaterialType=rz.USE_ALPHA_SEPARATED:this.grayscale?this._instanceMaterialType=rz.GRAYSCALE:this._instanceMaterialType=rz.ADD_COLOR_AND_TEXTURE,t!==this._instanceMaterialType&&this.updateMaterial()},n._updateBuiltinMaterial=function(){var t=e.prototype._updateBuiltinMaterial.call(this);if(this.spriteFrame&&this.spriteFrame.texture instanceof _E){var n=_({SAMPLE_FROM_RT:!0},t.passes[0].defines),i=new Ov;i.initialize({effectAsset:t.effectAsset,defines:n}),t=i}return t},n._render=function(e){e.commitComp(this,this.renderData,this._spriteFrame,this._assembler,null)},n._canRender=function(){if(!e.prototype._canRender.call(this))return!1;var t=this._spriteFrame;return!(!t||!t.texture)},n._flushAssembler=function(){var e=t.Assembler.getAssembler(this);this._assembler!==e&&(this.destroyRenderData(),this._assembler=e),this._renderData||this._assembler&&this._assembler.createData&&(this._renderData=this._assembler.createData(this),this._renderData.material=this.getRenderMaterial(0),this.markForUpdateRenderData(),this.spriteFrame&&this._assembler.updateUVs(this),this._updateColor()),this._spriteFrame&&(this._type===XG.SLICED?this._spriteFrame.on(cF.EVENT_UV_UPDATED,this._updateUVs,this):this._spriteFrame.off(cF.EVENT_UV_UPDATED,this._updateUVs,this))},n._applySpriteSize=function(){if(this._spriteFrame){if(!this._spriteFrame.isDefault)if(KG.RAW===this._sizeMode){var e=this._spriteFrame.originalSize;this.node._uiProps.uiTransformComp.setContentSize(e)}else if(KG.TRIMMED===this._sizeMode){var t=this._spriteFrame.rect;this.node._uiProps.uiTransformComp.setContentSize(t.width,t.height)}this._activateMaterial()}},n._resized=function(){},n._activateMaterial=function(){var e=this._spriteFrame,t=this.getRenderMaterial(0);e&&t&&this.markForUpdateRenderData(),this._renderData&&(this._renderData.material=t)},n._updateUVs=function(){this._assembler&&this._assembler.updateUVs(this)},n._applySpriteFrame=function(e){var t=this._spriteFrame;e&&this._type===XG.SLICED&&e.off(cF.EVENT_UV_UPDATED,this._updateUVs,this),this._updateUVs();var n=!1;t&&(e&&e.texture===t.texture||(n=!0),n&&(this._renderData&&(this._renderData.textureDirty=!0),this.changeMaterialForDefine()),this._applySpriteSize(),this._type===XG.SLICED&&t.on(cF.EVENT_UV_UPDATED,this._updateUVs,this))},h(t,[{key:"spriteAtlas",get:function(){return this._atlas},set:function(e){this._atlas!==e&&(this._atlas=e)}},{key:"spriteFrame",get:function(){return this._spriteFrame},set:function(e){if(this._spriteFrame!==e){var t=this._spriteFrame;this._spriteFrame=e,this.markForUpdateRenderData(!1),this._applySpriteFrame(t)}}},{key:"type",get:function(){return this._type},set:function(e){this._type!==e&&(this._type=e,this._flushAssembler())}},{key:"fillType",get:function(){return this._fillType},set:function(e){this._fillType!==e&&(e===YG.RADIAL||this._fillType===YG.RADIAL?(this.destroyRenderData(),this._renderData=null):this._renderData&&this.markForUpdateRenderData(!0)),this._fillType=e,this._flushAssembler()}},{key:"fillCenter",get:function(){return this._fillCenter},set:function(e){this._fillCenter.x=e.x,this._fillCenter.y=e.y,this._type===XG.FILLED&&this._renderData&&this.markForUpdateRenderData()}},{key:"fillStart",get:function(){return this._fillStart},set:function(e){this._fillStart=en(e,0,1),this._type===XG.FILLED&&this._renderData&&(this.markForUpdateRenderData(),this._updateUVs())}},{key:"fillRange",get:function(){return this._fillRange},set:function(e){this._fillRange=en(e,-1,1),this._type===XG.FILLED&&this._renderData&&(this.markForUpdateRenderData(),this._updateUVs())}},{key:"trim",get:function(){return this._isTrimmedMode},set:function(e){this._isTrimmedMode!==e&&(this._isTrimmedMode=e,this._type===XG.SIMPLE&&this._renderData&&this.markForUpdateRenderData(!0))}},{key:"grayscale",get:function(){return this._useGrayscale},set:function(e){this._useGrayscale!==e&&(this._useGrayscale=e,this.changeMaterialForDefine(),this.updateMaterial())}},{key:"sizeMode",get:function(){return this._sizeMode},set:function(e){this._sizeMode!==e&&(this._sizeMode=e,e!==KG.CUSTOM&&this._applySpriteSize())}}]),t}(EU),jG.FillType=YG,jG.Type=XG,jG.SizeMode=KG,jG.EventType=QG,T((MG=qG).prototype,"spriteAtlas",[oG,aG,sG],Object.getOwnPropertyDescriptor(MG.prototype,"spriteAtlas"),MG.prototype),T(MG.prototype,"spriteFrame",[cG,lG,uG],Object.getOwnPropertyDescriptor(MG.prototype,"spriteFrame"),MG.prototype),T(MG.prototype,"type",[hG,_G,fG],Object.getOwnPropertyDescriptor(MG.prototype,"type"),MG.prototype),T(MG.prototype,"fillType",[dG,pG,mG],Object.getOwnPropertyDescriptor(MG.prototype,"fillType"),MG.prototype),T(MG.prototype,"fillCenter",[vG,gG],Object.getOwnPropertyDescriptor(MG.prototype,"fillCenter"),MG.prototype),T(MG.prototype,"fillStart",[yG,xG,SG],Object.getOwnPropertyDescriptor(MG.prototype,"fillStart"),MG.prototype),T(MG.prototype,"fillRange",[EG,TG,CG],Object.getOwnPropertyDescriptor(MG.prototype,"fillRange"),MG.prototype),T(MG.prototype,"trim",[bG,AG,wG],Object.getOwnPropertyDescriptor(MG.prototype,"trim"),MG.prototype),T(MG.prototype,"grayscale",[Nc,IG,PG],Object.getOwnPropertyDescriptor(MG.prototype,"grayscale"),MG.prototype),T(MG.prototype,"sizeMode",[RG,DG,OG],Object.getOwnPropertyDescriptor(MG.prototype,"sizeMode"),MG.prototype),LG=T(MG.prototype,"_spriteFrame",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),FG=T(MG.prototype,"_type",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return XG.SIMPLE}}),BG=T(MG.prototype,"_fillType",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return YG.HORIZONTAL}}),zG=T(MG.prototype,"_sizeMode",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return KG.TRIMMED}}),UG=T(MG.prototype,"_fillCenter",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Tn(0,0)}}),kG=T(MG.prototype,"_fillStart",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),GG=T(MG.prototype,"_fillRange",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),HG=T(MG.prototype,"_isTrimmedMode",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),VG=T(MG.prototype,"_useGrayscale",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),WG=T(MG.prototype,"_atlas",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),NG=MG))||NG)||NG)||NG)||NG));b.Sprite=nH;var iH,rH,oH,aH,sH,cH,lH,uH,hH,_H,fH,dH,pH,mH=e("RenderRoot2D",dc("cc.RenderRoot2D")(tH=mc(100)(tH=Ic()(tH=pc(zB)(tH=vc(tH=wc(tH=function(e){function t(){return e.apply(this,arguments)||this}f(t,e);var n=t.prototype;return n.onEnable=function(){b.director.root.batcher2D.addScreen(this)},n.onDisable=function(){b.director.root.batcher2D.removeScreen(this)},n.onDestroy=function(){b.director.root.batcher2D.removeScreen(this)},t}(ku))||tH)||tH)||tH)||tH)||tH)||tH),vH=new yn,gH=Je({OVERLAY:0,INTERSPERSE:1}),yH=e("Canvas",(iH=dc("cc.Canvas"),rH=Oc(),oH=mc(100),aH=Ic(),sH=Jc(VL),cH=Bc(),lH=Bc(),uH=Jc(VL),iH(hH=rH(hH=oH(hH=aH(hH=wc(hH=vc((T((_H=function(e){function t(){var t;return E(t=e.call(this)||this,"_cameraComponent",fH,y(t)),E(t,"_alignCanvasWithScreen",dH,y(t)),t._thisOnCameraResized=void 0,t._fitDesignResolution=void 0,t._pos=new yn,t._renderMode=gH.OVERLAY,t._thisOnCameraResized=t._onResizeCamera.bind(y(t)),t}f(t,e);var n=t.prototype;return n.__preload=function(){var e=this.getComponent("cc.Widget");e&&e.updateAlignment(),this._cameraComponent&&(this._cameraComponent._createCamera(),this._cameraComponent.node.on(VL.TARGET_TEXTURE_CHANGE,this._thisOnCameraResized)),this._onResizeCamera(),this.node.on(VT.TRANSFORM_CHANGED,this._thisOnCameraResized)},n.onEnable=function(){e.prototype.onEnable.call(this),this._cameraComponent&&this._cameraComponent.node.on(VL.TARGET_TEXTURE_CHANGE,this._thisOnCameraResized)},n.onDisable=function(){e.prototype.onDisable.call(this),this._cameraComponent&&this._cameraComponent.node.off(VL.TARGET_TEXTURE_CHANGE,this._thisOnCameraResized)},n.onDestroy=function(){e.prototype.onDestroy.call(this),this.node.off(VT.TRANSFORM_CHANGED,this._thisOnCameraResized)},n._onResizeCamera=function(){if(this._cameraComponent&&this._alignCanvasWithScreen){if(this._cameraComponent.targetTexture)this._cameraComponent.orthoHeight=tO.height/2;else{var e=Ku.windowSize;this._cameraComponent.orthoHeight=e.height/BO.getScaleY()/2}this.node.getWorldPosition(vH),this._cameraComponent.node.setWorldPosition(vH.x,vH.y,1e3)}},n._getViewPriority=function(){if(this._cameraComponent){var e,t=null===(e=this.cameraComponent)||void 0===e?void 0:e.priority;return this._renderMode===gH.OVERLAY?t|1<<30:t&~(1<<30)}return 0},h(t,[{key:"renderMode",get:function(){return this._renderMode},set:function(e){this._renderMode=e,this._cameraComponent&&(this._cameraComponent.priority=this._getViewPriority())}},{key:"cameraComponent",get:function(){return this._cameraComponent},set:function(e){this._cameraComponent!==e&&(this._cameraComponent=e,this._onResizeCamera())}},{key:"alignCanvasWithScreen",get:function(){return this._alignCanvasWithScreen},set:function(e){this._alignCanvasWithScreen=e,this._onResizeCamera()}}]),t}(mH)).prototype,"cameraComponent",[sH,cH],Object.getOwnPropertyDescriptor(_H.prototype,"cameraComponent"),_H.prototype),T(_H.prototype,"alignCanvasWithScreen",[lH],Object.getOwnPropertyDescriptor(_H.prototype,"alignCanvasWithScreen"),_H.prototype),fH=T(_H.prototype,"_cameraComponent",[uH],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),dH=T(_H.prototype,"_alignCanvasWithScreen",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),hH=_H))||hH)||hH)||hH)||hH)||hH)||hH));b.Canvas=yH,e("UIComponent",dc("cc.UIComponent")(pH=pc(zB)(pH=mc(110)(pH=vc(pH=wc(pH=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._lastParent=null,t.stencilStage=EB.DISABLED,t}f(t,e);var n=t.prototype;return n.__preload=function(){this.node._uiProps.uiComp=this},n.onEnable=function(){},n.onDisable=function(){},n.onDestroy=function(){this.node._uiProps.uiComp===this&&(this.node._uiProps.uiComp=null)},n.updateAssembler=function(){},n.postUpdateAssembler=function(){},n.markForUpdateRenderData=function(){},n.setNodeDirty=function(){},n.setTextureDirty=function(){},t}(ku))||pH)||pH)||pH)||pH)||pH);var xH,SH,EH,TH,CH,bH,AH,wH,IH,PH,RH,DH,OH,NH,MH,LH,FH,BH,zH,UH,kH,GH,HH,VH,WH,jH,qH,XH,YH,KH,QH,JH,ZH,$H,eV,tV,nV,iV,rV,oV=new $G,aV="RICHTEXT_CHILD",sV="RICHTEXT_Image_CHILD",cV=new Xe((function(e){if(!b.isValid(e.node))return!1;var t=e.node.getComponent(eH);return t&&(t.width=0),!0}),20),lV=new Xe((function(e){return b.isValid(e.node)}),10);function uV(e){return{node:new jb(e),comp:null,lineCount:0,styleIndex:0,imageOffset:"",clickParam:"",clickHandler:"",type:e}}function hV(e,t){var n;e===aV?n=cV._get():e===sV&&(n=lV._get());var i=(n=n||uV(e)).node;return i||(i=new jb(e)),i.hideFlags|=ol.Flags.DontSave|ol.Flags.HideInHierarchy,e===sV?(n.comp=i.getComponent(nH)||i.addComponent(nH),n.comp.spriteFrame=t,n.comp.type=nH.Type.SLICED,n.comp.sizeMode=nH.SizeMode.CUSTOM):(n.comp=i.getComponent(AU)||i.addComponent(AU),n.comp.string=t,n.comp.horizontalAlign=gU.LEFT,n.comp.verticalAlign=yU.TOP,n.comp.underlineHeight=2),i.setPosition(0,0,0),i._uiProps.uiTransformComp.setAnchorPoint(.5,.5),n.node=i,n.lineCount=0,n.styleIndex=0,n.imageOffset="",n.clickParam="",n.clickHandler="",n}var _V,fV=e("RichText",(xH=dc("cc.RichText"),SH=Oc(),EH=mc(110),TH=Ic(),CH=Bc(),bH=Jc(gU),AH=Bc(),wH=Jc(yU),IH=Bc(),PH=Bc(),RH=Bc(),DH=Jc(pF),OH=Bc(),NH=Bc(),MH=Vc(),LH=Jc(SU),FH=Bc(),BH=Bc(),zH=Bc(),UH=Jc(uF),kH=Bc(),GH=Bc(),xH(HH=SH(HH=EH(HH=TH(HH=wc((rV=iV=function(e){function t(){var t;return E(t=e.call(this)||this,"_lineHeight",WH,y(t)),E(t,"_string",jH,y(t)),E(t,"_horizontalAlign",qH,y(t)),E(t,"_verticalAlign",XH,y(t)),E(t,"_fontSize",YH,y(t)),E(t,"_maxWidth",KH,y(t)),E(t,"_fontFamily",QH,y(t)),E(t,"_font",JH,y(t)),E(t,"_isSystemFontUsed",ZH,y(t)),E(t,"_userDefinedFont",$H,y(t)),E(t,"_cacheMode",eV,y(t)),E(t,"_imageAtlas",tV,y(t)),E(t,"_handleTouchEvent",nV,y(t)),t._textArray=[],t._segments=[],t._labelSegmentsCache=[],t._linesWidth=[],t._lineCount=1,t._labelWidth=0,t._labelHeight=0,t._layoutDirty=!0,t._lineOffsetX=0,t._updateRichTextStatus=void 0,t._labelChildrenNum=0,t._updateRichTextStatus=t._updateRichText,t}f(t,e);var n=t.prototype;return n.onLoad=function(){this.node.on(VT.LAYER_CHANGED,this._applyLayer,this)},n.onEnable=function(){this.handleTouchEvent&&this._addEventListeners(),this._updateRichText(),this._activateChildren(!0)},n.onDisable=function(){this.handleTouchEvent&&this._removeEventListeners(),this._activateChildren(!1)},n.start=function(){this._onTTFLoaded(),this.node.on(VT.ANCHOR_CHANGED,this._updateRichTextPosition,this)},n.onRestore=function(){},n.onDestroy=function(){for(var e,t=S(this._segments);!(e=t()).done;){var n=e.value;n.node.removeFromParent(),n.type===aV?cV.put(n):n.type===sV&&lV.put(n)}this.node.off(VT.ANCHOR_CHANGED,this._updateRichTextPosition,this),this.node.off(VT.LAYER_CHANGED,this._applyLayer,this)},n._addEventListeners=function(){this.node.on(VT.TOUCH_END,this._onTouchEnded,this)},n._removeEventListeners=function(){this.node.off(VT.TOUCH_END,this._onTouchEnded,this)},n._updateLabelSegmentTextAttributes=function(){var e=this;this._segments.forEach((function(t){e._applyTextAttribute(t)}))},n._createFontLabel=function(e){return hV(aV,e)},n._createImage=function(e){return hV(sV,e)},n._onTTFLoaded=function(){this._font,this._layoutDirty=!0,this._updateRichText()},n.SplitLongStringApproximatelyIn2048=function(e,t){var n=[];if(this._calculateSize(t,e).x<2048)n.push(e);else for(var i=e.split("\n"),r=0;r<i.length;r++)if(this._calculateSize(t,i[r]).x<2048)n.push(i[r]);else{var o=this.splitLongStringOver2048(i[r],t);n.push.apply(n,o)}return n},n.splitLongStringOver2048=function(e,t){for(var n=[],i=e,r=0,o=i.length/2,a=i.substring(r,o),s=i.substring(o),c=this._calculateSize(t,a),l=(this._calculateSize(t,s),1*this.maxWidth);c.x>l;){if((o/=2)<1){o*=2;break}a=a.substring(r,o),s=i.substring(o),c=this._calculateSize(t,a)}for(var u=1e3,h=1;u&&r<e.length;){for(;u&&c.x<l;){var _=jF(s);_&&_.length>0&&(h=_[0].length),o+=h,a=i.substring(r,o),s=i.substring(o),c=this._calculateSize(t,a),u--}for(;u&&a.length>=2&&c.x>l;)o-=h,a=i.substring(r,o),c=this._calculateSize(t,a),h=1,u--;if(a.length>=2){var f=qF(a);f&&f.length>0&&a!==f[0]&&(o-=f[0].length,a=i.substring(r,o))}if(n.push(a),r=o,o+=a.length,a=i.substring(r,o),s=i.substring(o),u--,this._calculateSize(t,s).x<2048){r=e.length,o=e.length,a=s,n.push(a);break}c=this._calculateSize(t,a)}return n},n._measureText=function(e,t){var n=this,i=function(t){return n._calculateSize(e,t).width};return t?i(t):i},n._calculateSize=function(e,t){var n;return 0===this._labelSegmentsCache.length?(n=this._createFontLabel(t),this._labelSegmentsCache.push(n)):(n=this._labelSegmentsCache[0]).node.getComponent(AU).string=t,n.styleIndex=e,this._applyTextAttribute(n),n.node._uiProps.uiTransformComp.contentSize},n._onTouchEnded=function(e){for(var t,n=this,i=this.node.getComponents(ku),r=function(){var r=t.value,o=r.clickHandler,a=r.clickParam;o&&n._containsTouchLocation(r,e.touch.getUILocation())&&(i.forEach((function(t){var n=t[o];t.enabledInHierarchy&&n&&n.call(t,e,a)})),e.propagationStopped=!0)},o=S(this._segments);!(t=o()).done;)r()},n._containsTouchLocation=function(e,t){var n=e.node.getComponent(zB);return!!n&&n.getBoundingBoxToWorld().contains(t)},n._resetState=function(){for(var e=this.node.children,t=e.length-1;t>=0;t--){var n=e[t];if(n.name===aV||n.name===sV){n.parent===this.node?n.parent=null:e.splice(t,1);var i=uV(n.name);i.node=n,n.name===aV?(i.comp=n.getComponent(AU),cV.put(i)):(i.comp=n.getComponent(nH),lV.put(i)),this._labelChildrenNum--}}this._segments.length=0,this._labelSegmentsCache.length=0,this._linesWidth.length=0,this._lineOffsetX=0,this._lineCount=1,this._labelWidth=0,this._labelHeight=0,this._layoutDirty=!0},n._activateChildren=function(e){for(var t=this.node.children.length-1;t>=0;t--){var n=this.node.children[t];n.name!==aV&&n.name!==sV||(n.active=e)}},n._addLabelSegment=function(e,t){var n;if(0===this._labelSegmentsCache.length)n=this._createFontLabel(e);else{var i=(n=this._labelSegmentsCache.pop()).node.getComponent(AU);i&&(i.string=e)}var r=n.comp;return r.verticalAlign!==this._verticalAlign&&(r.verticalAlign=this._verticalAlign),n.styleIndex=t,n.lineCount=this._lineCount,n.node._uiProps.uiTransformComp.setAnchorPoint(0,0),n.node.layer=this.node.layer,this.node.insertChild(n.node,this._labelChildrenNum++),this._applyTextAttribute(n),this._segments.push(n),n},n._updateRichTextWithMaxWidth=function(e,t,n){var i=t;if(this._lineOffsetX>0&&i+this._lineOffsetX>this._maxWidth)for(var r=0;this._lineOffsetX<=this._maxWidth;){var o=this._getFirstWordLen(e,r,e.length),a=e.substr(r,o),s=this._measureText(n,a);if(!(this._lineOffsetX+s<=this._maxWidth)){if(r>0){var c=e.substr(0,r);this._addLabelSegment(c,n),e=e.substr(r,e.length),i=this._measureText(n,e)}this._updateLineInfo();break}this._lineOffsetX+=s,r+=o}if(i>this._maxWidth)for(var l=XF(e,i,this._maxWidth,this._measureText(n)),u=0;u<l.length;++u){var h=l[u],_=this._addLabelSegment(h,n).node._uiProps.uiTransformComp.contentSize;this._lineOffsetX+=_.width,l.length>1&&u<l.length-1&&this._updateLineInfo()}else this._lineOffsetX+=i,this._addLabelSegment(e,n)},n._isLastComponentCR=function(e){return e.length-1===e.lastIndexOf("\n")},n._updateLineInfo=function(){this._linesWidth.push(this._lineOffsetX),this._lineOffsetX=0,this._lineCount++},n._needsUpdateTextLayout=function(e){if(this._layoutDirty||!this._textArray||!e)return!0;if(this._textArray.length!==e.length)return!0;for(var t=0;t<this._textArray.length;t++){var n=this._textArray[t],i=e[t];if(n.text!==i.text)return!0;var r=n.style,o=i.style;if(r){if(o){if(!!o.outline!=!!r.outline)return!0;if(r.size!==o.size||r.italic!==o.italic||r.isImage!==o.isImage)return!0;if(r.src!==o.src||r.imageAlign!==o.imageAlign||r.imageHeight!==o.imageHeight||r.imageWidth!==o.imageWidth||r.imageOffset!==o.imageOffset)return!0}else if(r.size||r.italic||r.isImage||r.outline)return!0}else if(o&&(o.size||o.italic||o.isImage||o.outline))return!0}return!1},n._addRichTextImageElement=function(e){if(e.style){var t=e.style,n=t.src,i=this._imageAtlas&&n&&this._imageAtlas.getSpriteFrame(n);if(i){var r=this._createImage(i);switch(r.comp,t.imageAlign){case"top":r.node._uiProps.uiTransformComp.setAnchorPoint(0,1);break;case"center":r.node._uiProps.uiTransformComp.setAnchorPoint(0,.5);break;default:r.node._uiProps.uiTransformComp.setAnchorPoint(0,0)}t.imageOffset&&(r.imageOffset=t.imageOffset),r.node.layer=this.node.layer,this.node.insertChild(r.node,this._labelChildrenNum++),this._segments.push(r);var o=i.rect.clone(),a=1,s=o.width,c=o.height,l=t.imageWidth||0,u=t.imageHeight||0;u>0?(s*=a=u/c,c*=a):(s*=a=this._lineHeight/c,c*=a),l>0&&(s=l),this._maxWidth>0?(this._lineOffsetX+s>this._maxWidth&&this._updateLineInfo(),this._lineOffsetX+=s):(this._lineOffsetX+=s,this._lineOffsetX>this._labelWidth&&(this._labelWidth=this._lineOffsetX)),r.node._uiProps.uiTransformComp.setContentSize(s,c),r.lineCount=this._lineCount,r.clickHandler="",r.clickParam="";var h=t.event;h&&(r.clickHandler=h.click,r.clickParam=h.param)}else q(4400)}},n._updateRichText=function(){if(this.enabledInHierarchy){var e=oV.parse(this._string);if(!this._needsUpdateTextLayout(e))return this._textArray=e.slice(),void this._updateLabelSegmentTextAttributes();this._textArray=e.slice(),this._resetState();for(var t,n=!1,i=0;i<this._textArray.length;++i){var r=this._textArray[i],o=r.text;if(void 0!==o){if(""===o){if(r.style&&r.style.isNewLine){this._updateLineInfo();continue}if(r.style&&r.style.isImage&&this._imageAtlas){this._addRichTextImageElement(r);continue}}for(var a=(o=this.SplitLongStringApproximatelyIn2048(o,i).join("\n")).split("\n"),s=0;s<a.length;++s){var c=a[s];if(""!==c)if(n=!1,this._maxWidth>0){var l=this._measureText(i,c);this._updateRichTextWithMaxWidth(c,l,i),a.length>1&&s<a.length-1&&this._updateLineInfo()}else t=this._addLabelSegment(c,i),this._lineOffsetX+=t.node._uiProps.uiTransformComp.width,this._lineOffsetX>this._labelWidth&&(this._labelWidth=this._lineOffsetX),a.length>1&&s<a.length-1&&this._updateLineInfo();else{if(this._isLastComponentCR(o)&&s===a.length-1)continue;this._updateLineInfo(),n=!0}}}}n||this._linesWidth.push(this._lineOffsetX),this._maxWidth>0&&(this._labelWidth=this._maxWidth),this._labelHeight=(this._lineCount+DF)*this._lineHeight,this.node._uiProps.uiTransformComp.setContentSize(this._labelWidth,this._labelHeight),this._updateRichTextPosition(),this._layoutDirty=!1}},n._getFirstWordLen=function(e,t,n){var i=e.charAt(t);if(GF(i)||HF(i))return 1;for(var r=1,o=t+1;o<n&&!HF(i=e.charAt(o))&&!GF(i);++o)r++;return r},n._updateRichTextPosition=function(){for(var e=0,t=1,n=this._lineCount,i=this.node._uiProps.uiTransformComp,r=i.anchorX,o=i.anchorY,a=0;a<this._segments.length;++a){var s=this._segments[a],c=s.lineCount;c>t&&(e=0,t=c);var l=this._labelWidth*(.5*this._horizontalAlign-r);switch(this._horizontalAlign){case gU.LEFT:break;case gU.CENTER:l-=this._linesWidth[c-1]/2;break;case gU.RIGHT:l-=this._linesWidth[c-1]}var u=s.node.position;if(s.node.setPosition(e+l,this._lineHeight*(n-c)-this._labelHeight*o,u.z),c===t&&(e+=s.node._uiProps.uiTransformComp.width),s.node.getComponent(nH)){var h=s.node.position.clone(),_=this._lineHeight,f=this._lineHeight*(1+DF);switch(s.node._uiProps.uiTransformComp.anchorY){case 1:h.y+=_+(f-_)/2;break;case.5:h.y+=f/2;break;default:h.y+=(f-_)/2}if(s.imageOffset){var d=s.imageOffset.split(",");if(1===d.length&&d[0]){var p=parseFloat(d[0]);Number.isInteger(p)&&(h.y+=p)}else if(2===d.length){var m=parseFloat(d[0]),v=parseFloat(d[1]);Number.isInteger(m)&&(h.x+=m),Number.isInteger(v)&&(h.y+=v)}}s.node.position=h}var g=s.node.getComponent(eH);if(g){var y=s.node.position.clone();y.y-=g.width,s.node.position=y}}},n._convertLiteralColorValue=function(e){var t=e.toUpperCase();return Qn[t]?Qn[t]:(new Qn).fromHEX(e)},n._applyTextAttribute=function(e){var t=e.node.getComponent(AU);if(t){this._resetLabelState(t);var n,i=e.styleIndex;if(this._textArray[i]&&(n=this._textArray[i].style),n){if(t.color=this._convertLiteralColorValue(n.color||"white"),t.isBold=!!n.bold,t.isItalic=!!n.italic,t.isUnderline=!!n.underline,n.outline){var r=e.node.getComponent(eH);r||(r=e.node.addComponent(eH)),r.color=this._convertLiteralColorValue(n.outline.color),r.width=n.outline.width}t.fontSize=n.size||this._fontSize,e.clickHandler="",e.clickParam="";var o=n.event;o&&(e.clickHandler=o.click||"",e.clickParam=o.param||"")}t.cacheMode=this._cacheMode,this._font instanceof pF&&!this._isSystemFontUsed?t.font=this._font:t.fontFamily=this._fontFamily,t.useSystemFont=this._isSystemFontUsed,t.lineHeight=this._lineHeight,t.updateRenderData(!0);var a=t._assembler;a&&a.updateRenderData(t)}},n._applyLayer=function(){for(var e,t=S(this._segments);!(e=t()).done;)e.value.node.layer=this.node.layer},n._resetLabelState=function(e){e.fontSize=this._fontSize,e.color=Qn.WHITE,e.isBold=!1,e.isItalic=!1,e.isUnderline=!1},h(t,[{key:"string",get:function(){return this._string},set:function(e){this._string!==e&&(this._string=e,this._updateRichTextStatus())}},{key:"horizontalAlign",get:function(){return this._horizontalAlign},set:function(e){this.horizontalAlign!==e&&(this._horizontalAlign=e,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"verticalAlign",get:function(){return this._verticalAlign},set:function(e){this._verticalAlign!==e&&(this._verticalAlign=e,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"fontSize",get:function(){return this._fontSize},set:function(e){this._fontSize!==e&&(this._fontSize=e,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"fontFamily",get:function(){return this._fontFamily},set:function(e){this._fontFamily!==e&&(this._fontFamily=e,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"font",get:function(){return this._font},set:function(e){this._font!==e&&(this._font=e,this._layoutDirty=!0,this._font?(this.useSystemFont=!1,this._onTTFLoaded()):this.useSystemFont=!0,this._updateRichTextStatus())}},{key:"useSystemFont",get:function(){return this._isSystemFontUsed},set:function(e){this._isSystemFontUsed!==e&&(this._isSystemFontUsed=e,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"cacheMode",get:function(){return this._cacheMode},set:function(e){this._cacheMode!==e&&(this._cacheMode=e,this._updateRichTextStatus())}},{key:"maxWidth",get:function(){return this._maxWidth},set:function(e){this._maxWidth!==e&&(this._maxWidth=e,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"lineHeight",get:function(){return this._lineHeight},set:function(e){this._lineHeight!==e&&(this._lineHeight=e,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"imageAtlas",get:function(){return this._imageAtlas},set:function(e){this._imageAtlas!==e&&(this._imageAtlas=e,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"handleTouchEvent",get:function(){return this._handleTouchEvent},set:function(e){this._handleTouchEvent!==e&&(this._handleTouchEvent=e,this.enabledInHierarchy&&(this.handleTouchEvent?this._addEventListeners():this._removeEventListeners()))}}]),t}(ku),iV.HorizontalAlign=gU,iV.VerticalAlign=yU,T((VH=rV).prototype,"string",[jc,CH],Object.getOwnPropertyDescriptor(VH.prototype,"string"),VH.prototype),T(VH.prototype,"horizontalAlign",[bH,AH],Object.getOwnPropertyDescriptor(VH.prototype,"horizontalAlign"),VH.prototype),T(VH.prototype,"verticalAlign",[wH,IH],Object.getOwnPropertyDescriptor(VH.prototype,"verticalAlign"),VH.prototype),T(VH.prototype,"fontSize",[PH],Object.getOwnPropertyDescriptor(VH.prototype,"fontSize"),VH.prototype),T(VH.prototype,"fontFamily",[RH],Object.getOwnPropertyDescriptor(VH.prototype,"fontFamily"),VH.prototype),T(VH.prototype,"font",[DH,OH],Object.getOwnPropertyDescriptor(VH.prototype,"font"),VH.prototype),T(VH.prototype,"useSystemFont",[NH,MH],Object.getOwnPropertyDescriptor(VH.prototype,"useSystemFont"),VH.prototype),T(VH.prototype,"cacheMode",[LH,FH],Object.getOwnPropertyDescriptor(VH.prototype,"cacheMode"),VH.prototype),T(VH.prototype,"maxWidth",[BH],Object.getOwnPropertyDescriptor(VH.prototype,"maxWidth"),VH.prototype),T(VH.prototype,"lineHeight",[zH],Object.getOwnPropertyDescriptor(VH.prototype,"lineHeight"),VH.prototype),T(VH.prototype,"imageAtlas",[UH,kH],Object.getOwnPropertyDescriptor(VH.prototype,"imageAtlas"),VH.prototype),T(VH.prototype,"handleTouchEvent",[GH],Object.getOwnPropertyDescriptor(VH.prototype,"handleTouchEvent"),VH.prototype),WH=T(VH.prototype,"_lineHeight",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 40}}),jH=T(VH.prototype,"_string",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"<color=#00ff00>Rich</color><color=#0fffff>Text</color>"}}),qH=T(VH.prototype,"_horizontalAlign",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return gU.LEFT}}),XH=T(VH.prototype,"_verticalAlign",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return yU.TOP}}),YH=T(VH.prototype,"_fontSize",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 40}}),KH=T(VH.prototype,"_maxWidth",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),QH=T(VH.prototype,"_fontFamily",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"Arial"}}),JH=T(VH.prototype,"_font",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),ZH=T(VH.prototype,"_isSystemFontUsed",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),$H=T(VH.prototype,"_userDefinedFont",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),eV=T(VH.prototype,"_cacheMode",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return SU.NONE}}),tV=T(VH.prototype,"_imageAtlas",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),nV=T(VH.prototype,"_handleTouchEvent",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),HH=VH))||HH)||HH)||HH)||HH)||HH));b.RichText=fV;var dV=e("UIMeshRenderer",dc("cc.UIMeshRenderer")(_V=Oc()(_V=mc(110)(_V=Ic()(_V=wc(_V=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._modelComponent=null,t.stencilStage=EB.DISABLED,t}f(t,e);var n=t.prototype;return n.__preload=function(){this.node._uiProps.uiComp=this},n.onLoad=function(){this.node._uiProps.uiTransformComp||this.node.addComponent("cc.UITransform"),this._modelComponent=this.getComponent("cc.RenderableComponent"),this._modelComponent||console.warn("node '"+(this.node&&this.node.name)+"' doesn't have any renderable component")},n.onDestroy=function(){this.node._uiProps.uiComp===this&&(this.node._uiProps.uiComp=null),this._modelComponent=this.getComponent("cc.RenderableComponent"),this._modelComponent&&(this._modelComponent._sceneGetter=null)},n.updateAssembler=function(e){if(this._modelComponent){var t=this._modelComponent._collectModels();this._modelComponent._detachFromScene();for(var n=0;n<t.length;n++)t[n].enabled&&e.commitModel(this,t[n],this._modelComponent.material);return!0}return!1},n.postUpdateAssembler=function(){},n.update=function(){this._fitUIRenderQueue()},n._fitUIRenderQueue=function(){if(this._modelComponent)for(var e=this._modelComponent.sharedMaterials.length,t=0;t<e;t++){var n=this._modelComponent.getMaterialInstance(t);if(null!=n)for(var i=n.passes,r=i.length,o=0;o<r;o++)i[o]._priority=ad.MAX-11,n.recompileShaders({CC_FORCE_FORWARD_SHADING:!0},o)}},n.markForUpdateRenderData=function(){},n.setNodeDirty=function(){},n.setTextureDirty=function(){},h(t,[{key:"modelComponent",get:function(){return this._modelComponent}}]),t}(ku))||_V)||_V)||_V)||_V)||_V);b.UIMeshRenderer=dV;var pV,mV,vV,gV,yV,xV,SV,EV,TV,CV,bV,AV,wV,IV,PV,RV,DV,OV,NV,MV,LV,FV,BV,zV,UV,kV,GV,HV,VV,WV=rd.Enum.NONE|rd.Enum.UI_3D,jV=function(){function e(){this.bufferBatch=null,this.camera=null,this.renderScene=null,this.model=null,this.texture=null,this.sampler=null,this.useLocalData=null,this.isStatic=!1,this.textureHash=0,this.samplerHash=0,this._passes=[],this._shaders=[],this._visFlags=WV,this._inputAssembler=null,this._descriptorSet=null}var t=e.prototype;return t.destroy=function(){this._passes=[]},t.clear=function(){this.bufferBatch=null,this.inputAssembler=null,this.descriptorSet=null,this.camera=null,this.texture=null,this.sampler=null,this.textureHash=0,this.samplerHash=0,this.model=null,this.isStatic=!1,this.useLocalData=null,this.visFlags=WV,this.renderScene=null},t.fillPasses=function(e,t,n,i,r,o){if(e){var a=e.passes;if(!a)return;var s=0;this._shaders.length=a.length;for(var c=0;c<a.length;c++){this._passes[c]||(this._passes[c]=new lv(b.director.root));var l=a[c],u=this._passes[c];l.update(),t||(t=l.depthStencilState,n=0),i||(i=l.blendState,r=0),-1===r&&(r=0),s=n<<16|r,u._initPassFromTarget(l,t,i,s),this._shaders[c]=u.getShaderVariant(o)}}},h(e,[{key:"native",get:function(){return this._nativeObj}},{key:"inputAssembler",get:function(){return this._inputAssembler},set:function(e){this._inputAssembler=e}},{key:"descriptorSet",get:function(){return this._descriptorSet},set:function(e){this._descriptorSet=e}},{key:"visFlags",get:function(){return this._visFlags},set:function(e){this._visFlags=e}},{key:"passes",get:function(){return this._passes}},{key:"shaders",get:function(){return this._shaders}}]),e}(),qV=(e("UIStaticBatch",(pV=dc("cc.UIStaticBatch"),mV=Oc(),vV=Ic(),gV=mc(110),yV=Mc(),pV(xV=mV(xV=vV(xV=gV((T((SV=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._init=!1,t._bufferAccessor=null,t._dirty=!0,t._uiDrawBatchList=[],t}f(t,e);var n=t.prototype;return n.onLoad=function(){},n.onDestroy=function(){},n.updateAssembler=function(){},n.postUpdateAssembler=function(){},n.markAsDirty=function(){},n._requireDrawBatch=function(){var e=new jV;return e.isStatic=!0,this._uiDrawBatchList.push(e),e},n._clearData=function(){if(this._bufferAccessor){this._bufferAccessor.reset();for(var e=this._getBatcher(),t=0;t<this._uiDrawBatchList.length;t++)this._uiDrawBatchList[t].destroy(e)}this._uiDrawBatchList.length=0,this._init=!1},n._getBatcher=function(){return KO.root&&KO.root.batcher2D?KO.root.batcher2D:(q(9301),null)},h(t,[{key:"color",get:function(){return this._color},set:function(e){this._color!==e&&this._color.set(e)}},{key:"drawBatchList",get:function(){return this._uiDrawBatchList}}]),t}(EU)).prototype,"color",[$c,yV],Object.getOwnPropertyDescriptor(SV.prototype,"color"),SV.prototype),xV=SV))||xV)||xV)||xV)||xV)),e("LabelShadow",(EV=dc("cc.LabelShadow"),TV=Oc(),CV=mc(110),bV=Ic(),AV=pc(AU),wV=Bc(),IV=Bc(),PV=Bc(),EV(RV=TV(RV=CV(RV=bV(RV=AV(RV=wc((LV=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return E(t=e.call.apply(e,[this].concat(i))||this,"_color",OV,y(t)),E(t,"_offset",NV,y(t)),E(t,"_blur",MV,y(t)),t}f(t,e);var n=t.prototype;return n.onEnable=function(){this._updateRenderData()},n.onDisable=function(){this._updateRenderData()},n._updateRenderData=function(){var e=this.node.getComponent(AU);e&&e.updateRenderData(!0)},h(t,[{key:"color",get:function(){return this._color},set:function(e){this._color!==e&&(this._color.set(e),this._updateRenderData())}},{key:"offset",get:function(){return this._offset},set:function(e){this._offset=e,this._updateRenderData()}},{key:"blur",get:function(){return this._blur},set:function(e){this._blur=e,this._updateRenderData()}}]),t}(ku),OV=T((DV=LV).prototype,"_color",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Qn(0,0,0,255)}}),NV=T(DV.prototype,"_offset",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Tn(2,2)}}),MV=T(DV.prototype,"_blur",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 2}}),T(DV.prototype,"color",[wV],Object.getOwnPropertyDescriptor(DV.prototype,"color"),DV.prototype),T(DV.prototype,"offset",[IV],Object.getOwnPropertyDescriptor(DV.prototype,"offset"),DV.prototype),T(DV.prototype,"blur",[PV],Object.getOwnPropertyDescriptor(DV.prototype,"blur"),DV.prototype),RV=DV))||RV)||RV)||RV)||RV)||RV)||RV))),XV=(e("UIOpacity",(FV=dc("cc.UIOpacity"),BV=Oc(),zV=mc(110),UV=Ic(),kV=Bc(),FV(GV=BV(GV=zV(GV=UV(GV=wc(GV=vc((T((HV=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return E(t=e.call.apply(e,[this].concat(i))||this,"_opacity",VV,y(t)),t}f(t,e);var n=t.prototype;return n.onEnable=function(){this.node._uiProps.localOpacity=this._opacity/255},n.onDisable=function(){this.node._uiProps.localOpacity=1},h(t,[{key:"opacity",get:function(){return this._opacity},set:function(e){this._opacity!==e&&(e=dt(e,0,255),this._opacity=e,this.node._uiProps.localOpacity=e/255)}}]),t}(ku)).prototype,"opacity",[Nc,kV],Object.getOwnPropertyDescriptor(HV.prototype,"opacity"),HV.prototype),VV=T(HV.prototype,"_opacity",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 255}}),GV=HV))||GV)||GV)||GV)||GV)||GV)||GV)),function(e,t,n){this.i=void 0,this.x=void 0,this.y=void 0,this.prev=null,this.next=null,this.z=0,this.prevZ=null,this.nextZ=null,this.steiner=!1,this.i=e,this.x=t,this.y=n});function YV(e,t,n,i,r){var o=0,a=null;if(r===function(e,t,n,i){for(var r=0,o=t,a=n-i;o<n;o+=i)r+=(e[a]-e[o])*(e[o+1]+e[a+1]),a=o;return r}(e,t,n,i)>0)for(o=t;o<n;o+=i)a=_W(o,e[o],e[o+1],a);else for(o=n-i;o>=t;o-=i)a=_W(o,e[o],e[o+1],a);return a&&cW(a,a.next)&&(fW(a),a=a.next),a}function KV(e,t){if(void 0===t&&(t=null),!e)return e;t||(t=e);var n=e,i=!1;do{if(i=!1,n.steiner||!cW(n,n.next)&&0!==sW(n.prev,n,n.next))n=n.next;else{if(fW(n),(n=t=n.prev)===n.next)return null;i=!0}}while(i||n!==t);return t}function QV(e,t,n,i,r,o,a){if(void 0===a&&(a=0),e){!a&&o&&function(e,t,n,i){var r=e;do{null===r.z&&(r.z=iW(r.x,r.y,t,n,i)),r.prevZ=r.prev,r.nextZ=r.next,r=r.next}while(r!==e);r.prevZ.nextZ=null,r.prevZ=null,function(e){var t=0,n=null,i=null,r=null,o=null,a=0,s=0,c=0,l=1;do{for(n=e,e=null,o=null,a=0;n;){for(a++,i=n,s=0,t=0;t<l&&(s++,i=i.nextZ);t++);for(c=l;s>0||c>0&&i;)0===s?(r=i,i=i.nextZ,c--):0!==c&&i?n.z<=i.z?(r=n,n=n.nextZ,s--):(r=i,i=i.nextZ,c--):(r=n,n=n.nextZ,s--),o?o.nextZ=r:e=r,r.prevZ=o,o=r;n=i}o.nextZ=null,l*=2}while(a>1)}(r)}(e,i,r,o);for(var s=e,c=null,l=null;e.prev!==e.next;)if(c=e.prev,l=e.next,o?ZV(e,i,r,o):JV(e))t.push(c.i/n),t.push(e.i/n),t.push(l.i/n),fW(e),e=l.next,s=l.next;else if((e=l)===s){a?1===a?QV(e=$V(e,t,n),t,n,i,r,o,2):2===a&&eW(e,t,n,i,r,o):QV(KV(e),t,n,i,r,o,1);break}}}function JV(e){var t=e.prev,n=e,i=e.next;if(sW(t,n,i)>=0)return!1;for(var r=e.next.next;r!==e.prev;){if(oW(t.x,t.y,n.x,n.y,i.x,i.y,r.x,r.y)&&sW(r.prev,r,r.next)>=0)return!1;r=r.next}return!0}function ZV(e,t,n,i){var r=e.prev,o=e,a=e.next;if(sW(r,o,a)>=0)return!1;for(var s=r.x<o.x?r.x<a.x?r.x:a.x:o.x<a.x?o.x:a.x,c=r.y<o.y?r.y<a.y?r.y:a.y:o.y<a.y?o.y:a.y,l=r.x>o.x?r.x>a.x?r.x:a.x:o.x>a.x?o.x:a.x,u=r.y>o.y?r.y>a.y?r.y:a.y:o.y>a.y?o.y:a.y,h=iW(s,c,t,n,i),_=iW(l,u,t,n,i),f=e.nextZ;f&&f.z<=_;){if(f!==e.prev&&f!==e.next&&oW(r.x,r.y,o.x,o.y,a.x,a.y,f.x,f.y)&&sW(f.prev,f,f.next)>=0)return!1;f=f.nextZ}for(f=e.prevZ;f&&f.z>=h;){if(f!==e.prev&&f!==e.next&&oW(r.x,r.y,o.x,o.y,a.x,a.y,f.x,f.y)&&sW(f.prev,f,f.next)>=0)return!1;f=f.prevZ}return!0}function $V(e,t,n){var i=e;do{var r=i.prev,o=i.next.next;!cW(r,o)&&lW(r,i,i.next,o)&&uW(r,o)&&uW(o,r)&&(t.push(r.i/n),t.push(i.i/n),t.push(o.i/n),fW(i),fW(i.next),i=e=o),i=i.next}while(i!==e);return i}function eW(e,t,n,i,r,o){var a=e;do{for(var s=a.next.next;s!==a.prev;){if(a.i!==s.i&&aW(a,s)){var c=hW(a,s);return a=KV(a,a.next),c=KV(c,c.next),QV(a,t,n,i,r,o),void QV(c,t,n,i,r,o)}s=s.next}a=a.next}while(a!==e)}function tW(e,t){return e.x-t.x}function nW(e,t){if(t=function(e,t){var n=t,i=e.x,r=e.y,o=-1/0,a=null;do{if(r<=n.y&&r>=n.next.y){var s=n.x+(r-n.y)*(n.next.x-n.x)/(n.next.y-n.y);if(s<=i&&s>o){if(o=s,s===i){if(r===n.y)return n;if(r===n.next.y)return n.next}a=n.x<n.next.x?n:n.next}}n=n.next}while(n!==t);if(!a)return null;if(i===o)return a.prev;var c,l=a,u=a.x,h=a.y,_=1/0;for(n=a.next;n!==l;)i>=n.x&&n.x>=u&&oW(r<h?i:o,r,u,h,r<h?o:i,r,n.x,n.y)&&((c=Math.abs(r-n.y)/(i-n.x))<_||c===_&&n.x>a.x)&&uW(n,e)&&(a=n,_=c),n=n.next;return a}(e,t)){var n=hW(t,e);KV(n,n.next)}}function iW(e,t,n,i,r){return(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=32767*(e-n)/r)|e<<8))|e<<4))|e<<2))|e<<1))|(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=32767*(t-i)/r)|t<<8))|t<<4))|t<<2))|t<<1))<<1}function rW(e){var t=e,n=e;do{t.x<n.x&&(n=t),t=t.next}while(t!==e);return n}function oW(e,t,n,i,r,o,a,s){return(r-a)*(t-s)-(e-a)*(o-s)>=0&&(e-a)*(i-s)-(n-a)*(t-s)>=0&&(n-a)*(o-s)-(r-a)*(i-s)>=0}function aW(e,t){return e.next.i!==t.i&&e.prev.i!==t.i&&!function(e,t){var n=e;do{if(n.i!==e.i&&n.next.i!==e.i&&n.i!==t.i&&n.next.i!==t.i&&lW(n,n.next,e,t))return!0;n=n.next}while(n!==e);return!1}(e,t)&&uW(e,t)&&uW(t,e)&&function(e,t){var n=e,i=!1,r=(e.x+t.x)/2,o=(e.y+t.y)/2;do{n.y>o!=n.next.y>o&&r<(n.next.x-n.x)*(o-n.y)/(n.next.y-n.y)+n.x&&(i=!i),n=n.next}while(n!==e);return i}(e,t)}function sW(e,t,n){return(t.y-e.y)*(n.x-t.x)-(t.x-e.x)*(n.y-t.y)}function cW(e,t){return e.x===t.x&&e.y===t.y}function lW(e,t,n,i){return!!(cW(e,t)&&cW(n,i)||cW(e,i)&&cW(n,t))||sW(e,t,n)>0!=sW(e,t,i)>0&&sW(n,i,e)>0!=sW(n,i,t)>0}function uW(e,t){return sW(e.prev,e,e.next)<0?sW(e,t,e.next)>=0&&sW(e,e.prev,t)>=0:sW(e,t,e.prev)<0||sW(e,e.next,t)<0}function hW(e,t){var n=new XV(e.i,e.x,e.y),i=new XV(t.i,t.x,t.y),r=e.next,o=t.prev;return e.next=t,t.prev=e,n.next=r,r.prev=n,i.next=n,n.prev=i,o.next=i,i.prev=o,i}function _W(e,t,n,i){var r=new XV(e,t,n);return i?(r.next=i.next,r.prev=i,i.next.prev=r,i.next=r):(r.prev=r,r.next=r),r}function fW(e){e.next.prev=e.prev,e.prev.next=e.next,e.prevZ&&(e.prevZ.nextZ=e.nextZ),e.nextZ&&(e.nextZ.prevZ=e.prevZ)}function dW(e,t,n){n=n||3;var i=t?t.length:0,r=i?t[0]*n:e.length,o=YV(e,0,r,n,!0),a=[];if(!o)return a;var s=0,c=0,l=0,u=0,h=0,_=0,f=0;if(i&&(o=function(e,t,n,i){var r,o=[],a=0,s=null;for(a=0,r=t.length;a<r;a++)(s=YV(e,t[a]*i,a<r-1?t[a+1]*i:e.length,i,!1))&&(s===s.next&&(s.steiner=!0),o.push(rW(s)));if(o.sort(tW),!n)return n;for(a=0;a<o.length;a++)nW(o[a],n),n=KV(n,n.next);return n}(e,t,o,n)),e.length>80*n){s=l=e[0],c=u=e[1];for(var d=n;d<r;d+=n)(h=e[d])<s&&(s=h),(_=e[d+1])<c&&(c=_),h>l&&(l=h),_>u&&(u=_);f=Math.max(l-s,u-c)}return QV(o,a,n,s,c,f),a}for(var pW=Math.PI,mW=Math.min,vW=Math.max,gW=Math.ceil,yW=Math.acos,xW=Math.cos,SW=Math.sin,EW=Math.atan2,TW=null,CW=null,bW=new Qn,AW=[],wW=0;wW<4;wW++)AW.push(new yn);function IW(e,t,n){return e<t?t:e>n?n:e}var PW={useModel:!0,updateRenderData:function(){},fillBuffers:function(){},renderIA:function(){},getRenderData:function(e,t){if(!CW)return null;var n=CW.getRenderDataList(),i=n[CW.dataOffset];if(!i)return null;var r=i,o=r?r.vertexStart+t:0;return(o>65535||3*o>131070)&&(++CW.dataOffset,CW.dataOffset<n.length?i=n[CW.dataOffset]:(i=CW.requestRenderData(),n[CW.dataOffset]=i),r=i),r&&r.vertexCount<o&&r.request(t,3*t),i},stroke:function(e){Qn.copy(bW,e.strokeColor),e.impl&&(this._flattenPaths(e.impl),this._expandStroke(e),e.impl.updatePathOffset=!0,this.end(e))},fill:function(e){Qn.copy(bW,e.fillColor),this._expandFill(e),e.impl&&(e.impl.updatePathOffset=!0),this.end(e)},end:function(e){e.markForUpdateRenderData()},_expandStroke:function(e){var t=.5*e.lineWidth,n=e.lineCap,i=e.lineJoin,r=e.miterLimit;if(CW=e.impl){var o=function(e,t,n){var i=2*yW(e/(e+n));return vW(2,gW(t/i))}(t,pW,CW.tessTol);this._calculateJoins(CW,t,i,r);for(var a=CW.paths,s=0,c=CW.pathOffset,l=CW.pathLength;c<l;c++){var u=a[c],h=u.points.length;i===CU.ROUND?s+=2*(h+u.bevel*(o+2)+1):s+=2*(h+5*u.bevel+1),u.closed||(n===TU.ROUND?s+=2*(2*o+2):s+=12)}var _=TW=this.getRenderData(e,s);if(_){for(var f=_.vData,d=_.iData,p=CW.pathOffset,m=CW.pathLength;p<m;p++){var v=a[p],g=v.points,y=g.length,x=_.vertexStart,S=void 0,E=void 0,T=0,C=0,b=v.closed;if(b?(S=g[y-1],E=g[0],T=0,C=y):(S=g[0],E=g[1],T=1,C=y-1),E=E||S,!b){var A=new Rk(E.x,E.y);A.subtract(S),A.normalize();var w=A.x,I=A.y;n===TU.BUTT?this._buttCapStart(S,w,I,t,0):n===TU.SQUARE?this._buttCapStart(S,w,I,t,t):n===TU.ROUND&&this._roundCapStart(S,w,I,t,o)}for(var P=T;P<C;++P)i===CU.ROUND?this._roundJoin(S,E,t,t,o):0!=(E.flags&(bU.PT_BEVEL|bU.PT_INNERBEVEL))?this._bevelJoin(S,E,t,t):(this._vSet(E.x+E.dmx*t,E.y+E.dmy*t,1),this._vSet(E.x-E.dmx*t,E.y-E.dmy*t,-1)),S=E,E=g[P+1];if(b){var R=8*x;this._vSet(f[R],f[R+1],1),this._vSet(f[R+8],f[R+8+1],-1)}else{var D=new Rk(E.x,E.y);D.subtract(S),D.normalize();var O=D.x,N=D.y;n===TU.BUTT?this._buttCapEnd(E,O,N,t,0):n===TU.SQUARE?this._buttCapEnd(E,O,N,t,t):n===TU.ROUND&&this._roundCapEnd(E,O,N,t,o)}for(var M=_.indexStart,L=x+2,F=_.vertexStart;L<F;L++)d[M++]=L-2,d[M++]=L-1,d[M++]=L;_.indexStart=M}TW=null,CW=null}}},_expandFill:function(e){if(CW=e.impl){for(var t=CW.paths,n=0,i=CW.pathOffset,r=CW.pathLength;i<r;i++)n+=t[i].points.length;var o=TW=this.getRenderData(e,n);if(o){for(var a=o,s=a.vData,c=a.iData,l=CW.pathOffset,u=CW.pathLength;l<u;l++){var h=t[l],_=h.points,f=_.length;if(0!==f){for(var d=o.vertexStart,p=0;p<f;++p)this._vSet(_[p].x,_[p].y);var m=o.indexStart;if(h.complex){for(var v=[],g=d,y=o.vertexStart;g<y;g++){var x=8*g;v.push(s[x++]),v.push(s[x++]),v.push(s[x++])}var S=dW(v,null,3);if(!S||0===S.length)continue;for(var E=0,T=S.length;E<T;E++)c[m++]=S[E]+d}else for(var C=d,b=d+2,A=a.vertexStart;b<A;b++)c[m++]=C,c[m++]=b-1,c[m++]=b;a.indexStart=m}}TW=null,CW=null}}},_calculateJoins:function(e,t,n,i){var r=0;t>0&&(r=1/t);for(var o=e.paths,a=e.pathOffset,s=e.pathLength;a<s;a++){var c=o[a],l=c.points,u=l.length,h=l[u-1],_=l[0];c.bevel=0;for(var f=0;f<u;f++){var d,p,m=h.dy,v=-h.dx,g=_.dy,y=-_.dx;if(_.dmx=.5*(m+g),_.dmy=.5*(v+y),(d=_.dmx*_.dmx+_.dmy*_.dmy)>1e-6){var x=1/d;x>600&&(x=600),_.dmx*=x,_.dmy*=x}_.dx*h.dy-h.dx*_.dy>0&&(_.flags|=bU.PT_LEFT),d*(p=vW(11,mW(h.len,_.len)*r))*p<1&&(_.flags|=bU.PT_INNERBEVEL),_.flags&bU.PT_CORNER&&(d*i*i<1||n===CU.BEVEL||n===CU.ROUND)&&(_.flags|=bU.PT_BEVEL),0!=(_.flags&(bU.PT_BEVEL|bU.PT_INNERBEVEL))&&c.bevel++,h=_,_=l[f+1]}}},_flattenPaths:function(e){for(var t=e.paths,n=e.pathOffset,i=e.pathLength;n<i;n++){var r=t[n],o=r.points,a=o[o.length-1],s=o[0];o.length>2&&a.equals(s)&&(r.closed=!0,o.pop(),a=o[o.length-1]);for(var c=0,l=o.length;c<l;c++){var u=new Rk(s.x,s.y);u.subtract(a),a.len=u.length(),(u.x||u.y)&&u.normalize(),a.dx=u.x,a.dy=u.y,a=s,s=o[c+1]}}},_chooseBevel:function(e,t,n,i){var r=n.x,o=n.y,a=0,s=0,c=0,l=0;return 0!==e?(a=r+t.dy*i,s=o-t.dx*i,c=r+n.dy*i,l=o-n.dx*i):(a=c=r+n.dmx*i,s=l=o+n.dmy*i),[a,s,c,l]},_buttCapStart:function(e,t,n,i,r){var o=e.x-t*r,a=e.y-n*r,s=n,c=-t;this._vSet(o+s*i,a+c*i,1),this._vSet(o-s*i,a-c*i,-1)},_buttCapEnd:function(e,t,n,i,r){var o=e.x+t*r,a=e.y+n*r,s=n,c=-t;this._vSet(o+s*i,a+c*i,1),this._vSet(o-s*i,a-c*i,-1)},_roundCapStart:function(e,t,n,i,r){for(var o=e.x,a=e.y,s=n,c=-t,l=0;l<r;l++){var u=l/(r-1)*pW,h=xW(u)*i,_=SW(u)*i;this._vSet(o-s*h-t*_,a-c*h-n*_,1),this._vSet(o,a,0)}this._vSet(o+s*i,a+c*i,1),this._vSet(o-s*i,a-c*i,-1)},_roundCapEnd:function(e,t,n,i,r){var o=e.x,a=e.y,s=n,c=-t;this._vSet(o+s*i,a+c*i,1),this._vSet(o-s*i,a-c*i,-1);for(var l=0;l<r;l++){var u=l/(r-1)*pW,h=xW(u)*i,_=SW(u)*i;this._vSet(o,a,0),this._vSet(o-s*h+t*_,a-c*h+n*_,1)}},_roundJoin:function(e,t,n,i,r){var o=e.dy,a=-e.dx,s=t.dy,c=-t.dx,l=t.x,u=t.y;if(0!=(t.flags&bU.PT_LEFT)){var h=this._chooseBevel(t.flags&bU.PT_INNERBEVEL,e,t,n),_=h[0],f=h[1],d=h[2],p=h[3],m=EW(-a,-o),v=EW(-c,-s);v>m&&(v-=2*pW),this._vSet(_,f,1),this._vSet(l-o*i,t.y-a*i,-1);for(var g=IW(gW((m-v)/pW)*r,2,r),y=0;y<g;y++){var x=m+y/(g-1)*(v-m),S=l+xW(x)*i,E=u+SW(x)*i;this._vSet(l,u,0),this._vSet(S,E,-1)}this._vSet(d,p,1),this._vSet(l-s*i,u-c*i,-1)}else{var T=this._chooseBevel(t.flags&bU.PT_INNERBEVEL,e,t,-i),C=T[0],b=T[1],A=T[2],w=T[3],I=EW(a,o),P=EW(c,s);P<I&&(P+=2*pW),this._vSet(l+o*i,u+a*i,1),this._vSet(C,b,-1);for(var R=IW(gW((P-I)/pW)*r,2,r),D=0;D<R;D++){var O=I+D/(R-1)*(P-I),N=l+xW(O)*n,M=u+SW(O)*n;this._vSet(N,M,1),this._vSet(l,u,0)}this._vSet(l+s*i,u+c*i,1),this._vSet(A,w,-1)}},_bevelJoin:function(e,t,n,i){var r=0,o=0,a=0,s=0,c=0,l=0,u=0,h=0,_=e.dy,f=-e.dx,d=t.dy,p=-t.dx;if(t.flags&bU.PT_LEFT){var m=this._chooseBevel(t.flags&bU.PT_INNERBEVEL,e,t,n);c=m[0],l=m[1],u=m[2],h=m[3],this._vSet(c,l,1),this._vSet(t.x-_*i,t.y-f*i,-1),this._vSet(u,h,1),this._vSet(t.x-d*i,t.y-p*i,-1)}else{var v=this._chooseBevel(t.flags&bU.PT_INNERBEVEL,e,t,-i);r=v[0],o=v[1],a=v[2],s=v[3],this._vSet(t.x+_*n,t.y+f*n,1),this._vSet(r,o,-1),this._vSet(t.x+d*n,t.y+p*n,1),this._vSet(a,s,-1)}},_vSet:function(e,t,n){if(void 0===n&&(n=0),TW){var i=TW,r=8*i.vertexStart,o=i.vData;o[r++]=e,o[r++]=t,o[r++]=0,Qn.toArray(o,bW,r),r+=4,o[r++]=n,i.vertexStart++}}},RW=e("graphicsAssembler",{getAssembler:function(){return PW}});Fk.Assembler=RW;var DW=function(){this.char="",this.valid=!0,this.x=0,this.y=0,this.line=0,this.hash=""},OW=new Xn,NW=null,MW=null,LW=[],FW=[],BW=[],zW=[],UW=new jn,kW=new jn,GW=new Tn,HW=null,VW=0,WW=0,jW=0,qW=0,XW=0,YW=1,KW=null,QW="",JW=0,ZW=0,$W=0,ej=0,tj=0,nj=0,ij=0,rj=!1,oj=0,aj=0,sj=0,cj={updateRenderData:function(e){e.renderData&&NW!==e&&(e.renderData.vertDirty&&(MW=(NW=e).node._uiProps.uiTransformComp,this._updateFontFamily(e),this._updateProperties(e),this._updateLabelInfo(e),this._updateContent(),NW.actualFontSize=JW,MW.setContentSize(kW),this.updateUVs(e),NW.renderData.vertDirty=!1,NW.markForUpdateRenderData(!1),NW=null,this._resetProperties()),e.spriteFrame&&e.renderData.updateRenderData(e,e.spriteFrame))},updateUVs:function(e){for(var t=e.renderData,n=t.chunk.vb,i=t.vertexCount,r=t.data,o=3,a=0;a<i;a++){var s=r[a];n[o]=s.u,n[o+1]=s.v,o+=9}},_updateFontScale:function(){YW=JW/ZW},_updateFontFamily:function(e){var t=e.font;KW=t.spriteFrame,HW=t.fntConfig,tB.fontAtlas=t.fontDefDictionary,nF.packToDynamicAtlas(e,KW)},_updateLabelInfo:function(){tB.hash="",tB.margin=0},_updateProperties:function(e){QW=e.string.toString(),JW=e.fontSize,ZW=HW?HW.fontSize:e.fontSize,$W=e.horizontalAlign,ej=e.verticalAlign,tj=e.spacingX,ij=e.overflow,nj=e._lineHeight;var t=MW.contentSize;kW.width=t.width,kW.height=t.height,ij===xU.NONE?(rj=!1,kW.width+=2*tB.margin,kW.height+=2*tB.margin):ij===xU.RESIZE_HEIGHT?(rj=!0,kW.height+=2*tB.margin):rj=e.enableWrapText,tB.lineHeight=nj,tB.fontSize=JW,this._setupBMFontOverflowMetrics()},_resetProperties:function(){HW=null,KW=null,tB.hash="",tB.margin=0},_updateContent:function(){this._updateFontScale(),this._computeHorizontalKerningForText(),this._alignText()},_computeHorizontalKerningForText:function(){for(var e=QW,t=e.length,n=HW.kerningDict,i=LW,r=-1,o=0;o<t;++o){var a=e.charCodeAt(o),s=n[r<<16|65535&a]||0;i[o]=o<t-1?s:0,r=a}},_multilineTextWrap:function(e){for(var t=QW.length,n=0,i=0,r=0,o=0,a=0,s=0,c=0,l=null,u=0;u<t;){var h=QW.charAt(u);if("\n"!==h){for(var _=e(QW,u,t),f=s,d=c,p=a,m=i,v=!1,g=0;g<_;++g){var y=u+g;if("\r"!==(h=QW.charAt(y)))if(l=tB.fontAtlas.getLetterDefinitionForChar(h,tB)){var x=m+l.offsetX*YW-tB.margin;if(rj&&sj>0&&i>0&&x+l.w*YW>sj&&!HF(h)){BW.push(a),a=0,n++,i=0,r-=nj*this._getFontScale()+0,v=!0;break}GW.x=x,GW.y=r-l.offsetY*YW,this._recordLetterInfo(GW,h,y,n),y+1<LW.length&&y<t-1&&(m+=LW[y+1]),m+=l.xAdvance*YW+tj,p=GW.x+l.w*YW,f<GW.y&&(f=GW.y),d>GW.y-l.h*YW&&(d=GW.y-l.h*YW)}else this._recordPlaceholderInfo(y,h),console.log("Can't find letter definition in texture atlas "+HW.atlasName+" for letter:"+h);else this._recordPlaceholderInfo(y,h)}v||(i=m,s<f&&(s=f),c>d&&(c=d),o<(a=p)&&(o=a),u+=_)}else BW.push(a),a=0,n++,i=0,r-=nj*this._getFontScale()+0,this._recordPlaceholderInfo(u,h),u++}return BW.push(a),WW=(VW=n+1)*nj*this._getFontScale(),VW>1&&(WW+=0*(VW-1)),kW.width=oj,kW.height=aj,oj<=0&&(kW.width=parseFloat(o.toFixed(2))+2*tB.margin),aj<=0&&(kW.height=parseFloat(WW.toFixed(2))+2*tB.margin),qW=kW.height,XW=0,s>0&&(qW=kW.height+s),c<-WW&&(XW=WW+c),!0},_getFirstCharLen:function(){return 1},_getFontScale:function(){return ij===xU.SHRINK?YW:1},_getFirstWordLen:function(e,t,n){var i=e.charAt(t);if(GF(i)||"\n"===i||HF(i))return 1;var r=1,o=tB.fontAtlas.getLetterDefinitionForChar(i,tB);if(!o)return r;for(var a=o.xAdvance*YW+tj,s=t+1;s<n&&(i=e.charAt(s),o=tB.fontAtlas.getLetterDefinitionForChar(i,tB));++s){if(a+o.offsetX*YW+o.w*YW>sj&&!HF(i)&&sj>0)return r;if(a+=o.xAdvance*YW+tj,"\n"===i||HF(i)||GF(i))break;r++}return r},_multilineTextWrapByWord:function(){return this._multilineTextWrap(this._getFirstWordLen)},_multilineTextWrapByChar:function(){return this._multilineTextWrap(this._getFirstCharLen)},_recordPlaceholderInfo:function(e,t){if(e>=FW.length){var n=new DW;FW.push(n)}FW[e].char=t,FW[e].hash=""+t.charCodeAt(0)+tB.hash,FW[e].valid=!1},_recordLetterInfo:function(e,t,n,i){if(n>=FW.length){var r=new DW;FW.push(r)}var o=""+t.charCodeAt(0)+tB.hash;FW[n].line=i,FW[n].char=t,FW[n].hash=o,FW[n].valid=tB.fontAtlas.getLetter(o).valid,FW[n].x=e.x,FW[n].y=e.y},_alignText:function(){WW=0,BW.length=0,this._multilineTextWrapByWord(),this._computeAlignmentOffset(),ij===xU.SHRINK&&JW>0&&this._isVerticalClamp()&&this._shrinkLabelToContentSize(this._isVerticalClamp),this._updateQuads()||ij===xU.SHRINK&&this._shrinkLabelToContentSize(this._isHorizontalClamp)},_scaleFontSizeDown:function(e){var t=!0;e||(e=.1,t=!1),JW=e,t&&this._updateContent()},_shrinkLabelToContentSize:function(e){for(var t=0,n=0|JW,i=0;t<n;){var r=i=t+n+1>>1;if(r<=0)break;YW=r/ZW,this._multilineTextWrapByWord(),this._computeAlignmentOffset(),e()?n=i-1:t=i}t>=0&&this._scaleFontSizeDown(t)},_isVerticalClamp:function(){return WW>kW.height},_isHorizontalClamp:function(){for(var e=!1,t=0,n=QW.length;t<n;++t){var i=FW[t];if(i.valid){var r=tB.fontAtlas.getLetterDefinitionForChar(i.char,tB);if(!r)continue;var o=i.x+r.w*YW,a=i.line;if(oj>0)if(rj){if(BW[a]>kW.width&&(o>kW.width||o<0)){e=!0;break}}else if(o>kW.width){e=!0;break}}}return e},_isHorizontalClamped:function(e,t){var n=BW[t],i=e>kW.width||e<0;return rj?n>kW.width&&i:i},_updateQuads:function(){if(!NW)return!1;var e=KW?KW.texture:tB.fontAtlas.getTexture(),t=NW.renderData;t.dataLength=0,t.resize(0,0);for(var n=MW.anchorPoint,i=kW,r=n.x*i.width,o=n.y*i.height,a=!0,s=0,c=QW.length;s<c;++s){var l=FW[s];if(l.valid){var u=tB.fontAtlas.getLetter(l.hash);if(u){OW.height=u.h,OW.width=u.w,OW.x=u.u,OW.y=u.v;var h=l.y+jW;if(aj>0){if(h>qW){var _=h-qW;OW.y+=_,OW.height-=_,h-=_}h-u.h*YW<XW&&ij===xU.CLAMP&&(OW.height=h<XW?0:(h-XW)/YW)}var f=l.line,d=l.x+u.w/2*YW+zW[f];if(oj>0&&this._isHorizontalClamped(d,f))if(ij===xU.CLAMP)OW.width=0;else if(ij===xU.SHRINK){if(kW.width>u.w){a=!1;break}OW.width=0}if(OW.height>0&&OW.width>0){var p=this._determineRect(),m=l.x+zW[l.line];this.appendQuad(NW,e,OW,p,m-r,h-o,YW)}}else console.warn("Can't find letter in this bitmap-font")}}return a},appendQuad:function(){},_determineRect:function(){var e=KW.isRotated(),t=KW.getOriginalSize(),n=KW.getRect(),i=KW.getOffset(),r=i.x+(t.width-n.width)/2,o=i.y-(t.height-n.height)/2;if(e){var a=OW.x;OW.x=n.x+n.height-OW.y-OW.height-o,OW.y=a+n.y-r,OW.y<0&&(OW.height+=o)}else OW.x+=n.x-r,OW.y+=n.y+o;return e},_computeAlignmentOffset:function(){switch(zW.length=0,$W){case gU.LEFT:for(var e=0;e<VW;++e)zW.push(0);break;case gU.CENTER:for(var t=0,n=BW.length;t<n;t++)zW.push((kW.width-BW[t])/2);break;case gU.RIGHT:for(var i=0,r=BW.length;i<r;i++)zW.push(kW.width-BW[i])}if(jW=kW.height,ej!==yU.TOP){var o=kW.height-WW+nj*this._getFontScale()-ZW*YW;ej===yU.BOTTOM?jW-=o:jW-=o/2}},_setupBMFontOverflowMetrics:function(){var e=kW.width,t=kW.height;ij===xU.RESIZE_HEIGHT&&(t=0),ij===xU.NONE&&(e=0,t=0),oj=e,aj=t,UW.width=e,UW.height=t,sj=e}},lj=new Qn(255,255,255,255),uj={createData:function(e){return e.requestRenderData()},fillBuffers:function(e){var t=e.node;lj.set(e.color),lj.a=255*t._uiProps.opacity,YL(t,0,e.renderData,lj)},appendQuad:function(e,t,n,i,r,o,a){var s=e.renderData;if(s){var c=s.dataLength;s.dataLength+=4,s.resize(s.dataLength,s.dataLength/2*3);var l=s.data,u=t.width,h=t.height,_=n.width,f=n.height,d=0,p=0,m=0,v=0;i?(d=n.x/u,v=(n.x+f)/u,p=(n.y+_)/h,m=n.y/h,l[c].u=d,l[c].v=m,l[c+1].u=d,l[c+1].v=p,l[c+2].u=v,l[c+2].v=m,l[c+3].u=v,l[c+3].v=p):(d=n.x/u,v=(n.x+_)/u,p=(n.y+f)/h,m=n.y/h,l[c].u=d,l[c].v=p,l[c+1].u=v,l[c+1].v=p,l[c+2].u=d,l[c+2].v=m,l[c+3].u=v,l[c+3].v=m),l[c].x=r,l[c].y=o-f*a,l[c+1].x=r+_*a,l[c+1].y=o-f*a,l[c+2].x=r,l[c+2].y=o,l[c+3].x=r+_*a,l[c+3].y=o}},updateColor:function(){}};Re(uj,cj);var hj=null,_j=De(cj,{getAssemblerData:function(){return hj||(hj=new eB(1024,1024)),hj.getTexture()},_updateFontFamily:function(e){tB.fontAtlas=hj,tB.fontFamily=this._getFontFamily(e);var t=e.getComponent(eH);t&&t.enabled?(tB.isOutlined=!0,tB.margin=t.width,tB.out=t.color.clone(),tB.out.a=t.color.a*e.color.a/255):(tB.isOutlined=!1,tB.margin=0)},_getFontFamily:function(e){var t="Arial";return e.useSystemFont?t=e.fontFamily||"Arial":e.font&&(t=e.font._nativeAsset||"Arial"),t},_updateLabelInfo:function(e){tB.fontDesc=this._getFontDesc(),tB.color=e.color,tB.hash=function(e){var t=e.color.toHEX(),n="";return e.isOutlined&&e.margin>0&&(n=n+e.margin+e.out.toHEX()),""+e.fontSize+e.fontFamily+t+n}(tB)},_getFontDesc:function(){return tB.fontSize.toString()+"px "+tB.fontFamily},_computeHorizontalKerningForText:function(){},_determineRect:function(){return!1}}),fj=new Qn(255,255,255,255),dj={createData:function(e){return e.requestRenderData()},fillBuffers:function(e){if(e.renderData){var t=e.node;fj.a=255*t._uiProps.opacity,YL(t,0,e.renderData,fj)}},updateColor:function(){},appendQuad:uj.appendQuad};Re(dj,_j);var pj=AU.Overflow,mj=(1/255).toFixed(3),vj=null,gj=null,yj=null,xj="",Sj="",Ej=0,Tj=0,Cj=[],bj=new jn,Aj=0,wj=0,Ij=0,Pj=new Qn,Rj="",Dj=pj.NONE,Oj=!1,Nj=null,Mj=Qn.BLACK.clone(),Lj=null,Fj=Qn.BLACK.clone(),Bj=new Xn,zj=jn.ZERO.clone(),Uj=jn.ZERO.clone(),kj=Tn.ZERO.clone(),Gj=Tn.ZERO.clone(),Hj=0,Vj=0,Wj=!1,jj=!1,qj=!1,Xj=["left","center","right"],Yj={getAssemblerData:function(){return AU._canvasPool.get()},resetAssemblerData:function(e){e&&AU._canvasPool.put(e)},updateRenderData:function(e){if(e.renderData){if(e.renderData.vertDirty){var t=e.node._uiProps.uiTransformComp;this._updateFontFamily(e),this._updateProperties(e,t),this._calculateLabelFont(),this._updateLabelDimensions(),this._updateTexture(e),this._calDynamicAtlas(e),e.actualFontSize=Ej,t.setContentSize(bj),this.updateVertexData(e),this.updateUVs(e),e.markForUpdateRenderData(!1),vj=null,gj=null,yj=null}e.spriteFrame&&e.renderData.updateRenderData(e,e.spriteFrame)}},updateVertexData:function(){},updateUVs:function(){},_updateFontFamily:function(e){Rj=e.useSystemFont?e.fontFamily||"Arial":e.font&&e.font._nativeAsset||"Arial"},_updateProperties:function(e,t){var n=e.assemblerData;n&&(vj=n.context,gj=n.canvas,yj=e.spriteFrame,Sj=e.string.toString(),Ej=e.fontSize,Tj=Ej,Dj=e.overflow,Uj.width=bj.width=t.width,Uj.height=bj.height=t.height,Vj=e.underlineHeight,Aj=e.lineHeight,wj=e.horizontalAlign,Ij=e.verticalAlign,Pj=e.color,e.node._uiProps.opacity,Wj=e.isBold,jj=e.isItalic,qj=e.isUnderline,Oj=Dj!==pj.NONE&&(Dj===pj.RESIZE_HEIGHT||e.enableWrapText),(Nj=(Nj=eH&&e.getComponent(eH))&&Nj.enabled&&Nj.width>0?Nj:null)&&Mj.set(Nj.color),(Lj=(Lj=qV&&e.getComponent(qV))&&Lj.enabled?Lj:null)&&Fj.set(Lj.color),this._updatePaddingRect())},_updatePaddingRect:function(){var e=0,t=0,n=0,i=0,r=0;if(zj.width=zj.height=0,Nj&&(e=t=n=i=r=Nj.width,zj.width=zj.height=2*r),Lj){var o=Lj.blur+r,a=Lj.offset.x,s=Lj.offset.y;n=Math.max(n,-a+o),i=Math.max(i,a+o),e=Math.max(e,s+o),t=Math.max(t,-s+o)}if(jj){var c=Tj*Math.tan(.20943951);i+=c,zj.width+=c}Bj.x=n,Bj.y=e,Bj.width=n+i,Bj.height=e+t},_calculateFillTextStartPosition:function(){var e=0;wj===gU.RIGHT?e=bj.width-Bj.width:wj===gU.CENTER&&(e=(bj.width-Bj.width)/2);var t=this._getLineHeight()*(Cj.length-1),n=Ej*(1-DF/2);if(Ij!==yU.TOP){var i=t+Bj.height+Ej-bj.height;Ij===yU.BOTTOM?n-=i+=DF/2*Ej:n-=i/2}n+=0*Ej,kj.set(e+Bj.x,n+Bj.y)},_updateTexture:function(e){if(vj&&gj){vj.clearRect(0,0,gj.width,gj.height),vj.font=xj,this._calculateFillTextStartPosition();var t=this._getLineHeight();vj.lineJoin="round",Nj?(vj.fillStyle="rgba("+Mj.r+", "+Mj.g+", "+Mj.b+", "+mj+")",vj.fillRect(0,0,gj.width,gj.height)):e._srcBlendFactor===Ti.SRC_ALPHA&&(vj.fillStyle="rgba("+Pj.r+", "+Pj.g+", "+Pj.b+", "+mj+")",vj.fillRect(0,0,gj.width,gj.height)),vj.fillStyle="rgb("+Pj.r+", "+Pj.g+", "+Pj.b+")";var n=kj.x,i=0;this._drawTextEffect(kj,t);for(var r=0;r<Cj.length;++r)i=kj.y+r*t,Nj&&vj.strokeText(Cj[r],n,i),vj.fillText(Cj[r],n,i);Lj&&(vj.shadowColor="transparent"),this._uploadTexture(e)}},_uploadTexture:function(e){if(e.cacheMode===AU.CacheMode.BITMAP){var t=e.ttfSpriteFrame;nF.deleteAtlasSpriteFrame(t),t._resetDynamicAtlasFrame()}var n;yj&&gj&&(n=yj instanceof cF?yj.texture:yj,0!==gj.width&&0!==gj.height&&(n.reset({width:gj.width,height:gj.height,mipmapLevel:1}),n.uploadData(gj),n.setWrapMode(nm.CLAMP_TO_EDGE,nm.CLAMP_TO_EDGE),yj instanceof cF&&(yj.rect=new Xn(0,0,gj.width,gj.height),yj._calculateUV()),e.renderData&&(e.renderData.textureDirty=!0),b.director.root&&b.director.root.batcher2D&&b.director.root.batcher2D._releaseDescriptorSetCache(n.getHash())))},_calDynamicAtlas:function(e){if(!(e.cacheMode!==AU.CacheMode.BITMAP||!gj||gj.width<=0||gj.height<=0)){var t=e.ttfSpriteFrame;nF.packToDynamicAtlas(e,t)}},_setupOutline:function(){vj.strokeStyle="rgba("+Mj.r+", "+Mj.g+", "+Mj.b+", "+Mj.a/255+")",vj.lineWidth=2*Nj.width},_setupShadow:function(){vj.shadowColor="rgba("+Fj.r+", "+Fj.g+", "+Fj.b+", "+Fj.a/255+")",vj.shadowBlur=Lj.blur,vj.shadowOffsetX=Lj.offset.x,vj.shadowOffsetY=-Lj.offset.y},_drawTextEffect:function(e,t){if(Lj||Nj||qj){var n=Cj.length>1&&Lj,i=this._measureText(vj,xj),r=0,o=0;Lj&&this._setupShadow(),Nj&&this._setupOutline();for(var a=0;a<Cj.length;++a)r=e.x,o=e.y+a*t,n&&(Nj&&vj.strokeText(Cj[a],r,o),vj.fillText(Cj[a],r,o)),qj&&(Hj=i(Cj[a]),wj===gU.RIGHT?Gj.x=e.x-Hj:wj===gU.CENTER?Gj.x=e.x-Hj/2:Gj.x=e.x,Gj.y=o+Tj/8,vj.fillRect(Gj.x,Gj.y,Hj,Vj));n&&(vj.shadowColor="transparent")}},_updateLabelDimensions:function(){bj.width=Math.min(bj.width,2048),bj.height=Math.min(bj.height,2048);var e=!1;gj.width!==bj.width&&(gj.width=bj.width,e=!0),gj.height!==bj.height&&(gj.height=bj.height,e=!0),e&&(vj.font=xj),vj.textAlign=Xj[wj],vj.textBaseline="alphabetic"},_getFontDesc:function(){var e=Ej.toString()+"px ";return e+=Rj,Wj&&(e="bold "+e),jj&&(e="italic "+e),e},_getLineHeight:function(){return 0|(0===Aj?Ej:Aj*Ej/Tj)},_calculateParagraphLength:function(e,t){for(var n,i=[],r=S(e);!(n=r()).done;){var o=VF(t,n.value,xj);i.push(o)}return i},_measureText:function(e,t){return function(n){return VF(e,n,t)}},_calculateShrinkFont:function(e){if(vj){var t=this._calculateParagraphLength(e,vj),n=0,i=0,r=0;if(Oj){var o=Uj.width,a=Uj.height;if(o<0||a<0)return;i=a+1;for(var s=0,c=0|Ej+1,l=0;s<c;){if((l=s+c+1>>1)<=0){W(4003);break}Ej=l,xj=this._getFontDesc(),vj.font=xj;var u=this._getLineHeight();for(i=0,n=0;n<e.length;++n){var h=VF(vj,e[n],xj);i+=XF(e[n],h,o,this._measureText(vj,xj)).length*u}i>a?c=l-1:s=l}0===s?W(4003):(Ej=s,xj=this._getFontDesc(),vj.font=xj)}else{for(i=e.length*this._getLineHeight(),n=0;n<e.length;++n)r<t[n]&&(r=t[n]);var _=(bj.width-Bj.width)/r,f=bj.height/i;Ej=Tj*Math.min(1,_,f)|0,xj=this._getFontDesc(),vj.font=xj}}},_calculateWrapText:function(e){if(Oj&&vj){Cj=[];for(var t=Uj.width,n=0;n<e.length;++n){var i=VF(vj,e[n],xj),r=XF(e[n],i,t,this._measureText(vj,xj));Cj=Cj.concat(r)}}},_calculateLabelFont:function(){if(vj){var e=Sj.split("\n");switch(Cj=e,xj=this._getFontDesc(),vj.font=xj,Dj){case pj.NONE:for(var t=0,n=0,i=0;i<e.length;++i){var r=VF(vj,e[i],xj);t=t>r?t:r}n=(Cj.length+DF)*this._getLineHeight();var o=parseFloat(t.toFixed(2)),a=parseFloat(n.toFixed(2));bj.width=o+Bj.width,bj.height=a+Bj.height,Uj.width=o+zj.width,Uj.height=a+zj.height;break;case pj.SHRINK:this._calculateShrinkFont(e),this._calculateWrapText(e);break;case pj.CLAMP:this._calculateWrapText(e);break;case pj.RESIZE_HEIGHT:this._calculateWrapText(e);var s=(Cj.length+DF)*this._getLineHeight();bj.height=s+Bj.height,Uj.height=s+zj.height}}}},Kj=Qn.WHITE.clone(),Qj={createData:function(e){var t=e.requestRenderData();t.dataLength=2,t.resize(4,6);var n=t.chunk.vb;n[3]=n[21]=n[22]=n[31]=0,n[4]=n[12]=n[13]=n[30]=1;for(var i=5,r=0;r<4;r++)Qn.toArray(n,Kj,i),i+=9;return t},fillBuffers:function(e){var t=e.renderData.chunk,n=e.renderData.data,i=e.node,r=t.vb,o=n[0],a=n[1];i.updateWorldTransform();var s=i._pos,c=i._rot,l=i._scale,u=o.x*l.x,h=a.x*l.x,_=o.y*l.y,f=a.y*l.y,d=c.x,p=c.y,m=c.z,v=c.w,g=d*p,y=m*v,x=d*d-p*p,S=v*v-m*m,E=S+x,T=2*(g-y),C=S-x,b=2*(g+y),A=s.x,w=s.y;r[0]=E*u+T*_+A,r[1]=C*_+b*u+w,r[9]=E*h+T*_+A,r[10]=C*_+b*h+w,r[18]=E*u+T*f+A,r[19]=C*f+b*u+w,r[27]=E*h+T*f+A,r[28]=C*f+b*h+w;var I=t.bufferId,P=t.vertexOffset,R=t.vertexAccessor.getMeshBuffer(t.bufferId),D=t.vertexAccessor.getIndexBuffer(I),O=R.indexOffset;D[O++]=P,D[O++]=P+1,D[O++]=P+2,D[O++]=P+2,D[O++]=P+1,D[O++]=P+3,R.indexOffset+=6},updateVertexData:function(e){var t=e.renderData;if(t){var n=e.node._uiProps.uiTransformComp,i=n.width,r=n.height,o=n.anchorX*i,a=n.anchorY*r,s=t.data;s[0].x=-o,s[0].y=-a,s[1].x=i-o,s[1].y=r-a}},updateUVs:function(e){var t=e.renderData;if(t&&e.ttfSpriteFrame){var n=t.chunk.vb,i=e.ttfSpriteFrame.uv;n[3]=i[0],n[4]=i[1],n[12]=i[2],n[13]=i[3],n[21]=i[4],n[22]=i[5],n[30]=i[6],n[31]=i[7]}},updateColor:function(){}};Re(Qj,Yj);var Jj=e("labelAssembler",{getAssembler:function(e){var t=Qj;return e.font instanceof PF?t=uj:e.cacheMode===AU.CacheMode.CHAR&&(t=dj),t}});AU.Assembler=Jj;var Zj=nH.FillType,$j=new kn,eq=new yn,tq={updateRenderData:function(e){var t=e.spriteFrame;nF.packToDynamicAtlas(e,t);var n=e.renderData;if(n&&t){if(n.updateRenderData(e,t),!n.vertDirty)return;var i=e.fillStart,r=e.fillRange;r<0&&(i+=r,r=-r),r=(r=(r=i+r)>1?1:r)<0?0:r;var o=(i=(i=i>1?1:i)<0?0:i)+(r=(r-=i)<0?0:r);o=o>1?1:o,this.updateUVs(e,i,o),this.updateVertexData(e,i,o)}},updateUVs:function(e,t,n){var i=e.spriteFrame,r=e.renderData.chunk.vb,o=i.width,a=i.height,s=i.rect,c=0,l=0,u=0,h=0,_=0,f=0,d=0,p=0,m=0,v=0;switch(i.isRotated()?(c=s.x/o,l=(s.y+s.width)/a,u=_=c,d=m=(s.x+s.height)/o,f=v=l,h=p=s.y/a):(c=s.x/o,l=(s.y+s.height)/a,u=d=c,_=m=(s.x+s.width)/o,h=f=l,p=v=s.y/a),e.fillType){case Zj.HORIZONTAL:r[3]=u+(_-u)*t,r[4]=h+(f-h)*t,r[12]=u+(_-u)*n,r[13]=h+(f-h)*n,r[21]=d+(m-d)*t,r[22]=p+(v-p)*t,r[30]=d+(m-d)*n,r[31]=p+(v-p)*n;break;case Zj.VERTICAL:r[3]=u+(d-u)*t,r[4]=h+(p-h)*t,r[12]=_+(m-_)*t,r[13]=f+(v-f)*t,r[21]=u+(d-u)*n,r[22]=h+(p-h)*n,r[30]=_+(m-_)*n,r[31]=f+(v-f)*n;break;default:Y(2626)}},updateVertexData:function(e,t,n){var i=e.renderData.data,r=e.node._uiProps.uiTransformComp,o=r.width,a=r.height,s=r.anchorX*o,c=r.anchorY*a,l=-s,u=-c,h=o-s,_=a-c,f=0;switch(e.fillType){case Zj.HORIZONTAL:f=l+(h-l)*n,l+=(h-l)*t,h=f;break;case Zj.VERTICAL:f=u+(_-u)*n,u+=(_-u)*t,_=f;break;default:Y(2626)}i[0].x=l,i[0].y=u,i[1].x=h,i[1].y=u,i[2].x=l,i[2].y=_,i[3].x=h,i[3].y=_},createData:function(e){var t=e.requestRenderData();t.dataLength=4,t.resize(4,6);for(var n,i=S(t.data);!(n=i()).done;)n.value.z=0;return t},updateWorldVertexData:function(e,t){e.node.getWorldMatrix($j);for(var n=e.renderData.floatStride,i=e.renderData.data,r=t.vb,o=0,a=0;a<4;a++){var s=i[a];yn.transformMat4(eq,s,$j),r[o=a*n]=eq.x,r[o+1]=eq.y,r[o+2]=eq.z}},fillBuffers:function(e){var t=e.renderData,n=t.chunk;(e.node.hasChangedFlags||t.vertDirty)&&(this.updateWorldVertexData(e,n),t.vertDirty=!1);var i=n.bufferId,r=n.vertexOffset,o=n.vertexAccessor.getMeshBuffer(n.bufferId),a=n.vertexAccessor.getIndexBuffer(i),s=o.indexOffset;a[s++]=r,a[s++]=r+1,a[s++]=r+2,a[s++]=r+2,a[s++]=r+1,a[s++]=r+3,o.indexOffset+=6},updateColor:function(e){for(var t=e.renderData,n=t.chunk.vb,i=t.floatStride,r=5,o=e.color,a=o.r/255,s=o.g/255,c=o.b/255,l=e.node._uiProps.opacity,u=0;u<4;u++)n[r]=a,n[r+1]=s,n[r+2]=c,n[r+3]=l,r+=i}},nq=2*Math.PI,iq=1e-6,rq=new kn,oq=new yn,aq=[new Tn,new Tn,new Tn,new Tn],sq=new Array(4),cq=new Array(8),lq=[new Tn,new Tn,new Tn,new Tn],uq=[new Tn,new Tn,new Tn,new Tn],hq=new Tn,_q=[new Tn,new Tn,new Tn,new Tn];function fq(e,t,n,i,r,o,a){var s=Math.sin(o);s=Math.abs(s)>iq?s:0;var c=Math.cos(o),l=0,u=0;if(0!==(c=Math.abs(c)>iq?c:0)){if(l=s/c,(e-r.x)*c>0){var h=r.y+l*(e-r.x);a[0].x=e,a[0].y=h}if((t-r.x)*c>0){var _=r.y+l*(t-r.x);a[2].x=t,a[2].y=_}}if(0!==s){if(u=c/s,(i-r.y)*s>0){var f=r.x+u*(i-r.y);a[3].x=f,a[3].y=i}if((n-r.y)*s>0){var d=r.x+u*(n-r.y);a[1].x=d,a[1].y=n}}}function dq(e,t){var n=t.x-e.x,i=t.y-e.y;if(0===n&&0===i)return 0;if(0===n)return i>0?.5*Math.PI:1.5*Math.PI;var r=Math.atan(i/n);return n<0&&(r+=Math.PI),r}function pq(e,t,n,i,r){var o=sq,a=o[0],s=o[1],c=o[2],l=o[3];e[t].x=n.x,e[t].y=n.y,e[t+1].x=i.x,e[t+1].y=i.y,e[t+2].x=r.x,e[t+2].y=r.y,mq((n.x-a)/(c-a),(n.y-s)/(l-s),e,t),mq((i.x-a)/(c-a),(i.y-s)/(l-s),e,t+1),mq((r.x-a)/(c-a),(r.y-s)/(l-s),e,t+2)}function mq(e,t,n,i){var r=cq,o=r[0]+(r[2]-r[0])*e,a=r[4]+(r[6]-r[4])*e,s=r[1]+(r[3]-r[1])*e,c=r[5]+(r[7]-r[5])*e,l=n[i];l.u=o+(a-o)*t,l.v=s+(c-s)*t}for(var vq={useModel:!1,createData:function(e){return e.requestRenderData()},updateRenderData:function(e){var t=e.spriteFrame;nF.packToDynamicAtlas(e,t),this.updateUVs(e);var n=e.renderData;if(n&&t){if(!n.vertDirty)return;var i=n.data,r=e.fillStart,o=e.fillRange;for(o<0&&(r+=o,o=-o);r>=1;)r-=1;for(;r<0;)r+=1;var a=(r*=nq)+(o*=nq);!function(e){var t=e.node._uiProps.uiTransformComp,n=t.width,i=t.height,r=t.anchorX*n,o=t.anchorY*i,a=-r,s=-o,c=n-r,l=i-o,u=sq;u[0]=a,u[1]=s,u[2]=c,u[3]=l;var h=e.fillCenter,_=hq.x=Math.min(Math.max(0,h.x),1)*(c-a)+a,f=hq.y=Math.min(Math.max(0,h.y),1)*(l-s)+s;aq[0].x=aq[3].x=a,aq[1].x=aq[2].x=c,aq[0].y=aq[1].y=s,aq[2].y=aq[3].y=l;for(var d,p=S(_q);!(d=p()).done;){var m=d.value;Tn.set(m,0,0)}_!==u[0]&&Tn.set(_q[0],3,0),_!==u[2]&&Tn.set(_q[2],1,2),f!==u[1]&&Tn.set(_q[1],0,1),f!==u[3]&&Tn.set(_q[3],2,3)}(e),function(e){var t=e.width,n=e.height,i=e.getRect(),r=0,o=0,a=0,s=0,c=cq;e.isRotated()?(r=i.x/t,o=(i.x+i.height)/t,a=i.y/n,s=(i.y+i.width)/n,c[0]=c[2]=r,c[4]=c[6]=o,c[3]=c[7]=s,c[1]=c[5]=a):(r=i.x/t,o=(i.x+i.width)/t,a=i.y/n,s=(i.y+i.height)/n,c[0]=c[4]=r,c[2]=c[6]=o,c[1]=c[3]=s,c[5]=c[7]=a)}(t),fq(sq[0],sq[2],sq[1],sq[3],hq,r,lq),fq(sq[0],sq[2],sq[1],sq[3],hq,r+o,uq);for(var s=0,c=0;c<4;++c){var l=_q[c];if(l)if(o>=nq)n.dataLength=s+3,pq(i,s,hq,aq[l.x],aq[l.y]),s+=3;else{var u=dq(hq,aq[l.x]),h=dq(hq,aq[l.y]);h<u&&(h+=nq),u-=nq,h-=nq;for(var _=0;_<3;++_)u>=a||(u>=r?(n.dataLength=s+3,pq(i,s,hq,aq[l.x],h>=a?uq[c]:aq[l.y]),s+=3):h>r&&(h<=a?(n.dataLength=s+3,pq(i,s,hq,lq[c],aq[l.y]),s+=3):(n.dataLength=s+3,pq(i,s,hq,lq[c],uq[c]),s+=3))),u+=nq,h+=nq}}n.resize(s,s),n.updateRenderData(e,t)}},fillBuffers:function(e){var t=e.node,n=e.renderData,i=n.chunk;(t.hasChangedFlags||n.vertDirty)&&(this.updateWorldVertexAndUVData(e,i),n.vertDirty=!1),this.updataColorLate(e);for(var r=i.bufferId,o=i.vertexOffset,a=i.vertexAccessor.getMeshBuffer(i.bufferId),s=i.vertexAccessor.getIndexBuffer(r),c=a.indexOffset,l=0;l<n.indexCount;l++)s[c+l]=o+l;a.indexOffset+=n.indexCount,a.setDirty()},updateWorldVertexAndUVData:function(e,t){e.node.getWorldMatrix(rq);for(var n=e.renderData,i=n.floatStride,r=e.renderData.data,o=t.vb,a=n.vertexCount,s=0,c=0;c<a;c++){var l=r[c];yn.set(oq,l.x,l.y,0),yn.transformMat4(oq,oq,rq),o[s+0]=oq.x,o[s+1]=oq.y,o[s+2]=oq.z,o[s+3]=l.u,o[s+4]=l.v,s+=i}},updateUVs:function(e){e.renderData.vertDirty=!0,e.markForUpdateRenderData()},updataColorLate:function(e){for(var t=e.renderData,n=t.chunk.vb,i=t.floatStride,r=t.vertexCount,o=5,a=e.color,s=a.r/255,c=a.g/255,l=a.b/255,u=e.node._uiProps.opacity,h=0;h<r;h++)n[o]=s,n[o+1]=c,n[o+2]=l,n[o+3]=u,o+=i},updateColor:function(){}},gq=[],yq=0;yq<4;yq++)gq.push(new yn);for(var xq={createData:function(e){var t=e.requestRenderData();return t.dataLength=2,t.resize(4,6),t},updateRenderData:function(e){var t=e.spriteFrame;nF.packToDynamicAtlas(e,t),this.updateUVs(e);var n=e.renderData;n&&t&&(n.vertDirty&&this.updateVertexData(e),n.updateRenderData(e,t))},updateWorldVerts:function(e,t){var n=e.renderData,i=t.vb,r=n.data,o=e.node,a=r[0],s=r[1],c=o.worldMatrix,l=c.m00,u=c.m01,h=c.m04,_=c.m05,f=1===l&&0===u&&0===h&&1===_,d=c.m12,p=c.m13,m=a.x,v=s.x,g=a.y,y=s.y;if(f){var x=m+d,S=v+d,E=g+p,T=y+p;i[0]=x,i[1]=E,i[9]=S,i[10]=E,i[18]=x,i[19]=T,i[27]=S,i[28]=T}else{var C=l*m,b=l*v,A=u*m,w=u*v,I=h*g+d,P=h*y+d,R=_*g+p,D=_*y+p;i[0]=C+I,i[1]=A+R,i[9]=b+I,i[10]=w+R,i[18]=C+P,i[19]=A+D,i[27]=b+P,i[28]=w+D}},fillBuffers:function(e){if(null!==e){var t=e.renderData,n=t.chunk;(e.node.hasChangedFlags||t.vertDirty)&&(this.updateWorldVerts(e,n),t.vertDirty=!1);var i=n.bufferId,r=n.vertexOffset,o=n.vertexAccessor.getMeshBuffer(i),a=n.vertexAccessor.getIndexBuffer(i),s=o.indexOffset;a[s++]=r,a[s++]=r+1,a[s++]=r+2,a[s++]=r+2,a[s++]=r+1,a[s++]=r+3,o.indexOffset+=6}},updateVertexData:function(e){var t=e.renderData;if(t){var n=e.node._uiProps.uiTransformComp,i=t.data,r=n.width,o=n.height,a=n.anchorX*r,s=n.anchorY*o,c=0,l=0,u=0,h=0;if(e.trim)c=-a,l=-s,u=r-a,h=o-s;else{var _=e.spriteFrame,f=_.getOriginalSize(),d=_.getRect(),p=f.width,m=f.height,v=d.width,g=d.height,y=_.getOffset(),x=r/p,S=o/m,E=y.x+(p-v)/2,T=y.x-(p-v)/2;c=E*x-a,l=(y.y+(m-g)/2)*S-s,u=r+T*x-a,h=o+(y.y-(m-g)/2)*S-s}i[0].x=c,i[0].y=l,i[1].x=u,i[1].y=h,t.vertDirty=!0}},updateUVs:function(e){if(e.spriteFrame){var t=e.renderData.chunk.vb,n=e.spriteFrame.uv;t[3]=n[0],t[4]=n[1],t[12]=n[2],t[13]=n[3],t[21]=n[4],t[22]=n[5],t[30]=n[6],t[31]=n[7]}},updateColor:function(e){for(var t=e.renderData,n=t.chunk.vb,i=5,r=e.color,o=r.r/255,a=r.g/255,s=r.b/255,c=r.a/255,l=0;l<4;l++,i+=t.floatStride)n[i]=o,n[i+1]=a,n[i+2]=s,n[i+3]=c}},Sq=new yn,Eq=new kn,Tq={createData:function(e){var t=e.requestRenderData();return t.dataLength=4,t.resize(16,54),t},updateRenderData:function(e){var t=e.spriteFrame;nF.packToDynamicAtlas(e,t),this.updateUVs(e);var n=e.renderData;n&&t&&(n.vertDirty&&this.updateVertexData(e),n.updateRenderData(e,t))},updateVertexData:function(e){var t=e.renderData.data,n=e.node._uiProps.uiTransformComp,i=n.width,r=n.height,o=n.anchorX*i,a=n.anchorY*r,s=e.spriteFrame,c=s.insetLeft,l=s.insetRight,u=s.insetTop,h=s.insetBottom,_=i-c-l,f=r-u-h,d=i/(c+l),p=r/(u+h);d=Number.isNaN(d)||d>1?1:d,p=Number.isNaN(p)||p>1?1:p,_=_<0?0:_,f=f<0?0:f,t[0].x=-o,t[0].y=-a,t[1].x=c*d-o,t[1].y=h*p-a,t[2].x=t[1].x+_,t[2].y=t[1].y+f,t[3].x=i-o,t[3].y=r-a},fillBuffers:function(e){var t=e.renderData,n=t.chunk;(e.node.hasChangedFlags||t.vertDirty)&&(this.updateWorldVertexData(e,n),t.vertDirty=!1);for(var i=n.bufferId,r=n.vertexOffset,o=n.vertexAccessor.getMeshBuffer(n.bufferId),a=n.vertexAccessor.getIndexBuffer(i),s=o.indexOffset,c=0;c<3;++c)for(var l=0;l<3;++l){var u=r+4*c+l;a[s++]=u,a[s++]=u+1,a[s++]=u+4,a[s++]=u+1,a[s++]=u+5,a[s++]=u+4}o.indexOffset=s},updateWorldVertexData:function(e,t){e.node.getWorldMatrix(Eq);for(var n=e.renderData,i=n.floatStride,r=n.data,o=t.vb,a=0,s=0;s<4;++s)for(var c=r[s],l=0;l<4;++l){var u=r[l];yn.set(Sq,u.x,c.y,0),yn.transformMat4(Sq,Sq,Eq),a=(4*s+l)*i,o[a++]=Sq.x,o[a++]=Sq.y,o[a++]=Sq.z}},updateUVs:function(e){if(e.spriteFrame)for(var t=e.renderData,n=t.chunk.vb,i=t.floatStride,r=e.spriteFrame.uvSliced,o=3,a=0;a<16;a++)n[o]=r[a].u,n[o+1]=r[a].v,o+=i},updateColor:function(e){for(var t=e.renderData,n=t.chunk.vb,i=t.floatStride,r=5,o=e.color,a=o.r/255,s=o.g/255,c=o.b/255,l=e.node._uiProps.opacity,u=0;u<16;u++)n[r]=a,n[r+1]=s,n[r+2]=c,n[r+3]=l,r+=i}},Cq=[],bq=0;bq<4;bq++)Cq.push(new yn);var Aq=new kn,wq={createData:function(e){return e.requestRenderData()},updateRenderData:function(e){var t=e.renderData,n=e.spriteFrame;if(n&&t&&(t.updateRenderData(e,n),t.vertDirty)){var i=e.node._uiProps.uiTransformComp,r=Math.abs(i.width),o=Math.abs(i.height),a=n.getRect(),s=n.insetLeft,c=n.insetRight,l=a.width-s-c,u=n.insetTop,h=n.insetBottom,_=a.height-u-h,f=r-s-c,d=o-u-h;f=f>0?f:0,d=d>0?d:0;var p=0===l?f:f/l,m=0===_?d:d/_,v=Math.ceil(m+2),g=Math.ceil(p+2);t.dataLength=Math.max(8,v+1,g+1),this.updateVerts(e,f,d,v,g),t.resize(v*g*4,v*g*6)}},updateUVs:function(e){e.renderData.vertDirty=!0,e.markForUpdateRenderData()},fillBuffers:function(e){var t=e.node,n=e.renderData,i=n.chunk;(t.hasChangedFlags||n.vertDirty)&&(this.updateWorldVertexAndUVData(e,i),n.vertDirty=!1),this.updataColorLate(e);for(var r=i.bufferId,o=i.vertexOffset,a=i.vertexAccessor.getMeshBuffer(i.bufferId),s=i.vertexAccessor.getIndexBuffer(r),c=a.indexOffset,l=0;l<n.indexCount;l+=6)s[c++]=o,s[c++]=o+1,s[c++]=o+2,s[c++]=o+1,s[c++]=o+3,s[c++]=o+2,o+=4,a.indexOffset+=6;a.setDirty()},updateWorldVertexAndUVData:function(e,t){var n=e.node;n.getWorldMatrix(Aq);var i=e.renderData,r=i.floatStride,o=i.data,a=t.vb,s=n._uiProps.uiTransformComp,c=Math.abs(s.width),l=Math.abs(s.height),u=e.spriteFrame,h=u.rotated,_=u.uv,f=u.uvSliced,d=u.rect,p=u.insetLeft,m=u.insetRight,v=d.width-p-m,g=u.insetTop,y=u.insetBottom,x=d.height-g-y,S=c-p-m,E=l-g-y;S=S>0?S:0,E=E>0?E:0;for(var T=0===v?S:S/v,C=0===x?E:E/x,b=Math.ceil(C+2),A=Math.ceil(T+2),w=0,I=0,P=0,R=0,D=0,O=0,N=b;O<N;++O){R=o[O].y,D=o[O+1].y;for(var M=0,L=A;M<L;++M){I=o[M].x,P=o[M+1].x,yn.set(Cq[0],I,R,0),yn.set(Cq[1],P,R,0),yn.set(Cq[2],I,D,0),yn.set(Cq[3],P,D,0);for(var F=0;F<4;F++){var B=Cq[F];yn.transformMat4(B,B,Aq);var z=F*r;a[w+z]=B.x,a[w+z+1]=B.y,a[w+z+2]=B.z}w+=4*r}}w=0;for(var U=r,k=2*r,G=3*r,H=4*r,V=0,W=0,j=[],q=[],X=0,Y=b;X<Y;++X){W=E>x?E>=X*x?1:C%1:C;for(var K=0,Q=A;K<Q;++K){V=S>v?S>=K*v?1:T%1:T;var J=w+3,Z=J+1;h?(0===X?(j[0]=f[0].u,j[1]=f[0].u,j[2]=f[4].u+(f[8].u-f[4].u)*W):X<b-1?(j[0]=f[4].u,j[1]=f[4].u,j[2]=f[4].u+(f[8].u-f[4].u)*W):X===b-1&&(j[0]=f[8].u,j[1]=f[8].u,j[2]=f[12].u),0===K?(q[0]=f[0].v,q[1]=f[1].v+(f[2].v-f[1].v)*V,q[2]=f[0].v):K<A-1?(q[0]=f[1].v,q[1]=f[1].v+(f[2].v-f[1].v)*V,q[2]=f[1].v):K===A-1&&(q[0]=f[2].v,q[1]=f[3].v,q[2]=f[2].v),j[3]=j[2],q[3]=q[1]):(0===K?(j[0]=f[0].u,j[1]=f[1].u+(f[2].u-f[1].u)*V,j[2]=_[0]):K<A-1?(j[0]=f[1].u,j[1]=f[1].u+(f[2].u-f[1].u)*V,j[2]=f[1].u):K===A-1&&(j[0]=f[2].u,j[1]=f[3].u,j[2]=f[2].u),0===X?(q[0]=f[0].v,q[1]=f[0].v,q[2]=f[4].v+(f[8].v-f[4].v)*W):X<b-1?(q[0]=f[4].v,q[1]=f[4].v,q[2]=f[4].v+(f[8].v-f[4].v)*W):X===b-1&&(q[0]=f[8].v,q[1]=f[8].v,q[2]=f[12].v),j[3]=j[1],q[3]=q[2]),a[J]=j[0],a[Z]=q[0],a[J+U]=j[1],a[Z+U]=q[1],a[J+k]=j[2],a[Z+k]=q[2],a[J+G]=j[3],a[Z+G]=q[3],w+=H}}},updateVerts:function(e,t,n,i,r){var o,a,s=e.node._uiProps.uiTransformComp,c=e.renderData.data,l=e.spriteFrame,u=l.rect,h=Math.abs(s.width),_=Math.abs(s.height),f=s.anchorX*h,d=s.anchorY*_,p=l.insetLeft,m=l.insetRight,v=u.width-p-m,g=l.insetTop,y=l.insetBottom,x=u.height-g-y,S=s.width/(p+m)>1?1:s.width/(p+m),E=s.height/(g+y)>1?1:s.height/(g+y);o=v>0?Math.floor(1e3*t)/1e3%v==0?v:t%v:t,a=x>0?Math.floor(1e3*n)/1e3%x==0?x:n%x:n;for(var T=0;T<=r;T++)0===T?c[T].x=-f:T>0&&T<r?c[T].x=1===T?p*S+Math.min(v,t)-f:v>0?T===r-1?p+o+v*(T-2)-f:p+Math.min(v,t)+v*(T-2)-f:p+t-f:T===r&&(c[T].x=Math.min(p+t+m,h)-f);for(var C=0;C<=i;C++)0===C?c[C].y=-d:C>0&&C<i?c[C].y=1===C?y*E+Math.min(x,n)-d:x>0?C===i-1?y+a+(C-2)*x-d:y+Math.min(x,n)+(C-2)*x-d:y+n-d:C===i&&(c[C].y=Math.min(y+n+g,_)-d)},updataColorLate:function(e){for(var t=e.renderData,n=t.chunk.vb,i=t.floatStride,r=t.vertexCount,o=5,a=e.color,s=a.r/255,c=a.g/255,l=a.b/255,u=e.node._uiProps.opacity,h=0;h<r;h++)n[o]=s,n[o+1]=c,n[o+2]=l,n[o+3]=u,o+=i},updateColor:function(){}},Iq=nH.Type,Pq=nH.FillType,Rq=e("spriteAssembler",{getAssembler:function(e){var t=xq,n=e;switch(n.type){case Iq.SLICED:t=Tq;break;case Iq.TILED:t=wq;break;case Iq.FILLED:t=n.fillType===Pq.RADIAL?vq:tq}return t}});nH.Assembler=Rq;var Dq=oz.sharedManager,Oq={createData:function(e){var t=e.requestRenderData();return t.dataLength=2,t.resize(4,6),t},updateRenderData:function(e){e.type===Bk.IMAGE_STENCIL&&(xq.updateRenderData(e),xq.updateColor(e))},fillBuffers:function(e,t){(e.type!==Bk.IMAGE_STENCIL||e.spriteFrame)&&(Dq.pushMask(e),t.finishMergeBatches(),function(e,t){Dq.clear(e),t.commitModel(e,e._clearModel,e._clearStencilMtl)}(e,t),function(e,t){if(Dq.enterLevel(e),e.type===Bk.IMAGE_STENCIL){xq.fillBuffers(e,t);var n=e.graphics.getMaterialInstance(0);t.forceMergeBatches(n,e.spriteFrame,e.graphics)}else e.graphics.updateAssembler(t)}(e,t),Dq.enableMask())}},Nq={fillBuffers:function(){Dq.exitMask()}},Mq={getAssembler:function(){return Oq}},Lq={getAssembler:function(){return Nq}};Hk.Assembler=Mq,Hk.PostAssembler=Lq;var Fq=e("MeshBuffer",function(){function e(){this.byteOffset=0,this.vertexOffset=0,this.indexOffset=0,this.vData=null,this.iData=null,this._dirty=!1,this._vertexFormatBytes=0,this._floatsPerVertex=0,this._initVDataCount=0,this._initIDataCount=0,this._attributes=null,this._iaPool=[],this._iaInfo=null,this._nextFreeIAHandle=0}var t=e.prototype;return t.initialize=function(e,t,n,i){this._initVDataCount=n,this._initIDataCount=i,this._attributes=t,this._floatsPerVertex=aB(t),this._initVDataCount,this._floatsPerVertex,Z(9005),this.vData&&this.iData||(this.vData=new Float32Array(this._initVDataCount),this.iData=new Uint16Array(this._initIDataCount)),this._iaPool.push(this.createNewIA(e))},t.reset=function(){this._nextFreeIAHandle=0,this._dirty=!1},t.destroy=function(){this.reset(),this._attributes=null,this._iaInfo=null,this.vData=null,this.iData=null;for(var e=0;e<this._iaPool.length;++e){var t=this._iaPool[e];t.vertexBuffers[0]&&t.vertexBuffers[0].destroy(),t.indexBuffer&&t.indexBuffer.destroy(),t.ia.destroy()}this._iaPool.length=0},t.setDirty=function(){this._dirty=!0},t.request=function(){return q(9002),!1},t.requireFreeIA=function(e){return this._iaPool.length<=this._nextFreeIAHandle&&this._iaPool.push(this.createNewIA(e)),this._iaPool[this._nextFreeIAHandle++].ia},t.recycleIA=function(e){for(var t=this._iaPool,n=0;n<this._nextFreeIAHandle;++n)if(e===t[n].ia){var i=t[n];return t[n]=t[--this._nextFreeIAHandle],void(t[this._nextFreeIAHandle]=i)}},t.checkCapacity=function(e,t){var n=(this.vertexOffset+e)*this._floatsPerVertex,i=this.indexOffset+t;return!(n>this._initVDataCount||i>this._initIDataCount)},t.uploadBuffers=function(){if(0!==this.byteOffset&&this._dirty){for(var e=Qu.__isWebIOS14OrIPadOS14Env?this._nextFreeIAHandle:1,t=this.byteOffset,n=this.indexOffset,i=0;i<e;++i){var r=this._iaPool[i],o=new Float32Array(this.vData.buffer,0,t>>2),a=new Uint16Array(this.iData.buffer,0,n),s=r.vertexBuffers[0];t>s.size&&s.resize(t),s.update(o),2*n>r.indexBuffer.size&&r.indexBuffer.resize(2*n),r.indexBuffer.update(a)}this._dirty=!1}},t.createNewIA=function(e){var t,n,i;if(Qu.__isWebIOS14OrIPadOS14Env||!this._iaPool[0]){var r=this._vertexFormatBytes=this._floatsPerVertex*Float32Array.BYTES_PER_ELEMENT,o=Uint16Array.BYTES_PER_ELEMENT,a=e.createBuffer(new cr(li.VERTEX|li.TRANSFER_DST,_i.HOST|_i.DEVICE,r,r));i=e.createBuffer(new cr(li.INDEX|li.TRANSFER_DST,_i.HOST|_i.DEVICE,o,o)),n=[a],this._iaInfo=new wr(this._attributes,n,i),t=e.createInputAssembler(this._iaInfo)}else t=e.createInputAssembler(this._iaInfo),n=this._iaInfo.vertexBuffers,i=this._iaInfo.indexBuffer;return{ia:t,vertexBuffers:n,indexBuffer:i}},h(e,[{key:"attributes",get:function(){return this._attributes}},{key:"vertexFormatBytes",get:function(){return this._vertexFormatBytes}}]),e}()),Bq=[TO.EventType.MOUSE_DOWN,TO.EventType.MOUSE_MOVE,TO.EventType.MOUSE_UP,TO.EventType.MOUSE_WHEEL],zq=[TO.EventType.TOUCH_START,TO.EventType.TOUCH_MOVE,TO.EventType.TOUCH_END,TO.EventType.TOUCH_CANCEL],Uq=(new(function(){function e(){this.priority=fO.UI,this._isListDirty=!1,this._inDispatchCount=0,this._pointerEventProcessorList=[],this._processorListToAdd=[],this._processorListToRemove=[],CO._registerEventDispatcher(this),wP.callbacksInvoker.on(VA.ADD_POINTER_EVENT_PROCESSOR,this.addPointerEventProcessor,this),wP.callbacksInvoker.on(VA.REMOVE_POINTER_EVENT_PROCESSOR,this.removePointerEventProcessor,this),wP.callbacksInvoker.on(VA.MARK_LIST_DIRTY,this._markListDirty,this)}var t=e.prototype;return t.dispatchEvent=function(e){var t=e.type;return zq.includes(t)?this.dispatchEventTouch(e):!Bq.includes(t)||this.dispatchEventMouse(e)},t.addPointerEventProcessor=function(e){0===this._inDispatchCount?this._pointerEventProcessorList.includes(e)||(this._pointerEventProcessorList.push(e),this._isListDirty=!0):this._processorListToAdd.includes(e)||this._processorListToAdd.push(e),Ke.array.remove(this._processorListToRemove,e)},t.removePointerEventProcessor=function(e){0===this._inDispatchCount?(Ke.array.remove(this._pointerEventProcessorList,e),this._isListDirty=!0):this._processorListToRemove.includes(e)||this._processorListToRemove.push(e),Ke.array.remove(this._processorListToAdd,e)},t.dispatchEventMouse=function(e){this._inDispatchCount++,this._sortPointerEventProcessorList();for(var t=this._pointerEventProcessorList,n=t.length,i=!0,r=0;r<n;++r){var o=t[r];if(o.isEnabled&&o.shouldHandleEventMouse&&o._handleEventMouse(e)){if(i=!1,!e.preventSwallow)break;e.preventSwallow=!1}}return--this._inDispatchCount<=0&&this._updatePointerEventProcessorList(),i},t.dispatchEventTouch=function(e){this._inDispatchCount++,this._sortPointerEventProcessorList();for(var t=this._pointerEventProcessorList,n=t.length,i=e.touch,r=!0,o=0;o<n;++o){var a=t[o];if(a.isEnabled&&a.shouldHandleEventTouch)if(e.type===GA.TOUCH_START){if(a._handleEventTouch(e)){if(a.claimedTouchIdList.push(i.getID()),r=!1,!e.preventSwallow)break;e.preventSwallow=!1}}else if(a.claimedTouchIdList.length>0){var s=a.claimedTouchIdList.indexOf(i.getID());if(-1!==s){if(a._handleEventTouch(e),e.type!==GA.TOUCH_END&&e.type!==GA.TOUCH_CANCEL||Ke.array.removeAt(a.claimedTouchIdList,s),r=!1,!e.preventSwallow)break;e.preventSwallow=!1}}}return--this._inDispatchCount<=0&&this._updatePointerEventProcessorList(),r},t._updatePointerEventProcessorList=function(){for(var e=this._processorListToAdd,t=e.length,n=0;n<t;++n)this.addPointerEventProcessor(e[n]);e.length=0;for(var i=this._processorListToRemove,r=i.length,o=0;o<r;++o)this.removePointerEventProcessor(i[o]);i.length=0},t._sortPointerEventProcessorList=function(){if(this._isListDirty){for(var e=this._pointerEventProcessorList,t=e.length,n=0;n<t;++n){var i=e[n],r=i.node;if(r._uiProps){var o=r._uiProps.uiTransformComp;i.cachedCameraPriority=o.cameraPriority}}e.sort(this._sortByPriority),this._isListDirty=!1}},t._sortByPriority=function(e,t){var n=e.node,i=t.node;if(!(t&&i&&i.activeInHierarchy&&i._uiProps.uiTransformComp))return-1;if(!(e&&n&&n.activeInHierarchy&&n._uiProps.uiTransformComp))return 1;if(e.cachedCameraPriority!==t.cachedCameraPriority)return t.cachedCameraPriority-e.cachedCameraPriority;for(var r=n,o=i,a=!1;(null===(s=r.parent)||void 0===s?void 0:s._id)!==(null===(c=o.parent)||void 0===c?void 0:c._id);){var s,c,l,u,h,_;r=null===(null===(l=r)||void 0===l||null===(u=l.parent)||void 0===u?void 0:u.parent)?(a=!0)&&i:r&&r.parent,o=null===(null===(h=o)||void 0===h||null===(_=h.parent)||void 0===_?void 0:_.parent)?(a=!0)&&n:o&&o.parent}if(r._id===o._id){if(r._id===i._id)return-1;if(r._id===n._id)return 1}var f=r?r.getSiblingIndex():0,d=o?o.getSiblingIndex():0;return a?f-d:d-f},t._markListDirty=function(){this._isListDirty=!0},e}()),function(){function e(e,t){this._device=null,this._attributes=null,this._vertexFormatBytes=void 0,this._floatsPerVertex=void 0,this._buffers=[],this._device=e,this._attributes=t,this._floatsPerVertex=aB(t),this._vertexFormatBytes=this._floatsPerVertex*Float32Array.BYTES_PER_ELEMENT}var t=e.prototype;return t.initialize=function(){},t.reset=function(){},t.request=function(){},t.appendBuffers=function(){},t.uploadBuffers=function(){},t.destroy=function(){this._attributes.length=0},h(e,[{key:"attributes",get:function(){return this._attributes}},{key:"vertexFormatBytes",get:function(){return this._vertexFormatBytes}},{key:"floatsPerVertex",get:function(){return this._floatsPerVertex}}]),e}()),kq=new Ml((function(){return{offset:0,length:0}}),32),Gq=function(e,t,n,i){this.vertexAccessor=e,this.bufferId=t,this.vertexOffset=n,this.vb=i},Hq=function(e){function t(n,i,r,o){var a;return(a=e.call(this,n,i)||this)._freeLists=[],a._vCount=0,a._iCount=0,a._vCount=r||Math.floor(1024*nt.BATCHER2D_MEM_INCREMENT/a._vertexFormatBytes),a._iCount=o||a._vCount*t.IB_SCALE,a._allocateBuffer(),a}f(t,e);var n=t.prototype;return n.destroy=function(){for(var t=0;t<this._buffers.length;++t){this._buffers[t].destroy();for(var n=this._freeLists[t],i=0;i<n.length;++i)kq.free(n[i])}this._buffers.length=0,this._freeLists.length=0,e.prototype.destroy.call(this)},n.reset=function(){for(var e=0;e<this._buffers.length;++e){var t=this._buffers[e];t.indexOffset=0,t.reset()}},n.getVertexBuffer=function(e){return this._buffers[e].vData},n.getIndexBuffer=function(e){return this._buffers[e].iData},n.getMeshBuffer=function(e){return this._buffers[e]},n.uploadBuffers=function(){for(var e=0;e<this._buffers.length;++e){var t=this._freeLists[e][0],n=this._buffers[e];(!t||t.length<n.vData.byteLength)&&n.uploadBuffers()}},n.appendIndices=function(e,t){var n=this._buffers[e];t.length&&(n.iData.set(t,n.indexOffset),n.indexOffset+=t.length)},n.allocateChunk=function(e,t){for(var n,i=e*this.vertexFormatBytes,r=null,o=0,a=-1,s=null,c=0;c<this._buffers.length;++c){r=this._buffers[c],n=this._freeLists[c];for(var l=0;l<n.length;++l)if(n[l].length>=i){s=n[l],o=c,a=l;break}if(s)break}if(s||(o=this._allocateBuffer(),(r=this._buffers[o])&&r.checkCapacity(e,t)&&(a=0,s=this._freeLists[o][a])),s){var u=s.offset/this.vertexFormatBytes,h=new Float32Array(r.vData.buffer,s.offset,i>>2).fill(0);return this._allocateChunkFromEntry(o,a,s,i),new Gq(this,o,u,h,t)}return Y(9004,i),null},n.recycleChunk=function(e){var t=this._freeLists[e.bufferId],n=this._buffers[e.bufferId],i=e.vertexOffset*this.vertexFormatBytes,r=e.vb.byteLength;if(0!==r){for(var o=!1,a=0,s=null,c=t[a];c&&c.offset<i;)s=c,c=t[++a];if(s&&0==i-(s.offset+s.length)&&(s.length+=r,i=s.offset,r=s.length,c&&c.offset-(i+r)==0&&(s.length+=c.length,t.splice(a,1),kq.free(c),c=null),o=!0),!o&&c){if(0==c.offset-(i+r))c.offset=i,c.length+=r;else{var l=kq.alloc();l.offset=i,l.length=r,t.splice(a,0,l)}o=!0}if(o)i+r===n.byteOffset&&(n.byteOffset=i);else{var u=kq.alloc();u.offset=i,u.length=r,t.push(u)}}},n._allocateChunkFromEntry=function(e,t,n,i){var r=n.length-i,o=n.offset+i,a=this._buffers[e];a.byteOffset<o&&(a.byteOffset=o),J(r>=0,9004,e,n.offset,n.length),0===r?(this._freeLists[e].splice(t,1),kq.free(n)):(n.offset+=i,n.length=r)},n._allocateBuffer=function(){J(this._buffers.length===this._freeLists.length,9003);var e=new Fq,t=this._vCount*this._floatsPerVertex;e.initialize(this._device,this._attributes,t,this._iCount),this._buffers.push(e);var n=kq.alloc();n.offset=0,n.length=e.vData.byteLength;var i=[n];return this._freeLists.push(i),this._buffers.length-1},t}(Uq);Hq.IB_SCALE=4;var Vq=new zr(null),Wq=new kn,jq=function(){function e(e){var t=this;this.device=void 0,this._screens=[],this._staticVBBuffer=null,this._bufferAccessors=new Map,this._drawBatchPool=void 0,this._batches=void 0,this._currBID=-1,this._indexStart=0,this._emptyMaterial=new Ov,this._currRenderData=null,this._currMaterial=this._emptyMaterial,this._currTexture=null,this._currSampler=null,this._currStaticRoot=null,this._currComponent=null,this._currTransform=null,this._currTextureHash=0,this._currSamplerHash=0,this._currLayer=0,this._currDepthStencilStateStage=null,this._currIsStatic=!1,this._currHash=0,this._pOpacity=1,this._opacityDirty=0,this._descriptorSetCache=new Xq,this._meshDataArray=[],this._root=e,this.device=e.device,this._batches=new Fl(64),this._drawBatchPool=new Ml((function(){return new jV}),128,(function(e){return e.destroy(t)}))}var t=e.prototype;return t.initialize=function(){return!0},t.destroy=function(){for(var e=0;e<this._batches.length;e++)this._batches.array[e]&&this._batches.array[e].destroy(this);this._batches.destroy(),this._bufferAccessors.forEach((function(e){e.destroy()})),this._bufferAccessors.clear(),this._drawBatchPool&&this._drawBatchPool.destroy(),this._descriptorSetCache.destroy(),oz.sharedManager.destroy()},t.addScreen=function(e){this._screens.push(e),this._screens.sort(this._screenSort)},t.removeScreen=function(e){var t=this._screens.indexOf(e);-1!==t&&this._screens.splice(t,1)},t.sortScreens=function(){this._screens.sort(this._screenSort)},t.getFirstRenderCamera=function(e){if(e.scene&&e.scene.renderScene)for(var t=e.scene.renderScene.cameras,n=0;n<t.length;n++){var i=t[n];if(i.visibility&e.layer)return i}return null},t.update=function(){for(var e=this._screens,t=0,n=0;n<e.length;++n){var i=e[n],r=i._getRenderScene();if(i.enabledInHierarchy&&r){this._opacityDirty=0,this._pOpacity=1,this.walk(i.node),this.autoMergeBatches(this._currComponent),this.resetRenderStates();var o=0;if(this._batches.length>t)for(;t<this._batches.length;++t){var a=this._batches.array[t];if(a.model)for(var s=a.model.subModels,c=0;c<s.length;c++)s[c].priority=o++;else a.descriptorSet=this._descriptorSetCache.getDescriptorSet(a);r.addBatch(a)}}}},t.uploadBuffers=function(){this._batches.length>0&&(this._meshDataArray.forEach((function(e){e.uploadBuffers()})),this._bufferAccessors.forEach((function(e){e.uploadBuffers(),e.reset()})),this._descriptorSetCache.update())},t.reset=function(){for(var e=0;e<this._batches.length;++e){var t=this._batches.array[e];t.isStatic||(t.clear(),this._drawBatchPool.free(t))}this._bufferAccessors.forEach((function(e){e.reset()})),this._meshDataArray.forEach((function(e){e.freeIAPool()})),this._meshDataArray.length=0,this._staticVBBuffer=null,this._currBID=-1,this._indexStart=0,this._currHash=0,this._currLayer=0,this._currRenderData=null,this._currMaterial=this._emptyMaterial,this._currTexture=null,this._currSampler=null,this._currComponent=null,this._currTransform=null,this._batches.clear(),oz.sharedManager.reset()},t.switchBufferAccessor=function(e){void 0===e&&(e=rB);var t=e===rB?36:sB(e);if(!this._staticVBBuffer||this._staticVBBuffer.vertexFormatBytes!==t){var n=this._bufferAccessors.get(t);n||(n=new Hq(this.device,e),this._bufferAccessors.set(t,n)),this._staticVBBuffer=n,this._currBID=-1}return this._staticVBBuffer},t.registerBufferAccessor=function(e,t){this._bufferAccessors.set(e,t)},t.updateBuffer=function(e,t){var n=this.switchBufferAccessor(e);this._currBID!==t&&(this._currBID=t,this._indexStart=n.getMeshBuffer(t).indexOffset)},t.commitComp=function(e,t,n,i,r){var o,a=0,s=-1;if(t&&t.chunk){if(!t.isValid())return;a=t.dataHash,o=t.material,s=t.chunk.bufferId}e.stencilStage=oz.sharedManager.stage;var c=e.stencilStage;this._currHash===a&&0!==a&&this._currMaterial===o&&this._currDepthStencilStateStage===c||(this.autoMergeBatches(this._currComponent),t&&!t.isMeshBuffer&&this.updateBuffer(t.vertexFormat,s),this._currRenderData=t,this._currHash=t?t.dataHash:0,this._currComponent=e,this._currTransform=r,this._currMaterial=e.getRenderMaterial(0),this._currDepthStencilStateStage=c,this._currLayer=e.node.layer,n?(this._currTexture=n.getGFXTexture(),this._currSampler=n.getGFXSampler(),this._currTextureHash=n.getHash(),this._currSamplerHash=this._currSampler.hash):(this._currTexture=null,this._currSampler=null,this._currTextureHash=0,this._currSamplerHash=0)),i.fillBuffers(e,this)},t.commitIA=function(e,t,n,i,r){var o,a;this._currMaterial!==this._emptyMaterial&&(this.autoMergeBatches(this._currComponent),this.resetRenderStates());var s=0,c=0;e&&(o=-1===e.blendHash?null:e.getBlendState(),c=e.blendHash,e.stencilStage=oz.sharedManager.stage,a=null!==e.customMaterial?oz.sharedManager.getStencilStage(e.stencilStage,i):oz.sharedManager.getStencilStage(e.stencilStage),s=oz.sharedManager.getStencilHash(e.stencilStage));var l=this._currStaticRoot?this._currStaticRoot._requireDrawBatch():this._drawBatchPool.alloc();l.visFlags=e.node.layer,l.inputAssembler=t,l.useLocalData=r||null,n&&(l.texture=n.getGFXTexture(),l.sampler=n.getGFXSampler(),l.textureHash=n.getHash(),l.samplerHash=l.sampler.hash),l.fillPasses(i||null,a,s,o,c,null,this),this._batches.push(l)},t.commitModel=function(e,t,n){var i;this._currMaterial!==this._emptyMaterial&&(this.autoMergeBatches(this._currComponent),this.resetRenderStates());var r=0;n&&(e.stencilStage!==EB.ENABLED&&e.stencilStage!==EB.DISABLED||(e.stencilStage=oz.sharedManager.stage),i=oz.sharedManager.getStencilStage(e.stencilStage,n),r=oz.sharedManager.getStencilHash(e.stencilStage));var o=b.director.getTotalFrames();t&&(t.updateTransform(o),t.updateUBOs(o));for(var a=0;a<t.subModels.length;a++){var s=this._drawBatchPool.alloc(),c=t.subModels[a];s.visFlags=e.node.layer,s.model=t,s.texture=null,s.sampler=null,s.useLocalData=null,i||(i=null),s.fillPasses(n,i,r,null,0,c.patches,this),s.inputAssembler=c.inputAssembler,s.model.visFlags=s.visFlags,s.descriptorSet=c.descriptorSet,this._batches.push(s)}},t.setupStaticBatch=function(e,t){this.finishMergeBatches(),this._staticVBBuffer=t,this.currStaticRoot=e},t.endStaticBatch=function(){this.finishMergeBatches(),this.currStaticRoot=null,this._staticVBBuffer=null,this.switchBufferAccessor()},t.commitStaticBatch=function(e){this._batches.concat(e.drawBatchList),this.finishMergeBatches()},t.autoMergeBatches=function(e){var t=this._currMaterial;if(t){var n,i=this._currRenderData,r=this._staticVBBuffer;if(i&&i.isMeshBuffer)n=i.requestIA(this.device),-1===this._meshDataArray.indexOf(i)&&this._meshDataArray.push(i);else if(r){var o=this._currBID,a=r.getMeshBuffer(o);if(!a)return;var s=a.indexOffset-this._indexStart;if(s<=0)return;this._indexStart,a.indexOffset,a.setDirty(),(n=a.requireFreeIA(this.device)).firstIndex=this._indexStart,n.indexCount=s,this._indexStart=a.indexOffset}if(this._currBID=-1,n){var c,l,u=0,h=0;e&&(c=-1===e.blendHash?null:e.getBlendState(),h=e.blendHash,l=null!==e.customMaterial?oz.sharedManager.getStencilStage(e.stencilStage,t):oz.sharedManager.getStencilStage(e.stencilStage),u=oz.sharedManager.getStencilHash(e.stencilStage));var _=this._currStaticRoot?this._currStaticRoot._requireDrawBatch():this._drawBatchPool.alloc();_.visFlags=this._currLayer,_.texture=this._currTexture,_.sampler=this._currSampler,_.inputAssembler=n,_.useLocalData=this._currTransform,_.textureHash=this._currTextureHash,_.samplerHash=this._currSamplerHash,_.fillPasses(t,l,u,c,h,null,this),this._batches.push(_)}}},t.forceMergeBatches=function(e,t,n){this._currMaterial=e,t?(this._currTexture=t.getGFXTexture(),this._currSampler=t.getGFXSampler(),this._currTextureHash=t.getHash(),this._currSamplerHash=this._currSampler.hash):(this._currTexture=this._currSampler=null,this._currTextureHash=this._currSamplerHash=0),this._currLayer=n.node.layer,this.autoMergeBatches(n)},t.resetRenderStates=function(){this._currMaterial=this._emptyMaterial,this._currRenderData=null,this._currTexture=null,this._currComponent=null,this._currTransform=null,this._currTextureHash=0,this._currSamplerHash=0,this._currLayer=0},t.finishMergeBatches=function(){this.autoMergeBatches(),this.resetRenderStates()},t.flushMaterial=function(e){this._currMaterial=e},t.walk=function(e,t){if(void 0===t&&(t=0),e.activeInHierarchy){var n=e.children,i=e._uiProps,r=i.uiComp,o=this._pOpacity,a=o,s=r&&r.color?r.color.a/255:1;if(this._pOpacity=a*=s*i.localOpacity,i._opacity=a,i.colorDirty&&this._opacityDirty++,r&&r.enabledInHierarchy&&r.updateAssembler(this),this._opacityDirty&&r&&!r.useVertexOpacity&&r.renderData&&r.renderData.vertexCount>0){!function(e,t){for(var n,i,r,o=e.vertexFormat,a=e.chunk.vb,s=0,c=0;c<o.length;++c){if(n=o[c],(i=Kr[n.format]).hasAlpha)if(r=e.floatStride,i.size/i.count==1)for(var l=~~en(Math.round(255*t),0,255),u=s;u<a.length;u+=r)a[u]=(4294967040&a[u]|l)>>>0;else if(i.size/i.count==4)for(var h=s+3;h<a.length;h+=r)a[h]=t;s+=i.size>>2}}(r.renderData,a);var c=r.renderData.getMeshBuffer();c&&c.setDirty()}if(n.length>0&&!e._static)for(var l=0;l<n.length;++l){var u=n[l];this.walk(u,t)}i.colorDirty&&(this._opacityDirty--,i.colorDirty=!1),this._pOpacity=o,r&&r.enabledInHierarchy&&r.postUpdateAssembler(this),t+=1}},t._screenSort=function(e,t){return e.node.getSiblingIndex()-t.node.getSiblingIndex()},t._releaseDescriptorSetCache=function(e){this._descriptorSetCache.releaseDescriptorSetCache(e)},h(e,[{key:"currBufferAccessor",get:function(){return this._staticVBBuffer||(this._staticVBBuffer=this.switchBufferAccessor()),this._staticVBBuffer}},{key:"batches",get:function(){return this._batches}},{key:"currStaticRoot",set:function(e){this._currStaticRoot=e}},{key:"currIsStatic",set:function(e){this._currIsStatic=e}}]),e}(),qq=function(){function e(){this._descriptorSet=null,this._transform=null,this._textureHash=0,this._samplerHash=0,this._localBuffer=null,this._transformUpdate=!0;var e=b.director.root.device;this._localData=new Float32Array(Fd.COUNT),this._localBuffer=e.createBuffer(new cr(li.UNIFORM|li.TRANSFER_DST,_i.HOST|_i.DEVICE,Fd.SIZE,Fd.SIZE))}var t=e.prototype;return t.initialize=function(e){var t=b.director.root.device;this._transform=e.useLocalData,this._textureHash=e.textureHash,this._samplerHash=e.samplerHash,Vq.layout=e.passes[0].localSetLayout,this._descriptorSet=t.createDescriptorSet(Vq),this._descriptorSet.bindBuffer(Fd.BINDING,this._localBuffer);var n=fd.SAMPLER_SPRITE;this._descriptorSet.bindTexture(n,e.texture),this._descriptorSet.bindSampler(n,e.sampler),this._descriptorSet.update(),this._transformUpdate=!0},t.updateTransform=function(e){e!==this._transform&&(this._transform=e,this._transformUpdate=!0,this.uploadLocalData())},t.equals=function(e,t,n){return this._transform===e&&this._textureHash===t&&this._samplerHash===n},t.reset=function(){this._transform=null,this._textureHash=0,this._samplerHash=0},t.destroy=function(){this._localBuffer&&(this._localBuffer.destroy(),this._localBuffer=null),this._descriptorSet&&(this._descriptorSet.destroy(),this._descriptorSet=null),this._localData=null},t.isValid=function(){return this._transform&&this._transform.isValid},t.uploadLocalData=function(){var e=this._transform;if((e.hasChangedFlags||e._dirtyFlags)&&(e.updateWorldTransform(),this._transformUpdate=!0),this._transformUpdate){var t=e.worldMatrix;kn.toArray(this._localData,t,Fd.MAT_WORLD_OFFSET),kn.inverseTranspose(Wq,t);var n=kn.determinant(Wq),i=1/Math.sqrt(n);kn.multiplyScalar(Wq,Wq,i),kn.toArray(this._localData,Wq,Fd.MAT_WORLD_IT_OFFSET),this._localBuffer.update(this._localData),this._transformUpdate=!1}},h(e,[{key:"descriptorSet",get:function(){return this._descriptorSet}}]),e}(),Xq=function(){function e(){this._descriptorSetCache=new Map,this._dsCacheHashByTexture=new Map,this._localDescriptorSetCache=[],this._localCachePool=void 0,this._localCachePool=new Ml((function(){return new qq}),16,(function(e){return e.destroy()}))}var t=e.prototype;return t.getDescriptorSet=function(e){var t,n=b.director.root;if(e.useLocalData){for(var i=this._localDescriptorSetCache,r=0,o=i.length;r<o;r++){var a=i[r];if(a.equals(e.useLocalData,e.textureHash,e.samplerHash))return a.descriptorSet}var s=this._localCachePool.alloc();return s.initialize(e),this._localDescriptorSetCache.push(s),s.descriptorSet}if(t=e.textureHash^e.samplerHash,this._descriptorSetCache.has(t))return this._descriptorSetCache.get(t);Vq.layout=e.passes[0].localSetLayout;var c=n.device.createDescriptorSet(Vq),l=fd.SAMPLER_SPRITE;return c.bindTexture(l,e.texture),c.bindSampler(l,e.sampler),c.update(),this._descriptorSetCache.set(t,c),this._dsCacheHashByTexture.set(e.textureHash,t),c},t.update=function(){var e=this._localDescriptorSetCache,t=[];e.forEach((function(n){if(n.isValid())n.uploadLocalData();else{n.reset();var i=e.indexOf(n);t.push(i)}}));for(var n=t.length-1;n>=0;n--)e.splice(t[n],1)},t.reset=function(){var e=this;this._localDescriptorSetCache.forEach((function(t){e._localCachePool.free(t)})),this._localDescriptorSetCache.length=0},t.releaseDescriptorSetCache=function(e){var t=this._dsCacheHashByTexture.get(e);t&&this._descriptorSetCache.has(t)&&(this._descriptorSetCache.get(t).destroy(),this._descriptorSetCache.delete(t),this._dsCacheHashByTexture.delete(e))},t.destroy=function(){this._descriptorSetCache.forEach((function(e){e.destroy()})),this._descriptorSetCache.clear(),this._dsCacheHashByTexture.clear(),this._localDescriptorSetCache.length=0,this._localCachePool.destroy()},e}();b.internal.Batcher2D=jq;var Yq,Kq,Qq=null,Jq=-1,Zq="BES bswy:->@123",$q=Object.create(null),eX=[],tX=3e3;function nX(){for(var e=!0,t=Date.now(),n=eX.length-1;n>=0;n--){var i=eX[n],r=i.fontFamilyName;if(t-i.startTime>tX)q(4933,r),i.onComplete(null,r),eX.splice(n,1);else{var o=i.refWidth,a="40px "+r;Qq.font=a,o!==VF(Qq,Zq,a)?(eX.splice(n,1),i.onComplete(null,r)):e=!1}}e&&(clearInterval(Jq),Jq=-1)}function iX(e,t,n){var i=function(e){var t=e.lastIndexOf(".ttf");if(-1===t)return e;var n,i=e.lastIndexOf("/");return-1!==(n=-1===i?e.substring(0,t)+"_LABEL":e.substring(i+1,t)+"_LABEL").indexOf(" ")&&(n='"'+n+'"'),n}(e);if($q[i])n(null,i);else{if(!Qq){var r=document.createElement("canvas");r.width=100,r.height=100,Qq=r.getContext("2d")}var o=VF(Qq,Zq,"40px "+i),a=document.createElement("style");a.type="text/css";var s="";Number.isNaN(i)?s+="@font-face { font-family:"+i+"; src:":s+='@font-face { font-family:"'+i+'"; src:',s+='url("'+e+'");',a.textContent=s+"}",document.body.appendChild(a);var c,l,u,h,_,f,d=document.createElement("div"),p=d.style;if(p.fontFamily=i,d.innerHTML=".",p.position="absolute",p.left="-100px",p.top="-100px",document.body.appendChild(d),function(){if(void 0===Yq)if("FontFace"in window){var e=/Gecko.*Firefox\/(\d+)/.exec(window.navigator.userAgent),t=/OS X.*Version\/10\..*Safari/.exec(window.navigator.userAgent)&&/Apple/.exec(window.navigator.vendor);Yq=e?parseInt(e[1],10)>42:!t}else Yq=!1;return Yq}())c=Date.now(),l=i,u=n,h=new Promise((function(e,t){!function n(){Date.now()-c>=tX?t():document.fonts.load("40px "+l).then((function(t){t.length>=1?e():setTimeout(n,100)}),(function(){t()}))}()})),_=null,f=new Promise((function(e,t){_=setTimeout(t,tX)})),Promise.race([f,h]).then((function(){_&&(clearTimeout(_),_=null),u(null,l)}),(function(){q(4933,l),u(null,l)}));else{var m={fontFamilyName:i,refWidth:o,onComplete:n,startTime:Date.now()};eX.push(m),-1===Jq&&(Jq=setInterval(nX,100))}$q[i]=a}}function rX(e,t,n,i){var r=new bF;r._nativeUrl=e,r._nativeAsset=t,i(null,r)}IN.register({".font":iX,".eot":iX,".ttf":iX,".woff":iX,".svg":iX,".ttc":iX}),LN.register({".font":rX,".eot":rX,".ttf":rX,".woff":rX,".svg":rX,".ttc":rX}),b.UI={MeshBuffer:Fq,spriteAssembler:Rq,graphicsAssembler:RW,labelAssembler:Jj,RenderData:wB,MeshRenderData:IB},function(e){e[e.positions=qi.ATTR_POSITION]="positions",e[e.normals=qi.ATTR_NORMAL]="normals",e[e.uvs=qi.ATTR_TEX_COORD]="uvs",e[e.colors=qi.ATTR_COLOR]="colors"}(Kq||(Kq={}));var oX,aX,sX,cX,lX,uX=function(){function e(){this._arrayBufferOrPaddings=[],this._length=0}var t=e.prototype;return t.setNextAlignment=function(e){if(0!==e){var t=this._length%e;if(0!==t){var n=e-t;this._arrayBufferOrPaddings.push(n),this._length+=n}}},t.addBuffer=function(e){var t=this._length;return this._arrayBufferOrPaddings.push(e),this._length+=e.byteLength,t},t.getLength=function(){return this._length},t.getCombined=function(){var e=new Uint8Array(this._length),t=0;return this._arrayBufferOrPaddings.forEach((function(n){"number"==typeof n?t+=n:(e.set(new Uint8Array(n),t),t+=n.byteLength)})),e.buffer},e}(),hX=function(){function e(e,t){if(this._mesh=void 0,this._subMeshRenderings=[],this._mesh=e,this._mesh.struct.morph){var n=this._mesh.struct.primitives.length;this._subMeshRenderings=new Array(n).fill(null);for(var i=0;i<n;++i){var r=this._mesh.struct.morph.subMeshMorphs[i];r&&(r.targets.length>qd.MAX_MORPH_TARGET_COUNT?this._subMeshRenderings[i]=new fX(this._mesh,i,this._mesh.struct.morph,t):this._subMeshRenderings[i]=new _X(this._mesh,i,this._mesh.struct.morph,t))}}}return e.prototype.createInstance=function(){for(var e=this,t=this._mesh.struct.primitives.length,n=new Array(t),i=0;i<t;++i){var r,o;n[i]=null!==(r=null===(o=this._subMeshRenderings[i])||void 0===o?void 0:o.createInstance())&&void 0!==r?r:null}return{setWeights:function(e,t){var i;null===(i=n[e])||void 0===i||i.setWeights(t)},requiredPatches:function(t){e._mesh.struct.morph;var i=e._mesh.struct.morph.subMeshMorphs[t],r=n[t];if(null===r)return null;var o=[{name:"CC_USE_MORPH",value:!0},{name:"CC_MORPH_TARGET_COUNT",value:i.targets.length}];return i.attributes.includes(qi.ATTR_POSITION)&&o.push({name:"CC_MORPH_TARGET_HAS_POSITION",value:!0}),i.attributes.includes(qi.ATTR_NORMAL)&&o.push({name:"CC_MORPH_TARGET_HAS_NORMAL",value:!0}),i.attributes.includes(qi.ATTR_TANGENT)&&o.push({name:"CC_MORPH_TARGET_HAS_TANGENT",value:!0}),o.push.apply(o,r.requiredPatches()),o},adaptPipelineState:function(e,t){var i;null===(i=n[e])||void 0===i||i.adaptPipelineState(t)},destroy:function(){for(var e,t=S(n);!(e=t()).done;){var i=e.value;null==i||i.destroy()}}}},e}(),_X=function(){function e(e,t,n,i){this._gfxDevice=void 0,this._subMeshMorph=void 0,this._textureInfo=void 0,this._attributes=void 0,this._verticesCount=void 0,this._gfxDevice=i;var r=n.subMeshMorphs[t];this._subMeshMorph=r,vX(e,t,i);var o=e.struct.vertexBundles[e.struct.primitives[t].vertexBundelIndices[0]].view.count;this._verticesCount=o;var a=r.targets.length,s=mX(i,o*a);this._textureInfo={width:s.width,height:s.height},this._attributes=r.attributes.map((function(t,n){var i=s.create(),a=i.valueView;return r.targets.forEach((function(t,i){for(var r=t.displacements[n],s=new Float32Array(e.data.buffer,e.data.byteOffset+r.offset,r.count),c=o*i*4,l=0;l<o;++l)a[c+4*l+0]=s[3*l+0],a[c+4*l+1]=s[3*l+1],a[c+4*l+2]=s[3*l+2]})),i.updatePixels(),{name:t,morphTexture:i}}))}var t=e.prototype;return t.destroy=function(){for(var e,t=S(this._attributes);!(e=t()).done;)e.value.morphTexture.destroy()},t.createInstance=function(){var e=this,t=new pX(this._gfxDevice,this._subMeshMorph.targets.length);return t.setMorphTextureInfo(this._textureInfo.width,this._textureInfo.height),t.setVerticesCount(this._verticesCount),t.commit(),{setWeights:function(e){t.setWeights(e),t.commit()},requiredPatches:function(){return[{name:"CC_MORPH_TARGET_USE_TEXTURE",value:!0}]},adaptPipelineState:function(n){for(var i,r=S(e._attributes);!(i=r()).done;){var o=i.value,a=void 0;switch(o.name){case qi.ATTR_POSITION:a=Jd;break;case qi.ATTR_NORMAL:a=ep;break;case qi.ATTR_TANGENT:a=ip;break;default:F("Unexpected attribute!")}void 0!==a&&(n.bindSampler(a,o.morphTexture.sampler),n.bindTexture(a,o.morphTexture.texture))}n.bindBuffer(qd.BINDING,t.buffer),n.update()},destroy:function(){}}},e}(),fX=function(){function e(e,t,n,i){this._gfxDevice=void 0,this._attributes=[],this._gfxDevice=i;var r=n.subMeshMorphs[t];vX(e,t,i),this._attributes=r.attributes.map((function(t,n){return{name:t,targets:r.targets.map((function(t){return{displacements:new Float32Array(e.data.buffer,e.data.byteOffset+t.displacements[n].offset,t.displacements[n].count)}}))}}))}return e.prototype.createInstance=function(){return new dX(this,this._attributes[0].targets[0].displacements.length/3,this._gfxDevice)},h(e,[{key:"data",get:function(){return this._attributes}}]),e}(),dX=function(){function e(e,t,n){this._attributes=void 0,this._owner=void 0,this._morphUniforms=void 0,this._owner=e,this._morphUniforms=new pX(n,0);var i=mX(n,t);this._morphUniforms.setMorphTextureInfo(i.width,i.height),this._morphUniforms.commit(),this._attributes=this._owner.data.map((function(e){var t=i.create();return{attributeName:e.name,morphTexture:t}}))}var t=e.prototype;return t.setWeights=function(e){for(var t=0;t<this._attributes.length;++t){var n=this._attributes[t],i=n.morphTexture.valueView,r=this._owner.data[t];e.length,r.targets.length;for(var o=0;o<r.targets.length;++o){var a=r.targets[o].displacements,s=e[o],c=a.length/3;if(0===o)for(var l=0;l<c;++l)i[4*l+0]=a[3*l+0]*s,i[4*l+1]=a[3*l+1]*s,i[4*l+2]=a[3*l+2]*s;else if(0!==s)for(var u=0;u<c;++u)i[4*u+0]+=a[3*u+0]*s,i[4*u+1]+=a[3*u+1]*s,i[4*u+2]+=a[3*u+2]*s}n.morphTexture.updatePixels()}},t.requiredPatches=function(){return[{name:"CC_MORPH_TARGET_USE_TEXTURE",value:!0},{name:"CC_MORPH_PRECOMPUTED",value:!0}]},t.adaptPipelineState=function(e){for(var t,n=S(this._attributes);!(t=n()).done;){var i=t.value,r=void 0;switch(i.attributeName){case qi.ATTR_POSITION:r=Jd;break;case qi.ATTR_NORMAL:r=ep;break;case qi.ATTR_TANGENT:r=ip;break;default:F("Unexpected attribute!")}void 0!==r&&(e.bindSampler(r,i.morphTexture.sampler),e.bindTexture(r,i.morphTexture.texture))}e.bindBuffer(qd.BINDING,this._morphUniforms.buffer),e.update()},t.destroy=function(){this._morphUniforms.destroy();for(var e=0;e<this._attributes.length;++e)this._attributes[e].morphTexture.destroy()},e}(),pX=function(){function e(e,t){this._targetCount=void 0,this._localBuffer=void 0,this._remoteBuffer=void 0,this._targetCount=t,this._localBuffer=new DataView(new ArrayBuffer(qd.SIZE)),this._remoteBuffer=e.createBuffer(new cr(li.UNIFORM|li.TRANSFER_DST,_i.HOST|_i.DEVICE,qd.SIZE,qd.SIZE))}var t=e.prototype;return t.destroy=function(){this._remoteBuffer.destroy()},t.setWeights=function(e){e.length,this._targetCount;for(var t=0;t<e.length;++t)this._localBuffer.setFloat32(qd.OFFSET_OF_WEIGHTS+4*t,e[t],b.sys.isLittleEndian)},t.setMorphTextureInfo=function(e,t){this._localBuffer.setFloat32(qd.OFFSET_OF_DISPLACEMENT_TEXTURE_WIDTH,e,b.sys.isLittleEndian),this._localBuffer.setFloat32(qd.OFFSET_OF_DISPLACEMENT_TEXTURE_HEIGHT,t,b.sys.isLittleEndian)},t.setVerticesCount=function(e){this._localBuffer.setFloat32(qd.OFFSET_OF_VERTICES_COUNT,e,b.sys.isLittleEndian)},t.commit=function(){this._remoteBuffer.update(this._localBuffer.buffer)},h(e,[{key:"buffer",get:function(){return this._remoteBuffer}}]),e}();function mX(e,t){var n,i,o,a;e.getFormatFeatures(ai.RGBA32F)&mi.SAMPLED_TEXTURE?(n=t,o=16,i=Xm.PixelFormat.RGBA32F,a=Float32Array):(n=4*t,o=4,i=Xm.PixelFormat.RGBA8888,a=Uint8Array);var c=function(e){e<5&&(e=5);var t=r(s(e)),n=t>>1;return{width:1<<(1&t?n+1:n),height:1<<n}}(n),l=c.width,u=c.height;return{width:l,height:u,create:function(){var t=new ArrayBuffer(l*u*o),n=new Float32Array(t),r=a===Float32Array?n:new a(t),s=new Cm({width:l,height:u,_data:r,_compressed:!1,format:i}),c=new Xm;c.setFilters(Xm.Filter.NEAREST,Xm.Filter.NEAREST),c.setMipFilter(Xm.Filter.NONE),c.setWrapMode(Xm.WrapMode.CLAMP_TO_EDGE,Xm.WrapMode.CLAMP_TO_EDGE,Xm.WrapMode.CLAMP_TO_EDGE),c.image=s,c.getGFXTexture()||F("Unexpected: failed to create morph texture?");var h=e.getSampler(c.getSamplerInfo());return{get texture(){return c.getGFXTexture()},get sampler(){return h},get valueView(){return n},destroy:function(){c.destroy()},updatePixels:function(){c.uploadData(r)}}}}}function vX(e,t,n){e.renderingSubMeshes[t].enableVertexIdChannel(n)}function gX(e){switch(e){case 1:return Uint8Array;case 2:return Uint16Array;case 4:return Uint32Array;default:return Uint8Array}}var yX=new yn,xX=new yn,SX=new Uint8Array,EX=e("Mesh",dc("cc.Mesh")((lX=function(e){function t(){var t;return(t=e.call(this)||this).morphRendering=null,E(t,"_struct",sX,y(t)),E(t,"_hash",cX,y(t)),t._data=SX,t._initialized=!1,t._renderingSubMeshes=null,t._boneSpaceBounds=new Map,t._jointBufferIndices=null,t}f(t,e);var n=t.prototype;return n.onLoaded=function(){this.initialize()},n.initialize=function(){if(!this._initialized){this._initialized=!0;for(var e=this._data.buffer,t=b.director.root.device,n=this._createVertexBuffers(t,e),i=[],r=0;r<this._struct.primitives.length;r++){var o=this._struct.primitives[r];if(0!==o.vertexBundelIndices.length){var a=null,s=null;if(o.indexView){var c=o.indexView,l=c.stride,u=c.length;if(4===l&&!t.hasFeature(oi.ELEMENT_INDEX_UINT)){var h=this._struct.vertexBundles[o.vertexBundelIndices[0]].view.count;if(h>=65536){q(10001,h,65536);continue}l>>=1,u>>=1}a=t.createBuffer(new cr(li.INDEX,_i.DEVICE,u,l)),s=new(gX(c.stride))(e,c.offset,c.count),c.stride!==l&&(s=gX(l).from(s)),a.update(s)}var _=o.vertexBundelIndices.map((function(e){return n[e]})),f=[];if(o.vertexBundelIndices.length>0)for(var d=o.vertexBundelIndices[0],p=this._struct.vertexBundles[d].attributes,m=0;m<p.length;++m){var v=p[m];f[m]=new br(v.name,v.format,v.isNormalized,v.stream,v.isInstanced,v.location)}var g=new HA(_,f,o.primitiveMode,a);g.mesh=this,g.subMeshIdx=r,i.push(g)}}this._renderingSubMeshes=i,this._struct.morph&&(this.morphRendering=function(e,t){return new hX(e,t)}(this,t))}},n.destroy=function(){return this.destroyRenderingMesh(),e.prototype.destroy.call(this)},n.destroyRenderingMesh=function(){if(this._renderingSubMeshes){for(var e=0;e<this._renderingSubMeshes.length;e++)this._renderingSubMeshes[e].destroy();this._renderingSubMeshes=null,this._initialized=!1}},n.assign=function(e,t){this.reset({struct:e,data:t})},n.reset=function(e){this.destroyRenderingMesh(),this._struct=e.struct,this._data=e.data,this._hash=0},n.getBoneSpaceBounds=function(e){if(this._boneSpaceBounds.has(e.hash))return this._boneSpaceBounds.get(e.hash);var t=[];this._boneSpaceBounds.set(e.hash,t);for(var n=[],i=e.bindposes,r=0;r<i.length;r++)t.push(new Us(1/0,1/0,1/0,-1/0,-1/0,-1/0)),n.push(!1);for(var o=this._struct.primitives,a=0;a<o.length;a++){var s=this.readAttribute(a,qi.ATTR_JOINTS),c=this.readAttribute(a,qi.ATTR_WEIGHTS),l=this.readAttribute(a,qi.ATTR_POSITION);if(s&&c&&l)for(var u=Math.min(s.length/4,c.length/4,l.length/3),h=0;h<u;h++){yn.set(yX,l[3*h+0],l[3*h+1],l[3*h+2]);for(var _=0;_<4;++_){var f=4*h+_,d=s[f];if(!(0===c[f]||d>=i.length)){yn.transformMat4(xX,yX,i[d]),n[d]=!0;var p=t[d];yn.min(p.center,p.center,xX),yn.max(p.halfExtents,p.halfExtents,xX)}}}}for(var m=0;m<i.length;m++){var v=t[m];n[m]?Us.fromPoints(v,v.center,v.halfExtents):t[m]=null}return t},n.merge=function(e,t,n){if(n&&!this.validateMergingMesh(e))return!1;var i=new yn,r=t&&new On,o=t&&new Us;if(r&&t.getRotation(r),!this._initialized){var a=JSON.parse(JSON.stringify(e._struct)),s=e._data.slice();if(t){a.maxPosition&&a.minPosition&&(yn.add(o.center,a.maxPosition,a.minPosition),yn.multiplyScalar(o.center,o.center,.5),yn.subtract(o.halfExtents,a.maxPosition,a.minPosition),yn.multiplyScalar(o.halfExtents,o.halfExtents,.5),Us.transform(o,o,t),yn.add(a.maxPosition,o.center,o.halfExtents),yn.subtract(a.minPosition,o.center,o.halfExtents));for(var c=0;c<a.vertexBundles.length;c++)for(var l=a.vertexBundles[c],u=0;u<l.attributes.length;u++)if(l.attributes[u].name===qi.ATTR_POSITION||l.attributes[u].name===qi.ATTR_NORMAL){var h=l.attributes[u].format,_=new DataView(s.buffer,l.view.offset+TX(l.attributes,u)),f=AX(_,h),d=wX(_,h);if(!f||!d)continue;for(var p=l.view.count,m=l.view.stride,v=bX(h),g=0;g<p;g++){var y=g*m,x=y+v,E=x+v;switch(i.set(f(y),f(x),f(E)),l.attributes[u].name){case qi.ATTR_POSITION:i.transformMat4(t);break;case qi.ATTR_NORMAL:yn.transformQuat(i,i,r)}d(y,i.x),d(x,i.y),d(E,i.z)}}}return this.reset({struct:a,data:s}),this.initialize(),!0}for(var T,C,b,A,w,I=new uX,P=0,R=0,D=0,O=0,N=0,M=0,L=0,F=0,B=!1,z=new Array(this._struct.vertexBundles.length),U=0;U<this._struct.vertexBundles.length;++U){var k=this._struct.vertexBundles[U],G=e._struct.vertexBundles[U];D=k.view.offset,O=G.view.offset,R=k.view.stride,P=k.view.count+G.view.count,T=new ArrayBuffer(P*R),C=new Uint8Array(T),D+=(b=this._data.subarray(D,D+k.view.length)).length,O+=(A=e._data.subarray(O,O+G.view.length)).length,C.set(b),N=0;for(var H,V=S(k.attributes);!(H=V()).done;){var W=H.value;L=0,B=!1;for(var j,q=S(G.attributes);!(j=q()).done;){var X=j.value;if(W.name===X.name&&W.format===X.format){B=!0;break}L+=Kr[X.format].size}if(B){F=Kr[W.format].size,M=k.view.length+N;for(var Y=0;Y<G.view.count;++Y){if(w=A.subarray(L,L+F),C.set(w,M),(W.name===qi.ATTR_POSITION||W.name===qi.ATTR_NORMAL)&&t){var K=new Float32Array(C.buffer,M,3);switch(i.set(K[0],K[1],K[2]),W.name){case qi.ATTR_POSITION:i.transformMat4(t);break;case qi.ATTR_NORMAL:yn.transformQuat(i,i,r)}K[0]=i.x,K[1]=i.y,K[2]=i.z}M+=k.view.stride,L+=G.view.stride}}N+=Kr[W.format].size}z[U]={attributes:k.attributes,view:{offset:I.getLength(),length:T.byteLength,count:P,stride:R}},I.addBuffer(T)}for(var Q,J,Z,$=0,ee=2,te=0,ne=new Array(this._struct.primitives.length),ie=0;ie<this._struct.primitives.length;++ie){var re=this._struct.primitives[ie],oe=e._struct.primitives[ie];ne[ie]={primitiveMode:re.primitiveMode,vertexBundelIndices:re.vertexBundelIndices};for(var ae,se=S(re.vertexBundelIndices);!(ae=se()).done;){var ce=ae.value;te=Math.max(te,this._struct.vertexBundles[ce].view.count)}if(re.indexView&&oe.indexView){$=re.indexView.count,$+=oe.indexView.count,D=re.indexView.offset,O=oe.indexView.offset,ee=$<256?1:$<65536?2:4;var le=new ArrayBuffer($*ee);if(Q=2===ee?new Uint16Array(le):1===ee?new Uint8Array(le):new Uint32Array(le),J=2===re.indexView.stride?new Uint16Array(this._data.buffer,D,re.indexView.count):1===re.indexView.stride?new Uint8Array(this._data.buffer,D,re.indexView.count):new Uint32Array(this._data.buffer,D,re.indexView.count),ee===re.indexView.stride)Q.set(J);else for(var ue=0;ue<re.indexView.count;++ue)Q[ue]=J[ue];D+=re.indexView.length,Z=2===oe.indexView.stride?new Uint16Array(e._data.buffer,O,oe.indexView.count):1===oe.indexView.stride?new Uint8Array(e._data.buffer,O,oe.indexView.count):new Uint32Array(e._data.buffer,O,oe.indexView.count);for(var he=0;he<oe.indexView.count;++he)Q[re.indexView.count+he]=te+Z[he];O+=oe.indexView.length,ne[ie].indexView={offset:I.getLength(),length:le.byteLength,count:$,stride:ee},I.setNextAlignment(ee),I.addBuffer(le)}}var _e={vertexBundles:z,primitives:ne,minPosition:this._struct.minPosition,maxPosition:this._struct.maxPosition};return _e.minPosition&&e._struct.minPosition&&_e.maxPosition&&e._struct.maxPosition&&(t?(yn.add(o.center,e._struct.maxPosition,e._struct.minPosition),yn.multiplyScalar(o.center,o.center,.5),yn.subtract(o.halfExtents,e._struct.maxPosition,e._struct.minPosition),yn.multiplyScalar(o.halfExtents,o.halfExtents,.5),Us.transform(o,o,t),yn.add(i,o.center,o.halfExtents),yn.max(_e.maxPosition,_e.maxPosition,i),yn.subtract(i,o.center,o.halfExtents),yn.min(_e.minPosition,_e.minPosition,i)):(yn.min(_e.minPosition,_e.minPosition,e._struct.minPosition),yn.max(_e.maxPosition,_e.maxPosition,e._struct.maxPosition))),this.reset({struct:_e,data:new Uint8Array(I.getCombined())}),this.initialize(),!0},n.validateMergingMesh=function(e){if(this._struct.vertexBundles.length!==e._struct.vertexBundles.length)return!1;for(var t=0;t<this._struct.vertexBundles.length;++t){var n=this._struct.vertexBundles[t],i=e._struct.vertexBundles[t];if(n.attributes.length!==i.attributes.length)return!1;for(var r=0;r<n.attributes.length;++r)if(n.attributes[r].format!==i.attributes[r].format)return!1}if(this._struct.primitives.length!==e._struct.primitives.length)return!1;for(var o=0;o<this._struct.primitives.length;++o){var a=this._struct.primitives[o],s=e._struct.primitives[o];if(a.vertexBundelIndices.length!==s.vertexBundelIndices.length)return!1;for(var c=0;c<a.vertexBundelIndices.length;++c)if(a.vertexBundelIndices[c]!==s.vertexBundelIndices[c])return!1;if(a.primitiveMode!==s.primitiveMode)return!1;if(a.indexView){if(void 0===s.indexView)return!1}else if(s.indexView)return!1}return!0},n.readAttribute=function(e,t){var n=this,i=null;return this._accessAttribute(e,t,(function(e,t){var r=e.view.count,o=e.attributes[t].format,a=oo(Kr[o]);if(0!==r){var s=new DataView(n._data.buffer,e.view.offset+TX(e.attributes,t)),c=Kr[o],l=AX(s,o);if(a&&l){for(var u=c.count,h=new a(r*u),_=e.view.stride,f=0;f<r;++f)for(var d=0;d<u;++d)h[u*f+d]=l(_*f+h.BYTES_PER_ELEMENT*d);i=h}}})),i},n.copyAttribute=function(e,t,n,i,r){var o=this,a=!1;return this._accessAttribute(e,t,(function(e,t){var s=e.view.count;if(0!==s){var c=e.attributes[t].format,l=new DataView(o._data.buffer,e.view.offset+TX(e.attributes,t)),u=new DataView(n,r),h=Kr[c],_=AX(l,c),f=wX(u,c);if(_&&f){for(var d=h.count,p=e.view.stride,m=bX(c),v=i,g=m,y=0;y<s;++y)for(var x=0;x<d;++x)f(v*y+g*x,_(p*y+m*x));a=!0}}else a=!0})),a},n.readIndices=function(e){if(e>=this._struct.primitives.length)return null;var t=this._struct.primitives[e];if(!t.indexView)return null;var n=t.indexView.stride;return new(1===n?Uint8Array:2===n?Uint16Array:Uint32Array)(this._data.buffer,t.indexView.offset,t.indexView.count)},n.copyIndices=function(e,t){if(e>=this._struct.primitives.length)return!1;var n=this._struct.primitives[e];if(!n.indexView)return!1;for(var i=n.indexView.count,r=1===n.indexView.stride?ai.R8UI:2===n.indexView.stride?ai.R16UI:ai.R32UI,o=AX(new DataView(this._data.buffer),r),a=0;a<i;++a)t[a]=o(n.indexView.offset+Kr[r].size*a);return!0},n._accessAttribute=function(e,t,n){if(!(e>=this._struct.primitives.length))for(var i,r=S(this._struct.primitives[e].vertexBundelIndices);!(i=r()).done;){var o=i.value,a=this._struct.vertexBundles[o],s=a.attributes.findIndex((function(e){return e.name===t}));if(!(s<0)){n(a,s);break}}},n._createVertexBuffers=function(e,t){return this._struct.vertexBundles.map((function(n){var i=e.createBuffer(new cr(li.VERTEX,_i.DEVICE,n.view.length,n.view.stride)),r=new Uint8Array(t,n.view.offset,n.view.length);return i.update(r),i}))},n.initDefault=function(t){e.prototype.initDefault.call(this,t),this.reset({struct:{vertexBundles:[],primitives:[]},data:SX})},h(t,[{key:"_nativeAsset",get:function(){return this._data.buffer},set:function(e){this._data=new Uint8Array(e)}},{key:"subMeshCount",get:function(){var e=this.renderingSubMeshes;return e?e.length:0}},{key:"minPosition",get:function(){return this.struct.minPosition}},{key:"maxPosition",get:function(){return this.struct.maxPosition}},{key:"struct",get:function(){return this._struct}},{key:"data",get:function(){return this._data}},{key:"hash",get:function(){return this._hash||(this._hash=po(this._data,666)),this._hash}},{key:"jointBufferIndices",get:function(){return this._jointBufferIndices?this._jointBufferIndices:this._jointBufferIndices=this._struct.primitives.map((function(e){return e.jointMapIndex||0}))}},{key:"renderingSubMeshes",get:function(){return this.initialize(),this._renderingSubMeshes}}]),t}(yu),sX=T((aX=lX).prototype,"_struct",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return{vertexBundles:[],primitives:[]}}}),cX=T(aX.prototype,"_hash",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),oX=aX))||oX);function TX(e,t){for(var n=0,i=0;i<t;++i){var r=e[i];n+=Kr[r.format].size}return n}b.Mesh=EX;var CX=Qu.isLittleEndian;function bX(e){var t=Kr[e];return t.size/t.count}function AX(e,t){var n=Kr[t],i=n.size/n.count;switch(n.type){case si.UNORM:switch(i){case 1:return function(t){return e.getUint8(t)};case 2:return function(t){return e.getUint16(t,CX)};case 4:return function(t){return e.getUint32(t,CX)}}break;case si.SNORM:case si.INT:switch(i){case 1:return function(t){return e.getInt8(t)};case 2:return function(t){return e.getInt16(t,CX)};case 4:return function(t){return e.getInt32(t,CX)}}break;case si.UINT:switch(i){case 1:return function(t){return e.getUint8(t)};case 2:return function(t){return e.getUint16(t,CX)};case 4:return function(t){return e.getUint32(t,CX)}}break;case si.FLOAT:return function(t){return e.getFloat32(t,CX)}}return null}function wX(e,t){var n=Kr[t],i=n.size/n.count;switch(n.type){case si.UNORM:switch(i){case 1:return function(t,n){return e.setUint8(t,n)};case 2:return function(t,n){return e.setUint16(t,n,CX)};case 4:return function(t,n){return e.setUint32(t,n,CX)}}break;case si.SNORM:case si.INT:switch(i){case 1:return function(t,n){return e.setInt8(t,n)};case 2:return function(t,n){return e.setInt16(t,n,CX)};case 4:return function(t,n){return e.setInt32(t,n,CX)}}break;case si.UINT:switch(i){case 1:return function(t,n){return e.setUint8(t,n)};case 2:return function(t,n){return e.setUint16(t,n,CX)};case 4:return function(t,n){return e.setUint32(t,n,CX)}}break;case si.FLOAT:return function(t,n){return e.setFloat32(t,n,CX)}}return null}var IX=[new br(qi.ATTR_POSITION,ai.RGB32F),new br(qi.ATTR_NORMAL,ai.RGB32F),new br(qi.ATTR_TEX_COORD,ai.RG32F),new br(qi.ATTR_TANGENT,ai.RGBA32F),new br(qi.ATTR_COLOR,ai.RGBA32F)],PX=new yn;function RX(e,t,n){n=n||{};var i,r=[],o=0,a=[],s=0,c=e.positions.slice();if(c.length>0){if(i=null,e.attributes)for(var l,u=S(e.attributes);!(l=u()).done;){var h=l.value;if(h.name===qi.ATTR_POSITION){i=h;break}}i||(i=IX[0]),r.push(i);var _=Kr[i.format];s=Math.max(s,Math.floor(c.length/_.count)),a.push({offset:o,data:c,attribute:i}),o+=_.size}if(e.normals&&e.normals.length>0){if(i=null,e.attributes)for(var f,d=S(e.attributes);!(f=d()).done;){var p=f.value;if(p.name===qi.ATTR_NORMAL){i=p;break}}i||(i=IX[1]);var m=Kr[i.format];r.push(i),s=Math.max(s,Math.floor(e.normals.length/m.count)),a.push({offset:o,data:e.normals,attribute:i}),o+=m.size}if(e.uvs&&e.uvs.length>0){if(i=null,e.attributes)for(var v,g=S(e.attributes);!(v=g()).done;){var y=v.value;if(y.name===qi.ATTR_TEX_COORD){i=y;break}}i||(i=IX[2]);var x=Kr[i.format];r.push(i),s=Math.max(s,Math.floor(e.uvs.length/x.count)),a.push({offset:o,data:e.uvs,attribute:i}),o+=x.size}if(e.tangents&&e.tangents.length>0){if(i=null,e.attributes)for(var E,T=S(e.attributes);!(E=T()).done;){var C=E.value;if(C.name===qi.ATTR_TANGENT){i=C;break}}i||(i=IX[3]);var b=Kr[i.format];r.push(i),s=Math.max(s,Math.floor(e.tangents.length/b.count)),a.push({offset:o,data:e.tangents,attribute:i}),o+=b.size}if(e.colors&&e.colors.length>0){if(i=null,e.attributes)for(var A,w=S(e.attributes);!(A=w()).done;){var I=A.value;if(I.name===qi.ATTR_COLOR){i=I;break}}i||(i=IX[4]);var P=Kr[i.format];r.push(i),s=Math.max(s,Math.floor(e.colors.length/P.count)),a.push({offset:o,data:e.colors,attribute:i}),o+=P.size}if(e.customAttributes)for(var R,D=S(e.customAttributes);!(R=D()).done;){var O=R.value,N=Kr[O.attr.format];r.push(O.attr),s=Math.max(s,Math.floor(O.values.length/N.count)),a.push({offset:o,data:O.values,attribute:O.attr}),o+=N.size}for(var M=new uX,L=new ArrayBuffer(s*o),F=new DataView(L),B=0,z=a;B<z.length;B++){var U=z[B];BA(F,U.data,U.attribute.format,U.offset,o)}M.setNextAlignment(0);var k={attributes:r,view:{offset:M.getLength(),length:L.byteLength,count:s,stride:o}};M.addBuffer(L);var G=null,H=0;if(e.indices){var V=e.indices;H=V.length,G=new ArrayBuffer(2*H),BA(new DataView(G),V,ai.R16UI)}var W={primitiveMode:e.primitiveMode||Oi.TRIANGLE_LIST,vertexBundelIndices:[0]};G&&(M.setNextAlignment(2),W.indexView={offset:M.getLength(),length:G.byteLength,count:H,stride:2},M.addBuffer(G));var j=e.minPos;if(!j&&n.calculateBounds){j=yn.set(new yn,1/0,1/0,1/0);for(var q=0;q<s;++q)yn.set(PX,c[3*q+0],c[3*q+1],c[3*q+2]),yn.min(j,j,PX)}var X=e.maxPos;if(!X&&n.calculateBounds){X=yn.set(new yn,-1/0,-1/0,-1/0);for(var Y=0;Y<s;++Y)yn.set(PX,c[3*Y+0],c[3*Y+1],c[3*Y+2]),yn.max(X,X,PX)}var K={vertexBundles:[k],primitives:[W]};return j&&(K.minPosition=new yn(j.x,j.y,j.z)),X&&(K.maxPosition=new yn(X.x,X.y,X.z)),t||(t=new EX),t.reset({struct:K,data:new Uint8Array(M.getCombined())}),t}var DX=Object.freeze({__proto__:null,find:YP,toPPM:function(e,t,n){return"P3 "+t+" "+n+" 255\n"+e.filter((function(e,t){return t%4<3})).toString()+"\n"},readMesh:function(e,t){void 0===t&&(t=0);for(var n,i={positions:[]},r=new DataView(e.data.buffer,e.data.byteOffset,e.data.byteLength),o=e.struct,a=o.primitives[t],s=S(a.vertexBundelIndices);!(n=s()).done;)for(var c,l=n.value,u=o.vertexBundles[l],h=u.view.offset,_=u.view,f=_.length,d=_.stride,p=S(u.attributes);!(c=p()).done;){var m=c.value,v=Kq[m.name];v&&(i[v]=(i[v]||[]).concat(zA(r,m.format,h,f,d))),h+=Kr[m.format].size}var g=a.indexView;return i.indices=zA(r,ai["R"+8*g.stride+"UI"],g.offset,g.length),i},createMesh:RX,readBuffer:zA,writeBuffer:BA,mapBuffer:UA});e("utils",DX);var OX,NX,MX,LX,FX,BX,zX,UX,kX,GX,HX,VX,WX,jX,qX,XX,YX,KX,QX,JX,ZX,$X,eY,tY,nY,iY,rY,oY,aY,sY,cY,lY,uY,hY,_Y,fY,dY,pY,mY,vY,gY,yY=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._morphRenderingInstance=null,t._usedMaterials=new Set,t}f(t,e);var n=t.prototype;return n.getMacroPatches=function(t){var n=e.prototype.getMacroPatches.call(this,t);if(this._morphRenderingInstance){var i=this._morphRenderingInstance.requiredPatches(t);if(i)return i.concat(null!=n?n:[])}return n},n.initSubModel=function(t,n,i){return e.prototype.initSubModel.call(this,t,n,this._launderMaterial(i))},n.destroy=function(){e.prototype.destroy.call(this),this._morphRenderingInstance=null},n.setSubModelMaterial=function(t,n){return e.prototype.setSubModelMaterial.call(this,t,this._launderMaterial(n))},n.setMorphRendering=function(e){this._morphRenderingInstance=e},n._updateLocalDescriptors=function(t,n){e.prototype._updateLocalDescriptors.call(this,t,n),this._morphRenderingInstance&&this._morphRenderingInstance.adaptPipelineState(t,n)},n._launderMaterial=function(e){return e},t}(Ug),xY=Je({OFF:0,ON:1}),SY=Je({OFF:0,ON:1}),EY=(OX=dc("cc.ModelLightmapSettings"),NX=Tc("_recieveShadow"),OX((HX=function(){function e(){E(this,"texture",FX,this),E(this,"uvParam",BX,this),E(this,"_bakeable",zX,this),E(this,"_castShadow",UX,this),E(this,"_receiveShadow",kX,this),E(this,"_lightmapSize",GX,this)}return h(e,[{key:"bakeable",get:function(){return this._bakeable},set:function(e){this._bakeable=e}},{key:"castShadow",get:function(){return this._castShadow},set:function(e){this._castShadow=e}},{key:"receiveShadow",get:function(){return this._receiveShadow},set:function(e){this._receiveShadow=e}},{key:"lightmapSize",get:function(){return this._lightmapSize},set:function(e){this._lightmapSize=e}}]),e}(),FX=T((LX=HX).prototype,"texture",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),BX=T(LX.prototype,"uvParam",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new wn}}),zX=T(LX.prototype,"_bakeable",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),UX=T(LX.prototype,"_castShadow",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),kX=T(LX.prototype,"_receiveShadow",[NX],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),GX=T(LX.prototype,"_lightmapSize",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 64}}),T(LX.prototype,"bakeable",[Nc],Object.getOwnPropertyDescriptor(LX.prototype,"bakeable"),LX.prototype),T(LX.prototype,"castShadow",[Nc],Object.getOwnPropertyDescriptor(LX.prototype,"castShadow"),LX.prototype),T(LX.prototype,"receiveShadow",[Nc],Object.getOwnPropertyDescriptor(LX.prototype,"receiveShadow"),LX.prototype),T(LX.prototype,"lightmapSize",[Nc],Object.getOwnPropertyDescriptor(LX.prototype,"lightmapSize"),LX.prototype),MX=LX))||MX),TY=e("MeshRenderer",(VX=dc("cc.MeshRenderer"),WX=Oc(),jX=mc(100),qX=Ic(),XX=Jc(bt),YX=Bc(),KX=gc({group:{name:"DynamicShadowSettings",displayOrder:0}}),QX=Jc(bt),JX=Bc(),ZX=gc({group:{name:"DynamicShadowSettings",displayOrder:1}}),$X=Jc(xY),eY=Bc(),tY=gc({group:{name:"DynamicShadowSettings",displayOrder:2}}),nY=Jc(SY),iY=Bc(),rY=gc({group:{name:"DynamicShadowSettings",displayOrder:3}}),oY=Jc(EX),aY=Bc(),sY=Mc(),VX(cY=WX(cY=jX(cY=qX(cY=wc((gY=vY=function(e){function t(){var t;return E(t=e.call(this)||this,"lightmapSettings",uY,y(t)),E(t,"_mesh",hY,y(t)),E(t,"_shadowCastingMode",_Y,y(t)),E(t,"_shadowReceivingMode",fY,y(t)),E(t,"_shadowBias",dY,y(t)),E(t,"_shadowNormalBias",pY,y(t)),t._subMeshShapesWeights=[],t._modelType=void 0,t._model=null,t._morphInstance=null,E(t,"_enableMorph",mY,y(t)),t._modelType=Ug,t}f(t,e);var n=t.prototype;return n.onLoad=function(){this._mesh&&this._mesh.initialize(),this._validateShapeWeights()||this._initSubMeshShapesWeights(),this._watchMorphInMesh(),this._updateModels(),this._updateCastShadow(),this._updateReceiveShadow(),this._updateShadowBias(),this._updateShadowNormalBias()},n.onRestore=function(){this._updateModels(),this.enabledInHierarchy&&this._attachToScene(),this._updateCastShadow(),this._updateReceiveShadow(),this._updateShadowBias(),this._updateShadowNormalBias()},n.onEnable=function(){this._model||this._updateModels(),this._updateCastShadow(),this._updateReceiveShadow(),this._updateShadowBias(),this._updateShadowNormalBias(),this._onUpdateLocalShadowBias(),this._attachToScene()},n.onDisable=function(){this._model&&this._detachFromScene()},n.onDestroy=function(){this._model&&(b.director.root.destroyModel(this._model),this._model=null,this._models.length=0),this._morphInstance&&this._morphInstance.destroy()},n.getWeight=function(e,t){this._subMeshShapesWeights.length;var n=this._subMeshShapesWeights[e];return n.length,n[t]},n.setWeights=function(e,t){var n=this._subMeshShapesWeights;t>=n.length||n[t].length===e.length&&(n[t]=e.slice(0),this._uploadSubMeshShapesWeights(t))},n.setWeight=function(e,t,n){var i=this._subMeshShapesWeights;if(!(t>=i.length)){var r=i[t];n>=r.length||(r[n]=e,this._uploadSubMeshShapesWeights(t))}},n.setInstancedAttribute=function(e,t){if(this.model)for(var n=this.model.instancedAttributes,i=n.attributes,r=n.views,o=0;o<i.length;o++)if(i[o].name===e){r[o].set(t);break}},n._updateLightmap=function(e,t,n,i,r){this.lightmapSettings.texture=e,this.lightmapSettings.uvParam.x=t,this.lightmapSettings.uvParam.y=n,this.lightmapSettings.uvParam.z=i,this.lightmapSettings.uvParam.w=r,this._onUpdateLightingmap()},n._updateModels=function(){if(this.enabledInHierarchy){var e=this._model;e?(e.destroy(),e.initialize(),e.node=e.transform=this.node):this._createModel(),this._model&&(this._mesh&&this._model.createBoundingShape(this._mesh.struct.minPosition,this._mesh.struct.maxPosition),this._updateModelParams(),this._onUpdateLightingmap(),this._onUpdateLocalShadowBias())}},n._createModel=function(){var e=this._morphInstance&&this._modelType===Ug?yY:this._modelType,t=this._model=b.director.root.createModel(e);t.visFlags=this.visibility,t.node=t.transform=this.node,this._models.length=0,this._models.push(this._model),this._morphInstance&&t instanceof yY&&t.setMorphRendering(this._morphInstance)},n._attachToScene=function(){if(this.node.scene&&this._model){var e=this._getRenderScene();null!==this._model.scene&&this._detachFromScene(),e.addModel(this._model)}},n._detachFromScene=function(){this._model&&this._model.scene&&this._model.scene.removeModel(this._model)},n._updateModelParams=function(){if(this._mesh&&this._model){this.node.hasChangedFlags|=Zg.POSITION,this._model.transform.hasChangedFlags|=Zg.POSITION,this._model.isDynamicBatching=this._isBatchingEnabled();var e=this._mesh?this._mesh.renderingSubMeshes.length:0,t=this._mesh.renderingSubMeshes;if(t)for(var n=0;n<e;++n){var i=this.getRenderMaterial(n);i&&!i.isValid&&(i=null);var r=t[n];r&&this._model.initSubModel(n,r,i||this._getBuiltinMaterial())}this._model.enabled=!0}},n._onUpdateLightingmap=function(){null!==this.model&&this.model.updateLightingmap(this.lightmapSettings.texture,this.lightmapSettings.uvParam),this.setInstancedAttribute("a_lightingMapUVParam",[this.lightmapSettings.uvParam.x,this.lightmapSettings.uvParam.y,this.lightmapSettings.uvParam.z,this.lightmapSettings.uvParam.w])},n._onUpdateLocalShadowBias=function(){null!==this.model&&this.model.updateLocalShadowBias(),this.setInstancedAttribute("a_localShadowBias",[this._shadowBias,this._shadowNormalBias])},n._onMaterialModified=function(e,t){this._model&&this._model.inited&&this._onRebuildPSO(e,t||this._getBuiltinMaterial())},n._onRebuildPSO=function(e,t){this._model&&this._model.inited&&(this._model.isDynamicBatching=this._isBatchingEnabled(),this._model.setSubModelMaterial(e,t),this._onUpdateLightingmap(),this._onUpdateLocalShadowBias())},n._onMeshChanged=function(){},n._clearMaterials=function(){if(this._model)for(var e=this._model.subModels,t=0;t<e.length;++t)this._onMaterialModified(t,null)},n._getBuiltinMaterial=function(){return nv.get("missing-material")},n._onVisibilityChange=function(e){this._model&&(this._model.visFlags=e)},n._updateShadowBias=function(){this._model&&(this._model.shadowBias=this._shadowBias)},n._updateShadowNormalBias=function(){this._model&&(this._model.shadowNormalBias=this._shadowNormalBias)},n._updateCastShadow=function(){this._model&&(this._shadowCastingMode===xY.OFF?this._model.castShadow=!1:(this._shadowCastingMode,xY.ON,this._shadowCastingMode,this._model.castShadow=!0))},n._updateReceiveShadow=function(){this._model&&(this._shadowReceivingMode===SY.OFF?this._model.receiveShadow=!1:this._model.receiveShadow=!0)},n._isBatchingEnabled=function(){for(var e=0;e<this._materials.length;++e){var t=this._materials[e];if(t)for(var n=0;n<t.passes.length;++n)if(t.passes[n].batchingScheme)return!0}return!1},n._watchMorphInMesh=function(){if(this._morphInstance&&(this._morphInstance.destroy(),this._morphInstance=null),this._enableMorph&&this._mesh&&this._mesh.struct.morph&&this._mesh.morphRendering){this._morphInstance=this._mesh.morphRendering.createInstance();for(var e=this._mesh.struct.primitives.length,t=0;t<e;++t)this._uploadSubMeshShapesWeights(t);this._model&&this._model instanceof yY&&this._model.setMorphRendering(this._morphInstance)}},n._initSubMeshShapesWeights=function(){var e=this._mesh;if(this._subMeshShapesWeights.length=0,e){var t=e.struct.morph;if(t){var n=t.weights;this._subMeshShapesWeights=t.subMeshMorphs.map((function(e){return e?e.weights?e.weights.slice(0):n?(n.length,e.targets.length,n.slice(0)):new Array(e.targets.length).fill(0):[]}))}}},n._validateShapeWeights=function(){var e=this._mesh,t=this._subMeshShapesWeights;if(!e||!e.struct.morph)return 0===t.length;var n=e.struct.morph;return n.subMeshMorphs.length===t.length&&t.every((function(e,t){var i,r,o=e.length;return(null!==(i=null===(r=n.subMeshMorphs[t])||void 0===r?void 0:r.targets.length)&&void 0!==i?i:0)===o}))},n._uploadSubMeshShapesWeights=function(e){var t;null===(t=this._morphInstance)||void 0===t||t.setWeights(e,this._subMeshShapesWeights[e])},h(t,[{key:"shadowBias",get:function(){return this._shadowBias},set:function(e){this._shadowBias=e,this._updateShadowBias(),this._onUpdateLocalShadowBias()}},{key:"shadowNormalBias",get:function(){return this._shadowNormalBias},set:function(e){this._shadowNormalBias=e,this._updateShadowNormalBias(),this._onUpdateLocalShadowBias()}},{key:"shadowCastingMode",get:function(){return this._shadowCastingMode},set:function(e){this._shadowCastingMode=e,this._updateCastShadow()}},{key:"receiveShadow",get:function(){return this._shadowReceivingMode},set:function(e){this._shadowReceivingMode=e,this._updateReceiveShadow()}},{key:"mesh",get:function(){return this._mesh},set:function(e){var t=this._mesh,n=this._mesh=e;null==n||n.initialize(),this._initSubMeshShapesWeights(),this._watchMorphInMesh(),this._onMeshChanged(t),this._updateModels(),this.enabledInHierarchy&&this._attachToScene(),this._updateCastShadow(),this._updateReceiveShadow()}},{key:"model",get:function(){return this._model}},{key:"enableMorph",get:function(){return this._enableMorph},set:function(e){this._enableMorph=e}}]),t}(jL),vY.ShadowCastingMode=xY,vY.ShadowReceivingMode=SY,uY=T((lY=gY).prototype,"lightmapSettings",[Ec,Nc,qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new EY}}),hY=T(lY.prototype,"_mesh",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),_Y=T(lY.prototype,"_shadowCastingMode",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return xY.OFF}}),fY=T(lY.prototype,"_shadowReceivingMode",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return SY.ON}}),dY=T(lY.prototype,"_shadowBias",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),pY=T(lY.prototype,"_shadowNormalBias",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),T(lY.prototype,"shadowBias",[XX,YX,KX,qc],Object.getOwnPropertyDescriptor(lY.prototype,"shadowBias"),lY.prototype),T(lY.prototype,"shadowNormalBias",[QX,JX,ZX,qc],Object.getOwnPropertyDescriptor(lY.prototype,"shadowNormalBias"),lY.prototype),T(lY.prototype,"shadowCastingMode",[$X,eY,tY,qc],Object.getOwnPropertyDescriptor(lY.prototype,"shadowCastingMode"),lY.prototype),T(lY.prototype,"receiveShadow",[nY,iY,rY,qc],Object.getOwnPropertyDescriptor(lY.prototype,"receiveShadow"),lY.prototype),T(lY.prototype,"mesh",[oY,aY],Object.getOwnPropertyDescriptor(lY.prototype,"mesh"),lY.prototype),T(lY.prototype,"enableMorph",[sY,qc],Object.getOwnPropertyDescriptor(lY.prototype,"enableMorph"),lY.prototype),mY=T(lY.prototype,"_enableMorph",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),cY=lY))||cY)||cY)||cY)||cY)||cY));function CY(e,t){var n=e.sharedMaterials.length;if(n!==t.sharedMaterials.length)return!1;for(var i=0;i<n;i++)if(e.getRenderMaterial(i)!==t.getRenderMaterial(i))return!1;return!0}e("BatchingUtility",function(){function e(){}return e.batchStaticModel=function(e,t){var n=e.getComponentsInChildren(TY);if(n.length<2)return console.error("the number of static models to batch is less than 2,it needn't batch."),!1;for(var i=1;i<n.length;i++){if(!n[0].mesh.validateMergingMesh(n[i].mesh))return console.error("the meshes of "+n[0].node.name+" and "+n[i].node.name+" can't be merged"),!1;if(!CY(n[0],n[i]))return console.error("the materials of "+n[0].node.name+" and "+n[i].node.name+" can't be merged"),!1}var r=new EX,o=new kn,a=new kn;e.getWorldMatrix(a),kn.invert(a,a);for(var s=0;s<n.length;s++){var c=n[s];c.node.getWorldMatrix(o),kn.multiply(o,a,o),r.merge(n[s].mesh,o),c.enabled=!1}var l=t.addComponent(TY);return l.mesh=r,l.sharedMaterials=n[0].sharedMaterials,!0},e.unbatchStaticModel=function(e,t){for(var n=e.getComponentsInChildren(TY),i=0;i<n.length;i++)n[i].enabled=!0;var r=t.getComponent(TY);return r&&(r.mesh&&r.mesh.destroyRenderingMesh(),r.destroy()),!0},e}());var bY,AY,wY,IY,PY,RY,DY,OY,NY,MY,LY,FY,BY,zY,UY,kY,GY,HY,VY,WY,jY,qY,XY,YY,KY,QY,JY,ZY,$Y,eK,tK,nK=e("Skeleton",(bY=dc("cc.Skeleton"),AY=Jc([wt]),wY=Jc([kn]),bY((NY=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return E(t=e.call.apply(e,[this].concat(i))||this,"_joints",RY,y(t)),E(t,"_bindposes",DY,y(t)),E(t,"_hash",OY,y(t)),t._invBindposes=null,t}f(t,e);var n=t.prototype;return n.destroy=function(){var t,n;return null===(t=null===(n=b.director.root)||void 0===n?void 0:n.dataPoolManager)||void 0===t||t.releaseSkeleton(this),e.prototype.destroy.call(this)},n.validate=function(){return this.joints.length>0&&this.bindposes.length>0},h(t,[{key:"joints",get:function(){return this._joints},set:function(e){this._joints=e}},{key:"bindposes",get:function(){return this._bindposes},set:function(e){this._bindposes=e}},{key:"inverseBindposes",get:function(){if(!this._invBindposes){this._invBindposes=[];for(var e=0;e<this._bindposes.length;e++){var t=new kn;kn.invert(t,this._bindposes[e]),this._invBindposes.push(t)}}return this._invBindposes}},{key:"hash",get:function(){if(!this._hash){for(var e="",t=0;t<this._bindposes.length;t++){var n=this._bindposes[t];e+=n.m00.toPrecision(2)+" "+n.m01.toPrecision(2)+" "+n.m02.toPrecision(2)+" "+n.m03.toPrecision(2)+" "+n.m04.toPrecision(2)+" "+n.m05.toPrecision(2)+" "+n.m06.toPrecision(2)+" "+n.m07.toPrecision(2)+" "+n.m08.toPrecision(2)+" "+n.m09.toPrecision(2)+" "+n.m10.toPrecision(2)+" "+n.m11.toPrecision(2)+" "+n.m12.toPrecision(2)+" "+n.m13.toPrecision(2)+" "+n.m14.toPrecision(2)+" "+n.m15.toPrecision(2)+"\n"}this._hash=po(e,666)}return this._hash}}]),t}(yu),RY=T((PY=NY).prototype,"_joints",[AY],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),DY=T(PY.prototype,"_bindposes",[wY],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),OY=T(PY.prototype,"_hash",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),IY=PY))||IY));b.Skeleton=nK;var iK,rK,oK,aK,sK,cK,lK,uK,hK,_K,fK,dK,pK,mK,vK,gK,yK,xK,SK,EK,TK,CK,bK,AK,wK,IK,PK,RK,DK,OK,NK,MK,LK,FK,BK,zK,UK,kK,GK,HK,VK,WK,jK,qK,XK,YK,KK,QK,JK,ZK,$K,eQ,tQ,nQ,iQ,rQ,oQ,aQ,sQ,cQ,lQ,uQ,hQ,_Q,fQ,dQ,pQ,mQ,vQ,gQ,yQ,xQ,SQ,EQ,TQ,CQ,bQ,AQ,wQ,IQ,PQ,RQ,DQ,OQ,NQ,MQ,LQ,FQ,BQ,zQ,UQ,kQ,GQ,HQ,VQ,WQ,jQ,qQ,XQ,YQ,KQ,QQ,JQ,ZQ,$Q,eJ,tJ,nJ,iJ,rJ,oJ,aJ,sJ,cJ,lJ,uJ,hJ,_J,fJ,dJ,pJ=new yn,mJ=Je({LUMINOUS_FLUX:0,LUMINANCE:1}),vJ=dc("cc.StaticLightSettings")((kY=function(){function e(){E(this,"_baked",FY,this),E(this,"_editorOnly",BY,this),E(this,"_bakeable",zY,this),E(this,"_castShadow",UY,this)}return h(e,[{key:"editorOnly",get:function(){return this._editorOnly},set:function(e){this._editorOnly=e}},{key:"baked",get:function(){return this._baked},set:function(e){this._baked=e}},{key:"bakeable",get:function(){return this._bakeable},set:function(e){this._bakeable=e}},{key:"castShadow",get:function(){return this._castShadow},set:function(e){this._castShadow=e}}]),e}(),FY=T((LY=kY).prototype,"_baked",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),BY=T(LY.prototype,"_editorOnly",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),zY=T(LY.prototype,"_bakeable",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),UY=T(LY.prototype,"_castShadow",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),T(LY.prototype,"editorOnly",[Nc],Object.getOwnPropertyDescriptor(LY.prototype,"editorOnly"),LY.prototype),T(LY.prototype,"bakeable",[Nc],Object.getOwnPropertyDescriptor(LY.prototype,"bakeable"),LY.prototype),T(LY.prototype,"castShadow",[Nc],Object.getOwnPropertyDescriptor(LY.prototype,"castShadow"),LY.prototype),MY=LY))||MY,gJ=e("Light",(GY=dc("cc.Light"),HY=Bc(),VY=Bc(),WY=zc(),jY=Bc(),qY=Jc(vJ),XY=Vc(),GY((tK=eK=function(e){function t(){var t;return E(t=e.call(this)||this,"_color",QY,y(t)),E(t,"_useColorTemperature",JY,y(t)),E(t,"_colorTemperature",ZY,y(t)),E(t,"_staticSettings",$Y,y(t)),t._type=$g.UNKNOWN,t._lightType=void 0,t._light=null,t._lightType=oy,t}f(t,e);var n=t.prototype;return n.onLoad=function(){this._createLight()},n.onEnable=function(){this._attachToScene()},n.onDisable=function(){this._detachFromScene()},n.onDestroy=function(){this._destroyLight()},n._createLight=function(){this._light||(this._light=b.director.root.createLight(this._lightType)),this.color=this._color,this.useColorTemperature=this._useColorTemperature,this.colorTemperature=this._colorTemperature,this._light.node=this.node,this._light.baked=this.baked},n._destroyLight=function(){this._light&&(b.director.root.destroyLight(this._light),this._light=null)},n._attachToScene=function(){if(this._detachFromScene(),this._light&&!this._light.scene&&this.node.scene){var e=this._getRenderScene();switch(this._type){case $g.DIRECTIONAL:e.addDirectionalLight(this._light),e.setMainLight(this._light);break;case $g.SPHERE:e.addSphereLight(this._light);break;case $g.SPOT:e.addSpotLight(this._light)}}},n._detachFromScene=function(){if(this._light&&this._light.scene){var e=this._light.scene;switch(this._type){case $g.DIRECTIONAL:e.removeDirectionalLight(this._light),e.unsetMainLight(this._light);break;case $g.SPHERE:e.removeSphereLight(this._light);break;case $g.SPOT:e.removeSpotLight(this._light)}}},h(t,[{key:"color",get:function(){return this._color},set:function(e){this._color=e,this._light&&(pJ.x=e.r/255,pJ.y=e.g/255,pJ.z=e.b/255,this._light.color=pJ)}},{key:"useColorTemperature",get:function(){return this._useColorTemperature},set:function(e){this._useColorTemperature=e,this._light&&(this._light.useColorTemperature=e)}},{key:"colorTemperature",get:function(){return this._colorTemperature},set:function(e){this._colorTemperature=e,this._light&&(this._light.colorTemperature=e)}},{key:"staticSettings",get:function(){return this._staticSettings},set:function(e){this._staticSettings=e}},{key:"type",get:function(){return this._type}},{key:"baked",get:function(){return this.staticSettings.baked},set:function(e){this.staticSettings.baked=e,null!==this._light&&(this._light.baked=e)}}]),t}(ku),eK.Type=$g,eK.PhotometricTerm=mJ,QY=T((KY=tK).prototype,"_color",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Qn.WHITE.clone()}}),JY=T(KY.prototype,"_useColorTemperature",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),ZY=T(KY.prototype,"_colorTemperature",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 6550}}),$Y=T(KY.prototype,"_staticSettings",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new vJ}}),T(KY.prototype,"color",[HY],Object.getOwnPropertyDescriptor(KY.prototype,"color"),KY.prototype),T(KY.prototype,"useColorTemperature",[VY],Object.getOwnPropertyDescriptor(KY.prototype,"useColorTemperature"),KY.prototype),T(KY.prototype,"colorTemperature",[Hc,WY,jY],Object.getOwnPropertyDescriptor(KY.prototype,"colorTemperature"),KY.prototype),T(KY.prototype,"staticSettings",[qY,XY],Object.getOwnPropertyDescriptor(KY.prototype,"staticSettings"),KY.prototype),YY=KY))||YY)),yJ=(e("DirectionalLight",(iK=dc("cc.DirectionalLight"),rK=Oc(),oK=Ic(),aK=Tc("_illuminance"),sK=Bc(),cK=Mc(),lK=gc({group:{name:"DynamicShadowSettings",displayOrder:1}}),uK=Jc(At),hK=Mc(),_K=gc({group:{name:"DynamicShadowSettings",displayOrder:5}}),fK=Jc(Wv),dK=Mc(),pK=gc({group:{name:"DynamicShadowSettings",displayOrder:6}}),mK=Jc(bt),vK=Mc(),gK=gc({group:{name:"DynamicShadowSettings",displayOrder:7}}),yK=Jc(bt),xK=Mc(),SK=gc({group:{name:"DynamicShadowSettings",displayOrder:8}}),EK=zc(),TK=Jc(bt),CK=Mc(),bK=gc({group:{name:"DynamicShadowSettings",displayOrder:9}}),AK=Bc(),wK=zc(),IK=Jc(bt),PK=Mc(),RK=gc({group:{name:"DynamicShadowSettings",displayOrder:10}}),DK=Bc(),OK=zc(),NK=Jc(bt),MK=Mc(),LK=gc({group:{name:"DynamicShadowSettings",displayOrder:11}}),FK=Jc(At),BK=Mc(),zK=gc({group:{name:"DynamicShadowSettings",displayOrder:12}}),UK=Jc(bt),kK=Mc(),GK=gc({group:{name:"DynamicShadowSettings",displayOrder:13}}),HK=Jc(bt),VK=Mc(),WK=gc({group:{name:"DynamicShadowSettings",displayOrder:14}}),jK=Jc(bt),iK(qK=rK(qK=oK(qK=wc((sQ=function(e){function t(){var t;return E(t=e.call(this)||this,"_illuminanceHDR",YK,y(t)),E(t,"_illuminanceLDR",KK,y(t)),E(t,"_shadowEnabled",QK,y(t)),E(t,"_shadowPcf",JK,y(t)),E(t,"_shadowBias",ZK,y(t)),E(t,"_shadowNormalBias",$K,y(t)),E(t,"_shadowSaturation",eQ,y(t)),E(t,"_shadowDistance",tQ,y(t)),E(t,"_shadowInvisibleOcclusionRange",nQ,y(t)),E(t,"_shadowFixedArea",iQ,y(t)),E(t,"_shadowNear",rQ,y(t)),E(t,"_shadowFar",oQ,y(t)),E(t,"_shadowOrthoSize",aQ,y(t)),t._type=$g.DIRECTIONAL,t._light=null,t._lightType=cy,t}return f(t,e),t.prototype._createLight=function(){e.prototype._createLight.call(this),this._light&&(this._light.illuminanceHDR=this._illuminanceHDR,this._light.illuminanceLDR=this._illuminanceLDR,this._light.shadowEnabled=this._shadowEnabled,this._light.shadowPcf=this._shadowPcf,this._light.shadowBias=this._shadowBias,this._light.shadowNormalBias=this._shadowNormalBias,this._light.shadowSaturation=this._shadowSaturation,this._light.shadowDistance=this._shadowDistance,this._light.shadowInvisibleOcclusionRange=this._shadowInvisibleOcclusionRange,this._light.shadowFixedArea=this._shadowFixedArea,this._light.shadowNear=this._shadowNear,this._light.shadowFar=this._shadowFar,this._light.shadowOrthoSize=this._shadowOrthoSize)},h(t,[{key:"illuminance",get:function(){return b.director.root.pipeline.pipelineSceneData.isHDR?this._illuminanceHDR:this._illuminanceLDR},set:function(e){b.director.root.pipeline.pipelineSceneData.isHDR?(this._illuminanceHDR=e,this._light&&(this._light.illuminanceHDR=this._illuminanceHDR)):(this._illuminanceLDR=e,this._light&&(this._light.illuminanceLDR=this._illuminanceLDR))}},{key:"shadowEnabled",get:function(){return this._shadowEnabled},set:function(e){this._shadowEnabled=e,this._light&&(this._light.shadowEnabled=this._shadowEnabled)}},{key:"shadowPcf",get:function(){return this._shadowPcf},set:function(e){this._shadowPcf=e,this._light&&(this._light.shadowPcf=this._shadowPcf)}},{key:"shadowBias",get:function(){return this._shadowBias},set:function(e){this._shadowBias=e,this._light&&(this._light.shadowBias=this._shadowBias)}},{key:"shadowNormalBias",get:function(){return this._shadowNormalBias},set:function(e){this._shadowNormalBias=e,this._light&&(this._light.shadowNormalBias=this._shadowNormalBias)}},{key:"shadowSaturation",get:function(){return this._shadowSaturation},set:function(e){this._shadowSaturation=en(e,0,1),this._light&&(this._light.shadowSaturation=this._shadowSaturation)}},{key:"shadowDistance",get:function(){return this._shadowDistance},set:function(e){this._shadowDistance=Math.min(e,qv.MAX_FAR),this._light&&(this._light.shadowDistance=this._shadowDistance)}},{key:"shadowInvisibleOcclusionRange",get:function(){return this._shadowInvisibleOcclusionRange},set:function(e){this._shadowInvisibleOcclusionRange=Math.min(e,qv.MAX_FAR),this._light&&(this._light.shadowInvisibleOcclusionRange=this._shadowInvisibleOcclusionRange)}},{key:"shadowFixedArea",get:function(){return this._shadowFixedArea},set:function(e){this._shadowFixedArea=e,this._light&&(this._light.shadowFixedArea=this._shadowFixedArea)}},{key:"shadowNear",get:function(){return this._shadowNear},set:function(e){this._shadowNear=e,this._light&&(this._light.shadowNear=this._shadowNear)}},{key:"shadowFar",get:function(){return this._shadowFar},set:function(e){this._shadowFar=Math.min(e,qv.MAX_FAR),this._light&&(this._light.shadowFar=this._shadowFar)}},{key:"shadowOrthoSize",get:function(){return this._shadowOrthoSize},set:function(e){this._shadowOrthoSize=e,this._light&&(this._light.shadowOrthoSize=this._shadowOrthoSize)}}]),t}(gJ),YK=T((XK=sQ).prototype,"_illuminanceHDR",[gc,aK],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 65e3}}),KK=T(XK.prototype,"_illuminanceLDR",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 65e3*Gv.standardExposureValue}}),QK=T(XK.prototype,"_shadowEnabled",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),JK=T(XK.prototype,"_shadowPcf",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Wv.HARD}}),ZK=T(XK.prototype,"_shadowBias",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1e-5}}),$K=T(XK.prototype,"_shadowNormalBias",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),eQ=T(XK.prototype,"_shadowSaturation",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),tQ=T(XK.prototype,"_shadowDistance",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 100}}),nQ=T(XK.prototype,"_shadowInvisibleOcclusionRange",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 200}}),iQ=T(XK.prototype,"_shadowFixedArea",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),rQ=T(XK.prototype,"_shadowNear",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),oQ=T(XK.prototype,"_shadowFar",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 10}}),aQ=T(XK.prototype,"_shadowOrthoSize",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 5}}),T(XK.prototype,"illuminance",[sK],Object.getOwnPropertyDescriptor(XK.prototype,"illuminance"),XK.prototype),T(XK.prototype,"shadowEnabled",[cK,lK,Nc,uK],Object.getOwnPropertyDescriptor(XK.prototype,"shadowEnabled"),XK.prototype),T(XK.prototype,"shadowPcf",[hK,_K,Nc,fK],Object.getOwnPropertyDescriptor(XK.prototype,"shadowPcf"),XK.prototype),T(XK.prototype,"shadowBias",[dK,pK,Nc,mK],Object.getOwnPropertyDescriptor(XK.prototype,"shadowBias"),XK.prototype),T(XK.prototype,"shadowNormalBias",[vK,gK,Nc,yK],Object.getOwnPropertyDescriptor(XK.prototype,"shadowNormalBias"),XK.prototype),T(XK.prototype,"shadowSaturation",[xK,SK,Nc,EK,Hc,TK],Object.getOwnPropertyDescriptor(XK.prototype,"shadowSaturation"),XK.prototype),T(XK.prototype,"shadowDistance",[CK,bK,Nc,AK,wK,Hc,IK],Object.getOwnPropertyDescriptor(XK.prototype,"shadowDistance"),XK.prototype),T(XK.prototype,"shadowInvisibleOcclusionRange",[PK,RK,Nc,DK,OK,Hc,NK],Object.getOwnPropertyDescriptor(XK.prototype,"shadowInvisibleOcclusionRange"),XK.prototype),T(XK.prototype,"shadowFixedArea",[MK,LK,Nc,FK],Object.getOwnPropertyDescriptor(XK.prototype,"shadowFixedArea"),XK.prototype),T(XK.prototype,"shadowNear",[BK,zK,Nc,UK],Object.getOwnPropertyDescriptor(XK.prototype,"shadowNear"),XK.prototype),T(XK.prototype,"shadowFar",[kK,GK,Nc,HK],Object.getOwnPropertyDescriptor(XK.prototype,"shadowFar"),XK.prototype),T(XK.prototype,"shadowOrthoSize",[VK,WK,jK],Object.getOwnPropertyDescriptor(XK.prototype,"shadowOrthoSize"),XK.prototype),qK=XK))||qK)||qK)||qK)||qK)),e("SphereLight",(cQ=dc("cc.SphereLight"),lQ=Oc(),uQ=Ic(),hQ=Tc("_luminance"),_Q=Vc(),fQ=Bc(),dQ=Vc(),pQ=Bc(),mQ=Jc(mJ),vQ=Vc(),gQ=Bc(),yQ=Bc(),xQ=Bc(),cQ(SQ=lQ(SQ=uQ(SQ=wc((IQ=function(e){function t(){var t;return E(t=e.call(this)||this,"_size",TQ,y(t)),E(t,"_luminanceHDR",CQ,y(t)),E(t,"_luminanceLDR",bQ,y(t)),E(t,"_term",AQ,y(t)),E(t,"_range",wQ,y(t)),t._type=$g.SPHERE,t._light=null,t._lightType=ly,t}return f(t,e),t.prototype._createLight=function(){e.prototype._createLight.call(this),this.size=this._size,this.range=this._range,this._light&&(this._light.luminanceHDR=this._luminanceHDR,this._light.luminanceLDR=this._luminanceLDR)},h(t,[{key:"luminousFlux",get:function(){return b.director.root.pipeline.pipelineSceneData.isHDR?this._luminanceHDR*ry(this._size):this._luminanceLDR},set:function(e){var t=0;b.director.root.pipeline.pipelineSceneData.isHDR?(this._luminanceHDR=e/ry(this._size),t=this._luminanceHDR):(this._luminanceLDR=e,t=this._luminanceLDR),this._light&&(this._light.luminance=t)}},{key:"luminance",get:function(){return b.director.root.pipeline.pipelineSceneData.isHDR?this._luminanceHDR:this._luminanceLDR},set:function(e){b.director.root.pipeline.pipelineSceneData.isHDR?(this._luminanceHDR=e,this._light&&(this._light.luminanceHDR=this._luminanceHDR)):(this._luminanceLDR=e,this._light&&(this._light.luminanceLDR=this._luminanceLDR))}},{key:"term",get:function(){return this._term},set:function(e){this._term=e}},{key:"size",get:function(){return this._size},set:function(e){this._size=e,this._light&&(this._light.size=e)}},{key:"range",get:function(){return this._range},set:function(e){this._range=e,this._light&&(this._light.range=e)}}]),t}(gJ),TQ=T((EQ=IQ).prototype,"_size",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.15}}),CQ=T(EQ.prototype,"_luminanceHDR",[Ec,hQ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1700/ry(.15)}}),bQ=T(EQ.prototype,"_luminanceLDR",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1700/ry(.15)*Gv.standardExposureValue*Gv.standardLightMeterScale}}),AQ=T(EQ.prototype,"_term",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return mJ.LUMINOUS_FLUX}}),wQ=T(EQ.prototype,"_range",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),T(EQ.prototype,"luminousFlux",[_Q,fQ],Object.getOwnPropertyDescriptor(EQ.prototype,"luminousFlux"),EQ.prototype),T(EQ.prototype,"luminance",[dQ,pQ],Object.getOwnPropertyDescriptor(EQ.prototype,"luminance"),EQ.prototype),T(EQ.prototype,"term",[mQ,vQ,gQ],Object.getOwnPropertyDescriptor(EQ.prototype,"term"),EQ.prototype),T(EQ.prototype,"size",[yQ],Object.getOwnPropertyDescriptor(EQ.prototype,"size"),EQ.prototype),T(EQ.prototype,"range",[xQ],Object.getOwnPropertyDescriptor(EQ.prototype,"range"),EQ.prototype),SQ=EQ))||SQ)||SQ)||SQ)||SQ)),e("SpotLight",(PQ=dc("cc.SpotLight"),RQ=Oc(),DQ=Ic(),OQ=Tc("_luminance"),NQ=Bc(),MQ=Vc(),LQ=Bc(),FQ=Vc(),BQ=Jc(mJ),zQ=Vc(),UQ=Bc(),kQ=Bc(),GQ=Bc(),HQ=zc(),VQ=Bc(),WQ=Mc(),jQ=gc({group:{name:"DynamicShadowSettings",displayOrder:1}}),qQ=Jc(At),XQ=Mc(),YQ=gc({group:{name:"DynamicShadowSettings",displayOrder:2}}),KQ=Jc(Wv),QQ=Mc(),JQ=gc({group:{name:"DynamicShadowSettings",displayOrder:3}}),ZQ=Jc(bt),$Q=Mc(),eJ=gc({group:{name:"DynamicShadowSettings",displayOrder:4}}),tJ=Jc(bt),PQ(nJ=RQ(nJ=DQ(nJ=wc((dJ=function(e){function t(){var t;return E(t=e.call(this)||this,"_size",rJ,y(t)),E(t,"_luminanceHDR",oJ,y(t)),E(t,"_luminanceLDR",aJ,y(t)),E(t,"_term",sJ,y(t)),E(t,"_range",cJ,y(t)),E(t,"_spotAngle",lJ,y(t)),E(t,"_shadowEnabled",uJ,y(t)),E(t,"_shadowPcf",hJ,y(t)),E(t,"_shadowBias",_J,y(t)),E(t,"_shadowNormalBias",fJ,y(t)),t._type=$g.SPOT,t._light=null,t._lightType=my,t}return f(t,e),t.prototype._createLight=function(){e.prototype._createLight.call(this),this.size=this._size,this.range=this._range,this.spotAngle=this._spotAngle,this._light&&(this._light.luminanceHDR=this._luminanceHDR,this._light.luminanceLDR=this._luminanceLDR,this._light.shadowEnabled=this._shadowEnabled,this._light.shadowPcf=this._shadowPcf,this._light.shadowBias=this._shadowBias,this._light.shadowNormalBias=this._shadowNormalBias)},h(t,[{key:"luminousFlux",get:function(){return b.director.root.pipeline.pipelineSceneData.isHDR?this._luminanceHDR*ry(this._size):this._luminanceLDR},set:function(e){var t=0;b.director.root.pipeline.pipelineSceneData.isHDR?(this._luminanceHDR=e/ry(this._size),t=this._luminanceHDR):(this._luminanceLDR=e,t=this._luminanceLDR),this._light&&(this._light.luminance=t)}},{key:"luminance",get:function(){return b.director.root.pipeline.pipelineSceneData.isHDR?this._luminanceHDR:this._luminanceLDR},set:function(e){b.director.root.pipeline.pipelineSceneData.isHDR?(this._luminanceHDR=e,this._light&&(this._light.luminanceHDR=this._luminanceHDR)):(this._luminanceLDR=e,this._light&&(this._light.luminanceLDR=this._luminanceLDR))}},{key:"term",get:function(){return this._term},set:function(e){this._term=e}},{key:"size",get:function(){return this._size},set:function(e){this._size=e,this._light&&(this._light.size=e)}},{key:"range",get:function(){return this._range},set:function(e){this._range=e,this._light&&(this._light.range=e)}},{key:"spotAngle",get:function(){return this._spotAngle},set:function(e){this._spotAngle=e,this._light&&(this._light.spotAngle=rn(e))}},{key:"shadowEnabled",get:function(){return this._shadowEnabled},set:function(e){this._shadowEnabled=e,this._light&&(this._light.shadowEnabled=e)}},{key:"shadowPcf",get:function(){return this._shadowPcf},set:function(e){this._shadowPcf=e,this._light&&(this._light.shadowPcf=e)}},{key:"shadowBias",get:function(){return this._shadowBias},set:function(e){this._shadowBias=e,this._light&&(this._light.shadowBias=e)}},{key:"shadowNormalBias",get:function(){return this._shadowNormalBias},set:function(e){this._shadowNormalBias=e,this._light&&(this._light.shadowNormalBias=e)}}]),t}(gJ),rJ=T((iJ=dJ).prototype,"_size",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.15}}),oJ=T(iJ.prototype,"_luminanceHDR",[Ec,OQ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1700/ry(.15)}}),aJ=T(iJ.prototype,"_luminanceLDR",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1700/ry(.15)*Gv.standardExposureValue*Gv.standardLightMeterScale}}),sJ=T(iJ.prototype,"_term",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return mJ.LUMINOUS_FLUX}}),cJ=T(iJ.prototype,"_range",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),lJ=T(iJ.prototype,"_spotAngle",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 60}}),uJ=T(iJ.prototype,"_shadowEnabled",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),hJ=T(iJ.prototype,"_shadowPcf",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Wv.HARD}}),_J=T(iJ.prototype,"_shadowBias",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1e-5}}),fJ=T(iJ.prototype,"_shadowNormalBias",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),T(iJ.prototype,"luminousFlux",[NQ,MQ],Object.getOwnPropertyDescriptor(iJ.prototype,"luminousFlux"),iJ.prototype),T(iJ.prototype,"luminance",[LQ,FQ],Object.getOwnPropertyDescriptor(iJ.prototype,"luminance"),iJ.prototype),T(iJ.prototype,"term",[BQ,zQ,UQ],Object.getOwnPropertyDescriptor(iJ.prototype,"term"),iJ.prototype),T(iJ.prototype,"size",[kQ],Object.getOwnPropertyDescriptor(iJ.prototype,"size"),iJ.prototype),T(iJ.prototype,"range",[GQ],Object.getOwnPropertyDescriptor(iJ.prototype,"range"),iJ.prototype),T(iJ.prototype,"spotAngle",[Hc,HQ,VQ],Object.getOwnPropertyDescriptor(iJ.prototype,"spotAngle"),iJ.prototype),T(iJ.prototype,"shadowEnabled",[WQ,jQ,Nc,qQ],Object.getOwnPropertyDescriptor(iJ.prototype,"shadowEnabled"),iJ.prototype),T(iJ.prototype,"shadowPcf",[XQ,YQ,Nc,KQ],Object.getOwnPropertyDescriptor(iJ.prototype,"shadowPcf"),iJ.prototype),T(iJ.prototype,"shadowBias",[QQ,JQ,Nc,ZQ],Object.getOwnPropertyDescriptor(iJ.prototype,"shadowBias"),iJ.prototype),T(iJ.prototype,"shadowNormalBias",[$Q,eJ,Nc,tJ],Object.getOwnPropertyDescriptor(iJ.prototype,"shadowNormalBias"),iJ.prototype),nJ=iJ))||nJ)||nJ)||nJ)||nJ)),Symbol("BakeNodeCurves")),xJ=e("SkelAnimDataHub",function(){function e(){}return e.getOrExtract=function(t){var n=e.pool.get(t);if(!n||n.samples!==t.sample){n&&b.director.root.dataPoolManager.releaseAnimationClip(t);var i=Math.ceil(t.sample*t.duration)+1,r=t.sample;n=t[yJ](0,r,i),e.pool.set(t,n)}return n},e.destroy=function(t){e.pool.delete(t)},e}());xJ.pool=new Map;var SJ=new kn;function EJ(e,t,n){for(kn.identity(n);e!==t;)kn.fromRTS(SJ,e.rotation,e.position,e.scale),kn.multiply(n,SJ,n),e=e.parent;return n}var TJ=new pr(yi.POINT,yi.POINT,yi.NONE,xi.CLAMP,xi.CLAMP,xi.CLAMP),CJ=function(e,t,n){e[t+0]=n.m00,e[t+1]=n.m01,e[t+2]=n.m02,e[t+3]=n.m12,e[t+4]=n.m04,e[t+5]=n.m05,e[t+6]=n.m06,e[t+7]=n.m13,e[t+8]=n.m08,e[t+9]=n.m09,e[t+10]=n.m10,e[t+11]=n.m14};function bJ(e,t){var n=4/Math.sqrt(t);return 12*Math.ceil(Math.max(480*n,e)/12)}new On,new On,new yn,new On,new yn;var AJ=new yn,wJ=new yn,IJ=new yn,PJ=new yn,RJ=new kn,DJ=new kn,OJ=new Us,NJ=Number.MAX_SAFE_INTEGER,MJ=function(){function e(e){this._device=void 0,this._pool=void 0,this._textureBuffers=new Map,this._formatSize=void 0,this._pixelsPerJoint=void 0,this._customPool=void 0,this._chunkIdxMap=new Map,this._device=e;var t=function(e){return e.getFormatFeatures(ai.RGBA32F)&mi.SAMPLED_TEXTURE?ai.RGBA32F:ai.RGBA8}(this._device);this._formatSize=Kr[t].size,this._pixelsPerJoint=48/this._formatSize,this._pool=new Sy(e),this._pool.initialize({format:t,roundUpFn:bJ}),this._customPool=new Sy(e),this._customPool.initialize({format:t,roundUpFn:bJ})}var t=e.prototype;return t.clear=function(){this._pool.destroy(),this._textureBuffers.clear()},t.registerCustomTextureLayouts=function(e){for(var t=0;t<e.length;t++)for(var n=e[t],i=this._customPool.createChunk(n.textureLength),r=0;r<n.contents.length;r++){var o=n.contents[r],a=o.skeleton;this._chunkIdxMap.set(a,i);for(var s=0;s<o.clips.length;s++){var c=o.clips[s];this._chunkIdxMap.set(a^c,i)}}},t.getDefaultPoseTexture=function(e,t,n){var i=0^e.hash,r=this._textureBuffers.get(i)||null;if(r&&r.bounds.has(t.hash))return r.refCount++,r;var o=e.joints,a=e.bindposes,s=null,c=!1,l=o.length;if(r)r.refCount++;else{var u=12*l,h=this._chunkIdxMap.get(i),_=void 0!==h?this._customPool.alloc(u*Float32Array.BYTES_PER_ELEMENT,h):this._pool.alloc(u*Float32Array.BYTES_PER_ELEMENT);if(!_)return r;r={pixelOffset:_.start/this._formatSize,refCount:1,bounds:new Map,skeletonHash:e.hash,clipHash:0,readyToBeDeleted:!1,handle:_},s=new Float32Array(u),c=!0}yn.set(IJ,NJ,NJ,NJ),yn.set(PJ,-NJ,-NJ,-NJ);for(var f=t.getBoneSpaceBounds(e),d=0,p=0;d<l;d++,p+=12){var m=n.getChildByPath(o[d]),v=m?EJ(m,n,RJ):e.inverseBindposes[d],g=f[d];g&&(Us.transform(OJ,g,v),OJ.getBoundary(AJ,wJ),yn.min(IJ,IJ,AJ),yn.max(PJ,PJ,wJ)),c&&(m&&kn.multiply(v,v,a[d]),CJ(s,p,m?v:kn.IDENTITY))}var y=[new Us];return r.bounds.set(t.hash,y),Us.fromPoints(y[0],IJ,PJ),c&&(this._pool.update(r.handle,s.buffer),this._textureBuffers.set(i,r)),r},t.getSequencePoseTexture=function(e,t,n,i){var r=e.hash^t.hash,o=this._textureBuffers.get(r)||null;if(o&&o.bounds.has(n.hash))return o.refCount++,o;var a=e.joints,s=e.bindposes,c=xJ.getOrExtract(t).frames,l=null,u=!1,h=a.length;if(o)o.refCount++;else{var _=12*h*c,f=this._chunkIdxMap.get(r),d=void 0!==f?this._customPool.alloc(_*Float32Array.BYTES_PER_ELEMENT,f):this._pool.alloc(_*Float32Array.BYTES_PER_ELEMENT);if(!d)return null;var p=this._createAnimInfos(e,t,i);o={pixelOffset:d.start/this._formatSize,refCount:1,bounds:new Map,skeletonHash:e.hash,clipHash:t.hash,readyToBeDeleted:!1,handle:d,animInfos:p},l=new Float32Array(_),u=!0}var m=n.getBoneSpaceBounds(e),v=[];o.bounds.set(n.hash,v);for(var g=0;g<c;g++)v.push(new Us(NJ,NJ,NJ,-NJ,-NJ,-NJ));for(var y=0,x=0;y<c;y++){for(var S=v[y],E=0;E<h;E++,x+=12){var T=o.animInfos[E],C=T.curveData,b=T.downstream,A=T.bindposeIdx,w=T.bindposeCorrection,I=void 0,P=!0;C&&b?I=kn.multiply(RJ,C[y],b):C?I=C[y]:b?I=b:(I=e.inverseBindposes[A],P=!1);var R=m[E];if(R){var D=w?kn.multiply(DJ,I,w):I;Us.transform(OJ,R,D),OJ.getBoundary(AJ,wJ),yn.min(S.center,S.center,AJ),yn.max(S.halfExtents,S.halfExtents,wJ)}u&&(P&&kn.multiply(RJ,I,s[A]),CJ(l,x,P?RJ:kn.IDENTITY))}Us.fromPoints(S,S.center,S.halfExtents)}return u&&(this._pool.update(o.handle,l.buffer),this._textureBuffers.set(r,o)),o},t.releaseHandle=function(e){if(e.refCount>0&&e.refCount--,!e.refCount&&e.readyToBeDeleted){var t=e.skeletonHash^e.clipHash;(void 0!==this._chunkIdxMap.get(t)?this._customPool:this._pool).free(e.handle),this._textureBuffers.get(t)===e&&this._textureBuffers.delete(t)}},t.releaseSkeleton=function(e){for(var t=this._textureBuffers.values(),n=t.next();!n.done;){var i=n.value;i.skeletonHash===e.hash&&(i.readyToBeDeleted=!0,i.refCount?this._textureBuffers.delete(i.skeletonHash^i.clipHash):this.releaseHandle(i)),n=t.next()}},t.releaseAnimationClip=function(e){for(var t=this._textureBuffers.values(),n=t.next();!n.done;){var i=n.value;i.clipHash===e.hash&&(i.readyToBeDeleted=!0,i.refCount?this._textureBuffers.delete(i.skeletonHash^i.clipHash):this.releaseHandle(i)),n=t.next()}},t._createAnimInfos=function(e,t,n){for(var i=[],r=e.joints,o=e.bindposes,a=r.length,s=xJ.getOrExtract(t),c=0;c<a;c++){for(var l=r[c],u=s.joints[l],h=n.getChildByPath(l),_=void 0,f=void 0;!u;){var d=l.lastIndexOf("/");if(l=l.substring(0,d),u=s.joints[l],h?(_||(_=new kn),kn.fromRTS(RJ,h.rotation,h.position,h.scale),kn.multiply(_,RJ,_),h=h.parent):f=l,d<0)break}var p=c,m=void 0;if(void 0!==f&&u){p=c-1;for(var v=0;v<a;v++)if(r[v]===f){p=v,m=new kn,kn.multiply(m,o[v],e.inverseBindposes[c]);break}}i.push({curveData:u&&u.transforms,downstream:_,bindposeIdx:p,bindposeCorrection:m})}return i},h(e,[{key:"pixelsPerJoint",get:function(){return this._pixelsPerJoint}}]),e}(),LJ=function(){function e(e){this._pool=new Map,this._device=void 0,this._device=e}var t=e.prototype;return t.getData=function(e){void 0===e&&(e="-1");var t=this._pool.get(e);if(t)return t;var n=this._device.createBuffer(new cr(li.UNIFORM|li.TRANSFER_DST,_i.HOST|_i.DEVICE,Vd.SIZE,Vd.SIZE)),i=new Float32Array([0,0,0,0]);n.update(i);var r={buffer:n,data:i,dirty:!1,currentClip:null};return this._setAnimInfoDirty(r,!1),this._pool.set(e,r),r},t.destroy=function(e){var t=this._pool.get(e);t&&(t.buffer.destroy(),this._pool.delete(e))},t._setAnimInfoDirty=function(e,t){e.dirty=t},t.switchClip=function(e,t){return e.currentClip=t,e.data[0]=-1,e.buffer.update(e.data),this._setAnimInfoDirty(e,!1),e},t.clear=function(){for(var e,t=S(this._pool.values());!(e=t()).done;)e.value.buffer.destroy();this._pool.clear()},e}(),FJ=[],BJ=new Map;function zJ(e,t){for(var n=0,i=kn.IDENTITY;e;){if(e.stamp===t||e.stamp+1===t&&!e.node.hasChangedFlags){i=e.world,e.stamp=t;break}e.stamp=t,FJ[n++]=e,e=e.parent}for(;n>0;){e=FJ[--n],FJ[n]=null;var r=e.node;kn.fromRTS(e.local,r.rotation,r.position,r.scale),i=kn.multiply(e.world,i,e.local)}return i}function UJ(e,t){for(var n,i=null,r=0;e!==t;){var o=e.uuid;if(BJ.has(o)){i=BJ.get(o);break}i={node:e,local:new kn,world:new kn,stamp:-1,parent:null},BJ.set(o,i),FJ[r++]=i,e=e.parent,i=null}for(;r>0;)n=FJ[--r],FJ[r]=null,n.parent=i,i=n;return i}function kJ(e){for(var t=BJ.get(e.uuid)||null;t;)BJ.delete(t.node.uuid),t=t.parent}var GJ=[{name:"CC_USE_SKINNING",value:!0}];function HJ(e,t,n,i){for(var r=0;r<n.length;r++){for(var o=n[r],a=-1,s=0;s<o.length;s++)if(o[s]===i){a=s;break}a>=0&&(t.push(r),e.push(a))}}var VJ,WJ,jJ,qJ,XJ,YJ,KJ,QJ,JJ,ZJ,$J,eZ,tZ,nZ,iZ,rZ,oZ,aZ,sZ,cZ,lZ,uZ,hZ,_Z,fZ,dZ,pZ,mZ,vZ,gZ,yZ,xZ,SZ,EZ,TZ,CZ,bZ,AZ,wZ,IZ,PZ,RZ,DZ,OZ,NZ,MZ,LZ,FZ,BZ,zZ,UZ,kZ,GZ,HZ=new yn,VZ=new yn,WZ=new yn,jZ=new yn,qZ=new kn,XZ=new Us,YZ=function(e){function t(){var t;return(t=e.call(this)||this)._buffers=[],t._dataArray=[],t._joints=[],t._bufferIndices=null,t.type=Ag.SKINNING,t}f(t,e);var n=t.prototype;return n._init=function(){},n.destroy=function(){if(this.bindSkeleton(),this._buffers.length){for(var t=0;t<this._buffers.length;t++)this._buffers[t].destroy();this._buffers.length=0}e.prototype.destroy.call(this)},n.uploadAnimation=function(){},n.bindSkeleton=function(e,t,n){void 0===e&&(e=null),void 0===t&&(t=null),void 0===n&&(n=null);for(var i=0;i<this._joints.length;i++)kJ(this._joints[i].target);if(this._bufferIndices=null,this._joints.length=0,e&&t&&n){this.transform=t;var r=n.getBoneSpaceBounds(e),o=n.struct.jointMaps;this._ensureEnoughBuffers(o&&o.length||1),this._bufferIndices=n.jointBufferIndices;for(var a=0;a<e.joints.length;a++){var s=r[a],c=t.getChildByPath(e.joints[a]);if(s&&c){var l=UJ(c,t),u=e.bindposes[a],h=[],_=[];o?HJ(h,_,o,a):(h.push(a),_.push(0)),this._joints.push({indices:h,buffers:_,bound:s,target:c,bindpose:u,transform:l})}}}},n.updateTransform=function(e){var t=this.transform;(t.hasChangedFlags||t._dirtyFlags)&&(t.updateWorldTransform(),this._localDataUpdated=!0),yn.set(HZ,1/0,1/0,1/0),yn.set(VZ,-1/0,-1/0,-1/0);for(var n=0;n<this._joints.length;n++){var i=this._joints[n],r=i.bound,o=zJ(i.transform,e);Us.transform(XZ,r,o),XZ.getBoundary(WZ,jZ),yn.min(HZ,HZ,WZ),yn.max(VZ,VZ,jZ)}var a=this._worldBounds;this._modelBounds&&a&&(Us.fromPoints(this._modelBounds,HZ,VZ),this._modelBounds.transform(t._mat,t._pos,t._rot,t._scale,this._worldBounds),this._updateNativeBounds())},n.updateUBOs=function(t){e.prototype.updateUBOs.call(this,t);for(var n=0;n<this._joints.length;n++){var i=this._joints[n],r=i.indices,o=i.buffers,a=i.transform,s=i.bindpose;kn.multiply(qZ,a.world,s);for(var c=0;c<o.length;c++)CJ(this._dataArray[o[c]],12*r[c],qZ)}for(var l=0;l<this._buffers.length;l++)this._buffers[l].update(this._dataArray[l]);return!0},n.initSubModel=function(t,n,i){var r=n.vertexBuffers,o=n.iaInfo;o.vertexBuffers=n.jointMappedBuffers,e.prototype.initSubModel.call(this,t,n,i),o.vertexBuffers=r},n.getMacroPatches=function(t){var n=e.prototype.getMacroPatches.call(this,t);return n?GJ.concat(n):GJ},n._updateLocalDescriptors=function(t,n){e.prototype._updateLocalDescriptors.call(this,t,n);var i=this._buffers[this._bufferIndices[t]];i&&n.bindBuffer(jd.BINDING,i)},n._updateInstancedAttributes=function(t,n){n.batchingScheme!==Zm.NONE&&q(3936,this.node.getPathInHierarchy()),e.prototype._updateInstancedAttributes.call(this,t,n)},n._ensureEnoughBuffers=function(e){for(var t=0;t<e;t++)this._buffers[t]||(this._buffers[t]=this._device.createBuffer(new cr(li.UNIFORM|li.TRANSFER_DST,_i.HOST|_i.DEVICE,jd.SIZE,jd.SIZE))),this._dataArray[t]||(this._dataArray[t]=new Float32Array(jd.COUNT))},t}(yY),KZ=[{name:"CC_USE_SKINNING",value:!0},{name:"CC_USE_BAKED_ANIMATION",value:!0}],QZ=function(e){function t(){var t;(t=e.call(this)||this).uploadedAnim=void 0,t._jointsMedium=void 0,t._skeleton=null,t._mesh=null,t._dataPoolManager=void 0,t._instAnimInfoIdx=-1,t.type=Ag.BAKED_SKINNING,t._dataPoolManager=b.director.root.dataPoolManager;var n=new Float32Array(4),i=t._dataPoolManager.jointAnimationInfo.getData();return t._jointsMedium={buffer:null,jointTextureInfo:n,animInfo:i,texture:null,boundsInfo:null},t}f(t,e);var n=t.prototype;return n._init=function(){},n.destroy=function(){this.uploadedAnim=void 0,this._jointsMedium.boundsInfo=null,this._jointsMedium.buffer&&(this._jointsMedium.buffer.destroy(),this._jointsMedium.buffer=null),this._applyJointTexture(),this._applyNativeJointMedium(),e.prototype.destroy.call(this)},n.bindSkeleton=function(e,t,n){if(void 0===e&&(e=null),void 0===t&&(t=null),void 0===n&&(n=null),this._skeleton=e,this._mesh=n,e&&t&&n){this.transform=t;var i=this._dataPoolManager;this._jointsMedium.animInfo=i.jointAnimationInfo.getData(t.uuid),this._jointsMedium.buffer||(this._jointsMedium.buffer=this._device.createBuffer(new cr(li.UNIFORM|li.TRANSFER_DST,_i.DEVICE,Hd.SIZE,Hd.SIZE)))}},n.updateTransform=function(t){if(e.prototype.updateTransform.call(this,t),this.uploadedAnim){var n=this._jointsMedium,i=n.animInfo,r=n.boundsInfo[i.data[0]],o=this._worldBounds;if(o&&r){var a=this.transform;r.transform(a._mat,a._pos,a._rot,a._scale,o)}}},n.updateUBOs=function(t){e.prototype.updateUBOs.call(this,t);var n=this._jointsMedium.animInfo,i=this._instAnimInfoIdx;return i>=0?this.instancedAttributes.views[i][0]=n.data[0]:n.dirty&&(n.buffer.update(n.data),n.dirty=!1),!0},n.getMacroPatches=function(t){var n=e.prototype.getMacroPatches.call(this,t);return n?n.concat(KZ):KZ},n.uploadAnimation=function(e){if(this._skeleton&&this._mesh&&this.uploadedAnim!==e){this.uploadedAnim=e;var t=this._dataPoolManager,n=null;e?(n=t.jointTexturePool.getSequencePoseTexture(this._skeleton,e,this._mesh,this.transform),this._jointsMedium.boundsInfo=n&&n.bounds.get(this._mesh.hash),this._updateModelBounds(null)):(n=t.jointTexturePool.getDefaultPoseTexture(this._skeleton,this._mesh,this.transform),this._jointsMedium.boundsInfo=null,this._updateModelBounds(n&&n.bounds.get(this._mesh.hash)[0])),this._applyJointTexture(n),this._applyNativeJointMedium()}},n._applyNativeJointMedium=function(){},n._updateModelBounds=function(e){this._modelBounds=e},n._applyJointTexture=function(e){void 0===e&&(e=null);var t=this._jointsMedium.texture;if(t&&t!==e&&this._dataPoolManager.jointTexturePool.releaseHandle(t),this._jointsMedium.texture=e,e){var n=this._jointsMedium,i=n.buffer,r=n.jointTextureInfo;r[0]=e.handle.texture.width,r[1]=this._skeleton.joints.length,r[2]=e.pixelOffset+.1,r[3]=1/r[0],this.updateInstancedJointTextureInfo(),i&&i.update(r);for(var o=e.handle.texture,a=0;a<this._subModels.length;++a)this._subModels[a].descriptorSet.bindTexture(Yd,o)}},n._updateLocalDescriptors=function(t,n){e.prototype._updateLocalDescriptors.call(this,t,n);var i=this._jointsMedium,r=i.buffer,o=i.texture,a=i.animInfo;if(n.bindBuffer(Hd.BINDING,r),n.bindBuffer(Vd.BINDING,a.buffer),o){var s=this._device.getSampler(TJ);n.bindTexture(Yd,o.handle.texture),n.bindSampler(Yd,s)}},n._updateInstancedAttributes=function(t,n){e.prototype._updateInstancedAttributes.call(this,t,n),this._setInstAnimInfoIdx(this._getInstancedAttributeIndex(Wd)),this.updateInstancedJointTextureInfo()},n._setInstAnimInfoIdx=function(e){this._instAnimInfoIdx=e},n.updateInstancedJointTextureInfo=function(){var e=this._jointsMedium,t=e.jointTextureInfo,n=e.animInfo,i=this._instAnimInfoIdx;if(i>=0){var r=this.instancedAttributes.views[i];r[0]=n.data[0],r[1]=t[1],r[2]=t[2]}},t}(yY),JZ=e("SkinnedMeshRenderer",(VJ=dc("cc.SkinnedMeshRenderer"),WJ=Oc(),jJ=mc(100),qJ=Ic(),XJ=Jc(nK),YJ=Jc(jb),KJ=Jc(nK),QJ=Jc(jb),JJ=Bc(),VJ(ZJ=WJ(ZJ=jJ(ZJ=wc(ZJ=qJ((nZ=function(e){function t(){var t;return E(t=e.call(this)||this,"_skeleton",eZ,y(t)),E(t,"_skinningRoot",tZ,y(t)),t._clip=null,t.associatedAnimation=null,t._modelType=QZ,t}f(t,e);var n=t.prototype;return n.onLoad=function(){e.prototype.onLoad.call(this),this._tryBindAnimation()},n.onDestroy=function(){this.associatedAnimation&&(this.associatedAnimation.notifySkinnedMeshRemoved(this),this.associatedAnimation),e.prototype.onDestroy.call(this)},n.uploadAnimation=function(e){this._clip=e,this.model&&this.model.uploadAnimation&&this.model.uploadAnimation(e)},n.setUseBakedAnimation=function(e,t){void 0===e&&(e=!0),void 0===t&&(t=!1);var n=e?QZ:YZ;(t||this._modelType!==n)&&(this._modelType=n,this._model&&(b.director.root.destroyModel(this._model),this._model=null,this._models.length=0,this._updateModels(),this._updateCastShadow(),this._updateReceiveShadow(),this.enabledInHierarchy&&this._attachToScene()))},n.setMaterial=function(t,n){e.prototype.setMaterial.call(this,t,n),this._modelType===YZ&&this.getMaterialInstance(n)},n._updateModelParams=function(){this._update(),e.prototype._updateModelParams.call(this)},n._tryBindAnimation=function(){var e=this._skinningRoot;if(e){for(var t=!1,n=this.node;n;n=n.parent)if(n===e){t=!0;break}if(t){var i=e.getComponent("cc.SkeletalAnimation");i?i.notifySkinnedMeshAdded(this):this.setUseBakedAnimation(!1)}}},n._update=function(){this.model&&(this.model.bindSkeleton(this._skeleton,this._skinningRoot,this._mesh),this.model.uploadAnimation&&this.model.uploadAnimation(this._clip))},h(t,[{key:"skeleton",get:function(){return this._skeleton},set:function(e){e!==this._skeleton&&(this._skeleton=e,this._update())}},{key:"skinningRoot",get:function(){return this._skinningRoot},set:function(e){this._skinningRoot=e,this._tryBindAnimation(),e!==this._skinningRoot&&this._update()}},{key:"model",get:function(){return this._model}}]),t}(TY),eZ=T(($J=nZ).prototype,"_skeleton",[XJ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),tZ=T($J.prototype,"_skinningRoot",[YJ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),T($J.prototype,"skeleton",[KJ],Object.getOwnPropertyDescriptor($J.prototype,"skeleton"),$J.prototype),T($J.prototype,"skinningRoot",[QJ,JJ],Object.getOwnPropertyDescriptor($J.prototype,"skinningRoot"),$J.prototype),ZJ=$J))||ZJ)||ZJ)||ZJ)||ZJ)||ZJ)),ZZ=new br(qi.ATTR_BATCH_ID,ai.R32F),$Z=new br(qi.ATTR_BATCH_UV,ai.RG32F),e$=Kr[ZZ.format].size+Kr[$Z.format].size,t$=e("SkinnedMeshUnit",(iZ=dc("cc.SkinnedMeshUnit"),rZ=Jc(EX),oZ=Jc(nK),aZ=Jc(Ov),sZ=Jc(JZ),iZ((mZ=function(){function e(){E(this,"mesh",uZ,this),E(this,"skeleton",hZ,this),E(this,"material",_Z,this),E(this,"_localTransform",fZ,this),E(this,"_offset",dZ,this),E(this,"_size",pZ,this)}return h(e,[{key:"offset",get:function(){return this._offset},set:function(e){Tn.copy(this._offset,e)}},{key:"size",get:function(){return this._size},set:function(e){Tn.copy(this._size,e)}},{key:"copyFrom",get:function(){return null},set:function(e){e&&(this.mesh=e.mesh,this.skeleton=e.skeleton,this.material=e.getMaterial(0),e.skinningRoot&&EJ(e.node,e.skinningRoot,this._localTransform))}}]),e}(),uZ=T((lZ=mZ).prototype,"mesh",[rZ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),hZ=T(lZ.prototype,"skeleton",[oZ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),_Z=T(lZ.prototype,"material",[aZ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),fZ=T(lZ.prototype,"_localTransform",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new kn}}),dZ=T(lZ.prototype,"_offset",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Tn(0,0)}}),pZ=T(lZ.prototype,"_size",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Tn(1,1)}}),T(lZ.prototype,"offset",[Nc],Object.getOwnPropertyDescriptor(lZ.prototype,"offset"),lZ.prototype),T(lZ.prototype,"size",[Nc],Object.getOwnPropertyDescriptor(lZ.prototype,"size"),lZ.prototype),T(lZ.prototype,"copyFrom",[sZ],Object.getOwnPropertyDescriptor(lZ.prototype,"copyFrom"),lZ.prototype),cZ=lZ))||cZ)),n$=new kn,i$=(new kn,new yn);function r$(e){return"string"==typeof e||"number"==typeof e}e("SkinnedMeshBatchRenderer",(vZ=dc("cc.SkinnedMeshBatchRenderer"),gZ=Oc(),yZ=mc(100),xZ=Ic(),SZ=Bc(),EZ=Jc([wt]),TZ=Bc(),CZ=Jc([t$]),bZ=Bc(),AZ=Mc(),wZ=Mc(),vZ(IZ=gZ(IZ=yZ(IZ=wc(IZ=xZ((NZ=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return E(t=e.call.apply(e,[this].concat(i))||this,"atlasSize",RZ,y(t)),E(t,"batchableTextureNames",DZ,y(t)),E(t,"units",OZ,y(t)),t._textures={},t._batchMaterial=null,t}f(t,e);var n=t.prototype;return n.onLoad=function(){e.prototype.onLoad.call(this),this.cook()},n.onDestroy=function(){for(var t in this._textures)this._textures[t].destroy();this._textures={},this._mesh&&(this._mesh.destroy(),this._mesh=null),e.prototype.onDestroy.call(this)},n._onMaterialModified=function(t){this.cookMaterials(),e.prototype._onMaterialModified.call(this,t,this.getMaterialInstance(t))},n.cook=function(){this.cookMaterials(),this.cookSkeletons(),this.cookMeshes()},n.cookMaterials=function(){var e=this;this._batchMaterial||(this._batchMaterial=this.getMaterial(0));var t=this.getMaterialInstance(0);if(t&&this._batchMaterial&&this._batchMaterial.effectAsset){t.copy(this._batchMaterial),this.resizeAtlases();for(var n=t.effectAsset.techniques[t.technique],i=function(i){var r=n.passes[i];if(!r.properties)return"continue";var o=function(n){if(r.properties[n].type>=ci.SAMPLER1D){var o=null;e.batchableTextureNames.find((function(e){return e===n}))?((o=e._textures[n])||(o=e.createTexture(n)),e.cookTextures(o,n,i)):e.units.some((function(e){return o=e.material&&e.material.getProperty(n,i)})),o&&t.setProperty(n,o,i)}else{for(var a=[],s=0;s<e.units.length;s++){var c=e.units[s];c.material&&a.push(c.material.getProperty(n.slice(0,-3),i))}t.setProperty(n,a,i)}};for(var a in r.properties)o(a)},r=0;r<n.passes.length;r++)i(r)}else console.warn("incomplete batch material!")},n.cookSkeletons=function(){if(this._skinningRoot){for(var e=[],t=[],n=0;n<this.units.length;n++){var i=this.units[n];if(i&&i.skeleton){var r=i.skeleton;kn.invert(n$,i._localTransform);for(var o=function(n){var i=r.joints[n];if(e.findIndex((function(e){return e===i}))>=0)return"continue";e.push(i),t.push(kn.multiply(new kn,r.bindposes[n]||kn.IDENTITY,n$))},a=0;a<r.joints.length;a++)o(a)}}var s=Array.from(Array(e.length).keys()).sort((function(t,n){return e[t]>e[n]?1:e[t]<e[n]?-1:0})),c=new nK;c.joints=e.map((function(e,t,n){return n[s[t]]})),c.bindposes=t.map((function(e,t,n){return n[s[t]]})),this._skeleton&&this._skeleton.destroy(),this.skeleton=c}else console.warn("no skinning root specified!")},n.cookMeshes=function(){for(var e=this,t=!1,n=0;n<this.units.length;n++)if(this.units[n].mesh){t=!0;break}if(t&&this._skinningRoot){this._mesh?this._mesh.destroyRenderingMesh():this._mesh=new EX;for(var i=0,r=ai.UNKNOWN,o=0,a=ai.UNKNOWN,s=0,c=ai.UNKNOWN,l=0,u=ai.UNKNOWN,h=0,_=ai.UNKNOWN,f=new Array(this.units.length),d=this.units.length,p=0;p<d;p++){var m=this.units[p];m&&m.skeleton&&(f[p]=m.skeleton.joints.map((function(t){return e._skeleton.joints.findIndex((function(e){return t===e}))})))}for(var v=function(t){var n=e.units[t];if(!n||!n.mesh||!n.mesh.data)return"continue";var d=e._createUnitMesh(t,n.mesh),p=new DataView(d.data.buffer);kn.inverseTranspose(n$,n._localTransform);for(var m=n.offset,v=n.size,g=function(e){var g=d.struct.vertexBundles[e];i=g.view.offset,r=ai.UNKNOWN;for(var y=0;y<g.attributes.length;y++){var x=g.attributes[y];if(x.name===qi.ATTR_POSITION){r=x.format;break}i+=Kr[x.format].size}if(r){for(var S=zA(p,r,i,g.view.length,g.view.stride),E=0;E<S.length;E+=3)yn.fromArray(i$,S,E),yn.transformMat4(i$,i$,n._localTransform),yn.toArray(S,i$,E);BA(p,S,r,i,g.view.stride)}o=g.view.offset,a=ai.UNKNOWN;for(var T=0;T<g.attributes.length;T++){var C=g.attributes[T];if(C.name===qi.ATTR_NORMAL){a=C.format;break}o+=Kr[C.format].size}if(a){for(var b=zA(p,a,o,g.view.length,g.view.stride),A=0;A<b.length;A+=3)yn.fromArray(i$,b,A),yn.transformMat4Normal(i$,i$,n$),yn.toArray(b,i$,A);BA(p,b,a,o,g.view.stride)}s=g.view.offset,c=ai.UNKNOWN;for(var w=0;w<g.attributes.length;w++){var I=g.attributes[w];if(I.name===qi.ATTR_TANGENT){c=I.format;break}s+=Kr[I.format].size}if(c){for(var P=zA(p,c,s,g.view.length,g.view.stride),R=0;R<P.length;R+=3)yn.fromArray(i$,P,R),yn.transformMat4Normal(i$,i$,n$),yn.toArray(P,i$,R);BA(p,P,c,s,g.view.stride)}l=g.view.offset,u=ai.UNKNOWN;for(var D=0;D<g.attributes.length;D++){var O=g.attributes[D];if(O.name===qi.ATTR_BATCH_UV){u=O.format;break}l+=Kr[O.format].size}u&&UA(p,(function(e,t){var n,i=0===t?"x":"y";return(e=(n=e)-Math.floor(n))*v[i]+m[i]}),u,l,g.view.length,g.view.stride,p);var N=f[t];if(!N)return"continue";h=g.view.offset,_=ai.UNKNOWN;for(var M=0;M<g.attributes.length;M++){var L=g.attributes[M];if(L.name===qi.ATTR_JOINTS){_=L.format;break}h+=Kr[L.format].size}_&&UA(p,(function(e){return N[e]}),_,h,g.view.length,g.view.stride,p)},y=0;y<d.struct.vertexBundles.length;y++)g(y);e._mesh.merge(d)},g=0;g<d;g++)v(g);this._onMeshChanged(this._mesh),this._updateModels()}},n.cookTextures=function(e,t,n){for(var i=[],r=[],o=[],a=[],s=0;s<this.units.length;s++){var c=this.units[s];if(c.material){var l=c.material.getProperty(t,n);if(l&&l.image&&l.image.data){var u=new nr;u.texOffset.x=c.offset.x*this.atlasSize,u.texOffset.y=c.offset.y*this.atlasSize,u.texExtent.width=c.size.x*this.atlasSize,u.texExtent.height=c.size.y*this.atlasSize;var h=l.image.data;ArrayBuffer.isView(h)?(o.push(h),a.push(u)):(i.push(h),r.push(u))}}}var _=e.getGFXTexture(),f=b.director.root.device;o.length>0&&f.copyBuffersToTexture(o,_,a),i.length>0&&f.copyTexImagesToTexture(i,_,r)},n.createTexture=function(e){var t=new Xm;return t.setFilters(im.LINEAR,im.LINEAR),t.setMipFilter(im.NEAREST),t.reset({width:this.atlasSize,height:this.atlasSize,format:tm.RGBA8888}),this._textures[e]=t,t},n.resizeAtlases=function(){for(var e in this._textures)this._textures[e].reset({width:this.atlasSize,height:this.atlasSize,format:tm.RGBA8888})},n._createUnitMesh=function(e,t){for(var n=JSON.parse(JSON.stringify(t.struct)),i={},r=0;r<t.struct.primitives.length;r++){for(var o=t.struct.primitives[r],a=0,s=ai.UNKNOWN,c=0;c<o.vertexBundelIndices.length;c++){var l=t.struct.vertexBundles[o.vertexBundelIndices[c]];a=l.view.offset,s=ai.UNKNOWN;for(var u=0;u<l.attributes.length;u++){var h=l.attributes[u];if(h.name===qi.ATTR_TEX_COORD){s=h.format;break}a+=Kr[h.format].size}if(s)break}if(void 0===i[c]){i[c]=[s,a];var _=n.vertexBundles[c];_.attributes.push(ZZ),_.attributes.push($Z),_.view.offset=0,_.view.length+=_.view.count*e$,_.view.stride+=e$}}for(var f=0,d=0;d<n.vertexBundles.length;d++)f+=n.vertexBundles[d].view.length;for(var p=0;p<n.primitives.length;p++){var m=n.primitives[p];m.indexView&&(m.indexView.offset=f,f+=m.indexView.length)}var v=new Uint8Array(f),g=t.data,y=new DataView(v.buffer),x=new DataView(g.buffer),S=b.sys.isLittleEndian;for(var E in i)for(var T=n.vertexBundles[E],C=t.struct.vertexBundles[E],A=i[E],w=zA(x,A[0],A[1],C.view.length,C.view.stride),I=C.view,P=T.view,R=I.stride,D=P.stride,O=I.offset,N=P.offset,M=0;M<P.count;M++){var L=g.subarray(O,O+R);v.set(L,N),y.setFloat32(N+R,e),y.setFloat32(N+R+4,w[2*M],S),y.setFloat32(N+R+8,w[2*M+1],S),N+=D,O+=R}for(var F=0;F<n.primitives.length;F++){var B=t.struct.primitives[F],z=n.primitives[F];if(B.indexView&&z.indexView)for(var U=B.indexView.stride,k=z.indexView.stride,G=B.indexView.offset,H=z.indexView.offset,V=0;V<z.indexView.count;V++){var W=g.subarray(G,G+U);v.set(W,H),H+=k,G+=U}}var j=new EX;return j.reset({struct:n,data:v}),j},h(t,[{key:"mesh",get:function(){return e.prototype.mesh},set:function(e){this.mesh=e}},{key:"skeleton",get:function(){return e.prototype.skeleton},set:function(e){this.skeleton=e}}]),t}(JZ),RZ=T((PZ=NZ).prototype,"atlasSize",[Ec,SZ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1024}}),DZ=T(PZ.prototype,"batchableTextureNames",[EZ,Ec,TZ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),OZ=T(PZ.prototype,"units",[CZ,Ec,bZ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),T(PZ.prototype,"mesh",[$c,AZ],Object.getOwnPropertyDescriptor(PZ.prototype,"mesh"),PZ.prototype),T(PZ.prototype,"skeleton",[$c,wZ],Object.getOwnPropertyDescriptor(PZ.prototype,"skeleton"),PZ.prototype),IZ=PZ))||IZ)||IZ)||IZ)||IZ)||IZ)),b.utils=DX;var o$,a$,s$,c$,l$,u$,h$,_$,f$,d$,p$,m$,v$,g$,y$,x$,S$,E$,T$,C$,b$,A$,w$=dc("cc.animation.HierarchyPath")((BZ=function(){function e(e){E(this,"path",FZ,this),this.path=e||""}return e.prototype.get=function(e){return e instanceof jb?e.getChildByPath(this.path)||(q(3926,e.name,this.path),null):(q(3925),null)},e}(),FZ=T((LZ=BZ).prototype,"path",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),MZ=LZ))||MZ,I$=dc("cc.animation.ComponentPath")((GZ=function(){function e(e){E(this,"component",kZ,this),this.component=e||""}return e.prototype.get=function(e){return e instanceof jb?e.getComponent(this.component)||(q(3928,e.name,this.component),null):(q(3927),null)},e}(),kZ=T((UZ=GZ).prototype,"component",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),zZ=UZ))||zZ,P$=dc("cc.animation.UniformProxyFactory")((u$=function(){function e(e,t){E(this,"passIndex",s$,this),E(this,"uniformName",c$,this),E(this,"channelIndex",l$,this),this.passIndex=t||0,this.uniformName=e||""}return e.prototype.forTarget=function(e){var t=e.passes[this.passIndex],n=t.getHandle(this.uniformName);if(!n)throw new Error('Material "'+e.name+'" has no uniform "'+this.uniformName+'"');if(lv.getTypeFromHandle(n)<ci.SAMPLER1D){var i=void 0===this.channelIndex?n:t.getHandle(this.uniformName,this.channelIndex,ci.FLOAT);if(!i)throw new Error('Uniform "'+this.uniformName+" (in material "+e.name+") has no channel "+this.channelIndex+'"');return function(e,t){for(var n,i=S(e.shaderInfo.blocks);!(n=i()).done;)for(var r,o=S(n.value.members);!(r=o()).done;){var a=r.value;if(a.name===t)return a.count>1}return!1}(t,this.uniformName)?{set:function(e){t.setUniformArray(i,e)}}:{set:function(e){t.setUniform(i,e)}}}var r=lv.getBindingFromHandle(n),o=t.properties[this.uniformName],a=o&&o.value?o.value+"-texture":Fp(o.type),s=nv.get(a);return s||(F("Illegal texture default value: "+a+"."),s=nv.get("default-texture")),{set:function(e){e||(e=s);var n=e.getGFXTexture();n&&n.width&&n.height&&(t.bindTexture(r,n),e instanceof Em&&t.bindSampler(r,b.game._gfxDevice.getSampler(e.getSamplerInfo())))}}},e}(),s$=T((a$=u$).prototype,"passIndex",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),c$=T(a$.prototype,"uniformName",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),l$=T(a$.prototype,"channelIndex",[Yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){}}),o$=a$))||o$,R$=dc("cc.animation.MorphWeightValueProxy")((p$=function(){function e(){E(this,"subMeshIndex",f$,this),E(this,"shapeIndex",d$,this)}return e.prototype.forTarget=function(e){var t=this;return{set:function(n){e.setWeight(n,t.subMeshIndex,t.shapeIndex)}}},e}(),f$=T((_$=p$).prototype,"subMeshIndex",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),d$=T(_$.prototype,"shapeIndex",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),h$=_$))||h$,D$=dc("cc.animation.MorphWeightsValueProxy")((y$=function(){function e(){E(this,"subMeshIndex",g$,this)}return e.prototype.forTarget=function(e){var t=this;return{set:function(n){e.setWeights(n,t.subMeshIndex)}}},e}(),g$=T((v$=y$).prototype,"subMeshIndex",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),m$=v$))||m$,O$=dc("cc.animation.MorphWeightsAllValueProxy")(x$=function(){function e(){}return e.prototype.forTarget=function(e){return{set:function(t){for(var n,i,r=null!==(n=null===(i=e.mesh)||void 0===i?void 0:i.struct.primitives.length)&&void 0!==n?n:0,o=0;o<r;++o)e.setWeights(t,o)}}},e}())||x$;function N$(e,t,n,i){var r,o,a,s,c,l,u=new t,h=new t,_=new t,f=dc(e)((l=function(){function e(e,n,i){E(this,"dataPoint",a,this),E(this,"inTangent",s,this),E(this,"outTangent",c,this),this.dataPoint=e||new t,this.inTangent=n||new t,this.outTangent=i||new t}var r=e.prototype;return r.lerp=function(e,t,r){var o=this.dataPoint,a=e.dataPoint;h=n(h,this.inTangent,r),_=n(_,e.outTangent,r);var s=t*t*t,c=t*t,l=s-2*c+t,f=-2*s+3*c,d=s-c;return u=n(u,o,2*s-3*c+1),u=i(u,u,h,l),u=i(u,u,a,f),u=i(u,u,_,d)},r.getNoLerp=function(){return this.dataPoint},e}(),a=T((o=l).prototype,"dataPoint",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new t}}),s=T(o.prototype,"inTangent",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new t}}),c=T(o.prototype,"outTangent",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new t}}),r=o))||r;if(t===On){var d=f.prototype.lerp;f.prototype.lerp=function(e,t,n){var i=d.call(this,e,t,n);return On.normalize(i,i),i}}return f}var M$,L$,F$,B$,z$,U$,k$,G$,H$,V$,W$,j$,q$,X$,Y$,K$,Q$,J$,Z$,$$,e0,t0,n0,i0,r0,o0,a0,s0=N$("cc.CubicSplineVec2Value",Tn,Tn.multiplyScalar,Tn.scaleAndAdd),c0=N$("cc.CubicSplineVec3Value",yn,yn.multiplyScalar,yn.scaleAndAdd),l0=N$("cc.CubicSplineVec4Value",wn,wn.multiplyScalar,wn.scaleAndAdd),u0=N$("cc.CubicSplineQuatValue",On,On.multiplyScalar,On.scaleAndAdd),h0=dc("cc.CubicSplineNumberValue")((A$=function(){function e(e,t,n){E(this,"dataPoint",T$,this),E(this,"inTangent",C$,this),E(this,"outTangent",b$,this),this.dataPoint=e,this.inTangent=t,this.outTangent=n}var t=e.prototype;return t.lerp=function(e,t,n){var i=this.dataPoint,r=e.dataPoint,o=t*t*t,a=t*t;return i*(2*o-3*a+1)+this.outTangent*n*(o-2*a+t)+r*(-2*o+3*a)+e.inTangent*n*(o-a)},t.getNoLerp=function(){return this.dataPoint},e}(),T$=T((E$=A$).prototype,"dataPoint",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),C$=T(E$.prototype,"inTangent",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),b$=T(E$.prototype,"outTangent",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),S$=E$))||S$,_0=Symbol("CreateEval"),f0=Symbol("NormalizedFollow"),d0=Symbol("ConvertAsTrsPath"),p0=Symbol("TrackBinding"),m0=dc("cc.animation.TrackPath")((B$=function(){function e(){E(this,"_paths",F$,this)}var t=e.prototype;return t.toProperty=function(e){return this._paths.push(e),this},t.toElement=function(e){return this._paths.push(e),this},t.toHierarchy=function(e){return this._paths.push(new w$(e)),this},t.toComponent=function(e){var t=new I$("string"==typeof e?e:Ke.getClassName(e));return this._paths.push(t),this},t.toCustomized=function(e){return this._paths.push(e),this},t.append=function(){for(var e,t=arguments.length,n=new Array(t),i=0;i<t;i++)n[i]=arguments[i];var r=(e=this._paths).concat.apply(e,n.map((function(e){return e._paths})));return this._paths=r,this},t.isPropertyAt=function(e){return"string"==typeof this._paths[e]},t.parsePropertyAt=function(e){return this._paths[e]},t.isElementAt=function(e){return"number"==typeof this._paths[e]},t.parseElementAt=function(e){return this._paths[e]},t.isHierarchyAt=function(e){return this._paths[e]instanceof w$},t.parseHierarchyAt=function(e){return this.isHierarchyAt(e),this._paths[e].path},t.isComponentAt=function(e){return this._paths[e]instanceof I$},t.parseComponentAt=function(e){return this.isComponentAt(e),this._paths[e].component},t.slice=function(t,n){var i=new e;return i._paths=this._paths.slice(t,n),i},t.trace=function(e,t,n){var i,r;return null!==(i=t)&&void 0!==i||(t=0),null!==(r=n)&&void 0!==r||(n=this._paths.length),this[f0](e,t,n)},t[d0]=function(){for(var e,t=this._paths,n=t.length,i=0,r="";i<n;++i){var o=t[i];if(!(o instanceof w$))break;o.path&&(r?r+="/"+o.path:r=o.path)}if(i===n)return null;if(i!==n-1)return null;switch(t[i]){case"position":case"scale":case"rotation":case"eulerAngles":e=t[i];break;default:return null}return{node:r,property:e}},t[f0]=function(e,t,n){for(var i=this._paths,r=e,o=t;o<n;++o){var a=i[o];if(r$(a)){if(!(a in r))return q(3929,a),null;r=r[a]}else r=a.get(r);if(null===r)break}return r},h(e,[{key:"length",get:function(){return this._paths.length}}]),e}(),F$=T((L$=B$).prototype,"_paths",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),M$=L$))||M$,v0=dc("cc.animation.TrackBinding")(z$=Ac((H$=function(){function e(){E(this,"path",k$,this),E(this,"proxy",G$,this)}var t=e.prototype;return t.parseTrsPath=function(){return this.proxy?null:this.path[d0]()},t.createRuntimeBinding=function(e,t,n){var i=this.path,r=this.proxy,o=i.length,a=o-1;if(0===o||!i.isPropertyAt(a)&&!i.isElementAt(a)||r){if(r){var s=i[f0](e,0,o);if(null===s)return null;var c=r.forTarget(s),l={setValue:function(e){c.set(e)}},u=c.get;return u&&(l.getValue=function(){return u.call(c)}),l}return Y(3921),null}var h,_=i.isPropertyAt(a)?i.parsePropertyAt(a):i.parseElementAt(a),f=i[f0](e,0,o-1);return null===f?null:t&&f instanceof jb&&("position"===(h=_)||"rotation"===h||"scale"===h||"eulerAngles"===h)?t.createPoseWriter(f,_,n):{setValue:function(e){f[_]=e},getValue:function(){return f[_]}}},t.isMaskedOff=function(e){var t=this.parseTrsPath();if(!t)return!1;for(var n=e.joints[Symbol.iterator](),i=n.next();!i.done;i=n.next()){var r=i.value;if(r.path===t.node)return!r.enabled}return!1},e}(),k$=T((U$=H$).prototype,"path",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new m0}}),G$=T(U$.prototype,"proxy",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),z$=U$))||z$)||z$,g0=dc("cc.animation.Track")((q$=function(){function e(){E(this,"_binding",j$,this)}var t=e.prototype;return t.channels=function(){return[]},t.range=function(){for(var e,t={min:1/0,max:-1/0},n=S(this.channels());!(e=n()).done;){var i=e.value;t.min=Math.min(t.min,i.curve.rangeMin),t.max=Math.max(t.max,i.curve.rangeMax)}return t},h(e,[{key:"path",get:function(){return this._binding.path},set:function(e){this._binding.path=e}},{key:"proxy",get:function(){return this._binding.proxy},set:function(e){this._binding.proxy=e}},{key:p0,get:function(){return this._binding}}]),e}(),j$=T((W$=q$).prototype,"_binding",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new v0}}),V$=W$))||V$,y0=dc("cc.animation.Channel")((Q$=function(){function e(e){this.name="",E(this,"_curve",K$,this),this._curve=e}return h(e,[{key:"curve",get:function(){return this._curve}}]),e}(),K$=T((Y$=Q$).prototype,"_curve",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),X$=Y$))||X$,x0=dc("cc.animation.SingleChannelTrack")((e0=function(e){function t(){var t;return E(t=e.call(this)||this,"_channel",$$,y(t)),t._channel=new y0(t.createCurve()),t}f(t,e);var n=t.prototype;return n.channels=function(){return[this._channel]},n.createCurve=function(){throw new Error("Not impl")},n[_0]=function(){var e=this._channel.curve;return new S0(e)},h(t,[{key:"channel",get:function(){return this._channel}}]),t}(g0),$$=T((Z$=e0).prototype,"_channel",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),J$=Z$))||J$,S0=function(){function e(e){this._curve=e}return e.prototype.evaluate=function(e){return this._curve.evaluate(e)},e}(),E0=dc("cc.animation.RealTrack")(t0=function(e){function t(){return e.apply(this,arguments)||this}return f(t,e),t.prototype.createCurve=function(){return new Z_},t}(x0))||t0;function T0(e){return 0===e.keyFramesCount?void 0:e}var C0,b0,A0,w0,I0,P0,R0,D0,O0,N0,M0=["X","Y","Z","W"],L0=dc("cc.animation.VectorTrack")((a0=function(e){function t(){var t;E(t=e.call(this)||this,"_channels",r0,y(t)),E(t,"_nComponents",o0,y(t)),t._channels=new Array(4);for(var n=0;n<t._channels.length;++n){var i=new y0(new Z_);i.name=M0[n],t._channels[n]=i}return t}f(t,e);var n=t.prototype;return n.channels=function(){return this._channels},n[_0]=function(){switch(this._nComponents){default:case 2:return new F0(T0(this._channels[0].curve),T0(this._channels[1].curve));case 3:return new B0(T0(this._channels[0].curve),T0(this._channels[1].curve),T0(this._channels[2].curve));case 4:return new z0(T0(this._channels[0].curve),T0(this._channels[1].curve),T0(this._channels[2].curve),T0(this._channels[3].curve))}},h(t,[{key:"componentsCount",get:function(){return this._nComponents},set:function(e){this._nComponents=e}}]),t}(g0),r0=T((i0=a0).prototype,"_channels",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),o0=T(i0.prototype,"_nComponents",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 4}}),n0=i0))||n0,F0=function(){function e(e,t){this._result=new Tn,this._x=e,this._y=t}return e.prototype.evaluate=function(e,t){return this._x&&this._y||!t.getValue||Tn.copy(this._result,t.getValue()),this._x&&(this._result.x=this._x.evaluate(e)),this._y&&(this._result.y=this._y.evaluate(e)),this._result},e}(),B0=function(){function e(e,t,n){this._result=new yn,this._x=e,this._y=t,this._z=n}return e.prototype.evaluate=function(e,t){return this._x&&this._y&&this._z||!t.getValue||yn.copy(this._result,t.getValue()),this._x&&(this._result.x=this._x.evaluate(e)),this._y&&(this._result.y=this._y.evaluate(e)),this._z&&(this._result.z=this._z.evaluate(e)),this._result},e}(),z0=function(){function e(e,t,n,i){this._result=new wn,this._x=e,this._y=t,this._z=n,this._w=i}return e.prototype.evaluate=function(e,t){return this._x&&this._y&&this._z&&this._w||!t.getValue||wn.copy(this._result,t.getValue()),this._x&&(this._result.x=this._x.evaluate(e)),this._y&&(this._result.y=this._y.evaluate(e)),this._z&&(this._result.z=this._z.evaluate(e)),this._w&&(this._result.w=this._w.evaluate(e)),this._result},e}(),U0=dc("cc.animation.QuatTrack")(C0=function(e){function t(){return e.apply(this,arguments)||this}f(t,e);var n=t.prototype;return n.createCurve=function(){return new Uf},n[_0]=function(){return new k0(this.channels()[0].curve)},t}(x0))||C0,k0=function(){function e(e){this._result=new On,this._curve=e}return e.prototype.evaluate=function(e){return this._curve.evaluate(e,this._result),this._result},e}(),G0=["Red","Green","Blue","Alpha"],H0=dc("cc.animation.ColorTrack")((I0=function(e){function t(){var t;E(t=e.call(this)||this,"_channels",w0,y(t)),t._channels=new Array(4);for(var n=0;n<t._channels.length;++n){var i=new y0(new Z_);i.name=G0[n],t._channels[n]=i}return t}f(t,e);var n=t.prototype;return n.channels=function(){return this._channels},n[_0]=function(){return new V0(T0(this._channels[0].curve),T0(this._channels[1].curve),T0(this._channels[2].curve),T0(this._channels[3].curve))},t}(g0),w0=T((A0=I0).prototype,"_channels",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),b0=A0))||b0,V0=function(){function e(e,t,n,i){this._result=new Qn,this._x=e,this._y=t,this._z=n,this._w=i}return e.prototype.evaluate=function(e,t){return this._x&&this._y&&this._z&&this._w||!t.getValue||Qn.copy(this._result,t.getValue()),this._x&&(this._result.r=this._x.evaluate(e)),this._y&&(this._result.g=this._y.evaluate(e)),this._z&&(this._result.b=this._z.evaluate(e)),this._w&&(this._result.a=this._w.evaluate(e)),this._result},e}(),W0=["Width","Height"],j0=dc("cc.animation.SizeTrack")((O0=function(e){function t(){var t;E(t=e.call(this)||this,"_channels",D0,y(t)),t._channels=new Array(2);for(var n=0;n<t._channels.length;++n){var i=new y0(new Z_);i.name=W0[n],t._channels[n]=i}return t}f(t,e);var n=t.prototype;return n.channels=function(){return this._channels},n[_0]=function(){return new q0(T0(this._channels[0].curve),T0(this._channels[1].curve))},t}(g0),D0=T((R0=O0).prototype,"_channels",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),P0=R0))||P0,q0=function(){function e(e,t){this._result=new jn,this._width=e,this._height=t}return e.prototype.evaluate=function(e,t){if((!this._width||!this._height)&&t.getValue){var n=t.getValue();this._result.x=n.x,this._result.y=n.y}return this._width&&(this._result.width=this._width.evaluate(e)),this._height&&(this._result.height=this._height.evaluate(e)),this._result},e}(),X0=dc("cc.animation.ObjectTrack")(N0=function(e){function t(){return e.apply(this,arguments)||this}return f(t,e),t.prototype.createCurve=function(){return new Kf},t}(x0))||N0;e("animation",Object.freeze({__proto__:null,UniformProxyFactory:P$,MorphWeightValueProxy:R$,MorphWeightsValueProxy:D$,MorphWeightsAllValueProxy:O$,Track:g0,TrackPath:m0,RealTrack:E0,VectorTrack:L0,QuatTrack:U0,ColorTrack:H0,SizeTrack:j0,ObjectTrack:X0,isPropertyPath:r$,isCustomPath:function(e,t){return e instanceof t},HierarchyPath:w$,ComponentPath:I$,CubicSplineVec2Value:s0,CubicSplineVec3Value:c0,CubicSplineVec4Value:l0,CubicSplineQuatValue:u0,CubicSplineNumberValue:h0}));var Y0=e("RatioSampler",function(){function e(e){var t,n;this.ratios=void 0,this._findRatio=void 0,this.ratios=e;for(var i=!0,r=1,o=e.length;r<o;r++)if(t=e[r]-e[r-1],1===r)n=t;else if(Math.abs(t-n)>1e-6){i=!1;break}this._findRatio=i?Z0:ec}return e.prototype.sample=function(e){return this._findRatio(this.ratios,e)},e}());b.RatioSampler=Y0;var K0=e("AnimCurve",function(){function e(t,n){this.types=void 0,this.type=null,this._values=[],this._lerp=void 0,this._duration=void 0,this._array=void 0,this._duration=n,this._values=t.values;var i=function(t){return"string"==typeof t?t:Array.isArray(t)?t[0]===t[1]&&t[2]===t[3]?e.Linear:e.Bezier(t):e.Linear};if(void 0!==t.easingMethod)this.type=i(t.easingMethod);else if(Array.isArray(t.easingMethods))this.types=t.easingMethods.map(i);else if(void 0!==t.easingMethods){this.types=new Array(this._values.length).fill(null);for(var r=0,o=Object.keys(t.easingMethods);r<o.length;r++){var a=o[r];this.types[a]=i(t.easingMethods[a])}}else this.type=null;var s=t.values[0];(void 0===t.interpolate||t.interpolate)&&(this._lerp=s1(s)),void 0!==t._arrayLength&&(this._array=new Array(t._arrayLength))}e.Bezier=function(e){return e};var t=e.prototype;return t.hasLerp=function(){return!!this._lerp},t.valueAt=function(e){if(void 0===this._array){var t=this._values[e];return t&&t.getNoLerp?t.getNoLerp():t}for(var n=0;n<this._array.length;++n)this._array[n]=this._values[this._array.length*e+n];return this._array},t.valueBetween=function(e,t,n,i,r){if(this._lerp){var o=this.types?this.types[t]:this.type,a=r-n,s=(e-n)/a;if(o&&(s=J0(s,o)),void 0===this._array){var c=this._values[t],l=this._values[i];return this._lerp(c,l,s,a*this._duration)}for(var u=0;u<this._array.length;++u){var h=this._values[this._array.length*t+u],_=this._values[this._array.length*i+u];this._array[u]=this._lerp(h,_,s,a*this._duration)}return this._array}if(void 0===this._array)return this.valueAt(t);for(var f=0;f<this._array.length;++f)this._array[f]=this._values[this._array.length*t+f];return this._array},t.empty=function(){return 0===this._values.length},t.constant=function(){return 1===this._values.length},e}());function Q0(e,t,n){var i=t.sample(n);if(i<0)if((i=~i)<=0)i=0;else{if(!(i>=t.ratios.length))return e.valueBetween(n,i-1,t.ratios[i-1],i,t.ratios[i]);i=t.ratios.length-1}return e.valueAt(i)}function J0(e,t){if("string"==typeof t){var n=G_[t];n?e=n(e):Y(3906,t)}else Array.isArray(t)&&(e=Lf(t,e));return e}function Z0(e,t){var n=e.length-1;if(0===n)return 0;var i=e[0];if(t<i)return 0;var r=e[n];if(t>r)return n;var o=(t=(t-i)/(r-i))/(1/n),a=0|o,s=1e-6;return o-a<s?a:a+1-o<s?a+1:~(a+1)}K0.Linear=null,b.AnimCurve=K0,e("EventInfo",function(){function e(){this.events=[]}return e.prototype.add=function(e,t){this.events.push({func:e||"",params:t||[]})},e}()),b.sampleAnimationCurve=Q0;var $0,e1,t1,n1,i1,r1,o1,a1,s1=function(){function e(e,t,n,i){return e.lerp(t,n,i)}return function(t){if(null!==t){if("number"==typeof t)return nn;if("object"==typeof t&&t.constructor){if(t instanceof On)return n=new On,function(e,t,i){return On.slerp(n,e,t,i)};if(t instanceof tt)return function(e){var t=new e;return function(n,i,r){return e.lerp(t,n,i,r),t}}(t.constructor);if(t.constructor===Number)return nn;if("function"==typeof t.lerp)return e}var n}}}(),c1=dc("cc.animation.UntypedTrackChannel")((n1=function(e){function t(){var t;return E(t=e.call(this,new Z_)||this,"property",t1,y(t)),t}return f(t,e),t}(y0),t1=T((e1=n1).prototype,"property",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),$0=e1))||$0,l1=dc("cc.animation.UntypedTrack")((a1=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return E(t=e.call.apply(e,[this].concat(i))||this,"_channels",o1,y(t)),t}f(t,e);var n=t.prototype;return n.channels=function(){return this._channels},n[_0]=function(e){var t=this;if(!e.getValue)throw new Error(Z(3930));var n=function(e){var n;return null===(n=t._channels.find((function(t){return t.property===e})))||void 0===n?void 0:n.curve},i=e.getValue();switch(!0){default:throw new Error(Z(3931));case i instanceof Tn:return new F0(n("x"),n("y"));case i instanceof yn:return new B0(n("x"),n("y"),n("z"));case i instanceof wn:return new z0(n("x"),n("y"),n("z"),n("w"));case i instanceof Qn:return new V0(n("r"),n("g"),n("b"),n("a"));case i instanceof jn:return new q0(n("width"),n("height"))}},n.addChannel=function(e){var t=new c1;return t.property=e,this._channels.push(t),t},n.upgrade=function(e){var t=this,n=function(e,n){var i=t.channels().find((function(t){return t.property===e}));i&&(n.name=i.name,n.curve.assignSorted(Array.from(i.curve.times()),Array.from(i.curve.values())))},i=e(this.path,this.proxy);switch(i){default:break;case"vec2":case"vec3":case"vec4":var r=new L0;r.path=this.path,r.proxy=this.proxy,r.componentsCount="vec2"===i?2:"vec3"===i?3:4;var o=r.channels(),a=o[0],s=o[1],c=o[2],l=o[3];switch(i){case"vec4":n("w",l);case"vec3":n("z",c);default:case"vec2":n("x",a),n("y",s)}return r;case"color":var u=new H0,h=u.channels(),_=h[0],f=h[1],d=h[2],p=h[3];return n("r",_),n("g",f),n("b",d),n("a",p),n("x",_),n("y",f),n("z",d),n("w",p),u;case"size":}return null},t}(g0),o1=T((r1=a1).prototype,"_channels",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),i1=r1))||i1,u1=function(){function e(e){this._keys=[],this._curves=[],this._commonTargets=[],this._ratioSamplers=[],this._runtimeCurves=void 0,this._data=null,this._duration=void 0,this._duration=e}var t=e.prototype;return t.getPropertyCurves=function(){return this._runtimeCurves||this._createPropertyCurves(),this._runtimeCurves},t.toTracks=function(){for(var e,t=[],n=this.keys,i=this.curves,r=this.commonTargets,o=function(e,t,n){for(var i,r=new m0,o=S(t);!(i=o()).done;){var a=i.value;"string"==typeof a?r.toProperty(a):"number"==typeof a?r.toElement(a):a instanceof w$?r.toHierarchy(a.path):a instanceof I$?r.toComponent(a.component):r.toCustomized(a)}e.path=r,e.proxy=n},a=r.map((function(e){var n=new l1;return o(n,e.modifiers,e.valueAdapter),t.push(n),n})),s=function(){var i,r=e.value,s=r.data,c=s.values;if(0===c.length)return"continue";var l=s.keys<0?[0]:n[s.keys],u=c[0],h=null===(i=s.interpolate)||void 0===i||i;s._arrayLength;var _=new _1(s,l.length),f=function(e){o(e,r.modifiers,r.valueAdapter)},d=void 0;if("number"==typeof r.commonTarget){if(!c.every((function(e){return"number"==typeof e})))return q(3932),"continue";if(r.valueAdapter||1!==r.modifiers.length||"string"!=typeof r.modifiers[0])return q(3933),"continue";var p=r.modifiers[0],m=a[r.commonTarget].addChannel(p).curve;d=m}!function(){if("number"==typeof u){if(!c.every((function(e){return"number"==typeof e})))return void q(3934);var e;if(d)e=d;else{var n=new E0;f(n),t.push(n),e=n.channel.curve}var i=h?tc.LINEAR:tc.CONSTANT;return e.assignSorted(l,c.map((function(e){return{value:e,interpolationMode:i}}))),void _.convert(e)}if("object"==typeof u)switch(!0){default:break;case h1(c,Tn):case h1(c,yn):case h1(c,wn):var r=u instanceof Tn?2:u instanceof yn?3:4,o=new L0;f(o),o.componentsCount=r;var a=o.channels(),s=a[0].curve,p=a[1].curve,m=a[2].curve,v=a[3].curve,g=h?tc.LINEAR:tc.CONSTANT,y=function(e){return{value:e,interpolationMode:g}};switch(r){case 4:v.assignSorted(l,c.map((function(e){return y(e.w)}))),_.convert(v);case 3:m.assignSorted(l,c.map((function(e){return y(e.z)}))),_.convert(m);default:s.assignSorted(l,c.map((function(e){return y(e.x)}))),_.convert(s),p.assignSorted(l,c.map((function(e){return y(e.y)}))),_.convert(p)}return void t.push(o);case h1(c,On):var x=new U0;f(x);var S=h?If.SLERP:If.CONSTANT;return x.channel.curve.assignSorted(l,c.map((function(e){return{value:On.clone(e),interpolationMode:S}}))),_.convertQuatCurve(x.channel.curve),void t.push(x);case h1(c,Qn):var E=new H0;f(E);var T=E.channels(),C=T[0].curve,b=T[1].curve,A=T[2].curve,w=T[3].curve,I=h?tc.LINEAR:tc.CONSTANT,P=function(e){return{value:e,interpolationMode:I}};return C.assignSorted(l,c.map((function(e){return P(e.r)}))),_.convert(C),b.assignSorted(l,c.map((function(e){return P(e.g)}))),_.convert(b),A.assignSorted(l,c.map((function(e){return P(e.b)}))),_.convert(A),w.assignSorted(l,c.map((function(e){return P(e.a)}))),_.convert(w),void t.push(E);case h1(c,jn):var R=new j0;f(R);var D=R.channels(),O=D[0].curve,N=D[1].curve,M=h?tc.LINEAR:tc.CONSTANT,L=function(e){return{value:e,interpolationMode:M}};return O.assignSorted(l,c.map((function(e){return L(e.width)}))),_.convert(O),N.assignSorted(l,c.map((function(e){return L(e.height)}))),_.convert(N),void t.push(R);case h1(c,h0):var F=new E0;f(F);var B=h?tc.CUBIC:tc.CONSTANT;return F.channel.curve.assignSorted(l,c.map((function(e){return{value:e.dataPoint,leftTangent:e.inTangent,rightTangent:e.outTangent,interpolationMode:B}}))),void t.push(F);case h1(c,s0):case h1(c,c0):case h1(c,l0):var z=u instanceof s0?2:u instanceof c0?3:4,U=new L0;f(U),U.componentsCount=z;var k=U.channels(),G=k[0],H=k[1],V=k[2],W=k[3],j=h?tc.LINEAR:tc.CONSTANT,X=function(e,t,n){return{value:e,leftTangent:t,rightTangent:n,interpolationMode:j}};switch(z){case 4:W.curve.assignSorted(l,c.map((function(e){return X(e.dataPoint.w,e.inTangent.w,e.outTangent.w)})));case 3:V.curve.assignSorted(l,c.map((function(e){return X(e.dataPoint.z,e.inTangent.z,e.outTangent.z)})));default:G.curve.assignSorted(l,c.map((function(e){return X(e.dataPoint.y,e.inTangent.y,e.outTangent.y)}))),H.curve.assignSorted(l,c.map((function(e){return X(e.dataPoint.x,e.inTangent.x,e.outTangent.x)})))}return void t.push(U);case c.every((function(e){return e instanceof u0})):q(3935)}var Y=new X0;f(Y),Y.channel.curve.assignSorted(l,c),t.push(Y)}()},c=S(i);!(e=c()).done;)s();return t},t._createPropertyCurves=function(){var e=this;this._ratioSamplers=this._keys.map((function(t){return new Y0(t.map((function(t){return t/e._duration})))})),this._runtimeCurves=this._curves.map((function(t){return{curve:new K0(t.data,e._duration),modifiers:t.modifiers,valueAdapter:t.valueAdapter,sampler:e._ratioSamplers[t.data.keys],commonTarget:t.commonTarget}}))},h(e,[{key:"keys",get:function(){return this._keys},set:function(e){this._keys=e}},{key:"curves",get:function(){return this._curves},set:function(e){this._curves=e,delete this._runtimeCurves}},{key:"commonTargets",get:function(){return this._commonTargets},set:function(e){this._commonTargets=e}},{key:"data",get:function(){return this._data}}]),e}();function h1(e,t){return e.every((function(e){return e instanceof t}))}var _1=function(){function e(e,t){this._easingMethods=void 0;var n=e.easingMethods;Array.isArray(n)?0===n.length&&0!==t?this._easingMethods=new Array(t).fill(null):this._easingMethods=n:this._easingMethods=void 0===n?new Array(t).fill(e.easingMethod):Array.from({length:t},(function(e,t){var i;return null!==(i=n[t])&&void 0!==i?i:null}))}var t=e.prototype;return t.convert=function(e){var t,n,i,r,o,a,s,c,l,u,h,_,f,d,p,m,v,g,y,x,S,E,T=this._easingMethods;if(T){var C=e.keyFramesCount;if(!(e.keyFramesCount<2)){Array.isArray(T)&&T.length;for(var b=C-1,A=0;A<b;++A){var w=T[A];w&&(Array.isArray(w)?(t=w,n=e.getKeyframeTime(A),i=e.getKeyframeValue(A),r=e.getKeyframeTime(A+1),o=e.getKeyframeValue(A+1),a=void 0,s=void 0,c=void 0,l=void 0,u=void 0,h=void 0,_=void 0,f=void 0,d=void 0,p=void 0,m=void 0,v=void 0,g=void 0,y=void 0,x=void 0,S=void 0,E=void 0,s=t[0],c=t[1],l=t[2],u=t[3],h=i.value,_=3*(r-n),f=3*(o.value-h),m=(1-l)*_,v=(1-u)*f,g=1/3,y=(p=c*f)/(d=s*_),x=Math.sqrt(d*d+p*p)*g,S=v/m,E=Math.sqrt(m*m+v*v)*g,i.interpolationMode=tc.CUBIC,i.tangentWeightMode=(a=i.tangentWeightMode)===ic.NONE?ic.RIGHT:a===ic.LEFT?ic.BOTH:a,i.rightTangent=y,i.rightTangentWeight=x,o.tangentWeightMode=function(e){return e===ic.NONE?ic.LEFT:e===ic.RIGHT?ic.BOTH:e}(o.tangentWeightMode),o.leftTangent=S,o.leftTangentWeight=E):f1(w,e,A))}}}},t.convertQuatCurve=function(e){var t=this._easingMethods;if(t){var n=e.keyFramesCount;if(!(e.keyFramesCount<2)){Array.isArray(t)&&t.length;for(var i=n-1,r=0;r<i;++r){var o=t[r];o&&(Array.isArray(o)?e.getKeyframeValue(r).easingMethod=o.slice():d1(o,e,r))}}}},h(e,[{key:"nil",get:function(){return!this._easingMethods||this._easingMethods.every((function(e){return null==e}))}}]),e}();function f1(e,t,n){t.keyFramesCount;var i=t.getKeyframeValue(n),r=W1[e];r===k_.CONSTANT?i.interpolationMode=tc.CONSTANT:(i.interpolationMode=tc.LINEAR,i.easingMethod=r)}function d1(e,t,n){t.keyFramesCount;var i=t.getKeyframeValue(n),r=W1[e];i.easingMethod=r}var p1,m1,v1,g1,y1,x1,S1,E1,T1,C1,b1,A1,w1,I1,P1,R1,D1,O1,N1,M1,L1,F1,B1,z1,U1,k1,G1,H1,V1,W1={constant:k_.CONSTANT,linear:k_.LINEAR,quadIn:k_.QUAD_IN,quadOut:k_.QUAD_OUT,quadInOut:k_.QUAD_IN_OUT,quadOutIn:k_.QUAD_OUT_IN,cubicIn:k_.CUBIC_IN,cubicOut:k_.CUBIC_OUT,cubicInOut:k_.CUBIC_IN_OUT,cubicOutIn:k_.CUBIC_OUT_IN,quartIn:k_.QUART_IN,quartOut:k_.QUART_OUT,quartInOut:k_.QUART_IN_OUT,quartOutIn:k_.QUART_OUT_IN,quintIn:k_.QUINT_IN,quintOut:k_.QUINT_OUT,quintInOut:k_.QUINT_IN_OUT,quintOutIn:k_.QUINT_OUT_IN,sineIn:k_.SINE_IN,sineOut:k_.SINE_OUT,sineInOut:k_.SINE_IN_OUT,sineOutIn:k_.SINE_OUT_IN,expoIn:k_.EXPO_IN,expoOut:k_.EXPO_OUT,expoInOut:k_.EXPO_IN_OUT,expoOutIn:k_.EXPO_OUT_IN,circIn:k_.CIRC_IN,circOut:k_.CIRC_OUT,circInOut:k_.CIRC_IN_OUT,circOutIn:k_.CIRC_OUT_IN,elasticIn:k_.ELASTIC_IN,elasticOut:k_.ELASTIC_OUT,elasticInOut:k_.ELASTIC_IN_OUT,elasticOutIn:k_.ELASTIC_OUT_IN,backIn:k_.BACK_IN,backOut:k_.BACK_OUT,backInOut:k_.BACK_IN_OUT,backOutIn:k_.BACK_OUT_IN,bounceIn:k_.BOUNCE_IN,bounceOut:k_.BOUNCE_OUT,bounceInOut:k_.BOUNCE_IN_OUT,bounceOutIn:k_.BOUNCE_OUT_IN,smooth:k_.SMOOTH,fade:k_.FADE};function j1(){throw new Error("split() only valid in Editor.")}dc("cc.animation.ExoticAnimation")((v1=function(){function e(){E(this,"_nodeAnimations",m1,this)}var t=e.prototype;return t.createEvaluator=function(e){return new t2(this._nodeAnimations,e)},t.addNodeAnimation=function(e){var t=new q1(e);return this._nodeAnimations.push(t),t},t.collectAnimatedJoints=function(){return Array.from(new Set(this._nodeAnimations.map((function(e){return e.path}))))},t.split=function(){return j1()},t.toHashString=function(){return this._nodeAnimations.map((function(e){return e.toHashString()})).join("\n")},e}(),m1=T((p1=v1).prototype,"_nodeAnimations",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),p1));var q1=dc("cc.animation.ExoticNodeAnimation")((C1=function(){function e(e){E(this,"_path",x1,this),E(this,"_position",S1,this),E(this,"_rotation",E1,this),E(this,"_scale",T1,this),this._path=e}var t=e.prototype;return t.createPosition=function(e,t){this._position=new Z1(e,new Q1(t))},t.createRotation=function(e,t){this._rotation=new Z1(e,new J1(t))},t.createScale=function(e,t){this._scale=new Z1(e,new Q1(t))},t.createEvaluator=function(e){return new n2(this._path,this._position,this._rotation,this._scale,e)},t.split=function(){return j1()},t.toHashString=function(){var e,t,n,i,r,o;return this._path+"\n"+(null!==(e=null===(t=this._position)||void 0===t?void 0:t.toHashString())&&void 0!==e?e:"")+(null!==(n=null===(i=this._scale)||void 0===i?void 0:i.toHashString())&&void 0!==n?n:"")+(null!==(r=null===(o=this._rotation)||void 0===o?void 0:o.toHashString())&&void 0!==r?r:"")},h(e,[{key:"path",get:function(){return this._path}}]),e}(),x1=T((y1=C1).prototype,"_path",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),S1=T(y1.prototype,"_position",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),E1=T(y1.prototype,"_rotation",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),T1=T(y1.prototype,"_scale",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),g1=y1))||g1;function X1(e){return e.toPrecision(2)}function Y1(e){return e.map(X1).join(" ")}var K1=dc("cc.animation.ExoticVectorLikeTrackValues")((P1=function(){function e(e){E(this,"_values",w1,this),E(this,"_isQuantized",I1,this),this._values=e,this._isQuantized=!1}var t=e.prototype;return t.quantize=function(e){this._isQuantized,this._values=function(e,t){var n=r2[t],i=1<<n.BYTES_PER_ELEMENT,r=Number.POSITIVE_INFINITY,o=Number.NEGATIVE_INFINITY;e.forEach((function(e){r=Math.min(e,r),o=Math.max(e,o)}));var a=o-r,s=n.from(e,(function(e){return(e-r)/a*i}));return new y2(o2(e),s,a,r)}(this._values,e),this._isQuantized=!0},t.toHashString=function(){var e=this._isQuantized,t=this._values;return e+" "+(e?t.toHashString():Y1(t))},h(e,[{key:"precision",get:function(){return this._isQuantized?this._values.originalPrecision:o2(this._values)}}]),e}(),w1=T((A1=P1).prototype,"_values",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),I1=T(A1.prototype,"_isQuantized",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),b1=A1))||b1,Q1=dc("cc.animation.ExoticVec3TrackValues")(R1=function(e){function t(){return e.apply(this,arguments)||this}f(t,e),t.imitate=function(e,n){var i=new t(e);return n._isQuantized&&i.quantize(n._values.quantizationType),i};var n=t.prototype;return n.get=function(e,t){var n=this._values;this._isQuantized?E2(n,e,t):yn.fromArray(t,n,3*e)},n.lerp=function(e,t,n,i,r,o){var a=this._values;this._isQuantized?(E2(a,e,i),E2(a,t,r)):(yn.fromArray(i,a,3*e),yn.fromArray(r,a,3*t)),yn.lerp(o,i,r,n)},t}(K1))||R1,J1=dc("cc.animation.ExoticQuatTrackValues")(D1=function(e){function t(){return e.apply(this,arguments)||this}f(t,e),t.imitate=function(e,n){var i=new t(e);return n._isQuantized&&i.quantize(n._values.quantizationType),i};var n=t.prototype;return n.get=function(e,t){var n=this._values;this._isQuantized?T2(n,e,t):On.fromArray(t,n,4*e)},n.lerp=function(e,t,n,i,r,o){var a=this._values;this._isQuantized?(T2(a,e,i),T2(a,t,r)):(On.fromArray(i,a,4*e),On.fromArray(r,a,4*t)),On.slerp(o,i,r,n)},t}(K1))||D1,Z1=dc("cc.animation.ExoticTrack")((F1=function(){function e(e,t){E(this,"times",M1,this),E(this,"values",L1,this),this.times=e,this.values=t}return e.prototype.toHashString=function(){var e=this.times,t=this.values;return"times: "+Y1(e)+"; values: "+t.toHashString()},e}(),M1=T((N1=F1).prototype,"times",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),L1=T(N1.prototype,"values",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),O1=N1))||O1;function $1(e,t){e.length,e.length;var n=0,i=0,r=ec(e,t);if(r>=0)n=r;else{var o=~r,a=o-1;n=a;var s=e[o],c=e[a];i=(t-c)/(s-c)}return{index:n,ratio:i}}!function(){function e(){this._reset()}var t=e.prototype;t.transformTime=function(e){return e-this._timeOffset},t.calculate=function(e,t,n){this._reset();var i=e.length;if(i){var r=e[0],o=e[i-1],a=en(t,r,o),s=en(n,r,o);this._timeOffset=a;var c=function(e,t,n){var i=e.length;n>=t&&t>=e[0]&&e[i-1];var r=$1(e,t),o=r.index,a=r.ratio,s=$1(e,n);return{fromIndex:o,fromRatio:a,toIndex:s.index,toRatio:s.ratio}}(e,a,s),l=c.fromIndex,u=c.fromRatio,h=c.toIndex,_=c.toRatio,f=!u,d=!_;l!==h||u!==_?(f||(this.preLerpIndex=l,this.preLerpRatio=u),this.directKeyframesBegin=f?l:l+1,this.directKeyframesEnd=h+1,d||(this.postLerpIndex=h,this.postLerpRatio=_)):f?(this.directKeyframesBegin=l,this.directKeyframesEnd=l+1):(this.preLerpIndex=l,this.preLerpRatio=u)}},t._reset=function(){this.preLerpIndex=-1,this.preLerpRatio=0,this.directKeyframesBegin=0,this.directKeyframesEnd=0,this.postLerpIndex=-1,this.postLerpRatio=0,this._timeOffset=0},h(e,[{key:"keyframesCount",get:function(){var e=this.preLerpIndex,t=this.directKeyframesBegin;return 0+(e<0?0:1)+(this.directKeyframesEnd-t)+(this.postLerpIndex<0?0:1)}}])}();var e2,t2=function(){function e(e,t){this._nodeEvaluations=void 0,this._nodeEvaluations=e.map((function(e){return e.createEvaluator(t)}))}return e.prototype.evaluate=function(e){this._nodeEvaluations.forEach((function(t){t.evaluate(e)}))},e}(),n2=function(){function e(e,t,n,i,r){this._position=null,this._rotation=null,this._scale=null,t&&(this._position=S2(t.times,t.values,yn,e,"position",r)),n&&(this._rotation=S2(n.times,n.values,On,e,"rotation",r)),i&&(this._scale=S2(i.times,i.values,yn,e,"scale",r))}return e.prototype.evaluate=function(e){if(this._position){var t=this._position.evaluator.evaluate(e);this._position.runtimeBinding.setValue(t)}if(this._rotation){var n=this._rotation.evaluator.evaluate(e);this._rotation.runtimeBinding.setValue(n)}if(this._scale){var i=this._scale.evaluator.evaluate(e);this._scale.runtimeBinding.setValue(i)}},e}(),i2=function(){function e(e,t,n){this._times=void 0,this._inputSampleResultCache={just:!1,index:-1,nextIndex:-1,ratio:0},this._values=void 0,this._prevValue=void 0,this._nextValue=void 0,this._resultValue=void 0,this._times=e,this._values=t,this._prevValue=new n,this._nextValue=new n,this._resultValue=new n}return e.prototype.evaluate=function(e){var t=this._times,n=this._values,i=this._resultValue;if(0===t.length)return i;var r=function(e,t,n){var i=e.length,r=e[0],o=e[i-1];if(t<r)n.just=!0,n.index=0;else if(t>o)n.just=!0,n.index=i-1;else{var a=ec(e,t);if(a>=0)n.just=!0,n.index=a;else{var s=~a,c=s-1,l=e[c],u=e[s],h=(t-e[c])/(u-l);n.just=!1,n.index=c,n.nextIndex=s,n.ratio=h}}return n}(t,e,this._inputSampleResultCache);return r.just?n.get(r.index,i):n.lerp(r.index,r.nextIndex,r.ratio,this._prevValue,this._nextValue,i),i},e}(),r2={uint8:Uint8Array,uint16:Uint16Array};function o2(e){switch(e.BYTES_PER_ELEMENT){default:case 4:return e2.FLOAT_32;case 8:return e2.FLOAT_64}}!function(e){e[e.FLOAT_32=0]="FLOAT_32",e[e.FLOAT_64=1]="FLOAT_64"}(e2||(e2={}));var a2,s2,c2,l2,u2,h2,_2,f2,d2,p2,m2,v2,g2,y2=dc("cc.animation.QuantizedFloatArray")((V1=function(){function e(e,t,n,i){void 0===i&&(i=0),E(this,"originalPrecision",U1,this),E(this,"min",k1,this),E(this,"extent",G1,this),E(this,"values",H1,this),this.originalPrecision=e,this.values=t,this.extent=n,this.min=i}return e.prototype.toHashString=function(){var e=this.originalPrecision,t=this.min,n=this.extent,i=this.values;return e+" "+X1(t)+" "+X1(n)+" "+i.join(" ")},h(e,[{key:"quantizationType",get:function(){switch(this.values.BYTES_PER_ELEMENT){default:case 1:return"uint8";case 2:return"uint16"}}}]),e}(),U1=T((z1=V1).prototype,"originalPrecision",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),k1=T(z1.prototype,"min",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),G1=T(z1.prototype,"extent",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),H1=T(z1.prototype,"values",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),B1=z1))||B1;function x2(e,t){return e.values[t]/(1<<e.values.BYTES_PER_ELEMENT)*e.extent+e.min}function S2(e,t,n,i,r,o){var a=new v0;a.path=(new m0).toHierarchy(i).toProperty(r);var s=o(a);return s?{runtimeBinding:s,evaluator:new i2(e,t,n)}:null}function E2(e,t,n){yn.set(n,x2(e,3*t+0),x2(e,3*t+1),x2(e,3*t+2))}function T2(e,t,n){On.set(n,x2(e,4*t+0),x2(e,4*t+1),x2(e,4*t+2),x2(e,4*t+3))}function C2(){return b.director.getAnimationManager()}var b2=Symbol("SearchForRootBonePath"),A2=Symbol("ExoticAnimation"),w2=e("AnimationClip",dc("cc.AnimationClip")((g2=v2=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return E(t=e.call.apply(e,[this].concat(i))||this,"sample",c2,y(t)),E(t,"speed",l2,y(t)),E(t,"wrapMode",u2,y(t)),E(t,"enableTrsBlending",h2,y(t)),E(t,"_duration",_2,y(t)),E(t,"_hash",f2,y(t)),t.frameRate=0,E(t,"_tracks",d2,y(t)),E(t,"_exoticAnimation",p2,y(t)),t._legacyData=void 0,t._legacyDataDirty=!1,E(t,"_events",m2,y(t)),t._runtimeEvents={ratios:[],eventGroups:[]},t}f(t,e),t.createWithSpriteFrames=function(e,n){var i=new t;i.sample=n||i.sample,i.duration=e.length/i.sample;var r=1/i.sample,o=new X0;return o.path=(new m0).toComponent("cc.Sprite").toProperty("spriteFrame"),o.channels()[0].curve.assignSorted(e.map((function(e,t){return[r*t,e]}))),i.addTrack(o),i};var n=t.prototype;return n.onLoaded=function(){this.frameRate=this.sample,this.events=this._events},n.range=function(){for(var e={min:1/0,max:-1/0},t=this._tracks,n=t.length,i=0;i<n;++i){var r=t[i].range();e.min=Math.min(e.min,r.min),e.max=Math.max(e.max,r.max)}return e},n.getTrack=function(e){return this._tracks[e]},n.addTrack=function(e){var t=this._tracks.length;return this._tracks.push(e),t},n.removeTrack=function(e){this._tracks.splice(e,1)},n.clearTracks=function(){this._tracks.length=0},n.createEventEvaluator=function(e){return new L2(e,this._runtimeEvents.ratios,this._runtimeEvents.eventGroups,this.wrapMode)},n.createEvaluator=function(e){var t=this,n=e.target;return this._createEvalWithBinder(n,(function(i){if(!e.mask||!i.isMaskedOff(e.mask)){var r=i.createRuntimeBinding(n,t.enableTrsBlending?e.pose:void 0,!1);return null!=r?r:void 0}}),e.rootMotion)},n.destroy=function(){var t;return(null===(t=b.director.root)||void 0===t?void 0:t.dataPoolManager)&&b.director.root.dataPoolManager.releaseAnimationClip(this),xJ.destroy(this),e.prototype.destroy.call(this)},n[yJ]=function(e,t,n){for(var i=1/t,r=this._collectAnimatedJoints(),o=r.length,a={},s=0;s<o;++s)a[r[s]]={transforms:Array.from({length:n},(function(){return new kn}))};var c=r.reduce((function(e,t){return e[t]=new R2,e}),{});for(var l in c){var u=c[l],h=l.lastIndexOf("/");if(h>=0){var _=l.substring(0,h),f=c[_];f&&(u.parent=f)}}for(var d=this._createEvalWithBinder(void 0,(function(e){var t=e.parseTrsPath();if(t){var n=c[t.node];if(n)return M2(n,t.property)}}),void 0),p=0;p<n;++p){var m=e+i*p;d.evaluate(m);for(var v=0;v<o;++v){var g=r[v];kn.copy(a[g].transforms[p],c[g].globalTransform)}for(var y=0;y<o;++y){var x=r[y];c[x].invalidate()}}return{samples:t,frames:n,joints:a}},n.upgradeUntypedTracks=function(e){for(var t=[],n=[],i=this._tracks,r=i.length,o=0;o<r;++o){var a=i[o];if(a instanceof l1){var s=a.upgrade(e);s&&(t.push(s),n.push(a))}}for(var c=n.length,l=0;l<c;++l)Ye.remove(i,n[l]);i.push.apply(i,t)},n[b2]=function(){return this._searchForRootBonePath()},n.getPropertyCurves=function(){return this._getLegacyData().getPropertyCurves()},n.updateEventDatas=function(){this.events=this._events},n.hasEvents=function(){return 0!==this.events.length},n.syncLegacyData=function(){this._legacyData&&(this._fromLegacy(this._legacyData),this._legacyData=void 0)},n._createEvalWithBinder=function(e,t,n){this._legacyDataDirty&&(this._legacyDataDirty=!1,this.syncLegacyData());var i,r=[];n&&(i=this._createRootMotionEvaluation(e,n,r));for(var o,a=[],s=this._tracks,c=s.length,l=0;l<c;++l){var u=s[l];if(!r.includes(u)&&!Array.from(u.channels()).every((function(e){return 0===e.curve.keyFramesCount}))){var h=t(u[p0]);if(h){var _=u[_0](h);a.push({binding:h,trackEval:_})}}}return this._exoticAnimation&&(o=this._exoticAnimation.createEvaluator(t)),new I2(a,o,i)},n._createRootMotionEvaluation=function(e,t,n){if(e instanceof jb){var i=this._searchForRootBonePath();if(i){var r=e.getChildByPath(i);if(r){for(var o=new P2,a=[],s=this._tracks,c=s.length,l=0;l<c;++l){var u=s[l],h=u[p0].parseTrsPath();if(h&&h.node===i){n.push(u);var _=M2(o,h.property);if(_){var f=u[_0](_);a.push({binding:_,trackEval:f})}}}return new O2(r,this._duration,o,a)}q(3924)}else q(3923)}else Y(3920)},n._searchForRootBonePath=function(){var e=this._tracks.map((function(e){var t=e[p0].parseTrsPath();if(t){var n=t.node;return{path:n,rank:n.split("/").length}}return{path:"",rank:0}}));e.sort((function(e,t){return e.rank-t.rank}));var t=e.findIndex((function(e){return 0!==e.rank}));if(t<0)return"";for(var n=e.length,i=e[t],r=!0,o=t+1;o<n;++o){var a=e[o];if(a.rank!==i.rank)break;if(a.path!==i.path){r=!1;break}}return r?i.path:""},n._getLegacyData=function(){return this._legacyData||(this._legacyData=this._toLegacy()),this._legacyData},n._toLegacy=function(){var e=new u1(this._duration);return e.keys=[],e.curves=[],e.commonTargets=[],e},n._fromLegacy=function(e){for(var t=e.toTracks(),n=t.length,i=0;i<n;++i)this.addTrack(t[i])},n._collectAnimatedJoints=function(){for(var e=new Set,t=this._tracks,n=t.length,i=0;i<n;++i){var r=t[i][p0].parseTrsPath();r&&e.add(r.node)}if(this._exoticAnimation)for(var o=this._exoticAnimation.collectAnimatedJoints(),a=o.length,s=0;s<a;++s)e.add(o[s]);return Array.from(e)},h(t,[{key:"duration",get:function(){return this._duration},set:function(e){this._duration=e}},{key:"tracksCount",get:function(){return this._tracks.length}},{key:"tracks",get:function(){return this._tracks}},{key:"hash",get:function(){var e,t;if(this._hash)return this._hash;var n="Exotic:"+(null!==(e=null===(t=this._exoticAnimation)||void 0===t?void 0:t.toHashString())&&void 0!==e?e:"");return this._hash=po(n,666)}},{key:"events",get:function(){return this._events},set:function(e){var t=this;this._events=e;for(var n=[],i=[],r=this.events.sort((function(e,t){return e.frame-t.frame})),o=r.length,a=function(e){var o=r[e],a=o.frame/t._duration,s=n.findIndex((function(e){return e===a}));s<0&&(s=n.length,n.push(a),i.push({events:[]})),i[s].events.push({functionName:o.func,parameters:o.params})},s=0;s<o;++s)a(s);this._runtimeEvents={ratios:n,eventGroups:i}}},{key:A2,get:function(){return this._exoticAnimation}},{key:A2,set:function(e){this._exoticAnimation=e}},{key:"keys",get:function(){return this._getLegacyData().keys}},{key:"keys",set:function(e){this._legacyDataDirty=!0,this._getLegacyData().keys=e}},{key:"curves",get:function(){return this._legacyDataDirty=!0,this._getLegacyData().curves}},{key:"curves",set:function(e){this._getLegacyData().curves=e}},{key:"commonTargets",get:function(){return this._getLegacyData().commonTargets}},{key:"commonTargets",set:function(e){this._legacyDataDirty=!0,this._getLegacyData().commonTargets=e}},{key:"data",get:function(){return this._getLegacyData().data}},{key:"eventGroups",get:function(){return this._runtimeEvents.eventGroups}}]),t}(yu),v2.WrapMode=Xs,c2=T((s2=g2).prototype,"sample",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 60}}),l2=T(s2.prototype,"speed",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),u2=T(s2.prototype,"wrapMode",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Xs.Normal}}),h2=T(s2.prototype,"enableTrsBlending",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),_2=T(s2.prototype,"_duration",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),f2=T(s2.prototype,"_hash",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),d2=T(s2.prototype,"_tracks",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),p2=T(s2.prototype,"_exoticAnimation",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),m2=T(s2.prototype,"_events",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),a2=s2))||a2);b.AnimationClip=w2;var I2=function(){function e(e,t,n){this._exoticAnimationEvaluator=void 0,this._trackEvalStatues=[],this._rootMotionEvaluation=void 0,this._trackEvalStatues=e,this._exoticAnimationEvaluator=t,this._rootMotionEvaluation=n}var t=e.prototype;return t.evaluate=function(e){for(var t=this._trackEvalStatues,n=this._exoticAnimationEvaluator,i=t.length,r=0;r<i;++r){var o=t[r],a=o.trackEval,s=o.binding,c=a.evaluate(e,s);s.setValue(c)}n&&n.evaluate(e)},t.evaluateRootMotion=function(e,t){var n=this._rootMotionEvaluation;n&&n.evaluate(e,t)},e}(),P2=function(){function e(){this.position=new yn,this.scale=new yn(1,1,1),this.rotation=new On,this.eulerAngles=new yn}return e.prototype.getTransform=function(e){kn.fromRTS(e,this.rotation,this.position,this.scale)},e}(),R2=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).parent=null,t._dirty=!0,t._transform=new kn,t}return f(t,e),t.prototype.invalidate=function(){this._dirty=!0},h(t,[{key:"globalTransform",get:function(){var e=this._transform;return this._dirty&&(this._dirty=!1,kn.fromRTS(e,this.rotation,this.position,this.scale),this.parent&&kn.multiply(e,this.parent.globalTransform,e)),this._transform}}]),t}(P2),D2=new kn,O2=function(){function e(e,t,n,i){this._initialTransformCache=new kn,this._clipEndTransformCache=new kn,this._startTransformCache=new kn,this._endTransformCache=new kn,this._motionTransformCache=new kn,this._translationMotionCache=new yn,this._rotationMotionCache=new On,this._scaleMotionCache=new yn,this._rootBone=e,this._duration=t,this._boneTransform=n,this._trackEvalStatuses=i}var t=e.prototype;return t.evaluate=function(e,t){var n=this._calcMotionTransform(e,t,this._motionTransformCache),i=this._translationMotionCache,r=this._rotationMotionCache,o=this._scaleMotionCache,a=this._rootBone;kn.toRTS(n,r,i,o),yn.add(i,i,a.position),a.setPosition(i),On.multiply(r,r,a.rotation),a.setRotation(r),yn.multiply(o,o,a.scale),a.setScale(o)},t._calcMotionTransform=function(e,t,n){var i=this._duration,r=i-e,o=this._evaluateAt(e,this._startTransformCache);if(t<r){var a=this._evaluateAt(e+t,this._endTransformCache);N2(n,o,a)}else{kn.identity(n);var s=function(e,t){N2(D2,e,t),kn.multiply(n,n,D2)},c=t-r,l=Math.floor(c/i),u=c-l*i,h=this._evaluateAt(0,this._initialTransformCache),_=this._evaluateAt(i,this._clipEndTransformCache),f=this._evaluateAt(u,this._endTransformCache);s(o,_),N2(D2,h,_);for(var d=0;d<l;++d)kn.multiply(n,n,D2);s(h,f)}return n},t._evaluateAt=function(e,t){for(var n=this._trackEvalStatuses,i=n.length,r=0;r<i;++r){var o=n[r],a=o.trackEval,s=o.binding,c=a.evaluate(e,s);s.setValue(c)}return this._boneTransform.getTransform(t),t},e}();function N2(e,t,n){kn.invert(e,t),kn.multiply(e,n,e)}function M2(e,t){switch(t){default:return;case"position":return{setValue:function(t){yn.copy(e.position,t)}};case"rotation":return{setValue:function(t){On.copy(e.rotation,t)}};case"scale":return{setValue:function(t){yn.copy(e.scale,t)}};case"eulerAngles":return{setValue:function(t){yn.copy(e.eulerAngles,t)}}}}var L2=function(){function e(e,t,n,i){this._lastFrameIndex=-1,this._lastIterations=0,this._lastDirection=0,this._ignoreIndex=-1,this._sampled=!1,this._targetNode=e,this._ratios=t,this._eventGroups=n,this._wrapMode=i}var t=e.prototype;return t.setWrapMode=function(e){this._wrapMode=e},t.ignore=function(e,t){this._ignoreIndex=-1,this._sampled=!1;var n=B2(e,this._ratios);n<0&&(n=~n-1,t<0&&(n+=1),this._ignoreIndex=n)},t.sample=function(e,t,n){var i=this._eventGroups.length,r=B2(e,this._ratios);if(r<0&&(r=~r-1,t<0&&(r+=1)),this._ignoreIndex!==r&&(this._ignoreIndex=-1),!this._sampled)return this._sampled=!0,this._doFire(r,!1),this._lastFrameIndex=r,this._lastIterations=n,void(this._lastDirection=t);var o=this._wrapMode,a=F2(n),s=F2(this._lastIterations),c=this._lastFrameIndex,l=this._lastDirection,u=-1!==s&&a!==s;if(c===r&&u&&1===i)this._doFire(0,!1);else if(c!==r||u){t=l;do{if(c!==r){if(-1===t&&0===c&&r>0?((o&qs.PingPong)===qs.PingPong?t*=-1:c=i,s++):1===t&&c===i-1&&r<i-1&&((o&qs.PingPong)===qs.PingPong?t*=-1:c=-1,s++),c===r)break;if(s>a)break}c+=t,this._doFire(c,!0)}while(c!==r&&c>-1&&c<i)}this._lastFrameIndex=r,this._lastIterations=n,this._lastDirection=t},t._doFire=function(e,t){t?C2().pushDelayEvent(this._checkAndFire,this,[e]):this._checkAndFire(e)},t._checkAndFire=function(e){if(this._targetNode&&this._targetNode.isValid){var t=this._eventGroups;if(!(e<0||e>=t.length||this._ignoreIndex===e))for(var n=t[e],i=this._targetNode.components,r=n.events.length,o=0;o<r;++o)for(var a=n.events[o],s=a.functionName,c=i.length,l=0;l<c;++l){var u=i[l],h=u[s];"function"==typeof h&&h.apply(u,a.parameters)}}},e}();function F2(e){return e-(0|e)==0&&(e-=1),0|e}function B2(e,t){return ec(t,e)}var z2,U2=function(){function e(){this._nodeBlendStates=new Map}var t=e.prototype;return t.createWriter=function(e,t,n,i){var r=this.ref(e,t);return new k2(e,t,r,n,i)},t.destroyWriter=function(e){var t=e;this.deRef(t.node,t.property)},t.ref=function(e,t){var n=this._nodeBlendStates.get(e);return n||(n=this.createNodeBlendState(),this._nodeBlendStates.set(e,n)),n.refProperty(e,t)},t.deRef=function(e,t){var n=this._nodeBlendStates.get(e);n&&(n.deRefProperty(t),n.empty&&this._nodeBlendStates.delete(e))},t.apply=function(){this._nodeBlendStates.forEach((function(e,t){e.apply(t)}))},e}(),k2=function(){function e(e,t,n,i,r){this._node=e,this._property=t,this._propertyBlendState=n,this._host=i,this._constants=r}var t=e.prototype;return t.getValue=function(){return this._node[this._property]},t.setValue=function(e){var t=this._propertyBlendState,n=this._host.weight;t.blend(e,n)},h(e,[{key:"node",get:function(){return this._node}},{key:"property",get:function(){return this._property}}]),e}();!function(e){e[e.POSITION=1]="POSITION",e[e.ROTATION=2]="ROTATION",e[e.SCALE=4]="SCALE",e[e.EULER_ANGLES=8]="EULER_ANGLES"}(z2||(z2={}));var G2,H2,V2,W2=z2.POSITION|z2.ROTATION|z2.SCALE|z2.EULER_ANGLES,j2=function(){function e(){this.refCount=0,this.accumulatedWeight=0,this.result=new yn}var t=e.prototype;return t.blend=function(e,t){this.accumulatedWeight=$2(this.result,this.result,this.accumulatedWeight,e,t)},t.reset=function(){this.accumulatedWeight=0,yn.zero(this.result)},e}(),q2=function(){function e(){this.refCount=0,this.accumulatedWeight=0,this.result=new On}var t=e.prototype;return t.blend=function(e,t){this.accumulatedWeight=e4(this.result,this.result,this.accumulatedWeight,e,t)},t.reset=function(){this.accumulatedWeight=0,On.identity(this.result)},e}(),X2=function(){function e(){this._transformApplyFlags=0,this._properties={}}var t=e.prototype;return t.refProperty=function(e,t){var n,i,r,o=this._properties;switch(t){default:case"position":case"scale":case"eulerAngles":r=null!==(n=o[t])&&void 0!==n?n:o[t]=this._createVec3BlendState(e[t]);break;case"rotation":r=null!==(i=o[t])&&void 0!==i?i:o[t]=this._createQuatBlendState(e.rotation)}return++r.refCount,r},t.deRefProperty=function(e){var t=this._properties,n=t[e];n&&(--n.refCount,n.refCount>0||delete t[e])},t.apply=function(e){var t,n,i,r=this._transformApplyFlags,o=this._properties,a=o.position,s=o.scale,c=o.rotation,l=o.eulerAngles;r&&(a&&r&z2.POSITION&&(t=a.result),s&&r&z2.SCALE&&(n=s.result),l&&r&z2.EULER_ANGLES&&(i=l.result),c&&r&z2.ROTATION&&(i=c.result),(i||t||n)&&e.setRTS(i,t,n),this._transformApplyFlags=0)},h(e,[{key:"empty",get:function(){var e=this._properties;return!(e.position||e.rotation||e.eulerAngles||e.scale)}}]),e}(),Y2=function(e){function t(){return e.apply(this,arguments)||this}f(t,e);var n=t.prototype;return n.apply=function(t){var n=this._properties,i=n.position,r=n.scale,o=n.rotation,a=n.eulerAngles;i&&i.accumulatedWeight&&(this._transformApplyFlags|=z2.POSITION,i.accumulatedWeight<1&&i.blend(t.position,1-i.accumulatedWeight)),r&&r.accumulatedWeight&&(this._transformApplyFlags|=z2.SCALE,r.accumulatedWeight<1&&r.blend(t.scale,1-r.accumulatedWeight)),a&&a.accumulatedWeight&&(this._transformApplyFlags|=z2.EULER_ANGLES,a.accumulatedWeight<1&&a.blend(t.eulerAngles,1-a.accumulatedWeight)),o&&o.accumulatedWeight&&(this._transformApplyFlags|=z2.ROTATION,o.accumulatedWeight<1&&o.blend(t.rotation,1-o.accumulatedWeight)),e.prototype.apply.call(this,t),null==i||i.reset(),null==r||r.reset(),null==o||o.reset(),null==a||a.reset()},n._createVec3BlendState=function(){return new j2},n._createQuatBlendState=function(){return new q2},t}(X2),K2=function(e){function t(){return e.apply(this,arguments)||this}return f(t,e),t.prototype.createNodeBlendState=function(){return new Y2},t}(U2),Q2=function(){function e(e){this.refCount=0,this.result=new yn,this._defaultValue=new yn,this._clipBlendResult=new yn,this._accumulatedWeight=0,yn.copy(this._defaultValue,e),yn.copy(this.result,e)}var t=e.prototype;return t.blend=function(e,t){this._accumulatedWeight=$2(this._clipBlendResult,this._clipBlendResult,this._accumulatedWeight,e,t)},t.commitLayerChange=function(e){var t=this.result,n=this._clipBlendResult,i=this._accumulatedWeight;i<1&&this.blend(this._defaultValue,1-i),yn.lerp(t,t,n,e),yn.zero(this._clipBlendResult),this._accumulatedWeight=0},t.reset=function(){yn.copy(this.result,this._defaultValue)},e}(),J2=function(){function e(e){this.refCount=0,this.result=new On,this._defaultValue=new On,this._clipBlendResult=new On,this._accumulatedWeight=0,On.copy(this._defaultValue,e),On.copy(this.result,e)}var t=e.prototype;return t.blend=function(e,t){this._accumulatedWeight=e4(this._clipBlendResult,this._clipBlendResult,this._accumulatedWeight,e,t)},t.commitLayerChange=function(e){var t=this.result,n=this._clipBlendResult,i=this._accumulatedWeight;i<1&&this.blend(this._defaultValue,1-i),On.slerp(t,t,n,e),On.identity(this._clipBlendResult),this._accumulatedWeight=0},t.reset=function(){On.copy(this.result,this._defaultValue)},e}(),Z2=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._layerMask=-1>>>0,t}f(t,e);var n=t.prototype;return n.setLayerMask=function(e){this._layerMask&=~(1<<e)},n.commitLayerChanges=function(e,t){if(this._layerMask&1<<e){var n=this._properties,i=n.position,r=n.scale,o=n.rotation,a=n.eulerAngles;i&&i.commitLayerChange(t),r&&r.commitLayerChange(t),o&&o.commitLayerChange(t),a&&a.commitLayerChange(t)}},n.apply=function(t){this._transformApplyFlags=W2,e.prototype.apply.call(this,t);var n=this._properties,i=n.position,r=n.scale,o=n.rotation,a=n.eulerAngles;null==i||i.reset(),null==r||r.reset(),null==o||o.reset(),null==a||a.reset()},n._createVec3BlendState=function(e){return new Q2(e)},n._createQuatBlendState=function(e){return new J2(e)},t}(X2);function $2(e,t,n,i,r){var o=n+r;if(1!==r||n){if(o){var a=r/o;yn.lerp(e,e,i,a)}}else yn.copy(e,i);return o}function e4(e,t,n,i,r){var o=n+r;if(1!==r||n){if(o){var a=r/o;On.slerp(e,t,i,a)}}else On.copy(e,i);return o}!function(e){function t(){return e.apply(this,arguments)||this}f(t,e);var n=t.prototype;n.setMask=function(e,t){this._nodeBlendStates.forEach((function(n,i){t.has(i)&&n.setLayerMask(e)}))},n.commitLayerChanges=function(e,t){this._nodeBlendStates.forEach((function(n){n.commitLayerChanges(e,t)}))},n.createNodeBlendState=function(){return new Z2}}(U2);var t4=e("AnimationManager",dc((V2=H2=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._anims=new ne([]),t._crossFades=new ne([]),t._delayEvents=[],t._blendStateBuffer=new K2,t._sockets=[],t}f(t,e);var n=t.prototype;return n.addCrossFade=function(e){-1===this._crossFades.array.indexOf(e)&&this._crossFades.push(e)},n.removeCrossFade=function(e){var t=this._crossFades.array.indexOf(e);t>=0?this._crossFades.fastRemoveAt(t):Y(3907)},n.update=function(e){var t=this._delayEvents,n=this._crossFades,i=this._sockets,r=n.array;for(n.i=0;n.i<r.length;++n.i)r[n.i].update(e);var o=this._anims,a=o.array;for(o.i=0;o.i<a.length;++o.i){var s=a[o.i];s.isMotionless||s.update(e)}this._blendStateBuffer.apply();for(var c=b.director.getTotalFrames(),l=0,u=i.length;l<u;l++){var h=i[l],_=h.target,f=h.transform;_.matrix=zJ(f,c)}for(var d=0,p=t.length;d<p;d++){var m=t[d];m.fn.apply(m.thisArg,m.args)}t.length=0},n.destruct=function(){},n.addAnimation=function(e){-1===this._anims.array.indexOf(e)&&this._anims.push(e)},n.removeAnimation=function(e){var t=this._anims.array.indexOf(e);t>=0?this._anims.fastRemoveAt(t):Y(3907)},n.pushDelayEvent=function(e,t,n){this._delayEvents.push({fn:e,thisArg:t,args:n})},n.addSockets=function(e,t){for(var n=this,i=function(i){var r=t[i];if(n._sockets.find((function(e){return e.target===r.target})))return"continue";var o=e.getChildByPath(r.path),a=r.target&&o&&UJ(o,e);a&&n._sockets.push({target:r.target,transform:a})},r=0;r<t.length;++r)i(r)},n.removeSockets=function(e,t){for(var n=0;n<t.length;++n)for(var i=t[n],r=0;r<this._sockets.length;++r){var o=this._sockets[r];if(o.target===i.target){kJ(o.transform.node),this._sockets[r]=this._sockets[this._sockets.length-1],this._sockets.length--;break}}},h(t,[{key:"blendState",get:function(){return this._blendStateBuffer}}]),t}(GO),H2.ID="animation",G2=V2))||G2);KO.on(YO.EVENT_INIT,(function(){var e=new t4;KO.registerSystem(t4.ID,e,GO.Priority.HIGH)})),b.AnimationManager=t4;var n4,i4=function(){function e(){this._isPlaying=!1,this._isPaused=!1,this._stepOnce=!1}var t=e.prototype;return t.play=function(){this._isPlaying?this._isPaused?(this._isPaused=!1,this.onResume()):this.onError(Z(3912)):(this._isPlaying=!0,this.onPlay())},t.stop=function(){this._isPlaying&&(this._isPlaying=!1,this.onStop(),this._isPaused=!1)},t.pause=function(){this._isPlaying&&!this._isPaused&&(this._isPaused=!0,this.onPause())},t.resume=function(){this._isPlaying&&this._isPaused&&(this._isPaused=!1,this.onResume())},t.step=function(){this.pause(),this._stepOnce=!0,this._isPlaying||this.play()},t.update=function(){},t.onPlay=function(){},t.onPause=function(){},t.onResume=function(){},t.onStop=function(){},t.onError=function(){},h(e,[{key:"isPlaying",get:function(){return this._isPlaying}},{key:"isPaused",get:function(){return this._isPaused}},{key:"isMotionless",get:function(){return!this.isPlaying||this.isPaused}}]),e}(),r4=function(){function e(e){this.weight=0,this._pose=void 0,this._blendStateWriters=[],this._pose=e}var t=e.prototype;return t.destroy=function(){for(var e=0;e<this._blendStateWriters.length;++e)this._pose.destroyWriter(this._blendStateWriters[e]);this._blendStateWriters.length=0},t.createPoseWriter=function(e,t,n){var i=this._pose.createWriter(e,t,this,n);return this._blendStateWriters.push(i),i},e}();!function(e){e.PLAY="play",e.STOP="stop",e.PAUSE="pause",e.RESUME="resume",e.LASTFRAME="lastframe",e.FINISHED="finished"}(n4||(n4={})),et(n4);var o4=e("AnimationState",function(e){function t(t,n){var i;return void 0===n&&(n=""),(i=e.call(this)||this).duration=1,i.speed=1,i.time=0,i.frameRate=0,i._targetNode=null,i._curveLoaded=!1,i._clip=void 0,i._useSimpleProcess=!1,i._target=null,i._wrapMode=Xs.Normal,i._repeatCount=1,i._delay=0,i._delayTime=0,i._currentFramePlayed=!1,i._name=void 0,i._lastIterations=NaN,i._lastWrapInfo=null,i._wrappedInfo=new $s,i._allowLastFrame=!1,i._blendStateWriterHost={weight:0},i._playbackDuration=0,i._invDuration=1,i._poseOutput=null,i._weight=1,i._clipEval=void 0,i._clipEventEval=void 0,i._doNotCreateEval=!1,i._clip=t,i._name=n||t&&t.name,i._playbackRange={min:0,max:t.duration},i._playbackDuration=t.duration,t.duration||U("Clip "+t.name+" has zero duration."),i}f(t,e);var n=t.prototype;return n.initialize=function(e,t,n){if(!this._curveLoaded){this._curveLoaded=!0,this._poseOutput&&(this._poseOutput.destroy(),this._poseOutput=null),this._clipEval&&(this._clipEval=void 0),this._targetNode=e;var i=this._clip;if(this.duration=i.duration,this._invDuration=1/this.duration,this.speed=i.speed,this.wrapMode=i.wrapMode,this.frameRate=i.sample,this._playbackRange.min=0,this._playbackRange.max=i.duration,this._playbackDuration=i.duration,(this.wrapMode&qs.Loop)===qs.Loop?this.repeatCount=1/0:this.repeatCount=1,!this._doNotCreateEval){var r,o,a,s=null!==(r=null!=t?t:null===(o=C2())||void 0===o?void 0:o.blendState)&&void 0!==r?r:null;s&&(this._poseOutput=new r4(s)),this._clipEval=i.createEvaluator({target:e,pose:null!==(a=this._poseOutput)&&void 0!==a?a:void 0,mask:n})}this._clipEventEval=i.createEventEvaluator(this._targetNode)}},n.destroy=function(){this.isMotionless||C2().removeAnimation(this),this._poseOutput&&(this._poseOutput.destroy(),this._poseOutput=null),this._clipEval=void 0},n.emit=function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];C2().pushDelayEvent(this._emit,this,t)},n.on=function(e,t,n){return this._target&&this._target.isValid?this._target.on(e,t,n):null},n.once=function(e,t,n){return this._target&&this._target.isValid?this._target.once(e,t,n):null},n.off=function(e,t,n){this._target&&this._target.isValid&&this._target.off(e,t,n)},n.allowLastFrameEvent=function(e){this._allowLastFrame=e},n._setEventTarget=function(e){this._target=e},n.setTime=function(e){this._currentFramePlayed=!1,this.time=e||0;var t,n=this.getWrappedInfo(e,this._wrappedInfo);null===(t=this._clipEventEval)||void 0===t||t.ignore(n.ratio,n.direction)},n.update=function(e){this._delayTime>0&&(this._delayTime-=e,this._delayTime>0)||(this._currentFramePlayed?this.time+=e*this.speed:this._currentFramePlayed=!0,this._process())},n.sample=function(){var e=this.getWrappedInfo(this.time,this._wrappedInfo);return this._sampleCurves(e.time),this._sampleEvents(e),e},n.onPlay=function(){this.setTime(this._getPlaybackStart()),this._delayTime=this._delay,this._onReplayOrResume(),this.emit(n4.PLAY,this)},n.onStop=function(){this.isPaused||this._onPauseOrStop(),this.emit(n4.STOP,this)},n.onResume=function(){this._onReplayOrResume(),this.emit(n4.RESUME,this)},n.onPause=function(){this._onPauseOrStop(),this.emit(n4.PAUSE,this)},n._sampleCurves=function(e){var t=this._poseOutput,n=this._clipEval;t&&(t.weight=this.weight),n&&n.evaluate(e)},n._process=function(){this._useSimpleProcess?this.simpleProcess():this.process()},n.process=function(){var e,t=this.sample();this._allowLastFrame&&(e=this._lastWrapInfo?this._lastWrapInfo:this._lastWrapInfo=new $s(t),this.repeatCount>1&&(0|t.iterations)>(0|e.iterations)&&this.emit(n4.LASTFRAME,this),e.set(t)),t.stopped&&(this.stop(),this.emit(n4.FINISHED,this))},n.simpleProcess=function(){var e=this._playbackRange.min,t=this._playbackDuration,n=this.time%t;n<0&&(n+=t);var i=(e+n)*this._invDuration;this._sampleCurves(e+n),this._sampleEvents(this.getWrappedInfo(this.time,this._wrappedInfo)),this._allowLastFrame&&(Number.isNaN(this._lastIterations)&&(this._lastIterations=i),(this.time>0&&this._lastIterations>i||this.time<0&&this._lastIterations<i)&&this.emit(n4.LASTFRAME,this),this._lastIterations=i)},n._needReverse=function(e){var t=this.wrapMode,n=!1;return(t&qs.PingPong)===qs.PingPong&&(e-(0|e)==0&&e>0&&(e-=1),1&e&&(n=!n)),(t&qs.Reverse)===qs.Reverse&&(n=!n),n},n.getWrappedInfo=function(e,t){t=t||new $s;var n=this._getPlaybackStart(),i=this._getPlaybackEnd()-n,r=!1,o=this.repeatCount,a=(e-=n)>0?e/i:-e/i;if(a>=o){a=o,r=!0;var s=o-(0|o);0===s&&(s=1),e=s*i*(e>0?1:-1)}if(e>i){var c=e%i;e=0===c?i:c}else e<0&&0!=(e%=i)&&(e+=i);var l=!1,u=this._wrapMode&qs.ShouldWrap;u&&(l=this._needReverse(a));var h=l?-1:1;return this.speed<0&&(h*=-1),u&&l&&(e=i-e),t.time=n+e,t.ratio=t.time/this.duration,t.direction=h,t.stopped=r,t.iterations=a,t},n._getPlaybackStart=function(){return this._playbackRange.min},n._getPlaybackEnd=function(){return this._playbackRange.max},n._sampleEvents=function(e){var t;null===(t=this._clipEventEval)||void 0===t||t.sample(e.ratio,e.direction,e.iterations)},n._emit=function(e,t){this._target&&this._target.isValid&&this._target.emit(e,e,t)},n._onReplayOrResume=function(){C2().addAnimation(this)},n._onPauseOrStop=function(){C2().removeAnimation(this)},h(t,[{key:"clip",get:function(){return this._clip}},{key:"name",get:function(){return this._name}},{key:"length",get:function(){return this.duration}},{key:"wrapMode",get:function(){return this._wrapMode},set:function(e){var t;this._wrapMode=e,this.time=0,e&qs.Loop?this.repeatCount=1/0:this.repeatCount=1,null===(t=this._clipEventEval)||void 0===t||t.setWrapMode(e)}},{key:"repeatCount",get:function(){return this._repeatCount},set:function(e){this._repeatCount=e;var t=this._wrapMode&qs.ShouldWrap,n=(this.wrapMode&qs.Reverse)===qs.Reverse;this._useSimpleProcess=e===1/0&&!t&&!n}},{key:"delay",get:function(){return this._delay},set:function(e){this._delayTime=this._delay=e}},{key:"playbackRange",get:function(){return this._playbackRange},set:function(e){e.max,e.min,this._playbackRange.min=Math.max(e.min,0),this._playbackRange.max=Math.min(e.max,this.duration),this._playbackDuration=this._playbackRange.max-this._playbackRange.min,this.setTime(0)}},{key:"current",get:function(){return this.getWrappedInfo(this.time).time}},{key:"ratio",get:function(){return this.current/this.duration}},{key:"weight",get:function(){return this._weight},set:function(e){this._weight=e,this._poseOutput&&(this._poseOutput.weight=e)}},{key:"curveLoaded",get:function(){return this._curveLoaded}}]),t}(i4));b.AnimationState=o4;var a4,s4,c4,l4,u4,h4,_4,f4,d4,p4,m4,v4,g4,y4,x4,S4,E4,T4,C4,b4,A4,w4=function(e){function t(t){var n;return(n=e.call(this)||this)._managedStates=[],n._fadings=[],n._scheduled=!1,n._scheduler=null!=t?t:C2(),n}f(t,e);var n=t.prototype;return n.update=function(e){if(!this.isMotionless){var t=this._managedStates,n=this._fadings;if(1===t.length&&1===n.length){var i=t[0].state;i&&(i.weight=1)}else this._calculateWeights(e);1===t.length&&1===n.length&&this._unscheduleThis()}},n.crossFade=function(e,t){var n;0===this._managedStates.length&&(t=0),0===t&&this.clear();var i=this._managedStates.find((function(t){return t.state===e}));i?(null===(n=i.state)||void 0===n?void 0:n.isMotionless)&&i.state.play():(i={state:e,reference:0},e&&e.play(),this._managedStates.push(i)),++i.reference,this._fadings.unshift({easeDuration:t,easeTime:0,target:i}),this.isMotionless||this._scheduleThis()},n.clear=function(){for(var e=0;e<this._managedStates.length;++e){var t=this._managedStates[e].state;t&&t.stop()}this._managedStates.length=0,this._fadings.length=0},n.onPlay=function(){e.prototype.onPlay.call(this),this._scheduleThis()},n.onPause=function(){e.prototype.onPause.call(this);for(var t=0;t<this._managedStates.length;++t){var n=this._managedStates[t].state;n&&n.pause()}this._unscheduleThis()},n.onResume=function(){e.prototype.onResume.call(this);for(var t=0;t<this._managedStates.length;++t){var n=this._managedStates[t].state;n&&n.resume()}this._scheduleThis()},n.onStop=function(){e.prototype.onStop.call(this),this.clear()},n._calculateWeights=function(e){for(var t=this._managedStates,n=this._fadings,i=0;i<t.length;++i){var r=t[i].state;r&&(r.weight=0)}for(var o=1,a=n.length,s=0;s<n.length;++s){var c=n[s];c.easeTime+=e;var l=0===c.easeDuration?1:tn(c.easeTime/c.easeDuration),u=l*o;if(o*=1-l,c.target.state&&(c.target.state.weight+=u),c.easeTime>=c.easeDuration){a=s+1,c.easeTime=c.easeDuration;break}}if(a!==n.length){for(var h=a;h<n.length;++h){var _=n[h];--_.target.reference,_.target.reference<=0&&(_.target.state&&_.target.state.stop(),oe(this._managedStates,_.target))}n.splice(a)}},n._scheduleThis=function(){this._scheduled||(this._scheduler.addCrossFade(this),this._scheduled=!0)},n._unscheduleThis=function(){this._scheduled&&(this._scheduler.removeCrossFade(this),this._scheduled=!1)},t}(i4),I4=(a4=dc("cc.Animation"),s4=Oc(),c4=mc(99),l4=Ic(),u4=Jc([w2]),h4=Bc(),_4=Jc(w2),f4=Bc(),d4=Bc(),p4=Jc([w2]),T4=a4(m4=s4(m4=c4(m4=wc(m4=l4((E4=S4=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return E(t=e.call.apply(e,[this].concat(i))||this,"playOnLoad",g4,y(t)),t._crossFade=new w4,t._nameToState=xe(!0),E(t,"_clips",y4,y(t)),E(t,"_defaultClip",x4,y(t)),t._hasBeenPlayed=!1,t}f(t,e);var n=t.prototype;return n.onLoad=function(){for(var e in this.clips=this._clips,this._nameToState)this._nameToState[e].initialize(this.node)},n.start=function(){this.playOnLoad&&!this._hasBeenPlayed&&this._defaultClip&&this.crossFade(this._defaultClip.name,0)},n.onEnable=function(){this._crossFade.resume()},n.onDisable=function(){this._crossFade.pause()},n.onDestroy=function(){for(var e in this._crossFade.stop(),this._nameToState)this._nameToState[e].destroy();this._nameToState=xe(!0)},n.play=function(e){if(this._hasBeenPlayed=!0,!e){if(!this._defaultClip)return;e=this._defaultClip.name}this.crossFade(e,0)},n.crossFade=function(e,t){void 0===t&&(t=.3),this._hasBeenPlayed=!0;var n=this._nameToState[e];n&&this.doPlayOrCrossFade(n,t)},n.pause=function(){this._crossFade.pause()},n.resume=function(){this._crossFade.resume()},n.stop=function(){this._crossFade.stop()},n.getState=function(e){var t=this._nameToState[e];return t&&!t.curveLoaded&&t.initialize(this.node),t||null},n.createState=function(e,t){return t=t||e.name,this.removeState(t),this._doCreateState(e,t)},n.removeState=function(e){var t=this._nameToState[e];t&&(t.allowLastFrameEvent(!1),t.stop(),delete this._nameToState[e])},n.addClip=function(e,t){return ae(this._clips,e)||this._clips.push(e),this.createState(e,t)},n.removeClip=function(e,t){var n;for(var i in this._nameToState){var r=this._nameToState[i];if(r.clip===e){n=r;break}}if(e===this._defaultClip){if(!t)return void q(3902);this._defaultClip=null}if(n&&n.isPlaying){if(!t)return void q(3903);n.stop()}this._clips=this._clips.filter((function(t){return t!==e})),n&&delete this._nameToState[n.name]},n.on=function(t,n,i,r){var o=e.prototype.on.call(this,t,n,i,r);return t===n4.LASTFRAME&&this._syncAllowLastFrameEvent(),o},n.once=function(t,n,i){var r=e.prototype.once.call(this,t,n,i);return t===n4.LASTFRAME&&this._syncAllowLastFrameEvent(),r},n.off=function(t,n,i){e.prototype.off.call(this,t,n,i),t===n4.LASTFRAME&&this._syncDisallowLastFrameEvent()},n._createState=function(e,t){return new o4(e,t)},n._doCreateState=function(e,t){var n=this._createState(e,t);return n._setEventTarget(this),n.allowLastFrameEvent(this.hasEventListener(n4.LASTFRAME)),this.node&&n.initialize(this.node),this._nameToState[n.name]=n,n},n.doPlayOrCrossFade=function(e,t){this._crossFade.play(),this._crossFade.crossFade(e,t)},n._removeStateOfAutomaticClip=function(e){for(var t in this._nameToState){var n=this._nameToState[t];P4(e,n.clip)&&(n.stop(),delete this._nameToState[t])}},n._syncAllowLastFrameEvent=function(){if(this.hasEventListener(n4.LASTFRAME))for(var e in this._nameToState)this._nameToState[e].allowLastFrameEvent(!0)},n._syncDisallowLastFrameEvent=function(){if(!this.hasEventListener(n4.LASTFRAME))for(var e in this._nameToState)this._nameToState[e].allowLastFrameEvent(!1)},h(t,[{key:"clips",get:function(){return this._clips},set:function(e){var t=this;this._crossFade&&this._crossFade.clear();for(var n,i=S(this._clips);!(n=i()).done;){var r=n.value;r&&this._removeStateOfAutomaticClip(r)}for(var o,a=S(e);!(o=a()).done;){var s=o.value;s&&this.createState(s)}var c=e.find((function(e){return P4(e,t._defaultClip)}));this._defaultClip=c||null,this._clips=e}},{key:"defaultClip",get:function(){return this._defaultClip},set:function(e){this._defaultClip=e,e&&(this._clips.findIndex((function(t){return P4(t,e)}))>=0||(this._clips.push(e),this.createState(e)))}}]),t}(Wl(ku)),S4.EventType=n4,T((v4=E4).prototype,"clips",[u4,h4],Object.getOwnPropertyDescriptor(v4.prototype,"clips"),v4.prototype),T(v4.prototype,"defaultClip",[_4,f4],Object.getOwnPropertyDescriptor(v4.prototype,"defaultClip"),v4.prototype),g4=T(v4.prototype,"playOnLoad",[Ec,d4],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),y4=T(v4.prototype,"_clips",[p4],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),x4=T(v4.prototype,"_defaultClip",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),m4=v4))||m4)||m4)||m4)||m4)||m4,e({Animation:T4,AnimationComponent:T4}),T4);function P4(e,t){return e===t||!!e&&!!t&&e._uuid===t._uuid&&e._uuid}b.Animation=I4,b.AnimationComponent=I4,Ke.setClassAlias(I4,"cc.AnimationComponent"),b.easing=G_,function(e){e.PLAYED="play",e.PAUSED="pause",e.STOPPED="stop",e.SEEKED="seeked",e.ENDED="ended",e.INTERRUPTION_BEGIN="interruptionBegin",e.INTERRUPTION_END="interruptionEnd",e.USER_GESTURE="on_gesture"}(C4||(C4={})),function(e){e[e.DOM_AUDIO=0]="DOM_AUDIO",e[e.WEB_AUDIO=1]="WEB_AUDIO",e[e.MINIGAME_AUDIO=2]="MINIGAME_AUDIO",e[e.NATIVE_AUDIO=3]="NATIVE_AUDIO",e[e.UNKNOWN_AUDIO=4]="UNKNOWN_AUDIO"}(b4||(b4={})),function(e){e[e.INIT=0]="INIT",e[e.PLAYING=1]="PLAYING",e[e.PAUSED=2]="PAUSED",e[e.STOPPED=3]="STOPPED",e[e.INTERRUPTED=4]="INTERRUPTED"}(A4||(A4={}));var R4,D4=0;function O4(e,t){var n;t.invoking||(t.invoking=!0,(n=t.func).call.apply(n,[e].concat(t.args)).then((function(){t.invoking=!1,e._operationQueue.shift(),e._eventTarget.emit(t.id.toString());var n=e._operationQueue[0];n&&O4(e,n)})).catch((function(){})))}function N4(e,t,n){var i=n.value;n.value=function(){for(var e=this,t=arguments.length,n=new Array(t),r=0;r<t;r++)n[r]=arguments[r];return new Promise((function(t){var r=D4++,o=e;o._operationQueue.push({id:r,func:i,args:n,invoking:!1}),o._eventTarget.once(r.toString(),t),O4(o,o._operationQueue[0])}))}}function M4(e){return new Promise((function(t){var n=e.play();return void 0===n?t():(n.then(t).catch((function(){var n=function(){e.play().catch((function(){})),t()},i=document.getElementById("GameCanvas");null==i||i.addEventListener("touchend",n,{once:!0}),null==i||i.addEventListener("mousedown",n,{once:!0})})),null)}))}var L4,F4,B4=function(){function e(e,t){this._domAudio=void 0,this._onPlayCb=void 0,this._onEndCb=void 0,this._domAudio=e,e.volume=t}var t=e.prototype;return t.play=function(){var e=this;M4(this._domAudio).then((function(){var t;null===(t=e.onPlay)||void 0===t||t.call(e)})).catch((function(){}))},t.stop=function(){this._domAudio.pause()},h(e,[{key:"onPlay",get:function(){return this._onPlayCb},set:function(e){this._onPlayCb=e}},{key:"onEnd",get:function(){return this._onEndCb},set:function(e){this._onEndCb&&this._domAudio.removeEventListener("ended",this._onEndCb),this._onEndCb=e,e&&this._domAudio.addEventListener("ended",e)}}]),e}(),z4=(T((R4=function(){function e(e){var t=this;this._domAudio=void 0,this._state=A4.INIT,this._onEnded=void 0,this._eventTarget=new Jl,this._operationQueue=[],this._domAudio=e,nu.on("hide",this._onHide,this),nu.on("show",this._onShow,this),this._onEnded=function(){t.seek(0).catch((function(){})),t._state=A4.INIT,t._eventTarget.emit(C4.ENDED)},this._domAudio.addEventListener("ended",this._onEnded)}var t=e.prototype;return t.destroy=function(){nu.off("hide",this._onHide,this),nu.off("show",this._onShow,this),this._domAudio.removeEventListener("ended",this._onEnded),this._domAudio=null},e.load=function(t){return new Promise((function(n){e.loadNative(t).then((function(t){n(new e(t))})).catch((function(){}))}))},e.loadNative=function(e){return new Promise((function(t,n){var i=document.createElement("audio"),r="canplaythrough";nu.os===Yl.IOS?r="loadedmetadata":nu.browserType===jl.FIREFOX&&(r="canplay");var o=setTimeout((function(){0===i.readyState?c():s()}),8e3),a=function(){clearTimeout(o),i.removeEventListener(r,s,!1),i.removeEventListener("error",c,!1)},s=function(){a(),t(i)},c=function(){a(),n("load audio failure - "+e)};i.addEventListener(r,s,!1),i.addEventListener("error",c,!1),i.src=e}))},e.loadOneShotAudio=function(t,n){return new Promise((function(i,r){e.loadNative(t).then((function(e){var t=new B4(e,n);i(t)})).catch(r)}))},t._onHide=function(){var e=this;this._state===A4.PLAYING&&this.pause().then((function(){e._state=A4.INTERRUPTED,e._eventTarget.emit(C4.INTERRUPTION_BEGIN)})).catch((function(){}))},t._onShow=function(){var e=this;this._state===A4.INTERRUPTED&&this.play().then((function(){e._eventTarget.emit(C4.INTERRUPTION_END)})).catch((function(){}))},t.seek=function(e){return e=en(e,0,this.duration),this._domAudio.currentTime=e,Promise.resolve()},t.play=function(){var e=this;return new Promise((function(t){M4(e._domAudio).then((function(){e._state=A4.PLAYING,t()})).catch((function(){}))}))},t.pause=function(){return this._domAudio.pause(),this._state=A4.PAUSED,Promise.resolve()},t.stop=function(){var e=this;return new Promise((function(t){e._domAudio.pause(),e._domAudio.currentTime=0,e._state=A4.STOPPED,t()}))},t.onInterruptionBegin=function(e){this._eventTarget.on(C4.INTERRUPTION_BEGIN,e)},t.offInterruptionBegin=function(e){this._eventTarget.off(C4.INTERRUPTION_BEGIN,e)},t.onInterruptionEnd=function(e){this._eventTarget.on(C4.INTERRUPTION_END,e)},t.offInterruptionEnd=function(e){this._eventTarget.off(C4.INTERRUPTION_END,e)},t.onEnded=function(e){this._eventTarget.on(C4.ENDED,e)},t.offEnded=function(e){this._eventTarget.off(C4.ENDED,e)},h(e,[{key:"src",get:function(){return this._domAudio?this._domAudio.src:""}},{key:"type",get:function(){return b4.DOM_AUDIO}},{key:"state",get:function(){return this._state}},{key:"loop",get:function(){return this._domAudio.loop},set:function(e){this._domAudio.loop=e}},{key:"volume",get:function(){return this._domAudio.volume},set:function(e){e=tn(e),this._domAudio.volume=e}},{key:"duration",get:function(){return this._domAudio.duration}},{key:"currentTime",get:function(){return this._domAudio.currentTime}}]),e}()).prototype,"seek",[N4],Object.getOwnPropertyDescriptor(R4.prototype,"seek"),R4.prototype),T(R4.prototype,"play",[N4],Object.getOwnPropertyDescriptor(R4.prototype,"play"),R4.prototype),T(R4.prototype,"pause",[N4],Object.getOwnPropertyDescriptor(R4.prototype,"pause"),R4.prototype),T(R4.prototype,"stop",[N4],Object.getOwnPropertyDescriptor(R4.prototype,"stop"),R4.prototype),R4),U4=function(){function e(e){this._nativeAudio=void 0,this._startTime=0,this._startOffset=0,this._isPaused=!0,this._nativeAudio=e}var t=e.prototype;return t.destroy=function(){this._nativeAudio=void 0},t._now=function(){return performance.now()/1e3},t._calculateCurrentTime=function(){var e=this._now()-this._startTime,t=this._startOffset+e;return t>=this.duration&&(this._startTime=this._now(),this._startOffset=0),t%this.duration},t.start=function(){this._isPaused=!1,this._startTime=this._now()},t.pause=function(){this._isPaused||(this._isPaused=!0,this._startOffset=this._calculateCurrentTime())},t.stop=function(){this._isPaused=!0,this._startOffset=0},t.seek=function(e){this._startTime=this._now(),this._startOffset=en(e,0,this.duration)},h(e,[{key:"duration",get:function(){return this._nativeAudio.duration}},{key:"currentTime",get:function(){return this._isPaused?this._startOffset:this._calculateCurrentTime()}}]),e}(),k4=new(function(){function e(){this._audioBufferDataMap={}}var t=e.prototype;return t.addCache=function(e,t){this._audioBufferDataMap[e]?console.warn("Audio buffer "+e+" has been cached"):this._audioBufferDataMap[e]={usedCount:1,audioBuffer:t}},t.retainCache=function(e){var t=this._audioBufferDataMap[e];t?t.usedCount++:console.warn("Audio buffer cache "+e+" has not been added.")},t.getCache=function(e){var t=this._audioBufferDataMap[e];return null==t?void 0:t.audioBuffer},t.tryReleasingCache=function(e){var t=this._audioBufferDataMap[e];t?--t.usedCount<=0&&delete this._audioBufferDataMap[e]:console.warn("Audio buffer cache "+e+" has not been added.")},e}()),G4=window.AudioContext||window.webkitAudioContext||window.mozAudioContext,H4=function(){function e(){this._context=void 0,this._context=new(window.AudioContext||window.webkitAudioContext||window.mozAudioContext)}var t=e.prototype;return t.decodeAudioData=function(e){var t=this;return new Promise((function(n){var i=t._context.decodeAudioData(e,(function(e){n(e)}),(function(e){console.error("failed to load Web Audio",e)}));null==i||i.catch((function(){}))}))},t.runContext=function(){var e=this;return new Promise((function(t){var n=e._context;if(n.resume)if("running"!==n.state){var i=document.getElementById("GameCanvas"),r=function(){n.resume().then(t).catch((function(){}))};null==i||i.addEventListener("touchend",r,{once:!0,capture:!0}),null==i||i.addEventListener("mouseup",r,{once:!0,capture:!0})}else t();else t()}))},t.createBufferSource=function(e,t){var n=this._context.createBufferSource();return void 0!==e&&(n.buffer=e),void 0!==t&&(n.loop=t),n},t.createGain=function(e){void 0===e&&(e=1);var t=this._context.createGain();return this.setGainValue(t,e),t},t.setGainValue=function(e,t){if(e.gain.setTargetAtTime)try{e.gain.setTargetAtTime(t,this._context.currentTime,0)}catch(n){e.gain.setTargetAtTime(t,this._context.currentTime,.01)}else e.gain.value=t},t.connectContext=function(e){this._context&&e.connect(this._context.destination)},h(e,[{key:"currentTime",get:function(){return this._context.currentTime}}]),e}();H4.support=!!G4,H4.support&&(F4=new H4);var V4,W4,j4,q4,X4,Y4=function(){function e(e,t,n){this._duration=void 0,this._bufferSourceNode=void 0,this._onPlayCb=void 0,this._currentTimer=0,this._url=void 0,this._onEndCb=void 0,this._duration=e.duration,this._url=n,this._bufferSourceNode=F4.createBufferSource(e,!1);var i=F4.createGain(t);this._bufferSourceNode.connect(i),F4.connectContext(i)}var t=e.prototype;return t.play=function(){var e=this;this._bufferSourceNode.start(),F4.runContext().then((function(){var t;null===(t=e.onPlay)||void 0===t||t.call(e),e._currentTimer=window.setTimeout((function(){var t;k4.tryReleasingCache(e._url),null===(t=e.onEnd)||void 0===t||t.call(e)}),1e3*e._duration)})).catch((function(){}))},t.stop=function(){clearTimeout(this._currentTimer),k4.tryReleasingCache(this._url),this._bufferSourceNode.stop(),this._bufferSourceNode.buffer=null},h(e,[{key:"onPlay",get:function(){return this._onPlayCb},set:function(e){this._onPlayCb=e}},{key:"onEnd",get:function(){return this._onEndCb},set:function(e){this._onEndCb=e}}]),e}(),K4=(T((L4=function(){function e(e,t){this._src=void 0,this._audioBuffer=void 0,this._sourceNode=void 0,this._gainNode=void 0,this._currentTimer=0,this._volume=1,this._loop=!1,this._state=A4.INIT,this._audioTimer=void 0,this._eventTarget=new Jl,this._operationQueue=[],this._audioBuffer=e,this._audioTimer=new U4(e),this._gainNode=F4.createGain(),F4.connectContext(this._gainNode),this._src=t,nu.on("hide",this._onHide,this),nu.on("show",this._onShow,this)}var t=e.prototype;return t.destroy=function(){this._audioTimer.destroy(),this._audioBuffer&&(this._audioBuffer=null),k4.tryReleasingCache(this._src),nu.off("hide",this._onHide,this),nu.off("show",this._onShow,this)},e.load=function(t){return new Promise((function(n){e.loadNative(t).then((function(i){n(new e(i,t))})).catch((function(){}))}))},e.loadNative=function(e){return new Promise((function(t,n){var i=k4.getCache(e);if(i)return k4.retainCache(e),void t(i);var r=new XMLHttpRequest,o="load audio failed: "+e+", status: ";r.open("GET",e,!0),r.responseType="arraybuffer",r.onload=function(){200===r.status||0===r.status?F4.decodeAudioData(r.response).then((function(n){k4.addCache(e,n),t(n)})).catch((function(){})):n(new Error(""+o+r.status+"(no response)"))},r.onerror=function(){n(new Error(""+o+r.status+"(error)"))},r.ontimeout=function(){n(new Error(""+o+r.status+"(time out)"))},r.onabort=function(){n(new Error(""+o+r.status+"(abort)"))},r.send(null)}))},e.loadOneShotAudio=function(t,n){return new Promise((function(i,r){e.loadNative(t).then((function(e){var r=new Y4(e,n,t);i(r)})).catch(r)}))},t._onHide=function(){var e=this;this._state===A4.PLAYING&&this.pause().then((function(){e._state=A4.INTERRUPTED,e._eventTarget.emit(C4.INTERRUPTION_BEGIN)})).catch((function(){}))},t._onShow=function(){var e=this;this._state===A4.INTERRUPTED&&this.play().then((function(){e._eventTarget.emit(C4.INTERRUPTION_END)})).catch((function(){}))},t.seek=function(e){var t=this;return new Promise((function(n){t._audioTimer.seek(e),t._state===A4.PLAYING?t._doPlay().then(n).catch((function(){})):n()}))},t.play=function(){return this._doPlay()},t._doPlay=function(){var e=this;return new Promise((function(t){e._stopSourceNode(),e._sourceNode=F4.createBufferSource(e._audioBuffer,e.loop),e._sourceNode.connect(e._gainNode),e._sourceNode.start(0,e._audioTimer.currentTime),F4.runContext().then((function(){e._state=A4.PLAYING,e._audioTimer.start(),window.clearTimeout(e._currentTimer),e._currentTimer=window.setTimeout((function t(){e.loop?e._currentTimer=window.setTimeout(t,1e3*e._audioBuffer.duration):(e._audioTimer.stop(),e._eventTarget.emit(C4.ENDED),e._state=A4.INIT)}),1e3*(e._audioBuffer.duration-e._audioTimer.currentTime)),t()})).catch((function(){}))}))},t._stopSourceNode=function(){try{this._sourceNode&&(this._sourceNode.stop(),this._sourceNode.buffer=null)}catch(e){}},t.pause=function(){return this._state===A4.PLAYING&&this._sourceNode?(this._audioTimer.pause(),this._state=A4.PAUSED,window.clearTimeout(this._currentTimer),this._stopSourceNode(),Promise.resolve()):Promise.resolve()},t.stop=function(){return this._sourceNode?(this._audioTimer.stop(),this._state=A4.STOPPED,window.clearTimeout(this._currentTimer),this._stopSourceNode(),Promise.resolve()):Promise.resolve()},t.onInterruptionBegin=function(e){this._eventTarget.on(C4.INTERRUPTION_BEGIN,e)},t.offInterruptionBegin=function(e){this._eventTarget.off(C4.INTERRUPTION_BEGIN,e)},t.onInterruptionEnd=function(e){this._eventTarget.on(C4.INTERRUPTION_END,e)},t.offInterruptionEnd=function(e){this._eventTarget.off(C4.INTERRUPTION_END,e)},t.onEnded=function(e){this._eventTarget.on(C4.ENDED,e)},t.offEnded=function(e){this._eventTarget.off(C4.ENDED,e)},h(e,[{key:"src",get:function(){return this._src}},{key:"type",get:function(){return b4.WEB_AUDIO}},{key:"state",get:function(){return this._state}},{key:"loop",get:function(){return this._loop},set:function(e){this._loop=e,this._sourceNode&&(this._sourceNode.loop=e)}},{key:"volume",get:function(){return this._volume},set:function(e){e=tn(e),this._volume=e,F4.setGainValue(this._gainNode,e)}},{key:"duration",get:function(){return this._audioBuffer.duration}},{key:"currentTime",get:function(){return this._audioTimer.currentTime}}]),e}()).prototype,"seek",[N4],Object.getOwnPropertyDescriptor(L4.prototype,"seek"),L4.prototype),T(L4.prototype,"play",[N4],Object.getOwnPropertyDescriptor(L4.prototype,"play"),L4.prototype),T(L4.prototype,"pause",[N4],Object.getOwnPropertyDescriptor(L4.prototype,"pause"),L4.prototype),T(L4.prototype,"stop",[N4],Object.getOwnPropertyDescriptor(L4.prototype,"stop"),L4.prototype),L4),Q4=function(){function e(e){this._audio=void 0,this._audio=e}var t=e.prototype;return t.play=function(){this._audio.play()},t.stop=function(){this._audio.stop()},h(e,[{key:"onPlay",get:function(){return this._audio.onPlay},set:function(e){this._audio.onPlay=e}},{key:"onEnd",get:function(){return this._audio.onEnd},set:function(e){this._audio.onEnd=e}}]),e}(),J4=function(){function e(e){this._player=void 0,this._player=e}e.load=function(t,n){return new Promise((function(i){(null==n?void 0:n.audioLoadMode)!==b4.DOM_AUDIO&&H4.support?K4.load(t).then((function(t){i(new e(t))})).catch((function(){})):(H4.support||q(5201),z4.load(t).then((function(t){i(new e(t))})).catch((function(){})))}))};var t=e.prototype;return t.destroy=function(){this._player.destroy()},e.loadNative=function(e,t){return(null==t?void 0:t.audioLoadMode)!==b4.DOM_AUDIO&&H4.support?K4.loadNative(e):(H4.support||q(5201),z4.loadNative(e))},e.loadOneShotAudio=function(e,t,n){return new Promise((function(i,r){(null==n?void 0:n.audioLoadMode)!==b4.DOM_AUDIO&&H4.support?K4.loadOneShotAudio(e,t).then((function(e){i(new Q4(e))})).catch(r):(H4.support||q(5201),z4.loadOneShotAudio(e,t).then((function(e){i(new Q4(e))})).catch(r))}))},t.seek=function(e){return this._player.seek(e)},t.play=function(){return this._player.play()},t.pause=function(){return this._player.pause()},t.stop=function(){return this._player.stop()},t.onInterruptionBegin=function(e){this._player.onInterruptionBegin(e)},t.offInterruptionBegin=function(e){this._player.offInterruptionBegin(e)},t.onInterruptionEnd=function(e){this._player.onInterruptionEnd(e)},t.offInterruptionEnd=function(e){this._player.offInterruptionEnd(e)},t.onEnded=function(e){this._player.onEnded(e)},t.offEnded=function(e){this._player.offEnded(e)},h(e,[{key:"src",get:function(){return this._player.src}},{key:"type",get:function(){return this._player.type}},{key:"state",get:function(){return this._player.state}},{key:"loop",get:function(){return this._player.loop},set:function(e){this._player.loop=e}},{key:"volume",get:function(){return this._player.volume},set:function(e){this._player.volume=e}},{key:"duration",get:function(){return this._player.duration}},{key:"currentTime",get:function(){return this._player.currentTime}}]),e}();J4.maxAudioChannel=24;var Z4=e("AudioClip",dc("cc.AudioClip")((X4=q4=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return E(t=e.call.apply(e,[this].concat(i))||this,"_duration",j4,y(t)),t._loadMode=b4.UNKNOWN_AUDIO,t._meta=null,t._player=null,t}f(t,e);var n=t.prototype;return n.destroy=function(){var t,n=e.prototype.destroy.call(this);return null===(t=this._player)||void 0===t||t.destroy(),this._player=null,this._meta&&(this._meta.player=null),n},n.validate=function(){return!!this._meta},n.getDuration=function(){return this._duration?this._duration:this._meta?this._meta.duration:0},n.getCurrentTime=function(){return this._player?this._player.currentTime:0},n.getVolume=function(){return this._player?this._player.volume:0},n.getLoop=function(){return!!this._player&&this._player.loop},n.setCurrentTime=function(e){var t;null===(t=this._player)||void 0===t||t.seek(e).catch((function(){}))},n.setVolume=function(e){this._player&&(this._player.volume=e)},n.setLoop=function(e){this._player&&(this._player.loop=e)},n.play=function(){var e;null===(e=this._player)||void 0===e||e.play().catch((function(){}))},n.pause=function(){var e;null===(e=this._player)||void 0===e||e.pause().catch((function(){}))},n.stop=function(){var e;null===(e=this._player)||void 0===e||e.stop().catch((function(){}))},n.playOneShot=function(e){void 0===e&&(e=1),this._nativeAsset&&J4.loadOneShotAudio(this._nativeAsset.url,e).then((function(e){e.play()})).catch((function(){}))},h(t,[{key:"_nativeAsset",get:function(){return this._meta},set:function(e){this._meta=e,e?(this._loadMode=e.type,this._player=e.player):(this._meta=null,this._loadMode=b4.UNKNOWN_AUDIO,this._duration=0)}},{key:"_nativeDep",get:function(){return{uuid:this._uuid,audioLoadMode:this.loadMode,ext:this._native,__isNative__:!0}}},{key:"loadMode",get:function(){return this._loadMode}},{key:"state",get:function(){return this._player?this._player.state:A4.INIT}}]),t}(yu),q4.AudioType=b4,j4=T((W4=X4).prototype,"_duration",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),T(W4.prototype,"_nativeDep",[$c],Object.getOwnPropertyDescriptor(W4.prototype,"_nativeDep"),W4.prototype),V4=W4))||V4);function $4(e,t,n){J4.load(e,{audioLoadMode:t.audioLoadMode}).then((function(t){var i={player:t,url:e,duration:t.duration,type:t.type};n(null,i)})).catch((function(e){n(e)}))}function e3(e,t,n,i){var r=new Z4;r._nativeUrl=e,r._nativeAsset=t,r._duration=t.duration,i(null,r)}b.AudioClip=Z4,IN.register({".mp3":$4,".ogg":$4,".wav":$4,".m4a":$4}),LN.register({".mp3":e3,".ogg":e3,".wav":e3,".m4a":e3});var t3,n3,i3,r3,o3,a3,s3,c3,l3,u3,h3,_3,f3,d3,p3,m3,v3,g3,y3,x3=new(function(){function e(){this._oneShotAudioInfoList=[],this._audioPlayerInfoList=[]}var t=e.prototype;return t._findIndex=function(e,t){return e.findIndex((function(e){return e.audio===t}))},t._tryAddPlaying=function(e,t){var n=this._findIndex(e,t);return n>-1?(e[n].playTime=performance.now(),!1):(e.push({audio:t,playTime:performance.now()}),!0)},t.addPlaying=function(e){if(e instanceof J4){if(this._tryAddPlaying(this._audioPlayerInfoList,e))return}else this._tryAddPlaying(this._oneShotAudioInfoList,e)},t._tryRemovePlaying=function(e,t){var n=this._findIndex(e,t);return-1!==n&&(re(e,n),!0)},t.removePlaying=function(e){if(e instanceof J4){if(this._tryRemovePlaying(this._audioPlayerInfoList,e))return}else this._tryRemovePlaying(this._oneShotAudioInfoList,e)},t.discardOnePlayingIfNeeded=function(){var e;this._audioPlayerInfoList.length+this._oneShotAudioInfoList.length<J4.maxAudioChannel||(this._oneShotAudioInfoList.length>0?this._oneShotAudioInfoList.forEach((function(t){(!e||t.playTime<e.playTime)&&(e=t)})):this._audioPlayerInfoList.forEach((function(t){(!e||t.playTime<e.playTime)&&(e=t)})),e&&(e.audio.stop(),this.removePlaying(e.audio)))},e}());!function(e){e.STARTED="started",e.ENDED="ended"}(y3||(y3={}));var S3=function(t){return e({AudioSource:t,AudioSourceComponent:t}),t}((t3=dc("cc.AudioSource"),n3=Oc(),i3=Ic(),r3=Jc(Z4),o3=Jc(Z4),a3=Bc(),s3=Bc(),c3=Bc(),l3=zc(),u3=Bc(),t3(h3=n3(h3=i3((g3=v3=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return E(t=e.call.apply(e,[this].concat(i))||this,"_clip",f3,y(t)),t._player=null,E(t,"_loop",d3,y(t)),E(t,"_playOnAwake",p3,y(t)),E(t,"_volume",m3,y(t)),t._cachedCurrentTime=0,t._operationsBeforeLoading=[],t._isLoaded=!1,t._lastSetClip=null,t}f(t,e);var n=t.prototype;return n._syncPlayer=function(){var e=this,t=this._clip;this._isLoaded=!1,this._lastSetClip!==t&&(t?t._nativeAsset?(this._lastSetClip=t,J4.load(t._nativeAsset.url,{audioLoadMode:t.loadMode}).then((function(n){e._lastSetClip===t?(e._isLoaded=!0,e._player&&(x3.removePlaying(e._player),e._player.offEnded(),e._player.offInterruptionBegin(),e._player.offInterruptionEnd(),e._player.destroy()),e._player=n,n.onEnded((function(){x3.removePlaying(n),e.node.emit(y3.ENDED,e)})),n.onInterruptionBegin((function(){x3.removePlaying(n)})),n.onInterruptionEnd((function(){x3.addPlaying(n)})),e._syncStates()):n.destroy()})).catch((function(){}))):console.error("Invalid audio clip"):this._lastSetClip=null)},n.onLoad=function(){this._syncPlayer()},n.onEnable=function(){this._playOnAwake&&!this.playing&&this.play()},n.onDisable=function(){var e=this._getRootNode();(null==e?void 0:e._persistNode)||this.pause()},n.onDestroy=function(){var e;this.stop(),null===(e=this._player)||void 0===e||e.destroy(),this._player=null},n._getRootNode=function(){for(var e,t,n=this.node,i=null===(e=n)||void 0===e||null===(t=e.parent)||void 0===t?void 0:t.parent;i;){var r,o,a;i=null===(o=n=null===(r=n)||void 0===r?void 0:r.parent)||void 0===o||null===(a=o.parent)||void 0===a?void 0:a.parent}return n},n.play=function(){var e,t,n=this;this._isLoaded?(x3.discardOnePlayingIfNeeded(),this.state===A4.PLAYING&&(null===(t=this._player)||void 0===t||t.stop().catch((function(){}))),null===(e=this._player)||void 0===e||e.play().then((function(){x3.addPlaying(n._player),n.node.emit(y3.STARTED,n)})).catch((function(){}))):this._operationsBeforeLoading.push("play")},n.pause=function(){var e,t=this;this._isLoaded?null===(e=this._player)||void 0===e||e.pause().then((function(){x3.removePlaying(t._player)})).catch((function(){})):this._operationsBeforeLoading.push("pause")},n.stop=function(){var e,t=this;this._isLoaded?null===(e=this._player)||void 0===e||e.stop().then((function(){x3.removePlaying(t._player)})).catch((function(){})):this._operationsBeforeLoading.push("stop")},n.playOneShot=function(e,t){void 0===t&&(t=1),e._nativeAsset?J4.loadOneShotAudio(e._nativeAsset.url,this._volume*t,{audioLoadMode:e.loadMode}).then((function(e){x3.discardOnePlayingIfNeeded(),e.onPlay=function(){x3.addPlaying(e)},e.onEnd=function(){x3.removePlaying(e)},e.play()})).catch((function(){})):console.error("Invalid audio clip")},n._syncStates=function(){var e=this;this._player&&this._player.seek(this._cachedCurrentTime).then((function(){e._player&&(e._player.loop=e._loop,e._player.volume=e._volume,e._operationsBeforeLoading.forEach((function(t){var n;null===(n=e[t])||void 0===n||n.call(e)})),e._operationsBeforeLoading.length=0)})).catch((function(){}))},h(t,[{key:"clip",get:function(){return this._clip},set:function(e){e!==this._clip&&(this._clip=e,this._syncPlayer())}},{key:"loop",get:function(){return this._loop},set:function(e){this._loop=e,this._player&&(this._player.loop=e)}},{key:"playOnAwake",get:function(){return this._playOnAwake},set:function(e){this._playOnAwake=e}},{key:"volume",get:function(){return this._volume},set:function(e){Number.isNaN(e)?console.warn("illegal audio volume!"):(e=en(e,0,1),this._player?(this._player.volume=e,this._volume=this._player.volume):this._volume=e)}},{key:"currentTime",get:function(){return this._player?this._player.currentTime:this._cachedCurrentTime},set:function(e){var t;Number.isNaN(e)?console.warn("illegal audio time!"):(e=en(e,0,this.duration),this._cachedCurrentTime=e,null===(t=this._player)||void 0===t||t.seek(this._cachedCurrentTime).catch((function(){})))}},{key:"duration",get:function(){var e,t;return null!==(e=null===(t=this._clip)||void 0===t?void 0:t.getDuration())&&void 0!==e?e:this._player?this._player.duration:0}},{key:"state",get:function(){return this._player?this._player.state:A4.INIT}},{key:"playing",get:function(){return this.state===t.AudioState.PLAYING}}],[{key:"maxAudioChannel",get:function(){return J4.maxAudioChannel}}]),t}(ku),v3.AudioState=A4,v3.EventType=y3,f3=T((_3=g3).prototype,"_clip",[r3],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),d3=T(_3.prototype,"_loop",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),p3=T(_3.prototype,"_playOnAwake",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),m3=T(_3.prototype,"_volume",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),T(_3.prototype,"clip",[o3,a3],Object.getOwnPropertyDescriptor(_3.prototype,"clip"),_3.prototype),T(_3.prototype,"loop",[s3],Object.getOwnPropertyDescriptor(_3.prototype,"loop"),_3.prototype),T(_3.prototype,"playOnAwake",[c3],Object.getOwnPropertyDescriptor(_3.prototype,"playOnAwake"),_3.prototype),T(_3.prototype,"volume",[l3,u3],Object.getOwnPropertyDescriptor(_3.prototype,"volume"),_3.prototype),h3=_3))||h3)||h3)||h3));b.AudioSourceComponent=S3,Ke.setClassAlias(S3,"cc.AudioSourceComponent"),b.log=L,b.warn=F,b.error=B,b.assert=z,b._throw=G,b.logID=W,b.warnID=q,b.errorID=Y,b.assertID=J,b.debug=te,b.path={join:au,extname:su,mainFileName:cu,basename:lu,dirname:uu,changeExtname:hu,changeBasename:_u,_normalize:fu,stripSep:du,get sep(){return pu()}};var E3=e("NodePool",function(){function e(e){this.poolHandlerComp=void 0,this._pool=void 0,this.poolHandlerComp=e,this._pool=[]}var t=e.prototype;return t.size=function(){return this._pool.length},t.clear=function(){for(var e=this._pool.length,t=0;t<e;++t)this._pool[t].destroy();this._pool.length=0},t.put=function(e){if(e&&-1===this._pool.indexOf(e)){e.removeFromParent();var t=this.poolHandlerComp?e.getComponent(this.poolHandlerComp):null;t&&t.unuse&&t.unuse(),this._pool.push(e)}},t.get=function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];var i=this._pool.length-1;if(i<0)return null;var r=this._pool[i];this._pool.length=i;var o=this.poolHandlerComp?r.getComponent(this.poolHandlerComp):null;return o&&o.reuse&&o.reuse(arguments),r},e}());b.NodePool=E3,b.renderer=Ty;var T3,C3=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuDescriptorSet=null,t}f(t,e);var n=t.prototype;return n.initialize=function(e){this._layout=e.layout;var t=e.layout.gpuDescriptorSetLayout,n=t.bindings,i=t.descriptorIndices,r=t.descriptorCount;this._buffers=Array(r).fill(null),this._textures=Array(r).fill(null),this._samplers=Array(r).fill(null);var o=[];this._gpuDescriptorSet={gpuDescriptors:o,descriptorIndices:i};for(var a=0;a<n.length;++a)for(var s=n[a],c=0;c<s.count;c++)o.push({type:s.descriptorType,gpuBuffer:null,gpuTexture:null,gpuSampler:null})},n.destroy=function(){this._layout=null,this._gpuDescriptorSet=null},n.update=function(){if(this._isDirty&&this._gpuDescriptorSet){for(var e=this._gpuDescriptorSet.gpuDescriptors,t=0;t<e.length;++t)if(e[t].type&Qr){var n=this._buffers[t];n&&(e[t].gpuBuffer=n.gpuBuffer||n.gpuBufferView)}else e[t].type&Jr&&(this._textures[t]&&(e[t].gpuTexture=this._textures[t].gpuTexture),this._samplers[t]&&(e[t].gpuSampler=this._samplers[t].gpuSampler));this._isDirty=!1}},h(t,[{key:"gpuDescriptorSet",get:function(){return this._gpuDescriptorSet}}]),t}(vo);!function(e){e[e.RGBA16F_EXT=34842]="RGBA16F_EXT",e[e.RGB16F_EXT=34843]="RGB16F_EXT",e[e.RGBA32F_EXT=34836]="RGBA32F_EXT",e[e.FRAMEBUFFER_ATTACHMENT_COMPONENT_TYPE_EXT=33297]="FRAMEBUFFER_ATTACHMENT_COMPONENT_TYPE_EXT",e[e.UNSIGNED_NORMALIZED_EXT=35863]="UNSIGNED_NORMALIZED_EXT",e[e.UNSIGNED_INT_24_8_WEBGL=34042]="UNSIGNED_INT_24_8_WEBGL",e[e.HALF_FLOAT_OES=36193]="HALF_FLOAT_OES",e[e.SRGB_EXT=35904]="SRGB_EXT",e[e.SRGB_ALPHA_EXT=35906]="SRGB_ALPHA_EXT",e[e.SRGB8_ALPHA8_EXT=35907]="SRGB8_ALPHA8_EXT",e[e.COMPRESSED_RGB_S3TC_DXT1_EXT=33776]="COMPRESSED_RGB_S3TC_DXT1_EXT",e[e.COMPRESSED_RGBA_S3TC_DXT1_EXT=33777]="COMPRESSED_RGBA_S3TC_DXT1_EXT",e[e.COMPRESSED_RGBA_S3TC_DXT3_EXT=33778]="COMPRESSED_RGBA_S3TC_DXT3_EXT",e[e.COMPRESSED_RGBA_S3TC_DXT5_EXT=33779]="COMPRESSED_RGBA_S3TC_DXT5_EXT",e[e.COMPRESSED_SRGB_S3TC_DXT1_EXT=35916]="COMPRESSED_SRGB_S3TC_DXT1_EXT",e[e.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT=35917]="COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT",e[e.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT=35918]="COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT",e[e.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT=35919]="COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT",e[e.COMPRESSED_RGB_PVRTC_4BPPV1_IMG=35840]="COMPRESSED_RGB_PVRTC_4BPPV1_IMG",e[e.COMPRESSED_RGB_PVRTC_2BPPV1_IMG=35841]="COMPRESSED_RGB_PVRTC_2BPPV1_IMG",e[e.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG=35842]="COMPRESSED_RGBA_PVRTC_4BPPV1_IMG",e[e.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG=35843]="COMPRESSED_RGBA_PVRTC_2BPPV1_IMG",e[e.COMPRESSED_RGB_ETC1_WEBGL=36196]="COMPRESSED_RGB_ETC1_WEBGL",e[e.COMPRESSED_R11_EAC=37488]="COMPRESSED_R11_EAC",e[e.COMPRESSED_SIGNED_R11_EAC=37489]="COMPRESSED_SIGNED_R11_EAC",e[e.COMPRESSED_RG11_EAC=37490]="COMPRESSED_RG11_EAC",e[e.COMPRESSED_SIGNED_RG11_EAC=37491]="COMPRESSED_SIGNED_RG11_EAC",e[e.COMPRESSED_RGB8_ETC2=37492]="COMPRESSED_RGB8_ETC2",e[e.COMPRESSED_SRGB8_ETC2=37493]="COMPRESSED_SRGB8_ETC2",e[e.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2=37494]="COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2",e[e.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2=37495]="COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2",e[e.COMPRESSED_RGBA8_ETC2_EAC=37496]="COMPRESSED_RGBA8_ETC2_EAC",e[e.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC=37497]="COMPRESSED_SRGB8_ALPHA8_ETC2_EAC",e[e.COMPRESSED_RGBA_ASTC_4x4_KHR=37808]="COMPRESSED_RGBA_ASTC_4x4_KHR",e[e.COMPRESSED_RGBA_ASTC_5x4_KHR=37809]="COMPRESSED_RGBA_ASTC_5x4_KHR",e[e.COMPRESSED_RGBA_ASTC_5x5_KHR=37810]="COMPRESSED_RGBA_ASTC_5x5_KHR",e[e.COMPRESSED_RGBA_ASTC_6x5_KHR=37811]="COMPRESSED_RGBA_ASTC_6x5_KHR",e[e.COMPRESSED_RGBA_ASTC_6x6_KHR=37812]="COMPRESSED_RGBA_ASTC_6x6_KHR",e[e.COMPRESSED_RGBA_ASTC_8x5_KHR=37813]="COMPRESSED_RGBA_ASTC_8x5_KHR",e[e.COMPRESSED_RGBA_ASTC_8x6_KHR=37814]="COMPRESSED_RGBA_ASTC_8x6_KHR",e[e.COMPRESSED_RGBA_ASTC_8x8_KHR=37815]="COMPRESSED_RGBA_ASTC_8x8_KHR",e[e.COMPRESSED_RGBA_ASTC_10x5_KHR=37816]="COMPRESSED_RGBA_ASTC_10x5_KHR",e[e.COMPRESSED_RGBA_ASTC_10x6_KHR=37817]="COMPRESSED_RGBA_ASTC_10x6_KHR",e[e.COMPRESSED_RGBA_ASTC_10x8_KHR=37818]="COMPRESSED_RGBA_ASTC_10x8_KHR",e[e.COMPRESSED_RGBA_ASTC_10x10_KHR=37819]="COMPRESSED_RGBA_ASTC_10x10_KHR",e[e.COMPRESSED_RGBA_ASTC_12x10_KHR=37820]="COMPRESSED_RGBA_ASTC_12x10_KHR",e[e.COMPRESSED_RGBA_ASTC_12x12_KHR=37821]="COMPRESSED_RGBA_ASTC_12x12_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR=37840]="COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR=37841]="COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR=37842]="COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR=37843]="COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR=37844]="COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR=37845]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR=37846]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR=37847]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR=37848]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR=37849]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR=37850]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR=37851]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR=37852]="COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR=37853]="COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR"}(T3||(T3={}));var b3=function(){function e(){}return e.setInstance=function(t){e._instance=t},h(e,null,[{key:"instance",get:function(){return e._instance}}]),e}();function A3(e,t){switch(e){case ai.R8:return t.UNSIGNED_BYTE;case ai.R8SN:return t.BYTE;case ai.R8UI:return t.UNSIGNED_BYTE;case ai.R8I:return t.BYTE;case ai.R16F:return T3.HALF_FLOAT_OES;case ai.R16UI:return t.UNSIGNED_SHORT;case ai.R16I:return t.SHORT;case ai.R32F:return t.FLOAT;case ai.R32UI:return t.UNSIGNED_INT;case ai.R32I:return t.INT;case ai.RG8:return t.UNSIGNED_BYTE;case ai.RG8SN:return t.BYTE;case ai.RG8UI:return t.UNSIGNED_BYTE;case ai.RG8I:return t.BYTE;case ai.RG16F:return T3.HALF_FLOAT_OES;case ai.RG16UI:return t.UNSIGNED_SHORT;case ai.RG16I:return t.SHORT;case ai.RG32F:return t.FLOAT;case ai.RG32UI:return t.UNSIGNED_INT;case ai.RG32I:return t.INT;case ai.RGB8:case ai.SRGB8:return t.UNSIGNED_BYTE;case ai.RGB8SN:return t.BYTE;case ai.RGB8UI:return t.UNSIGNED_BYTE;case ai.RGB8I:return t.BYTE;case ai.RGB16F:return T3.HALF_FLOAT_OES;case ai.RGB16UI:return t.UNSIGNED_SHORT;case ai.RGB16I:return t.SHORT;case ai.RGB32F:return t.FLOAT;case ai.RGB32UI:return t.UNSIGNED_INT;case ai.RGB32I:return t.INT;case ai.BGRA8:case ai.RGBA8:case ai.SRGB8_A8:return t.UNSIGNED_BYTE;case ai.RGBA8SN:return t.BYTE;case ai.RGBA8UI:return t.UNSIGNED_BYTE;case ai.RGBA8I:return t.BYTE;case ai.RGBA16F:return T3.HALF_FLOAT_OES;case ai.RGBA16UI:return t.UNSIGNED_SHORT;case ai.RGBA16I:return t.SHORT;case ai.RGBA32F:return t.FLOAT;case ai.RGBA32UI:return t.UNSIGNED_INT;case ai.RGBA32I:return t.INT;case ai.R5G6B5:return t.UNSIGNED_SHORT_5_6_5;case ai.R11G11B10F:return t.FLOAT;case ai.RGB5A1:return t.UNSIGNED_SHORT_5_5_5_1;case ai.RGBA4:return t.UNSIGNED_SHORT_4_4_4_4;case ai.RGB10A2:return t.UNSIGNED_BYTE;case ai.RGB10A2UI:return t.UNSIGNED_INT;case ai.RGB9E5:return t.UNSIGNED_BYTE;case ai.DEPTH:return t.UNSIGNED_INT;case ai.DEPTH_STENCIL:return T3.UNSIGNED_INT_24_8_WEBGL;case ai.BC1:case ai.BC1_SRGB:case ai.BC2:case ai.BC2_SRGB:case ai.BC3:case ai.BC3_SRGB:case ai.BC4:return t.UNSIGNED_BYTE;case ai.BC4_SNORM:return t.BYTE;case ai.BC5:return t.UNSIGNED_BYTE;case ai.BC5_SNORM:return t.BYTE;case ai.BC6H_SF16:case ai.BC6H_UF16:return t.FLOAT;case ai.BC7:case ai.BC7_SRGB:case ai.ETC_RGB8:case ai.ETC2_RGB8:case ai.ETC2_SRGB8:case ai.ETC2_RGB8_A1:case ai.ETC2_SRGB8_A1:case ai.EAC_R11:return t.UNSIGNED_BYTE;case ai.EAC_R11SN:return t.BYTE;case ai.EAC_RG11:return t.UNSIGNED_BYTE;case ai.EAC_RG11SN:return t.BYTE;case ai.PVRTC_RGB2:case ai.PVRTC_RGBA2:case ai.PVRTC_RGB4:case ai.PVRTC_RGBA4:case ai.PVRTC2_2BPP:case ai.PVRTC2_4BPP:return t.UNSIGNED_BYTE;case ai.ASTC_RGBA_4X4:case ai.ASTC_RGBA_5X4:case ai.ASTC_RGBA_5X5:case ai.ASTC_RGBA_6X5:case ai.ASTC_RGBA_6X6:case ai.ASTC_RGBA_8X5:case ai.ASTC_RGBA_8X6:case ai.ASTC_RGBA_8X8:case ai.ASTC_RGBA_10X5:case ai.ASTC_RGBA_10X6:case ai.ASTC_RGBA_10X8:case ai.ASTC_RGBA_10X10:case ai.ASTC_RGBA_12X10:case ai.ASTC_RGBA_12X12:case ai.ASTC_SRGBA_4X4:case ai.ASTC_SRGBA_5X4:case ai.ASTC_SRGBA_5X5:case ai.ASTC_SRGBA_6X5:case ai.ASTC_SRGBA_6X6:case ai.ASTC_SRGBA_8X5:case ai.ASTC_SRGBA_8X6:case ai.ASTC_SRGBA_8X8:case ai.ASTC_SRGBA_10X5:case ai.ASTC_SRGBA_10X6:case ai.ASTC_SRGBA_10X8:case ai.ASTC_SRGBA_10X10:case ai.ASTC_SRGBA_12X10:case ai.ASTC_SRGBA_12X12:default:return t.UNSIGNED_BYTE}}function w3(e,t){switch(e){case ci.BOOL:return t.BOOL;case ci.BOOL2:return t.BOOL_VEC2;case ci.BOOL3:return t.BOOL_VEC3;case ci.BOOL4:return t.BOOL_VEC4;case ci.INT:return t.INT;case ci.INT2:return t.INT_VEC2;case ci.INT3:return t.INT_VEC3;case ci.INT4:return t.INT_VEC4;case ci.UINT:return t.UNSIGNED_INT;case ci.FLOAT:return t.FLOAT;case ci.FLOAT2:return t.FLOAT_VEC2;case ci.FLOAT3:return t.FLOAT_VEC3;case ci.FLOAT4:return t.FLOAT_VEC4;case ci.MAT2:return t.FLOAT_MAT2;case ci.MAT3:return t.FLOAT_MAT3;case ci.MAT4:return t.FLOAT_MAT4;case ci.SAMPLER2D:return t.SAMPLER_2D;case ci.SAMPLER_CUBE:return t.SAMPLER_CUBE;default:return console.error("Unsupported GLType, convert to GL type failed."),ci.UNKNOWN}}function I3(e){switch(e){case ci.BOOL:case ci.BOOL2:case ci.BOOL3:case ci.BOOL4:case ci.INT:case ci.INT2:case ci.INT3:case ci.INT4:case ci.UINT:return Int32Array;case ci.FLOAT:case ci.FLOAT2:case ci.FLOAT3:case ci.FLOAT4:case ci.MAT2:case ci.MAT3:case ci.MAT4:return Float32Array;default:return console.error("Unsupported GLType, convert to TypedArrayConstructor failed."),Float32Array}}function P3(e,t){switch(e){case t.BOOL:return ci.BOOL;case t.BOOL_VEC2:return ci.BOOL2;case t.BOOL_VEC3:return ci.BOOL3;case t.BOOL_VEC4:return ci.BOOL4;case t.INT:return ci.INT;case t.INT_VEC2:return ci.INT2;case t.INT_VEC3:return ci.INT3;case t.INT_VEC4:return ci.INT4;case t.UNSIGNED_INT:return ci.UINT;case t.FLOAT:return ci.FLOAT;case t.FLOAT_VEC2:return ci.FLOAT2;case t.FLOAT_VEC3:return ci.FLOAT3;case t.FLOAT_VEC4:return ci.FLOAT4;case t.FLOAT_MAT2:return ci.MAT2;case t.FLOAT_MAT3:return ci.MAT3;case t.FLOAT_MAT4:return ci.MAT4;case t.SAMPLER_2D:return ci.SAMPLER2D;case t.SAMPLER_CUBE:return ci.SAMPLER_CUBE;default:return console.error("Unsupported GLType, convert to Type failed."),ci.UNKNOWN}}function R3(e,t){switch(e){case t.BOOL:return 4;case t.BOOL_VEC2:return 8;case t.BOOL_VEC3:return 12;case t.BOOL_VEC4:return 16;case t.INT:return 4;case t.INT_VEC2:return 8;case t.INT_VEC3:return 12;case t.INT_VEC4:return 16;case t.UNSIGNED_INT:case t.FLOAT:return 4;case t.FLOAT_VEC2:return 8;case t.FLOAT_VEC3:return 12;case t.FLOAT_VEC4:case t.FLOAT_MAT2:return 16;case t.FLOAT_MAT3:return 36;case t.FLOAT_MAT4:return 64;case t.SAMPLER_2D:case t.SAMPLER_CUBE:return 4;default:return console.error("Unsupported GLType, get type failed."),0}}function D3(e,t){switch(e){case t.FLOAT_MAT2:return 2;case t.FLOAT_MAT3:return 3;case t.FLOAT_MAT4:return 4;default:return 1}}b3._instance=null;var O3,N3=[512,513,514,515,516,517,518,519],M3=[0,7680,7681,7682,7683,5386,34055,34056],L3=[32774,32778,32779,32775,32776],F3=[0,1,770,772,771,773,768,774,769,775,776,32769,32770,32771,32772];!function(e){e[e.BEGIN_RENDER_PASS=0]="BEGIN_RENDER_PASS",e[e.END_RENDER_PASS=1]="END_RENDER_PASS",e[e.BIND_STATES=2]="BIND_STATES",e[e.DRAW=3]="DRAW",e[e.UPDATE_BUFFER=4]="UPDATE_BUFFER",e[e.COPY_BUFFER_TO_TEXTURE=5]="COPY_BUFFER_TO_TEXTURE",e[e.COUNT=6]="COUNT"}(O3||(O3={}));var B3=function(e){this.cmdType=void 0,this.refCount=0,this.cmdType=e},z3=function(e){function t(){var t;return(t=e.call(this,O3.BEGIN_RENDER_PASS)||this).gpuRenderPass=null,t.gpuFramebuffer=null,t.renderArea=new Qi,t.clearFlag=Hi.NONE,t.clearColors=[],t.clearDepth=1,t.clearStencil=0,t}return f(t,e),t.prototype.clear=function(){this.gpuFramebuffer=null,this.clearColors.length=0},t}(B3),U3=function(e){function t(){var t;return(t=e.call(this,O3.BIND_STATES)||this).gpuPipelineState=null,t.gpuInputAssembler=null,t.gpuDescriptorSets=[],t.dynamicOffsets=[],t.dynamicStates=new Xr,t}return f(t,e),t.prototype.clear=function(){this.gpuPipelineState=null,this.gpuDescriptorSets.length=0,this.gpuInputAssembler=null,this.dynamicOffsets.length=0},t}(B3),k3=function(e){function t(){var t;return(t=e.call(this,O3.DRAW)||this).drawInfo=new ur,t}return f(t,e),t.prototype.clear=function(){},t}(B3),G3=function(e){function t(){var t;return(t=e.call(this,O3.UPDATE_BUFFER)||this).gpuBuffer=null,t.buffer=null,t.offset=0,t.size=0,t}return f(t,e),t.prototype.clear=function(){this.gpuBuffer=null,this.buffer=null},t}(B3),H3=function(e){function t(){var t;return(t=e.call(this,O3.COPY_BUFFER_TO_TEXTURE)||this).gpuTexture=null,t.buffers=[],t.regions=[],t}return f(t,e),t.prototype.clear=function(){this.gpuTexture=null,this.buffers.length=0,this.regions.length=0},t}(B3),V3=function(){function e(){this.cmds=new Fl(1),this.beginRenderPassCmds=new Fl(1),this.bindStatesCmds=new Fl(1),this.drawCmds=new Fl(1),this.updateBufferCmds=new Fl(1),this.copyBufferToTextureCmds=new Fl(1)}return e.prototype.clearCmds=function(e){this.beginRenderPassCmds.length&&(e.beginRenderPassCmdPool.freeCmds(this.beginRenderPassCmds),this.beginRenderPassCmds.clear()),this.bindStatesCmds.length&&(e.bindStatesCmdPool.freeCmds(this.bindStatesCmds),this.bindStatesCmds.clear()),this.drawCmds.length&&(e.drawCmdPool.freeCmds(this.drawCmds),this.drawCmds.clear()),this.updateBufferCmds.length&&(e.updateBufferCmdPool.freeCmds(this.updateBufferCmds),this.updateBufferCmds.clear()),this.copyBufferToTextureCmds.length&&(e.copyBufferToTextureCmdPool.freeCmds(this.copyBufferToTextureCmds),this.copyBufferToTextureCmds.clear()),this.cmds.clear()},e}();function W3(e,t,n,i,r){if(t.usage&li.UNIFORM)ArrayBuffer.isView(n)?t.vf32.set(n,i/Float32Array.BYTES_PER_ELEMENT):t.vf32.set(new Float32Array(n),i/Float32Array.BYTES_PER_ELEMENT);else if(t.usage&li.INDIRECT){t.indirects.clearDraws();for(var o=n.drawInfos,a=0;a<o.length;++a)t.indirects.setDrawInfo(i+a,o[a])}else{var s=n,c=e.gl,l=e.stateCache;switch(t.glTarget){case c.ARRAY_BUFFER:e.extensions.useVAO&&l.glVAO&&(e.extensions.OES_vertex_array_object.bindVertexArrayOES(null),l.glVAO=null),j3.gpuInputAssembler=null,e.stateCache.glArrayBuffer!==t.glBuffer&&(c.bindBuffer(c.ARRAY_BUFFER,t.glBuffer),e.stateCache.glArrayBuffer=t.glBuffer);break;case c.ELEMENT_ARRAY_BUFFER:e.extensions.useVAO&&l.glVAO&&(e.extensions.OES_vertex_array_object.bindVertexArrayOES(null),l.glVAO=null),j3.gpuInputAssembler=null,e.stateCache.glElementArrayBuffer!==t.glBuffer&&(c.bindBuffer(c.ELEMENT_ARRAY_BUFFER,t.glBuffer),e.stateCache.glElementArrayBuffer=t.glBuffer);break;default:return void console.error("Unsupported BufferType, update buffer failed.")}r===s.byteLength?c.bufferSubData(t.glTarget,i,s):c.bufferSubData(t.glTarget,i,s.slice(0,r))}}var j3={gpuPipelineState:null,gpuInputAssembler:null,glPrimitive:0},q3=new Qi;function X3(e,t,n,i,r,o,a){var s=e.gl,c=e.stateCache,l=0;if(n&&(q3.x=i.x<<n.lodLevel,q3.y=i.y<<n.lodLevel,q3.width=i.width<<n.lodLevel,q3.height=i.height<<n.lodLevel),n&&t){c.glFramebuffer!==n.glFramebuffer&&(s.bindFramebuffer(s.FRAMEBUFFER,n.glFramebuffer),c.glFramebuffer=n.glFramebuffer),c.viewport.left===q3.x&&c.viewport.top===q3.y&&c.viewport.width===q3.width&&c.viewport.height===q3.height||(s.viewport(q3.x,q3.y,q3.width,q3.height),c.viewport.left=q3.x,c.viewport.top=q3.y,c.viewport.width=q3.width,c.viewport.height=q3.height),c.scissorRect.x===q3.x&&c.scissorRect.y===q3.y&&c.scissorRect.width===q3.width&&c.scissorRect.height===q3.height||(s.scissor(q3.x,q3.y,q3.width,q3.height),c.scissorRect.x=q3.x,c.scissorRect.y=q3.y,c.scissorRect.width=q3.width,c.scissorRect.height=q3.height);var u=r.length;e.extensions.WEBGL_draw_buffers||(u=1);for(var h=0;h<u;++h){var _=t.colorAttachments[h];if(_.format!==ai.UNKNOWN)switch(_.loadOp){case wi.LOAD:break;case wi.CLEAR:c.bs.targets[0].blendColorMask!==bi.ALL&&s.colorMask(!0,!0,!0,!0);var f=r[0];s.clearColor(f.x,f.y,f.z,f.w),l|=s.COLOR_BUFFER_BIT;break;case wi.DISCARD:}}if(t.depthStencilAttachment&&t.depthStencilAttachment.format!==ai.UNKNOWN){switch(t.depthStencilAttachment.depthLoadOp){case wi.LOAD:break;case wi.CLEAR:c.dss.depthWrite||s.depthMask(!0),s.clearDepth(o),l|=s.DEPTH_BUFFER_BIT;break;case wi.DISCARD:}if(Kr[t.depthStencilAttachment.format].hasStencil)switch(t.depthStencilAttachment.stencilLoadOp){case wi.LOAD:break;case wi.CLEAR:c.dss.stencilWriteMaskFront||s.stencilMaskSeparate(s.FRONT,65535),c.dss.stencilWriteMaskBack||s.stencilMaskSeparate(s.BACK,65535),s.clearStencil(a),l|=s.STENCIL_BUFFER_BIT;break;case wi.DISCARD:}}if(l&&s.clear(l),l&s.COLOR_BUFFER_BIT){var d=c.bs.targets[0].blendColorMask;if(d!==bi.ALL){var p=(d&bi.R)!==bi.NONE,m=(d&bi.G)!==bi.NONE,v=(d&bi.B)!==bi.NONE,g=(d&bi.A)!==bi.NONE;s.colorMask(p,m,v,g)}}l&s.DEPTH_BUFFER_BIT&&!c.dss.depthWrite&&s.depthMask(!1),l&s.STENCIL_BUFFER_BIT&&(c.dss.stencilWriteMaskFront||s.stencilMaskSeparate(s.FRONT,0),c.dss.stencilWriteMaskBack||s.stencilMaskSeparate(s.BACK,0))}}function Y3(e,t,n,i,r,o){var a,s,c,l=e.gl,u=e.stateCache,h=t&&t.gpuShader,_=!1;if(t&&j3.gpuPipelineState!==t){if(j3.gpuPipelineState=t,j3.glPrimitive=t.glPrimitive,t.gpuShader){var f=t.gpuShader.glProgram;u.glProgram!==f&&(l.useProgram(f),u.glProgram=f,_=!0)}var d=t.rs;if(d){if(u.rs.cullMode!==d.cullMode){switch(d.cullMode){case Li.NONE:l.disable(l.CULL_FACE);break;case Li.FRONT:l.enable(l.CULL_FACE),l.cullFace(l.FRONT);break;case Li.BACK:l.enable(l.CULL_FACE),l.cullFace(l.BACK)}u.rs.cullMode=d.cullMode}var p=d.isFrontFaceCCW;u.rs.isFrontFaceCCW!==p&&(l.frontFace(p?l.CCW:l.CW),u.rs.isFrontFaceCCW=p),u.rs.depthBias===d.depthBias&&u.rs.depthBiasSlop===d.depthBiasSlop||(l.polygonOffset(d.depthBias,d.depthBiasSlop),u.rs.depthBias=d.depthBias,u.rs.depthBiasSlop=d.depthBiasSlop),u.rs.lineWidth!==d.lineWidth&&(l.lineWidth(d.lineWidth),u.rs.lineWidth=d.lineWidth)}var m=t.dss;m&&(u.dss.depthTest!==m.depthTest&&(m.depthTest?l.enable(l.DEPTH_TEST):l.disable(l.DEPTH_TEST),u.dss.depthTest=m.depthTest),u.dss.depthWrite!==m.depthWrite&&(l.depthMask(m.depthWrite),u.dss.depthWrite=m.depthWrite),u.dss.depthFunc!==m.depthFunc&&(l.depthFunc(N3[m.depthFunc]),u.dss.depthFunc=m.depthFunc),u.dss.stencilTestFront===m.stencilTestFront&&u.dss.stencilTestBack===m.stencilTestBack||(m.stencilTestFront||m.stencilTestBack?l.enable(l.STENCIL_TEST):l.disable(l.STENCIL_TEST),u.dss.stencilTestFront=m.stencilTestFront,u.dss.stencilTestBack=m.stencilTestBack),u.dss.stencilFuncFront===m.stencilFuncFront&&u.dss.stencilRefFront===m.stencilRefFront&&u.dss.stencilReadMaskFront===m.stencilReadMaskFront||(l.stencilFuncSeparate(l.FRONT,N3[m.stencilFuncFront],m.stencilRefFront,m.stencilReadMaskFront),u.dss.stencilFuncFront=m.stencilFuncFront,u.dss.stencilRefFront=m.stencilRefFront,u.dss.stencilReadMaskFront=m.stencilReadMaskFront),u.dss.stencilFailOpFront===m.stencilFailOpFront&&u.dss.stencilZFailOpFront===m.stencilZFailOpFront&&u.dss.stencilPassOpFront===m.stencilPassOpFront||(l.stencilOpSeparate(l.FRONT,M3[m.stencilFailOpFront],M3[m.stencilZFailOpFront],M3[m.stencilPassOpFront]),u.dss.stencilFailOpFront=m.stencilFailOpFront,u.dss.stencilZFailOpFront=m.stencilZFailOpFront,u.dss.stencilPassOpFront=m.stencilPassOpFront),u.dss.stencilWriteMaskFront!==m.stencilWriteMaskFront&&(l.stencilMaskSeparate(l.FRONT,m.stencilWriteMaskFront),u.dss.stencilWriteMaskFront=m.stencilWriteMaskFront),u.dss.stencilFuncBack===m.stencilFuncBack&&u.dss.stencilRefBack===m.stencilRefBack&&u.dss.stencilReadMaskBack===m.stencilReadMaskBack||(l.stencilFuncSeparate(l.BACK,N3[m.stencilFuncBack],m.stencilRefBack,m.stencilReadMaskBack),u.dss.stencilFuncBack=m.stencilFuncBack,u.dss.stencilRefBack=m.stencilRefBack,u.dss.stencilReadMaskBack=m.stencilReadMaskBack),u.dss.stencilFailOpBack===m.stencilFailOpBack&&u.dss.stencilZFailOpBack===m.stencilZFailOpBack&&u.dss.stencilPassOpBack===m.stencilPassOpBack||(l.stencilOpSeparate(l.BACK,M3[m.stencilFailOpBack],M3[m.stencilZFailOpBack],M3[m.stencilPassOpBack]),u.dss.stencilFailOpBack=m.stencilFailOpBack,u.dss.stencilZFailOpBack=m.stencilZFailOpBack,u.dss.stencilPassOpBack=m.stencilPassOpBack),u.dss.stencilWriteMaskBack!==m.stencilWriteMaskBack&&(l.stencilMaskSeparate(l.BACK,m.stencilWriteMaskBack),u.dss.stencilWriteMaskBack=m.stencilWriteMaskBack));var v=t.bs;if(v){u.bs.isA2C!==v.isA2C&&(v.isA2C?l.enable(l.SAMPLE_ALPHA_TO_COVERAGE):l.disable(l.SAMPLE_ALPHA_TO_COVERAGE),u.bs.isA2C=v.isA2C),u.bs.blendColor.x===v.blendColor.x&&u.bs.blendColor.y===v.blendColor.y&&u.bs.blendColor.z===v.blendColor.z&&u.bs.blendColor.w===v.blendColor.w||(l.blendColor(v.blendColor.x,v.blendColor.y,v.blendColor.z,v.blendColor.w),u.bs.blendColor.x=v.blendColor.x,u.bs.blendColor.y=v.blendColor.y,u.bs.blendColor.z=v.blendColor.z,u.bs.blendColor.w=v.blendColor.w);var g=v.targets[0],y=u.bs.targets[0];y.blend!==g.blend&&(g.blend?l.enable(l.BLEND):l.disable(l.BLEND),y.blend=g.blend),y.blendEq===g.blendEq&&y.blendAlphaEq===g.blendAlphaEq||(l.blendEquationSeparate(L3[g.blendEq],L3[g.blendAlphaEq]),y.blendEq=g.blendEq,y.blendAlphaEq=g.blendAlphaEq),y.blendSrc===g.blendSrc&&y.blendDst===g.blendDst&&y.blendSrcAlpha===g.blendSrcAlpha&&y.blendDstAlpha===g.blendDstAlpha||(l.blendFuncSeparate(F3[g.blendSrc],F3[g.blendDst],F3[g.blendSrcAlpha],F3[g.blendDstAlpha]),y.blendSrc=g.blendSrc,y.blendDst=g.blendDst,y.blendSrcAlpha=g.blendSrcAlpha,y.blendDstAlpha=g.blendDstAlpha),y.blendColorMask!==g.blendColorMask&&(l.colorMask((g.blendColorMask&bi.R)!==bi.NONE,(g.blendColorMask&bi.G)!==bi.NONE,(g.blendColorMask&bi.B)!==bi.NONE,(g.blendColorMask&bi.A)!==bi.NONE),y.blendColorMask=g.blendColorMask)}}if(t&&t.gpuPipelineLayout&&h){for(var x=h.glBlocks.length,S=t.gpuPipelineLayout.dynamicOffsetIndices,E=0;E<x;E++){var T=h.glBlocks[E],C=i[T.set],b=C&&C.descriptorIndices[T.binding],A=b>=0&&C.gpuDescriptors[b],w=null,I=0;if(A&&A.gpuBuffer){var P=A.gpuBuffer,R=S[T.set],D=R&&R[T.binding];D>=0&&(I=r[D]),"vf32"in P?w=P.vf32:(I+=P.offset,w=P.gpuBuffer.vf32),I>>=2}if(w)for(var O=T.glActiveUniforms.length,N=0;N<O;N++){var M=T.glActiveUniforms[N];switch(M.glType){case l.BOOL:case l.INT:for(var L=0;L<M.array.length;++L){var F=M.offset+I+L;if(w[F]!==M.array[L]){for(var z=L,U=F;z<M.array.length;++z,++U)M.array[z]=w[U];l.uniform1iv(M.glLoc,M.array);break}}break;case l.BOOL_VEC2:case l.INT_VEC2:for(var k=0;k<M.array.length;++k){var G=M.offset+I+k;if(w[G]!==M.array[k]){for(var H=k,V=G;H<M.array.length;++H,++V)M.array[H]=w[V];l.uniform2iv(M.glLoc,M.array);break}}break;case l.BOOL_VEC3:case l.INT_VEC3:for(var W=0;W<M.array.length;++W){var j=M.offset+I+W;if(w[j]!==M.array[W]){for(var q=W,X=j;q<M.array.length;++q,++X)M.array[q]=w[X];l.uniform3iv(M.glLoc,M.array);break}}break;case l.BOOL_VEC4:case l.INT_VEC4:for(var Y=0;Y<M.array.length;++Y){var K=M.offset+I+Y;if(w[K]!==M.array[Y]){for(var Q=Y,J=K;Q<M.array.length;++Q,++J)M.array[Q]=w[J];l.uniform4iv(M.glLoc,M.array);break}}break;case l.FLOAT:for(var Z=0;Z<M.array.length;++Z){var $=M.offset+I+Z;if(w[$]!==M.array[Z]){for(var ee=Z,te=$;ee<M.array.length;++ee,++te)M.array[ee]=w[te];l.uniform1fv(M.glLoc,M.array);break}}break;case l.FLOAT_VEC2:for(var ne=0;ne<M.array.length;++ne){var ie=M.offset+I+ne;if(w[ie]!==M.array[ne]){for(var re=ne,oe=ie;re<M.array.length;++re,++oe)M.array[re]=w[oe];l.uniform2fv(M.glLoc,M.array);break}}break;case l.FLOAT_VEC3:for(var ae=0;ae<M.array.length;++ae){var se=M.offset+I+ae;if(w[se]!==M.array[ae]){for(var ce=ae,le=se;ce<M.array.length;++ce,++le)M.array[ce]=w[le];l.uniform3fv(M.glLoc,M.array);break}}break;case l.FLOAT_VEC4:for(var ue=0;ue<M.array.length;++ue){var he=M.offset+I+ue;if(w[he]!==M.array[ue]){for(var _e=ue,fe=he;_e<M.array.length;++_e,++fe)M.array[_e]=w[fe];l.uniform4fv(M.glLoc,M.array);break}}break;case l.FLOAT_MAT2:for(var de=0;de<M.array.length;++de){var pe=M.offset+I+de;if(w[pe]!==M.array[de]){for(var me=de,ve=pe;me<M.array.length;++me,++ve)M.array[me]=w[ve];l.uniformMatrix2fv(M.glLoc,!1,M.array);break}}break;case l.FLOAT_MAT3:for(var ge=0;ge<M.array.length;++ge){var ye=M.offset+I+ge;if(w[ye]!==M.array[ge]){for(var xe=ge,Se=ye;xe<M.array.length;++xe,++Se)M.array[xe]=w[Se];l.uniformMatrix3fv(M.glLoc,!1,M.array);break}}break;case l.FLOAT_MAT4:for(var Ee=0;Ee<M.array.length;++Ee){var Te=M.offset+I+Ee;if(w[Te]!==M.array[Ee]){for(var Ce=Ee,be=Te;Ce<M.array.length;++Ce,++be)M.array[Ce]=w[be];l.uniformMatrix4fv(M.glLoc,!1,M.array);break}}}}else B("Buffer binding '"+T.name+"' at set "+T.set+" binding "+T.binding+" is not bounded")}for(var Ae=h.glSamplerTextures.length,we=0;we<Ae;we++)for(var Ie=h.glSamplerTextures[we],Pe=i[Ie.set],Re=Pe&&Pe.descriptorIndices[Ie.binding],De=Re>=0&&Pe.gpuDescriptors[Re],Oe=Ie.units.length,Ne=0;Ne<Oe;Ne++){var Me=Ie.units[Ne];if(De&&De.gpuSampler){if(De.gpuTexture&&De.gpuTexture.size>0){var Le=De.gpuTexture,Fe=u.glTexUnits[Me];Fe.glTexture!==Le.glTexture&&(u.texUnit!==Me&&(l.activeTexture(l.TEXTURE0+Me),u.texUnit=Me),Le.glTexture?l.bindTexture(Le.glTarget,Le.glTexture):l.bindTexture(Le.glTarget,e.nullTex2D.gpuTexture.glTexture),Fe.glTexture=Le.glTexture);var Be=De.gpuSampler;Le.isPowerOf2?(a=Be.glWrapS,s=Be.glWrapT):(a=l.CLAMP_TO_EDGE,s=l.CLAMP_TO_EDGE),c=Le.isPowerOf2?Le.mipLevel<=1&&(Be.glMinFilter===l.LINEAR_MIPMAP_NEAREST||Be.glMinFilter===l.LINEAR_MIPMAP_LINEAR)?l.LINEAR:Be.glMinFilter:Be.glMinFilter===l.LINEAR||Be.glMinFilter===l.LINEAR_MIPMAP_NEAREST||Be.glMinFilter===l.LINEAR_MIPMAP_LINEAR?l.LINEAR:l.NEAREST,Le.glWrapS!==a&&(u.texUnit!==Me&&(l.activeTexture(l.TEXTURE0+Me),u.texUnit=Me),l.texParameteri(Le.glTarget,l.TEXTURE_WRAP_S,a),Le.glWrapS=a),Le.glWrapT!==s&&(u.texUnit!==Me&&(l.activeTexture(l.TEXTURE0+Me),u.texUnit=Me),l.texParameteri(Le.glTarget,l.TEXTURE_WRAP_T,s),Le.glWrapT=s),Le.glMinFilter!==c&&(u.texUnit!==Me&&(l.activeTexture(l.TEXTURE0+Me),u.texUnit=Me),l.texParameteri(Le.glTarget,l.TEXTURE_MIN_FILTER,c),Le.glMinFilter=c),Le.glMagFilter!==Be.glMagFilter&&(u.texUnit!==Me&&(l.activeTexture(l.TEXTURE0+Me),u.texUnit=Me),l.texParameteri(Le.glTarget,l.TEXTURE_MAG_FILTER,Be.glMagFilter),Le.glMagFilter=Be.glMagFilter)}De=Pe.gpuDescriptors[++Re]}else B("Sampler binding '"+Ie.name+"' at set "+Ie.set+" binding "+Ie.binding+" index "+Ne+" is not bounded")}}if(n&&h&&(_||j3.gpuInputAssembler!==n)){j3.gpuInputAssembler=n;var ze=e.extensions.ANGLE_instanced_arrays;if(e.extensions.useVAO){var Ue=e.extensions.OES_vertex_array_object,ke=n.glVAOs.get(h.glProgram);if(!ke){var Ge;ke=Ue.createVertexArrayOES(),n.glVAOs.set(h.glProgram,ke),Ue.bindVertexArrayOES(ke),l.bindBuffer(l.ARRAY_BUFFER,null),l.bindBuffer(l.ELEMENT_ARRAY_BUFFER,null),u.glArrayBuffer=null,u.glElementArrayBuffer=null;for(var He=h.glInputs.length,Ve=0;Ve<He;Ve++){var We=h.glInputs[Ve];Ge=null;for(var je=n.glAttribs.length,qe=0;qe<je;qe++){var Xe=n.glAttribs[qe];if(Xe.name===We.name){Ge=Xe;break}}if(Ge){u.glArrayBuffer!==Ge.glBuffer&&(l.bindBuffer(l.ARRAY_BUFFER,Ge.glBuffer),u.glArrayBuffer=Ge.glBuffer);for(var Ye=0;Ye<Ge.componentCount;++Ye){var Ke=We.glLoc+Ye,Qe=Ge.offset+Ge.size*Ye;l.enableVertexAttribArray(Ke),u.glCurrentAttribLocs[Ke]=!0,l.vertexAttribPointer(Ke,Ge.count,Ge.glType,Ge.isNormalized,Ge.stride,Qe),ze&&ze.vertexAttribDivisorANGLE(Ke,Ge.isInstanced?1:0)}}}var Je=n.gpuIndexBuffer;Je&&l.bindBuffer(l.ELEMENT_ARRAY_BUFFER,Je.glBuffer),Ue.bindVertexArrayOES(null),l.bindBuffer(l.ARRAY_BUFFER,null),l.bindBuffer(l.ELEMENT_ARRAY_BUFFER,null),u.glArrayBuffer=null,u.glElementArrayBuffer=null}u.glVAO!==ke&&(Ue.bindVertexArrayOES(ke),u.glVAO=ke)}else{for(var Ze=0;Ze<e.capabilities.maxVertexAttributes;++Ze)u.glCurrentAttribLocs[Ze]=!1;for(var $e=h.glInputs.length,et=0;et<$e;et++){for(var tt=h.glInputs[et],nt=null,it=n.glAttribs.length,rt=0;rt<it;rt++){var ot=n.glAttribs[rt];if(ot.name===tt.name){nt=ot;break}}if(nt){u.glArrayBuffer!==nt.glBuffer&&(l.bindBuffer(l.ARRAY_BUFFER,nt.glBuffer),u.glArrayBuffer=nt.glBuffer);for(var at=0;at<nt.componentCount;++at){var st=tt.glLoc+at,ct=nt.offset+nt.size*at;!u.glEnabledAttribLocs[st]&&st>=0&&(l.enableVertexAttribArray(st),u.glEnabledAttribLocs[st]=!0),u.glCurrentAttribLocs[st]=!0,l.vertexAttribPointer(st,nt.count,nt.glType,nt.isNormalized,nt.stride,ct),ze&&ze.vertexAttribDivisorANGLE(st,nt.isInstanced?1:0)}}}var lt=n.gpuIndexBuffer;lt&&u.glElementArrayBuffer!==lt.glBuffer&&(l.bindBuffer(l.ELEMENT_ARRAY_BUFFER,lt.glBuffer),u.glElementArrayBuffer=lt.glBuffer);for(var ut=0;ut<e.capabilities.maxVertexAttributes;++ut)u.glEnabledAttribLocs[ut]!==u.glCurrentAttribLocs[ut]&&(l.disableVertexAttribArray(ut),u.glEnabledAttribLocs[ut]=!1)}}if(t&&t.dynamicStates.length)for(var ht=t.dynamicStates.length,_t=0;_t<ht;_t++)switch(t.dynamicStates[_t]){case Fi.LINE_WIDTH:u.rs.lineWidth!==o.lineWidth&&(l.lineWidth(o.lineWidth),u.rs.lineWidth=o.lineWidth);break;case Fi.DEPTH_BIAS:u.rs.depthBias===o.depthBiasConstant&&u.rs.depthBiasSlop===o.depthBiasSlope||(l.polygonOffset(o.depthBiasConstant,o.depthBiasSlope),u.rs.depthBias=o.depthBiasConstant,u.rs.depthBiasSlop=o.depthBiasSlope);break;case Fi.BLEND_CONSTANTS:var ft=o.blendConstant;u.bs.blendColor.x===ft.x&&u.bs.blendColor.y===ft.y&&u.bs.blendColor.z===ft.z&&u.bs.blendColor.w===ft.w||(l.blendColor(ft.x,ft.y,ft.z,ft.w),u.bs.blendColor.copy(ft));break;case Fi.STENCIL_WRITE_MASK:var dt=o.stencilStatesFront,pt=o.stencilStatesBack;u.dss.stencilWriteMaskFront!==dt.writeMask&&(l.stencilMaskSeparate(l.FRONT,dt.writeMask),u.dss.stencilWriteMaskFront=dt.writeMask),u.dss.stencilWriteMaskBack!==pt.writeMask&&(l.stencilMaskSeparate(l.BACK,pt.writeMask),u.dss.stencilWriteMaskBack=pt.writeMask);break;case Fi.STENCIL_COMPARE_MASK:var mt=o.stencilStatesFront,vt=o.stencilStatesBack;u.dss.stencilRefFront===mt.reference&&u.dss.stencilReadMaskFront===mt.compareMask||(l.stencilFuncSeparate(l.FRONT,N3[u.dss.stencilFuncFront],mt.reference,mt.compareMask),u.dss.stencilRefFront=mt.reference,u.dss.stencilReadMaskFront=mt.compareMask),u.dss.stencilRefBack===vt.reference&&u.dss.stencilReadMaskBack===vt.compareMask||(l.stencilFuncSeparate(l.BACK,N3[u.dss.stencilFuncBack],vt.reference,vt.compareMask),u.dss.stencilRefBack=vt.reference,u.dss.stencilReadMaskBack=vt.compareMask)}}function K3(e,t){var n=e.gl,i=e.extensions,r=i.ANGLE_instanced_arrays,o=i.WEBGL_multi_draw,a=j3.gpuInputAssembler,s=j3.glPrimitive;if(a){var c=a.gpuIndexBuffer;if(a.gpuIndirectBuffer){var l=a.gpuIndirectBuffer.indirects;if(l.drawByIndex){for(var u=0;u<l.drawCount;u++)l.byteOffsets[u]=l.offsets[u]*c.stride;if(o)l.instancedDraw?o.multiDrawElementsInstancedWEBGL(s,l.counts,0,a.glIndexType,l.byteOffsets,0,l.instances,0,l.drawCount):o.multiDrawElementsWEBGL(s,l.counts,0,a.glIndexType,l.byteOffsets,0,l.drawCount);else for(var h=0;h<l.drawCount;h++)l.instances[h]&&r?r.drawElementsInstancedANGLE(s,l.counts[h],a.glIndexType,l.byteOffsets[h],l.instances[h]):n.drawElements(s,l.counts[h],a.glIndexType,l.byteOffsets[h])}else if(o)l.instancedDraw?o.multiDrawArraysInstancedWEBGL(s,l.offsets,0,l.counts,0,l.instances,0,l.drawCount):o.multiDrawArraysWEBGL(s,l.offsets,0,l.counts,0,l.drawCount);else for(var _=0;_<l.drawCount;_++)l.instances[_]&&r?r.drawArraysInstancedANGLE(s,l.offsets[_],l.counts[_],l.instances[_]):n.drawArrays(s,l.offsets[_],l.counts[_])}else if(t.instanceCount&&r)if(c){if(t.indexCount>0){var f=t.firstIndex*c.stride;r.drawElementsInstancedANGLE(s,t.indexCount,a.glIndexType,f,t.instanceCount)}}else t.vertexCount>0&&r.drawArraysInstancedANGLE(s,t.firstVertex,t.vertexCount,t.instanceCount);else if(c){if(t.indexCount>0){var d=t.firstIndex*c.stride;n.drawElements(s,t.indexCount,a.glIndexType,d)}}else t.vertexCount>0&&n.drawArrays(s,t.firstVertex,t.vertexCount)}}var Q3=new Array(O3.COUNT);function J3(e,t){Q3.fill(0);for(var n=0;n<t.cmds.length;++n){var i=t.cmds.array[n],r=Q3[i]++;switch(i){case O3.BEGIN_RENDER_PASS:var o=t.beginRenderPassCmds.array[r];X3(e,o.gpuRenderPass,o.gpuFramebuffer,o.renderArea,o.clearColors,o.clearDepth,o.clearStencil);break;case O3.BIND_STATES:var a=t.bindStatesCmds.array[r];Y3(e,a.gpuPipelineState,a.gpuInputAssembler,a.gpuDescriptorSets,a.dynamicOffsets,a.dynamicStates);break;case O3.DRAW:K3(e,t.drawCmds.array[r].drawInfo);break;case O3.UPDATE_BUFFER:var s=t.updateBufferCmds.array[r];W3(e,s.gpuBuffer,s.buffer,s.offset,s.size);break;case O3.COPY_BUFFER_TO_TEXTURE:var c=t.copyBufferToTextureCmds.array[r];Z3(e,c.buffers,c.gpuTexture,c.regions)}}}function Z3(e,t,n,i){var r=e.gl,o=e.stateCache.glTexUnits[e.stateCache.texUnit];o.glTexture!==n.glTexture&&(r.bindTexture(n.glTarget,n.glTexture),o.glTexture=n.glTexture);var a=0,s=1,c=1,l=0,u=Kr[n.format].isCompressed;switch(n.glTarget){case r.TEXTURE_2D:for(var h=0;h<i.length;h++){var _=i[h];s=_.texExtent.width,c=_.texExtent.height;var f=t[a++];u?n.glInternalFmt===T3.COMPRESSED_RGB_ETC1_WEBGL||e.extensions.noCompressedTexSubImage2D?r.compressedTexImage2D(r.TEXTURE_2D,_.texSubres.mipLevel,n.glInternalFmt,s,c,0,f):r.compressedTexSubImage2D(r.TEXTURE_2D,_.texSubres.mipLevel,_.texOffset.x,_.texOffset.y,s,c,n.glFormat,f):r.texSubImage2D(r.TEXTURE_2D,_.texSubres.mipLevel,_.texOffset.x,_.texOffset.y,s,c,n.glFormat,n.glType,f)}break;case r.TEXTURE_CUBE_MAP:for(var d=0;d<i.length;d++){var p=i[d],m=p.texSubres.baseArrayLayer+p.texSubres.layerCount;for(l=p.texSubres.baseArrayLayer;l<m;++l){s=p.texExtent.width,c=p.texExtent.height;var v=t[a++];u?n.glInternalFmt===T3.COMPRESSED_RGB_ETC1_WEBGL||e.extensions.noCompressedTexSubImage2D?r.compressedTexImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+l,p.texSubres.mipLevel,n.glInternalFmt,s,c,0,v):r.compressedTexSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+l,p.texSubres.mipLevel,p.texOffset.x,p.texOffset.y,s,c,n.glFormat,v):r.texSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+l,p.texSubres.mipLevel,p.texOffset.x,p.texOffset.y,s,c,n.glFormat,n.glType,v)}}break;default:console.error("Unsupported GL texture type, copy buffer to texture failed.")}n.flags&pi.GEN_MIPMAP&&r.generateMipmap(n.glTarget)}var $3=function(){function e(){this.counts=void 0,this.offsets=void 0,this.instances=void 0,this.drawCount=0,this.drawByIndex=!1,this.instancedDraw=!1,this.byteOffsets=void 0,this._capacity=4,this.counts=new Int32Array(this._capacity),this.offsets=new Int32Array(this._capacity),this.instances=new Int32Array(this._capacity),this.byteOffsets=new Int32Array(this._capacity)}var t=e.prototype;return t.clearDraws=function(){this.drawCount=0,this.drawByIndex=!1,this.instancedDraw=!1},t.setDrawInfo=function(e,t){this._ensureCapacity(e),this.drawByIndex=t.indexCount>0,this.instancedDraw=!!t.instanceCount,this.drawCount=Math.max(e+1,this.drawCount),this.drawByIndex?(this.counts[e]=t.indexCount,this.offsets[e]=t.firstIndex):(this.counts[e]=t.vertexCount,this.offsets[e]=t.firstVertex),this.instances[e]=Math.max(1,t.instanceCount)},t._ensureCapacity=function(e){if(!(this._capacity>e)){this._capacity=s(e);var t=new Int32Array(this._capacity),n=new Int32Array(this._capacity),i=new Int32Array(this._capacity);this.byteOffsets=new Int32Array(this._capacity),t.set(this.counts),n.set(this.offsets),i.set(this.instances),this.counts=t,this.offsets=n,this.instances=i}},e}(),e5=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuBuffer=null,t._gpuBufferView=null,t._uniformBuffer=null,t}f(t,e);var n=t.prototype;return n.initialize=function(e){if("buffer"in e){this._isBufferView=!0;var t=e.buffer;this._usage=t.usage,this._memUsage=t.memUsage,this._size=this._stride=e.range,this._count=1,this._flags=t.flags,this._gpuBufferView={gpuBuffer:t.gpuBuffer,offset:e.offset,range:e.range}}else this._usage=e.usage,this._memUsage=e.memUsage,this._size=e.size,this._stride=Math.max(e.stride||this._size,1),this._count=this._size/this._stride,this._flags=e.flags,this._usage&li.UNIFORM&&this._size>0&&(this._uniformBuffer=new Uint8Array(this._size)),this._gpuBuffer={usage:this._usage,memUsage:this._memUsage,size:this._size,stride:this._stride,buffer:null,vf32:null,indirects:new $3,glTarget:0,glBuffer:null},this._usage&li.UNIFORM&&(this._gpuBuffer.buffer=this._uniformBuffer),function(e,t){var n=e.gl,i=e.stateCache,r=t.memUsage&_i.HOST?n.DYNAMIC_DRAW:n.STATIC_DRAW;if(t.usage&li.VERTEX){t.glTarget=n.ARRAY_BUFFER;var o=n.createBuffer();o&&(t.glBuffer=o,t.size>0&&(e.extensions.useVAO&&i.glVAO&&(e.extensions.OES_vertex_array_object.bindVertexArrayOES(null),i.glVAO=null),j3.gpuInputAssembler=null,e.stateCache.glArrayBuffer!==t.glBuffer&&(n.bindBuffer(n.ARRAY_BUFFER,t.glBuffer),e.stateCache.glArrayBuffer=t.glBuffer),n.bufferData(n.ARRAY_BUFFER,t.size,r),n.bindBuffer(n.ARRAY_BUFFER,null),e.stateCache.glArrayBuffer=null))}else if(t.usage&li.INDEX){t.glTarget=n.ELEMENT_ARRAY_BUFFER;var a=n.createBuffer();a&&(t.glBuffer=a,t.size>0&&(e.extensions.useVAO&&i.glVAO&&(e.extensions.OES_vertex_array_object.bindVertexArrayOES(null),i.glVAO=null),j3.gpuInputAssembler=null,e.stateCache.glElementArrayBuffer!==t.glBuffer&&(n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,t.glBuffer),e.stateCache.glElementArrayBuffer=t.glBuffer),n.bufferData(n.ELEMENT_ARRAY_BUFFER,t.size,r),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,null),e.stateCache.glElementArrayBuffer=null))}else t.usage&li.UNIFORM?(t.glTarget=n.NONE,t.buffer&&(t.vf32=new Float32Array(t.buffer.buffer))):(t.usage&li.INDIRECT||t.usage&li.TRANSFER_DST||t.usage&li.TRANSFER_SRC||console.error("Unsupported BufferType, create buffer failed."),t.glTarget=n.NONE)}(b3.instance,this._gpuBuffer),b3.instance.memoryStatus.bufferSize+=this._size},n.destroy=function(){this._gpuBuffer&&(function(e,t){var n=e.gl,i=e.stateCache;if(t.glBuffer){switch(t.glTarget){case n.ARRAY_BUFFER:e.extensions.useVAO&&i.glVAO&&(e.extensions.OES_vertex_array_object.bindVertexArrayOES(null),e.stateCache.glVAO=null),j3.gpuInputAssembler=null,n.bindBuffer(n.ARRAY_BUFFER,null),e.stateCache.glArrayBuffer=null;break;case n.ELEMENT_ARRAY_BUFFER:e.extensions.useVAO&&i.glVAO&&(e.extensions.OES_vertex_array_object.bindVertexArrayOES(null),e.stateCache.glVAO=null),j3.gpuInputAssembler=null,n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,null),e.stateCache.glElementArrayBuffer=null}n.deleteBuffer(t.glBuffer),t.glBuffer=null}}(b3.instance,this._gpuBuffer),b3.instance.memoryStatus.bufferSize-=this._size,this._gpuBuffer=null),this._gpuBufferView&&(this._gpuBufferView=null)},n.resize=function(e){if(this._isBufferView)console.warn("cannot resize buffer views!");else{var t=this._size;t!==e&&(this._size=e,this._count=this._size/this._stride,this._uniformBuffer&&(this._uniformBuffer=new Uint8Array(e)),this._gpuBuffer&&(this._uniformBuffer&&(this._gpuBuffer.buffer=this._uniformBuffer),this._gpuBuffer.size=e,e>0&&(function(e,t){var n=e.gl,i=e.stateCache,r=t.memUsage&_i.HOST?n.DYNAMIC_DRAW:n.STATIC_DRAW;t.usage&li.VERTEX?(e.extensions.useVAO&&i.glVAO&&(e.extensions.OES_vertex_array_object.bindVertexArrayOES(null),i.glVAO=null),j3.gpuInputAssembler=null,e.stateCache.glArrayBuffer!==t.glBuffer&&n.bindBuffer(n.ARRAY_BUFFER,t.glBuffer),t.buffer?n.bufferData(n.ARRAY_BUFFER,t.buffer,r):n.bufferData(n.ARRAY_BUFFER,t.size,r),n.bindBuffer(n.ARRAY_BUFFER,null),e.stateCache.glArrayBuffer=null):t.usage&li.INDEX?(e.extensions.useVAO&&i.glVAO&&(e.extensions.OES_vertex_array_object.bindVertexArrayOES(null),i.glVAO=null),j3.gpuInputAssembler=null,e.stateCache.glElementArrayBuffer!==t.glBuffer&&n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,t.glBuffer),t.buffer?n.bufferData(n.ELEMENT_ARRAY_BUFFER,t.buffer,r):n.bufferData(n.ELEMENT_ARRAY_BUFFER,t.size,r),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,null),e.stateCache.glElementArrayBuffer=null):t.usage&li.UNIFORM?t.buffer&&(t.vf32=new Float32Array(t.buffer.buffer)):(t.usage&li.INDIRECT||t.usage&li.TRANSFER_DST||t.usage&li.TRANSFER_SRC||console.error("Unsupported BufferType, create buffer failed."),t.glTarget=n.NONE)}(b3.instance,this._gpuBuffer),b3.instance.memoryStatus.bufferSize-=t,b3.instance.memoryStatus.bufferSize+=e)))}},n.update=function(e,t){var n;this._isBufferView?console.warn("cannot update through buffer views!"):(n=void 0!==t?t:this._usage&li.INDIRECT?0:e.byteLength,W3(b3.instance,this._gpuBuffer,e,0,n))},h(t,[{key:"gpuBuffer",get:function(){return this._gpuBuffer}},{key:"gpuBufferView",get:function(){return this._gpuBufferView}}]),t}(so),t5=function(){function e(e,t){this._frees=void 0,this._freeIdx=0,this._freeCmds=void 0,this._frees=new Array(t),this._freeCmds=new Fl(t);for(var n=0;n<t;++n)this._frees[n]=new e;this._freeIdx=t-1}var t=e.prototype;return t.alloc=function(e){if(this._freeIdx<0){var t=2*this._frees.length,n=this._frees;this._frees=new Array(t);for(var i=t-n.length,r=0;r<i;++r)this._frees[r]=new e;for(var o=i,a=0;o<t;++o,++a)this._frees[o]=n[a];this._freeIdx+=i}var s=this._frees[this._freeIdx];return this._frees[this._freeIdx--]=null,++s.refCount,s},t.free=function(e){0==--e.refCount&&this._freeCmds.push(e)},t.freeCmds=function(e){for(var t=0;t<e.length;++t)0==--e.array[t].refCount&&this._freeCmds.push(e.array[t])},t.release=function(){for(var e=0;e<this._freeCmds.length;++e){var t=this._freeCmds.array[e];t.clear(),this._frees[++this._freeIdx]=t}this._freeCmds.clear()},e}(),n5=function(){function e(){this.beginRenderPassCmdPool=void 0,this.bindStatesCmdPool=void 0,this.drawCmdPool=void 0,this.updateBufferCmdPool=void 0,this.copyBufferToTextureCmdPool=void 0,this.beginRenderPassCmdPool=new t5(z3,1),this.bindStatesCmdPool=new t5(U3,1),this.drawCmdPool=new t5(k3,1),this.updateBufferCmdPool=new t5(G3,1),this.copyBufferToTextureCmdPool=new t5(H3,1)}var t=e.prototype;return t.clearCmds=function(e){e.beginRenderPassCmds.length&&(this.beginRenderPassCmdPool.freeCmds(e.beginRenderPassCmds),e.beginRenderPassCmds.clear()),e.bindStatesCmds.length&&(this.bindStatesCmdPool.freeCmds(e.bindStatesCmds),e.bindStatesCmds.clear()),e.drawCmds.length&&(this.drawCmdPool.freeCmds(e.drawCmds),e.drawCmds.clear()),e.updateBufferCmds.length&&(this.updateBufferCmdPool.freeCmds(e.updateBufferCmds),e.updateBufferCmds.clear()),e.copyBufferToTextureCmds.length&&(this.copyBufferToTextureCmdPool.freeCmds(e.copyBufferToTextureCmds),e.copyBufferToTextureCmds.clear()),e.cmds.clear()},t.releaseCmds=function(){this.beginRenderPassCmdPool.release(),this.bindStatesCmdPool.release(),this.drawCmdPool.release(),this.updateBufferCmdPool.release(),this.copyBufferToTextureCmdPool.release()},e}(),i5=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).cmdPackage=new V3,t._cmdAllocator=new n5,t._isInRenderPass=!1,t._curGPUPipelineState=null,t._curGPUInputAssembler=null,t._curGPUDescriptorSets=[],t._curDynamicOffsets=Array(8).fill(0),t._curDynamicStates=new Xr,t._isStateInvalied=!1,t}f(t,e);var n=t.prototype;return n.initialize=function(e){this._type=e.type,this._queue=e.queue;for(var t=b3.instance.bindingMappings.blockOffsets.length,n=0;n<t;n++)this._curGPUDescriptorSets.push(null)},n.destroy=function(){this._cmdAllocator.clearCmds(this.cmdPackage)},n.begin=function(){this._cmdAllocator.clearCmds(this.cmdPackage),this._curGPUPipelineState=null,this._curGPUInputAssembler=null,this._curGPUDescriptorSets.length=0,this._numDrawCalls=0,this._numInstances=0,this._numTris=0},n.end=function(){this._isStateInvalied&&this.bindStates(),this._isInRenderPass=!1},n.beginRenderPass=function(e,t,n,i,r,o){var a=this._cmdAllocator.beginRenderPassCmdPool.alloc(z3);a.gpuRenderPass=e.gpuRenderPass,a.gpuFramebuffer=t.gpuFramebuffer,a.renderArea.copy(n),a.clearColors.length=i.length;for(var s=0;s<i.length;++s)a.clearColors[s]=i[s];a.clearDepth=r,a.clearStencil=o,this.cmdPackage.beginRenderPassCmds.push(a),this.cmdPackage.cmds.push(O3.BEGIN_RENDER_PASS),this._isInRenderPass=!0},n.endRenderPass=function(){this._isInRenderPass=!1},n.bindPipelineState=function(e){var t=e.gpuPipelineState;t!==this._curGPUPipelineState&&(this._curGPUPipelineState=t,this._isStateInvalied=!0)},n.bindDescriptorSet=function(e,t,n){var i=t.gpuDescriptorSet;if(i!==this._curGPUDescriptorSets[e]&&(this._curGPUDescriptorSets[e]=i,this._isStateInvalied=!0),n){var r,o=null===(r=this._curGPUPipelineState)||void 0===r?void 0:r.gpuPipelineLayout;if(o){for(var a=this._curDynamicOffsets,s=o.dynamicOffsetOffsets[e],c=0;c<n.length;c++)a[s+c]=n[c];this._isStateInvalied=!0}}},n.bindInputAssembler=function(e){var t=e.gpuInputAssembler;this._curGPUInputAssembler=t,this._isStateInvalied=!0},n.setViewport=function(e){var t=this._curDynamicStates.viewport;t.left===e.left&&t.top===e.top&&t.width===e.width&&t.height===e.height&&t.minDepth===e.minDepth&&t.maxDepth===e.maxDepth||(t.left=e.left,t.top=e.top,t.width=e.width,t.height=e.height,t.minDepth=e.minDepth,t.maxDepth=e.maxDepth,this._isStateInvalied=!0)},n.setScissor=function(e){var t=this._curDynamicStates.scissor;t.x===e.x&&t.y===e.y&&t.width===e.width&&t.height===e.height||(t.x=e.x,t.y=e.y,t.width=e.width,t.height=e.height,this._isStateInvalied=!0)},n.setLineWidth=function(e){this._curDynamicStates.lineWidth!==e&&(this._curDynamicStates.lineWidth=e,this._isStateInvalied=!0)},n.setDepthBias=function(e,t,n){var i=this._curDynamicStates;i.depthBiasConstant===e&&i.depthBiasClamp===t&&i.depthBiasSlope===n||(i.depthBiasConstant=e,i.depthBiasClamp=t,i.depthBiasSlope=n,this._isStateInvalied=!0)},n.setBlendConstants=function(e){var t=this._curDynamicStates.blendConstant;t.x===e.x&&t.y===e.y&&t.z===e.z&&t.w===e.w||(t.copy(e),this._isStateInvalied=!0)},n.setDepthBound=function(e,t){var n=this._curDynamicStates;n.depthMinBounds===e&&n.depthMaxBounds===t||(n.depthMinBounds=e,n.depthMaxBounds=t,this._isStateInvalied=!0)},n.setStencilWriteMask=function(e,t){var n=this._curDynamicStates.stencilStatesFront,i=this._curDynamicStates.stencilStatesBack;e&Bi.FRONT&&n.writeMask!==t&&(n.writeMask=t,this._isStateInvalied=!0),e&Bi.BACK&&i.writeMask!==t&&(i.writeMask=t,this._isStateInvalied=!0)},n.setStencilCompareMask=function(e,t,n){var i=this._curDynamicStates.stencilStatesFront,r=this._curDynamicStates.stencilStatesBack;e&Bi.FRONT&&(i.compareMask===n&&i.reference===t||(i.reference=t,i.compareMask=n,this._isStateInvalied=!0)),e&Bi.BACK&&(r.compareMask===n&&r.reference===t||(r.reference=t,r.compareMask=n,this._isStateInvalied=!0))},n.draw=function(e){if(this._type===Gi.PRIMARY&&this._isInRenderPass||this._type===Gi.SECONDARY){this._isStateInvalied&&this.bindStates();var t="drawInfo"in e?e.drawInfo:e,n=this._cmdAllocator.drawCmdPool.alloc(k3);n.drawInfo.copy(t),this.cmdPackage.drawCmds.push(n),this.cmdPackage.cmds.push(O3.DRAW),++this._numDrawCalls,this._numInstances+=t.instanceCount;var i=t.indexCount||t.vertexCount;if(this._curGPUPipelineState)switch(this._curGPUPipelineState.glPrimitive){case 4:this._numTris+=i/3*Math.max(t.instanceCount,1);break;case 5:case 6:this._numTris+=(i-2)*Math.max(t.instanceCount,1)}}else console.error("Command 'draw' must be recorded inside a render pass.")},n.updateBuffer=function(e,t,n){if(this._type===Gi.PRIMARY&&!this._isInRenderPass||this._type===Gi.SECONDARY){var i=e.gpuBuffer;if(i){var r,o=this._cmdAllocator.updateBufferCmdPool.alloc(G3),a=0;e.usage&li.INDIRECT||(a=void 0!==n?n:t.byteLength),r=t,o.gpuBuffer=i,o.buffer=r,o.offset=0,o.size=a,this.cmdPackage.updateBufferCmds.push(o),this.cmdPackage.cmds.push(O3.UPDATE_BUFFER)}}else console.error("Command 'updateBuffer' must be recorded outside a render pass.")},n.copyBuffersToTexture=function(e,t,n){if(this._type===Gi.PRIMARY&&!this._isInRenderPass||this._type===Gi.SECONDARY){var i=t.gpuTexture;if(i){var r=this._cmdAllocator.copyBufferToTextureCmdPool.alloc(H3);r&&(r.gpuTexture=i,r.regions=n,r.buffers=e,this.cmdPackage.copyBufferToTextureCmds.push(r),this.cmdPackage.cmds.push(O3.COPY_BUFFER_TO_TEXTURE))}}else console.error("Command 'copyBufferToTexture' must be recorded outside a render pass.")},n.execute=function(e,t){for(var n=0;n<t;++n){for(var i=e[n],r=0;r<i.cmdPackage.beginRenderPassCmds.length;++r){var o=i.cmdPackage.beginRenderPassCmds.array[r];++o.refCount,this.cmdPackage.beginRenderPassCmds.push(o)}for(var a=0;a<i.cmdPackage.bindStatesCmds.length;++a){var s=i.cmdPackage.bindStatesCmds.array[a];++s.refCount,this.cmdPackage.bindStatesCmds.push(s)}for(var c=0;c<i.cmdPackage.drawCmds.length;++c){var l=i.cmdPackage.drawCmds.array[c];++l.refCount,this.cmdPackage.drawCmds.push(l)}for(var u=0;u<i.cmdPackage.updateBufferCmds.length;++u){var h=i.cmdPackage.updateBufferCmds.array[u];++h.refCount,this.cmdPackage.updateBufferCmds.push(h)}for(var _=0;_<i.cmdPackage.copyBufferToTextureCmds.length;++_){var f=i.cmdPackage.copyBufferToTextureCmds.array[_];++f.refCount,this.cmdPackage.copyBufferToTextureCmds.push(f)}this.cmdPackage.cmds.concat(i.cmdPackage.cmds.array),this._numDrawCalls+=i._numDrawCalls,this._numInstances+=i._numInstances,this._numTris+=i._numTris}},n.pipelineBarrier=function(){},n.bindStates=function(){var e=this._cmdAllocator.bindStatesCmdPool.alloc(U3);e&&(e.gpuPipelineState=this._curGPUPipelineState,Array.prototype.push.apply(e.gpuDescriptorSets,this._curGPUDescriptorSets),Array.prototype.push.apply(e.dynamicOffsets,this._curDynamicOffsets),e.gpuInputAssembler=this._curGPUInputAssembler,e.dynamicStates.copy(this._curDynamicStates),this.cmdPackage.bindStatesCmds.push(e),this.cmdPackage.cmds.push(O3.BIND_STATES),this._isStateInvalied=!1)},t}(co),r5=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuFramebuffer=null,t}f(t,e);var n=t.prototype;return n.initialize=function(e){this._renderPass=e.renderPass,this._colorTextures=e.colorTextures||[],this._depthStencilTexture=e.depthStencilTexture||null;for(var t=0,n=[],i=0;i<e.colorTextures.length;++i){var r=e.colorTextures[i];r&&(n.push(r.gpuTexture),t=r.lodLevel)}var o=null;e.depthStencilTexture&&(o=e.depthStencilTexture.gpuTexture,t=e.depthStencilTexture.lodLevel);var a=Number.MAX_SAFE_INTEGER,s=Number.MAX_SAFE_INTEGER;this._gpuFramebuffer={gpuRenderPass:e.renderPass.gpuRenderPass,gpuColorTextures:n,gpuDepthStencilTexture:o,glFramebuffer:null,isOffscreen:!0,get width(){return this.isOffscreen?a:this.gpuColorTextures[0].width},set width(e){a=e},get height(){return this.isOffscreen?s:this.gpuColorTextures[0].height},set height(e){s=e},lodLevel:t},function(e,t){for(var n=0;n<t.gpuColorTextures.length;++n)if(t.gpuColorTextures[n].isSwapchainTexture)return void(t.isOffscreen=!1);var i=e.gl,r=[],o=i.createFramebuffer();if(o){t.glFramebuffer=o,e.stateCache.glFramebuffer!==t.glFramebuffer&&i.bindFramebuffer(i.FRAMEBUFFER,t.glFramebuffer);for(var a=0;a<t.gpuColorTextures.length;++a){var s=t.gpuColorTextures[a];s&&(s.glTexture?i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0+a,s.glTarget,s.glTexture,0):i.framebufferRenderbuffer(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0+a,i.RENDERBUFFER,s.glRenderbuffer),r.push(i.COLOR_ATTACHMENT0+a),t.width=Math.min(t.width,s.width),t.height=Math.min(t.height,s.height))}var c=t.gpuDepthStencilTexture;if(c){var l=Kr[c.format].hasStencil?i.DEPTH_STENCIL_ATTACHMENT:i.DEPTH_ATTACHMENT;c.glTexture?i.framebufferTexture2D(i.FRAMEBUFFER,l,c.glTarget,c.glTexture,0):i.framebufferRenderbuffer(i.FRAMEBUFFER,l,i.RENDERBUFFER,c.glRenderbuffer),t.width=Math.min(t.width,c.width),t.height=Math.min(t.height,c.height)}e.extensions.WEBGL_draw_buffers&&e.extensions.WEBGL_draw_buffers.drawBuffersWEBGL(r);var u=i.checkFramebufferStatus(i.FRAMEBUFFER);if(u!==i.FRAMEBUFFER_COMPLETE)switch(u){case i.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_ATTACHMENT");break;case i.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT");break;case i.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_DIMENSIONS");break;case i.FRAMEBUFFER_UNSUPPORTED:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_UNSUPPORTED")}e.stateCache.glFramebuffer!==t.glFramebuffer&&i.bindFramebuffer(i.FRAMEBUFFER,e.stateCache.glFramebuffer)}}(b3.instance,this._gpuFramebuffer)},n.destroy=function(){var e,t;this._gpuFramebuffer&&(e=b3.instance,(t=this._gpuFramebuffer).glFramebuffer&&(e.gl.deleteFramebuffer(t.glFramebuffer),e.stateCache.glFramebuffer===t.glFramebuffer&&(e.gl.bindFramebuffer(e.gl.FRAMEBUFFER,null),e.stateCache.glFramebuffer=null),t.glFramebuffer=null),this._gpuFramebuffer=null)},h(t,[{key:"gpuFramebuffer",get:function(){return this._gpuFramebuffer}}]),t}(ho),o5=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuInputAssembler=null,t}f(t,e);var n=t.prototype;return n.initialize=function(e){if(0!==e.vertexBuffers.length){if(this._attributes=e.attributes,this._attributesHash=this.computeAttributesHash(),this._vertexBuffers=e.vertexBuffers,e.indexBuffer)this._indexBuffer=e.indexBuffer,this._drawInfo.indexCount=this._indexBuffer.size/this._indexBuffer.stride,this._drawInfo.firstIndex=0;else{var t=this._vertexBuffers[0];this._drawInfo.vertexCount=t.size/t.stride,this._drawInfo.firstVertex=0,this._drawInfo.vertexOffset=0}this._drawInfo.instanceCount=0,this._drawInfo.firstInstance=0,this._indirectBuffer=e.indirectBuffer||null;for(var n=new Array(e.vertexBuffers.length),i=0;i<e.vertexBuffers.length;++i){var r=e.vertexBuffers[i];r.gpuBuffer&&(n[i]=r.gpuBuffer)}var o=null,a=0;if(e.indexBuffer&&(o=e.indexBuffer.gpuBuffer))switch(o.stride){case 1:a=5121;break;case 2:a=5123;break;case 4:a=5125;break;default:console.error("Error index buffer stride.")}var s=null;e.indirectBuffer&&(s=e.indirectBuffer.gpuBuffer),this._gpuInputAssembler={attributes:e.attributes,gpuVertexBuffers:n,gpuIndexBuffer:o,gpuIndirectBuffer:s,glAttribs:[],glIndexType:a,glVAOs:new Map},function(e,t){var n=e.gl;t.glAttribs=new Array(t.attributes.length);for(var i=[0,0,0,0,0,0,0,0],r=0;r<t.attributes.length;++r){var o=t.attributes[r],a=void 0!==o.stream?o.stream:0,s=t.gpuVertexBuffers[a],c=A3(o.format,n),l=Kr[o.format].size;t.glAttribs[r]={name:o.name,glBuffer:s.glBuffer,glType:c,size:l,count:Kr[o.format].count,stride:s.stride,componentCount:D3(c,n),isNormalized:void 0!==o.isNormalized&&o.isNormalized,isInstanced:void 0!==o.isInstanced&&o.isInstanced,offset:i[a]},i[a]+=l}}(b3.instance,this._gpuInputAssembler)}else console.error("InputAssemblerInfo.vertexBuffers is null.")},n.destroy=function(){var e=b3.instance;this._gpuInputAssembler&&e.extensions.useVAO&&function(e,t){for(var n=t.glVAOs.values(),i=n.next(),r=e.extensions.OES_vertex_array_object,o=e.stateCache.glVAO;!i.done;)r.deleteVertexArrayOES(i.value),o===i.value&&(r.bindVertexArrayOES(null),o=null),i=n.next();e.stateCache.glVAO=o,t.glVAOs.clear()}(e,this._gpuInputAssembler),this._gpuInputAssembler=null},h(t,[{key:"gpuInputAssembler",get:function(){return this._gpuInputAssembler}}]),t}(mo),a5=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuDescriptorSetLayout=null,t}f(t,e);var n=t.prototype;return n.initialize=function(e){Array.prototype.push.apply(this._bindings,e.bindings);for(var t=0,n=-1,i=[],r=0;r<this._bindings.length;r++){var o=this._bindings[r];i.push(t),t+=o.count,o.binding>n&&(n=o.binding)}this._bindingIndices=Array(n+1).fill(-1);for(var a=this._descriptorIndices=Array(n+1).fill(-1),s=0;s<this._bindings.length;s++){var c=this._bindings[s];this._bindingIndices[c.binding]=s,a[c.binding]=i[s]}for(var l=[],u=0;u<this._bindings.length;u++){var h=this._bindings[u];if(h.descriptorType&Zr)for(var _=0;_<h.count;_++)l.push(h.binding)}this._gpuDescriptorSetLayout={bindings:this._bindings,dynamicBindings:l,descriptorIndices:a,descriptorCount:t}},n.destroy=function(){this._bindings.length=0},h(t,[{key:"gpuDescriptorSetLayout",get:function(){return this._gpuDescriptorSetLayout}}]),t}(go),s5=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuPipelineLayout=null,t}f(t,e);var n=t.prototype;return n.initialize=function(e){Array.prototype.push.apply(this._setLayouts,e.setLayouts);for(var t=[],n=[],i=0,r=[],o=0;o<this._setLayouts.length;o++){for(var a=this._setLayouts[o],s=a.gpuDescriptorSetLayout.dynamicBindings,c=Array(a.bindingIndices.length).fill(-1),l=0;l<s.length;l++){var u=s[l];c[u]<0&&(c[u]=i+l)}n.push(a.gpuDescriptorSetLayout),t.push(c),r.push(i),i+=s.length}this._gpuPipelineLayout={gpuSetLayouts:n,dynamicOffsetIndices:t,dynamicOffsetCount:i,dynamicOffsetOffsets:r}},n.destroy=function(){this._setLayouts.length=0},h(t,[{key:"gpuPipelineLayout",get:function(){return this._gpuPipelineLayout}}]),t}(yo),c5=[0,1,3,2,0,0,0,4,5,6,0,0,0,0],l5=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuPipelineState=null,t}f(t,e);var n=t.prototype;return n.initialize=function(e){this._primitive=e.primitive,this._shader=e.shader,this._pipelineLayout=e.pipelineLayout;var t=this._bs;if(e.blendState){var n=e.blendState,i=n.targets;i&&i.forEach((function(e,n){t.setTarget(n,e)})),void 0!==n.isA2C&&(t.isA2C=n.isA2C),void 0!==n.isIndepend&&(t.isIndepend=n.isIndepend),void 0!==n.blendColor&&(t.blendColor=n.blendColor)}Object.assign(this._rs,e.rasterizerState),Object.assign(this._dss,e.depthStencilState),this._is=e.inputState,this._renderPass=e.renderPass,this._dynamicStates=e.dynamicStates;for(var r=[],o=0;o<31;o++)this._dynamicStates&1<<o&&r.push(1<<o);this._gpuPipelineState={glPrimitive:c5[e.primitive],gpuShader:e.shader.gpuShader,gpuPipelineLayout:e.pipelineLayout.gpuPipelineLayout,rs:e.rasterizerState,dss:e.depthStencilState,bs:e.blendState,gpuRenderPass:e.renderPass.gpuRenderPass,dynamicStates:r}},n.destroy=function(){this._gpuPipelineState=null},h(t,[{key:"gpuPipelineState",get:function(){return this._gpuPipelineState}}]),t}(bo),u5=function(e){function t(){return e.apply(this,arguments)||this}f(t,e);var n=t.prototype;return n.beginRenderPass=function(e,t,n,i,r,o){X3(b3.instance,e.gpuRenderPass,t.gpuFramebuffer,n,i,r,o),this._isInRenderPass=!0},n.draw=function(e){if(this._isInRenderPass){this._isStateInvalied&&this.bindStates();var t="drawInfo"in e?e.drawInfo:e;K3(b3.instance,t),++this._numDrawCalls,this._numInstances+=t.instanceCount;var n=t.indexCount||t.vertexCount;if(this._curGPUPipelineState)switch(this._curGPUPipelineState.glPrimitive){case 4:this._numTris+=n/3*Math.max(t.instanceCount,1);break;case 5:case 6:this._numTris+=(n-2)*Math.max(t.instanceCount,1)}}else console.error("Command 'draw' must be recorded inside a render pass.")},n.setViewport=function(e){var t=b3.instance,n=t.stateCache,i=t.gl;n.viewport.left===e.left&&n.viewport.top===e.top&&n.viewport.width===e.width&&n.viewport.height===e.height||(i.viewport(e.left,e.top,e.width,e.height),n.viewport.left=e.left,n.viewport.top=e.top,n.viewport.width=e.width,n.viewport.height=e.height)},n.setScissor=function(e){var t=b3.instance,n=t.stateCache,i=t.gl;n.scissorRect.x===e.x&&n.scissorRect.y===e.y&&n.scissorRect.width===e.width&&n.scissorRect.height===e.height||(i.scissor(e.x,e.y,e.width,e.height),n.scissorRect.x=e.x,n.scissorRect.y=e.y,n.scissorRect.width=e.width,n.scissorRect.height=e.height)},n.updateBuffer=function(e,t,n){if(this._isInRenderPass)console.error("Command 'updateBuffer' must be recorded outside a render pass.");else{var i,r=e.gpuBuffer;r&&(i=void 0!==n?n:e.usage&li.INDIRECT?0:t.byteLength,W3(b3.instance,r,t,0,i))}},n.copyBuffersToTexture=function(e,t,n){if(this._isInRenderPass)console.error("Command 'copyBufferToTexture' must be recorded outside a render pass.");else{var i=t.gpuTexture;i&&Z3(b3.instance,e,i,n)}},n.execute=function(e,t){for(var n=0;n<t;++n){var i=e[n];J3(b3.instance,i.cmdPackage),this._numDrawCalls+=i._numDrawCalls,this._numInstances+=i._numInstances,this._numTris+=i._numTris}},n.bindStates=function(){Y3(b3.instance,this._curGPUPipelineState,this._curGPUInputAssembler,this._curGPUDescriptorSets,this._curDynamicOffsets,this._curDynamicStates),this._isStateInvalied=!1},t}(i5),h5=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).numDrawCalls=0,t.numInstances=0,t.numTris=0,t}f(t,e);var n=t.prototype;return n.initialize=function(e){this._type=e.type},n.destroy=function(){},n.submit=function(e){for(var t=e.length,n=0;n<t;n++){var i=e[n];this.numDrawCalls+=i.numDrawCalls,this.numInstances+=i.numInstances,this.numTris+=i.numTris}},n.clear=function(){this.numDrawCalls=0,this.numInstances=0,this.numTris=0},t}(Ao),_5=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuRenderPass=null,t}f(t,e);var n=t.prototype;return n.initialize=function(e){this._colorInfos=e.colorAttachments,this._depthStencilInfo=e.depthStencilAttachment,this._subpasses=e.subpasses,this._gpuRenderPass={colorAttachments:this._colorInfos,depthStencilAttachment:this._depthStencilInfo},this._hash=this.computeHash()},n.destroy=function(){this._gpuRenderPass=null},h(t,[{key:"gpuRenderPass",get:function(){return this._gpuRenderPass}}]),t}(wo),f5=[10497,33648,33071,33071],d5=function(e){function t(t,n){var i;(i=e.call(this,t,n)||this)._gpuSampler=null;var r,o,a=i._info.minFilter,s=i._info.magFilter,c=i._info.mipFilter;r=a===yi.LINEAR||a===yi.ANISOTROPIC?c===yi.LINEAR||c===yi.ANISOTROPIC?9987:c===yi.POINT?9985:9729:c===yi.LINEAR||c===yi.ANISOTROPIC?9986:c===yi.POINT?9984:9728,o=s===yi.LINEAR||s===yi.ANISOTROPIC?9729:9728;var l=f5[i._info.addressU],u=f5[i._info.addressV],h=f5[i._info.addressW];return i._gpuSampler={glMinFilter:r,glMagFilter:o,glWrapS:l,glWrapT:u,glWrapR:h},i}return f(t,e),h(t,[{key:"gpuSampler",get:function(){return this._gpuSampler}}]),t}(Io),p5=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuShader=null,t}f(t,e);var n=t.prototype;return n.initialize=function(e){this._name=e.name,this._stages=e.stages,this._attributes=e.attributes,this._blocks=e.blocks,this._samplers=e.samplers,this._gpuShader={name:e.name,blocks:e.blocks.slice(),samplerTextures:e.samplerTextures.slice(),subpassInputs:e.subpassInputs.slice(),gpuStages:new Array(e.stages.length),glProgram:null,glInputs:[],glUniforms:[],glBlocks:[],glSamplerTextures:[]};for(var t=0;t<e.stages.length;++t){var n=e.stages[t];this._gpuShader.gpuStages[t]={type:n.stage,source:n.source,glShader:null}}!function(e,t){for(var n=e.gl,i=function(e){var i=t.gpuStages[e],r=0,o="",a=1;switch(i.type){case Ai.VERTEX:o="VertexShader",r=n.VERTEX_SHADER;break;case Ai.FRAGMENT:o="FragmentShader",r=n.FRAGMENT_SHADER;break;default:return console.error("Unsupported ShaderType."),{v:void 0}}var s=n.createShader(r);if(s&&(i.glShader=s,n.shaderSource(i.glShader,i.source),n.compileShader(i.glShader),!n.getShaderParameter(i.glShader,n.COMPILE_STATUS))){console.error(o+" in '"+t.name+"' compilation failed."),console.error("Shader source dump:",i.source.replace(/^|\n/g,(function(){return"\n"+a+++" "}))),console.error(n.getShaderInfoLog(i.glShader));for(var c=0;c<t.gpuStages.length;c++){var l=t.gpuStages[e];l.glShader&&(n.deleteShader(l.glShader),l.glShader=null)}return{v:void 0}}},r=0;r<t.gpuStages.length;r++){var o=i(r);if("object"==typeof o)return o.v}var a=n.createProgram();if(a){t.glProgram=a;for(var s=0;s<t.gpuStages.length;s++){var c=t.gpuStages[s];n.attachShader(t.glProgram,c.glShader)}if(n.linkProgram(t.glProgram),e.extensions.destroyShadersImmediately)for(var l=0;l<t.gpuStages.length;l++){var u=t.gpuStages[l];u.glShader&&(n.detachShader(t.glProgram,u.glShader),n.deleteShader(u.glShader),u.glShader=null)}if(!n.getProgramParameter(t.glProgram,n.LINK_STATUS))return console.error("Failed to link shader '"+t.name+"'."),void console.error(n.getProgramInfoLog(t.glProgram));U("Shader '"+t.name+"' compilation succeeded.");var h=n.getProgramParameter(t.glProgram,n.ACTIVE_ATTRIBUTES);t.glInputs=new Array(h);for(var _=0;_<h;++_){var f=n.getActiveAttrib(t.glProgram,_);if(f){var d,p=f.name.indexOf("[");d=-1!==p?f.name.substr(0,p):f.name;var m=n.getAttribLocation(t.glProgram,d),v=P3(f.type,n),g=R3(f.type,n);t.glInputs[_]={binding:m,name:d,type:v,stride:g,count:f.size,size:g*f.size,glType:f.type,glLoc:m}}}if(t.blocks.length>0){t.glBlocks=new Array(t.blocks.length);for(var y=0;y<t.blocks.length;++y){var x=t.blocks[y],S={set:x.set,binding:x.binding,name:x.name,size:0,glUniforms:new Array(x.members.length),glActiveUniforms:[]};t.glBlocks[y]=S;for(var E=0;E<x.members.length;++E){var T=x.members[E],C=w3(T.type,n),b=R3(C,n),A=b*T.count;S.glUniforms[E]={binding:-1,name:T.name,type:T.type,stride:b,count:T.count,size:A,offset:0,glType:C,glLoc:null,array:null}}}}for(var w=0;w<t.subpassInputs.length;++w){var I=t.subpassInputs[w];t.samplerTextures.push(new gr(I.set,I.binding,I.name,ci.SAMPLER2D,I.count))}if(t.samplerTextures.length>0){t.glSamplerTextures=new Array(t.samplerTextures.length);for(var P=0;P<t.samplerTextures.length;++P){var R=t.samplerTextures[P];t.glSamplerTextures[P]={set:R.set,binding:R.binding,name:R.name,type:R.type,count:R.count,units:[],glUnits:null,glType:w3(R.type,n),glLoc:null}}}for(var D=n.getProgramParameter(t.glProgram,n.ACTIVE_UNIFORMS),O=0;O<D;++O){var N=n.getActiveUniform(t.glProgram,O);if(N&&N.type!==n.SAMPLER_2D&&N.type!==n.SAMPLER_CUBE){var M=n.getUniformLocation(t.glProgram,N.name);if(e.extensions.isLocationActive(M)){var L,F=N.name.indexOf("[");L=-1!==F?N.name.substr(0,F):N.name;for(var B=0;B<t.glBlocks.length;B++)for(var z=t.glBlocks[B],k=0;k<z.glUniforms.length;k++){var G=z.glUniforms[k];if(G.name===L){G.glLoc=M,G.count=N.size,G.size=G.stride*G.count,G.array=new(I3(G.type))(G.size/4),z.glActiveUniforms.push(G);break}}}}}for(var H=0;H<t.glBlocks.length;H++)for(var V=t.glBlocks[H],W=0;W<V.glUniforms.length;W++){var j=V.glUniforms[W];j.offset=V.size/4,V.size+=j.size}for(var q=[],X=[],Y=e.bindingMappings,K=e.stateCache.texUnitCacheMap,Q=0,J=0;J<t.blocks.length;++J)t.blocks[J].set===Y.flexibleSet&&Q++;for(var Z=0,$=0;$<t.samplerTextures.length;++$){var ee=t.samplerTextures[$],te=n.getUniformLocation(t.glProgram,ee.name);if(e.extensions.isLocationActive(te)&&(q.push(t.glSamplerTextures[$]),X.push(te)),void 0===K[ee.name]){var ne=ee.binding+Y.samplerTextureOffsets[ee.set]+Z;ee.set===Y.flexibleSet&&(ne-=Q),K[ee.name]=ne%e.capabilities.maxTextureUnits,Z+=ee.count-1}}if(q.length){for(var ie=[],re=0;re<q.length;++re){var oe=q[re],ae=K[oe.name];if(void 0!==ae){oe.glLoc=X[re];for(var se=0;se<oe.count;++se){for(;ie[ae];)ae=(ae+1)%e.capabilities.maxTextureUnits;oe.units.push(ae),ie[ae]=!0}}}for(var ce=0,le=0;le<q.length;++le){var ue=q[le];if(!e.extensions.isLocationActive(ue.glLoc)){ue.glLoc=X[le];for(var he=0;he<ue.count;++he){for(;ie[ce];)ce=(ce+1)%e.capabilities.maxTextureUnits;void 0===K[ue.name]&&(K[ue.name]=ce),ue.units.push(ce),ie[ce]=!0}}}e.stateCache.glProgram!==t.glProgram&&n.useProgram(t.glProgram);for(var _e=0;_e<q.length;_e++){var fe=q[_e];fe.glUnits=new Int32Array(fe.units),n.uniform1iv(fe.glLoc,fe.glUnits)}e.stateCache.glProgram!==t.glProgram&&n.useProgram(e.stateCache.glProgram)}for(var de=0;de<t.glBlocks.length;)t.glBlocks[de].glActiveUniforms.length?de++:(t.glBlocks[de]=t.glBlocks[t.glBlocks.length-1],t.glBlocks.length--);t.glSamplerTextures=q}}(b3.instance,this._gpuShader)},n.destroy=function(){this._gpuShader&&(function(e,t){if(t.glProgram){var n=e.gl;if(!e.extensions.destroyShadersImmediately)for(var i=0;i<t.gpuStages.length;i++){var r=t.gpuStages[i];r.glShader&&(n.detachShader(t.glProgram,r.glShader),n.deleteShader(r.glShader),r.glShader=null)}n.deleteProgram(t.glProgram),e.stateCache.glProgram===t.glProgram&&(e.gl.useProgram(null),e.stateCache.glProgram=null),t.glProgram=null}}(b3.instance,this._gpuShader),this._gpuShader=null)},h(t,[{key:"gpuShader",get:function(){return this._gpuShader}}]),t}(Po),m5=function(){function e(){this.glArrayBuffer=null,this.glElementArrayBuffer=null,this.glVAO=null,this.texUnit=0,this.glTexUnits=[],this.glRenderbuffer=null,this.glFramebuffer=null,this.viewport=new ir,this.scissorRect=new Qi(0,0,0,0),this.rs=new xo,this.dss=new So,this.bs=new To,this.glProgram=null,this.glEnabledAttribLocs=[],this.glCurrentAttribLocs=[],this.texUnitCacheMap={}}return e.prototype.initialize=function(e,t){for(var n=0;n<e;++n)this.glTexUnits.push({glTexture:null});this.glEnabledAttribLocs.length=t,this.glEnabledAttribLocs.fill(!1),this.glCurrentAttribLocs.length=t,this.glCurrentAttribLocs.fill(!1)},e}(),v5=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuTexture=null,t._lodLevel=0,t}f(t,e);var n=t.prototype;return n.initialize=function(e,t){var n=e,i=e;"texture"in e&&(n=i.texture.info,this._isTextureView=!0),this._info.copy(n),this._isPowerOf2=eo(this._info.width)&&eo(this._info.height),this._size=no(this._info.format,this.width,this.height,this.depth,this._info.levelCount)*this._info.layerCount,this._isTextureView?(this._viewInfo.copy(i),this._lodLevel=i.baseLevel,this._gpuTexture=i.texture._gpuTexture):(this._gpuTexture={type:n.type,format:n.format,usage:n.usage,width:n.width,height:n.height,depth:n.depth,size:this._size,arrayLayer:n.layerCount,mipLevel:n.levelCount,samples:n.samples,flags:n.flags,isPowerOf2:this._isPowerOf2,glTarget:0,glInternalFmt:0,glFormat:0,glType:0,glUsage:0,glTexture:null,glRenderbuffer:null,glWrapS:0,glWrapT:0,glMinFilter:0,glMagFilter:0,isSwapchainTexture:t||!1},function(e,t){var n=e.gl;t.glFormat=t.glInternalFmt=function(e,t){switch(e){case ai.A8:return t.ALPHA;case ai.L8:return t.LUMINANCE;case ai.LA8:return t.LUMINANCE_ALPHA;case ai.RGB8:case ai.RGB16F:case ai.RGB32F:return t.RGB;case ai.BGRA8:case ai.RGBA8:case ai.SRGB8_A8:case ai.RGBA16F:case ai.RGBA32F:return t.RGBA;case ai.R5G6B5:return t.RGB;case ai.RGB5A1:case ai.RGBA4:return t.RGBA;case ai.DEPTH:return t.DEPTH_COMPONENT;case ai.DEPTH_STENCIL:return t.DEPTH_STENCIL;case ai.BC1:return T3.COMPRESSED_RGB_S3TC_DXT1_EXT;case ai.BC1_ALPHA:return T3.COMPRESSED_RGBA_S3TC_DXT1_EXT;case ai.BC1_SRGB:return T3.COMPRESSED_SRGB_S3TC_DXT1_EXT;case ai.BC1_SRGB_ALPHA:return T3.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;case ai.BC2:return T3.COMPRESSED_RGBA_S3TC_DXT3_EXT;case ai.BC2_SRGB:return T3.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;case ai.BC3:return T3.COMPRESSED_RGBA_S3TC_DXT5_EXT;case ai.BC3_SRGB:return T3.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT;case ai.ETC_RGB8:return T3.COMPRESSED_RGB_ETC1_WEBGL;case ai.ETC2_RGB8:return T3.COMPRESSED_RGB8_ETC2;case ai.ETC2_SRGB8:return T3.COMPRESSED_SRGB8_ETC2;case ai.ETC2_RGB8_A1:return T3.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2;case ai.ETC2_SRGB8_A1:return T3.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2;case ai.ETC2_RGBA8:return T3.COMPRESSED_RGBA8_ETC2_EAC;case ai.ETC2_SRGB8_A8:return T3.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC;case ai.EAC_R11:return T3.COMPRESSED_R11_EAC;case ai.EAC_R11SN:return T3.COMPRESSED_SIGNED_R11_EAC;case ai.EAC_RG11:return T3.COMPRESSED_RG11_EAC;case ai.EAC_RG11SN:return T3.COMPRESSED_SIGNED_RG11_EAC;case ai.PVRTC_RGB2:return T3.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;case ai.PVRTC_RGBA2:return T3.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG;case ai.PVRTC_RGB4:return T3.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;case ai.PVRTC_RGBA4:return T3.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;case ai.ASTC_RGBA_4X4:return T3.COMPRESSED_RGBA_ASTC_4x4_KHR;case ai.ASTC_RGBA_5X4:return T3.COMPRESSED_RGBA_ASTC_5x4_KHR;case ai.ASTC_RGBA_5X5:return T3.COMPRESSED_RGBA_ASTC_5x5_KHR;case ai.ASTC_RGBA_6X5:return T3.COMPRESSED_RGBA_ASTC_6x5_KHR;case ai.ASTC_RGBA_6X6:return T3.COMPRESSED_RGBA_ASTC_6x6_KHR;case ai.ASTC_RGBA_8X5:return T3.COMPRESSED_RGBA_ASTC_8x5_KHR;case ai.ASTC_RGBA_8X6:return T3.COMPRESSED_RGBA_ASTC_8x6_KHR;case ai.ASTC_RGBA_8X8:return T3.COMPRESSED_RGBA_ASTC_8x8_KHR;case ai.ASTC_RGBA_10X5:return T3.COMPRESSED_RGBA_ASTC_10x5_KHR;case ai.ASTC_RGBA_10X6:return T3.COMPRESSED_RGBA_ASTC_10x6_KHR;case ai.ASTC_RGBA_10X8:return T3.COMPRESSED_RGBA_ASTC_10x8_KHR;case ai.ASTC_RGBA_10X10:return T3.COMPRESSED_RGBA_ASTC_10x10_KHR;case ai.ASTC_RGBA_12X10:return T3.COMPRESSED_RGBA_ASTC_12x10_KHR;case ai.ASTC_RGBA_12X12:return T3.COMPRESSED_RGBA_ASTC_12x12_KHR;case ai.ASTC_SRGBA_4X4:return T3.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR;case ai.ASTC_SRGBA_5X4:return T3.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR;case ai.ASTC_SRGBA_5X5:return T3.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR;case ai.ASTC_SRGBA_6X5:return T3.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR;case ai.ASTC_SRGBA_6X6:return T3.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR;case ai.ASTC_SRGBA_8X5:return T3.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR;case ai.ASTC_SRGBA_8X6:return T3.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR;case ai.ASTC_SRGBA_8X8:return T3.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR;case ai.ASTC_SRGBA_10X5:return T3.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR;case ai.ASTC_SRGBA_10X6:return T3.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR;case ai.ASTC_SRGBA_10X8:return T3.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR;case ai.ASTC_SRGBA_10X10:return T3.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR;case ai.ASTC_SRGBA_12X10:return T3.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR;case ai.ASTC_SRGBA_12X12:return T3.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR;default:return console.error("Unsupported Format, convert to WebGL format failed."),t.RGBA}}(t.format,n),t.glType=A3(t.format,n);var i=t.width,r=t.height;switch(t.type){case fi.TEX2D:if(t.glTarget=n.TEXTURE_2D,t.isSwapchainTexture)break;var o=Math.max(i,r);if(o>e.capabilities.maxTextureSize&&Y(9100,o,e.capabilities.maxTextureSize),e.textureExclusive[t.format]||e.extensions.WEBGL_depth_texture||!Kr[t.format].hasDepth){if(t.glTexture=n.createTexture(),t.size>0){var a=e.stateCache.glTexUnits[e.stateCache.texUnit];if(a.glTexture!==t.glTexture&&(n.bindTexture(n.TEXTURE_2D,t.glTexture),a.glTexture=t.glTexture),Kr[t.format].isCompressed)for(var s=0;s<t.mipLevel;++s){var c=to(t.format,i,r,1),l=new Uint8Array(c);n.compressedTexImage2D(n.TEXTURE_2D,s,t.glInternalFmt,i,r,0,l),i=Math.max(1,i>>1),r=Math.max(1,r>>1)}else for(var u=0;u<t.mipLevel;++u)n.texImage2D(n.TEXTURE_2D,u,t.glInternalFmt,i,r,0,t.glFormat,t.glType,null),i=Math.max(1,i>>1),r=Math.max(1,r>>1);t.isPowerOf2?(t.glWrapS=n.REPEAT,t.glWrapT=n.REPEAT):(t.glWrapS=n.CLAMP_TO_EDGE,t.glWrapT=n.CLAMP_TO_EDGE),t.glMinFilter=n.LINEAR,t.glMagFilter=n.LINEAR,n.texParameteri(t.glTarget,n.TEXTURE_WRAP_S,t.glWrapS),n.texParameteri(t.glTarget,n.TEXTURE_WRAP_T,t.glWrapT),n.texParameteri(t.glTarget,n.TEXTURE_MIN_FILTER,t.glMinFilter),n.texParameteri(t.glTarget,n.TEXTURE_MAG_FILTER,t.glMagFilter)}}else t.glInternalFmt=function(e,t){switch(e){case ai.R5G6B5:return t.RGB565;case ai.RGB5A1:return t.RGB5_A1;case ai.RGBA4:return t.RGBA4;case ai.RGBA16F:return T3.RGBA16F_EXT;case ai.RGBA32F:return T3.RGBA32F_EXT;case ai.SRGB8_A8:return T3.SRGB8_ALPHA8_EXT;case ai.DEPTH:return t.DEPTH_COMPONENT16;case ai.DEPTH_STENCIL:return t.DEPTH_STENCIL;default:return console.error("Unsupported Format, convert to WebGL internal format failed."),t.RGBA}}(t.format,n),t.glRenderbuffer=n.createRenderbuffer(),t.size>0&&(e.stateCache.glRenderbuffer!==t.glRenderbuffer&&(n.bindRenderbuffer(n.RENDERBUFFER,t.glRenderbuffer),e.stateCache.glRenderbuffer=t.glRenderbuffer),n.renderbufferStorage(n.RENDERBUFFER,t.glInternalFmt,i,r));break;case fi.CUBE:t.glTarget=n.TEXTURE_CUBE_MAP;var h=Math.max(i,r);if(h>e.capabilities.maxCubeMapTextureSize&&Y(9100,h,e.capabilities.maxTextureSize),t.glTexture=n.createTexture(),t.size>0){var _=e.stateCache.glTexUnits[e.stateCache.texUnit];if(_.glTexture!==t.glTexture&&(n.bindTexture(n.TEXTURE_CUBE_MAP,t.glTexture),_.glTexture=t.glTexture),Kr[t.format].isCompressed)for(var f=0;f<6;++f){i=t.width,r=t.height;for(var d=0;d<t.mipLevel;++d){var p=to(t.format,i,r,1),m=new Uint8Array(p);n.compressedTexImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+f,d,t.glInternalFmt,i,r,0,m),i=Math.max(1,i>>1),r=Math.max(1,r>>1)}}else for(var v=0;v<6;++v){i=t.width,r=t.height;for(var g=0;g<t.mipLevel;++g)n.texImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+v,g,t.glInternalFmt,i,r,0,t.glFormat,t.glType,null),i=Math.max(1,i>>1),r=Math.max(1,r>>1)}t.isPowerOf2?(t.glWrapS=n.REPEAT,t.glWrapT=n.REPEAT):(t.glWrapS=n.CLAMP_TO_EDGE,t.glWrapT=n.CLAMP_TO_EDGE),t.glMinFilter=n.LINEAR,t.glMagFilter=n.LINEAR,n.texParameteri(t.glTarget,n.TEXTURE_WRAP_S,t.glWrapS),n.texParameteri(t.glTarget,n.TEXTURE_WRAP_T,t.glWrapT),n.texParameteri(t.glTarget,n.TEXTURE_MIN_FILTER,t.glMinFilter),n.texParameteri(t.glTarget,n.TEXTURE_MAG_FILTER,t.glMagFilter)}break;default:console.error("Unsupported TextureType, create texture failed."),t.type=fi.TEX2D,t.glTarget=n.TEXTURE_2D}}(b3.instance,this._gpuTexture),b3.instance.memoryStatus.textureSize+=this._size,this._viewInfo.texture=this,this._viewInfo.type=e.type,this._viewInfo.format=e.format,this._viewInfo.baseLevel=0,this._viewInfo.levelCount=e.levelCount,this._viewInfo.baseLayer=0,this._viewInfo.layerCount=e.layerCount)},n.destroy=function(){!this._isTextureView&&this._gpuTexture&&(function(e,t){var n=e.gl;if(t.glTexture){var i=e.stateCache.glTexUnits,r=e.stateCache.texUnit;n.deleteTexture(t.glTexture);for(var o=0;o<i.length;o++)i[o].glTexture===t.glTexture&&(n.activeTexture(n.TEXTURE0+o),r=o,n.bindTexture(t.glTarget,null),i[o].glTexture=null);e.stateCache.texUnit=r,t.glTexture=null}if(t.glRenderbuffer){var a=e.stateCache.glRenderbuffer;n.deleteRenderbuffer(t.glRenderbuffer),a===t.glRenderbuffer&&(n.bindRenderbuffer(n.RENDERBUFFER,null),a=null),t.glRenderbuffer=null}}(b3.instance,this._gpuTexture),b3.instance.memoryStatus.textureSize-=this._size,this._gpuTexture=null)},n.resize=function(e,n){if(this._info.width!==e||this._info.height!==n){this._info.levelCount===t.getLevelCount(this._info.width,this._info.height)?this._info.levelCount=t.getLevelCount(e,n):this._info.levelCount>1&&(this._info.levelCount=Math.min(this._info.levelCount,t.getLevelCount(e,n)));var i=this._size;this._info.width=e,this._info.height=n,this._size=no(this._info.format,this.width,this.height,this.depth,this._info.levelCount)*this._info.layerCount,!this._isTextureView&&this._gpuTexture&&(this._gpuTexture.width=e,this._gpuTexture.height=n,this._gpuTexture.size=this._size,function(e,t){if(t.size){var n=e.gl,i=t.width,r=t.height;switch(t.type){case fi.TEX2D:t.glTarget=n.TEXTURE_2D;var o=Math.max(i,r);if(o>e.capabilities.maxTextureSize&&Y(9100,o,e.capabilities.maxTextureSize),t.glRenderbuffer)e.stateCache.glRenderbuffer!==t.glRenderbuffer&&(n.bindRenderbuffer(n.RENDERBUFFER,t.glRenderbuffer),e.stateCache.glRenderbuffer=t.glRenderbuffer),n.renderbufferStorage(n.RENDERBUFFER,t.glInternalFmt,i,r);else if(t.glTexture){var a=e.stateCache.glTexUnits[e.stateCache.texUnit];if(a.glTexture!==t.glTexture&&(n.bindTexture(n.TEXTURE_2D,t.glTexture),a.glTexture=t.glTexture),Kr[t.format].isCompressed)for(var s=0;s<t.mipLevel;++s){var c=to(t.format,i,r,1),l=new Uint8Array(c);n.compressedTexImage2D(n.TEXTURE_2D,s,t.glInternalFmt,i,r,0,l),i=Math.max(1,i>>1),r=Math.max(1,r>>1)}else for(var u=0;u<t.mipLevel;++u)n.texImage2D(n.TEXTURE_2D,u,t.glInternalFmt,i,r,0,t.glFormat,t.glType,null),i=Math.max(1,i>>1),r=Math.max(1,r>>1)}break;case fi.CUBE:t.glTarget=n.TEXTURE_CUBE_MAP;var h=Math.max(i,r);h>e.capabilities.maxCubeMapTextureSize&&Y(9100,h,e.capabilities.maxTextureSize);var _=e.stateCache.glTexUnits[e.stateCache.texUnit];if(_.glTexture!==t.glTexture&&(n.bindTexture(n.TEXTURE_CUBE_MAP,t.glTexture),_.glTexture=t.glTexture),Kr[t.format].isCompressed)for(var f=0;f<6;++f){i=t.width,r=t.height;for(var d=0;d<t.mipLevel;++d){var p=to(t.format,i,r,1),m=new Uint8Array(p);n.compressedTexImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+f,d,t.glInternalFmt,i,r,0,m),i=Math.max(1,i>>1),r=Math.max(1,r>>1)}}else for(var v=0;v<6;++v){i=t.width,r=t.height;for(var g=0;g<t.mipLevel;++g)n.texImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+v,g,t.glInternalFmt,i,r,0,t.glFormat,t.glType,null),i=Math.max(1,i>>1),r=Math.max(1,r>>1)}break;default:console.error("Unsupported TextureType, create texture failed."),t.type=fi.TEX2D,t.glTarget=n.TEXTURE_2D}}}(b3.instance,this._gpuTexture),b3.instance.memoryStatus.textureSize-=i,b3.instance.memoryStatus.textureSize+=this._size)}},n.initAsSwapchainTexture=function(e){var t=new fr;t.format=e.format,t.usage=Kr[e.format].hasDepth?di.DEPTH_STENCIL_ATTACHMENT:di.COLOR_ATTACHMENT,t.width=e.width,t.height=e.height,this.initialize(t,!0)},h(t,[{key:"gpuTexture",get:function(){return this._gpuTexture}},{key:"lodLevel",get:function(){return this._lodLevel}}]),t}(Ro),g5="webglcontextlost";function y5(e,t){for(var n=["","WEBKIT_","MOZ_"],i=0;i<n.length;++i){var r=e.getExtension(n[i]+t);if(r)return r}return null}function x5(e){var t={EXT_texture_filter_anisotropic:y5(e,"EXT_texture_filter_anisotropic"),EXT_blend_minmax:y5(e,"EXT_blend_minmax"),EXT_frag_depth:y5(e,"EXT_frag_depth"),EXT_shader_texture_lod:y5(e,"EXT_shader_texture_lod"),EXT_sRGB:y5(e,"EXT_sRGB"),OES_vertex_array_object:y5(e,"OES_vertex_array_object"),EXT_color_buffer_half_float:y5(e,"EXT_color_buffer_half_float"),WEBGL_color_buffer_float:y5(e,"WEBGL_color_buffer_float"),WEBGL_compressed_texture_etc1:y5(e,"WEBGL_compressed_texture_etc1"),WEBGL_compressed_texture_etc:y5(e,"WEBGL_compressed_texture_etc"),WEBGL_compressed_texture_pvrtc:y5(e,"WEBGL_compressed_texture_pvrtc"),WEBGL_compressed_texture_s3tc:y5(e,"WEBGL_compressed_texture_s3tc"),WEBGL_compressed_texture_s3tc_srgb:y5(e,"WEBGL_compressed_texture_s3tc_srgb"),WEBGL_debug_shaders:y5(e,"WEBGL_debug_shaders"),WEBGL_draw_buffers:y5(e,"WEBGL_draw_buffers"),WEBGL_lose_context:y5(e,"WEBGL_lose_context"),WEBGL_depth_texture:y5(e,"WEBGL_depth_texture"),OES_texture_half_float:y5(e,"OES_texture_half_float"),OES_texture_half_float_linear:y5(e,"OES_texture_half_float_linear"),OES_texture_float:y5(e,"OES_texture_float"),OES_texture_float_linear:y5(e,"OES_texture_float_linear"),OES_standard_derivatives:y5(e,"OES_standard_derivatives"),OES_element_index_uint:y5(e,"OES_element_index_uint"),ANGLE_instanced_arrays:y5(e,"ANGLE_instanced_arrays"),WEBGL_debug_renderer_info:y5(e,"WEBGL_debug_renderer_info"),WEBGL_multi_draw:null,WEBGL_compressed_texture_astc:null,destroyShadersImmediately:!0,noCompressedTexSubImage2D:!1,isLocationActive:function(e){return!!e},useVAO:!1};return nu.os===Yl.IOS&&14===nu.osMainVersion&&nu.isBrowser||(t.WEBGL_compressed_texture_astc=y5(e,"WEBGL_compressed_texture_astc")),nu.os!==Yl.ANDROID&&nu.os!==Yl.IOS&&(t.WEBGL_multi_draw=y5(e,"WEBGL_multi_draw")),nu.browserType===jl.UC&&(t.ANGLE_instanced_arrays=null),nu.os===Yl.IOS&&nu.osMainVersion<=10&&(t.destroyShadersImmediately=!1),t.OES_vertex_array_object&&(t.useVAO=!0),t}var S5,E5,T5,C5,b5,A5,w5,I5,P5,R5,D5,O5,N5,M5,L5,F5,B5=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).stateCache=new m5,t.cmdAllocator=new n5,t.nullTex2D=null,t.nullTexCube=null,t._canvas=null,t._webGLContextLostHandler=null,t._extensions=null,t}f(t,e);var n=t.prototype;return n.initialize=function(e){this._canvas=e.windowHandle,this._webGLContextLostHandler=this._onWebGLContextLost.bind(this),this._canvas.addEventListener(g5,this._onWebGLContextLost);var t=b3.instance.gl;this.stateCache.initialize(b3.instance.capabilities.maxTextureUnits,b3.instance.capabilities.maxVertexAttributes),this._extensions=x5(t),function(e){e.activeTexture(e.TEXTURE0),e.pixelStorei(e.PACK_ALIGNMENT,1),e.pixelStorei(e.UNPACK_ALIGNMENT,1),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,!1),e.bindFramebuffer(e.FRAMEBUFFER,null),e.enable(e.SCISSOR_TEST),e.enable(e.CULL_FACE),e.cullFace(e.BACK),e.frontFace(e.CCW),e.disable(e.POLYGON_OFFSET_FILL),e.polygonOffset(0,0),e.enable(e.DEPTH_TEST),e.depthMask(!0),e.depthFunc(e.LESS),e.depthRange(0,1),e.stencilFuncSeparate(e.FRONT,e.ALWAYS,1,65535),e.stencilOpSeparate(e.FRONT,e.KEEP,e.KEEP,e.KEEP),e.stencilMaskSeparate(e.FRONT,65535),e.stencilFuncSeparate(e.BACK,e.ALWAYS,1,65535),e.stencilOpSeparate(e.BACK,e.KEEP,e.KEEP,e.KEEP),e.stencilMaskSeparate(e.BACK,65535),e.disable(e.STENCIL_TEST),e.disable(e.SAMPLE_ALPHA_TO_COVERAGE),e.disable(e.BLEND),e.blendEquationSeparate(e.FUNC_ADD,e.FUNC_ADD),e.blendFuncSeparate(e.ONE,e.ZERO,e.ONE,e.ZERO),e.colorMask(!0,!0,!0,!0),e.blendColor(0,0,0,0)}(t);var n=ai.RGBA8,i=ai.DEPTH_STENCIL,r=t.getParameter(t.DEPTH_BITS),o=t.getParameter(t.STENCIL_BITS);r&&o?i=ai.DEPTH_STENCIL:r&&(i=ai.DEPTH),this._colorTexture=new v5,this._colorTexture.initAsSwapchainTexture({swapchain:this,format:n,width:e.width,height:e.height}),this._depthStencilTexture=new v5,this._depthStencilTexture.initAsSwapchainTexture({swapchain:this,format:i,width:e.width,height:e.height}),this.nullTex2D=b3.instance.createTexture(new fr(fi.TEX2D,di.SAMPLED,ai.RGBA8,2,2,pi.GEN_MIPMAP)),this.nullTexCube=b3.instance.createTexture(new fr(fi.CUBE,di.SAMPLED,ai.RGBA8,2,2,pi.GEN_MIPMAP,6));var a=new nr;a.texExtent.width=2,a.texExtent.height=2;var s=new Uint8Array(this.nullTex2D.size);s.fill(0),b3.instance.copyBuffersToTexture([s],this.nullTex2D,[a]),a.texSubres.layerCount=6,b3.instance.copyBuffersToTexture([s,s,s,s,s,s],this.nullTexCube,[a])},n.destroy=function(){this._canvas&&this._webGLContextLostHandler&&(this._canvas.removeEventListener(g5,this._webGLContextLostHandler),this._webGLContextLostHandler=null),this.nullTex2D&&(this.nullTex2D.destroy(),this.nullTex2D=null),this.nullTexCube&&(this.nullTexCube.destroy(),this.nullTexCube=null),this._extensions=null,this._canvas=null},n.resize=function(e,t){this._colorTexture.width===e&&this._colorTexture.height===t||(U("Resizing swapchain: "+e+"x"+t),this._canvas.width=e,this._canvas.height=t,this._colorTexture.resize(e,t),this._depthStencilTexture.resize(e,t))},n._onWebGLContextLost=function(e){q(11e3),F(e)},h(t,[{key:"extensions",get:function(){return this._extensions}}]),t}(uo),z5=e("WebGLDevice",function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._swapchain=null,t._context=null,t._bindingMappings=null,t._textureExclusive=new Array(ai.COUNT),t}f(t,e);var n=t.prototype;return n.initialize=function(e){b3.setInstance(this),this._gfxAPI=ii.WEBGL;var t=this._bindingMappingInfo=e.bindingMappingInfo,n=[],i=[],r=t.setIndices[0];n[r]=0,i[r]=0;for(var o=1;o<t.setIndices.length;++o){var a=t.setIndices[o],s=t.setIndices[o-1];n[a]=t.maxBlockCounts[s]+n[s],i[a]=t.maxSamplerTextureCounts[s]+i[s]}for(var c=0;c<t.setIndices.length;++c){var l=t.setIndices[c];i[l]-=t.maxBlockCounts[l]}this._bindingMappings={blockOffsets:n,samplerTextureOffsets:i,flexibleSet:t.setIndices[t.setIndices.length-1]};var u=this._context=function(e){var t=null;try{var n={alpha:nt.ENABLE_TRANSPARENT_CANVAS,antialias:nt.ENABLE_WEBGL_ANTIALIAS,depth:!0,stencil:!0,premultipliedAlpha:!1,preserveDrawingBuffer:!1,powerPreference:"default",failIfMajorPerformanceCaveat:!1};t=e.getContext("webgl",n)}catch(e){return null}return t}(lo.canvas);if(!u)return console.error("This device does not support WebGL."),!1;this._queue=this.createQueue(new Hr(Ui.GRAPHICS)),this._cmdBuff=this.createCommandBuffer(new Gr(this._queue)),this._caps.maxVertexAttributes=u.getParameter(u.MAX_VERTEX_ATTRIBS),this._caps.maxVertexUniformVectors=u.getParameter(u.MAX_VERTEX_UNIFORM_VECTORS),this._caps.maxFragmentUniformVectors=u.getParameter(u.MAX_FRAGMENT_UNIFORM_VECTORS),this._caps.maxTextureUnits=u.getParameter(u.MAX_TEXTURE_IMAGE_UNITS),this._caps.maxVertexTextureUnits=u.getParameter(u.MAX_VERTEX_TEXTURE_IMAGE_UNITS),this._caps.maxTextureSize=u.getParameter(u.MAX_TEXTURE_SIZE),this._caps.maxCubeMapTextureSize=u.getParameter(u.MAX_CUBE_MAP_TEXTURE_SIZE),this._caps.maxUniformBufferBindings=16;var h=u.getSupportedExtensions(),_="";if(h)for(var f,d=S(h);!(f=d()).done;)_+=f.value+" ";var p=x5(u);p.WEBGL_debug_renderer_info?(this._renderer=u.getParameter(p.WEBGL_debug_renderer_info.UNMASKED_RENDERER_WEBGL),this._vendor=u.getParameter(p.WEBGL_debug_renderer_info.UNMASKED_VENDOR_WEBGL)):(this._renderer=u.getParameter(u.RENDERER),this._vendor=u.getParameter(u.VENDOR));var m=u.getParameter(u.VERSION);this._features.fill(!1),this.initFormatFeatures(p),p.EXT_blend_minmax&&(this._features[oi.BLEND_MINMAX]=!0),p.OES_element_index_uint&&(this._features[oi.ELEMENT_INDEX_UINT]=!0),p.ANGLE_instanced_arrays&&(this._features[oi.INSTANCED_ARRAYS]=!0),p.WEBGL_draw_buffers&&(this._features[oi.MULTIPLE_RENDER_TARGETS]=!0);var v="";return this.getFormatFeatures(ai.ETC_RGB8)&&(v+="etc1 "),this.getFormatFeatures(ai.ETC2_RGB8)&&(v+="etc2 "),this.getFormatFeatures(ai.BC1)&&(v+="dxt "),this.getFormatFeatures(ai.PVRTC_RGB2)&&(v+="pvrtc "),this.getFormatFeatures(ai.ASTC_RGBA_4X4)&&(v+="astc "),U("WebGL device initialized."),U("RENDERER: "+this._renderer),U("VENDOR: "+this._vendor),U("VERSION: "+m),U("COMPRESSED_FORMAT: "+v),U("EXTENSIONS: "+_),!0},n.destroy=function(){this._queue&&(this._queue.destroy(),this._queue=null),this._cmdBuff&&(this._cmdBuff.destroy(),this._cmdBuff=null)},n.flushCommands=function(){},n.acquire=function(){},n.present=function(){var e=this._queue;this._numDrawCalls=e.numDrawCalls,this._numInstances=e.numInstances,this._numTris=e.numTris,e.clear()},n.initFormatFeatures=function(e){this._formatFeatures.fill(mi.NONE),this._textureExclusive.fill(!0);var t=mi.RENDER_TARGET|mi.SAMPLED_TEXTURE|mi.LINEAR_FILTER;this._formatFeatures[ai.RGB8]=t,this._formatFeatures[ai.R5G6B5]=t,this._textureExclusive[ai.R5G6B5]=!1,this._formatFeatures[ai.RGBA8]=t,this._formatFeatures[ai.RGBA4]=t,this._textureExclusive[ai.RGBA4]=!1,this._formatFeatures[ai.RGB5A1]=t,this._textureExclusive[ai.RGB5A1]=!1,this._formatFeatures[ai.DEPTH]=mi.RENDER_TARGET,this._textureExclusive[ai.DEPTH]=!1,this._formatFeatures[ai.DEPTH_STENCIL]=mi.RENDER_TARGET,this._textureExclusive[ai.DEPTH_STENCIL]=!1,this._formatFeatures[ai.R8I]|=mi.VERTEX_ATTRIBUTE,this._formatFeatures[ai.RG8I]|=mi.VERTEX_ATTRIBUTE,this._formatFeatures[ai.RGB8I]|=mi.VERTEX_ATTRIBUTE,this._formatFeatures[ai.RGBA8I]|=mi.VERTEX_ATTRIBUTE,this._formatFeatures[ai.R8UI]|=mi.VERTEX_ATTRIBUTE,this._formatFeatures[ai.RG8UI]|=mi.VERTEX_ATTRIBUTE,this._formatFeatures[ai.RGB8UI]|=mi.VERTEX_ATTRIBUTE,this._formatFeatures[ai.RGBA8UI]|=mi.VERTEX_ATTRIBUTE,this._formatFeatures[ai.R8I]|=mi.VERTEX_ATTRIBUTE,this._formatFeatures[ai.RG8I]|=mi.VERTEX_ATTRIBUTE,this._formatFeatures[ai.RGB8I]|=mi.VERTEX_ATTRIBUTE,this._formatFeatures[ai.RGBA8I]|=mi.VERTEX_ATTRIBUTE,this._formatFeatures[ai.R8UI]|=mi.VERTEX_ATTRIBUTE,this._formatFeatures[ai.RG8UI]|=mi.VERTEX_ATTRIBUTE,this._formatFeatures[ai.RGB8UI]|=mi.VERTEX_ATTRIBUTE,this._formatFeatures[ai.RGBA8UI]|=mi.VERTEX_ATTRIBUTE,this._formatFeatures[ai.R32F]|=mi.VERTEX_ATTRIBUTE,this._formatFeatures[ai.RG32F]|=mi.VERTEX_ATTRIBUTE,this._formatFeatures[ai.RGB32F]|=mi.VERTEX_ATTRIBUTE,this._formatFeatures[ai.RGBA32F]|=mi.VERTEX_ATTRIBUTE,e.EXT_sRGB&&(this._formatFeatures[ai.SRGB8]=t,this._formatFeatures[ai.SRGB8_A8]=t,this._textureExclusive[ai.SRGB8_A8]=!1),e.WEBGL_depth_texture&&(this._formatFeatures[ai.DEPTH]|=t,this._formatFeatures[ai.DEPTH_STENCIL]|=t),e.WEBGL_color_buffer_float&&(this._formatFeatures[ai.RGB32F]|=mi.RENDER_TARGET,this._formatFeatures[ai.RGBA32F]|=mi.RENDER_TARGET,this._textureExclusive[ai.RGB32F]=!1,this._textureExclusive[ai.RGBA32F]=!1),e.EXT_color_buffer_half_float&&(this._formatFeatures[ai.RGB16F]|=mi.RENDER_TARGET,this._formatFeatures[ai.RGBA16F]|=mi.RENDER_TARGET,this._textureExclusive[ai.RGB16F]=!1,this._textureExclusive[ai.RGBA16F]=!1),e.OES_texture_float&&(this._formatFeatures[ai.RGB32F]|=mi.RENDER_TARGET|mi.SAMPLED_TEXTURE,this._formatFeatures[ai.RGBA32F]|=mi.RENDER_TARGET|mi.SAMPLED_TEXTURE),e.OES_texture_half_float&&(this._formatFeatures[ai.RGB16F]|=mi.RENDER_TARGET|mi.SAMPLED_TEXTURE,this._formatFeatures[ai.RGBA16F]|=mi.RENDER_TARGET|mi.SAMPLED_TEXTURE),e.OES_texture_float_linear&&(this._formatFeatures[ai.RGB32F]|=mi.LINEAR_FILTER,this._formatFeatures[ai.RGBA32F]|=mi.LINEAR_FILTER),e.OES_texture_half_float_linear&&(this._formatFeatures[ai.RGB16F]|=mi.LINEAR_FILTER,this._formatFeatures[ai.RGBA16F]|=mi.LINEAR_FILTER);var n=mi.SAMPLED_TEXTURE|mi.LINEAR_FILTER;e.WEBGL_compressed_texture_etc1&&(this._formatFeatures[ai.ETC_RGB8]=n),e.WEBGL_compressed_texture_etc&&(this._formatFeatures[ai.ETC2_RGB8]=n,this._formatFeatures[ai.ETC2_RGBA8]=n,this._formatFeatures[ai.ETC2_SRGB8]=n,this._formatFeatures[ai.ETC2_SRGB8_A8]=n,this._formatFeatures[ai.ETC2_RGB8_A1]=n,this._formatFeatures[ai.ETC2_SRGB8_A1]=n),e.WEBGL_compressed_texture_s3tc&&(this._formatFeatures[ai.BC1]=n,this._formatFeatures[ai.BC1_ALPHA]=n,this._formatFeatures[ai.BC1_SRGB]=n,this._formatFeatures[ai.BC1_SRGB_ALPHA]=n,this._formatFeatures[ai.BC2]=n,this._formatFeatures[ai.BC2_SRGB]=n,this._formatFeatures[ai.BC3]=n,this._formatFeatures[ai.BC3_SRGB]=n),e.WEBGL_compressed_texture_pvrtc&&(this._formatFeatures[ai.PVRTC_RGB2]|=n,this._formatFeatures[ai.PVRTC_RGBA2]|=n,this._formatFeatures[ai.PVRTC_RGB4]|=n,this._formatFeatures[ai.PVRTC_RGBA4]|=n),e.WEBGL_compressed_texture_astc&&(this._formatFeatures[ai.ASTC_RGBA_4X4]|=n,this._formatFeatures[ai.ASTC_RGBA_5X4]|=n,this._formatFeatures[ai.ASTC_RGBA_5X5]|=n,this._formatFeatures[ai.ASTC_RGBA_6X5]|=n,this._formatFeatures[ai.ASTC_RGBA_6X6]|=n,this._formatFeatures[ai.ASTC_RGBA_8X5]|=n,this._formatFeatures[ai.ASTC_RGBA_8X6]|=n,this._formatFeatures[ai.ASTC_RGBA_8X8]|=n,this._formatFeatures[ai.ASTC_RGBA_10X5]|=n,this._formatFeatures[ai.ASTC_RGBA_10X6]|=n,this._formatFeatures[ai.ASTC_RGBA_10X8]|=n,this._formatFeatures[ai.ASTC_RGBA_10X10]|=n,this._formatFeatures[ai.ASTC_RGBA_12X10]|=n,this._formatFeatures[ai.ASTC_RGBA_12X12]|=n,this._formatFeatures[ai.ASTC_SRGBA_4X4]|=n,this._formatFeatures[ai.ASTC_SRGBA_5X4]|=n,this._formatFeatures[ai.ASTC_SRGBA_5X5]|=n,this._formatFeatures[ai.ASTC_SRGBA_6X5]|=n,this._formatFeatures[ai.ASTC_SRGBA_6X6]|=n,this._formatFeatures[ai.ASTC_SRGBA_8X5]|=n,this._formatFeatures[ai.ASTC_SRGBA_8X6]|=n,this._formatFeatures[ai.ASTC_SRGBA_8X8]|=n,this._formatFeatures[ai.ASTC_SRGBA_10X5]|=n,this._formatFeatures[ai.ASTC_SRGBA_10X6]|=n,this._formatFeatures[ai.ASTC_SRGBA_10X8]|=n,this._formatFeatures[ai.ASTC_SRGBA_10X10]|=n,this._formatFeatures[ai.ASTC_SRGBA_12X10]|=n,this._formatFeatures[ai.ASTC_SRGBA_12X12]|=n)},n.createCommandBuffer=function(e){var t=new(e.type===Gi.PRIMARY?u5:i5);return t.initialize(e),t},n.createSwapchain=function(e){var t=new B5;return this._swapchain=t,t.initialize(e),t},n.createBuffer=function(e){var t=new e5;return t.initialize(e),t},n.createTexture=function(e){var t=new v5;return t.initialize(e),t},n.createDescriptorSet=function(e){var t=new C3;return t.initialize(e),t},n.createShader=function(e){var t=new p5;return t.initialize(e),t},n.createInputAssembler=function(e){var t=new o5;return t.initialize(e),t},n.createRenderPass=function(e){var t=new _5;return t.initialize(e),t},n.createFramebuffer=function(e){var t=new r5;return t.initialize(e),t},n.createDescriptorSetLayout=function(e){var t=new a5;return t.initialize(e),t},n.createPipelineLayout=function(e){var t=new s5;return t.initialize(e),t},n.createPipelineState=function(e){var t=new l5;return t.initialize(e),t},n.createQueue=function(e){var t=new h5;return t.initialize(e),t},n.getSampler=function(e){var t=Io.computeHash(e);return this._samplers.has(t)||this._samplers.set(t,new d5(e,t)),this._samplers.get(t)},n.getGeneralBarrier=function(e){var t=Do.computeHash(e);return this._generalBarrierss.has(t)||this._generalBarrierss.set(t,new Do(e,t)),this._generalBarrierss.get(t)},n.getTextureBarrier=function(e){var t=Oo.computeHash(e);return this._textureBarriers.has(t)||this._textureBarriers.set(t,new Oo(e,t)),this._textureBarriers.get(t)},n.copyBuffersToTexture=function(e,t,n){Z3(this,e,t.gpuTexture,n)},n.copyTextureToBuffers=function(e,t,n){!function(e,t,n,i){var r=e.gl,o=e.stateCache,a=r.createFramebuffer();r.bindFramebuffer(r.FRAMEBUFFER,a);var s=0,c=0,l=1,u=1;switch(t.glTarget){case r.TEXTURE_2D:for(var h=0;h<i.length;h++){var _=i[h];r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,t.glTarget,t.glTexture,_.texSubres.mipLevel),s=_.texOffset.x,c=_.texOffset.y,l=_.texExtent.width,u=_.texExtent.height,r.readPixels(s,c,l,u,t.glFormat,t.glType,n[h])}break;default:console.error("Unsupported GL texture type, copy texture to buffers failed.")}r.bindFramebuffer(r.FRAMEBUFFER,null),o.glFramebuffer=null,r.deleteFramebuffer(a)}(this,e.gpuTexture,t,n)},n.copyTexImagesToTexture=function(e,t,n){!function(e,t,n,i){var r=e.gl,o=e.stateCache.glTexUnits[e.stateCache.texUnit];o.glTexture!==n.glTexture&&(r.bindTexture(n.glTarget,n.glTexture),o.glTexture=n.glTexture);var a=0,s=0;switch(n.glTarget){case r.TEXTURE_2D:for(var c=0;c<i.length;c++){var l=i[c];r.texSubImage2D(r.TEXTURE_2D,l.texSubres.mipLevel,l.texOffset.x,l.texOffset.y,n.glFormat,n.glType,t[a++])}break;case r.TEXTURE_CUBE_MAP:for(var u=0;u<i.length;u++){var h=i[u],_=h.texSubres.baseArrayLayer+h.texSubres.layerCount;for(s=h.texSubres.baseArrayLayer;s<_;++s)r.texSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+s,h.texSubres.mipLevel,h.texOffset.x,h.texOffset.y,n.glFormat,n.glType,t[a++])}break;default:console.error("Unsupported GL texture type, copy buffer to texture failed.")}n.flags&pi.GEN_MIPMAP&&n.isPowerOf2&&r.generateMipmap(n.glTarget)}(this,e,t.gpuTexture,n)},h(t,[{key:"gl",get:function(){return this._context}},{key:"extensions",get:function(){return this._swapchain.extensions}},{key:"stateCache",get:function(){return this._swapchain.stateCache}},{key:"nullTex2D",get:function(){return this._swapchain.nullTex2D}},{key:"nullTexCube",get:function(){return this._swapchain.nullTexCube}},{key:"textureExclusive",get:function(){return this._textureExclusive}},{key:"bindingMappings",get:function(){return this._bindingMappings}}]),t}(lo));b.WebGLDevice=z5,e("Billboard",(S5=dc("cc.Billboard"),E5=Oc(),T5=Ic(),C5=Jc(Xm),b5=Jc(Xm),A5=Bc(),w5=Bc(),I5=Bc(),P5=Bc(),S5(R5=E5(R5=T5(R5=wc((F5=function(e){function t(){var t;return E(t=e.call(this)||this,"_texture",O5,y(t)),E(t,"_height",N5,y(t)),E(t,"_width",M5,y(t)),E(t,"_rotation",L5,y(t)),t._model=null,t._mesh=null,t._material=null,t._uniform=new wn(1,1,0,0),t}f(t,e);var n=t.prototype;return n.onLoad=function(){this.createModel()},n.onEnable=function(){this.attachToScene(),this._model.enabled=!0,this.width=this._width,this.height=this._height,this.rotation=this.rotation,this.texture=this.texture},n.onDisable=function(){this.detachFromScene()},n.attachToScene=function(){this._model&&this.node&&this.node.scene&&(this._model.scene&&this.detachFromScene(),this._getRenderScene().addModel(this._model))},n.detachFromScene=function(){this._model&&this._model.scene&&this._model.scene.removeModel(this._model)},n.createModel=function(){this._mesh=RX({primitiveMode:Oi.TRIANGLE_LIST,positions:[0,0,0,0,0,0,0,0,0,0,0,0],uvs:[0,0,1,0,0,1,1,1],colors:[Qn.WHITE.r,Qn.WHITE.g,Qn.WHITE.b,Qn.WHITE.a,Qn.WHITE.r,Qn.WHITE.g,Qn.WHITE.b,Qn.WHITE.a,Qn.WHITE.r,Qn.WHITE.g,Qn.WHITE.b,Qn.WHITE.a,Qn.WHITE.r,Qn.WHITE.g,Qn.WHITE.b,Qn.WHITE.a],attributes:[new br(qi.ATTR_POSITION,ai.RGB32F),new br(qi.ATTR_TEX_COORD,ai.RG32F),new br(qi.ATTR_COLOR,ai.RGBA8UI,!0)],indices:[0,1,2,1,2,3]},void 0,{calculateBounds:!1});var e=this._model=b.director.root.createModel(Ug,this.node);e.node=e.transform=this.node,null==this._material&&(this._material=new Ov,this._material.copy(nv.get("default-billboard-material"))),e.initSubModel(0,this._mesh.renderingSubMeshes[0],this._material)},h(t,[{key:"texture",get:function(){return this._texture},set:function(e){this._texture=e,this._material&&this._material.setProperty("mainTexture",e)}},{key:"height",get:function(){return this._height},set:function(e){this._height=e,this._material&&(this._uniform.y=e,this._material.setProperty("cc_size_rotation",this._uniform))}},{key:"width",get:function(){return this._width},set:function(e){this._width=e,this._material&&(this._uniform.x=e,this._material.setProperty("cc_size_rotation",this._uniform))}},{key:"rotation",get:function(){return Math.round(100*on(this._rotation))/100},set:function(e){this._rotation=rn(e),this._material&&(this._uniform.z=this._rotation,this._material.setProperty("cc_size_rotation",this._uniform))}}]),t}(ku),O5=T((D5=F5).prototype,"_texture",[C5],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),T(D5.prototype,"texture",[b5,A5],Object.getOwnPropertyDescriptor(D5.prototype,"texture"),D5.prototype),N5=T(D5.prototype,"_height",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),T(D5.prototype,"height",[w5],Object.getOwnPropertyDescriptor(D5.prototype,"height"),D5.prototype),M5=T(D5.prototype,"_width",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),T(D5.prototype,"width",[I5],Object.getOwnPropertyDescriptor(D5.prototype,"width"),D5.prototype),L5=T(D5.prototype,"_rotation",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),T(D5.prototype,"rotation",[P5],Object.getOwnPropertyDescriptor(D5.prototype,"rotation"),D5.prototype),R5=D5))||R5)||R5)||R5)||R5));var U5,k5,G5,H5=[new br(qi.ATTR_POSITION,ai.RGB32F),new br(qi.ATTR_TEX_COORD,ai.RGBA32F),new br(qi.ATTR_TEX_COORD1,ai.RGB32F),new br(qi.ATTR_COLOR,ai.RGBA8,!0)],V5=new yn,W5=new yn,j5=function(e){function t(){var t;return(t=e.call(this)||this)._capacity=void 0,t._vertSize=0,t._vBuffer=null,t._vertAttrsFloatCount=0,t._vdataF32=null,t._vdataUint32=null,t._iaInfo=void 0,t._iaInfoBuffer=void 0,t._subMeshData=null,t._vertCount=0,t._indexCount=0,t._material=null,t.type=Ag.LINE,t._capacity=100,t._iaInfo=new _r([new ur]),t._iaInfoBuffer=t._device.createBuffer(new cr(li.INDIRECT,_i.DEVICE,$r,$r)),t}f(t,e);var n=t.prototype;return n.setCapacity=function(e){this._capacity=e,this.createBuffer()},n.createBuffer=function(){this._vertSize=0;for(var e,t=S(H5);!(e=t()).done;){var n=e.value;n.offset=this._vertSize,this._vertSize+=Kr[n.format].size}this._vertAttrsFloatCount=this._vertSize/4,this._vBuffer=this.createSubMeshData(),this._vdataF32=new Float32Array(this._vBuffer),this._vdataUint32=new Uint32Array(this._vBuffer)},n.updateMaterial=function(t){this._material=t,e.prototype.setSubModelMaterial.call(this,0,t)},n.createSubMeshData=function(){this._subMeshData&&this.destroySubMeshData(),this._vertCount=2,this._indexCount=6;var e=this._device.createBuffer(new cr(li.VERTEX|li.TRANSFER_DST,_i.DEVICE,this._vertSize*this._capacity*this._vertCount,this._vertSize)),t=new ArrayBuffer(this._vertSize*this._capacity*this._vertCount);e.update(t);for(var n=new Uint16Array((this._capacity-1)*this._indexCount),i=0,r=0;r<this._capacity-1;++r){var o=2*r;n[i++]=o,n[i++]=o+1,n[i++]=o+2,n[i++]=o+3,n[i++]=o+2,n[i++]=o+1}var a=this._device.createBuffer(new cr(li.INDEX|li.TRANSFER_DST,_i.DEVICE,(this._capacity-1)*this._indexCount*Uint16Array.BYTES_PER_ELEMENT,Uint16Array.BYTES_PER_ELEMENT));return a.update(n),this._iaInfo.drawInfos[0].vertexCount=this._capacity*this._vertCount,this._iaInfo.drawInfos[0].indexCount=(this._capacity-1)*this._indexCount,this._iaInfoBuffer.update(this._iaInfo),this._subMeshData=new HA([e],H5,Oi.TRIANGLE_LIST,a,this._iaInfoBuffer),this.initSubModel(0,this._subMeshData,this._material),t},n.addLineVertexData=function(e,t,n){if(e.length>1){var i=0;yn.subtract(V5,e[1],e[0]),this._vdataF32[i++]=e[0].x,this._vdataF32[i++]=e[0].y,this._vdataF32[i++]=e[0].z,this._vdataF32[i++]=0,this._vdataF32[i++]=t.evaluate(0,1),this._vdataF32[i++]=0,this._vdataF32[i++]=0,this._vdataF32[i++]=V5.x,this._vdataF32[i++]=V5.y,this._vdataF32[i++]=V5.z,this._vdataUint32[i++]=n.evaluate(0,1)._val,this._vdataF32[i++]=e[0].x,this._vdataF32[i++]=e[0].y,this._vdataF32[i++]=e[0].z,this._vdataF32[i++]=1,this._vdataF32[i++]=t.evaluate(0,1),this._vdataF32[i++]=0,this._vdataF32[i++]=1,this._vdataF32[i++]=V5.x,this._vdataF32[i++]=V5.y,this._vdataF32[i++]=V5.z,this._vdataUint32[i++]=n.evaluate(0,1)._val;for(var r=1;r<e.length-1;r++){yn.subtract(V5,e[r-1],e[r]),yn.subtract(W5,e[r+1],e[r]),yn.subtract(W5,W5,V5);var o=r/e.length;this._vdataF32[i++]=e[r].x,this._vdataF32[i++]=e[r].y,this._vdataF32[i++]=e[r].z,this._vdataF32[i++]=0,this._vdataF32[i++]=t.evaluate(o,1),this._vdataF32[i++]=o,this._vdataF32[i++]=0,this._vdataF32[i++]=W5.x,this._vdataF32[i++]=W5.y,this._vdataF32[i++]=W5.z,this._vdataUint32[i++]=n.evaluate(o,1)._val,this._vdataF32[i++]=e[r].x,this._vdataF32[i++]=e[r].y,this._vdataF32[i++]=e[r].z,this._vdataF32[i++]=1,this._vdataF32[i++]=t.evaluate(o,1),this._vdataF32[i++]=o,this._vdataF32[i++]=1,this._vdataF32[i++]=W5.x,this._vdataF32[i++]=W5.y,this._vdataF32[i++]=W5.z,this._vdataUint32[i++]=n.evaluate(o,1)._val}yn.subtract(V5,e[e.length-1],e[e.length-2]),this._vdataF32[i++]=e[e.length-1].x,this._vdataF32[i++]=e[e.length-1].y,this._vdataF32[i++]=e[e.length-1].z,this._vdataF32[i++]=0,this._vdataF32[i++]=t.evaluate(1,1),this._vdataF32[i++]=1,this._vdataF32[i++]=0,this._vdataF32[i++]=V5.x,this._vdataF32[i++]=V5.y,this._vdataF32[i++]=V5.z,this._vdataUint32[i++]=n.evaluate(1,1)._val,this._vdataF32[i++]=e[e.length-1].x,this._vdataF32[i++]=e[e.length-1].y,this._vdataF32[i++]=e[e.length-1].z,this._vdataF32[i++]=1,this._vdataF32[i++]=t.evaluate(1,1),this._vdataF32[i++]=1,this._vdataF32[i++]=1,this._vdataF32[i++]=V5.x,this._vdataF32[i++]=V5.y,this._vdataF32[i++]=V5.z,this._vdataUint32[i++]=n.evaluate(1,1)._val}this.updateIA(Math.max(0,e.length-1))},n.updateIA=function(e){this._subModels[0].inputAssembler.vertexBuffers[0].update(this._vdataF32),this._iaInfo.drawInfos[0].firstIndex=0,this._iaInfo.drawInfos[0].indexCount=this._indexCount*e,this._iaInfoBuffer.update(this._iaInfo)},n.destroySubMeshData=function(){this._subMeshData&&(this._subMeshData.destroy(),this._subMeshData=null)},t}(Ug),q5=jt.Attr.setClassAttr,X5=[["mode","constant","multiplier"],["mode","spline","multiplier"],["mode","splineMin","splineMax","multiplier"],["mode","constantMin","constantMax","multiplier"]],Y5=Je({Constant:0,Curve:1,TwoCurves:2,TwoConstants:3}),K5=e("CurveRange",dc("cc.CurveRange")((G5=k5=function(){function e(){this.mode=Y5.Constant,this.spline=td(),this.splineMin=td(),this.splineMax=td(),this.constant=0,this.constantMin=0,this.constantMax=0,this.multiplier=1}var t=e.prototype;return t.evaluate=function(e,t){switch(this.mode){default:case Y5.Constant:return this.constant;case Y5.Curve:return this.spline.evaluate(e)*this.multiplier;case Y5.TwoCurves:return nn(this.splineMin.evaluate(e),this.splineMax.evaluate(e),t)*this.multiplier;case Y5.TwoConstants:return nn(this.constantMin,this.constantMax,t)}},t.getMax=function(){switch(this.mode){default:case Y5.Constant:return this.constant;case Y5.Curve:return this.multiplier;case Y5.TwoConstants:return this.constantMax;case Y5.TwoCurves:return this.multiplier}},t._onBeforeSerialize=function(){return X5[this.mode]},h(e,[{key:"curve",get:function(){var e;return null!==(e=this._curve)&&void 0!==e?e:this._curve=new Zf(this.spline)},set:function(e){this._curve=e,this.spline=e._internalCurve}},{key:"curveMin",get:function(){var e;return null!==(e=this._curveMin)&&void 0!==e?e:this._curveMin=new Zf(this.splineMin)},set:function(e){this._curveMin=e,this.splineMin=e._internalCurve}},{key:"curveMax",get:function(){var e;return null!==(e=this._curveMax)&&void 0!==e?e:this._curveMax=new Zf(this.splineMax)},set:function(e){this._curveMax=e,this.splineMax=e._internalCurve}}]),e}(),k5.Mode=Y5,U5=G5))||U5);function Q5(e,t,n){switch(e.mode){case Y5.Constant:return e.constant;case Y5.Curve:return e.spline.evaluate(t)*e.multiplier;case Y5.TwoCurves:return 0===n?e.splineMin.evaluate(t)*e.multiplier:e.splineMax.evaluate(t)*e.multiplier;case Y5.TwoConstants:return 0===n?e.constantMin:e.constantMax;default:return 0}}function J5(e){switch(e.mode){case Y5.TwoConstants:case Y5.TwoCurves:return 2;default:return 1}}function Z5(e,t,n){var i=new Cm({width:t,height:n,_data:e,_compressed:!1,format:tm.RGBA32F}),r=new Xm;return r.setFilters(im.NEAREST,im.NEAREST),r.setMipFilter(im.NONE),r.setWrapMode(nm.CLAMP_TO_EDGE,nm.CLAMP_TO_EDGE,nm.CLAMP_TO_EDGE),r.image=i,r}function $5(e,t,n,i,r){for(var o=Math.max(J5(t),J5(n),J5(i)),a=new Float32Array(e*o*4),s=[t,n,i],c=1/(e-1),l=0;l<o;l++)for(var u=0;u<3;u++)for(var h=s[u],_=0,f=0,d=0;d<e;d++){var p=Q5(h,c*d,l);f=r?p:(_+=p)/(d+1),a[4*d+u]=f}return Z5(a,e,o)}jt.fastDefine("cc.CurveRange",K5,{multiplier:1,constantMax:0,constantMin:0,constant:0,mode:Y5.Constant,splineMax:Object.freeze(td()),splineMin:Object.freeze(td()),spline:Object.freeze(td())}),q5(K5,"multiplier","visible",!0),q5(K5,"constantMax","visible",!0),q5(K5,"constantMin","visible",!0),q5(K5,"constant","visible",!0),q5(K5,"mode","type","Enum"),q5(K5,"mode","enumList",Je.getList(Y5)),q5(K5,"mode","visible",!0),q5(K5,"splineMax","type","Object"),q5(K5,"splineMax","ctor",Z_),q5(K5,"splineMax","visible",!0),q5(K5,"splineMin","type","Object"),q5(K5,"splineMin","ctor",Z_),q5(K5,"splineMin","visible",!0),q5(K5,"spline","type","Object"),q5(K5,"spline","ctor",Z_),q5(K5,"spline","visible",!0);var e6=Je({Blend:0,Fixed:1}),t6=e("ColorKey",(function(){this.color=Qn.WHITE.clone(),this.time=0}));jt.fastDefine("cc.ColorKey",t6,{color:Qn.WHITE.clone(),time:0}),jt.Attr.setClassAttr(t6,"color","visible",!0),jt.Attr.setClassAttr(t6,"time","visible",!0);var n6=e("AlphaKey",(function(){this.alpha=1,this.time=0}));jt.fastDefine("cc.AlphaKey",n6,{alpha:1,time:0}),jt.Attr.setClassAttr(n6,"alpha","visible",!0),jt.Attr.setClassAttr(n6,"time","visible",!0);var i6,r6,o6,a6,s6,c6,l6,u6,h6,_6,f6,d6,p6,m6,v6,g6,y6,x6=e("Gradient",function(){function e(){this.colorKeys=new Array,this.alphaKeys=new Array,this.mode=e6.Blend,this._color=void 0,this._color=Qn.WHITE.clone()}var t=e.prototype;return t.setKeys=function(e,t){this.colorKeys=e,this.alphaKeys=t},t.sortKeys=function(){this.colorKeys.length>1&&this.colorKeys.sort((function(e,t){return e.time-t.time})),this.alphaKeys.length>1&&this.alphaKeys.sort((function(e,t){return e.time-t.time}))},t.evaluate=function(e){return this.getRGB(e),this._color._set_a_unsafe(this.getAlpha(e)),this._color},t.randomColor=function(){var e=this.colorKeys[Math.trunc(Math.random()*this.colorKeys.length)],t=this.alphaKeys[Math.trunc(Math.random()*this.alphaKeys.length)];return this._color.set(e.color),this._color._set_a_unsafe(t.alpha),this._color},t.getRGB=function(e){if(this.colorKeys.length>1){e=fn(e,1);for(var t=1;t<this.colorKeys.length;++t){var n=this.colorKeys[t-1].time,i=this.colorKeys[t].time;if(e>=n&&e<i){if(this.mode===e6.Fixed)return this.colorKeys[t].color;var r=(e-n)/(i-n);return Qn.lerp(this._color,this.colorKeys[t-1].color,this.colorKeys[t].color,r),this._color}}var o=this.colorKeys.length-1;return e<this.colorKeys[0].time?Qn.lerp(this._color,Qn.BLACK,this.colorKeys[0].color,e/this.colorKeys[0].time):e>this.colorKeys[o].time&&Qn.lerp(this._color,this.colorKeys[o].color,Qn.BLACK,(e-this.colorKeys[o].time)/(1-this.colorKeys[o].time)),this._color}return 1===this.colorKeys.length?(this._color.set(this.colorKeys[0].color),this._color):(this._color.set(Qn.WHITE),this._color)},t.getAlpha=function(e){if(this.alphaKeys.length>1){e=fn(e,1);for(var t=1;t<this.alphaKeys.length;++t){var n=this.alphaKeys[t-1].time,i=this.alphaKeys[t].time;if(e>=n&&e<i){if(this.mode===e6.Fixed)return this.alphaKeys[t].alpha;var r=(e-n)/(i-n);return nn(this.alphaKeys[t-1].alpha,this.alphaKeys[t].alpha,r)}}var o=this.alphaKeys.length-1;return e<this.alphaKeys[0].time?nn(0,this.alphaKeys[0].alpha,e/this.alphaKeys[0].time):e>this.alphaKeys[o].time?nn(this.alphaKeys[o].alpha,0,(e-this.alphaKeys[o].time)/(1-this.alphaKeys[o].time)):255}return 1===this.alphaKeys.length?this.alphaKeys[0].alpha:255},e}());x6.Mode=e6,jt.fastDefine("cc.Gradient",x6,{colorKeys:[],alphaKeys:[],mode:e6.Blend}),jt.Attr.setClassAttr(x6,"colorKeys","visible",!0),jt.Attr.setClassAttr(x6,"alphaKeys","visible",!0),jt.Attr.setClassAttr(x6,"mode","visible",!0);var S6,E6,T6,C6,b6,A6,w6,I6,P6,R6,D6,O6,N6,M6,L6,F6,B6,z6,U6,k6,G6,H6,V6,W6,j6,q6,X6,Y6,K6,Q6,J6,Z6,$6,e8,t8,n8,i8,r8,o8=Je({Color:0,Gradient:1,TwoColors:2,TwoGradients:3,RandomColor:4}),a8=e("GradientRange",(i6=dc("cc.GradientRange"),r6=Jc(o8),o6=Jc(x6),a6=Jc(x6),s6=Jc(x6),c6=Jc(o8),i6((y6=g6=function(){function e(){E(this,"color",h6,this),E(this,"colorMin",_6,this),E(this,"colorMax",f6,this),E(this,"gradient",d6,this),E(this,"gradientMin",p6,this),E(this,"gradientMax",m6,this),E(this,"_mode",v6,this),this._color=Qn.WHITE.clone()}var t=e.prototype;return t.evaluate=function(e,t){switch(this._mode){case o8.Color:return this.color;case o8.TwoColors:return Qn.lerp(this._color,this.colorMin,this.colorMax,t),this._color;case o8.RandomColor:return this.gradient.randomColor();case o8.Gradient:return this.gradient.evaluate(e);case o8.TwoGradients:return Qn.lerp(this._color,this.gradientMin.evaluate(e),this.gradientMax.evaluate(e),t),this._color;default:return this.color}},t._onBeforeSerialize=function(){return(!1)[this._mode]},h(e,[{key:"mode",get:function(){return this._mode},set:function(e){this._mode=e}}]),e}(),g6.Mode=o8,T((u6=y6).prototype,"mode",[r6],Object.getOwnPropertyDescriptor(u6.prototype,"mode"),u6.prototype),h6=T(u6.prototype,"color",[Ec,Nc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Qn.WHITE.clone()}}),_6=T(u6.prototype,"colorMin",[Ec,Nc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Qn.WHITE.clone()}}),f6=T(u6.prototype,"colorMax",[Ec,Nc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Qn.WHITE.clone()}}),d6=T(u6.prototype,"gradient",[o6],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new x6}}),p6=T(u6.prototype,"gradientMin",[a6],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new x6}}),m6=T(u6.prototype,"gradientMax",[s6],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new x6}}),v6=T(u6.prototype,"_mode",[c6],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return o8.Color}}),l6=u6))||l6));function s8(e,t,n){switch(e.mode){case o8.Color:return e.color;case o8.TwoColors:return 0===n?e.colorMin:e.colorMax;case o8.RandomColor:return e.gradient.randomColor();case o8.Gradient:return e.gradient.evaluate(t);case o8.TwoGradients:return 0===n?e.gradientMin.evaluate(t):e.gradientMax.evaluate(t);default:return e.color}}var c8={parent:null,owner:null,subModelIdx:0},l8={CC_USE_WORLD_SPACE:!1},u8=(e("Line",(S6=dc("cc.Line"),E6=Oc(),T6=Ic(),C6=Jc(Xm),b6=Jc(Xm),A6=Vc(),w6=Bc(),I6=Vc(),P6=Bc(),R6=Jc([yn]),D6=Jc([yn]),O6=Vc(),N6=Bc(),M6=Jc(K5),L6=Jc(K5),F6=zc(),B6=Vc(),z6=Bc(),U6=Jc(Tn),k6=Vc(),G6=Bc(),H6=Jc(Tn),V6=Vc(),W6=Bc(),j6=Jc(a8),q6=Jc(a8),X6=Vc(),Y6=Bc(),S6(K6=E6(K6=T6(K6=wc((r8=function(e){function t(){var t;return E(t=e.call(this)||this,"_texture",J6,y(t)),t._material=null,t._materialInstance=null,E(t,"_worldSpace",Z6,y(t)),E(t,"_positions",$6,y(t)),E(t,"_width",e8,y(t)),E(t,"_tile",t8,y(t)),E(t,"_offset",n8,y(t)),E(t,"_color",i8,y(t)),t._model=null,t._tile_offset=new wn,t}f(t,e);var n=t.prototype;return n.onLoad=function(){var e=this._model=b.director.root.createModel(j5);e.node=e.transform=this.node,null===this._material&&(this._material=new Ov,this._material.copy(nv.get("default-trail-material")),l8.CC_USE_WORLD_SPACE=this.worldSpace,c8.parent=this._material,c8.subModelIdx=0,this._materialInstance=new Hg(c8),c8.parent=null,c8.subModelIdx=0,this._materialInstance.recompileShaders(l8)),e.updateMaterial(this._materialInstance),e.setCapacity(100)},n.onEnable=function(){this._model&&(this._attachToScene(),this.texture=this._texture,this.tile=this._tile,this.offset=this._offset,this._model.addLineVertexData(this._positions,this._width,this._color))},n.onDisable=function(){this._model&&this._detachFromScene()},n._attachToScene=function(){this._model&&this.node&&this.node.scene&&(this._model.scene&&this._detachFromScene(),this._getRenderScene().addModel(this._model))},n._detachFromScene=function(){this._model&&this._model.scene&&this._model.scene.removeModel(this._model)},h(t,[{key:"texture",get:function(){return this._texture},set:function(e){this._texture=e,this._materialInstance&&this._materialInstance.setProperty("mainTexture",e)}},{key:"worldSpace",get:function(){return this._worldSpace},set:function(e){this._worldSpace=e,this._materialInstance&&(l8.CC_USE_WORLD_SPACE=this.worldSpace,this._materialInstance.recompileShaders(l8),this._model&&this._model.setSubModelMaterial(0,this._materialInstance))}},{key:"positions",get:function(){return this._positions},set:function(e){this._positions=e,this._model&&this._model.addLineVertexData(this._positions,this._width,this._color)}},{key:"width",get:function(){return this._width},set:function(e){this._width=e,this._model&&this._model.addLineVertexData(this._positions,this._width,this._color)}},{key:"tile",get:function(){return this._tile},set:function(e){this._tile.set(e),this._materialInstance&&(this._tile_offset.x=this._tile.x,this._tile_offset.y=this._tile.y,this._materialInstance.setProperty("mainTiling_Offset",this._tile_offset))}},{key:"offset",get:function(){return this._offset},set:function(e){this._offset.set(e),this._materialInstance&&(this._tile_offset.z=this._offset.x,this._tile_offset.w=this._offset.y,this._materialInstance.setProperty("mainTiling_Offset",this._tile_offset))}},{key:"color",get:function(){return this._color},set:function(e){this._color=e,this._model&&this._model.addLineVertexData(this._positions,this._width,this._color)}}]),t}(ku),J6=T((Q6=r8).prototype,"_texture",[C6],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),T(Q6.prototype,"texture",[b6,A6,w6],Object.getOwnPropertyDescriptor(Q6.prototype,"texture"),Q6.prototype),Z6=T(Q6.prototype,"_worldSpace",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),T(Q6.prototype,"worldSpace",[I6,P6],Object.getOwnPropertyDescriptor(Q6.prototype,"worldSpace"),Q6.prototype),$6=T(Q6.prototype,"_positions",[R6],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),T(Q6.prototype,"positions",[D6,O6,N6],Object.getOwnPropertyDescriptor(Q6.prototype,"positions"),Q6.prototype),e8=T(Q6.prototype,"_width",[M6],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new K5}}),T(Q6.prototype,"width",[L6,F6,B6,z6],Object.getOwnPropertyDescriptor(Q6.prototype,"width"),Q6.prototype),t8=T(Q6.prototype,"_tile",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Tn(1,1)}}),T(Q6.prototype,"tile",[U6,k6,G6],Object.getOwnPropertyDescriptor(Q6.prototype,"tile"),Q6.prototype),n8=T(Q6.prototype,"_offset",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Tn(0,0)}}),T(Q6.prototype,"offset",[H6,V6,W6],Object.getOwnPropertyDescriptor(Q6.prototype,"offset"),Q6.prototype),i8=T(Q6.prototype,"_color",[j6],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new a8}}),T(Q6.prototype,"color",[q6,X6,Y6],Object.getOwnPropertyDescriptor(Q6.prototype,"color"),Q6.prototype),K6=Q6))||K6)||K6)||K6)||K6)),function(){function e(e){this.particleSystem=void 0,this.position=void 0,this.velocity=void 0,this.animatedVelocity=void 0,this.ultimateVelocity=void 0,this.angularVelocity=void 0,this.axisOfRotation=void 0,this.rotation=void 0,this.startEuler=void 0,this.startRotation=void 0,this.startRotated=void 0,this.deltaQuat=void 0,this.deltaMat=void 0,this.localMat=void 0,this.startSize=void 0,this.size=void 0,this.startColor=void 0,this.color=void 0,this.randomSeed=void 0,this.remainingLifetime=void 0,this.loopCount=void 0,this.lastLoop=void 0,this.trailDelay=void 0,this.startLifetime=void 0,this.emitAccumulator0=void 0,this.emitAccumulator1=void 0,this.frameIndex=void 0,this.startRow=void 0,this.particleSystem=e,this.position=new yn(0,0,0),this.velocity=new yn(0,0,0),this.animatedVelocity=new yn(0,0,0),this.ultimateVelocity=new yn(0,0,0),this.angularVelocity=new yn(0,0,0),this.axisOfRotation=new yn(0,0,0),this.rotation=new yn(0,0,0),this.startEuler=new yn(0,0,0),this.startRotation=new On,this.startRotated=!1,this.deltaQuat=new On,this.deltaMat=new kn,this.localMat=new kn,this.startSize=new yn(0,0,0),this.size=new yn(0,0,0),this.startColor=Qn.WHITE.clone(),this.color=Qn.WHITE.clone(),this.randomSeed=0,this.remainingLifetime=0,this.loopCount=0,this.lastLoop=0,this.trailDelay=0,this.startLifetime=0,this.emitAccumulator0=0,this.emitAccumulator1=0,this.frameIndex=0,this.startRow=0}return e.prototype.reset=function(){this.rotation.set(0,0,0),this.startEuler.set(0,0,0),this.startRotation.set(0,0,0,1),this.startRotated=!1,this.deltaQuat.set(0,0,0,1),this.deltaMat.identity(),this.localMat.identity()},e}());u8.INDENTIFY_NEG_QUAT=10,u8.R2D=180/Math.PI;var h8,_8,f8,d8,p8,m8,v8,g8,y8,x8,S8,E8,T8,C8,b8,A8,w8,I8,P8,R8,D8,O8,N8,M8,L8,F8,B8,z8,U8,k8,G8,H8,V8,W8,j8="colorModule",q8="rotationModule",X8="sizeModule",Y8="textureModule",K8=["sizeModule","colorModule","forceModule","velocityModule","limitModule","rotationModule","textureModule"],Q8=["_colorOverLifetimeModule","_shapeModule","_sizeOvertimeModule","_velocityOvertimeModule","_forceOvertimeModule","_limitVelocityOvertimeModule","_rotationOvertimeModule","_textureAnimationModule","_trailModule"],J8=function(){function e(){this.target=null,this.needUpdate=!1,this.needAnimate=!0,this.name=void 0}var t=e.prototype;return t.bindTarget=function(e){this.target=e},t.update=function(){},e}(),Z8=Je({World:0,Local:1,Custom:2}),$8=Je({Pause:0,PauseAndCatchup:1,AlwaysSimulate:2}),e7=Je({World:0,Local:1,View:2}),t7=Je({Billboard:0,StrecthedBillboard:1,HorizontalBillboard:2,VerticalBillboard:3,Mesh:4}),n7=Je({Box:0,Circle:1,Cone:2,Sphere:3,Hemisphere:4}),i7=Je({Base:0,Edge:1,Shell:2,Volume:3}),r7=Je({Random:0,Loop:1,PingPong:2}),o7=Je({Particles:0}),a7=Je({Stretch:0}),s7=(h8=dc("cc.ColorOvertimeModule"),_8=Vc(),f8=Jc(a8),d8=Vc(),h8((y8=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return E(t=e.call.apply(e,[this].concat(i))||this,"_enable",v8,y(t)),E(t,"color",g8,y(t)),t.name=j8,t}return f(t,e),t.prototype.animate=function(e){e.color.set(e.startColor),e.color.multiply(this.color.evaluate(1-e.remainingLifetime/e.startLifetime,ln(e.randomSeed+91041)))},h(t,[{key:"enable",get:function(){return this._enable},set:function(e){this._enable!==e&&(this._enable=e,this.target&&this.target.enableModule(this.name,e,this))}}]),t}(J8),v8=T((m8=y8).prototype,"_enable",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),T(m8.prototype,"enable",[_8],Object.getOwnPropertyDescriptor(m8.prototype,"enable"),m8.prototype),g8=T(m8.prototype,"color",[f8,Ec,d8],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new a8}}),p8=m8))||p8),c7=new yn(0,0,-1);function l7(e,t,n,i){return t!==e?(e===Z8.World||kn.invert(n,n),kn.getRotation(i,n),!0):(On.set(i,0,0,0,1),!1)}function u7(e,t){Tn.set(e,Math.cos(t),Math.sin(t))}function h7(e){var t=sn(-1,1),n=sn(0,2*Math.PI),i=Math.sqrt(1-t*t),r=i*Math.cos(n),o=i*Math.sin(n);yn.set(e,r,o,t)}function _7(e,t,n){h7(e),yn.multiplyScalar(e,e,t+(n-t)*an())}function f7(e,t,n,i){u7(e,i),e.z=0,yn.multiplyScalar(e,e,t+(n-t)*an())}function d7(e){for(var t=0;t<e.length;t++){var n=t+cn(0,e.length-t),i=e[n];e[n]=e[t],e[t]=i}}function p7(){var e=sn(-1,1);return 0===e&&e++,i(e)}var m7,v7,g7,y7,x7,S7,E7,T7,C7,b7,A7,w7,I7,P7,R7,D7,O7,N7,M7,L7,F7,B7,z7,U7,k7,G7,H7,V7,W7,j7,q7,X7,Y7,K7,Q7,J7,Z7,$7,e9,t9,n9,i9,r9,o9,a9,s9,c9,l9,u9,h9,_9,f9,d9,p9,m9,v9,g9,y9,x9,S9,E9=212165,T9=new yn,C9=(x8=dc("cc.ForceOvertimeModule"),S8=Vc(),E8=Jc(K5),T8=zc(),C8=Vc(),b8=Bc(),A8=Jc(K5),w8=zc(),I8=Vc(),P8=Bc(),R8=Jc(K5),D8=zc(),O8=Vc(),N8=Bc(),M8=Jc(Z8),L8=Vc(),F8=Bc(),x8((W8=function(e){function t(){var t;return E(t=e.call(this)||this,"_enable",U8,y(t)),E(t,"x",k8,y(t)),E(t,"y",G8,y(t)),E(t,"z",H8,y(t)),E(t,"space",V8,y(t)),t.randomized=!1,t.rotation=void 0,t.needTransform=void 0,t.name="forceModule",t.rotation=new On,t.needTransform=!1,t.needUpdate=!0,t}f(t,e);var n=t.prototype;return n.update=function(e,t){this.needTransform=l7(e,this.space,t,this.rotation)},n.animate=function(e,t){var n=1-e.remainingLifetime/e.startLifetime,i=yn.set(T9,this.x.evaluate(n,ln(e.randomSeed+E9)),this.y.evaluate(n,ln(e.randomSeed+E9)),this.z.evaluate(n,ln(e.randomSeed+E9)));this.needTransform&&yn.transformQuat(i,i,this.rotation),yn.scaleAndAdd(e.velocity,e.velocity,i,t),yn.copy(e.ultimateVelocity,e.velocity)},h(t,[{key:"enable",get:function(){return this._enable},set:function(e){this._enable!==e&&(this._enable=e,this.target&&this.target.enableModule(this.name,e,this))}}]),t}(J8),U8=T((z8=W8).prototype,"_enable",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),T(z8.prototype,"enable",[S8],Object.getOwnPropertyDescriptor(z8.prototype,"enable"),z8.prototype),k8=T(z8.prototype,"x",[E8,Ec,T8,C8,b8],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new K5}}),G8=T(z8.prototype,"y",[A8,Ec,w8,I8,P8],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new K5}}),H8=T(z8.prototype,"z",[R8,Ec,D8,O8,N8],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new K5}}),V8=T(z8.prototype,"space",[M8,Ec,L8,F8],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Z8.Local}}),B8=z8))||B8),b9=23541,A9=new yn,w9=new yn,I9=(m7=dc("cc.LimitVelocityOvertimeModule"),v7=Vc(),g7=Jc(K5),y7=zc(),x7=Vc(),S7=Bc(),E7=Jc(K5),T7=zc(),C7=Vc(),b7=Bc(),A7=Jc(K5),w7=zc(),I7=Vc(),P7=Bc(),R7=Jc(K5),D7=zc(),O7=Vc(),N7=Bc(),M7=Vc(),L7=Bc(),F7=Vc(),B7=Bc(),z7=Jc(Z8),U7=Vc(),k7=Bc(),m7((J7=function(e){function t(){var t;return E(t=e.call(this)||this,"_enable",V7,y(t)),E(t,"limitX",W7,y(t)),E(t,"limitY",j7,y(t)),E(t,"limitZ",q7,y(t)),E(t,"limit",X7,y(t)),E(t,"dampen",Y7,y(t)),E(t,"separateAxes",K7,y(t)),E(t,"space",Q7,y(t)),t.drag=null,t.multiplyDragByParticleSize=!1,t.multiplyDragByParticleVelocity=!1,t.name="limitModule",t.rotation=void 0,t.needTransform=void 0,t.rotation=new On,t.needTransform=!1,t.needUpdate=!0,t}f(t,e);var n=t.prototype;return n.update=function(e,t){this.needTransform=l7(e,this.space,t,this.rotation)},n.animate=function(e){var t=1-e.remainingLifetime/e.startLifetime,n=A9;this.separateAxes?(yn.set(w9,this.limitX.evaluate(t,ln(e.randomSeed+b9)),this.limitY.evaluate(t,ln(e.randomSeed+b9)),this.limitZ.evaluate(t,ln(e.randomSeed+b9))),this.needTransform&&yn.transformQuat(w9,w9,this.rotation),yn.set(n,P9(e.ultimateVelocity.x,w9.x,this.dampen),P9(e.ultimateVelocity.y,w9.y,this.dampen),P9(e.ultimateVelocity.z,w9.z,this.dampen))):(yn.normalize(n,e.ultimateVelocity),yn.multiplyScalar(n,n,P9(e.ultimateVelocity.length(),this.limit.evaluate(t,ln(e.randomSeed+b9)),this.dampen))),yn.copy(e.ultimateVelocity,n)},h(t,[{key:"enable",get:function(){return this._enable},set:function(e){this._enable!==e&&(this._enable=e,this.target&&this.target.enableModule(this.name,e,this))}}]),t}(J8),V7=T((H7=J7).prototype,"_enable",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),T(H7.prototype,"enable",[v7],Object.getOwnPropertyDescriptor(H7.prototype,"enable"),H7.prototype),W7=T(H7.prototype,"limitX",[g7,Ec,y7,x7,S7],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new K5}}),j7=T(H7.prototype,"limitY",[E7,Ec,T7,C7,b7],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new K5}}),q7=T(H7.prototype,"limitZ",[A7,Ec,w7,I7,P7],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new K5}}),X7=T(H7.prototype,"limit",[R7,Ec,D7,O7,N7],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new K5}}),Y7=T(H7.prototype,"dampen",[Ec,M7,L7],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 3}}),K7=T(H7.prototype,"separateAxes",[Ec,F7,B7],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Q7=T(H7.prototype,"space",[z7,Ec,U7,k7],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Z8.Local}}),G7=H7))||G7);function P9(e,t,n){var i=Math.sign(e),r=Math.abs(e);return r>t&&(r=nn(r,t,n)),r*i}var R9,D9,O9,N9,M9,L9,F9,B9,z9,U9,k9,G9,H9,V9,W9,j9,q9,X9,Y9,K9,Q9,J9,Z9,$9,eee,tee,nee,iee,ree,oee,aee,see,cee,lee,uee,hee,_ee,fee,dee,pee,mee,vee,gee,yee,xee,See,Eee,Tee,Cee,bee,Aee,wee,Iee,Pee,Ree,Dee,Oee,Nee,Mee,Lee,Fee,Bee,zee,Uee,kee,Gee,Hee,Vee,Wee,jee,qee,Xee,Yee,Kee,Qee,Jee,Zee,$ee,ete,tte,nte,ite,rte,ote,ate,ste,cte,lte,ute,hte,_te,fte,dte,pte,mte,vte,gte,yte,xte,Ste,Ete,Tte,Cte,bte,Ate,wte,Ite,Pte,Rte,Dte,Ote,Nte,Mte,Lte,Fte,Bte,zte,Ute,kte,Gte,Hte,Vte,Wte,jte,qte,Xte,Yte,Kte,Qte,Jte,Zte,$te,ene,tne,nne,ine,rne,one,ane,sne,cne,lne,une,hne,_ne,fne,dne,pne,mne,vne,gne,yne,xne,Sne,Ene,Tne,Cne,bne,Ane,wne,Ine,Pne,Rne,Dne,One,Nne,Mne,Lne,Fne,Bne,zne,Une,kne,Gne,Hne,Vne,Wne,jne,qne,Xne,Yne,Kne,Qne=(Z7=dc("cc.RotationOvertimeModule"),$7=Vc(),e9=Vc(),t9=Bc(),n9=Jc(K5),i9=zc(),r9=Vc(),o9=Bc(),a9=Jc(K5),s9=zc(),c9=Vc(),l9=Bc(),u9=Jc(K5),h9=zc(),_9=Vc(),f9=Bc(),Z7((S9=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return E(t=e.call.apply(e,[this].concat(i))||this,"_enable",m9,y(t)),E(t,"_separateAxes",v9,y(t)),E(t,"x",g9,y(t)),E(t,"y",y9,y(t)),E(t,"z",x9,y(t)),t.name=q8,t._startMat=new kn,t._matRot=new kn,t._quatRot=new On,t._otherEuler=new yn,t}f(t,e);var n=t.prototype;return n._processRotation=function(e){var t=e.particleSystem.processor.getInfo().renderMode;t!==t7.Mesh&&t===t7.StrecthedBillboard&&this._quatRot.set(0,0,0,1),On.normalize(this._quatRot,this._quatRot),this._quatRot.w<0&&(this._quatRot.x+=u8.INDENTIFY_NEG_QUAT)},n.animate=function(e,t){var n=1-e.remainingLifetime/e.startLifetime,i=ln(e.randomSeed+125292),r=e.particleSystem.processor.getInfo().renderMode;this._separateAxes&&r!==t7.VerticalBillboard&&r!==t7.HorizontalBillboard?On.fromEuler(e.deltaQuat,this.x.evaluate(n,i)*t*u8.R2D,this.y.evaluate(n,i)*t*u8.R2D,this.z.evaluate(n,i)*t*u8.R2D):On.fromEuler(e.deltaQuat,0,0,this.z.evaluate(n,i)*t*u8.R2D),e.deltaMat=kn.fromQuat(e.deltaMat,e.deltaQuat),e.localMat=e.localMat.multiply(e.deltaMat),e.startRotated||(r!==t7.Mesh&&(r===t7.StrecthedBillboard?e.startEuler.set(0,0,0):r!==t7.Billboard&&e.startEuler.set(0,0,e.startEuler.z)),On.fromEuler(e.startRotation,e.startEuler.x*u8.R2D,e.startEuler.y*u8.R2D,e.startEuler.z*u8.R2D),e.startRotated=!0),this._startMat=kn.fromQuat(this._startMat,e.startRotation),this._matRot=this._startMat.multiply(e.localMat),kn.getRotation(this._quatRot,this._matRot),this._processRotation(e,u8.R2D),e.rotation.set(this._quatRot.x,this._quatRot.y,this._quatRot.z)},h(t,[{key:"enable",get:function(){return this._enable},set:function(e){this._enable!==e&&(this._enable=e,this.target&&this.target.enableModule(this.name,e,this))}},{key:"separateAxes",get:function(){return this._separateAxes},set:function(e){this._separateAxes=e}}]),t}(J8),m9=T((p9=S9).prototype,"_enable",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),T(p9.prototype,"enable",[$7],Object.getOwnPropertyDescriptor(p9.prototype,"enable"),p9.prototype),v9=T(p9.prototype,"_separateAxes",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),T(p9.prototype,"separateAxes",[e9,t9],Object.getOwnPropertyDescriptor(p9.prototype,"separateAxes"),p9.prototype),g9=T(p9.prototype,"x",[n9,Ec,i9,Wc,r9,o9],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new K5}}),y9=T(p9.prototype,"y",[a9,Ec,s9,Wc,c9,l9],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new K5}}),x9=T(p9.prototype,"z",[u9,Ec,h9,Wc,_9,f9],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new K5}}),d9=p9))||d9),Jne=(R9=dc("cc.SizeOvertimeModule"),D9=Vc(),O9=Vc(),N9=Bc(),M9=Jc(K5),L9=zc(),F9=Vc(),B9=Bc(),z9=Jc(K5),U9=zc(),k9=Vc(),G9=Bc(),H9=Jc(K5),V9=zc(),W9=Vc(),j9=Bc(),q9=Jc(K5),X9=zc(),Y9=Vc(),K9=Bc(),R9((ree=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return E(t=e.call.apply(e,[this].concat(i))||this,"_enable",Z9,y(t)),E(t,"separateAxes",$9,y(t)),E(t,"size",eee,y(t)),E(t,"x",tee,y(t)),E(t,"y",nee,y(t)),E(t,"z",iee,y(t)),t.name=X8,t}return f(t,e),t.prototype.animate=function(e){if(this.separateAxes){var t=1-e.remainingLifetime/e.startLifetime,n=ln(e.randomSeed+39825);e.size.x=e.startSize.x*this.x.evaluate(t,n),e.size.y=e.startSize.y*this.y.evaluate(t,n),e.size.z=e.startSize.z*this.z.evaluate(t,n)}else yn.multiplyScalar(e.size,e.startSize,this.size.evaluate(1-e.remainingLifetime/e.startLifetime,ln(e.randomSeed+39825)))},h(t,[{key:"enable",get:function(){return this._enable},set:function(e){this._enable!==e&&(this._enable=e,this.target&&this.target.enableModule(this.name,e,this))}}]),t}(J8),Z9=T((J9=ree).prototype,"_enable",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),T(J9.prototype,"enable",[D9],Object.getOwnPropertyDescriptor(J9.prototype,"enable"),J9.prototype),$9=T(J9.prototype,"separateAxes",[Ec,O9,N9],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),eee=T(J9.prototype,"size",[M9,Ec,L9,F9,B9],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new K5}}),tee=T(J9.prototype,"x",[z9,Ec,U9,k9,G9],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new K5}}),nee=T(J9.prototype,"y",[H9,Ec,V9,W9,j9],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new K5}}),iee=T(J9.prototype,"z",[q9,Ec,X9,Y9,K9],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new K5}}),Q9=J9))||Q9),Zne=90794,$ne=Je({Grid:0}),eie=Je({WholeSheet:0,SingleRow:1}),tie=(oee=dc("cc.TextureAnimationModule"),aee=Tc("numTilesX"),see=Tc("numTilesY"),cee=Vc(),lee=Jc($ne),uee=Jc($ne),hee=Vc(),_ee=Bc(),fee=Vc(),dee=Bc(),pee=Vc(),mee=Bc(),vee=Jc(eie),gee=Vc(),yee=Bc(),xee=Jc(K5),See=zc(),Eee=Vc(),Tee=Bc(),Cee=Jc(K5),bee=zc(),Aee=Vc(),wee=Bc(),Iee=Vc(),Pee=Bc(),Ree=Vc(),Dee=Bc(),Oee=Vc(),Nee=Bc(),oee((Kee=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return E(t=e.call.apply(e,[this].concat(i))||this,"_enable",Fee,y(t)),E(t,"_numTilesX",Bee,y(t)),E(t,"_numTilesY",zee,y(t)),E(t,"_mode",Uee,y(t)),E(t,"animation",kee,y(t)),E(t,"frameOverTime",Gee,y(t)),E(t,"startFrame",Hee,y(t)),E(t,"cycleCount",Vee,y(t)),E(t,"_flipU",Wee,y(t)),E(t,"_flipV",jee,y(t)),E(t,"_uvChannelMask",qee,y(t)),E(t,"randomRow",Xee,y(t)),E(t,"rowIndex",Yee,y(t)),t.name=Y8,t}f(t,e);var n=t.prototype;return n.init=function(e){e.startRow=Math.floor(Math.random()*this.numTilesY)},n.animate=function(e){var t=1-e.remainingLifetime/e.startLifetime,n=this.startFrame.evaluate(t,ln(e.randomSeed+Zne))/(this.numTilesX*this.numTilesY);if(this.animation===eie.WholeSheet)e.frameIndex=fn(this.cycleCount*(this.frameOverTime.evaluate(t,ln(e.randomSeed+Zne))+n),1);else if(this.animation===eie.SingleRow){var i=1/this.numTilesY;if(this.randomRow){var r=fn(this.cycleCount*(this.frameOverTime.evaluate(t,ln(e.randomSeed+Zne))+n),1),o=e.startRow*i,a=o+i;e.frameIndex=nn(o,a,r)}else{var s=this.rowIndex*i,c=s+i;e.frameIndex=nn(s,c,fn(this.cycleCount*(this.frameOverTime.evaluate(t,ln(e.randomSeed+Zne))+n),1))}}},h(t,[{key:"enable",get:function(){return this._enable},set:function(e){this._enable!==e&&(this._enable=e,this.target&&(this.target.updateMaterialParams(),this.target.enableModule(this.name,e,this)))}},{key:"mode",get:function(){return this._mode},set:function(e){e!==$ne.Grid&&console.error("particle texture animation's sprites is not supported!")}},{key:"numTilesX",get:function(){return this._numTilesX},set:function(e){this._numTilesX!==e&&(this._numTilesX=e,this.target.updateMaterialParams())}},{key:"numTilesY",get:function(){return this._numTilesY},set:function(e){this._numTilesY!==e&&(this._numTilesY=e,this.target.updateMaterialParams())}},{key:"flipU",get:function(){return this._flipU},set:function(){console.error("particle texture animation's flipU is not supported!")}},{key:"flipV",get:function(){return this._flipV},set:function(){console.error("particle texture animation's flipV is not supported!")}},{key:"uvChannelMask",get:function(){return this._uvChannelMask},set:function(){console.error("particle texture animation's uvChannelMask is not supported!")}}]),t}(J8),Fee=T((Lee=Kee).prototype,"_enable",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Bee=T(Lee.prototype,"_numTilesX",[aee],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),zee=T(Lee.prototype,"_numTilesY",[see],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),T(Lee.prototype,"enable",[cee],Object.getOwnPropertyDescriptor(Lee.prototype,"enable"),Lee.prototype),Uee=T(Lee.prototype,"_mode",[lee],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return $ne.Grid}}),T(Lee.prototype,"mode",[uee,hee,_ee],Object.getOwnPropertyDescriptor(Lee.prototype,"mode"),Lee.prototype),T(Lee.prototype,"numTilesX",[fee,dee],Object.getOwnPropertyDescriptor(Lee.prototype,"numTilesX"),Lee.prototype),T(Lee.prototype,"numTilesY",[pee,mee],Object.getOwnPropertyDescriptor(Lee.prototype,"numTilesY"),Lee.prototype),kee=T(Lee.prototype,"animation",[vee,Ec,gee,yee],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return eie.WholeSheet}}),Gee=T(Lee.prototype,"frameOverTime",[xee,Ec,See,Eee,Tee],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new K5}}),Hee=T(Lee.prototype,"startFrame",[Cee,Ec,bee,Aee,wee],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new K5}}),Vee=T(Lee.prototype,"cycleCount",[Ec,Iee,Pee],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Wee=T(Lee.prototype,"_flipU",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),jee=T(Lee.prototype,"_flipV",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),qee=T(Lee.prototype,"_uvChannelMask",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),Xee=T(Lee.prototype,"randomRow",[Ec,Ree,Dee],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Yee=T(Lee.prototype,"rowIndex",[Ec,Oee,Nee],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Mee=Lee))||Mee),nie=197866,iie=new yn,rie=(Qee=dc("cc.VelocityOvertimeModule"),Jee=Vc(),Zee=Jc(K5),$ee=zc(),ete=Vc(),tte=Bc(),nte=Jc(K5),ite=zc(),rte=Vc(),ote=Bc(),ate=Jc(K5),ste=zc(),cte=Vc(),lte=Bc(),ute=Jc(K5),hte=zc(),_te=Vc(),fte=Bc(),dte=Jc(Z8),pte=Vc(),mte=Bc(),Qee((bte=function(e){function t(){var t;return E(t=e.call(this)||this,"_enable",yte,y(t)),E(t,"x",xte,y(t)),E(t,"y",Ste,y(t)),E(t,"z",Ete,y(t)),E(t,"speedModifier",Tte,y(t)),E(t,"space",Cte,y(t)),t.rotation=void 0,t.needTransform=void 0,t.name="velocityModule",t.rotation=new On,t.speedModifier.constant=1,t.needTransform=!1,t.needUpdate=!0,t}f(t,e);var n=t.prototype;return n.update=function(e,t){this.needTransform=l7(e,this.space,t,this.rotation)},n.animate=function(e){var t=1-e.remainingLifetime/e.startLifetime,n=yn.set(iie,this.x.evaluate(t,ln(e.randomSeed^nie)),this.y.evaluate(t,ln(156497^e.randomSeed)),this.z.evaluate(t,ln(984136^e.randomSeed)));this.needTransform&&yn.transformQuat(n,n,this.rotation),yn.add(e.animatedVelocity,e.animatedVelocity,n),yn.add(e.ultimateVelocity,e.velocity,e.animatedVelocity),yn.multiplyScalar(e.ultimateVelocity,e.ultimateVelocity,this.speedModifier.evaluate(1-e.remainingLifetime/e.startLifetime,ln(e.randomSeed+nie)))},h(t,[{key:"enable",get:function(){return this._enable},set:function(e){this._enable!==e&&(this._enable=e,this.target&&this.target.enableModule(this.name,e,this))}}]),t}(J8),yte=T((gte=bte).prototype,"_enable",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),T(gte.prototype,"enable",[Jee],Object.getOwnPropertyDescriptor(gte.prototype,"enable"),gte.prototype),xte=T(gte.prototype,"x",[Zee,Ec,$ee,ete,tte],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new K5}}),Ste=T(gte.prototype,"y",[nte,Ec,ite,rte,ote],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new K5}}),Ete=T(gte.prototype,"z",[ate,Ec,ste,cte,lte],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new K5}}),Tte=T(gte.prototype,"speedModifier",[ute,Ec,hte,_te,fte],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new K5}}),Cte=T(gte.prototype,"space",[dte,Ec,pte,mte],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Z8.Local}}),vte=gte))||vte),oie=e("Burst",(Ate=dc("cc.Burst"),wte=Jc(K5),Ite=zc(),Ate((Lte=function(){function e(){E(this,"_time",Dte,this),E(this,"_repeatCount",Ote,this),E(this,"repeatInterval",Nte,this),E(this,"count",Mte,this),this._remainingCount=void 0,this._curTime=void 0,this._remainingCount=0,this._curTime=0}var t=e.prototype;return t.update=function(e,t){if(0===this._remainingCount&&(this._remainingCount=this._repeatCount,this._curTime=this._time),this._remainingCount>0){var n=fn(e._time-e.startDelay.evaluate(0,1),e.duration)-t;n=n>0?n:0;var i=fn(e.time-e.startDelay.evaluate(0,1),e.duration);this._curTime>=n&&this._curTime<i&&(e.emit(this.count.evaluate(this._curTime/e.duration,1),t-(i-this._curTime)),this._curTime+=this.repeatInterval,--this._remainingCount)}},t.reset=function(){this._remainingCount=0,this._curTime=0},t.getMaxCount=function(e){return this.count.getMax()*Math.min(Math.ceil(e.duration/this.repeatInterval),this.repeatCount)},h(e,[{key:"time",get:function(){return this._time},set:function(e){this._time=e,this._curTime=e}},{key:"repeatCount",get:function(){return this._repeatCount},set:function(e){this._repeatCount=e,this._remainingCount=e}}]),e}(),Dte=T((Rte=Lte).prototype,"_time",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),T(Rte.prototype,"time",[Nc],Object.getOwnPropertyDescriptor(Rte.prototype,"time"),Rte.prototype),Ote=T(Rte.prototype,"_repeatCount",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),T(Rte.prototype,"repeatCount",[Nc],Object.getOwnPropertyDescriptor(Rte.prototype,"repeatCount"),Rte.prototype),Nte=T(Rte.prototype,"repeatInterval",[Ec,Nc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Mte=T(Rte.prototype,"count",[wte,Ec,Ite],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new K5}}),Pte=Rte))||Pte)),aie=new yn(0,0,0),sie=[],cie=new yn(.5,.5,.5),lie=(Fte=dc("cc.ShapeModule"),Bte=Vc(),zte=Bc(),Ute=Vc(),kte=Bc(),Gte=Vc(),Hte=Bc(),Vte=Vc(),Wte=Bc(),jte=Vc(),qte=Bc(),Xte=Vc(),Yte=Jc(n7),Kte=Tc("shapeType"),Qte=Vc(),Jte=Jc(n7),Zte=Bc(),$te=Jc(i7),ene=Vc(),tne=Bc(),nne=Vc(),ine=Bc(),rne=Vc(),one=Bc(),ane=Vc(),sne=Bc(),cne=Vc(),lne=Bc(),une=Vc(),hne=Bc(),_ne=Vc(),fne=Bc(),dne=Jc(r7),pne=Vc(),mne=Bc(),vne=Mc(),gne=Vc(),yne=Bc(),xne=Jc(K5),Sne=Mc(),Ene=zc(),Tne=Vc(),Cne=Bc(),bne=Vc(),Ane=Bc(),wne=Vc(),Ine=Bc(),Fte((T((Rne=function(){function e(){E(this,"_enable",Dne,this),E(this,"_shapeType",One,this),E(this,"emitFrom",Nne,this),E(this,"alignToDirection",Mne,this),E(this,"randomDirectionAmount",Lne,this),E(this,"sphericalDirectionAmount",Fne,this),E(this,"randomPositionAmount",Bne,this),E(this,"radius",zne,this),E(this,"radiusThickness",Une,this),E(this,"arcMode",kne,this),E(this,"arcSpread",Gne,this),E(this,"arcSpeed",Hne,this),E(this,"length",Vne,this),E(this,"boxThickness",Wne,this),E(this,"_position",jne,this),E(this,"_rotation",qne,this),E(this,"_scale",Xne,this),E(this,"_arc",Yne,this),E(this,"_angle",Kne,this),this.mat=void 0,this.quat=void 0,this.particleSystem=void 0,this.lastTime=void 0,this.totalAngle=void 0,this.mat=new kn,this.quat=new On,this.particleSystem=null,this.lastTime=0,this.totalAngle=0}var t=e.prototype;return t.onInit=function(e){this.particleSystem=e,this.constructMat(),this.lastTime=this.particleSystem._time},t.emit=function(e){switch(this.shapeType){case n7.Box:!function(e,t,n,i){switch(e){case i7.Volume:r=n,o=cie,yn.set(r,sn(-o.x,o.x),sn(-o.y,o.y),sn(-o.z,o.z));break;case i7.Shell:sie.splice(0,sie.length),sie.push(sn(-.5,.5)),sie.push(sn(-.5,.5)),sie.push(.5*p7()),d7(sie),uie(sie,t),yn.set(n,sie[0],sie[1],sie[2]);break;case i7.Edge:sie.splice(0,sie.length),sie.push(sn(-.5,.5)),sie.push(.5*p7()),sie.push(.5*p7()),d7(sie),uie(sie,t),yn.set(n,sie[0],sie[1],sie[2]);break;default:console.warn(e+" is not supported for box emitter.")}var r,o;yn.copy(i,c7)}(this.emitFrom,this.boxThickness,e.position,e.velocity);break;case n7.Circle:!function(e,t,n,i,r){f7(i,e*(1-t),e,n),yn.normalize(r,i)}(this.radius,this.radiusThickness,this.generateArcAngle(),e.position,e.velocity);break;case n7.Cone:!function(e,t,n,i,r,o,a,s){switch(e){case i7.Base:f7(a,t*(1-n),t,i),Tn.multiplyScalar(s,a,Math.sin(r)),s.z=-Math.cos(r)*t,yn.normalize(s,s),a.z=0;break;case i7.Shell:u7(a,i),Tn.multiplyScalar(s,a,Math.sin(r)),s.z=-Math.cos(r),yn.normalize(s,s),Tn.multiplyScalar(a,a,t),a.z=0;break;case i7.Volume:f7(a,t*(1-n),t,i),Tn.multiplyScalar(s,a,Math.sin(r)),s.z=-Math.cos(r)*t,yn.normalize(s,s),a.z=0,yn.add(a,a,yn.multiplyScalar(aie,s,o*an()/-s.z));break;default:console.warn(e+" is not supported for cone emitter.")}}(this.emitFrom,this.radius,this.radiusThickness,this.generateArcAngle(),this._angle,this.length,e.position,e.velocity);break;case n7.Sphere:!function(e,t,n,i,r){switch(e){case i7.Volume:_7(i,t*(1-n),t),yn.normalize(r,i);break;case i7.Shell:h7(i),yn.multiplyScalar(i,i,t),yn.normalize(r,i);break;default:console.warn(e+" is not supported for sphere emitter.")}}(this.emitFrom,this.radius,this.radiusThickness,e.position,e.velocity);break;case n7.Hemisphere:!function(e,t,n,i,r){switch(e){case i7.Volume:_7(i,t*(1-n),t),i.z>0&&(i.z*=-1),yn.normalize(r,i);break;case i7.Shell:h7(i),yn.multiplyScalar(i,i,t),i.z>0&&(i.z*=-1),yn.normalize(r,i);break;default:console.warn(e+" is not supported for hemisphere emitter.")}}(this.emitFrom,this.radius,this.radiusThickness,e.position,e.velocity);break;default:console.warn(this.shapeType+" shapeType is not supported by ShapeModule.")}if(this.randomPositionAmount>0&&(e.position.x+=sn(-this.randomPositionAmount,this.randomPositionAmount),e.position.y+=sn(-this.randomPositionAmount,this.randomPositionAmount),e.position.z+=sn(-this.randomPositionAmount,this.randomPositionAmount)),yn.transformQuat(e.velocity,e.velocity,this.quat),yn.transformMat4(e.position,e.position,this.mat),this.sphericalDirectionAmount>0){var t=yn.normalize(aie,e.position);yn.lerp(e.velocity,e.velocity,t,this.sphericalDirectionAmount)}this.lastTime=this.particleSystem._time},t.constructMat=function(){On.fromEuler(this.quat,this._rotation.x,this._rotation.y,this._rotation.z),kn.fromRTS(this.mat,this.quat,this._position,this._scale)},t.generateArcAngle=function(){if(this.arcMode===r7.Random)return sn(0,this._arc);var e=this.totalAngle+2*Math.PI*this.arcSpeed.evaluate(this.particleSystem._time,1)*(this.particleSystem._time-this.lastTime);switch(this.totalAngle=e,0!==this.arcSpread&&(e=Math.floor(e/(this._arc*this.arcSpread))*this._arc*this.arcSpread),this.arcMode){case r7.Loop:return fn(e,this._arc);case r7.PingPong:return dn(e,this._arc);default:return fn(e,this._arc)}},h(e,[{key:"position",get:function(){return this._position},set:function(e){this._position=e,this.constructMat()}},{key:"rotation",get:function(){return this._rotation},set:function(e){this._rotation=e,this.constructMat()}},{key:"scale",get:function(){return this._scale},set:function(e){this._scale=e,this.constructMat()}},{key:"arc",get:function(){return on(this._arc)},set:function(e){this._arc=rn(e)}},{key:"angle",get:function(){return Math.round(100*on(this._angle))/100},set:function(e){this._angle=rn(e)}},{key:"enable",get:function(){return this._enable},set:function(e){this._enable=e}},{key:"shapeType",get:function(){return this._shapeType},set:function(e){switch(this._shapeType=e,this._shapeType){case n7.Box:this.emitFrom===i7.Base&&(this.emitFrom=i7.Volume);break;case n7.Cone:this.emitFrom===i7.Edge&&(this.emitFrom=i7.Base);break;case n7.Sphere:case n7.Hemisphere:this.emitFrom!==i7.Base&&this.emitFrom!==i7.Edge||(this.emitFrom=i7.Volume)}}}]),e}()).prototype,"position",[Bte,zte],Object.getOwnPropertyDescriptor(Rne.prototype,"position"),Rne.prototype),T(Rne.prototype,"rotation",[Ute,kte],Object.getOwnPropertyDescriptor(Rne.prototype,"rotation"),Rne.prototype),T(Rne.prototype,"scale",[Gte,Hte],Object.getOwnPropertyDescriptor(Rne.prototype,"scale"),Rne.prototype),T(Rne.prototype,"arc",[Vte,Wte],Object.getOwnPropertyDescriptor(Rne.prototype,"arc"),Rne.prototype),T(Rne.prototype,"angle",[jte,qte],Object.getOwnPropertyDescriptor(Rne.prototype,"angle"),Rne.prototype),Dne=T(Rne.prototype,"_enable",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),T(Rne.prototype,"enable",[Xte],Object.getOwnPropertyDescriptor(Rne.prototype,"enable"),Rne.prototype),One=T(Rne.prototype,"_shapeType",[Yte,Kte,Qte],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return n7.Cone}}),T(Rne.prototype,"shapeType",[Jte,Zte],Object.getOwnPropertyDescriptor(Rne.prototype,"shapeType"),Rne.prototype),Nne=T(Rne.prototype,"emitFrom",[$te,Ec,ene,tne],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return i7.Volume}}),Mne=T(Rne.prototype,"alignToDirection",[Ec,nne,ine],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Lne=T(Rne.prototype,"randomDirectionAmount",[Ec,rne,one],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Fne=T(Rne.prototype,"sphericalDirectionAmount",[Ec,ane,sne],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Bne=T(Rne.prototype,"randomPositionAmount",[Ec,cne,lne],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),zne=T(Rne.prototype,"radius",[Ec,une,hne],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Une=T(Rne.prototype,"radiusThickness",[Ec,_ne,fne],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),kne=T(Rne.prototype,"arcMode",[dne,Ec,pne,mne],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return r7.Random}}),Gne=T(Rne.prototype,"arcSpread",[vne,Ec,gne,yne],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Hne=T(Rne.prototype,"arcSpeed",[xne,Sne,Ene,Ec,Tne,Cne],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new K5}}),Vne=T(Rne.prototype,"length",[Ec,bne,Ane],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 5}}),Wne=T(Rne.prototype,"boxThickness",[Ec,wne,Ine],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new yn(0,0,0)}}),jne=T(Rne.prototype,"_position",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new yn(0,0,0)}}),qne=T(Rne.prototype,"_rotation",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new yn(0,0,0)}}),Xne=T(Rne.prototype,"_scale",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new yn(1,1,1)}}),Yne=T(Rne.prototype,"_arc",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return rn(360)}}),Kne=T(Rne.prototype,"_angle",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return rn(25)}}),Pne=Rne))||Pne);function uie(e,t){t.x>0&&(e[0]+=.5*sn(-t.x,t.x),e[0]=en(e[0],-.5,.5)),t.y>0&&(e[1]+=.5*sn(-t.y,t.y),e[1]=en(e[1],-.5,.5)),t.z>0&&(e[2]+=.5*sn(-t.z,t.z),e[2]=en(e[2],-.5,.5))}var hie,_ie,fie,die,pie,mie,vie,gie,yie,xie,Sie,Eie,Tie,Cie,bie,Aie,wie,Iie,Pie,Rie,Die,Oie,Nie,Mie,Lie,Fie,Bie,zie,Uie,kie,Gie,Hie,Vie,Wie,jie=[0,0,1,0,0,1,1,1],qie=function(e){function t(){var t;return(t=e.call(this)||this)._capacity=void 0,t._vertAttrs=void 0,t._vertSize=void 0,t._vBuffer=void 0,t._vertAttrsFloatCount=void 0,t._vdataF32=void 0,t._vdataUint32=void 0,t._iaInfo=void 0,t._iaInfoBuffer=void 0,t._subMeshData=void 0,t._mesh=void 0,t._vertCount=0,t._indexCount=0,t._startTimeOffset=0,t._lifeTimeOffset=0,t._material=null,t.type=Ag.PARTICLE_BATCH,t._capacity=0,t._vertAttrs=null,t._vertSize=0,t._vBuffer=null,t._vertAttrsFloatCount=0,t._vdataF32=null,t._vdataUint32=null,t._iaInfo=new _r([new ur]),t._iaInfoBuffer=t._device.createBuffer(new cr(li.INDIRECT,_i.HOST|_i.DEVICE,$r,$r)),t._subMeshData=null,t._mesh=null,t}f(t,e);var n=t.prototype;return n.setCapacity=function(e){var t=this._capacity!==e;this._capacity=e,this._subMeshData&&t&&this.rebuild()},n.setVertexAttributes=function(e,t){if(this._mesh!==e||this._vertAttrs!==t){this._mesh=e,this._vertAttrs=t,this._vertSize=0;for(var n,i=S(this._vertAttrs);!(n=i()).done;){var r=n.value;r.offset=this._vertSize,this._vertSize+=Kr[r.format].size}this._vertAttrsFloatCount=this._vertSize/4,this.rebuild()}},n.createSubMeshData=function(){this.destroySubMeshData(),this._vertCount=4,this._indexCount=6,this._mesh&&(this._vertCount=this._mesh.struct.vertexBundles[this._mesh.struct.primitives[0].vertexBundelIndices[0]].view.count,this._indexCount=this._mesh.struct.primitives[0].indexView.count);var e=this._device.createBuffer(new cr(li.VERTEX|li.TRANSFER_DST,_i.HOST|_i.DEVICE,this._vertSize*this._capacity*this._vertCount,this._vertSize)),t=new ArrayBuffer(this._vertSize*this._capacity*this._vertCount);if(this._mesh&&this._capacity>0){var n=this._vertAttrs[this._vertAttrs.findIndex((function(e){return e.name===qi.ATTR_TEX_COORD}))].offset;this._mesh.copyAttribute(0,qi.ATTR_TEX_COORD,t,this._vertSize,n);var i=this._vertAttrs.findIndex((function(e){return e.name===qi.ATTR_TEX_COORD3}));if(n=this._vertAttrs[i++].offset,this._mesh.copyAttribute(0,qi.ATTR_POSITION,t,this._vertSize,n),n=this._vertAttrs[i++].offset,this._mesh.copyAttribute(0,qi.ATTR_NORMAL,t,this._vertSize,n),n=this._vertAttrs[i++].offset,!this._mesh.copyAttribute(0,qi.ATTR_COLOR,t,this._vertSize,n))for(var r=new Uint32Array(t),o=0;o<this._vertCount;++o)r[o*this._vertAttrsFloatCount+n/4]=Qn.WHITE._val;for(var a=new Float32Array(t),s=1;s<this._capacity;s++)a.copyWithin(s*this._vertSize*this._vertCount/4,0,this._vertSize*this._vertCount/4)}e.update(t);var c=new Uint16Array(this._capacity*this._indexCount);if(this._mesh&&this._capacity>0){this._mesh.copyIndices(0,c);for(var l=1;l<this._capacity;l++)for(var u=0;u<this._indexCount;u++)c[l*this._indexCount+u]=c[u]+l*this._vertCount}else for(var h=0,_=0;_<this._capacity;++_){var f=4*_;c[h++]=f,c[h++]=f+1,c[h++]=f+2,c[h++]=f+3,c[h++]=f+2,c[h++]=f+1}var d=this._device.createBuffer(new cr(li.INDEX|li.TRANSFER_DST,_i.DEVICE,this._capacity*this._indexCount*Uint16Array.BYTES_PER_ELEMENT,Uint16Array.BYTES_PER_ELEMENT));return d.update(c),this._iaInfo.drawInfos[0].vertexCount=this._capacity*this._vertCount,this._iaInfo.drawInfos[0].indexCount=this._capacity*this._indexCount,this._iaInfoBuffer||(this._iaInfoBuffer=this._device.createBuffer(new cr(li.INDIRECT,_i.HOST|_i.DEVICE,$r,$r))),this._iaInfoBuffer.update(this._iaInfo),this._subMeshData=new HA([e],this._vertAttrs,Oi.TRIANGLE_LIST,d,this._iaInfoBuffer),this.initSubModel(0,this._subMeshData,this._material),t},n.updateMaterial=function(e){this._material=e,this.setSubModelMaterial(0,e)},n.addParticleVertexData=function(e,t){if(this._mesh)for(var n=0;n<this._vertCount;n++){var i=(e*this._vertCount+n)*this._vertAttrsFloatCount;this._vdataF32[i++]=t[0].x,this._vdataF32[i++]=t[0].y,this._vdataF32[i++]=t[0].z,i+=2,this._vdataF32[i++]=t[1].z,this._vdataF32[i++]=t[2].x,this._vdataF32[i++]=t[2].y,this._vdataF32[i++]=t[2].z,this._vdataF32[i++]=t[3].x,this._vdataF32[i++]=t[3].y,this._vdataF32[i++]=t[3].z,this._vdataUint32[i++]=t[4]}else{var r=e*this._vertAttrsFloatCount;this._vdataF32[r++]=t[0].x,this._vdataF32[r++]=t[0].y,this._vdataF32[r++]=t[0].z,this._vdataF32[r++]=t[1].x,this._vdataF32[r++]=t[1].y,this._vdataF32[r++]=t[1].z,this._vdataF32[r++]=t[2].x,this._vdataF32[r++]=t[2].y,this._vdataF32[r++]=t[2].z,this._vdataF32[r++]=t[3].x,this._vdataF32[r++]=t[3].y,this._vdataF32[r++]=t[3].z,this._vdataUint32[r++]=t[4],t[5]&&(this._vdataF32[r++]=t[5].x,this._vdataF32[r++]=t[5].y,this._vdataF32[r++]=t[5].z)}},n.addGPUParticleVertexData=function(e,t,n){for(var i=t*this._vertAttrsFloatCount*this._vertCount,r=0;r<this._vertCount;r++){var o=i;this._vdataF32[o++]=e.position.x,this._vdataF32[o++]=e.position.y,this._vdataF32[o++]=e.position.z,this._vdataF32[o++]=n,this._vdataF32[o++]=e.startSize.x,this._vdataF32[o++]=e.startSize.y,this._vdataF32[o++]=e.startSize.z,this._vdataF32[o++]=jie[2*r],this._vdataF32[o++]=e.rotation.x,this._vdataF32[o++]=e.rotation.y,this._vdataF32[o++]=e.rotation.z,this._vdataF32[o++]=jie[2*r+1],this._vdataF32[o++]=e.startColor.r/255,this._vdataF32[o++]=e.startColor.g/255,this._vdataF32[o++]=e.startColor.b/255,this._vdataF32[o++]=e.startColor.a/255,this._vdataF32[o++]=e.velocity.x,this._vdataF32[o++]=e.velocity.y,this._vdataF32[o++]=e.velocity.z,this._vdataF32[o++]=e.startLifetime,this._vdataF32[o++]=e.randomSeed,i+=this._vertAttrsFloatCount}},n.updateGPUParticles=function(e,t,n){for(var i=this._vertAttrsFloatCount*this._vertCount,r=0,o=0,a=0,s=0;s<e;++s)r=s*i,o=this._vdataF32[r+this._startTimeOffset],this._vdataF32[r+this._lifeTimeOffset]-(t-o)<n&&(a=--e*i,this._vdataF32.copyWithin(r,a,a+i),s--);return e},n.constructAttributeIndex=function(){if(this._vertAttrs){var e=this._vertAttrs.findIndex((function(e){return"a_position_starttime"===e.name})),t=this._vertAttrs[e].offset;this._startTimeOffset=t/4+3,e=this._vertAttrs.findIndex((function(e){return"a_dir_life"===e.name})),t=this._vertAttrs[e].offset,this._lifeTimeOffset=t/4+3}},n.updateIA=function(e){e<=0||(this._subModels[0].inputAssembler.vertexBuffers[0].update(this._vdataF32),this._iaInfo.drawInfos[0].firstIndex=0,this._iaInfo.drawInfos[0].indexCount=this._indexCount*e,this._iaInfoBuffer.update(this._iaInfo))},n.clear=function(){this._subModels[0].inputAssembler.indexCount=0},n.destroy=function(){e.prototype.destroy.call(this),this._vertAttrs=null,this._vBuffer=null,this._vdataF32=null,this._vdataUint32=null,this._material=null,this._mesh=null,this.destroySubMeshData(),this._iaInfoBuffer&&(this._iaInfoBuffer.destroy(),this._iaInfoBuffer=null)},n.rebuild=function(){this._vBuffer=this.createSubMeshData(),this._vdataF32=new Float32Array(this._vBuffer),this._vdataUint32=new Uint32Array(this._vBuffer)},n.destroySubMeshData=function(){this._subMeshData&&(this._subMeshData.destroy(),this._subMeshData=null,this._iaInfoBuffer=null)},t}(Ug),Xie=function(){function e(e){this._particleSystem=null,this._model=null,this._renderInfo=null,this._vertAttrs=[],this._renderInfo=e}var t=e.prototype;return t.getInfo=function(){return this._renderInfo},t.onInit=function(e){this._particleSystem=e},t.onEnable=function(){if(this._particleSystem){this.attachToScene();var e=this._model;e&&(e.node=e.transform=this._particleSystem.node)}},t.onDisable=function(){this.detachFromScene()},t.onDestroy=function(){this._model&&(b.director.root.destroyModel(this._model),this._model=null)},t.attachToScene=function(){this._model&&(this._model.scene&&this.detachFromScene(),this._particleSystem._getRenderScene().addModel(this._model))},t.detachFromScene=function(){this._model&&this._model.scene&&this._model.scene.removeModel(this._model)},t.setVertexAttributes=function(){this._model&&this._model.setVertexAttributes(this._renderInfo.renderMode===t7.Mesh?this._renderInfo.mesh:null,this._vertAttrs)},t.clear=function(){this._model&&(this._model.enabled=!1)},t.getModel=function(){return this._model},t._initModel=function(){this._model||(this._model=b.director.root.createModel(qie),this._model.setCapacity(this._particleSystem.capacity),this._model.visFlags=this._particleSystem.visibility)},t.updateTrailMaterial=function(){},t.getDefaultTrailMaterial=function(){return null},e}(),Yie=new yn,Kie=new kn,Qie=new On,Jie=(new yn,["_colorOverLifetimeModule","_sizeOvertimeModule","_velocityOvertimeModule","_forceOvertimeModule","_limitVelocityOvertimeModule","_rotationOvertimeModule","_textureAnimationModule"]),Zie=[0,0,1,0,0,1,1,1],$ie=[new br(qi.ATTR_POSITION,ai.RGB32F),new br(qi.ATTR_TEX_COORD,ai.RGB32F),new br(qi.ATTR_TEX_COORD1,ai.RGB32F),new br(qi.ATTR_TEX_COORD2,ai.RGB32F),new br(qi.ATTR_COLOR,ai.RGBA8,!0)],ere=[new br(qi.ATTR_POSITION,ai.RGB32F),new br(qi.ATTR_TEX_COORD,ai.RGB32F),new br(qi.ATTR_TEX_COORD1,ai.RGB32F),new br(qi.ATTR_TEX_COORD2,ai.RGB32F),new br(qi.ATTR_COLOR,ai.RGBA8,!0),new br(qi.ATTR_COLOR1,ai.RGB32F)],tre=[new br(qi.ATTR_POSITION,ai.RGB32F),new br(qi.ATTR_TEX_COORD,ai.RGB32F),new br(qi.ATTR_TEX_COORD1,ai.RGB32F),new br(qi.ATTR_TEX_COORD2,ai.RGB32F),new br(qi.ATTR_COLOR,ai.RGBA8,!0),new br(qi.ATTR_TEX_COORD3,ai.RGB32F),new br(qi.ATTR_NORMAL,ai.RGB32F),new br(qi.ATTR_COLOR1,ai.RGBA8,!0)],nre={parent:null,owner:null,subModelIdx:0},ire=function(e){function t(t){var n;return(n=e.call(this,t)||this)._defines=void 0,n._trailDefines=void 0,n._frameTile_velLenScale=void 0,n._tmp_velLenScale=void 0,n._defaultMat=null,n._node_scale=void 0,n._attrs=void 0,n._particles=null,n._defaultTrailMat=null,n._updateList=new Map,n._animateList=new Map,n._runAnimateList=new Array,n._fillDataFunc=null,n._uScaleHandle=0,n._uLenHandle=0,n._uNodeRotHandle=0,n._alignSpace=e7.View,n._inited=!1,n._localMat=new kn,n._gravity=new wn,n._model=null,n._frameTile_velLenScale=new wn(1,1,0,0),n._tmp_velLenScale=n._frameTile_velLenScale.clone(),n._node_scale=new wn,n._attrs=new Array(5),n._defines={CC_USE_WORLD_SPACE:!0,CC_USE_BILLBOARD:!0,CC_USE_STRETCHED_BILLBOARD:!1,CC_USE_HORIZONTAL_BILLBOARD:!1,CC_USE_VERTICAL_BILLBOARD:!1},n._trailDefines={CC_USE_WORLD_SPACE:!0},n}f(t,e);var n=t.prototype;return n.onInit=function(t){var n=this;e.prototype.onInit.call(this,t),this._particles=new Ll((function(){return new u8(n)}),16),this._setVertexAttrib(),this._setFillFunc(),this._initModuleList(),this._initModel(),this.updateMaterialParams(),this.updateTrailMaterial(),this.setVertexAttributes(),this._inited=!0},n.clear=function(){e.prototype.clear.call(this),this._particles.reset(),this._particleSystem._trailModule&&this._particleSystem._trailModule.clear(),this.updateRenderData(),this._model.enabled=!1},n.updateRenderMode=function(){this._setVertexAttrib(),this._setFillFunc(),this.updateMaterialParams(),this.setVertexAttributes()},n.onDestroy=function(){var t;null===(t=this._particles)||void 0===t||t.destroy(),e.prototype.onDestroy.call(this)},n.getFreeParticle=function(){return this._particles.length>=this._particleSystem.capacity?null:this._particles.add()},n.getDefaultTrailMaterial=function(){return this._defaultTrailMat},n.setNewParticle=function(){},n._initModuleList=function(){var e=this;Jie.forEach((function(t){var n=e._particleSystem[t];n&&n.enable&&(n.needUpdate&&(e._updateList[n.name]=n),n.needAnimate&&(e._animateList[n.name]=n))})),this._runAnimateList.length=0;for(var t=0,n=K8.length;t<n;t++){var i=this._animateList[K8[t]];i&&this._runAnimateList.push(i)}},n.enableModule=function(e,t,n){t?(n.needUpdate&&(this._updateList[n.name]=n),n.needAnimate&&(this._animateList[n.name]=n)):(delete this._animateList[e],delete this._updateList[e]),this._runAnimateList.length=0;for(var i=0,r=K8.length;i<r;i++){var o=this._animateList[K8[i]];o&&this._runAnimateList.push(o)}this.updateMaterialParams()},n.updateAlignSpace=function(e){this._alignSpace=e},n.getDefaultMaterial=function(){return this._defaultMat},n.updateRotation=function(e){e&&this.doUpdateRotation(e)},n.doUpdateRotation=function(e){if(this._renderInfo.renderMode===t7.Mesh||this._alignSpace!==e7.View){if(this._alignSpace===e7.Local)this._particleSystem.node.getRotation(Qie);else if(this._alignSpace===e7.World)this._particleSystem.node.getWorldRotation(Qie);else if(this._alignSpace===e7.View){var t;Qie.set(0,0,0,1);var n=null===(t=this._particleSystem.node.scene.renderScene)||void 0===t?void 0:t.cameras;if(void 0!==n)for(var i=0;i<(null==n?void 0:n.length);++i){var r=n[i];if((r.visibility&this._particleSystem.node.layer)===this._particleSystem.node.layer){On.fromViewUp(Qie,r.forward);break}}}else Qie.set(0,0,0,1);e.setUniform(this._uNodeRotHandle,Qie)}},n.updateScale=function(e){e&&this.doUpdateScale(e)},n.doUpdateScale=function(e){switch(this._particleSystem.scaleSpace){case Z8.Local:this._particleSystem.node.getScale(this._node_scale);break;case Z8.World:this._particleSystem.node.getWorldScale(this._node_scale)}e.setUniform(this._uScaleHandle,this._node_scale)},n.updateParticles=function(e){var t=this,n=this._particleSystem;if(!n)return this._particles.length;n.node.getWorldMatrix(Kie);var i=(n.getMaterialInstance(0)||this._defaultMat).passes[0];this.doUpdateScale(i),this.doUpdateRotation(i),this._updateList.forEach((function(e){e.update(n._simulationSpace,Kie)}));var r=n._trailModule,o=r&&r.enable;if(o&&r.update(),n.simulationSpace===Z8.Local){var a=n.node.getRotation();kn.fromQuat(this._localMat,a),this._localMat.transpose()}for(var s=function(i){var a=t._particles.data[i];if(a.remainingLifetime-=e,yn.set(a.animatedVelocity,0,0,0),a.remainingLifetime<0)return o&&r.removeParticle(a),t._particles.removeAt(i),--i,c=i,"continue";if(n.simulationSpace===Z8.Local){var s=9.8*-n.gravityModifier.evaluate(1-a.remainingLifetime/a.startLifetime,ln(a.randomSeed))*e;t._gravity.x=0,t._gravity.y=s,t._gravity.z=0,t._gravity.w=1,t._gravity=t._gravity.transformMat4(t._localMat),a.velocity.x+=t._gravity.x,a.velocity.y+=t._gravity.y,a.velocity.z+=t._gravity.z}else a.velocity.y-=9.8*n.gravityModifier.evaluate(1-a.remainingLifetime/a.startLifetime,ln(a.randomSeed))*e;yn.copy(a.ultimateVelocity,a.velocity),t._runAnimateList.forEach((function(t){t.animate(a,e)})),yn.scaleAndAdd(a.position,a.position,a.ultimateVelocity,e),o&&r.animate(a,e),c=i},c=0;c<this._particles.length;++c)s(c);return this._model.enabled=this._particles.length>0,this._particles.length},n.updateRenderData=function(){for(var e=0,t=0;t<this._particles.length;++t){var n=this._particles.data[t],i=0,r=this._particleSystem._textureAnimationModule;r&&r.enable&&(i=n.frameIndex),e=4*t,this._fillDataFunc(n,e,i)}},n.beforeRender=function(){this._model.updateIA(this._particles.length)},n.getParticleCount=function(){return this._particles.length},n.onMaterialModified=function(e){this._inited&&(0===e?this.updateMaterialParams():this.updateTrailMaterial())},n.onRebuildPSO=function(e,t){this._model&&0===e&&this._model.setSubModelMaterial(0,t);var n=this._particleSystem._trailModule;n&&n._trailModel&&1===e&&n._trailModel.setSubModelMaterial(0,t)},n._setFillFunc=function(){this._renderInfo.renderMode===t7.Mesh?this._fillDataFunc=this._fillMeshData:this._renderInfo.renderMode===t7.StrecthedBillboard?this._fillDataFunc=this._fillStrecthedData:this._fillDataFunc=this._fillNormalData},n._fillMeshData=function(e,t,n){var i=t/4;this._attrs[0]=e.position,Yie.z=n,this._attrs[1]=Yie,this._attrs[2]=e.size,this._attrs[3]=e.rotation,this._attrs[4]=e.color._val,this._model.addParticleVertexData(i,this._attrs)},n._fillStrecthedData=function(e,t,n){for(var i=0;i<4;++i)this._attrs[0]=e.position,Yie.x=Zie[2*i],Yie.y=Zie[2*i+1],Yie.z=n,this._attrs[1]=Yie,this._attrs[2]=e.size,this._attrs[3]=e.rotation,this._attrs[4]=e.color._val,this._attrs[5]=e.ultimateVelocity,this._attrs[6]=null,this._model.addParticleVertexData(t++,this._attrs)},n._fillNormalData=function(e,t,n){for(var i=0;i<4;++i)this._attrs[0]=e.position,Yie.x=Zie[2*i],Yie.y=Zie[2*i+1],Yie.z=n,this._attrs[1]=Yie,this._attrs[2]=e.size,this._attrs[3]=e.rotation,this._attrs[4]=e.color._val,this._attrs[5]=null,this._model.addParticleVertexData(t++,this._attrs)},n._setVertexAttrib=function(){switch(this._renderInfo.renderMode){case t7.StrecthedBillboard:this._vertAttrs=ere.slice();break;case t7.Mesh:this._vertAttrs=tre.slice();break;default:this._vertAttrs=$ie.slice()}},n.updateMaterialParams=function(){if(this._particleSystem){var e=this._particleSystem,t=e.sharedMaterial;if(null!=t){var n=t._effectAsset._name;this._renderInfo.mainTexture=t.getProperty("mainTexture",0),-1!==n.indexOf("particle")&&-1===n.indexOf("particle-gpu")||e.setMaterial(null,0)}null==e.sharedMaterial&&null==this._defaultMat&&(nre.parent=nv.get("default-particle-material"),nre.owner=this._particleSystem,nre.subModelIdx=0,this._defaultMat=new Hg(nre),nre.parent=null,nre.owner=null,nre.subModelIdx=0,null!==this._renderInfo.mainTexture&&this._defaultMat.setProperty("mainTexture",this._renderInfo.mainTexture));var i=e.getMaterialInstance(0)||this._defaultMat;e._simulationSpace===Z8.World?this._defines.CC_USE_WORLD_SPACE=!0:this._defines.CC_USE_WORLD_SPACE=!1;var r=i.passes[0];this._uScaleHandle=r.getHandle("scale"),this._uLenHandle=r.getHandle("frameTile_velLenScale"),this._uNodeRotHandle=r.getHandle("nodeRotation");var o=this._renderInfo.renderMode,a=this._frameTile_velLenScale;o===t7.Billboard?this._defines.CC_RENDER_MODE=0:o===t7.StrecthedBillboard?(this._defines.CC_RENDER_MODE=1,a.z=this._renderInfo.velocityScale,a.w=this._renderInfo.lengthScale):o===t7.HorizontalBillboard?this._defines.CC_RENDER_MODE=2:o===t7.VerticalBillboard?this._defines.CC_RENDER_MODE=3:o===t7.Mesh?this._defines.CC_RENDER_MODE=4:console.warn("particle system renderMode "+o+" not support.");var s=e._textureAnimationModule;s&&s.enable?(wn.copy(this._tmp_velLenScale,a),Tn.set(this._tmp_velLenScale,s.numTilesX,s.numTilesY),r.setUniform(this._uLenHandle,this._tmp_velLenScale)):r.setUniform(this._uLenHandle,a);var c,l=this._particleSystem._rotationOvertimeModule;c=l&&l.enable,this._defines.ROTATION_OVER_TIME_MODULE_ENABLE=c,i.recompileShaders(this._defines),this._model&&this._model.updateMaterial(i)}},n.updateTrailMaterial=function(){if(this._particleSystem){var e=this._particleSystem,t=e._trailModule;if(t&&t.enable){e.simulationSpace===Z8.World||t.space===Z8.World?this._trailDefines.CC_USE_WORLD_SPACE=!0:this._trailDefines.CC_USE_WORLD_SPACE=!1;var n=e.getMaterialInstance(1);null===n&&null===this._defaultTrailMat&&(nre.parent=nv.get("default-trail-material"),nre.owner=this._particleSystem,nre.subModelIdx=1,this._defaultTrailMat=new Hg(nre),nre.parent=null,nre.owner=null,nre.subModelIdx=0),(n=n||this._defaultTrailMat).recompileShaders(this._trailDefines),t.updateMaterial()}}},t}(Xie),rre=new kn,ore=new wn,are=new On,sre=new On,cre=(new yn,32),lre="a_position_starttime",ure="a_size_uv",hre="a_rotation_uv",_re="a_color",fre="a_dir_life",dre="a_rndSeed",pre=[new br(lre,ai.RGBA32F),new br(ure,ai.RGBA32F),new br(hre,ai.RGBA32F),new br(_re,ai.RGBA32F),new br(fre,ai.RGBA32F),new br(dre,ai.R32F)],mre=[new br(lre,ai.RGBA32F),new br(ure,ai.RGBA32F),new br(hre,ai.RGBA32F),new br(_re,ai.RGBA32F),new br(fre,ai.RGBA32F),new br(dre,ai.R32F),new br(qi.ATTR_TEX_COORD,ai.RGB32F),new br(qi.ATTR_TEX_COORD3,ai.RGB32F),new br(qi.ATTR_NORMAL,ai.RGB32F),new br(qi.ATTR_COLOR1,ai.RGBA8,!0)],vre={parent:null,owner:null,subModelIdx:0},gre=function(e){function t(t){var n;return(n=e.call(this,t)||this)._defines=void 0,n._frameTile_velLenScale=void 0,n._unifrom_velLenScale=void 0,n._tmp_velLenScale=void 0,n._node_scale=void 0,n._vertAttrs=[],n._defaultMat=null,n._particleNum=0,n._tempParticle=null,n._colorTexture=null,n._forceTexture=null,n._velocityTexture=null,n._rotationTexture=null,n._sizeTexture=null,n._animTexture=null,n._uTimeHandle=0,n._uRotHandle=0,n._uNodeRotHandle=0,n._alignSpace=e7.View,n._inited=!1,n._frameTile_velLenScale=new wn(1,1,0,0),n._unifrom_velLenScale=n._frameTile_velLenScale.clone(),n._tmp_velLenScale=n._frameTile_velLenScale.clone(),n._node_scale=new wn,n._defines={CC_USE_WORLD_SPACE:!0,CC_USE_BILLBOARD:!0,CC_USE_STRETCHED_BILLBOARD:!1,CC_USE_HORIZONTAL_BILLBOARD:!1,CC_USE_VERTICAL_BILLBOARD:!1,COLOR_OVER_TIME_MODULE_ENABLE:!1},n._tempParticle=new u8(null),n._particleNum=0,n}f(t,e);var n=t.prototype;return n.onInit=function(t){e.prototype.onInit.call(this,t),this._setVertexAttrib(),this._initModel(),this.updateMaterialParams(),this.setVertexAttributes(),this._inited=!0},n.updateRenderMode=function(){this._setVertexAttrib(),this.updateMaterialParams(),this.setVertexAttributes()},n.setVertexAttributes=function(){e.prototype.setVertexAttributes.call(this),this._model.constructAttributeIndex()},n.clear=function(){e.prototype.clear.call(this),this._particleNum=0,this.updateRenderData()},n.onDestroy=function(){e.prototype.onDestroy.call(this),this._forceTexture&&this._forceTexture.destroy(),this._velocityTexture&&this._velocityTexture.destroy(),this._colorTexture&&this._colorTexture.destroy(),this._sizeTexture&&this._sizeTexture.destroy(),this._rotationTexture&&this._rotationTexture.destroy(),this._animTexture&&this._animTexture.destroy()},n.enableModule=function(){var e=this._particleSystem.getMaterialInstance(0)||this._defaultMat;e&&(this.initShaderUniform(e),e.recompileShaders(this._defines),this._model&&this._model.setSubModelMaterial(0,e))},n.getFreeParticle=function(){return this._particleNum>=this._particleSystem._capacity?null:this._tempParticle},n.setNewParticle=function(e){this._model.addGPUParticleVertexData(e,this._particleNum,this._particleSystem._time),this._particleNum++},n.getDefaultMaterial=function(){return this._defaultMat},n.updateRotation=function(e){e&&this.doUpdateRotation(e)},n.doUpdateRotation=function(e){if(this._renderInfo.renderMode===t7.Mesh||this._alignSpace!==e7.View){if(this._alignSpace===e7.Local)this._particleSystem.node.getRotation(sre);else if(this._alignSpace===e7.World)this._particleSystem.node.getWorldRotation(sre);else if(this._alignSpace===e7.View){var t;sre.set(0,0,0,1);var n=null===(t=this._particleSystem.node.scene.renderScene)||void 0===t?void 0:t.cameras;if(void 0!==n)for(var i=0;i<(null==n?void 0:n.length);++i){var r=n[i];if((r.visibility&this._particleSystem.node.layer)===this._particleSystem.node.layer){On.fromViewUp(sre,r.forward);break}}}else sre.set(0,0,0,1);e.setUniform(this._uNodeRotHandle,sre)}},n.updateScale=function(e){e&&this.doUpdateScale(e)},n.doUpdateScale=function(e){switch(this._particleSystem.scaleSpace){case Z8.Local:this._particleSystem.node.getScale(this._node_scale);break;case Z8.World:this._particleSystem.node.getWorldScale(this._node_scale)}e.setUniform(e.getHandle("scale"),this._node_scale)},n.updateParticles=function(e){return this._particleNum=this._model.updateGPUParticles(this._particleNum,this._particleSystem._time,e),this.updateShaderUniform(e),this._model.enabled=this._particleNum>0,this._particleNum},n.updateRenderData=function(){},n.beforeRender=function(){this._model.updateIA(this._particleNum)},n.updateAlignSpace=function(e){this._alignSpace=e},n.updateShaderUniform=function(e){var t=this._particleSystem.getMaterialInstance(0)||this._defaultMat;if(t){var n=t.passes[0];ore.x=this._particleSystem._time,ore.y=e,n.setUniform(this._uTimeHandle,ore),this._particleSystem.node.getWorldRotation(are),n.setUniform(this._uRotHandle,are),this.doUpdateRotation(n)}},n.initShaderUniform=function(e){var t=e.passes[0];this._uTimeHandle=t.getHandle("u_timeDelta"),this._uRotHandle=t.getHandle("u_worldRot"),this._uNodeRotHandle=t.getHandle("nodeRotation"),this.doUpdateScale(t),t.setUniform(t.getHandle("frameTile_velLenScale"),this._unifrom_velLenScale),ore.x=cre,ore.y=.03125,t.setUniform(t.getHandle("u_sampleInfo"),ore);var n=!1,i=this._particleSystem._forceOvertimeModule;if(n=i&&i.enable,this._defines.FORCE_OVER_TIME_MODULE_ENABLE=n,n){this._forceTexture&&this._forceTexture.destroy(),this._forceTexture=$5(cre,i.x,i.y,i.z);var r=t.getHandle("force_over_time_tex0"),o=lv.getBindingFromHandle(r);t.bindSampler(o,this._forceTexture.getGFXSampler()),t.bindTexture(o,this._forceTexture.getGFXTexture());var a=t.getHandle("u_force_space");t.setUniform(a,i.space);var s=t.getHandle("u_force_mode");t.setUniform(s,this._forceTexture.height)}var c=this._particleSystem._velocityOvertimeModule;if(n=c&&c.enable,this._defines.VELOCITY_OVER_TIME_MODULE_ENABLE=n,n){this._velocityTexture&&this._velocityTexture.destroy(),this._velocityTexture=function(e,t,n,i,r){for(var o=Math.max(J5(t),J5(n),J5(i),J5(r)),a=new Float32Array(e*o*4),s=[t,n,i,r],c=1/(e-1),l=0;l<o;l++)for(var u=0;u<4;u++)for(var h=s[u],_=0,f=0,d=0;d<e;d++){var p=Q5(h,c*d,l);f=(_+=p)/(d+1),a[4*d+u]=f}return Z5(a,e,o)}(cre,c.x,c.y,c.z,c.speedModifier);var l=t.getHandle("velocity_over_time_tex0"),u=lv.getBindingFromHandle(l);t.bindSampler(u,this._velocityTexture.getGFXSampler()),t.bindTexture(u,this._velocityTexture.getGFXTexture());var h=t.getHandle("u_velocity_space");t.setUniform(h,c.space);var _=t.getHandle("u_velocity_mode");t.setUniform(_,this._velocityTexture.height)}var f=this._particleSystem._colorOverLifetimeModule;if(n=f&&f.enable,this._defines.COLOR_OVER_TIME_MODULE_ENABLE=n,n){this._colorTexture&&this._colorTexture.destroy(),this._colorTexture=function(e,t){for(var n=function(e){switch(e.mode){case o8.TwoColors:case o8.TwoGradients:return 2;default:return 1}}(t),i=new Uint8Array(e*n*4),r=1/(e-1),o=0,a=0;a<n;a++)for(var s=0;s<e;s++){var c=s8(t,r*s,a);i[o]=c.r,i[o+1]=c.g,i[o+2]=c.b,i[o+3]=c.a,o+=4}var l=new Xm;return l.create(e,n,tm.RGBA8888),l.setFilters(im.LINEAR,im.LINEAR),l.setWrapMode(nm.CLAMP_TO_EDGE,nm.CLAMP_TO_EDGE),l.uploadData(i),l}(cre,f.color);var d=t.getHandle("color_over_time_tex0"),p=lv.getBindingFromHandle(d);t.bindSampler(p,this._colorTexture.getGFXSampler()),t.bindTexture(p,this._colorTexture.getGFXTexture());var m=t.getHandle("u_color_mode");t.setUniform(m,this._colorTexture.height)}var v=this._particleSystem._rotationOvertimeModule;if(n=v&&v.enable,this._defines.ROTATION_OVER_TIME_MODULE_ENABLE=n,n){this._rotationTexture&&this._rotationTexture.destroy(),v.separateAxes?this._rotationTexture=$5(cre,v.x,v.y,v.z):this._rotationTexture=function(e,t){for(var n=J5(t),i=new Float32Array(e*n*4),r=1/(e-1),o=0,a=0;a<n;a++)for(var s=0;s<e;s++){var c=Q5(t,r*s,a);i[o+2]=c,o+=4}return Z5(i,e,n)}(cre,v.z);var g=t.getHandle("rotation_over_time_tex0"),y=lv.getBindingFromHandle(g);t.bindSampler(y,this._rotationTexture.getGFXSampler()),t.bindTexture(y,this._rotationTexture.getGFXTexture());var x=t.getHandle("u_rotation_mode");t.setUniform(x,this._rotationTexture.height)}var S=this._particleSystem._sizeOvertimeModule;if(n=S&&S.enable,this._defines.SIZE_OVER_TIME_MODULE_ENABLE=n,n){this._sizeTexture&&this._sizeTexture.destroy(),S.separateAxes?this._sizeTexture=$5(cre,S.x,S.y,S.z,!0):this._sizeTexture=function(e,t){for(var n=J5(t),i=new Float32Array(e*n*4),r=1/(e-1),o=0,a=0,s=0;s<n;s++){0;for(var c=0;c<e;c++){var l=Q5(t,r*c,s);o=l,i[a]=o,i[a+1]=o,i[a+2]=o,a+=4}}return Z5(i,e,n)}(cre,S.size);var E=t.getHandle("size_over_time_tex0"),T=lv.getBindingFromHandle(E);t.bindSampler(T,this._sizeTexture.getGFXSampler()),t.bindTexture(T,this._sizeTexture.getGFXTexture());var C=t.getHandle("u_size_mode");t.setUniform(C,this._sizeTexture.height)}var A=this._particleSystem._textureAnimationModule;if(n=A&&A.enable,this._defines.TEXTURE_ANIMATION_MODULE_ENABLE=n,n){this._animTexture&&this._animTexture.destroy(),this._animTexture=function(e,t,n){for(var i=Math.max(J5(t),J5(n)),r=new Float32Array(e*i*4),o=[t,n],a=1/(e-1),s=0;s<i;s++)for(var c=0;c<2;c++)for(var l=o[c],u=0,h=0,_=0;_<e;_++){var f=Q5(l,a*_,s);h=(u+=f)/(_+1),r[4*_+c]=h}return Z5(r,e,i)}(cre,A.startFrame,A.frameOverTime);var w=t.getHandle("texture_animation_tex0"),I=lv.getBindingFromHandle(w);t.bindSampler(I,this._animTexture.getGFXSampler()),t.bindTexture(I,this._animTexture.getGFXTexture());var P=t.getHandle("u_anim_info");ore.x=this._animTexture.height,ore.y=A.numTilesX*A.numTilesY,ore.z=A.cycleCount,t.setUniform(P,ore)}this._defines.USE_VK_SHADER=b.game._gfxDevice.gfxAPI===ii.VULKAN},n.getParticleCount=function(){return this._particleNum},n.onMaterialModified=function(){this._inited&&this.updateMaterialParams()},n.onRebuildPSO=function(e,t){this._model&&0===e&&this._model.setSubModelMaterial(0,t)},n._setVertexAttrib=function(){switch(this._renderInfo.renderMode){case t7.StrecthedBillboard:this._vertAttrs=pre.slice();break;case t7.Mesh:this._vertAttrs=mre.slice();break;default:this._vertAttrs=pre.slice()}},n.updateMaterialParams=function(){if(this._particleSystem){var e=this._particleSystem,t=e.sharedMaterial;if(null!==t){var n=t._effectAsset._name;this._renderInfo.mainTexture=t.getProperty("mainTexture",0),-1===n.indexOf("particle-gpu")&&(this._renderInfo.mainTexture=t.getProperty("mainTexture",0),this._particleSystem.setMaterial(null,0))}null==e.sharedMaterial&&null==this._defaultMat&&(vre.parent=nv.get("default-particle-gpu-material"),vre.owner=e,vre.subModelIdx=0,this._defaultMat=new Hg(vre),vre.parent=null,vre.owner=null,vre.subModelIdx=0,null!==this._renderInfo.mainTexture&&this._defaultMat.setProperty("mainTexture",this._renderInfo.mainTexture));var i=e.getMaterialInstance(0)||this._defaultMat;e.node.getWorldMatrix(rre),e._simulationSpace===Z8.World?this._defines.CC_USE_WORLD_SPACE=!0:this._defines.CC_USE_WORLD_SPACE=!1;var r=this._renderInfo.renderMode;r===t7.Billboard?this._defines.CC_RENDER_MODE=0:r===t7.StrecthedBillboard?(this._defines.CC_RENDER_MODE=1,this._frameTile_velLenScale.z=this._renderInfo.velocityScale,this._frameTile_velLenScale.w=this._renderInfo.lengthScale):r===t7.HorizontalBillboard?this._defines.CC_RENDER_MODE=2:r===t7.VerticalBillboard?this._defines.CC_RENDER_MODE=3:r===t7.Mesh?this._defines.CC_RENDER_MODE=4:console.warn("particle system renderMode "+r+" not support.");var o=e._textureAnimationModule;o&&o.enable?(Tn.set(this._frameTile_velLenScale,o.numTilesX,o.numTilesY),wn.copy(this._unifrom_velLenScale,this._frameTile_velLenScale)):(this._tmp_velLenScale.z=this._frameTile_velLenScale.z,this._tmp_velLenScale.w=this._frameTile_velLenScale.w,wn.copy(this._unifrom_velLenScale,this._tmp_velLenScale)),this.initShaderUniform(i),i.recompileShaders(this._defines),this._model&&this._model.updateMaterial(i)}},t}(Xie);function yre(){var e=KO.root.device;return!!(e.capabilities.maxVertexTextureUnits>=8&&e.getFormatFeatures(ai.RGBA32F)&(mi.RENDER_TARGET|mi.SAMPLED_TEXTURE))||(b.warn("Maybe the device has restrictions on vertex textures or does not support float textures."),!1)}var xre,Sre,Ere,Tre,Cre,bre,Are,wre,Ire,Pre,Rre,Dre,Ore,Nre,Mre,Lre,Fre,Bre,zre,Ure,kre,Gre,Hre,Vre,Wre,jre,qre,Xre,Yre,Kre,Qre,Jre,Zre,$re,eoe,toe,noe,ioe,roe,ooe,aoe,soe,coe,loe,uoe,hoe,_oe,foe,doe,poe,moe,voe,goe,yoe,xoe,Soe,Eoe,Toe,Coe,boe,Aoe,woe,Ioe,Poe,Roe,Doe,Ooe,Noe,Moe,Loe,Foe,Boe,zoe,Uoe,koe,Goe,Hoe,Voe,Woe,joe,qoe,Xoe,Yoe,Koe,Qoe,Joe,Zoe,$oe,eae,tae,nae,iae,rae,oae,aae,sae,cae,lae,uae,hae,_ae,fae,dae,pae,mae,vae,gae,yae,xae,Sae,Eae,Tae,Cae,bae,Aae,wae,Iae,Pae,Rae,Dae,Oae,Nae,Mae,Lae,Fae,Bae,zae,Uae,kae,Gae,Hae,Vae,Wae,jae,qae,Xae,Yae,Kae,Qae,Jae,Zae,$ae,ese,tse,nse,ise,rse,ose,ase,sse,cse,lse,use,hse,_se,fse,dse,pse,mse,vse,gse,yse,xse,Sse,Ese,Tse,Cse,bse,Ase,wse,Ise,Pse,Rse,Dse,Ose,Nse,Mse,Lse,Fse,Bse,zse,Use,kse,Gse,Hse,Vse,Wse,jse,qse,Xse,Yse,Kse,Qse,Jse,Zse,$se,ece,tce,nce,ice,rce,oce,ace,sce,cce,lce,uce,hce,_ce,fce,dce,pce,mce,vce,gce,yce,xce,Sce,Ece,Tce,Cce,bce,Ace,wce,Ice,Pce,Rce,Dce,Oce,Nce,Mce,Lce,Fce,Bce,zce,Uce,kce,Gce,Hce,Vce,Wce,jce=(hie=dc("cc.ParticleSystemRenderer"),_ie=Jc(t7),fie=Vc(),die=Bc(),pie=Vc(),mie=Bc(),vie=Vc(),gie=Bc(),yie=Jc(t7),xie=Jc(EX),Sie=Vc(),Eie=Bc(),Tie=Jc(Ov),Cie=Vc(),bie=Bc(),Aie=Jc(Ov),wie=Vc(),Iie=Bc(),Pie=Vc(),Rie=Bc(),Die=Jc(e7),Oie=Vc(),Nie=Bc(),hie((Wie=Vie=function(){function e(){E(this,"_renderMode",Fie,this),E(this,"_velocityScale",Bie,this),E(this,"_lengthScale",zie,this),E(this,"_mesh",Uie,this),E(this,"_mainTexture",kie,this),E(this,"_useGPU",Gie,this),E(this,"_alignSpace",Hie,this),this._particleSystem=null}var t=e.prototype;return t.create=function(e){null===this._particleSystem?this._particleSystem=e:this._particleSystem!==e&&Y(6033)},t.onInit=function(e){if(this.create(e),this._particleSystem.processor)Y(6034);else{var t=this._useGPU&&yre();this._particleSystem.processor=t?new gre(this):new ire(this),this._particleSystem.processor.updateAlignSpace(this.alignSpace),this._particleSystem.processor.onInit(e)}},t._switchProcessor=function(){this._particleSystem&&(this._particleSystem.processor&&(this._particleSystem.processor.detachFromScene(),this._particleSystem.processor.clear(),this._particleSystem.processor=null),this._particleSystem.processor=this._useGPU?new gre(this):new ire(this),this._particleSystem.processor.updateAlignSpace(this.alignSpace),this._particleSystem.processor.onInit(this._particleSystem),this._particleSystem.processor.onEnable(),this._particleSystem.bindModule())},h(e,[{key:"renderMode",get:function(){return this._renderMode},set:function(e){this._renderMode!==e&&(this._renderMode=e,this._particleSystem&&this._particleSystem.processor.updateRenderMode())}},{key:"velocityScale",get:function(){return this._velocityScale},set:function(e){this._velocityScale=e,this._particleSystem&&this._particleSystem.processor.updateMaterialParams()}},{key:"lengthScale",get:function(){return this._lengthScale},set:function(e){this._lengthScale=e,this._particleSystem&&this._particleSystem.processor.updateMaterialParams()}},{key:"mesh",get:function(){return this._mesh},set:function(e){this._mesh=e,this._particleSystem&&this._particleSystem.processor.setVertexAttributes()}},{key:"particleMaterial",get:function(){return this._particleSystem?this._particleSystem.getMaterial(0):null},set:function(e){this._particleSystem&&this._particleSystem.setMaterial(e,0)}},{key:"trailMaterial",get:function(){return this._particleSystem?this._particleSystem.getMaterial(1):null},set:function(e){this._particleSystem&&this._particleSystem.setMaterial(e,1)}},{key:"mainTexture",get:function(){return this._mainTexture},set:function(e){this._mainTexture=e}},{key:"useGPU",get:function(){return this._useGPU},set:function(e){this._useGPU!==e&&(yre()?this._useGPU=e:this._useGPU=!1,this._switchProcessor())}},{key:"alignSpace",get:function(){return this._alignSpace},set:function(e){this._alignSpace=e,this._particleSystem.processor.updateAlignSpace(this._alignSpace)}}]),e}(),Vie.AlignmentSpace=e7,T((Lie=Wie).prototype,"renderMode",[_ie,fie,die],Object.getOwnPropertyDescriptor(Lie.prototype,"renderMode"),Lie.prototype),T(Lie.prototype,"velocityScale",[pie,mie],Object.getOwnPropertyDescriptor(Lie.prototype,"velocityScale"),Lie.prototype),T(Lie.prototype,"lengthScale",[vie,gie],Object.getOwnPropertyDescriptor(Lie.prototype,"lengthScale"),Lie.prototype),Fie=T(Lie.prototype,"_renderMode",[yie,Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return t7.Billboard}}),Bie=T(Lie.prototype,"_velocityScale",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),zie=T(Lie.prototype,"_lengthScale",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Uie=T(Lie.prototype,"_mesh",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),T(Lie.prototype,"mesh",[xie,Sie,Eie],Object.getOwnPropertyDescriptor(Lie.prototype,"mesh"),Lie.prototype),T(Lie.prototype,"particleMaterial",[Tie,Cie,qc,bie],Object.getOwnPropertyDescriptor(Lie.prototype,"particleMaterial"),Lie.prototype),T(Lie.prototype,"trailMaterial",[Aie,wie,qc,Iie],Object.getOwnPropertyDescriptor(Lie.prototype,"trailMaterial"),Lie.prototype),kie=T(Lie.prototype,"_mainTexture",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Gie=T(Lie.prototype,"_useGPU",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),T(Lie.prototype,"useGPU",[Pie,Rie],Object.getOwnPropertyDescriptor(Lie.prototype,"useGPU"),Lie.prototype),T(Lie.prototype,"alignSpace",[Die,Oie,Nie],Object.getOwnPropertyDescriptor(Lie.prototype,"alignSpace"),Lie.prototype),Hie=T(Lie.prototype,"_alignSpace",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return e7.View}}),Mie=Lie))||Mie),qce=Math.cos(rn(100)),Xce={position:new yn,velocity:new yn},Yce=new On,Kce=new kn,Qce=new yn,Jce=new yn,Zce=new Qn,$ce=function(){function e(e){for(this.start=void 0,this.end=void 0,this.trailElements=void 0,this.start=-1,this.end=-1,this.trailElements=[];e--;)this.trailElements.push({position:new yn,lifetime:0,width:0,velocity:new yn,direction:0,color:new Qn})}var t=e.prototype;return t.getElement=function(e){return-1===this.start?null:(e<0&&(e=(e+this.trailElements.length)%this.trailElements.length),e>=this.trailElements.length&&(e%=this.trailElements.length),this.trailElements[e])},t.addElement=function(){if(0===this.trailElements.length)return null;if(-1===this.start)return this.start=0,this.end=1,this.trailElements[0];this.start===this.end&&(this.trailElements.splice(this.end,0,{position:new yn,lifetime:0,width:0,velocity:new yn,direction:0,color:new Qn}),this.start++,this.start%=this.trailElements.length);var e=this.end++;return this.end%=this.trailElements.length,this.trailElements[e]},t.iterateElement=function(e,t,n,i){for(var r=this.start>=this.end?this.end+this.trailElements.length:this.end,o=this.start;o<r;o++)t(e,this.trailElements[o%this.trailElements.length],n,i)&&(this.start++,this.start%=this.trailElements.length);this.start===r&&(this.start=-1,this.end=-1)},t.count=function(){return this.start<this.end?this.end-this.start:this.trailElements.length+this.end-this.start},t.clear=function(){this.start=-1,this.end=-1},e}(),ele=(xre=dc("cc.TrailModule"),Sre=Vc(),Ere=Jc(o7),Tre=Vc(),Cre=Bc(),bre=Jc(K5),Are=zc(),wre=Vc(),Ire=Bc(),Pre=Vc(),Rre=Bc(),Dre=Jc(Z8),Ore=Vc(),Nre=Bc(),Mre=Jc(a7),Lre=Vc(),Fre=Bc(),Bre=Vc(),zre=Bc(),Ure=Jc(K5),kre=zc(),Gre=Vc(),Hre=Bc(),Vre=Vc(),Wre=Bc(),jre=Jc(a8),qre=Vc(),Xre=Bc(),Yre=Jc(a8),Kre=Vc(),Qre=Bc(),Jre=Jc(Z8),xre((T(($re=function(){var e=t.prototype;function t(){E(this,"_enable",eoe,this),E(this,"mode",toe,this),E(this,"lifeTime",noe,this),E(this,"_minParticleDistance",ioe,this),E(this,"existWithParticles",roe,this),E(this,"textureMode",ooe,this),E(this,"widthFromParticle",aoe,this),E(this,"widthRatio",soe,this),E(this,"colorFromParticle",coe,this),E(this,"colorOverTrail",loe,this),E(this,"colorOvertime",uoe,this),E(this,"_space",hoe,this),E(this,"_particleSystem",_oe,this),this._minSquaredDistance=0,this._vertSize=void 0,this._trailNum=0,this._trailLifetime=0,this.vbOffset=0,this.ibOffset=0,this._trailSegments=null,this._particleTrail=void 0,this._trailModel=null,this._iaInfo=void 0,this._iaInfoBuffer=null,this._subMeshData=null,this._vertAttrs=void 0,this._vbF32=null,this._vbUint32=null,this._iBuffer=null,this._needTransform=!1,this._material=null,this._iaInfo=new _r([new ur]),this._vertAttrs=[new br(qi.ATTR_POSITION,ai.RGB32F),new br(qi.ATTR_TEX_COORD,ai.RGBA32F),new br(qi.ATTR_TEX_COORD1,ai.RGB32F),new br(qi.ATTR_COLOR,ai.RGBA8,!0)],this._vertSize=0;for(var e,t=S(this._vertAttrs);!(e=t()).done;){var n=e.value;this._vertSize+=Kr[n.format].size}this._particleTrail=new Map}return e.getModel=function(){return this._trailModel},e.onInit=function(e){this._particleSystem=e,this.minParticleDistance=this._minParticleDistance;for(var t=0,n=e.startLifetime.getMax(),i=e.rateOverTime.getMax(),r=e.duration,o=0,a=e.bursts.length;o<a;o++)t+=e.bursts[o].getMaxCount(e)*Math.ceil(n/r);this._trailNum=Math.ceil(n*this.lifeTime.getMax()*60*(i*r+t)),this._trailSegments=new Ml((function(){return new $ce(10)}),Math.ceil(i*r),(function(e){return e.trailElements.length=0})),this._enable&&(this.enable=this._enable)},e.onEnable=function(){this._attachToScene()},e.onDisable=function(){this._particleTrail.clear(),this._detachFromScene()},e._attachToScene=function(){this._trailModel&&(this._trailModel.scene&&this._detachFromScene(),this._particleSystem._getRenderScene().addModel(this._trailModel))},e._detachFromScene=function(){this._trailModel&&this._trailModel.scene&&this._trailModel.scene.removeModel(this._trailModel)},e.destroy=function(){this.destroySubMeshData(),this._trailModel&&(KO.root.destroyModel(this._trailModel),this._trailModel=null),this._trailSegments&&(this._trailSegments.destroy(),this._trailSegments=null)},e.play=function(){this._trailModel&&this._enable&&(this._trailModel.enabled=!0)},e.clear=function(){if(this.enable){for(var e=this._particleTrail.values(),t=e.next();!t.done;)t.value.clear(),t=e.next();this._particleTrail.clear(),this.updateRenderData(),this._trailModel&&(this._trailModel.enabled=!1)}},e.updateMaterial=function(){this._particleSystem&&(this._material=this._particleSystem.getMaterialInstance(1)||this._particleSystem.processor._defaultTrailMat,this._trailModel&&this._trailModel.setSubModelMaterial(0,this._material))},e.update=function(){this._trailLifetime=this.lifeTime.evaluate(this._particleSystem._time,1),this.space===Z8.World&&this._particleSystem._simulationSpace===Z8.Local?(this._needTransform=!0,this._particleSystem.node.getWorldMatrix(Kce),this._particleSystem.node.getWorldRotation(Yce)):this._needTransform=!1},e.animate=function(e,t){if(this._trailSegments)if(e.loopCount>e.lastLoop)e.trailDelay>1?(e.lastLoop=e.loopCount,e.trailDelay=0):e.trailDelay++;else{var n=this._particleTrail.get(e);if(!n)return n=this._trailSegments.alloc(),void this._particleTrail.set(e,n);var i=n.getElement(n.end-1);if(this._needTransform?yn.transformMat4(Qce,e.position,Kce):yn.copy(Qce,e.position),!(i&&(n.iterateElement(this,this._updateTrailElement,e,t),yn.squaredDistance(i.position,Qce)<this._minSquaredDistance))&&(i=n.addElement())){yn.copy(i.position,Qce),i.lifetime=0,this.widthFromParticle?i.width=e.size.x*this.widthRatio.evaluate(0,1):i.width=this.widthRatio.evaluate(0,1);var r=n.count();if(2===r){var o=n.getElement(n.end-2);yn.subtract(o.velocity,i.position,o.position)}else if(r>2){var a=n.getElement(n.end-2),s=n.getElement(n.end-3);yn.subtract(Qce,s.position,a.position),yn.subtract(Jce,i.position,a.position),yn.subtract(a.velocity,Jce,Qce),yn.equals(yn.ZERO,a.velocity)&&yn.copy(a.velocity,Qce),yn.normalize(a.velocity,a.velocity),this._checkDirectionReverse(a,s)}this.colorFromParticle?i.color.set(e.color):i.color.set(this.colorOvertime.evaluate(0,1))}}},e.removeParticle=function(e){var t=this._particleTrail.get(e);t&&this._trailSegments&&(t.clear(),this._trailSegments.free(t),this._particleTrail.delete(e))},e.updateRenderData=function(){this.vbOffset=0,this.ibOffset=0;for(var e,t=S(this._particleTrail.keys());!(e=t()).done;){var n=e.value,i=this._particleTrail.get(n);if(-1!==i.start){var r=4*this.vbOffset/this._vertSize,o=i.start>=i.end?i.end+i.trailElements.length:i.end,a=o-i.start,s=1/a,c=i.trailElements[i.start];this._fillVertexBuffer(c,this.colorOverTrail.evaluate(1,1),r,1,0,4);for(var l=i.start+1;l<o;l++){var u=i.trailElements[l%i.trailElements.length],h=l-i.start;this._fillVertexBuffer(u,this.colorOverTrail.evaluate(1-h/a,1),r,1-h*s,h,5)}this._needTransform?yn.transformMat4(Xce.position,n.position,Kce):yn.copy(Xce.position,n.position);var _=this._trailModel;if(_&&_.node.invalidateChildren(Zg.POSITION),1===a||2===a){var f=i.getElement(i.end-1);yn.subtract(f.velocity,Xce.position,f.position),this._vbF32[this.vbOffset-this._vertSize/4-4]=f.velocity.x,this._vbF32[this.vbOffset-this._vertSize/4-3]=f.velocity.y,this._vbF32[this.vbOffset-this._vertSize/4-2]=f.velocity.z,this._vbF32[this.vbOffset-4]=f.velocity.x,this._vbF32[this.vbOffset-3]=f.velocity.y,this._vbF32[this.vbOffset-2]=f.velocity.z,yn.subtract(Xce.velocity,Xce.position,f.position),this._checkDirectionReverse(Xce,f)}else if(a>2){var d=i.getElement(i.end-1),p=i.getElement(i.end-2);yn.subtract(Qce,p.position,d.position),yn.subtract(Jce,Xce.position,d.position),yn.normalize(Qce,Qce),yn.normalize(Jce,Jce),yn.subtract(d.velocity,Jce,Qce),yn.normalize(d.velocity,d.velocity),this._checkDirectionReverse(d,p),this.vbOffset-=this._vertSize/4*2,this.ibOffset-=6,this._fillVertexBuffer(d,this.colorOverTrail.evaluate(s,1),r,s,a-1,5),yn.subtract(Xce.velocity,Xce.position,d.position),yn.normalize(Xce.velocity,Xce.velocity),this._checkDirectionReverse(Xce,d)}this.widthFromParticle?Xce.width=n.size.x*this.widthRatio.evaluate(0,1):Xce.width=this.widthRatio.evaluate(0,1),Xce.color=n.color,yn.equals(Xce.velocity,yn.ZERO)?this.ibOffset-=3:this._fillVertexBuffer(Xce,this.colorOverTrail.evaluate(0,1),r,0,a,1)}}this._trailModel.enabled=this.ibOffset>0},e.updateIA=function(e){var t=this._trailModel&&this._trailModel.subModels;if(t&&t.length>0){var n=t[0];n.inputAssembler.vertexBuffers[0].update(this._vbF32),n.inputAssembler.indexBuffer.update(this._iBuffer),this._iaInfo.drawInfos[0].firstIndex=0,this._iaInfo.drawInfos[0].indexCount=e,this._iaInfoBuffer.update(this._iaInfo)}},e.beforeRender=function(){this.updateIA(this.ibOffset)},e._createModel=function(){this._trailModel||(this._trailModel=b.director.root.createModel(Ug))},e.rebuild=function(){var e=KO.root.device,t=e.createBuffer(new cr(li.VERTEX|li.TRANSFER_DST,_i.HOST|_i.DEVICE,this._vertSize*(this._trailNum+1)*2,this._vertSize)),n=new ArrayBuffer(this._vertSize*(this._trailNum+1)*2);this._vbF32=new Float32Array(n),this._vbUint32=new Uint32Array(n),t.update(n);var i=e.createBuffer(new cr(li.INDEX|li.TRANSFER_DST,_i.HOST|_i.DEVICE,6*Math.max(1,this._trailNum)*Uint16Array.BYTES_PER_ELEMENT,Uint16Array.BYTES_PER_ELEMENT));this._iBuffer=new Uint16Array(6*Math.max(1,this._trailNum)),i.update(this._iBuffer),this._iaInfoBuffer=e.createBuffer(new cr(li.INDIRECT,_i.HOST|_i.DEVICE,$r,$r)),this._iaInfo.drawInfos[0].vertexCount=2*(this._trailNum+1),this._iaInfo.drawInfos[0].indexCount=6*this._trailNum,this._iaInfoBuffer.update(this._iaInfo),this._subMeshData=new HA([t],this._vertAttrs,Oi.TRIANGLE_LIST,i,this._iaInfoBuffer);var r=this._trailModel;r&&(r.node=r.transform=this._particleSystem.node,r.visFlags=this._particleSystem.visibility,r.initSubModel(0,this._subMeshData,this._material),r.enabled=!0)},e._updateTrailElement=function(e,t,n,i){return t.lifetime+=i,e.colorFromParticle?(t.color.set(n.color),t.color.multiply(e.colorOvertime.evaluate(1-n.remainingLifetime/n.startLifetime,1))):t.color.set(e.colorOvertime.evaluate(1-n.remainingLifetime/n.startLifetime,1)),e.widthFromParticle?t.width=n.size.x*e.widthRatio.evaluate(t.lifetime/e._trailLifetime,1):t.width=e.widthRatio.evaluate(t.lifetime/e._trailLifetime,1),t.lifetime>e._trailLifetime},e._fillVertexBuffer=function(e,t,n,i,r,o){this._vbF32[this.vbOffset++]=e.position.x,this._vbF32[this.vbOffset++]=e.position.y,this._vbF32[this.vbOffset++]=e.position.z,this._vbF32[this.vbOffset++]=e.direction,this._vbF32[this.vbOffset++]=e.width,this._vbF32[this.vbOffset++]=i,this._vbF32[this.vbOffset++]=0,this._vbF32[this.vbOffset++]=e.velocity.x,this._vbF32[this.vbOffset++]=e.velocity.y,this._vbF32[this.vbOffset++]=e.velocity.z,Zce.set(e.color),Zce.multiply(t),this._vbUint32[this.vbOffset++]=Zce._val,this._vbF32[this.vbOffset++]=e.position.x,this._vbF32[this.vbOffset++]=e.position.y,this._vbF32[this.vbOffset++]=e.position.z,this._vbF32[this.vbOffset++]=1-e.direction,this._vbF32[this.vbOffset++]=e.width,this._vbF32[this.vbOffset++]=i,this._vbF32[this.vbOffset++]=1,this._vbF32[this.vbOffset++]=e.velocity.x,this._vbF32[this.vbOffset++]=e.velocity.y,this._vbF32[this.vbOffset++]=e.velocity.z,this._vbUint32[this.vbOffset++]=Zce._val,1&o&&(this._iBuffer[this.ibOffset++]=n+2*r,this._iBuffer[this.ibOffset++]=n+2*r-1,this._iBuffer[this.ibOffset++]=n+2*r+1),4&o&&(this._iBuffer[this.ibOffset++]=n+2*r,this._iBuffer[this.ibOffset++]=n+2*r+1,this._iBuffer[this.ibOffset++]=n+2*r+2)},e._checkDirectionReverse=function(e,t){yn.dot(e.velocity,t.velocity)<qce?e.direction=1-t.direction:e.direction=t.direction},e.destroySubMeshData=function(){this._subMeshData&&(this._subMeshData.destroy(),this._subMeshData=null)},h(t,[{key:"enable",get:function(){return this._enable},set:function(e){e===this._enable&&this._trailModel||(e&&!this._enable&&(this._enable=e,this._particleSystem.processor&&this._particleSystem.processor.updateTrailMaterial()),e&&!this._trailModel&&(this._createModel(),this.rebuild()),this._enable=e,this._trailModel&&(this._trailModel.enabled=e),e?this.onEnable():this.onDisable())}},{key:"minParticleDistance",get:function(){return this._minParticleDistance},set:function(e){this._minParticleDistance=e,this._minSquaredDistance=e*e}},{key:"space",get:function(){return this._space},set:function(e){this._space=e;var t=this._particleSystem;t&&t.processor&&t.processor.updateTrailMaterial()}}]),t}()).prototype,"enable",[Sre],Object.getOwnPropertyDescriptor($re.prototype,"enable"),$re.prototype),eoe=T($re.prototype,"_enable",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),toe=T($re.prototype,"mode",[Ere,Ec,Tre,Cre],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return o7.Particles}}),noe=T($re.prototype,"lifeTime",[bre,Ec,Are,wre,Ire],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new K5}}),ioe=T($re.prototype,"_minParticleDistance",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),T($re.prototype,"minParticleDistance",[Pre,Rre],Object.getOwnPropertyDescriptor($re.prototype,"minParticleDistance"),$re.prototype),T($re.prototype,"space",[Dre,Ore,Nre],Object.getOwnPropertyDescriptor($re.prototype,"space"),$re.prototype),roe=T($re.prototype,"existWithParticles",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),ooe=T($re.prototype,"textureMode",[Mre,Ec,Lre,Fre],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return a7.Stretch}}),aoe=T($re.prototype,"widthFromParticle",[Ec,Bre,zre],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),soe=T($re.prototype,"widthRatio",[Ure,Ec,kre,Gre,Hre],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new K5}}),coe=T($re.prototype,"colorFromParticle",[Ec,Vre,Wre],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),loe=T($re.prototype,"colorOverTrail",[jre,Ec,qre,Xre],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new a8}}),uoe=T($re.prototype,"colorOvertime",[Yre,Ec,Kre,Qre],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new a8}}),hoe=T($re.prototype,"_space",[Jre],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Z8.World}}),_oe=T($re.prototype,"_particleSystem",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Zre=$re))||Zre),tle=new kn,nle=new On,ile=new yn,rle=["_colorOverLifetimeModule","_sizeOvertimeModule","_velocityOvertimeModule","_forceOvertimeModule","_limitVelocityOvertimeModule","_rotationOvertimeModule","_textureAnimationModule"],ole=function(){function e(e){this._particleSystem=void 0,this._processor=void 0,this._node=void 0,this._particlesAll=void 0,this._updateList=new Map,this._animateList=new Map,this._runAnimateList=new Array,this._localMat=new kn,this._gravity=new wn,this.minPos=new yn,this.maxPos=new yn,this._nodePos=new yn,this._nodeSize=new yn,this._particleSystem=e,this._processor=this._particleSystem.processor,this._node=e.node,this._particlesAll=[],this._initModuleList()}var t=e.prototype;return t._updateBoundingNode=function(){this._nodeSize.set(this.maxPos.x-this.minPos.x,this.maxPos.y-this.minPos.y,this.maxPos.z-this.minPos.z),this._nodePos.set(this.minPos.x+.5*this._nodeSize.x,this.minPos.y+.5*this._nodeSize.y,this.minPos.z+.5*this._nodeSize.z)},t.setBoundingBoxSize=function(e){this.maxPos.x=this._nodePos.x+e.x,this.maxPos.y=this._nodePos.y+e.y,this.maxPos.z=this._nodePos.z+e.z,this.minPos.x=this._nodePos.x-e.x,this.minPos.y=this._nodePos.y-e.y,this.minPos.z=this._nodePos.z-e.z,this._updateBoundingNode()},t.setBoundingBoxCenter=function(e,t,n){this.maxPos.x=e+.5*this._nodeSize.x,this.maxPos.y=t+.5*this._nodeSize.y,this.maxPos.z=n+.5*this._nodeSize.z,this.minPos.x=e-.5*this._nodeSize.x,this.minPos.y=t-.5*this._nodeSize.y,this.minPos.z=n-.5*this._nodeSize.z,this._updateBoundingNode()},t._initModuleList=function(){var e=this;rle.forEach((function(t){var n=e._particleSystem[t];n&&n.enable&&(n.needUpdate&&(e._updateList[n.name]=n),n.needAnimate&&(e._animateList[n.name]=n))})),this._runAnimateList.length=0;for(var t=0,n=K8.length;t<n;t++){var i=this._animateList[K8[t]];i&&this._runAnimateList.push(i)}},t._emit=function(e,t,i){var r=this._particleSystem,o=this._node,a=r.time%r.duration/r.duration;o.invalidateChildren(Zg.POSITION),r.simulationSpace===Z8.World&&(o.getWorldMatrix(tle),o.getWorldRotation(nle));for(var s=0;s<e;++s){var c=new u8(r);c.particleSystem=r,c.reset();var l=ln(cn(0,n));r._shapeModule&&r._shapeModule.enable?r._shapeModule.emit(c):(yn.set(c.position,0,0,0),yn.copy(c.velocity,c7)),r._textureAnimationModule&&r._textureAnimationModule.enable&&r._textureAnimationModule.init(c);var u=r.startSpeed.evaluate(a,l);yn.multiplyScalar(c.velocity,c.velocity,u),r.simulationSpace===Z8.World&&(yn.transformMat4(c.position,c.position,tle),yn.transformQuat(c.velocity,c.velocity,nle)),yn.copy(c.ultimateVelocity,c.velocity),yn.set(c.rotation,0,0,0),r.startSize3D?yn.set(c.startSize,r.startSizeX.evaluate(a,l),r.startSizeY.evaluate(a,l),r.startSizeZ.evaluate(a,l)):(yn.set(c.startSize,r.startSizeX.evaluate(a,l),1,1),c.startSize.y=c.startSize.x),yn.copy(c.size,c.startSize),c.startLifetime=r.startLifetime.evaluate(a,l)+t,c.remainingLifetime=c.startLifetime,i.push(c)}},t._updateParticles=function(e,t){var n=this,i=this._particleSystem;switch(i.node.getWorldMatrix(tle),i.scaleSpace){case Z8.Local:i.node.getScale(ile);break;case Z8.World:i.node.getWorldScale(ile)}if(this._updateList.forEach((function(e){e.update(i.simulationSpace,tle)})),i.simulationSpace===Z8.Local){var r=i.node.getRotation();kn.fromQuat(this._localMat,r),this._localMat.transpose()}for(var o=function(r){var o=t[r];if(o.remainingLifetime-=e,yn.set(o.animatedVelocity,0,0,0),i.simulationSpace===Z8.Local){var a=9.8*-i.gravityModifier.evaluate(1-o.remainingLifetime/o.startLifetime,ln(o.randomSeed))*e;n._gravity.x=0,n._gravity.y=a,n._gravity.z=0,n._gravity.w=1,n._gravity=n._gravity.transformMat4(n._localMat),o.velocity.x+=n._gravity.x,o.velocity.y+=n._gravity.y,o.velocity.z+=n._gravity.z}else o.velocity.y-=9.8*i.gravityModifier.evaluate(1-o.remainingLifetime/o.startLifetime,ln(o.randomSeed))*e;yn.copy(o.ultimateVelocity,o.velocity),n._runAnimateList.forEach((function(t){t.animate(o,e)})),yn.scaleAndAdd(o.position,o.position,o.ultimateVelocity,e)},a=0;a<t.length;++a)o(a)},t._calculateBounding=function(e){var t=new yn,n=new yn,i=new yn,r=new yn,o=new yn(1,1,1);if(this._processor.getInfo().renderMode===t7.Mesh){var a=this._processor.getInfo().mesh;if(a&&a.struct.minPosition&&a.struct.maxPosition){var s=new Us;Us.fromPoints(s,a.struct.minPosition,a.struct.maxPosition);var c=Math.max(s.halfExtents.x,s.halfExtents.y,s.halfExtents.z);o.set(c,c,c)}}for(var l=0;l<this._particlesAll.length;++l){var u=this._particlesAll[l];yn.multiply(t,ile,u.size),yn.multiply(t,t,o),n.set(u.position),this._particleSystem.simulationSpace!==Z8.World&&yn.transformMat4(n,n,this._particleSystem.node._mat),e&&0===l?(yn.subtract(this.minPos,n,t),yn.add(this.maxPos,n,t)):(yn.subtract(i,n,t),yn.add(r,n,t),yn.min(this.minPos,this.minPos,i),yn.max(this.maxPos,this.maxPos,r))}},t.calculatePositions=function(){this._emit(this._particleSystem.capacity,0,this._particlesAll);var e=ln(cn(0,n));this._updateParticles(0,this._particlesAll),this._calculateBounding(!0),this._updateParticles(this._particleSystem.startLifetime.evaluate(0,e),this._particlesAll),this._calculateBounding(!1),this._updateBoundingNode()},t.clear=function(){this._particlesAll.length=0},t.destroy=function(){},e}(),ale=new kn,sle=new On,cle=Object.getOwnPropertyDescriptor(jL.prototype,"sharedMaterials"),lle=e("ParticleSystem",(foe=dc("cc.ParticleSystem"),doe=Oc(),poe=Ic(),moe=mc(99),voe=zc(),goe=Vc(),yoe=Bc(),xoe=Jc(a8),Soe=Vc(),Eoe=Bc(),Toe=Jc(Z8),Coe=Vc(),boe=Bc(),Aoe=Vc(),woe=Bc(),Ioe=Tc("startSize"),Poe=zc(),Roe=Jc(K5),Doe=Vc(),Ooe=Bc(),Noe=Jc(K5),Moe=zc(),Loe=Vc(),Foe=Bc(),Boe=Jc(K5),zoe=zc(),Uoe=Vc(),koe=Bc(),Goe=Jc(K5),Hoe=zc(),Voe=Vc(),Woe=Bc(),joe=Vc(),qoe=Bc(),Xoe=Jc(K5),Yoe=zc(),Koe=Vc(),Qoe=Bc(),Joe=Jc(K5),Zoe=zc(),$oe=Vc(),eae=Bc(),tae=Jc(K5),nae=Tc("startRotation"),iae=zc(),rae=Vc(),oae=Bc(),aae=Jc(K5),sae=zc(),cae=Vc(),lae=Bc(),uae=Jc(K5),hae=zc(),_ae=Vc(),fae=Bc(),dae=Vc(),pae=Bc(),mae=Vc(),vae=Bc(),gae=Vc(),yae=Bc(),xae=Jc(Z8),Sae=Vc(),Eae=Bc(),Tae=Vc(),Cae=Bc(),bae=Vc(),Aae=Bc(),wae=Jc(K5),Iae=zc(),Pae=Vc(),Rae=Bc(),Dae=Jc(K5),Oae=zc(),Nae=Vc(),Mae=Bc(),Lae=Jc(K5),Fae=zc(),Bae=Vc(),zae=Bc(),Uae=Jc([oie]),kae=Vc(),Gae=Bc(),Hae=Jc(Boolean),Vae=Vc(),Wae=Bc(),jae=Jc($8),qae=Vc(),Xae=Bc(),Yae=Jc(Number),Kae=Vc(),Qae=Bc(),Jae=Jc(Number),Zae=Vc(),$ae=Bc(),ese=Jc(Number),tse=Vc(),nse=Bc(),ise=Vc(),rse=Bc(),ose=Tc("enableCulling"),ase=Mc(),sse=Jc(Ov),cse=Fc(),lse=Jc(s7),use=Jc(s7),hse=Vc(),_se=Bc(),fse=Jc(lie),dse=Jc(lie),pse=Vc(),mse=Bc(),vse=Jc(Jne),gse=Jc(Jne),yse=Vc(),xse=Bc(),Sse=Jc(rie),Ese=Jc(rie),Tse=Vc(),Cse=Bc(),bse=Jc(C9),Ase=Jc(C9),wse=Vc(),Ise=Bc(),Pse=Jc(I9),Rse=Jc(I9),Dse=Vc(),Ose=Bc(),Nse=Jc(Qne),Mse=Jc(Qne),Lse=Vc(),Fse=Bc(),Bse=Jc(tie),zse=Jc(tie),Use=Vc(),kse=Bc(),Gse=Jc(ele),Hse=Jc(ele),Vse=Vc(),Wse=Bc(),jse=Jc(jce),qse=Vc(),Xse=Bc(),foe(Yse=doe(Yse=poe(Yse=moe(Yse=wc((Bce=Fce=function(e){function t(){var t;return E(t=e.call(this)||this,"startColor",Qse,y(t)),E(t,"scaleSpace",Jse,y(t)),E(t,"startSize3D",Zse,y(t)),E(t,"startSizeX",$se,y(t)),E(t,"startSizeY",ece,y(t)),E(t,"startSizeZ",tce,y(t)),E(t,"startSpeed",nce,y(t)),E(t,"startRotation3D",ice,y(t)),E(t,"startRotationX",rce,y(t)),E(t,"startRotationY",oce,y(t)),E(t,"startRotationZ",ace,y(t)),E(t,"startDelay",sce,y(t)),E(t,"startLifetime",cce,y(t)),E(t,"duration",lce,y(t)),E(t,"loop",uce,y(t)),E(t,"simulationSpeed",hce,y(t)),E(t,"playOnAwake",_ce,y(t)),E(t,"gravityModifier",fce,y(t)),E(t,"rateOverTime",dce,y(t)),E(t,"rateOverDistance",pce,y(t)),E(t,"bursts",mce,y(t)),E(t,"_renderCulling",vce,y(t)),E(t,"_cullingMode",gce,y(t)),E(t,"_aabbHalfX",yce,y(t)),E(t,"_aabbHalfY",xce,y(t)),E(t,"_aabbHalfZ",Sce,y(t)),E(t,"_dataCulling",Ece,y(t)),E(t,"_colorOverLifetimeModule",Tce,y(t)),E(t,"_shapeModule",Cce,y(t)),E(t,"_sizeOvertimeModule",bce,y(t)),E(t,"_velocityOvertimeModule",Ace,y(t)),E(t,"_forceOvertimeModule",wce,y(t)),E(t,"_limitVelocityOvertimeModule",Ice,y(t)),E(t,"_rotationOvertimeModule",Pce,y(t)),E(t,"_textureAnimationModule",Rce,y(t)),E(t,"_trailModule",Dce,y(t)),E(t,"renderer",Oce,y(t)),t._isPlaying=void 0,t._isPaused=void 0,t._isStopped=void 0,t._isEmitting=void 0,t._needRefresh=void 0,t._time=void 0,t._emitRateTimeCounter=void 0,t._emitRateDistanceCounter=void 0,t._oldWPos=void 0,t._curWPos=void 0,t._boundingBox=void 0,t._culler=void 0,t._oldPos=void 0,t._curPos=void 0,t._isCulled=void 0,t._isSimulating=void 0,t._customData1=void 0,t._customData2=void 0,t._subEmitters=void 0,t._needAttach=void 0,E(t,"_prewarm",Nce,y(t)),E(t,"_capacity",Mce,y(t)),E(t,"_simulationSpace",Lce,y(t)),t.processor=null,t.rateOverTime.constant=10,t.startLifetime.constant=5,t.startSizeX.constant=1,t.startSpeed.constant=5,t._isPlaying=!1,t._isPaused=!1,t._isStopped=!0,t._isEmitting=!1,t._needRefresh=!0,t._needAttach=!1,t._time=0,t._emitRateTimeCounter=0,t._emitRateDistanceCounter=0,t._oldWPos=new yn,t._curWPos=new yn,t._boundingBox=null,t._culler=null,t._oldPos=null,t._curPos=null,t._isCulled=!1,t._isSimulating=!0,t._customData1=new Tn,t._customData2=new Tn,t._subEmitters=[],t}f(t,e);var i=t.prototype;return i.onFocusInEditor=function(){this.renderer.create(this)},i.onLoad=function(){this.renderer.onInit(this),this._shapeModule&&this._shapeModule.onInit(this),this._trailModule&&this._trailModule.onInit(this),this.bindModule(),this._resetPosition()},i._onMaterialModified=function(e,t){null!==this.processor&&this.processor.onMaterialModified(e,t)},i._onRebuildPSO=function(e,t){this.processor.onRebuildPSO(e,t)},i._collectModels=function(){return this._models.length=0,this._models.push(this.processor._model),this._trailModule&&this._trailModule.enable&&this._trailModule._trailModel&&this._models.push(this._trailModule._trailModel),this._models},i._attachToScene=function(){this.processor.attachToScene(),this._trailModule&&this._trailModule.enable&&this._trailModule._attachToScene()},i._detachFromScene=function(){this.processor.detachFromScene(),this._trailModule&&this._trailModule.enable&&this._trailModule._detachFromScene(),this._boundingBox&&(this._boundingBox=null),this._culler&&(this._culler.clear(),this._culler.destroy(),this._culler=null)},i.bindModule=function(){this._colorOverLifetimeModule&&this._colorOverLifetimeModule.bindTarget(this.processor),this._sizeOvertimeModule&&this._sizeOvertimeModule.bindTarget(this.processor),this._rotationOvertimeModule&&this._rotationOvertimeModule.bindTarget(this.processor),this._forceOvertimeModule&&this._forceOvertimeModule.bindTarget(this.processor),this._limitVelocityOvertimeModule&&this._limitVelocityOvertimeModule.bindTarget(this.processor),this._velocityOvertimeModule&&this._velocityOvertimeModule.bindTarget(this.processor),this._textureAnimationModule&&this._textureAnimationModule.bindTarget(this.processor)},i.play=function(){if(this._isPaused&&(this._isPaused=!1),this._isStopped&&(this._isStopped=!1),this._isPlaying=!0,this._isEmitting=!0,this._resetPosition(),this._prewarm&&this._prewarmSystem(),this._trailModule&&this._trailModule.play(),this.processor){var e=this.processor.getModel();e&&(e.enabled=this.enabledInHierarchy)}},i.pause=function(){this._isStopped?console.warn("pause(): particle system is already stopped."):(this._isPlaying&&(this._isPlaying=!1),this._isPaused=!0)},i.stop=function(){(this._isPlaying||this._isPaused)&&this.clear(),this._isPlaying&&(this._isPlaying=!1),this._isPaused&&(this._isPaused=!1),this._time=0,this._emitRateTimeCounter=0,this._emitRateDistanceCounter=0,this._isStopped=!0,this._needRefresh=!0;for(var e,t=S(this.bursts);!(e=t()).done;)e.value.reset()},i.clear=function(){this.enabledInHierarchy&&(this.processor.clear(),this._trailModule&&this._trailModule.clear()),this._calculateBounding(!1)},i.getParticleCount=function(){return this.processor.getParticleCount()},i.setCustomData1=function(e,t){Tn.set(this._customData1,e,t)},i.setCustomData2=function(e,t){Tn.set(this._customData2,e,t)},i.onDestroy=function(){b.director.off(b.Director.EVENT_BEFORE_COMMIT,this.beforeRender,this),this.processor.onDestroy(),this._trailModule&&this._trailModule.destroy(),this._culler&&(this._culler.clear(),this._culler.destroy(),this._culler=null)},i.onEnable=function(){b.director.on(b.Director.EVENT_BEFORE_COMMIT,this.beforeRender,this),this.playOnAwake&&this.play(),this.processor.onEnable(),this._trailModule&&this._trailModule.onEnable()},i.onDisable=function(){b.director.off(b.Director.EVENT_BEFORE_COMMIT,this.beforeRender,this),this.processor.onDisable(),this._trailModule&&this._trailModule.onDisable(),this._boundingBox&&(this._boundingBox=null),this._culler&&(this._culler.clear(),this._culler.destroy(),this._culler=null)},i._calculateBounding=function(e){this._boundingBox&&(this._culler||(this._culler=new ole(this)),this._culler.calculatePositions(),Us.fromPoints(this._boundingBox,this._culler.minPos,this._culler.maxPos),e?(this.aabbHalfX=this._boundingBox.halfExtents.x,this.aabbHalfY=this._boundingBox.halfExtents.y,this.aabbHalfZ=this._boundingBox.halfExtents.z):(this.aabbHalfX?this.setBoundingX(this.aabbHalfX):this.aabbHalfX=this._boundingBox.halfExtents.x,this.aabbHalfY?this.setBoundingY(this.aabbHalfY):this.aabbHalfY=this._boundingBox.halfExtents.y,this.aabbHalfZ?this.setBoundingZ(this.aabbHalfZ):this.aabbHalfZ=this._boundingBox.halfExtents.z),this._culler.clear())},i.update=function(e){var t,n,i=e*this.simulationSpeed;if(this.renderCulling){var r;if(this._boundingBox||(this._boundingBox=new Us,this._calculateBounding(!1)),this._curPos||(this._curPos=new yn),this.node.getWorldPosition(this._curPos),this._oldPos||(this._oldPos=new yn,this._oldPos.set(this._curPos)),!this._curPos.equals(this._oldPos)&&this._boundingBox&&this._culler){var o=this._curPos.x-this._oldPos.x,a=this._curPos.y-this._oldPos.y,s=this._curPos.z-this._oldPos.z,c=this._boundingBox.center;c.x+=o,c.y+=a,c.z+=s,this._culler.setBoundingBoxCenter(c.x,c.y,c.z),this._oldPos.set(this._curPos)}var l=null===(r=this.node.scene.renderScene)||void 0===r?void 0:r.cameras,u=!0;if(void 0!==l&&this._boundingBox)for(var h=0;h<l.length;++h){var _=l[h];if((_.visibility&this.node.layer)===this.node.layer&&rs.aabbFrustum(this._boundingBox,_.frustum)){u=!1;break}}if(u){if(this._cullingMode!==$8.AlwaysSimulate&&(this._isSimulating=!1),this._isCulled||(this.processor.detachFromScene(),this._isCulled=!0),this._trailModule&&this._trailModule.enable&&this._trailModule._detachFromScene(),this._cullingMode===$8.PauseAndCatchup&&(this._time+=i),this._cullingMode!==$8.AlwaysSimulate)return}else this._isCulled&&(this._attachToScene(),this._isCulled=!1),this._isSimulating||(this._isSimulating=!0);if(!this._isSimulating)return}else this._boundingBox&&(this._boundingBox=null),this._culler&&(this._culler.clear(),this._culler.destroy(),this._culler=null),this._isSimulating=!0;if(this._isPlaying)this._time+=i,this._emit(i),0!==this.processor.updateParticles(i)||this._isEmitting||this.stop();else{var f=(this.getMaterialInstance(0)||this.processor.getDefaultMaterial()).passes[0];this.processor.updateRotation(f),this.processor.updateScale(f)}(this.processor.updateRenderData(),this._trailModule&&this._trailModule.enable&&this._trailModule.updateRenderData(),this._needAttach&&this.getParticleCount()>0&&!this._isCulled)&&((null===(t=this.processor.getModel())||void 0===t?void 0:t.scene)||this.processor.attachToScene(),this._trailModule&&this._trailModule.enable&&((null===(n=this._trailModule.getModel())||void 0===n?void 0:n.scene)||this._trailModule._attachToScene()),this._needAttach=!1)},i.beforeRender=function(){var e,t;this._isPlaying&&(this.processor.beforeRender(),this._trailModule&&this._trailModule.enable&&this._trailModule.beforeRender(),this.getParticleCount()<=0?(null===(t=this.processor.getModel())||void 0===t?void 0:t.scene)&&(this.processor.detachFromScene(),this._trailModule&&this._trailModule.enable&&this._trailModule._detachFromScene(),this._needAttach=!1):(null===(e=this.processor.getModel())||void 0===e?void 0:e.scene)||(this._needAttach=!0))},i._onVisibilityChange=function(e){this.processor._model&&(this.processor._model.visFlags=e)},i.emit=function(e,t){var i=this._time%this.duration/this.duration;this._needRefresh&&(this.node.invalidateChildren(Zg.POSITION),this._needRefresh=!1),this._simulationSpace===Z8.World&&(this.node.getWorldMatrix(ale),this.node.getWorldRotation(sle));for(var r=0;r<e;++r){var o=this.processor.getFreeParticle();if(null===o)return;o.particleSystem=this,o.reset();var a=ln(cn(0,n));this._shapeModule&&this._shapeModule.enable?this._shapeModule.emit(o):(yn.set(o.position,0,0,0),yn.copy(o.velocity,c7)),this._textureAnimationModule&&this._textureAnimationModule.enable&&this._textureAnimationModule.init(o);var s=this.startSpeed.evaluate(i,a);yn.multiplyScalar(o.velocity,o.velocity,s),this._simulationSpace===Z8.World&&(yn.transformMat4(o.position,o.position,ale),yn.transformQuat(o.velocity,o.velocity,sle)),yn.copy(o.ultimateVelocity,o.velocity),this.startRotation3D?o.startEuler.set(this.startRotationX.evaluate(i,a),this.startRotationY.evaluate(i,a),this.startRotationZ.evaluate(i,a)):o.startEuler.set(0,0,this.startRotationZ.evaluate(i,a)),o.rotation.set(o.startEuler),this.startSize3D?yn.set(o.startSize,this.startSizeX.evaluate(i,a),this.startSizeY.evaluate(i,a),this.startSizeZ.evaluate(i,a)):(yn.set(o.startSize,this.startSizeX.evaluate(i,a),1,1),o.startSize.y=o.startSize.x),yn.copy(o.size,o.startSize),o.startColor.set(this.startColor.evaluate(i,a)),o.color.set(o.startColor),o.startLifetime=this.startLifetime.evaluate(i,a)+t,o.remainingLifetime=o.startLifetime,o.randomSeed=cn(0,233280),o.loopCount++,this.processor.setNewParticle(o)}},i._prewarmSystem=function(){this.startDelay.mode=Y5.Constant,this.startDelay.constant=0;for(var e=this.duration/1,t=0;t<e;++t)this._time+=1,this._emit(1),this.processor.updateParticles(1)},i._emit=function(e){var t=this.startDelay.evaluate(0,1);if(this._time>t){if(this._time>this.duration+t&&!this.loop)return void(this._isEmitting=!1);if(this._emitRateTimeCounter+=this.rateOverTime.evaluate(this._time/this.duration,1)*e,this._emitRateTimeCounter>1&&this._isEmitting){var n=Math.floor(this._emitRateTimeCounter);this._emitRateTimeCounter-=n,this.emit(n,e)}this.node.getWorldPosition(this._curWPos);var i=yn.distance(this._curWPos,this._oldWPos);if(yn.copy(this._oldWPos,this._curWPos),this._emitRateDistanceCounter+=i*this.rateOverDistance.evaluate(this._time/this.duration,1),this._emitRateDistanceCounter>1&&this._isEmitting){var r=Math.floor(this._emitRateDistanceCounter);this._emitRateDistanceCounter-=r,this.emit(r,e)}for(var o,a=S(this.bursts);!(o=a()).done;)o.value.update(this,e)}},i._resetPosition=function(){this.node.getWorldPosition(this._oldWPos),yn.copy(this._curWPos,this._oldWPos)},i.addSubEmitter=function(e){this._subEmitters.push(e)},i.removeSubEmitter=function(e){this._subEmitters.splice(this._subEmitters.indexOf(e),1)},i.addBurst=function(e){this.bursts.push(e)},i.removeBurst=function(e){this.bursts.splice(this.bursts.indexOf(e),1)},i.getBoundingX=function(){return this._aabbHalfX},i.getBoundingY=function(){return this._aabbHalfY},i.getBoundingZ=function(){return this._aabbHalfZ},i.setBoundingX=function(e){this._boundingBox&&this._culler&&(this._boundingBox.halfExtents.x=e,this._culler.setBoundingBoxSize(this._boundingBox.halfExtents),this._aabbHalfX=e)},i.setBoundingY=function(e){this._boundingBox&&this._culler&&(this._boundingBox.halfExtents.y=e,this._culler.setBoundingBoxSize(this._boundingBox.halfExtents),this._aabbHalfY=e)},i.setBoundingZ=function(e){this._boundingBox&&this._culler&&(this._boundingBox.halfExtents.z=e,this._culler.setBoundingBoxSize(this._boundingBox.halfExtents),this._aabbHalfZ=e)},i._onBeforeSerialize=function(e){var t=this;return this.dataCulling?e.filter((function(e){return!Q8.includes(e)||t[e]&&t[e].enable})):e},h(t,[{key:"capacity",get:function(){return this._capacity},set:function(e){this._capacity=Math.floor(e>0?e:0),this.processor&&this.processor._model&&this.processor._model.setCapacity(this._capacity)}},{key:"prewarm",get:function(){return this._prewarm},set:function(e){!0===e&&this.loop,this._prewarm=e}},{key:"simulationSpace",get:function(){return this._simulationSpace},set:function(e){e!==this._simulationSpace&&(this._simulationSpace=e,this.processor&&(this.processor.updateMaterialParams(),this.processor.updateTrailMaterial()))}},{key:"renderCulling",get:function(){return this._renderCulling},set:function(e){this._renderCulling=e,e&&(this._boundingBox||(this._boundingBox=new Us,this._calculateBounding(!1)))}},{key:"cullingMode",get:function(){return this._cullingMode},set:function(e){this._cullingMode=e}},{key:"aabbHalfX",get:function(){return this.getBoundingX()||0},set:function(e){this.setBoundingX(e)}},{key:"aabbHalfY",get:function(){return this.getBoundingY()||0},set:function(e){this.setBoundingY(e)}},{key:"aabbHalfZ",get:function(){return this.getBoundingZ()||0},set:function(e){this.setBoundingZ(e)}},{key:"dataCulling",get:function(){return this._dataCulling},set:function(e){this._dataCulling=e}},{key:"sharedMaterials",get:function(){return cle.get.call(this)},set:function(e){cle.set.call(this,e)}},{key:"colorOverLifetimeModule",get:function(){return this._colorOverLifetimeModule},set:function(e){e&&(this._colorOverLifetimeModule=e)}},{key:"shapeModule",get:function(){return this._shapeModule},set:function(e){e&&(this._shapeModule=e)}},{key:"sizeOvertimeModule",get:function(){return this._sizeOvertimeModule},set:function(e){e&&(this._sizeOvertimeModule=e)}},{key:"velocityOvertimeModule",get:function(){return this._velocityOvertimeModule},set:function(e){e&&(this._velocityOvertimeModule=e)}},{key:"forceOvertimeModule",get:function(){return this._forceOvertimeModule},set:function(e){e&&(this._forceOvertimeModule=e)}},{key:"limitVelocityOvertimeModule",get:function(){return this._limitVelocityOvertimeModule},set:function(e){e&&(this._limitVelocityOvertimeModule=e)}},{key:"rotationOvertimeModule",get:function(){return this._rotationOvertimeModule},set:function(e){e&&(this._rotationOvertimeModule=e)}},{key:"textureAnimationModule",get:function(){return this._textureAnimationModule},set:function(e){e&&(this._textureAnimationModule=e)}},{key:"trailModule",get:function(){return this._trailModule},set:function(e){e&&(this._trailModule=e)}},{key:"isPlaying",get:function(){return this._isPlaying}},{key:"isPaused",get:function(){return this._isPaused}},{key:"isStopped",get:function(){return this._isStopped}},{key:"isEmitting",get:function(){return this._isEmitting}},{key:"time",get:function(){return this._time}}]),t}(jL),Fce.CullingMode=$8,T((Kse=Bce).prototype,"capacity",[voe,goe,yoe],Object.getOwnPropertyDescriptor(Kse.prototype,"capacity"),Kse.prototype),Qse=T(Kse.prototype,"startColor",[xoe,Ec,Soe,Eoe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new a8}}),Jse=T(Kse.prototype,"scaleSpace",[Toe,Ec,Coe,boe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Z8.Local}}),Zse=T(Kse.prototype,"startSize3D",[Ec,Aoe,woe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),$se=T(Kse.prototype,"startSizeX",[Ioe,Poe,Roe,Doe,Ooe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new K5}}),ece=T(Kse.prototype,"startSizeY",[Noe,Ec,Moe,Loe,Foe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new K5}}),tce=T(Kse.prototype,"startSizeZ",[Boe,Ec,zoe,Uoe,koe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new K5}}),nce=T(Kse.prototype,"startSpeed",[Goe,Ec,Hoe,Voe,Woe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new K5}}),ice=T(Kse.prototype,"startRotation3D",[Ec,joe,qoe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),rce=T(Kse.prototype,"startRotationX",[Xoe,Ec,Yoe,Wc,Koe,Qoe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new K5}}),oce=T(Kse.prototype,"startRotationY",[Joe,Ec,Zoe,Wc,$oe,eae],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new K5}}),ace=T(Kse.prototype,"startRotationZ",[tae,nae,iae,Wc,rae,oae],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new K5}}),sce=T(Kse.prototype,"startDelay",[aae,Ec,sae,cae,lae],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new K5}}),cce=T(Kse.prototype,"startLifetime",[uae,Ec,hae,_ae,fae],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new K5}}),lce=T(Kse.prototype,"duration",[Ec,dae,pae],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 5}}),uce=T(Kse.prototype,"loop",[Ec,mae,vae],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),T(Kse.prototype,"prewarm",[gae,yae],Object.getOwnPropertyDescriptor(Kse.prototype,"prewarm"),Kse.prototype),T(Kse.prototype,"simulationSpace",[xae,Ec,Sae,Eae],Object.getOwnPropertyDescriptor(Kse.prototype,"simulationSpace"),Kse.prototype),hce=T(Kse.prototype,"simulationSpeed",[Ec,Tae,Cae],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),_ce=T(Kse.prototype,"playOnAwake",[Ec,bae,Aae],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),fce=T(Kse.prototype,"gravityModifier",[wae,Ec,Iae,Pae,Rae],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new K5}}),dce=T(Kse.prototype,"rateOverTime",[Dae,Ec,Oae,Nae,Mae],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new K5}}),pce=T(Kse.prototype,"rateOverDistance",[Lae,Ec,Fae,Bae,zae],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new K5}}),mce=T(Kse.prototype,"bursts",[Uae,Ec,kae,Gae],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),T(Kse.prototype,"renderCulling",[Hae,Vae,Wae],Object.getOwnPropertyDescriptor(Kse.prototype,"renderCulling"),Kse.prototype),vce=T(Kse.prototype,"_renderCulling",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),T(Kse.prototype,"cullingMode",[jae,qae,Xae],Object.getOwnPropertyDescriptor(Kse.prototype,"cullingMode"),Kse.prototype),gce=T(Kse.prototype,"_cullingMode",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return $8.Pause}}),T(Kse.prototype,"aabbHalfX",[Yae,Kae,Qae],Object.getOwnPropertyDescriptor(Kse.prototype,"aabbHalfX"),Kse.prototype),yce=T(Kse.prototype,"_aabbHalfX",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),T(Kse.prototype,"aabbHalfY",[Jae,Zae,$ae],Object.getOwnPropertyDescriptor(Kse.prototype,"aabbHalfY"),Kse.prototype),xce=T(Kse.prototype,"_aabbHalfY",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),T(Kse.prototype,"aabbHalfZ",[ese,tse,nse],Object.getOwnPropertyDescriptor(Kse.prototype,"aabbHalfZ"),Kse.prototype),Sce=T(Kse.prototype,"_aabbHalfZ",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),T(Kse.prototype,"dataCulling",[ise,rse],Object.getOwnPropertyDescriptor(Kse.prototype,"dataCulling"),Kse.prototype),Ece=T(Kse.prototype,"_dataCulling",[Ec,ose],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),T(Kse.prototype,"sharedMaterials",[$c,ase,sse,Ec,cse],Object.getOwnPropertyDescriptor(Kse.prototype,"sharedMaterials"),Kse.prototype),Tce=T(Kse.prototype,"_colorOverLifetimeModule",[lse],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),T(Kse.prototype,"colorOverLifetimeModule",[use,hse,_se],Object.getOwnPropertyDescriptor(Kse.prototype,"colorOverLifetimeModule"),Kse.prototype),Cce=T(Kse.prototype,"_shapeModule",[fse],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),T(Kse.prototype,"shapeModule",[dse,pse,mse],Object.getOwnPropertyDescriptor(Kse.prototype,"shapeModule"),Kse.prototype),bce=T(Kse.prototype,"_sizeOvertimeModule",[vse],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),T(Kse.prototype,"sizeOvertimeModule",[gse,yse,xse],Object.getOwnPropertyDescriptor(Kse.prototype,"sizeOvertimeModule"),Kse.prototype),Ace=T(Kse.prototype,"_velocityOvertimeModule",[Sse],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),T(Kse.prototype,"velocityOvertimeModule",[Ese,Tse,Cse],Object.getOwnPropertyDescriptor(Kse.prototype,"velocityOvertimeModule"),Kse.prototype),wce=T(Kse.prototype,"_forceOvertimeModule",[bse],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),T(Kse.prototype,"forceOvertimeModule",[Ase,wse,Ise],Object.getOwnPropertyDescriptor(Kse.prototype,"forceOvertimeModule"),Kse.prototype),Ice=T(Kse.prototype,"_limitVelocityOvertimeModule",[Pse],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),T(Kse.prototype,"limitVelocityOvertimeModule",[Rse,Dse,Ose],Object.getOwnPropertyDescriptor(Kse.prototype,"limitVelocityOvertimeModule"),Kse.prototype),Pce=T(Kse.prototype,"_rotationOvertimeModule",[Nse],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),T(Kse.prototype,"rotationOvertimeModule",[Mse,Lse,Fse],Object.getOwnPropertyDescriptor(Kse.prototype,"rotationOvertimeModule"),Kse.prototype),Rce=T(Kse.prototype,"_textureAnimationModule",[Bse],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),T(Kse.prototype,"textureAnimationModule",[zse,Use,kse],Object.getOwnPropertyDescriptor(Kse.prototype,"textureAnimationModule"),Kse.prototype),Dce=T(Kse.prototype,"_trailModule",[Gse],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),T(Kse.prototype,"trailModule",[Hse,Vse,Wse],Object.getOwnPropertyDescriptor(Kse.prototype,"trailModule"),Kse.prototype),Oce=T(Kse.prototype,"renderer",[jse,Ec,qse,Xse],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new jce}}),Nce=T(Kse.prototype,"_prewarm",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Mce=T(Kse.prototype,"_capacity",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 100}}),Lce=T(Kse.prototype,"_simulationSpace",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Z8.Local}}),Yse=Kse))||Yse)||Yse)||Yse)||Yse)||Yse)),ule=e("ParticleUtils",function(){function e(){}return e.instantiate=function(e){return this.registeredSceneEvent||(KO.on(YO.EVENT_BEFORE_SCENE_LAUNCH,this.onSceneUnload,this),this.registeredSceneEvent=!0),this.particleSystemPool.has(e._uuid)||this.particleSystemPool.set(e._uuid,new Ml((function(){return kh(e)||new jb}),1,(function(e){return e.destroy()}))),this.particleSystemPool.get(e._uuid).alloc()},e.destroy=function(e){this.particleSystemPool.has(e._prefab.asset._uuid)&&(this.stop(e),this.particleSystemPool.get(e._prefab.asset._uuid).free(e))},e.play=function(e){for(var t,n=S(e.getComponentsInChildren(lle));!(t=n()).done;)t.value.play()},e.stop=function(e){for(var t,n=S(e.getComponentsInChildren(lle));!(t=n()).done;)t.value.stop()},e.onSceneUnload=function(){this.particleSystemPool.forEach((function(e){return e.destroy()})),this.particleSystemPool.clear()},e}());function hle(e){b._global.CC_PHYSICS_BUILTIN="builtin"===e,b._global.CC_PHYSICS_CANNON="cannon.js"===e,b._global.CC_PHYSICS_AMMO="ammo.js"===e}ule.particleSystemPool=new Map,ule.registeredSceneEvent=!1,b.ParticleUtils=ule,function(e){e[e.DYNAMIC=1]="DYNAMIC",e[e.STATIC=2]="STATIC",e[e.KINEMATIC=4]="KINEMATIC"}(zce||(zce=e("ERigidBodyType",{}))),Je(zce),function(e){e[e.X_AXIS=0]="X_AXIS",e[e.Y_AXIS=1]="Y_AXIS",e[e.Z_AXIS=2]="Z_AXIS"}(Uce||(Uce=e("EAxisDirection",{}))),Je(Uce),function(e){e[e.VERTEX=1]="VERTEX",e[e.LINE=2]="LINE",e[e.TRIANGLE=3]="TRIANGLE",e[e.TETRAHEDRON=4]="TETRAHEDRON"}(kce||(kce={})),Je(kce),function(e){e[e.BOX=0]="BOX",e[e.SPHERE=1]="SPHERE",e[e.CAPSULE=2]="CAPSULE",e[e.CYLINDER=3]="CYLINDER",e[e.CONE=4]="CONE",e[e.MESH=5]="MESH",e[e.PLANE=6]="PLANE",e[e.SIMPLEX=7]="SIMPLEX",e[e.TERRAIN=8]="TERRAIN"}(Gce||(Gce={})),Je(Gce),function(e){e[e.POINT_TO_POINT=0]="POINT_TO_POINT",e[e.HINGE=1]="HINGE",e[e.CONE_TWIST=2]="CONE_TWIST"}(Hce||(Hce={})),Je(Hce),function(e){e[e.DEFAULT=1]="DEFAULT"}(Vce||(Vce={})),Je(Vce);var _le,fle={id:"",switchTo:function(e){if(fle.runInEditor){var t=fle;if(fle.physicsWorld&&e!==fle.id&&null!=fle.backend[e]?(fle.physicsWorld.destroy(),console.info("[PHYSICS]: switch from "+fle.id+" to "+e+"."),hle(e),t.id=e,t.wrapper=fle.backend[e],t.physicsWorld=vle()):(console.info("[PHYSICS]: using "+e+"."),t.physicsWorld=vle()),Wce){var n=t.physicsWorld;n.setGravity(Wce.gravity),n.setAllowSleep(Wce.allowSleep),n.setDefaultMaterial(Wce.defaultMaterial)}}},register:function(e,t){if(console.info("[PHYSICS]: register "+e+"."),fle.backend[e]=t,!fle.physicsWorld||fle.id===e){hle(e);var n=fle;n.id=e,n.wrapper=t}},wrapper:{},backend:{},physicsWorld:null,runInEditor:!0},dle=function(){return 0},ple={impl:null,setGravity:dle,setAllowSleep:dle,setDefaultMaterial:dle,step:dle,syncAfterEvents:dle,syncSceneToPhysics:dle,raycast:dle,raycastClosest:dle,emitEvents:dle,destroy:dle};function mle(e,t){return null==e&&(fle.id?F(fle.id+" physics does not support "+_le[t]):Y(9600),!0)}function vle(){return mle(fle.wrapper.PhysicsWorld,_le.World)?ple:new fle.wrapper.PhysicsWorld}!function(e){e[e.World=0]="World",e[e.RigidBody=1]="RigidBody",e[e.BoxCollider=2]="BoxCollider",e[e.SphereCollider=3]="SphereCollider",e[e.CapsuleCollider=4]="CapsuleCollider",e[e.MeshCollider=5]="MeshCollider",e[e.CylinderCollider=6]="CylinderCollider",e[e.ConeCollider=7]="ConeCollider",e[e.TerrainCollider=8]="TerrainCollider",e[e.SimplexCollider=9]="SimplexCollider",e[e.PlaneCollider=10]="PlaneCollider",e[e.PointToPointConstraint=11]="PointToPointConstraint",e[e.HingeConstraint=12]="HingeConstraint",e[e.ConeTwistConstraint=13]="ConeTwistConstraint"}(_le||(_le={}));var gle={impl:null,rigidBody:null,isAwake:!1,isSleepy:!1,isSleeping:!1,initialize:dle,onEnable:dle,onDisable:dle,onDestroy:dle,setType:dle,setMass:dle,setLinearDamping:dle,setAngularDamping:dle,useGravity:dle,setLinearFactor:dle,setAngularFactor:dle,setAllowSleep:dle,wakeUp:dle,sleep:dle,clearState:dle,clearForces:dle,clearVelocity:dle,setSleepThreshold:dle,getSleepThreshold:dle,getLinearVelocity:dle,setLinearVelocity:dle,getAngularVelocity:dle,setAngularVelocity:dle,applyForce:dle,applyLocalForce:dle,applyImpulse:dle,applyLocalImpulse:dle,applyTorque:dle,applyLocalTorque:dle,setGroup:dle,getGroup:dle,addGroup:dle,removeGroup:dle,setMask:dle,getMask:dle,addMask:dle,removeMask:dle,isUsingCCD:dle,useCCD:dle},yle={INITED:!1},xle={impl:null,collider:null,attachedRigidBody:null,initialize:dle,onLoad:dle,onEnable:dle,onDisable:dle,onDestroy:dle,setGroup:dle,getGroup:dle,addGroup:dle,removeGroup:dle,setMask:dle,getMask:dle,addMask:dle,removeMask:dle,setMaterial:dle,setAsTrigger:dle,setCenter:dle,getAABB:dle,getBoundingSphere:dle,updateSize:dle,updateRadius:dle,setRadius:dle,setCylinderHeight:dle,setDirection:dle,setHeight:dle,setShapeType:dle,setVertices:dle,setMesh:dle,setTerrain:dle,setNormal:dle,setConstant:dle,updateEventListener:dle};var Sle,Ele,Tle,Cle,ble,Ale,wle,Ile,Ple={INITED:!1},Rle={impl:null,initialize:dle,onLoad:dle,onEnable:dle,onDisable:dle,onDestroy:dle,setEnableCollision:dle,setConnectedBody:dle,setPivotA:dle,setPivotB:dle,setAxis:dle};var Dle=e("PhysicsMaterial",dc("cc.PhysicsMaterial")((Ile=wle=function(e){function t(){var n;return(n=e.call(this)||this).id=void 0,E(n,"_friction",Tle,y(n)),E(n,"_rollingFriction",Cle,y(n)),E(n,"_spinningFriction",ble,y(n)),E(n,"_restitution",Ale,y(n)),t.allMaterials.push(y(n)),n.id=t._idCounter++,n._uuid||(n._uuid="pm_"+n.id),n}f(t,e);var n=t.prototype;return n.clone=function(){var e=new t;return e._friction=this._friction,e._restitution=this._restitution,e._rollingFriction=this._rollingFriction,e._spinningFriction=this._spinningFriction,e},n.destroy=function(){if(e.prototype.destroy.call(this)){var n=t.allMaterials.indexOf(this);return n>=0&&t.allMaterials.splice(n,1),!0}return!1},n.setValues=function(e,n,i,r){var o=this._friction!==e||this._rollingFriction!==n||this._spinningFriction!==i||this._restitution!==r;this._friction=e,this._rollingFriction=n,this._spinningFriction=i,this._restitution=r,o&&this.emit(t.EVENT_UPDATE)},h(t,[{key:"friction",get:function(){return this._friction},set:function(e){Zt(this._friction,e)||(this._friction=e,this.emit(t.EVENT_UPDATE))}},{key:"rollingFriction",get:function(){return this._rollingFriction},set:function(e){Zt(this._rollingFriction,e)||(this._rollingFriction=e,this.emit(t.EVENT_UPDATE))}},{key:"spinningFriction",get:function(){return this._spinningFriction},set:function(e){Zt(this._spinningFriction,e)||(this._spinningFriction=e,this.emit(t.EVENT_UPDATE))}},{key:"restitution",get:function(){return this._restitution},set:function(e){Zt(this._restitution,e)||(this._restitution=e,this.emit(t.EVENT_UPDATE))}}]),t}(yu),wle.allMaterials=[],wle.EVENT_UPDATE="event_update",wle._idCounter=0,T((Ele=Ile).prototype,"friction",[Nc],Object.getOwnPropertyDescriptor(Ele.prototype,"friction"),Ele.prototype),T(Ele.prototype,"rollingFriction",[Nc],Object.getOwnPropertyDescriptor(Ele.prototype,"rollingFriction"),Ele.prototype),T(Ele.prototype,"spinningFriction",[Nc],Object.getOwnPropertyDescriptor(Ele.prototype,"spinningFriction"),Ele.prototype),T(Ele.prototype,"restitution",[Nc],Object.getOwnPropertyDescriptor(Ele.prototype,"restitution"),Ele.prototype),Tle=T(Ele.prototype,"_friction",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.6}}),Cle=T(Ele.prototype,"_rollingFriction",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),ble=T(Ele.prototype,"_spinningFriction",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Ale=T(Ele.prototype,"_restitution",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Sle=Ele))||Sle),Ole=e("PhysicsRayResult",function(){function e(){this._hitPoint=new yn,this._hitNormal=new yn,this._distance=0,this._collider=null}var t=e.prototype;return t._assign=function(e,t,n,i){yn.copy(this._hitPoint,e),yn.copy(this._hitNormal,i),this._distance=t,this._collider=n},t.clone=function(){var t=new e;return yn.copy(t._hitPoint,this._hitPoint),yn.copy(t._hitNormal,this._hitNormal),t._distance=this._distance,t._collider=this._collider,t},h(e,[{key:"hitPoint",get:function(){return this._hitPoint}},{key:"distance",get:function(){return this._distance}},{key:"collider",get:function(){return this._collider}},{key:"hitNormal",get:function(){return this._hitNormal}}]),e}()),Nle=function(e){if(1===e){for(var t=this,n=function(e){var n="_"+(1<<e);t[n]=0,t.updateArray=[],Object.defineProperty(t,1<<e,{get:function(){return this[n]},set:function(t){this[n]!==t&&(this[n]=t,this.updateArray.indexOf(e)<0&&this.updateArray.push(e))}})},i=0;i<32;i++)n(i);this._1=Vce.DEFAULT}else{for(var r=0;r<32;r++)this[""+(1<<r)]=0;this[1]=Vce.DEFAULT}};b.internal.PhysicsGroup=Vce;var Mle,Lle,Fle,Ble,zle,Ule,kle,Gle,Hle,Vle,Wle,jle,qle,Xle,Yle,Kle,Qle,Jle,Zle,$le,eue,tue,nue,iue,rue,oue,aue,sue,cue,lue,uue,hue,_ue,fue,due,pue,mue,vue,gue,yue,xue,Sue,Eue,Tue,Cue=e("PhysicsSystem",function(e){function t(){var t;return(t=e.call(this)||this).raycastClosestResult=new Ole,t.raycastResults=[],t.collisionMatrix=new Nle(1),t.minVolumeSize=1e-5,t.useNodeChains=!1,t._enable=!0,t._allowSleep=!0,t._maxSubSteps=1,t._subStepCount=0,t._fixedTimeStep=1/60,t._autoSimulation=!0,t._accumulator=0,t._sleepThreshold=.1,t._gravity=new yn(0,-10,0),t._material=new Dle,t.raycastOptions={group:-1,mask:-1,queryTrigger:!0,maxDistance:1e7},t.raycastResultPool=new Ll((function(){return new Ole}),1),t._material.on(Dle.EVENT_UPDATE,t._updateMaterial,y(t)),t}f(t,e);var n=t.prototype;return n.postUpdate=function(e){if(this.physicsWorld)if(this._enable){if(this._autoSimulation){for(this._subStepCount=0,this._accumulator+=e,KO.emit(YO.EVENT_BEFORE_PHYSICS);this._subStepCount<this._maxSubSteps;){if(!(this._accumulator>=this._fixedTimeStep)){this.physicsWorld.syncSceneToPhysics();break}this.physicsWorld.syncSceneToPhysics(),this.physicsWorld.step(this._fixedTimeStep),this.physicsWorld.emitEvents(),this.physicsWorld.syncAfterEvents(),this._accumulator-=this._fixedTimeStep,this._subStepCount++}KO.emit(YO.EVENT_AFTER_PHYSICS)}}else this.physicsWorld.syncSceneToPhysics()},n.resetConfiguration=function(e){var t=e||(PO.config?PO.config.physics:null);if(t){if("boolean"==typeof t.allowSleep&&(this._allowSleep=t.allowSleep),"number"==typeof t.fixedTimeStep&&(this._fixedTimeStep=t.fixedTimeStep),"number"==typeof t.maxSubSteps&&(this._maxSubSteps=t.maxSubSteps),"number"==typeof t.sleepThreshold&&(this._sleepThreshold=t.sleepThreshold),"boolean"==typeof t.autoSimulation&&(this.autoSimulation=t.autoSimulation),t.gravity&&yn.copy(this._gravity,t.gravity),t.defaultMaterial&&this._material.setValues(t.defaultMaterial.friction,t.defaultMaterial.rollingFriction,t.defaultMaterial.spinningFriction,t.defaultMaterial.restitution),t.collisionMatrix)for(var n in t.collisionMatrix)this.collisionMatrix[""+(1<<parseInt(n))]=t.collisionMatrix[n];if(t.collisionGroups){var i=t.collisionGroups;i instanceof Array&&(i.forEach((function(e){Vce[e.name]=1<<e.index})),Je.update(Vce))}}this.physicsWorld&&(this.physicsWorld.setGravity(this._gravity),this.physicsWorld.setAllowSleep(this._allowSleep),this.physicsWorld.setDefaultMaterial(this._material))},n.resetAccumulator=function(e){void 0===e&&(e=0),this._accumulator=e},n.step=function(e,t,n){this.physicsWorld&&this.physicsWorld.step(e,t,n)},n.syncSceneToPhysics=function(){this.physicsWorld&&this.physicsWorld.syncSceneToPhysics()},n.emitEvents=function(){this.physicsWorld&&this.physicsWorld.emitEvents()},n.raycast=function(e,t,n,i){return void 0===t&&(t=4294967295),void 0===n&&(n=1e7),void 0===i&&(i=!0),!!this.physicsWorld&&(this.raycastResultPool.reset(),this.raycastResults.length=0,this.raycastOptions.mask=t>>>0,this.raycastOptions.maxDistance=n,this.raycastOptions.queryTrigger=i,this.physicsWorld.raycast(e,this.raycastOptions,this.raycastResultPool,this.raycastResults))},n.raycastClosest=function(e,t,n,i){return void 0===t&&(t=4294967295),void 0===n&&(n=1e7),void 0===i&&(i=!0),!!this.physicsWorld&&(this.raycastOptions.mask=t>>>0,this.raycastOptions.maxDistance=n,this.raycastOptions.queryTrigger=i,this.physicsWorld.raycastClosest(e,this.raycastOptions,this.raycastClosestResult))},n._updateMaterial=function(){this.physicsWorld&&this.physicsWorld.setDefaultMaterial(this._material)},t.constructAndRegister=function(){if(!t._instance){var e=new t;e.resetConfiguration(),function(e){if(Wce||(Wce=e),fle.runInEditor&&!fle.physicsWorld){console.info("[PHYSICS]: using "+fle.id+".");var t=fle.physicsWorld=vle();t.setGravity(Wce.gravity),t.setAllowSleep(Wce.allowSleep),t.setDefaultMaterial(Wce.defaultMaterial)}}(e),t._instance=e,KO.registerSystem(t.ID,e,e.priority)}},h(t,[{key:"enable",get:function(){return this._enable},set:function(e){this._enable=e}},{key:"allowSleep",get:function(){return this._allowSleep},set:function(e){this._allowSleep=e,this.physicsWorld&&this.physicsWorld.setAllowSleep(e)}},{key:"maxSubSteps",get:function(){return this._maxSubSteps},set:function(e){this._maxSubSteps=e}},{key:"fixedTimeStep",get:function(){return this._fixedTimeStep},set:function(e){this._fixedTimeStep=e}},{key:"gravity",get:function(){return this._gravity},set:function(e){this._gravity.set(e),this.physicsWorld&&this.physicsWorld.setGravity(e)}},{key:"sleepThreshold",get:function(){return this._sleepThreshold},set:function(e){this._sleepThreshold=e}},{key:"autoSimulation",get:function(){return this._autoSimulation},set:function(e){this._autoSimulation=e}},{key:"defaultMaterial",get:function(){return this._material}},{key:"physicsWorld",get:function(){return fle.physicsWorld}}],[{key:"PHYSICS_NONE",get:function(){return!fle.id}},{key:"PHYSICS_BUILTIN",get:function(){return"builtin"===fle.id}},{key:"PHYSICS_CANNON",get:function(){return"cannon.js"===fle.id}},{key:"PHYSICS_BULLET",get:function(){return"bullet"===fle.id}},{key:"PHYSICS_PHYSX",get:function(){return"physx"===fle.id}},{key:"PhysicsGroup",get:function(){return Vce}},{key:"instance",get:function(){return t._instance}}]),t}(GO));Cue.ID="PHYSICS",Cue._instance=null,KO.once(YO.EVENT_INIT,(function(){Cue.constructAndRegister()}));var bue,Aue,wue,Iue,Pue,Rue,Due,Oue,Nue,Mue,Lue,Fue,Bue,zue,Uue,kue,Gue,Hue,Vue,Wue,jue,que,Xue=e("RigidBody",(Mle=dc("cc.RigidBody"),Lle=Oc(),Fle=Ic(),Ble=mc(-1),zle=Jc(Cue.PhysicsGroup),Ule=Vc(),kle=Bc(),Gle=Jc(zce),Hle=Vc(),Vle=Bc(),Wle=Mc(),jle=Vc(),qle=Bc(),Xle=Mc(),Yle=Vc(),Kle=Bc(),Qle=Mc(),Jle=Vc(),Zle=Bc(),$le=Mc(),eue=Vc(),tue=Bc(),nue=Mc(),iue=Vc(),rue=Bc(),oue=Mc(),aue=Vc(),sue=Bc(),cue=Mc(),lue=Vc(),uue=Bc(),Mle(hue=Lle(hue=Fle(hue=wc(hue=vc(hue=Ble((Tue=Eue=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._body=null,E(t,"_group",fue,y(t)),E(t,"_type",due,y(t)),E(t,"_mass",pue,y(t)),E(t,"_allowSleep",mue,y(t)),E(t,"_linearDamping",vue,y(t)),E(t,"_angularDamping",gue,y(t)),E(t,"_useGravity",yue,y(t)),E(t,"_linearFactor",xue,y(t)),E(t,"_angularFactor",Sue,y(t)),t}f(t,e);var n=t.prototype;return n.onLoad=function(){fle.runInEditor&&(this._body=mle(fle.wrapper.RigidBody,_le.RigidBody)?gle:new fle.wrapper.RigidBody,this._body.initialize(this))},n.onEnable=function(){this._body&&this._body.onEnable()},n.onDisable=function(){this._body&&this._body.onDisable()},n.onDestroy=function(){this._body&&this._body.onDestroy()},n.applyForce=function(e,t){this._isInitialized&&this._body.applyForce(e,t)},n.applyLocalForce=function(e,t){this._isInitialized&&this._body.applyLocalForce(e,t)},n.applyImpulse=function(e,t){this._isInitialized&&this._body.applyImpulse(e,t)},n.applyLocalImpulse=function(e,t){this._isInitialized&&this._body.applyLocalImpulse(e,t)},n.applyTorque=function(e){this._isInitialized&&this._body.applyTorque(e)},n.applyLocalTorque=function(e){this._isInitialized&&this._body.applyLocalTorque(e)},n.wakeUp=function(){this._isInitialized&&this._body.wakeUp()},n.sleep=function(){this._isInitialized&&this._body.sleep()},n.clearState=function(){this._isInitialized&&this._body.clearState()},n.clearForces=function(){this._isInitialized&&this._body.clearForces()},n.clearVelocity=function(){this._isInitialized&&this._body.clearVelocity()},n.getLinearVelocity=function(e){this._isInitialized&&this._body.getLinearVelocity(e)},n.setLinearVelocity=function(e){this._isInitialized&&this._body.setLinearVelocity(e)},n.getAngularVelocity=function(e){this._isInitialized&&this._body.getAngularVelocity(e)},n.setAngularVelocity=function(e){this._isInitialized&&this._body.setAngularVelocity(e)},n.getGroup=function(){return this._isInitialized?this._body.getGroup():0},n.setGroup=function(e){this._isInitialized&&this._body.setGroup(e)},n.addGroup=function(e){this._isInitialized&&this._body.addGroup(e)},n.removeGroup=function(e){this._isInitialized&&this._body.removeGroup(e)},n.getMask=function(){return this._isInitialized?this._body.getMask():0},n.setMask=function(e){this._isInitialized&&this._body.setMask(e)},n.addMask=function(e){this._isInitialized&&this._body.addMask(e)},n.removeMask=function(e){this._isInitialized&&this._body.removeMask(e)},h(t,[{key:"group",get:function(){return this._group},set:function(e){this._group=e,this._body&&this._body.getGroup()!==e&&this._body.setGroup(e)}},{key:"type",get:function(){return this._type},set:function(e){this._type!==e&&(this._type=e,this._body&&this._body.setType(e))}},{key:"mass",get:function(){return this._mass},set:function(e){this._mass!==e&&(e=e<=0?1e-4:e,this._mass=e,this._body&&this._body.setMass(e))}},{key:"allowSleep",get:function(){return this._allowSleep},set:function(e){this._allowSleep=e,this._body&&this._body.setAllowSleep(e)}},{key:"linearDamping",get:function(){return this._linearDamping},set:function(e){this._linearDamping=e,this._body&&this._body.setLinearDamping(e)}},{key:"angularDamping",get:function(){return this._angularDamping},set:function(e){this._angularDamping=e,this._body&&this._body.setAngularDamping(e)}},{key:"useGravity",get:function(){return this._useGravity},set:function(e){this._useGravity=e,this._body&&this._body.useGravity(e)}},{key:"linearFactor",get:function(){return this._linearFactor},set:function(e){yn.copy(this._linearFactor,e),this._body&&this._body.setLinearFactor(this._linearFactor)}},{key:"angularFactor",get:function(){return this._angularFactor},set:function(e){yn.copy(this._angularFactor,e),this._body&&this._body.setAngularFactor(this._angularFactor)}},{key:"sleepThreshold",get:function(){return this._isInitialized?this._body.getSleepThreshold():.1},set:function(e){this._isInitialized&&this._body.setSleepThreshold(e)}},{key:"useCCD",get:function(){return!!this._isInitialized&&this._body.isUsingCCD()},set:function(e){this._isInitialized&&this._body.useCCD(e)}},{key:"isAwake",get:function(){return!!this._isInitialized&&this._body.isAwake}},{key:"isSleepy",get:function(){return!!this._isInitialized&&this._body.isSleepy}},{key:"isSleeping",get:function(){return!!this._isInitialized&&this._body.isSleeping}},{key:"isStatic",get:function(){return this._type===zce.STATIC},set:function(e){e&&this.isStatic||!e&&!this.isStatic||(this.type=e?zce.STATIC:zce.DYNAMIC)}},{key:"isDynamic",get:function(){return this._type===zce.DYNAMIC},set:function(e){e&&this.isDynamic||!e&&!this.isDynamic||(this.type=e?zce.DYNAMIC:zce.KINEMATIC)}},{key:"isKinematic",get:function(){return this._type===zce.KINEMATIC},set:function(e){e&&this.isKinematic||!e&&!this.isKinematic||(this.type=e?zce.KINEMATIC:zce.DYNAMIC)}},{key:"body",get:function(){return this._body}},{key:"_isInitialized",get:function(){var e=null===this._body;return e&&B("[Physics]: This component has not been call onLoad yet, please make sure the node has been added to the scene."),!e}}]),t}(ku),Eue.Type=zce,T((_ue=Tue).prototype,"group",[zle,Ule,kle],Object.getOwnPropertyDescriptor(_ue.prototype,"group"),_ue.prototype),T(_ue.prototype,"type",[Gle,Hle,Vle],Object.getOwnPropertyDescriptor(_ue.prototype,"type"),_ue.prototype),T(_ue.prototype,"mass",[Wle,jle,qle],Object.getOwnPropertyDescriptor(_ue.prototype,"mass"),_ue.prototype),T(_ue.prototype,"allowSleep",[Xle,Yle,Kle],Object.getOwnPropertyDescriptor(_ue.prototype,"allowSleep"),_ue.prototype),T(_ue.prototype,"linearDamping",[Qle,Jle,Zle],Object.getOwnPropertyDescriptor(_ue.prototype,"linearDamping"),_ue.prototype),T(_ue.prototype,"angularDamping",[$le,eue,tue],Object.getOwnPropertyDescriptor(_ue.prototype,"angularDamping"),_ue.prototype),T(_ue.prototype,"useGravity",[nue,iue,rue],Object.getOwnPropertyDescriptor(_ue.prototype,"useGravity"),_ue.prototype),T(_ue.prototype,"linearFactor",[oue,aue,sue],Object.getOwnPropertyDescriptor(_ue.prototype,"linearFactor"),_ue.prototype),T(_ue.prototype,"angularFactor",[cue,lue,uue],Object.getOwnPropertyDescriptor(_ue.prototype,"angularFactor"),_ue.prototype),fue=T(_ue.prototype,"_group",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Cue.PhysicsGroup.DEFAULT}}),due=T(_ue.prototype,"_type",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return zce.DYNAMIC}}),pue=T(_ue.prototype,"_mass",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),mue=T(_ue.prototype,"_allowSleep",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),vue=T(_ue.prototype,"_linearDamping",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),gue=T(_ue.prototype,"_angularDamping",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),yue=T(_ue.prototype,"_useGravity",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),xue=T(_ue.prototype,"_linearFactor",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new yn(1,1,1)}}),Sue=T(_ue.prototype,"_angularFactor",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new yn(1,1,1)}}),hue=_ue))||hue)||hue)||hue)||hue)||hue)||hue));Xue||(Xue=e("RigidBody",{}));var Yue=e("Collider",(bue=dc("cc.Collider"),Aue=Jc(Xue),wue=Fc(),Iue=Vc(),Pue=Bc(),Rue=Jc(Dle),Due=Fc(),Oue=Vc(),Nue=Bc(),Mue=Vc(),Lue=Bc(),Fue=Jc(yn),Bue=Vc(),zue=Bc(),Uue=Jc(Dle),bue((que=jue=function(e){function t(t){var n;return(n=e.call(this)||this).type=void 0,n._shape=null,n._aabb=null,n._boundingSphere=null,n._isSharedMaterial=!0,n._needTriggerEvent=!1,n._needCollisionEvent=!1,E(n,"_material",Hue,y(n)),E(n,"_isTrigger",Vue,y(n)),E(n,"_center",Wue,y(n)),n.type=t,n}f(t,e);var n=t.prototype;return n.on=function(t,n,i,r){var o=e.prototype.on.call(this,t,n,i,r);return this._updateNeedEvent(t),o},n.off=function(t,n,i){e.prototype.off.call(this,t,n,i),this._updateNeedEvent()},n.once=function(t,n,i){var r=e.prototype.once.call(this,t,n,i);return this._updateNeedEvent(t),r},n.removeAll=function(t){e.prototype.removeAll.call(this,t),this._updateNeedEvent()},n.getGroup=function(){return this._isInitialized?this._shape.getGroup():0},n.setGroup=function(e){this._isInitialized&&this._shape.setGroup(e)},n.addGroup=function(e){this._isInitialized&&this._shape.addGroup(e)},n.removeGroup=function(e){this._isInitialized&&this._shape.removeGroup(e)},n.getMask=function(){return this._isInitialized?this._shape.getMask():0},n.setMask=function(e){this._isInitialized&&this._shape.setMask(e)},n.addMask=function(e){this._isInitialized&&this._shape.addMask(e)},n.removeMask=function(e){this._isInitialized&&this._shape.removeMask(e)},n.onLoad=function(){fle.runInEditor&&(this.sharedMaterial=null==this._material?Cue.instance.defaultMaterial:this._material,this._shape=function(e){return yle.INITED||(yle.INITED=!0,yle[Gce.BOX]=function(){return mle(fle.wrapper.BoxShape,_le.BoxCollider)?xle:new fle.wrapper.BoxShape},yle[Gce.SPHERE]=function(){return mle(fle.wrapper.SphereShape,_le.SphereCollider)?xle:new fle.wrapper.SphereShape},yle[Gce.CAPSULE]=function(){return mle(fle.wrapper.CapsuleShape,_le.CapsuleCollider)?xle:new fle.wrapper.CapsuleShape},yle[Gce.CYLINDER]=function(){return mle(fle.wrapper.CylinderShape,_le.CylinderCollider)?xle:new fle.wrapper.CylinderShape},yle[Gce.CONE]=function(){return mle(fle.wrapper.ConeShape,_le.ConeCollider)?xle:new fle.wrapper.ConeShape},yle[Gce.MESH]=function(){return mle(fle.wrapper.TrimeshShape,_le.MeshCollider)?xle:new fle.wrapper.TrimeshShape},yle[Gce.TERRAIN]=function(){return mle(fle.wrapper.TerrainShape,_le.TerrainCollider)?xle:new fle.wrapper.TerrainShape},yle[Gce.SIMPLEX]=function(){return mle(fle.wrapper.SimplexShape,_le.SimplexCollider)?xle:new fle.wrapper.SimplexShape},yle[Gce.PLANE]=function(){return mle(fle.wrapper.PlaneShape,_le.PlaneCollider)?xle:new fle.wrapper.PlaneShape}),yle[e]()}(this.type),this._shape.initialize(this),this._shape.onLoad())},n.onEnable=function(){this._shape&&this._shape.onEnable()},n.onDisable=function(){this._shape&&this._shape.onDisable()},n.onDestroy=function(){this._shape&&(this._needTriggerEvent=!1,this._needCollisionEvent=!1,this._shape.updateEventListener(),this._material&&this._material.off(Dle.EVENT_UPDATE,this._updateMaterial,this),this._shape.onDestroy()),this._boundingSphere&&this._boundingSphere.destroy()},n._updateMaterial=function(){this._shape&&this._shape.setMaterial(this._material)},n._updateNeedEvent=function(e){this.isValid&&(void 0!==e?("onCollisionEnter"!==e&&"onCollisionStay"!==e&&"onCollisionExit"!==e||(this._needCollisionEvent=!0),"onTriggerEnter"!==e&&"onTriggerStay"!==e&&"onTriggerExit"!==e||(this._needTriggerEvent=!0)):(this.hasEventListener("onTriggerEnter")||this.hasEventListener("onTriggerStay")||this.hasEventListener("onTriggerExit")||(this._needTriggerEvent=!1),this.hasEventListener("onCollisionEnter")||this.hasEventListener("onCollisionStay")||this.hasEventListener("onCollisionExit")||(this._needCollisionEvent=!1)),this._shape&&this._shape.updateEventListener())},h(t,[{key:"attachedRigidBody",get:function(){return e=this.node,(t=e.getComponent(Xue))&&t.isValid?t:null;var e,t}},{key:"sharedMaterial",get:function(){return this._material},set:function(e){this.material=e}},{key:"material",get:function(){return this._isSharedMaterial&&this._material&&(this._material.off(Dle.EVENT_UPDATE,this._updateMaterial,this),this._material=this._material.clone(),this._material.on(Dle.EVENT_UPDATE,this._updateMaterial,this),this._isSharedMaterial=!1),this._material},set:function(e){this._shape?(e&&this._material?this._material.id!==e.id&&(this._material.off(Dle.EVENT_UPDATE,this._updateMaterial,this),e.on(Dle.EVENT_UPDATE,this._updateMaterial,this),this._isSharedMaterial=!1,this._material=e):e&&!this._material?(e.on(Dle.EVENT_UPDATE,this._updateMaterial,this),this._material=e):!e&&this._material&&(this._material.off(Dle.EVENT_UPDATE,this._updateMaterial,this),this._material=e),this._updateMaterial()):this._material=e}},{key:"isTrigger",get:function(){return this._isTrigger},set:function(e){this._isTrigger=e,this._shape&&this._shape.setAsTrigger(this._isTrigger)}},{key:"center",get:function(){return this._center},set:function(e){yn.copy(this._center,e),this._shape&&this._shape.setCenter(this._center)}},{key:"shape",get:function(){return this._shape}},{key:"worldBounds",get:function(){return null==this._aabb&&(this._aabb=new Us),this._shape&&this._shape.getAABB(this._aabb),this._aabb}},{key:"boundingSphere",get:function(){return null==this._boundingSphere&&(this._boundingSphere=new ea),this._shape&&this._shape.getBoundingSphere(this._boundingSphere),this._boundingSphere}},{key:"needTriggerEvent",get:function(){return this._needTriggerEvent}},{key:"needCollisionEvent",get:function(){return this._needCollisionEvent}},{key:"_isInitialized",get:function(){var e=null===this._shape;return e&&B("[Physics]: This component has not been call onLoad yet, please make sure the node has been added to the scene."),!e}}]),t}(Wl(ku)),jue.Type=Gce,jue.Axis=Uce,T((Gue=que).prototype,"attachedRigidBody",[Aue,Lc,wue,Iue,Pue],Object.getOwnPropertyDescriptor(Gue.prototype,"attachedRigidBody"),Gue.prototype),T(Gue.prototype,"sharedMaterial",[Rue,Due,Oue,Nue],Object.getOwnPropertyDescriptor(Gue.prototype,"sharedMaterial"),Gue.prototype),T(Gue.prototype,"isTrigger",[Mue,Lue],Object.getOwnPropertyDescriptor(Gue.prototype,"isTrigger"),Gue.prototype),T(Gue.prototype,"center",[Fue,Bue,zue],Object.getOwnPropertyDescriptor(Gue.prototype,"center"),Gue.prototype),Hue=T(Gue.prototype,"_material",[Uue],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Vue=T(Gue.prototype,"_isTrigger",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Wue=T(Gue.prototype,"_center",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new yn}}),kue=Gue))||kue));function Kue(e){return void 0===(e=e||{}).includeNormal&&(e.includeNormal=!0),void 0===e.includeUV&&(e.includeUV=!0),e}Yue||(Yue=e("Collider",{}));var Que=new yn,Jue=new yn,Zue=new yn,$ue=new yn,ehe=new yn,the=new yn,nhe=new yn,ihe=new yn,rhe=new yn,ohe=new yn,ahe=new yn,she=new yn,che=new yn(0,0,0),lhe=new yn(0,0,0);function uhe(e,t,n,i){void 0===e&&(e=.5),void 0===t&&(t=.5),void 0===n&&(n=2),void 0===i&&(i={});var r=.5*n,o=i.radialSegments||32,a=i.heightSegments||1,s=void 0===i.capped||i.capped,c=i.arc||2*Math.PI,l=0;s||(e>0&&l++,t>0&&l++);var u=(o+1)*(a+1);s&&(u+=(o+1)*l+o*l);var h=o*a*6;s&&(h+=o*l*3);var _=new Array(h),f=new Array(3*u),d=new Array(3*u),p=new Array(2*u),m=Math.max(e,t),v=new yn(-m,-r,-m),g=new yn(m,r,m),y=Math.sqrt(m*m+r*r),x=0,S=0;return function(){for(var i=[],s=e-t,l=s*s/n*Math.sign(s),u=0;u<=a;u++){for(var h=[],m=u/a,v=m*s+t,g=0;g<=o;++g){var y=g/o,E=y*c,T=Math.sin(E),C=Math.cos(E);f[3*x]=v*T,f[3*x+1]=m*n-r,f[3*x+2]=v*C,yn.normalize(che,yn.set(lhe,T,-l,C)),d[3*x]=che.x,d[3*x+1]=che.y,d[3*x+2]=che.z,p[2*x]=2*(1-y)%1,p[2*x+1]=m,h.push(x),++x}i.push(h)}for(var b=0;b<a;++b)for(var A=0;A<o;++A){var w=i[b][A],I=i[b+1][A],P=i[b+1][A+1],R=i[b][A+1];_[S]=w,++S,_[S]=R,++S,_[S]=I,++S,_[S]=R,++S,_[S]=P,++S,_[S]=I,++S}}(),s&&(t>0&&E(!1),e>0&&E(!0)),{positions:f,normals:d,uvs:p,indices:_,minPos:v,maxPos:g,boundingRadius:y};function E(n){for(var i=n?e:t,a=n?1:-1,s=x,l=1;l<=o;++l)f[3*x]=0,f[3*x+1]=r*a,f[3*x+2]=0,d[3*x]=0,d[3*x+1]=a,d[3*x+2]=0,p[2*x]=.5,p[2*x+1]=.5,++x;for(var u=x,h=0;h<=o;++h){var m=h/o*c,v=Math.cos(m),g=Math.sin(m);f[3*x]=i*g,f[3*x+1]=r*a,f[3*x+2]=i*v,d[3*x]=0,d[3*x+1]=a,d[3*x+2]=0,p[2*x]=.5-.5*g*a,p[2*x+1]=.5+.5*v,++x}for(var y=0;y<o;++y){var E=s+y,T=u+y;n?(_[S]=T+1,++S,_[S]=E,++S,_[S]=T,++S):(_[S]=E,++S,_[S]=T+1,++S,_[S]=T,++S)}}}var hhe=new yn(0,0,0),_he=new yn(0,0,0),fhe=new yn(0,0,0),dhe=new yn(0,0,0),phe=new yn(0,0,0),mhe=new yn(0,0,0),vhe=new yn(0,0,0),ghe=new yn(0,0,0),yhe=new yn(0,0,0),xhe=Object.freeze({__proto__:null,box:function(e){var t=(e=e||{}).widthSegments||1,n=e.heightSegments||1,i=e.lengthSegments||1,r=(e.width||1)/2,o=(e.height||1)/2,a=(e.length||1)/2,s=[yn.set(ehe,-r,-o,a),yn.set(the,r,-o,a),yn.set(nhe,r,o,a),yn.set(ihe,-r,o,a),yn.set(rhe,r,-o,-a),yn.set(ohe,-r,-o,-a),yn.set(ahe,-r,o,-a),yn.set(she,r,o,-a)],c=[[2,3,1],[4,5,7],[7,6,2],[1,0,4],[1,4,2],[5,0,6]],l=[[0,0,1],[0,0,-1],[0,1,0],[0,-1,0],[1,0,0],[-1,0,0]],u=[[-1,0,0,1],[-1,0,0,1],[-1,0,0,1],[-1,0,0,1],[0,0,-1,1],[0,0,1,1]],h=[],_=[],f=[],d=[],p=[],m=new yn(-r,-o,-a),v=new yn(r,o,a),g=Math.sqrt(r*r+o*o+a*a);function y(e,t,n){var i,r,o,a,m=h.length/3,v=c[e],g=l[e],y=u[e];for(a=0;a<=n;a++)for(o=0;o<=t;o++)if(i=o/t,r=a/n,yn.lerp(Que,s[v[0]],s[v[1]],i),yn.lerp(Jue,s[v[0]],s[v[2]],r),yn.subtract(Zue,Jue,s[v[0]]),yn.add($ue,Que,Zue),h.push($ue.x,$ue.y,$ue.z),_.push(g[0],g[1],g[2]),f.push(i,r),d.push(y[0],y[1],y[2],y[3]),o<t&&a<n){var x=t+1,S=o+a*x,E=o+(a+1)*x,T=o+1+(a+1)*x,C=o+1+a*x;p.push(m+S,m+C,m+E),p.push(m+E,m+C,m+T)}}return y(0,t,n),y(4,i,n),y(1,t,n),y(5,i,n),y(3,t,i),y(2,t,i),{positions:h,normals:_,uvs:f,tangents:d,indices:p,minPos:m,maxPos:v,boundingRadius:g}},cone:function(e,t,n){return void 0===e&&(e=.5),void 0===t&&(t=1),void 0===n&&(n={}),uhe(0,e,t,n)},cylinder:uhe,plane:function(e){var t=function(e){return(e=Kue(e)).width=e.width||10,e.length=e.length||10,e.widthSegments=e.widthSegments||10,e.lengthSegments=e.lengthSegments||10,e}(e),n=t.width,i=t.length,r=t.widthSegments,o=t.lengthSegments,a=.5*n,s=.5*i,c=[],l=[],u=[],h=new yn(-a,0,-s),_=new yn(a,0,s),f=Math.sqrt(n*n+i*i);yn.set(phe,-a,0,s),yn.set(mhe,a,0,s),yn.set(vhe,-a,0,-s);for(var d=0;d<=o;d++)for(var p=0;p<=r;p++){var m=p/r,v=d/o;if(yn.lerp(hhe,phe,mhe,m),yn.lerp(_he,phe,vhe,v),yn.subtract(fhe,_he,phe),yn.add(dhe,hhe,fhe),c.push(dhe.x,dhe.y,dhe.z),t.includeUV&&l.push(m,v),p<r&&d<o){var g=r+1,y=p+d*g,x=p+(d+1)*g,S=p+1+(d+1)*g,E=p+1+d*g;u.push(y,E,x),u.push(E,S,x)}}var T={positions:c,indices:u,minPos:h,maxPos:_,boundingRadius:f};if(t.includeNormal){var C=(o+1)*(r+1),b=new Array(3*C);T.normals=b;for(var A=0;A<C;++A)b[3*A+0]=0,b[3*A+1]=1,b[3*A+2]=0}return t.includeUV&&(T.uvs=l),T},quad:function(e){var t=Kue(e),n={positions:[-.5,-.5,0,-.5,.5,0,.5,.5,0,.5,-.5,0],indices:[0,3,1,3,2,1],minPos:{x:-.5,y:-.5,z:0},maxPos:{x:.5,y:.5,z:0},boundingRadius:Math.sqrt(.5)};return!1!==t.includeNormal&&(n.normals=[0,0,1,0,0,1,0,0,1,0,0,1]),!1!==t.includeUV&&(n.uvs=[0,0,0,1,1,1,1,0]),n},sphere:function(e,t){void 0===e&&(e=.5),void 0===t&&(t={});for(var n=void 0!==t.segments?t.segments:32,i=[],r=[],o=[],a=[],s=new yn(-e,-e,-e),c=new yn(e,e,e),l=e,u=0;u<=n;++u)for(var h=u*Math.PI/n,_=Math.sin(h),f=-Math.cos(h),d=0;d<=n;++d){var p=2*d*Math.PI/n-Math.PI/2,m=Math.sin(p)*_,v=f,g=Math.cos(p)*_,y=d/n,x=u/n;if(i.push(m*e,v*e,g*e),r.push(m,v,g),o.push(y,x),u<n&&d<n){var S=n+1,E=S*u+d,T=S*(u+1)+d,C=S*(u+1)+d+1,b=S*u+d+1;a.push(E,b,T),a.push(b,C,T)}}return{positions:i,indices:a,normals:r,uvs:o,minPos:s,maxPos:c,boundingRadius:l}},torus:function(e,t,n){void 0===e&&(e=.4),void 0===t&&(t=.1),void 0===n&&(n={});for(var i=n.radialSegments||32,r=n.tubularSegments||32,o=n.arc||2*Math.PI,a=[],s=[],c=[],l=[],u=new yn(-e-t,-t,-e-t),h=new yn(e+t,t,e+t),_=e+t,f=0;f<=i;f++)for(var d=0;d<=r;d++){var p=d/r,m=f/i,v=p*o,g=m*Math.PI*2,y=(e+t*Math.cos(g))*Math.sin(v),x=t*Math.sin(g),S=(e+t*Math.cos(g))*Math.cos(v),E=Math.sin(v)*Math.cos(g),T=Math.sin(g),C=Math.cos(v)*Math.cos(g);if(a.push(y,x,S),s.push(E,T,C),c.push(p,m),d<r&&f<i){var b=r+1,A=b*f+d,w=b*(f+1)+d,I=b*(f+1)+d+1,P=b*f+d+1;l.push(A,P,w),l.push(P,I,w)}}return{positions:a,normals:s,uvs:c,indices:l,minPos:u,maxPos:h,boundingRadius:_}},capsule:function(e,t,n,i){void 0===e&&(e=.5),void 0===t&&(t=.5),void 0===n&&(n=2),void 0===i&&(i={});var r=n-e-t,o=i.sides||32,a=i.heightSegments||32,s=t/n,c=r/n,l=e/n,u=Math.floor(a*s),h=Math.floor(a*l),_=Math.floor(a*c),f=r+t-n/2,d=t-n/2,p=t-n/2,m=i.arc||2*Math.PI,v=[],g=[],y=[],x=[],S=Math.max(e,t),E=new yn(-S,-n/2,-S),T=new yn(S,n/2,S),C=n/2,b=0,A=[];return function(){for(var e=0;e<=u;++e)for(var n=e*Math.PI/u/2,i=Math.sin(n),r=-Math.cos(n),s=0;s<=o;++s){var c=2*s*Math.PI/o-Math.PI/2,l=Math.sin(c)*i,h=r,_=Math.cos(c)*i,f=s/o,d=e/a;if(v.push(l*t,h*t+p,_*t),g.push(l,h,_),y.push(f,d),e<u&&s<o){var m=o+1,S=m*e+s,E=m*(e+1)+s,T=m*(e+1)+s+1,C=m*e+s+1;x.push(S,C,E),x.push(C,T,E)}++b}}(),function(){for(var n=(e-t)/r,i=0;i<=_;i++){for(var a=[],l=i/_,u=l*(e-t)+t,h=0;h<=o;++h){var f=h/o,p=l*c+s,S=f*m-m/4,E=Math.sin(S),T=Math.cos(S);v.push(u*E),v.push(l*r+d),v.push(u*T),yn.normalize(ghe,yn.set(yhe,E,-n,T)),g.push(ghe.x),g.push(ghe.y),g.push(ghe.z),y.push(f,p),a.push(b),++b}A.push(a)}for(var C=0;C<_;++C)for(var w=0;w<o;++w){var I=A[C][w],P=A[C+1][w],R=A[C+1][w+1],D=A[C][w+1];x.push(I),x.push(D),x.push(P),x.push(D),x.push(R),x.push(P)}}(),function(){for(var t=0;t<=h;++t)for(var n=t*Math.PI/h/2+Math.PI/2,i=Math.sin(n),r=-Math.cos(n),s=0;s<=o;++s){var c=2*s*Math.PI/o-Math.PI/2,u=Math.sin(c)*i,d=r,p=Math.cos(c)*i,m=s/o,S=t/a+(1-l);if(v.push(u*e,d*e+f,p*e),g.push(u,d,p),y.push(m,S),t<h&&s<o){var E=o+1,T=E*t+s+A[_][o]+1,C=E*(t+1)+s+A[_][o]+1,b=E*(t+1)+s+1+A[_][o]+1,w=E*t+s+1+A[_][o]+1;x.push(T,w,C),x.push(w,b,C)}}}(),{positions:v,normals:g,uvs:y,indices:x,minPos:E,maxPos:T,boundingRadius:C}},circle:function(e){var t=function(e){return(e=Kue(e)).segments=64,e}(e).segments,n=new Array(3*(t+1));n[0]=0,n[1]=0,n[2]=0;var i=new Array(1+2*t);i[0]=0;for(var r=2*Math.PI/t,o=0;o<t;++o){var a=r*o,s=Math.cos(a),c=Math.sin(a),l=3*(o+1);n[l+0]=s,n[l+1]=c,n[l+2]=0;var u=2*o;i[1+u]=o+1,i[1+(u+1)]=o+2}return t>0&&(i[i.length-1]=1),{positions:n,indices:i,minPos:{x:1,y:1,z:0},maxPos:{x:-1,y:-1,z:0},boundingRadius:1,primitiveMode:Oi.TRIANGLE_FAN}},translate:function(e,t){for(var n=t.x||0,i=t.y||0,r=t.z||0,o=Math.floor(e.positions.length/3),a=0;a<o;++a){var s=3*a,c=3*a+1,l=3*a+2;e.positions[s]+=n,e.positions[c]+=i,e.positions[l]+=r}return e.minPos&&(e.minPos.x+=n,e.minPos.y+=i,e.minPos.z+=r),e.maxPos&&(e.maxPos.x+=n,e.maxPos.y+=i,e.maxPos.z+=r),e},scale:function(e,t){for(var n=t.x||0,i=t.y||0,r=t.z||0,o=Math.floor(e.positions.length/3),a=0;a<o;++a){var s=3*a,c=3*a+1,l=3*a+2;e.positions[s]*=n,e.positions[c]*=i,e.positions[l]*=r}return e.minPos&&(e.minPos.x*=n,e.minPos.y*=i,e.minPos.z*=r),e.maxPos&&(e.maxPos.x*=n,e.maxPos.y*=i,e.maxPos.z*=r),e.boundingRadius=Math.max(Math.max(n,i),r),e},wireframed:function(e){var t=e.indices;if(!t)return e;if(e.primitiveMode&&e.primitiveMode!==Oi.TRIANGLE_LIST)return e;for(var n=[[0,1],[1,2],[2,0]],i=[],r={},o=0;o<t.length;o+=3)for(var a=0;a<3;++a){var s=t[o+n[a][0]],c=t[o+n[a][1]],l=s>c?c<<16|s:s<<16|c;void 0===r[l]&&(r[l]=0,i.push(s,c))}return e.indices=i,e.primitiveMode=Oi.LINE_LIST,e},wireframe:function(e){for(var t=[[0,1],[1,2],[2,0]],n=[],i={},r=0;r<e.length;r+=3)for(var o=0;o<3;++o){var a=e[r+t[o][0]],s=e[r+t[o][1]],c=a>s?s<<16|a:a<<16|s;void 0===i[c]&&(i[c]=0,n.push(a,s))}return n},invWinding:function(e){for(var t=[],n=0;n<e.length;n+=3)t.push(e[n],e[n+2],e[n+1]);return t},toWavefrontOBJ:function(e,t){if(void 0===t&&(t=1),!e.indices||!e.uvs||!e.normals||void 0!==e.primitiveMode&&e.primitiveMode!==Oi.TRIANGLE_LIST)return"";for(var n=e.positions,i=e.uvs,r=e.normals,o=e.indices,a=function(e){return o[e]+1+"/"+(o[e]+1)+"/"+(o[e]+1)},s="",c=0;c<n.length;c+=3)s+="v "+n[c]*t+" "+n[c+1]*t+" "+n[c+2]*t+"\n";for(var l=0;l<i.length;l+=2)s+="vt "+i[l]+" "+i[l+1]+"\n";for(var u=0;u<r.length;u+=3)s+="vn "+r[u]+" "+r[u+1]+" "+r[u+2]+"\n";for(var h=0;h<o.length;h+=3)s+="f "+a(h)+" "+a(h+1)+" "+a(h+2)+"\n";return s},normals:function(e,t,n){void 0===n&&(n=1);for(var i=new Array(2*e.length),r=0;r<e.length/3;++r){var o=3*r,a=6*r;i[a+0]=e[o+0],i[a+1]=e[o+1],i[a+2]=e[o+2],i[a+3]=e[o+0]+t[o+0]*n,i[a+4]=e[o+1]+t[o+1]*n,i[a+5]=e[o+2]+t[o+2]*n}return i},applyDefaultGeometryOptions:Kue});function She(e){return Math.max(e.x,Math.max(e.y,e.z))}e("primitives",xhe);var Ehe=new yn;function The(e){return e.x=Math.abs(e.x),e.y=Math.abs(e.y),e.z=Math.abs(e.z),e}var Che,bhe,Ahe,whe,Ihe,Phe,Rhe,Dhe,Ohe,Nhe,Mhe,Lhe,Fhe,Bhe,zhe,Uhe,khe,Ghe,Hhe,Vhe,Whe,jhe,qhe,Xhe,Yhe,Khe,Qhe,Jhe,Zhe,$he,e_e,t_e,n_e,i_e,r_e,o_e,a_e,s_e,c_e,l_e,u_e,h_e,__e,f_e,d_e,p_e,m_e,v_e,g_e,y_e,x_e,S_e,E_e,T_e,C_e,b_e,A_e,w_e,I_e,P_e,R_e,D_e,O_e,N_e,M_e,L_e,F_e,B_e,z_e,U_e,k_e,G_e,H_e,V_e,W_e,j_e,q_e,X_e,Y_e,K_e,Q_e,J_e,Z_e,$_e,efe,tfe,nfe,ife,rfe,ofe,afe,sfe,cfe,lfe,ufe,hfe,_fe,ffe,dfe,pfe,mfe,vfe,gfe,yfe,xfe,Sfe,Efe,Tfe,Cfe,bfe,Afe,wfe,Ife,Pfe,Rfe,Dfe,Ofe,Nfe,Mfe,Lfe,Ffe,Bfe,zfe,Ufe,kfe,Gfe,Hfe,Vfe,Wfe=Object.freeze({__proto__:null,setWrap:function(e,t){e.__cc_wrapper__=t},getWrap:function(e){return e.__cc_wrapper__},maxComponent:She,VEC3_0:Ehe,TriggerEventObject:{type:"onTriggerEnter",selfCollider:null,otherCollider:null,impl:null},CollisionEventObject:{type:"onCollisionEnter",selfCollider:null,otherCollider:null,contacts:[],impl:null},shrinkPositions:function(e){var t=[];if(e.length>=3){t[0]=e[0],t[1]=e[1],t[2]=e[2];for(var n=e.length,i=3;i<n;i+=3){for(var r=e[i],o=e[i+1],a=e[i+2],s=t.length,c=!0,l=0;l<s;l+=3)if(Zt(r,t[l])&&Zt(o,t[l+1])&&Zt(a,t[l+2])){c=!1;break}c&&(t.push(r),t.push(o),t.push(a))}}return t},absolute:The,cylinder:uhe}),jfe=e("BoxCollider",(Che=dc("cc.BoxCollider"),bhe=Oc(),Ahe=Ic(),whe=Jc(yn),Ihe=Bc(),Che(Phe=bhe(Phe=Ahe(Phe=wc((T((Rhe=function(e){function t(){var t;return E(t=e.call(this,Gce.BOX)||this,"_size",Dhe,y(t)),t}return f(t,e),h(t,[{key:"size",get:function(){return this._size},set:function(e){yn.strictEquals(this._size,e)||(yn.copy(this._size,e),The(this._size),this._shape&&this.shape.updateSize())}},{key:"shape",get:function(){return this._shape}}]),t}(Yue)).prototype,"size",[whe,Ihe],Object.getOwnPropertyDescriptor(Rhe.prototype,"size"),Rhe.prototype),Dhe=T(Rhe.prototype,"_size",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new yn(1,1,1)}}),Phe=Rhe))||Phe)||Phe)||Phe)||Phe)),qfe=e("SphereCollider",(Ohe=dc("cc.SphereCollider"),Nhe=Oc(),Mhe=Ic(),Lhe=Bc(),Ohe(Fhe=Nhe(Fhe=Mhe(Fhe=wc((T((Bhe=function(e){function t(){var t;return E(t=e.call(this,Gce.SPHERE)||this,"_radius",zhe,y(t)),t}return f(t,e),h(t,[{key:"radius",get:function(){return this._radius},set:function(e){this._radius!==e&&(this._radius=Math.abs(e),this._shape&&this.shape.updateRadius())}},{key:"shape",get:function(){return this._shape}}]),t}(Yue)).prototype,"radius",[Lhe],Object.getOwnPropertyDescriptor(Bhe.prototype,"radius"),Bhe.prototype),zhe=T(Bhe.prototype,"_radius",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.5}}),Fhe=Bhe))||Fhe)||Fhe)||Fhe)||Fhe)),Xfe=e("CapsuleCollider",(Uhe=dc("cc.CapsuleCollider"),khe=Oc(),Ghe=Ic(),Hhe=Bc(),Vhe=Bc(),Whe=Jc(Uce),jhe=Bc(),Uhe(qhe=khe(qhe=Ghe(qhe=wc((T((Xhe=function(e){function t(){var t;return E(t=e.call(this,Gce.CAPSULE)||this,"_radius",Yhe,y(t)),E(t,"_cylinderHeight",Khe,y(t)),E(t,"_direction",Qhe,y(t)),t}f(t,e);var n=t.prototype;return n._getRadiusScale=function(){if(null==this.node)return 1;var e=this.node.worldScale;return this._direction===Uce.Y_AXIS?Math.abs(vn(e.x,e.z)):this._direction===Uce.X_AXIS?Math.abs(vn(e.y,e.z)):Math.abs(vn(e.x,e.y))},n._getHeightScale=function(){if(null==this.node)return 1;var e=this.node.worldScale;return this._direction===Uce.Y_AXIS?Math.abs(e.y):this._direction===Uce.X_AXIS?Math.abs(e.x):Math.abs(e.z)},h(t,[{key:"radius",get:function(){return this._radius},set:function(e){this._radius!==e&&(this._radius=Math.abs(e),this._shape&&this.shape.setRadius(e))}},{key:"cylinderHeight",get:function(){return this._cylinderHeight},set:function(e){this._cylinderHeight!==e&&(this._cylinderHeight=Math.abs(e),this._shape&&this.shape.setCylinderHeight(e))}},{key:"direction",get:function(){return this._direction},set:function(e){(e=Math.floor(e))<Uce.X_AXIS||e>Uce.Z_AXIS||this._direction!==e&&(this._direction=e,this._shape&&this.shape.setDirection(e))}},{key:"height",get:function(){return 2*this._radius+this._cylinderHeight},set:function(e){var t=e-2*this._radius;t<0&&(t=0),this.cylinderHeight=t}},{key:"worldHeight",get:function(){return 2*this._radius*this._getRadiusScale()+this._cylinderHeight*this._getHeightScale()}},{key:"shape",get:function(){return this._shape}}]),t}(Yue)).prototype,"radius",[Hhe],Object.getOwnPropertyDescriptor(Xhe.prototype,"radius"),Xhe.prototype),T(Xhe.prototype,"cylinderHeight",[Vhe],Object.getOwnPropertyDescriptor(Xhe.prototype,"cylinderHeight"),Xhe.prototype),T(Xhe.prototype,"direction",[Whe,jhe],Object.getOwnPropertyDescriptor(Xhe.prototype,"direction"),Xhe.prototype),Yhe=T(Xhe.prototype,"_radius",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.5}}),Khe=T(Xhe.prototype,"_cylinderHeight",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Qhe=T(Xhe.prototype,"_direction",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Uce.Y_AXIS}}),qhe=Xhe))||qhe)||qhe)||qhe)||qhe)),Yfe=e("CylinderCollider",(Jhe=dc("cc.CylinderCollider"),Zhe=Oc(),$he=Ic(),e_e=Bc(),t_e=Bc(),n_e=Jc(Uce),i_e=Bc(),Jhe(r_e=Zhe(r_e=$he(r_e=wc((T((o_e=function(e){function t(){var t;return E(t=e.call(this,Gce.CYLINDER)||this,"_radius",a_e,y(t)),E(t,"_height",s_e,y(t)),E(t,"_direction",c_e,y(t)),t}return f(t,e),h(t,[{key:"radius",get:function(){return this._radius},set:function(e){this._radius!==e&&(this._radius=Math.abs(e),this._shape&&this.shape.setRadius(e))}},{key:"height",get:function(){return this._height},set:function(e){this._height!==e&&(this._height=Math.abs(e),this._shape&&this.shape.setHeight(e))}},{key:"direction",get:function(){return this._direction},set:function(e){this._direction!==e&&(e<Uce.X_AXIS||e>Uce.Z_AXIS||(this._direction=e,this._shape&&this.shape.setDirection(e)))}},{key:"shape",get:function(){return this._shape}}]),t}(Yue)).prototype,"radius",[e_e],Object.getOwnPropertyDescriptor(o_e.prototype,"radius"),o_e.prototype),T(o_e.prototype,"height",[t_e],Object.getOwnPropertyDescriptor(o_e.prototype,"height"),o_e.prototype),T(o_e.prototype,"direction",[n_e,i_e],Object.getOwnPropertyDescriptor(o_e.prototype,"direction"),o_e.prototype),a_e=T(o_e.prototype,"_radius",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.5}}),s_e=T(o_e.prototype,"_height",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 2}}),c_e=T(o_e.prototype,"_direction",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Uce.Y_AXIS}}),r_e=o_e))||r_e)||r_e)||r_e)||r_e)),Kfe=e("ConeCollider",(l_e=dc("cc.ConeCollider"),u_e=Oc(),h_e=Ic(),__e=Bc(),f_e=Bc(),d_e=Jc(Uce),p_e=Bc(),l_e(m_e=u_e(m_e=h_e(m_e=wc((T((v_e=function(e){function t(){var t;return E(t=e.call(this,Gce.CONE)||this,"_radius",g_e,y(t)),E(t,"_height",y_e,y(t)),E(t,"_direction",x_e,y(t)),t}return f(t,e),h(t,[{key:"radius",get:function(){return this._radius},set:function(e){this._radius!==e&&(this._radius=Math.abs(e),this._shape&&this.shape.setRadius(e))}},{key:"height",get:function(){return this._height},set:function(e){this._height!==e&&(e<0&&(e=0),this._height=e,this._shape&&this.shape.setHeight(e))}},{key:"direction",get:function(){return this._direction},set:function(e){this._direction!==e&&(e<Uce.X_AXIS||e>Uce.Z_AXIS||(this._direction=e,this._shape&&this.shape.setDirection(e)))}},{key:"shape",get:function(){return this._shape}}]),t}(Yue)).prototype,"radius",[__e],Object.getOwnPropertyDescriptor(v_e.prototype,"radius"),v_e.prototype),T(v_e.prototype,"height",[f_e],Object.getOwnPropertyDescriptor(v_e.prototype,"height"),v_e.prototype),T(v_e.prototype,"direction",[d_e,p_e],Object.getOwnPropertyDescriptor(v_e.prototype,"direction"),v_e.prototype),g_e=T(v_e.prototype,"_radius",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.5}}),y_e=T(v_e.prototype,"_height",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),x_e=T(v_e.prototype,"_direction",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Uce.Y_AXIS}}),m_e=v_e))||m_e)||m_e)||m_e)||m_e)),Qfe=e("MeshCollider",(S_e=dc("cc.MeshCollider"),E_e=Oc(),T_e=Ic(),C_e=Jc(EX),b_e=Bc(),A_e=Bc(),S_e(w_e=E_e(w_e=T_e(w_e=wc((T((I_e=function(e){function t(){var t;return E(t=e.call(this,Gce.MESH)||this,"_mesh",P_e,y(t)),E(t,"_convex",R_e,y(t)),t}return f(t,e),h(t,[{key:"mesh",get:function(){return this._mesh},set:function(e){this._mesh!==e&&(this._mesh=e,this._shape&&this.shape.setMesh(this._mesh))}},{key:"convex",get:function(){return this._convex},set:function(e){this._convex!==e&&(this._convex=e)}},{key:"shape",get:function(){return this._shape}}]),t}(Yue)).prototype,"mesh",[C_e,b_e],Object.getOwnPropertyDescriptor(I_e.prototype,"mesh"),I_e.prototype),T(I_e.prototype,"convex",[Nc,A_e],Object.getOwnPropertyDescriptor(I_e.prototype,"convex"),I_e.prototype),P_e=T(I_e.prototype,"_mesh",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),R_e=T(I_e.prototype,"_convex",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),w_e=I_e))||w_e)||w_e)||w_e)||w_e)),Jfe=e("ConstantForce",(D_e=dc("cc.ConstantForce"),O_e=Oc(),N_e=pc(Xue),M_e=Ic(),L_e=Vc(),F_e=Bc(),B_e=Vc(),z_e=Bc(),U_e=Vc(),k_e=Bc(),G_e=Vc(),H_e=Bc(),D_e(V_e=O_e(V_e=N_e(V_e=M_e(V_e=vc(V_e=wc((K_e=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._rigidBody=null,E(t,"_force",j_e,y(t)),E(t,"_localForce",q_e,y(t)),E(t,"_torque",X_e,y(t)),E(t,"_localTorque",Y_e,y(t)),t._mask=0,t}f(t,e);var n=t.prototype;return n.onLoad=function(){this._rigidBody=this.node.getComponent(Xue),this._maskUpdate(this._force,1),this._maskUpdate(this._localForce,2),this._maskUpdate(this._torque,4),this._maskUpdate(this._localTorque,8)},n.lateUpdate=function(){null!=this._rigidBody&&0!==this._mask&&(1&this._mask&&this._rigidBody.applyForce(this._force),2&this._mask&&this._rigidBody.applyLocalForce(this.localForce),4&this._mask&&this._rigidBody.applyTorque(this._torque),8&this._mask&&this._rigidBody.applyLocalTorque(this._localTorque))},n._maskUpdate=function(e,t){e.strictEquals(yn.ZERO)?this._mask&=~t:this._mask|=t},h(t,[{key:"force",get:function(){return this._force},set:function(e){yn.copy(this._force,e),this._maskUpdate(this._force,1)}},{key:"localForce",get:function(){return this._localForce},set:function(e){yn.copy(this._localForce,e),this._maskUpdate(this.localForce,2)}},{key:"torque",get:function(){return this._torque},set:function(e){yn.copy(this._torque,e),this._maskUpdate(this._torque,4)}},{key:"localTorque",get:function(){return this._localTorque},set:function(e){yn.copy(this._localTorque,e),this._maskUpdate(this._localTorque,8)}}]),t}(ku),j_e=T((W_e=K_e).prototype,"_force",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new yn}}),q_e=T(W_e.prototype,"_localForce",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new yn}}),X_e=T(W_e.prototype,"_torque",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new yn}}),Y_e=T(W_e.prototype,"_localTorque",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new yn}}),T(W_e.prototype,"force",[L_e,F_e],Object.getOwnPropertyDescriptor(W_e.prototype,"force"),W_e.prototype),T(W_e.prototype,"localForce",[B_e,z_e],Object.getOwnPropertyDescriptor(W_e.prototype,"localForce"),W_e.prototype),T(W_e.prototype,"torque",[U_e,k_e],Object.getOwnPropertyDescriptor(W_e.prototype,"torque"),W_e.prototype),T(W_e.prototype,"localTorque",[G_e,H_e],Object.getOwnPropertyDescriptor(W_e.prototype,"localTorque"),W_e.prototype),V_e=W_e))||V_e)||V_e)||V_e)||V_e)||V_e)||V_e)),Zfe=16842754,$fe=16842755,ede=16842756,tde=16842757,nde=16843025,ide=function(){function e(){this.length=0,this.buffer=new Uint8Array(2048),this._buffView=new DataView(this.buffer.buffer),this._seekPos=0}var t=e.prototype;return t.reserve=function(e){if(!(this.buffer.byteLength>e)){for(var t=this.buffer.byteLength;t<e;)t+=t;for(var n=new Uint8Array(t),i=0;i<this.length;++i)n[i]=this.buffer[i];this.buffer=n,this._buffView=new DataView(this.buffer.buffer)}},t.assign=function(e){this.buffer=e,this.length=e.length,this._seekPos=e.byteOffset,this._buffView=new DataView(e.buffer)},t.writeInt8=function(e){this.reserve(this.length+1),this._buffView.setInt8(this.length,e),this.length+=1},t.writeInt16=function(e){this.reserve(this.length+2),this._buffView.setInt16(this.length,e,!0),this.length+=2},t.writeInt32=function(e){this.reserve(this.length+4),this._buffView.setInt32(this.length,e,!0),this.length+=4},t.writeIntArray=function(e){this.reserve(this.length+4*e.length);for(var t=0;t<e.length;++t)this._buffView.setInt32(this.length+4*t,e[t],!0);this.length+=4*e.length},t.writeFloat=function(e){this.reserve(this.length+4),this._buffView.setFloat32(this.length,e,!0),this.length+=4},t.writeFloatArray=function(e){this.reserve(this.length+4*e.length);for(var t=0;t<e.length;++t)this._buffView.setFloat32(this.length+4*t,e[t],!0);this.length+=4*e.length},t.writeString=function(e){this.reserve(this.length+e.length+4),this._buffView.setInt32(this.length,e.length,!0);for(var t=0;t<e.length;++t)this._buffView.setInt8(this.length+4+t,e.charCodeAt(t));this.length+=e.length+4},t.readInt8=function(){var e=this._buffView.getInt8(this._seekPos);return this._seekPos+=1,e},t.readInt16=function(){var e=this._buffView.getInt16(this._seekPos,!0);return this._seekPos+=2,e},t.readInt=function(){var e=this._buffView.getInt32(this._seekPos,!0);return this._seekPos+=4,e},t.readIntArray=function(e){for(var t=0;t<e.length;++t)e[t]=this._buffView.getInt32(this._seekPos+4*t,!0);return this._seekPos+=4*e.length,e},t.readFloat=function(){var e=this._buffView.getFloat32(this._seekPos,!0);return this._seekPos+=4,e},t.readFloatArray=function(e){for(var t=0;t<e.length;++t)e[t]=this._buffView.getFloat32(this._seekPos+4*t,!0);return this._seekPos+=4*e.length,e},t.readString=function(){for(var e=this.readInt(),t="",n=0;n<e;++n)t+=String.fromCharCode(this.readInt8());return t},e}(),rde=(dc("cc.TerrainLayerInfo")((J_e=T((Q_e=function(){E(this,"slot",J_e,this),E(this,"tileSize",Z_e,this),E(this,"detailMap",$_e,this),E(this,"normalMap",efe,this),E(this,"roughness",tfe,this),E(this,"metallic",nfe,this)}).prototype,"slot",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Z_e=T(Q_e.prototype,"tileSize",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),$_e=T(Q_e.prototype,"detailMap",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),efe=T(Q_e.prototype,"normalMap",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),tfe=T(Q_e.prototype,"roughness",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),nfe=T(Q_e.prototype,"metallic",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Q_e)),dc("cc.TerrainLayerBinaryInfo")(ife=function(){this.slot=0,this.tileSize=1,this.roughness=1,this.metallic=0,this.detailMapId="",this.normalMapId=""})||ife),ode=dc("cc.TerrainAsset")((sfe=function(e){function t(){var t;return(t=e.call(this)||this)._version=0,t._data=null,t._tileSize=1,t._blockCount=[1,1],t._weightMapSize=128,t._lightMapSize=128,t._heights=new Uint16Array,t._weights=new Uint8Array,t._layerBuffer=[-1,-1,-1,-1],t._layerBinaryInfos=[],E(t,"_layerInfos",afe,y(t)),t}f(t,e);var n=t.prototype;return n.getLayer=function(e,t,n){var i=4*(t*this.blockCount[0]+e)+n;return e<this.blockCount[0]&&t<this.blockCount[1]&&i<this._layerBuffer.length?this._layerBuffer[i]:-1},n.getHeight=function(e,t){var n=32*this._blockCount[0]+1;return.001953125*(this._heights[t*n+e]-32768)},n.getVertexCountI=function(){return this._blockCount.length<1?0:32*this._blockCount[0]+1},n.getVertexCountJ=function(){return this._blockCount.length<2?0:32*this._blockCount[1]+1},n._setNativeData=function(e){this._data=e},n._loadNativeData=function(e){if(!e||0===e.length)return!1;var t=new ide;if(t.assign(e),this._version=t.readInt(),this._version===nde)return!0;if(16842753!==this._version&&this._version!==Zfe&&this._version!==$fe&&this._version!==ede&&this._version!==tde)return!1;this.tileSize=t.readFloat(),t.readIntArray(this._blockCount),this.weightMapSize=t.readInt16(),this.lightMapSize=t.readInt16();var n=t.readInt();this.heights=new Uint16Array(n);for(var i=0;i<this.heights.length;++i)this.heights[i]=t.readInt16();var r=t.readInt();this.weights=new Uint8Array(r);for(var o=0;o<this.weights.length;++o)this.weights[o]=t.readInt8();if(this._version>=Zfe){var a=t.readInt();this.layerBuffer=new Array(a);for(var s=0;s<this.layerBuffer.length;++s)this.layerBuffer[s]=t.readInt16()}if(this._version>=$fe){var c=t.readInt();this._layerBinaryInfos=new Array(c);for(var l=0;l<this._layerBinaryInfos.length;++l)this._layerBinaryInfos[l]=new rde,this._layerBinaryInfos[l].slot=t.readInt(),this._layerBinaryInfos[l].tileSize=t.readFloat(),this._layerBinaryInfos[l].detailMapId=t.readString(),this._version>=ede&&(this._layerBinaryInfos[l].normalMapId=t.readString(),this._layerBinaryInfos[l].roughness=t.readFloat(),this._layerBinaryInfos[l].metallic=t.readFloat())}return!0},n._exportNativeData=function(){var e=new ide;e.writeInt32(tde),e.writeFloat(this.tileSize),e.writeIntArray(this._blockCount),e.writeInt16(this.weightMapSize),e.writeInt16(this.lightMapSize),e.writeInt32(this.heights.length);for(var t=0;t<this.heights.length;++t)e.writeInt16(this.heights[t]);e.writeInt32(this.weights.length);for(var n=0;n<this.weights.length;++n)e.writeInt8(this.weights[n]);e.writeInt32(this.layerBuffer.length);for(var i=0;i<this.layerBuffer.length;++i)e.writeInt16(this.layerBuffer[i]);var r=[];r.length=this.layerInfos.length;for(var o=0;o<r.length;++o){var a=this.layerInfos[o],s=new rde;s.slot=o,s.tileSize=a.tileSize,s.detailMapId=a.detailMap?a.detailMap._uuid:"",s.normalMapId=a.normalMap?a.normalMap._uuid:"",s.metallic=a.metallic,s.roughness=a.roughness,r[o]=s}e.writeInt32(r.length);for(var c=0;c<r.length;++c)e.writeInt32(r[c].slot),e.writeFloat(r[c].tileSize),e.writeString(r[c].detailMapId),e.writeString(r[c].normalMapId),e.writeFloat(r[c].roughness),e.writeFloat(r[c].metallic);return e.buffer},n._exportDefaultNativeData=function(){var e=new ide;return e.writeInt32(nde),e.buffer},h(t,[{key:"_nativeAsset",get:function(){return this._data.buffer},set:function(e){this._data&&this._data.byteLength===e.byteLength?this._data.set(new Uint8Array(e)):this._data=new Uint8Array(e),this._loadNativeData(this._data)}},{key:"version",get:function(){return this._version}},{key:"tileSize",get:function(){return this._tileSize},set:function(e){this._tileSize=e}},{key:"blockCount",get:function(){return this._blockCount},set:function(e){this._blockCount=e}},{key:"lightMapSize",get:function(){return this._lightMapSize},set:function(e){this._lightMapSize=e}},{key:"weightMapSize",get:function(){return this._weightMapSize},set:function(e){this._weightMapSize=e}},{key:"heights",get:function(){return this._heights},set:function(e){this._heights=e}},{key:"weights",get:function(){return this._weights},set:function(e){this._weights=e}},{key:"layerBuffer",get:function(){return this._layerBuffer},set:function(e){this._layerBuffer=e}},{key:"layerInfos",get:function(){return this._layerInfos},set:function(e){this._layerInfos=e}},{key:"layerBinaryInfos",get:function(){return this._layerBinaryInfos}}]),t}(yu),afe=T((ofe=sfe).prototype,"_layerInfos",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),rfe=ofe))||rfe,ade=e("TerrainCollider",(cfe=dc("cc.TerrainCollider"),lfe=Oc(),ufe=Ic(),hfe=Jc(ode),_fe=Bc(),cfe(ffe=lfe(ffe=ufe(ffe=wc((T((dfe=function(e){function t(){var t;return E(t=e.call(this,Gce.TERRAIN)||this,"_terrain",pfe,y(t)),t}return f(t,e),h(t,[{key:"terrain",get:function(){return this._terrain},set:function(e){this._terrain=e,this._shape&&this.shape.setTerrain(this._terrain)}},{key:"shape",get:function(){return this._shape}}]),t}(Yue)).prototype,"terrain",[hfe,_fe],Object.getOwnPropertyDescriptor(dfe.prototype,"terrain"),dfe.prototype),pfe=T(dfe.prototype,"_terrain",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),ffe=dfe))||ffe)||ffe)||ffe)||ffe)),sde=e("SimplexCollider",(mfe=dc("cc.SimplexCollider"),vfe=Oc(),gfe=Ic(),yfe=Jc(kce),xfe=Bc(),Sfe=Bc(),Efe=Mc(),Tfe=Bc(),Cfe=Mc(),bfe=Bc(),Afe=Mc(),wfe=Bc(),mfe(Ife=vfe(Ife=gfe(Ife=wc((Nfe=Ofe=function(e){function t(){var t;return E(t=e.call(this,Gce.SIMPLEX)||this,"_shapeType",Rfe,y(t)),E(t,"_vertices",Dfe,y(t)),t}return f(t,e),t.prototype.updateVertices=function(){this._shape&&this.shape.setVertices(this._vertices)},h(t,[{key:"shapeType",get:function(){return this._shapeType},set:function(e){this._shapeType=e,this._shape&&this.shape.setShapeType(e)}},{key:"vertex0",get:function(){return this._vertices[0]},set:function(e){yn.copy(this._vertices[0],e),this.updateVertices()}},{key:"vertex1",get:function(){return this._vertices[1]},set:function(e){yn.copy(this._vertices[1],e),this.updateVertices()}},{key:"vertex2",get:function(){return this._vertices[2]},set:function(e){yn.copy(this._vertices[2],e),this.updateVertices()}},{key:"vertex3",get:function(){return this._vertices[3]},set:function(e){yn.copy(this._vertices[3],e),this.updateVertices()}},{key:"shape",get:function(){return this._shape}},{key:"vertices",get:function(){return this._vertices}}]),t}(Yue),Ofe.ESimplexType=kce,T((Pfe=Nfe).prototype,"shapeType",[yfe,xfe],Object.getOwnPropertyDescriptor(Pfe.prototype,"shapeType"),Pfe.prototype),T(Pfe.prototype,"vertex0",[Nc,Sfe],Object.getOwnPropertyDescriptor(Pfe.prototype,"vertex0"),Pfe.prototype),T(Pfe.prototype,"vertex1",[Efe,Tfe],Object.getOwnPropertyDescriptor(Pfe.prototype,"vertex1"),Pfe.prototype),T(Pfe.prototype,"vertex2",[Cfe,bfe],Object.getOwnPropertyDescriptor(Pfe.prototype,"vertex2"),Pfe.prototype),T(Pfe.prototype,"vertex3",[Afe,wfe],Object.getOwnPropertyDescriptor(Pfe.prototype,"vertex3"),Pfe.prototype),Rfe=T(Pfe.prototype,"_shapeType",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return kce.TETRAHEDRON}}),Dfe=T(Pfe.prototype,"_vertices",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[new yn(0,0,0),new yn(0,0,1),new yn(1,0,0),new yn(0,1,0)]}}),Ife=Pfe))||Ife)||Ife)||Ife)||Ife));sde||(sde=e("SimplexCollider",{}));var cde,lde,ude,hde,_de,fde,dde,pde,mde,vde,gde,yde,xde,Sde,Ede,Tde,Cde,bde,Ade,wde,Ide,Pde,Rde,Dde,Ode,Nde,Mde,Lde,Fde=e("PlaneCollider",(Mfe=dc("cc.PlaneCollider"),Lfe=Oc(),Ffe=Ic(),Bfe=Jc(yn),zfe=Bc(),Ufe=Bc(),Mfe(kfe=Lfe(kfe=Ffe(kfe=wc((T((Gfe=function(e){function t(){var t;return E(t=e.call(this,Gce.PLANE)||this,"_normal",Hfe,y(t)),E(t,"_constant",Vfe,y(t)),t}return f(t,e),h(t,[{key:"normal",get:function(){return this._normal},set:function(e){yn.strictEquals(this._normal,e)||(yn.copy(this._normal,e),this._shape&&this.shape.setNormal(this._normal))}},{key:"constant",get:function(){return this._constant},set:function(e){this._constant!==e&&(this._constant=e,this._shape&&this.shape.setConstant(this._constant))}},{key:"shape",get:function(){return this._shape}}]),t}(Yue)).prototype,"normal",[Bfe,zfe],Object.getOwnPropertyDescriptor(Gfe.prototype,"normal"),Gfe.prototype),T(Gfe.prototype,"constant",[Nc,Ufe],Object.getOwnPropertyDescriptor(Gfe.prototype,"constant"),Gfe.prototype),Hfe=T(Gfe.prototype,"_normal",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new yn(0,1,0)}}),Vfe=T(Gfe.prototype,"_constant",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),kfe=Gfe))||kfe)||kfe)||kfe)||kfe)),Bde=e("Constraint",(cde=dc("cc.Constraint"),lde=pc(Xue),ude=Jc(Xue),hde=Vc(),_de=Jc(Xue),fde=Vc(),dde=Vc(),pde=Jc(Xue),cde(mde=lde((Sde=xde=function(e){function t(t){var n;return(n=e.call(this)||this).TYPE=void 0,E(n,"_enableCollision",gde,y(n)),E(n,"_connectedBody",yde,y(n)),n._constraint=null,n.TYPE=t,n}f(t,e);var n=t.prototype;return n.onLoad=function(){fle.runInEditor&&(this._constraint=function(e){return Ple.INITED||(Ple.INITED=!0,Ple[Hce.POINT_TO_POINT]=function(){return mle(fle.wrapper.PointToPointConstraint,_le.PointToPointConstraint)?Rle:new fle.wrapper.PointToPointConstraint},Ple[Hce.HINGE]=function(){return mle(fle.wrapper.HingeConstraint,_le.HingeConstraint)?Rle:new fle.wrapper.HingeConstraint},Ple[Hce.CONE_TWIST]=function(){return mle(fle.wrapper.ConeTwistConstraint,_le.ConeTwistConstraint)?Rle:new fle.wrapper.ConeTwistConstraint}),Ple[e]()}(this.TYPE),this._constraint.initialize(this))},n.onEnable=function(){this._constraint&&this._constraint.onEnable()},n.onDisable=function(){this._constraint&&this._constraint.onDisable()},n.onDestroy=function(){this._constraint&&this._constraint.onDestroy()},h(t,[{key:"attachedBody",get:function(){return this.getComponent(Xue)}},{key:"connectedBody",get:function(){return this._connectedBody},set:function(e){this._connectedBody=e,this._constraint&&this._constraint.setConnectedBody(e)}},{key:"enableCollision",get:function(){return this._enableCollision},set:function(e){this._enableCollision=e,this._constraint&&this._constraint.setEnableCollision(e)}}]),t}(Wl(ku)),xde.Type=Hce,T((vde=Sde).prototype,"attachedBody",[ude,Lc,hde],Object.getOwnPropertyDescriptor(vde.prototype,"attachedBody"),vde.prototype),T(vde.prototype,"connectedBody",[_de,fde],Object.getOwnPropertyDescriptor(vde.prototype,"connectedBody"),vde.prototype),T(vde.prototype,"enableCollision",[dde],Object.getOwnPropertyDescriptor(vde.prototype,"enableCollision"),vde.prototype),gde=T(vde.prototype,"_enableCollision",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),yde=T(vde.prototype,"_connectedBody",[pde],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),mde=vde))||mde)||mde));Bde||(Bde=e("Constraint",{}));var zde,Ude,kde,Gde,Hde,Vde,Wde,jde,qde,Xde=e("HingeConstraint",(Ede=dc("cc.HingeConstraint"),Tde=Oc(),Cde=Ic(),bde=Jc(yn),Ade=Jc(yn),wde=Jc(yn),Ide=Tc("axisA"),Pde=Tc("pivotA"),Rde=Tc("pivotB"),Ede(Dde=Tde(Dde=Cde((T((Ode=function(e){function t(){var t;return E(t=e.call(this,Hce.HINGE)||this,"_axis",Nde,y(t)),E(t,"_pivotA",Mde,y(t)),E(t,"_pivotB",Lde,y(t)),t}return f(t,e),h(t,[{key:"pivotA",get:function(){return this._pivotA},set:function(e){yn.copy(this._pivotA,e),this.constraint.setPivotA(this._pivotA)}},{key:"pivotB",get:function(){return this._pivotB},set:function(e){yn.copy(this._pivotB,e),this.constraint.setPivotB(this._pivotB)}},{key:"axis",get:function(){return this._axis},set:function(e){yn.copy(this._axis,e),this.constraint.setAxis(this._axis)}},{key:"constraint",get:function(){return this._constraint}}]),t}(Bde)).prototype,"pivotA",[bde],Object.getOwnPropertyDescriptor(Ode.prototype,"pivotA"),Ode.prototype),T(Ode.prototype,"pivotB",[Ade],Object.getOwnPropertyDescriptor(Ode.prototype,"pivotB"),Ode.prototype),T(Ode.prototype,"axis",[wde],Object.getOwnPropertyDescriptor(Ode.prototype,"axis"),Ode.prototype),Nde=T(Ode.prototype,"_axis",[Ec,Ide],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new yn}}),Mde=T(Ode.prototype,"_pivotA",[Ec,Pde],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new yn}}),Lde=T(Ode.prototype,"_pivotB",[Ec,Rde],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new yn}}),Dde=Ode))||Dde)||Dde)||Dde)),Yde=e("PointToPointConstraint",(zde=dc("cc.PointToPointConstraint"),Ude=Oc(),kde=Ic(),Gde=Jc(yn),Hde=Jc(yn),zde(Vde=Ude(Vde=kde((T((Wde=function(e){function t(){var t;return E(t=e.call(this,Hce.POINT_TO_POINT)||this,"_pivotA",jde,y(t)),E(t,"_pivotB",qde,y(t)),t}return f(t,e),h(t,[{key:"pivotA",get:function(){return this._pivotA},set:function(e){yn.copy(this._pivotA,e),this.constraint.setPivotA(this._pivotA)}},{key:"pivotB",get:function(){return this._pivotB},set:function(e){yn.copy(this._pivotB,e),this.constraint.setPivotB(this._pivotB)}},{key:"constraint",get:function(){return this._constraint}}]),t}(Bde)).prototype,"pivotA",[Gde],Object.getOwnPropertyDescriptor(Wde.prototype,"pivotA"),Wde.prototype),T(Wde.prototype,"pivotB",[Hde],Object.getOwnPropertyDescriptor(Wde.prototype,"pivotB"),Wde.prototype),jde=T(Wde.prototype,"_pivotA",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new yn}}),qde=T(Wde.prototype,"_pivotB",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new yn}}),Vde=Wde))||Vde)||Vde)||Vde));b.PhysicsSystem=Cue,b.PhysicsMaterial=Dle,b.PhysicsRayResult=Ole,b.ConstantForce=Jfe;var Kde=Object.freeze({__proto__:null,PhysicsSystem:Cue,PhysicsRayResult:Ole,get Collider(){return Yue},BoxCollider:jfe,SphereCollider:qfe,CapsuleCollider:Xfe,MeshCollider:Qfe,CylinderCollider:Yfe,ConeCollider:Kfe,TerrainCollider:ade,get SimplexCollider(){return sde},PlaneCollider:Fde,get Constraint(){return Bde},HingeConstraint:Xde,PointToPointConstraint:Yde,get RigidBody(){return Xue},PhysicsMaterial:Dle,ConstantForce:Jfe,selector:fle,utils:Wfe,get ERigidBodyType(){return zce},get EAxisDirection(){return Uce},get ESimplexType(){return kce},get EColliderType(){return Gce},get EConstraintType(){return Hce},get PhysicsGroup(){return Vce}});e("physics",Kde);var Qde=function(){function e(){this.collisionFilterGroup=Cue.PhysicsGroup.DEFAULT,this.collisionFilterMask=-1}var t=e.prototype;return t.getGroup=function(){return this.collisionFilterGroup},t.setGroup=function(e){this.collisionFilterGroup=e},t.addGroup=function(e){this.collisionFilterGroup|=e},t.removeGroup=function(e){this.collisionFilterGroup&=~e},t.getMask=function(){return this.collisionFilterMask},t.setMask=function(e){this.collisionFilterMask=e},t.addMask=function(e){this.collisionFilterMask|=e},t.removeMask=function(e){this.collisionFilterMask&=~e},e}(),Jde=new kn,Zde=new yn,$de=new yn,epe=new On,tpe=function(e){function t(n,i){var r;return(r=e.call(this)||this)._id=void 0,r.index=-1,r.ref=0,r.node=void 0,r.world=void 0,r.shapes=[],r.wrappedBody=null,r._id=t.idCounter++,r.node=n,r.world=i,r}f(t,e),t.getSharedBody=function(e,n,i){var r,o=e.uuid;if(t.sharedBodesMap.has(o))r=t.sharedBodesMap.get(o);else{r=new t(e,n);var a=Vce.DEFAULT,s=Cue.instance.collisionMatrix[a];r.collisionFilterGroup=a,r.collisionFilterMask=s,t.sharedBodesMap.set(e.uuid,r)}if(i){r.wrappedBody=i;var c=i.rigidBody.group,l=Cue.instance.collisionMatrix[c];r.collisionFilterGroup=c,r.collisionFilterMask=l}return r};var n=t.prototype;return n.intersects=function(e){for(var t=0;t<this.shapes.length;t++)for(var n=this.shapes[t],i=0;i<e.shapes.length;i++){var r=e.shapes[i];(n.collider.needTriggerEvent||r.collider.needTriggerEvent)&&rs.resolve(n.worldShape,r.worldShape)&&(this.world.shapeArr.push(n),this.world.shapeArr.push(r))}},n.addShape=function(e){this.shapes.indexOf(e)<0&&this.shapes.push(e)},n.removeShape=function(e){var t=this.shapes.indexOf(e);t>=0&&re(this.shapes,t)},n.syncSceneToPhysics=function(){if(this.node.hasChangedFlags){this.node.getWorldMatrix(Jde),Zde.set(this.node.worldPosition),epe.set(this.node.worldRotation),$de.set(this.node.worldScale);for(var e=0;e<this.shapes.length;e++)this.shapes[e].transform(Jde,Zde,epe,$de)}},n.syncInitial=function(){this.node.getWorldMatrix(Jde),Zde.set(this.node.worldPosition),epe.set(this.node.worldRotation),$de.set(this.node.worldScale);for(var e=0;e<this.shapes.length;e++)this.shapes[e].transform(Jde,Zde,epe,$de)},n.destroy=function(){t.sharedBodesMap.delete(this.node.uuid),this.node=null,this.world=null,this.shapes=null},h(t,[{key:"id",get:function(){return this._id}},{key:"enabled",set:function(e){e?this.index<0&&(this.index=this.world.bodies.length,this.world.addSharedBody(this),this.syncInitial()):this.index>=0&&0===this.shapes.length&&(this.index=-1,this.world.removeSharedBody(this))}},{key:"reference",set:function(e){e?this.ref++:this.ref--,0===this.ref&&this.destroy()}}]),t}(Qde);tpe.sharedBodesMap=new Map,tpe.idCounter=0;var npe=function(){function e(){this.matrix=[]}var t=e.prototype;return t.get=function(e,t){if(t>e){var n=t;t=e,e=n}return this.matrix[(e*(e+1)>>1)+t-1]},t.set=function(e,t,n){if(t>e){var i=t;t=e,e=i}this.matrix[(e*(e+1)>>1)+t-1]=n?1:0},t.reset=function(){this.matrix.length=0},t.setNumObjects=function(e){this.matrix.length=e*(e-1)>>1},e}(),ipe=new yn,rpe={type:"onTriggerEnter",selfCollider:null,otherCollider:null,impl:{}},ope=function(){function e(){this.shapeArr=[],this.bodies=[],this._shapeArrPrev=[],this._collisionMatrix=new npe,this._collisionMatrixPrev=new npe}var t=e.prototype;return t.setGravity=function(){},t.setAllowSleep=function(){},t.setDefaultMaterial=function(){},t.destroy=function(){this.bodies.length&&B("You should destroy all physics component first.")},t.step=function(){var e=this._shapeArrPrev;this._shapeArrPrev=this.shapeArr,this.shapeArr=e,this.shapeArr.length=0;for(var t=0;t<this.bodies.length;t++)for(var n=this.bodies[t],i=t+1;i<this.bodies.length;i++){var r=this.bodies[i];0!=(n.collisionFilterGroup&r.collisionFilterMask)&&0!=(r.collisionFilterGroup&n.collisionFilterMask)&&n.intersects(r)}},t.syncSceneToPhysics=function(){for(var e=0;e<this.bodies.length;e++)this.bodies[e].syncSceneToPhysics()},t.syncAfterEvents=function(){this.syncSceneToPhysics()},t.emitEvents=function(){this.emitTriggerEvent()},t.raycastClosest=function(e,t,n){for(var i=1/0,r=t.maxDistance,o=t.mask,a=0;a<this.bodies.length;a++){var s=this.bodies[a];if(s.collisionFilterGroup&o)for(var c=0;c<s.shapes.length;c++){var l=s.shapes[c],u=rs.resolve(e,l.worldShape);0===u||u>r||i>u&&(i=u,yn.normalize(ipe,e.d),yn.scaleAndAdd(ipe,e.o,ipe,u),n._assign(ipe,u,l.collider,yn.ZERO))}}return!(i===1/0)},t.raycast=function(e,t,n,i){for(var r=t.maxDistance,o=t.mask,a=0;a<this.bodies.length;a++){var s=this.bodies[a];if(s.collisionFilterGroup&o)for(var c=0;c<s.shapes.length;c++){var l=s.shapes[c],u=rs.resolve(e,l.worldShape);if(!(0===u||u>r)){var h=n.add();e.computeHit(ipe,u),h._assign(ipe,u,l.collider,yn.ZERO),i.push(h)}}}return i.length>0},t.getSharedBody=function(e,t){return tpe.getSharedBody(e,this,t)},t.addSharedBody=function(e){this.bodies.indexOf(e)<0&&this.bodies.push(e)},t.removeSharedBody=function(e){var t=this.bodies.indexOf(e);t>=0&&re(this.bodies,t)},t.emitTriggerEvent=function(){for(var e,t,n=0;n<this.shapeArr.length;n+=2)e=this.shapeArr[n],t=this.shapeArr[n+1],rpe.selfCollider=e.collider,rpe.otherCollider=t.collider,this._collisionMatrix.set(e.id,t.id,!0),this._collisionMatrixPrev.get(e.id,t.id)?rpe.type="onTriggerStay":rpe.type="onTriggerEnter",e.collider&&e.collider.emit(rpe.type,rpe),rpe.selfCollider=t.collider,rpe.otherCollider=e.collider,t.collider&&t.collider.emit(rpe.type,rpe);for(var i=0;i<this._shapeArrPrev.length;i+=2)e=this._shapeArrPrev[i],t=this._shapeArrPrev[i+1],this._collisionMatrixPrev.get(e.id,t.id)&&(this._collisionMatrix.get(e.id,t.id)||(rpe.type="onTriggerExit",rpe.selfCollider=e.collider,rpe.otherCollider=t.collider,e.collider&&e.collider.emit(rpe.type,rpe),rpe.selfCollider=t.collider,rpe.otherCollider=e.collider,t.collider&&t.collider.emit(rpe.type,rpe),this._collisionMatrix.set(e.id,t.id,!1)));var r=this._collisionMatrixPrev.matrix;this._collisionMatrixPrev.matrix=this._collisionMatrix.matrix,this._collisionMatrix.matrix=r,this._collisionMatrix.reset()},h(e,[{key:"impl",get:function(){return this}}]),e}(),ape=function(){function e(){}var t=e.prototype;return t.initialize=function(e){this._rigidBody=e,this._sharedBody=Cue.instance.physicsWorld.getSharedBody(this._rigidBody.node,this),this._sharedBody.reference=!0},t.onEnable=function(){this._sharedBody.enabled=!0},t.onDisable=function(){this._sharedBody.enabled=!1},t.onDestroy=function(){this._sharedBody.reference=!1,this._rigidBody=null,this._sharedBody=null},t.setMass=function(){},t.setType=function(){},t.setLinearDamping=function(){},t.setAngularDamping=function(){},t.useGravity=function(){},t.useCCD=function(){},t.isUsingCCD=function(){return!1},t.setLinearFactor=function(){},t.setAngularFactor=function(){},t.setAllowSleep=function(){},t.wakeUp=function(){},t.sleep=function(){},t.clearState=function(){},t.clearForces=function(){},t.clearVelocity=function(){},t.setSleepThreshold=function(){},t.getSleepThreshold=function(){return 0},t.getLinearVelocity=function(){},t.setLinearVelocity=function(){},t.getAngularVelocity=function(){},t.setAngularVelocity=function(){},t.applyForce=function(){},t.applyLocalForce=function(){},t.applyImpulse=function(){},t.applyLocalImpulse=function(){},t.applyTorque=function(){},t.applyLocalTorque=function(){},t.setGroup=function(e){this._sharedBody.setGroup(e)},t.getGroup=function(){return this._sharedBody.getGroup()},t.addGroup=function(e){this._sharedBody.addGroup(e)},t.removeGroup=function(e){this._sharedBody.removeGroup(e)},t.setMask=function(e){this._sharedBody.setMask(e)},t.getMask=function(){return this._sharedBody.getMask()},t.addMask=function(e){this._sharedBody.addMask(e)},t.removeMask=function(e){this._sharedBody.removeMask(e)},h(e,[{key:"impl",get:function(){return this}},{key:"isAwake",get:function(){return!0}},{key:"isSleepy",get:function(){return!1}},{key:"isSleeping",get:function(){return!1}},{key:"rigidBody",get:function(){return this._rigidBody}},{key:"sharedBody",get:function(){return this._sharedBody}}]),e}();b.physics=Kde;var spe=function(){function e(){this.id=e.idCounter++}var t=e.prototype;return t.getAABB=function(){},t.getBoundingSphere=function(){},t.updateEventListener=function(){},t.setMaterial=function(){},t.setAsTrigger=function(){},t.setCenter=function(e){yn.copy(this._localShape.center,e)},t.initialize=function(e){this._collider=e,this._sharedBody=Cue.instance.physicsWorld.getSharedBody(this._collider.node),this._sharedBody.reference=!0},t.onLoad=function(){this.setCenter(this._collider.center)},t.onEnable=function(){this._sharedBody.addShape(this),this._sharedBody.enabled=!0},t.onDisable=function(){this._sharedBody.removeShape(this),this._sharedBody.enabled=!1},t.onDestroy=function(){this._sharedBody.reference=!1,this._collider=null,this._localShape=null,this._worldShape=null},t.transform=function(e,t,n,i){this._localShape.transform(e,t,n,i,this._worldShape)},t.getGroup=function(){return this._sharedBody.getGroup()},t.setGroup=function(e){this._sharedBody.setGroup(e)},t.addGroup=function(e){this._sharedBody.addGroup(e)},t.removeGroup=function(e){this._sharedBody.removeGroup(e)},t.getMask=function(){return this._sharedBody.getMask()},t.setMask=function(e){this._sharedBody.setMask(e)},t.addMask=function(e){this._sharedBody.addMask(e)},t.removeMask=function(e){this._sharedBody.removeMask(e)},h(e,[{key:"attachedRigidBody",get:function(){return null}},{key:"localShape",get:function(){return this._localShape}},{key:"worldShape",get:function(){return this._worldShape}},{key:"impl",get:function(){return this._worldShape}},{key:"sharedBody",get:function(){return this._sharedBody}},{key:"collider",get:function(){return this._collider}}]),e}();spe.idCounter=0;var cpe,lpe,upe,hpe,_pe,fpe,dpe,ppe,mpe,vpe=function(e){function t(){var t;return(t=e.call(this)||this)._localShape=new Vs,t._worldShape=new Vs,t}f(t,e);var n=t.prototype;return n.updateSize=function(){yn.multiplyScalar(this.localObb.halfExtents,this.collider.size,.5),yn.multiply(this.worldObb.halfExtents,this.localObb.halfExtents,this.collider.node.worldScale)},n.onLoad=function(){e.prototype.onLoad.call(this),this.updateSize()},h(t,[{key:"localObb",get:function(){return this._localShape}},{key:"worldObb",get:function(){return this._worldShape}},{key:"collider",get:function(){return this._collider}}]),t}(spe),gpe=function(e){f(n,e);var t=n.prototype;function n(t){var n;return void 0===t&&(t=.5),(n=e.call(this)||this)._localShape=new ea(0,0,0,t),n._worldShape=new ea(0,0,0,t),n}return t.updateRadius=function(){this.localSphere.radius=this.collider.radius;var e=She(this.collider.node.worldScale);this.worldSphere.radius=this.localSphere.radius*e},t.onLoad=function(){e.prototype.onLoad.call(this),this.updateRadius()},h(n,[{key:"localSphere",get:function(){return this._localShape}},{key:"worldSphere",get:function(){return this._worldShape}},{key:"collider",get:function(){return this._collider}}]),n}(spe),ype=function(e){function t(t,n,i){var r;void 0===t&&(t=.5),void 0===n&&(n=2),void 0===i&&(i=Uce.Y_AXIS);var o=(n-2*t)/2,a=o<0?0:o;return(r=e.call(this)||this)._localShape=new Ws(t,a,i),r._worldShape=new Ws(t,a,i),r}f(t,e);var n=t.prototype;return n.setRadius=function(e){this.localCapsule.radius=e,this.transform(this._sharedBody.node.worldMatrix,this._sharedBody.node.worldPosition,this._sharedBody.node.worldRotation,this._sharedBody.node.worldScale)},n.setCylinderHeight=function(e){this.localCapsule.halfHeight=e/2,this.localCapsule.updateCache(),this.transform(this._sharedBody.node.worldMatrix,this._sharedBody.node.worldPosition,this._sharedBody.node.worldRotation,this._sharedBody.node.worldScale)},n.setDirection=function(e){this.localCapsule.axis=e,this.localCapsule.updateCache(),this.worldCapsule.axis=e,this.worldCapsule.updateCache(),this.transform(this._sharedBody.node.worldMatrix,this._sharedBody.node.worldPosition,this._sharedBody.node.worldRotation,this._sharedBody.node.worldScale)},n.onLoad=function(){e.prototype.onLoad.call(this),this.setRadius(this.collider.radius),this.setDirection(this.collider.direction)},h(t,[{key:"localCapsule",get:function(){return this._localShape}},{key:"worldCapsule",get:function(){return this._worldShape}},{key:"collider",get:function(){return this._collider}}]),t}(spe);PO.once(wO.EVENT_ENGINE_INITED,(function(){fle.register("builtin",{RigidBody:ape,BoxShape:vpe,SphereShape:gpe,PhysicsWorld:ope,CapsuleShape:ype})})),function(e){e[e.BOX=0]="BOX",e[e.SPHERE=1]="SPHERE",e[e.CYLINDER=2]="CYLINDER",e[e.CONE=3]="CONE",e[e.CAPSULE=4]="CAPSULE",e[e.TORUS=5]="TORUS",e[e.PLANE=6]="PLANE",e[e.QUAD=7]="QUAD"}(mpe||(mpe={})),et(mpe);var xpe=e("Primitive",(cpe=dc("cc.Primitive"),lpe=Jc(mpe),cpe((ppe=dpe=function(e){function t(t){var n;return void 0===t&&(t=mpe.BOX),E(n=e.call(this)||this,"type",_pe,y(n)),E(n,"info",fpe,y(n)),n.type=t,n}return f(t,e),t.prototype.onLoaded=function(){RX(xhe[mpe[this.type].toLowerCase()](this.info),this)},t}(EX),dpe.PrimitiveType=mpe,_pe=T((hpe=ppe).prototype,"type",[lpe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return mpe.BOX}}),fpe=T(hpe.prototype,"info",[Ec,Nc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return{}}}),upe=hpe))||upe));b.Primitive=xpe,b.primitives=xhe;var Spe=function(){function e(e){this.jointTexturePool=void 0,this.jointAnimationInfo=void 0,this.jointTexturePool=new MJ(e),this.jointAnimationInfo=new LJ(e)}var t=e.prototype;return t.releaseSkeleton=function(e){this.jointTexturePool.releaseSkeleton(e)},t.releaseAnimationClip=function(e){this.jointTexturePool.releaseAnimationClip(e)},t.clear=function(){this.jointTexturePool.clear(),this.jointAnimationInfo.clear()},e}();b.internal.DataPoolManager=Spe;var Epe,Tpe,Cpe,bpe,Ape,wpe,Ipe,Ppe,Rpe,Dpe,Ope,Npe,Mpe,Lpe,Fpe,Bpe,zpe,Upe,kpe,Gpe,Hpe=new kn,Vpe=new kn,Wpe=e("SkeletalAnimationState",function(e){function t(t,n){var i;return void 0===n&&(n=""),(i=e.call(this,t,n)||this)._frames=1,i._bakedDuration=0,i._animInfo=null,i._sockets=[],i._animInfoMgr=void 0,i._parent=null,i._curvesInited=!1,i._animInfoMgr=b.director.root.dataPoolManager.jointAnimationInfo,i}f(t,e);var n=t.prototype;return n.initialize=function(t){if(!this._curveLoaded){this._parent=t.getComponent("cc.SkeletalAnimation");var n=this._parent.useBakedAnimation;this._doNotCreateEval=n,e.prototype.initialize.call(this,t),this._curvesInited=!n;var i=xJ.getOrExtract(this.clip),r=i.frames,o=i.samples;this._frames=r-1,this._animInfo=this._animInfoMgr.getData(t.uuid),this._bakedDuration=this._frames/o,this.setUseBaked(n)}},n.setUseBaked=function(t){t?(this._sampleCurves=this._sampleCurvesBaked,this.duration=this._bakedDuration):(this._sampleCurves=e.prototype._sampleCurves,this.duration=this.clip.duration,this._curvesInited||(this._curveLoaded=!1,e.prototype.initialize.call(this,this._targetNode),this._curvesInited=!0))},n.rebuildSocketCurves=function(e){if(this._sockets.length=0,this._targetNode)for(var t=this._targetNode,n=0;n<e.length;++n){var i=e[n],r=t.getChildByPath(i.path);if(i.target){for(var o=xJ.getOrExtract(this.clip),a=i.path,s=o.joints[a],c=r,l=void 0;!s;){var u=a.lastIndexOf("/");if(a=a.substring(0,u),s=o.joints[a],c&&(l||(l=kn.identity(Vpe)),kn.fromRTS(Hpe,c.rotation,c.position,c.scale),kn.multiply(l,Hpe,l),c=c.parent),u<0)break}for(var h=s&&s.transforms,_=o.frames,f=[],d=0;d<_;d++){var p;p=h&&l?kn.multiply(Hpe,h[d],l):h?h[d]:l||new kn;var m={pos:new yn,rot:new On,scale:new yn};kn.toRTS(p,m.rot,m.pos,m.scale),f.push(m)}this._sockets.push({target:i.target,frames:f})}}},n._setAnimInfoDirty=function(e,t){e.dirty=t},n._sampleCurvesBaked=function(e){var t=e/this.duration,n=this._animInfo,i=this.clip;n.currentClip!==i&&(this._animInfoMgr.switchClip(this._animInfo,i),this._parent.getUsers().forEach((function(e){e.uploadAnimation(i)})));var r=t*this._frames+.5|0;if(r!==n.data[0]){n.data[0]=r,this._setAnimInfoDirty(n,!0);for(var o=0;o<this._sockets.length;++o){var a=this._sockets[o],s=a.target,c=a.frames[r],l=c.pos,u=c.rot,h=c.scale;s.setRTS(u,l,h)}}},t}(o4)),jpe=e("Socket",(Epe=dc("cc.SkeletalAnimation.Socket"),Tpe=Jc(jb),Epe((Ape=T((bpe=function(e,t){void 0===e&&(e=""),void 0===t&&(t=null),E(this,"path",Ape,this),E(this,"target",wpe,this),this.path=e,this.target=t}).prototype,"path",[Ec,Nc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),wpe=T(bpe.prototype,"target",[Tpe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Cpe=bpe))||Cpe));Ke.setClassAlias(jpe,"cc.SkeletalAnimationComponent.Socket");var qpe=new kn,Xpe=new kn;function Ype(e,t,n){void 0===t&&(t=""),void 0===n&&(n=[]);for(var i=0;i<e.children.length;i++){var r=e.children[i];if(r){var o=t?t+"/"+r.name:r.name;n.push(o),Ype(r,o,n)}}return n}e("SkeletalAnimation",(Ipe=dc("cc.SkeletalAnimation"),Ppe=Oc(),Rpe=mc(99),Dpe=Ic(),Ope=Jc([jpe]),Npe=Bc(),Mpe=Bc(),Lpe=Jc([jpe]),Ipe(Fpe=Ppe(Fpe=Rpe(Fpe=wc(Fpe=Dpe((Gpe=kpe=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return E(t=e.call.apply(e,[this].concat(i))||this,"_useBakedAnimation",zpe,y(t)),E(t,"_sockets",Upe,y(t)),t._users=new Set,t._currentBakedState=null,t}f(t,e);var n=t.prototype;return n.onLoad=function(){e.prototype.onLoad.call(this);for(var t=this.node.getComponentsInChildren(JZ),n=0;n<t.length;++n){var i=t[n];i.skinningRoot===this.node&&this.notifySkinnedMeshAdded(i)}},n.onDestroy=function(){e.prototype.onDestroy.call(this),b.director.root.dataPoolManager.jointAnimationInfo.destroy(this.node.uuid),C2().removeSockets(this.node,this._sockets),this._removeAllUsers()},n.start=function(){this.sockets=this._sockets,this.useBakedAnimation=this._useBakedAnimation,e.prototype.start.call(this)},n.pause=function(){var t;this._useBakedAnimation?null===(t=this._currentBakedState)||void 0===t||t.pause():e.prototype.pause.call(this)},n.resume=function(){var t;this._useBakedAnimation?null===(t=this._currentBakedState)||void 0===t||t.resume():e.prototype.resume.call(this)},n.stop=function(){this._useBakedAnimation?this._currentBakedState&&(this._currentBakedState.stop(),this._currentBakedState=null):e.prototype.stop.call(this)},n.querySockets=function(){var e=this._defaultClip&&Object.keys(xJ.getOrExtract(this._defaultClip).joints).sort().reduce((function(e,t){return t.startsWith(e[e.length-1])||e.push(t),e}),[])||[];if(!e.length)return["please specify a valid default animation clip first"];for(var t=[],n=0;n<e.length;n++){var i=e[n],r=this.node.getChildByPath(i);r&&(t.push(i),Ype(r,i,t))}return t},n.rebuildSocketAnimations=function(){for(var e,t=S(this._sockets);!(e=t()).done;){var n=e.value,i=this.node.getChildByPath(n.path),r=n.target;i&&r&&(r.name=n.path.substring(n.path.lastIndexOf("/")+1)+" Socket",r.parent=this.node,EJ(i,this.node,qpe),kn.fromRTS(Xpe,r.rotation,r.position,r.scale),kn.equals(Xpe,qpe)||(r.matrix=qpe))}for(var o=0,a=Object.keys(this._nameToState);o<a.length;o++){var s=a[o];this._nameToState[s].rebuildSocketCurves(this._sockets)}},n.createSocket=function(e){var t=this._sockets.find((function(t){return t.path===e}));if(t)return t.target;if(!this.node.getChildByPath(e))return console.warn("illegal socket path"),null;var n=new jb;return n.parent=this.node,this._sockets.push(new jpe(e,n)),this.rebuildSocketAnimations(),n},n.notifySkinnedMeshAdded=function(e){var t=this._useBakedAnimation,n=e.associatedAnimation;if(n&&n._users.delete(e),e.associatedAnimation=this,e.setUseBakedAnimation(t,!0),t){var i=this._currentBakedState;i&&e.uploadAnimation(i.clip)}this._users.add(e)},n.notifySkinnedMeshRemoved=function(e){e.associatedAnimation===this||e.associatedAnimation,e.setUseBakedAnimation(!1),e.associatedAnimation=null,this._users.delete(e)},n.getUsers=function(){return this._users},n._createState=function(e,t){return new Wpe(e,t)},n._doCreateState=function(t,n){var i=e.prototype._doCreateState.call(this,t,n);return i.rebuildSocketCurves(this._sockets),i},n.doPlayOrCrossFade=function(t,n){if(this._useBakedAnimation){this._currentBakedState&&this._currentBakedState.stop();var i=t;this._currentBakedState=i,i.play()}else e.prototype.doPlayOrCrossFade.call(this,t,n)},n._removeAllUsers=function(){var e=this;Array.from(this._users).forEach((function(t){e.notifySkinnedMeshRemoved(t)}))},h(t,[{key:"sockets",get:function(){return this._sockets},set:function(e){if(!this._useBakedAnimation){var t=C2();t.removeSockets(this.node,this._sockets),t.addSockets(this.node,e)}this._sockets=e,this.rebuildSocketAnimations()}},{key:"useBakedAnimation",get:function(){return this._useBakedAnimation},set:function(e){for(var t in this._useBakedAnimation=e,this._nameToState)this._nameToState[t].setUseBaked(e);this._users.forEach((function(t){t.setUseBakedAnimation(e)})),this._useBakedAnimation?C2().removeSockets(this.node,this._sockets):(C2().addSockets(this.node,this._sockets),this._currentBakedState=null)}}]),t}(I4),kpe.Socket=jpe,T((Bpe=Gpe).prototype,"sockets",[Ope,Npe],Object.getOwnPropertyDescriptor(Bpe.prototype,"sockets"),Bpe.prototype),T(Bpe.prototype,"useBakedAnimation",[Mpe],Object.getOwnPropertyDescriptor(Bpe.prototype,"useBakedAnimation"),Bpe.prototype),zpe=T(Bpe.prototype,"_useBakedAnimation",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Upe=T(Bpe.prototype,"_sockets",[Lpe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Fpe=Bpe))||Fpe)||Fpe)||Fpe)||Fpe)||Fpe));var Kpe=function(){function e(){this.originalTarget=null,this.target=null,this.tag=e.TAG_INVALID}var t=e.prototype;return t.clone=function(){var t=new e;return t.originalTarget=null,t.target=null,t.tag=this.tag,t},t.isDone=function(){return!0},t.startWithTarget=function(e){this.originalTarget=e,this.target=e},t.stop=function(){this.target=null},t.step=function(){W(1006)},t.update=function(){W(1007)},t.getTarget=function(){return this.target},t.setTarget=function(e){this.target=e},t.getOriginalTarget=function(){return this.originalTarget},t.setOriginalTarget=function(e){this.originalTarget=e},t.getTag=function(){return this.tag},t.setTag=function(e){this.tag=e},t.reverse=function(){return W(1008),null},t.retain=function(){},t.release=function(){},e}();Kpe.TAG_INVALID=-1;var Qpe=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._duration=0,t._timesForRepeat=1,t}f(t,e);var n=t.prototype;return n.getDuration=function(){return this._duration*(this._timesForRepeat||1)},n.setDuration=function(e){this._duration=e},n.clone=function(){return new t},t}(Kpe),Jpe=(function(e){function t(t,n){var i;return void 0===n&&(n=1),(i=e.call(this)||this)._speed=0,i._innerAction=null,t&&i.initWithAction(t,n),i}f(t,e);var n=t.prototype;n.getSpeed=function(){return this._speed},n.setSpeed=function(e){this._speed=e},n.initWithAction=function(e,t){return e?(this._innerAction=e,this._speed=t,!0):(Y(1021),!1)},n.clone=function(){var e=new t;return e.initWithAction(this._innerAction.clone(),this._speed),e},n.startWithTarget=function(e){Kpe.prototype.startWithTarget.call(this,e),this._innerAction.startWithTarget(e)},n.stop=function(){this._innerAction.stop(),Kpe.prototype.stop.call(this)},n.step=function(e){this._innerAction.step(e*this._speed)},n.isDone=function(){return this._innerAction.isDone()},n.reverse=function(){return new t(this._innerAction.reverse(),this._speed)},n.setInnerAction=function(e){this._innerAction!==e&&(this._innerAction=e)},n.getInnerAction=function(){return this._innerAction}}(Kpe),0),Zpe=function(){this.actions=[],this.target=null,this.actionIndex=0,this.currentAction=null,this.paused=!1,this.lock=!1},$pe=function(){function e(){this._hashTargets=new Map,this._arrayTargets=[],this._elementPool=[]}var t=e.prototype;return t._searchElementByTarget=function(e,t){for(var n=0;n<e.length;n++)if(t===e[n].target)return e[n];return null},t._getElement=function(e,t){var n=this._elementPool.pop();return n||(n=new Zpe),n.target=e,n.paused=!!t,n},t._putElement=function(e){e.actions.length=0,e.actionIndex=0,e.currentAction=null,e.paused=!1,e.target=null,e.lock=!1,this._elementPool.push(e)},t.addAction=function(e,t,n){if(e&&t){null==t.uuid&&(t.uuid="_TWEEN_UUID_"+Jpe++);var i=this._hashTargets.get(t);i?i.actions||(i.actions=[]):(i=this._getElement(t,n),this._hashTargets.set(t,i),this._arrayTargets.push(i)),i.target=t,i.actions.push(e),e.startWithTarget(t)}else Y(1e3)},t.removeAllActions=function(){for(var e=this._arrayTargets,t=0;t<e.length;t++){var n=e[t];n&&this._putElement(n)}this._arrayTargets.length=0,this._hashTargets=new Map},t.removeAllActionsFromTarget=function(e){if(null!=e){var t=this._hashTargets.get(e);t&&(t.actions.length=0,this._deleteHashElement(t))}},t.removeAction=function(e){if(null!=e){var t=e.getOriginalTarget(),n=this._hashTargets.get(t);if(n)for(var i=0;i<n.actions.length;i++)if(n.actions[i]===e){n.actions.splice(i,1),n.actionIndex>=i&&n.actionIndex--;break}}},t._removeActionByTag=function(e,t,n){for(var i=0,r=t.actions.length;i<r;++i){var o=t.actions[i];if(o&&o.getTag()===e){if(n&&o.getOriginalTarget()!==n)continue;this._removeActionAtIndex(i,t);break}}},t._removeAllActionsByTag=function(e,t,n){for(var i=t.actions.length-1;i>=0;--i){var r=t.actions[i];if(r&&r.getTag()===e){if(n&&r.getOriginalTarget()!==n)continue;this._removeActionAtIndex(i,t)}}},t.removeActionByTag=function(e,t){var n=this;e===Kpe.TAG_INVALID&&W(1002);var i=this._hashTargets;if(t){var r=i.get(t);r&&this._removeActionByTag(e,r,t)}else i.forEach((function(t){n._removeActionByTag(e,t)}))},t.removeAllActionsByTag=function(e,t){var n=this;e===Kpe.TAG_INVALID&&W(1002);var i=this._hashTargets;if(t){var r=i.get(t);r&&this._removeAllActionsByTag(e,r,t)}else i.forEach((function(t){n._removeAllActionsByTag(e,t)}))},t.getActionByTag=function(e,t){e===Kpe.TAG_INVALID&&W(1004);var n=this._hashTargets.get(t);if(n){if(null!=n.actions)for(var i=0;i<n.actions.length;++i){var r=n.actions[i];if(r&&r.getTag()===e)return r}W(1005,e)}return null},t.getNumberOfRunningActionsInTarget=function(e){var t=this._hashTargets.get(e);return t&&t.actions?t.actions.length:0},t.pauseTarget=function(e){var t=this._hashTargets.get(e);t&&(t.paused=!0)},t.resumeTarget=function(e){var t=this._hashTargets.get(e);t&&(t.paused=!1)},t.pauseAllRunningActions=function(){for(var e=[],t=this._arrayTargets,n=0;n<t.length;n++){var i=t[n];i&&!i.paused&&(i.paused=!0,e.push(i.target))}return e},t.resumeTargets=function(e){if(e)for(var t=0;t<e.length;t++)e[t]&&this.resumeTarget(e[t])},t.pauseTargets=function(e){if(e)for(var t=0;t<e.length;t++)e[t]&&this.pauseTarget(e[t])},t.purgeSharedManager=function(){b.director.getScheduler().unscheduleUpdate(this)},t._removeActionAtIndex=function(e,t){t.actions[e],t.actions.splice(e,1),t.actionIndex>=e&&t.actionIndex--,0===t.actions.length&&this._deleteHashElement(t)},t._deleteHashElement=function(e){var t=!1;if(e&&!e.lock&&this._hashTargets.get(e.target)){this._hashTargets.delete(e.target);for(var n=this._arrayTargets,i=0,r=n.length;i<r;i++)if(n[i]===e){n.splice(i,1);break}this._putElement(e),t=!0}return t},t.update=function(e){for(var t,n=this._arrayTargets,i=0;i<n.length;i++){this._currentTarget=n[i];var r=(t=this._currentTarget).target;if(r instanceof ol&&!r.isValid)this.removeAllActionsFromTarget(r),i--;else{if(!t.paused&&t.actions){for(t.lock=!0,t.actionIndex=0;t.actionIndex<t.actions.length;t.actionIndex++)if(t.currentAction=t.actions[t.actionIndex],t.currentAction){if(t.currentAction.step(e*(t.currentAction._speedMethod?t.currentAction._speed:1)),t.currentAction&&t.currentAction.isDone()){t.currentAction.stop();var o=t.currentAction;t.currentAction=null,this.removeAction(o)}t.currentAction=null}t.lock=!1}0===t.actions.length&&this._deleteHashElement(t)&&i--}}},e}(),eme=e("TweenSystem",function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).actionMgr=new $pe,t}return f(t,e),t.prototype.update=function(e){this.actionMgr.update(e)},h(t,[{key:"ActionManager",get:function(){return this.actionMgr}}]),t}(GO));eme.ID="TWEEN",eme.instance=void 0,KO.on(YO.EVENT_INIT,(function(){var e=new eme;eme.instance=e,KO.registerSystem(eme.ID,e,GO.Priority.MEDIUM)}));var tme=function(e){function t(){return e.apply(this,arguments)||this}f(t,e);var n=t.prototype;return n.isDone=function(){return!0},n.step=function(){this.update(1)},n.update=function(){},n.reverse=function(){return this.clone()},n.clone=function(){return new t},t}(Qpe),nme=function(e){function t(){return e.apply(this,arguments)||this}f(t,e);var n=t.prototype;return n.update=function(){for(var e=this.target.getComponentsInChildren(jL),t=0;t<e.length;++t)e[t].enabled=!0},n.reverse=function(){return new ime},n.clone=function(){return new t},t}(tme),ime=function(e){function t(){return e.apply(this,arguments)||this}f(t,e);var n=t.prototype;return n.update=function(){for(var e=this.target.getComponentsInChildren(jL),t=0;t<e.length;++t)e[t].enabled=!1},n.reverse=function(){return new nme},n.clone=function(){return new t},t}(tme);!function(e){function t(){return e.apply(this,arguments)||this}f(t,e);var n=t.prototype;n.update=function(){for(var e=this.target.getComponentsInChildren(jL),t=0;t<e.length;++t){var n=e[t];n.enabled=!n.enabled}},n.reverse=function(){return new t},n.clone=function(){return new t}}(tme);var rme=function(e){function t(t){var n;return(n=e.call(this)||this)._isNeedCleanUp=!0,void 0!==t&&n.init(t),n}f(t,e);var n=t.prototype;return n.update=function(){this.target.removeFromParent(),this._isNeedCleanUp&&this.target.destroy()},n.init=function(e){return this._isNeedCleanUp=e,!0},n.reverse=function(){return new t(this._isNeedCleanUp)},n.clone=function(){return new t(this._isNeedCleanUp)},t}(tme),ome=function(e){function t(t,n,i){var r;return(r=e.call(this)||this)._selectorTarget=null,r._function=null,r._data=null,r.initWithFunction(t,n,i),r}f(t,e);var n=t.prototype;return n.initWithFunction=function(e,t,n){return e&&(this._function=e),t&&(this._selectorTarget=t),void 0!==n&&(this._data=n),!0},n.execute=function(){this._function&&this._function.call(this._selectorTarget,this.target,this._data)},n.update=function(){this.execute()},n.getTargetCallback=function(){return this._selectorTarget},n.setTargetCallback=function(e){e!==this._selectorTarget&&(this._selectorTarget&&(this._selectorTarget=null),this._selectorTarget=e)},n.clone=function(){var e=new t;return e.initWithFunction(this._function,this._selectorTarget,this._data),e},t}(tme),ame=function(e){function t(t){var n;return(n=e.call(this)||this).MAX_VALUE=2,n._elapsed=0,n._firstTick=!1,n._easeList=[],n._speed=1,n._repeatForever=!1,n._repeatMethod=!1,n._speedMethod=!1,void 0===t||isNaN(t)||n.initWithDuration(t),n}f(t,e);var n=t.prototype;return n.getElapsed=function(){return this._elapsed},n.initWithDuration=function(e){return this._duration=0===e?nt.FLT_EPSILON:e,this._elapsed=0,this._firstTick=!0,!0},n.isDone=function(){return this._elapsed>=this._duration},n._cloneDecoration=function(e){e._repeatForever=this._repeatForever,e._speed=this._speed,e._timesForRepeat=this._timesForRepeat,e._easeList=this._easeList,e._speedMethod=this._speedMethod,e._repeatMethod=this._repeatMethod},n._reverseEaseList=function(e){if(this._easeList){e._easeList=[];for(var t=0;t<this._easeList.length;t++)e._easeList.push(this._easeList[t])}},n.clone=function(){var e=new t(this._duration);return this._cloneDecoration(e),e},n.easing=function(e){this._easeList?this._easeList.length=0:this._easeList=[];for(var t=0;t<arguments.length;t++)this._easeList.push(arguments[t]);return this},n._computeEaseTime=function(e){return e},n.step=function(e){this._firstTick?(this._firstTick=!1,this._elapsed=0):this._elapsed+=e;var t=this._elapsed/(this._duration>1.192092896e-7?this._duration:1.192092896e-7);t=t<1?t:1,this.update(t>0?t:0),this._repeatMethod&&this._timesForRepeat>1&&this.isDone()&&(this._repeatForever||this._timesForRepeat--,this.startWithTarget(this.target),this.step(this._elapsed-this._duration))},n.startWithTarget=function(e){Kpe.prototype.startWithTarget.call(this,e),this._elapsed=0,this._firstTick=!0},n.reverse=function(){return W(1010),this},n.setAmplitudeRate=function(){W(1011)},n.getAmplitudeRate=function(){return W(1012),0},n.speed=function(e){return e<=0?(W(1013),this):(this._speedMethod=!0,this._speed*=e,this)},n.getSpeed=function(){return this._speed},n.setSpeed=function(e){return this._speed=e,this},n.repeat=function(e){return e=Math.round(e),isNaN(e)||e<1?(W(1014),this):(this._repeatMethod=!0,this._timesForRepeat*=e,this)},n.repeatForever=function(){return this._repeatMethod=!0,this._timesForRepeat=this.MAX_VALUE,this._repeatForever=!0,this},t}(Qpe),sme=function(e){function t(n){var i;(i=e.call(this)||this)._actions=[],i._split=0,i._last=0,i._reversed=!1;var r=n instanceof Array?n:arguments;if(1===r.length)return Y(1019),y(i);var o=r.length-1;if(o>=0&&null==r[o]&&W(1015),o>=0){for(var a,s=r[0],c=1;c<o;c++)r[c]&&(a=s,s=t._actionOneTwo(a,r[c]));i.initWithTwoActions(s,r[o])}return i}f(t,e);var n=t.prototype;return n.initWithTwoActions=function(e,t){if(!e||!t)return Y(1025),!1;var n=e._duration,i=t._duration,r=(n*=e._repeatMethod?e._timesForRepeat:1)+(i*=t._repeatMethod?t._timesForRepeat:1);return this.initWithDuration(r),this._actions[0]=e,this._actions[1]=t,!0},n.clone=function(){var e=new t;return this._cloneDecoration(e),e.initWithTwoActions(this._actions[0].clone(),this._actions[1].clone()),e},n.startWithTarget=function(e){ame.prototype.startWithTarget.call(this,e),this._split=this._actions[0]._duration/this._duration,this._split*=this._actions[0]._repeatMethod?this._actions[0]._timesForRepeat:1,this._last=-1},n.stop=function(){-1!==this._last&&this._actions[this._last].stop(),Kpe.prototype.stop.call(this)},n.update=function(e){var t,n,i=0,r=this._split,o=this._actions,a=this._last;(e=this._computeEaseTime(e))<r?(t=0!==r?e/r:1,0===i&&1===a&&this._reversed&&(o[1].update(0),o[1].stop())):(i=1,t=1===r?1:(e-r)/(1-r),-1===a&&(o[0].startWithTarget(this.target),o[0].update(1),o[0].stop()),0===a&&(o[0].update(1),o[0].stop())),n=o[i],a===i&&n.isDone()||(a!==i&&n.startWithTarget(this.target),t*=n._timesForRepeat,n.update(t>1?t%1:t),this._last=i)},n.reverse=function(){var e=t._actionOneTwo(this._actions[1].reverse(),this._actions[0].reverse());return this._cloneDecoration(e),this._reverseEaseList(e),e._reversed=!0,e},t}(ame);function cme(e){var t=e instanceof Array?e:arguments;if(1===t.length)return Y(1019),null;var n=t.length-1;n>=0&&null==t[n]&&W(1015);var i=null;if(n>=0){i=t[0];for(var r=1;r<=n;r++)t[r]&&(i=sme._actionOneTwo(i,t[r]))}return i}sme._actionOneTwo=function(e,t){var n=new sme;return n.initWithTwoActions(e,t),n};var lme=function(e){function t(t,n){var i;return(i=e.call(this)||this)._times=0,i._total=0,i._nextDt=0,i._actionInstant=!1,i._innerAction=null,void 0!==n&&i.initWithAction(t,n),i}f(t,e);var n=t.prototype;return n.initWithAction=function(e,t){var n=e._duration*t;return!!this.initWithDuration(n)&&(this._times=t,this._innerAction=e,e instanceof tme&&(this._actionInstant=!0,this._times-=1),this._total=0,!0)},n.clone=function(){var e=new t;return this._cloneDecoration(e),e.initWithAction(this._innerAction.clone(),this._times),e},n.startWithTarget=function(e){this._total=0,this._nextDt=this._innerAction._duration/this._duration,ame.prototype.startWithTarget.call(this,e),this._innerAction.startWithTarget(e)},n.stop=function(){this._innerAction.stop(),Kpe.prototype.stop.call(this)},n.update=function(e){e=this._computeEaseTime(e);var t=this._innerAction,n=this._duration,i=this._times,r=this._nextDt;if(e>=r){for(;e>r&&this._total<i;)t.update(1),this._total++,t.stop(),t.startWithTarget(this.target),r+=t._duration/n,this._nextDt=r>1?1:r;e>=1&&this._total<i&&(t.update(1),this._total++),this._actionInstant||(this._total===i?t.stop():t.update(e-(r-t._duration/n)))}else t.update(e*i%1)},n.isDone=function(){return this._total===this._times},n.reverse=function(){var e=new t(this._innerAction.reverse(),this._times);return this._cloneDecoration(e),this._reverseEaseList(e),e},n.setInnerAction=function(e){this._innerAction!==e&&(this._innerAction=e)},n.getInnerAction=function(){return this._innerAction},t}(ame),ume=function(e){function t(t){var n;return(n=e.call(this)||this)._innerAction=null,t&&n.initWithAction(t),n}f(t,e);var n=t.prototype;return n.initWithAction=function(e){return e?(this._innerAction=e,!0):(Y(1026),!1)},n.clone=function(){var e=new t;return this._cloneDecoration(e),e.initWithAction(this._innerAction.clone()),e},n.startWithTarget=function(e){ame.prototype.startWithTarget.call(this,e),this._innerAction.startWithTarget(e)},n.step=function(e){var t=this._innerAction;t.step(e),t.isDone()&&(t.startWithTarget(this.target),t.step(t.getElapsed()-t._duration))},n.isDone=function(){return!1},n.reverse=function(){var e=new t(this._innerAction.reverse());return this._cloneDecoration(e),this._reverseEaseList(e),e},n.setInnerAction=function(e){this._innerAction!==e&&(this._innerAction=e)},n.getInnerAction=function(){return this._innerAction},t}(ame),hme=function(e){function t(n){var i;(i=e.call(this)||this)._one=null,i._two=null;var r=n instanceof Array?n:arguments;if(1===r.length)return Y(1020),y(i);var o=r.length-1;if(o>=0&&null==r[o]&&W(1015),o>=0){for(var a,s=r[0],c=1;c<o;c++)r[c]&&(a=s,s=t._actionOneTwo(a,r[c]));i.initWithTwoActions(s,r[o])}return i}f(t,e);var n=t.prototype;return n.initWithTwoActions=function(e,t){if(!e||!t)return Y(1027),!1;var n=!1,i=e._duration,r=t._duration;return this.initWithDuration(Math.max(i,r))&&(this._one=e,this._two=t,i>r?this._two=sme._actionOneTwo(t,dme(i-r)):i<r&&(this._one=sme._actionOneTwo(e,dme(r-i))),n=!0),n},n.clone=function(){var e=new t;return this._cloneDecoration(e),e.initWithTwoActions(this._one.clone(),this._two.clone()),e},n.startWithTarget=function(e){ame.prototype.startWithTarget.call(this,e),this._one.startWithTarget(e),this._two.startWithTarget(e)},n.stop=function(){this._one.stop(),this._two.stop(),Kpe.prototype.stop.call(this)},n.update=function(e){e=this._computeEaseTime(e),this._one&&this._one.update(e),this._two&&this._two.update(e)},n.reverse=function(){var e=t._actionOneTwo(this._one.reverse(),this._two.reverse());return this._cloneDecoration(e),this._reverseEaseList(e),e},t}(ame);function _me(e){var t=e instanceof Array?e:arguments;if(1===t.length)return Y(1020),null;t.length>0&&null==t[t.length-1]&&W(1015);for(var n=t[0],i=1;i<t.length;i++)null!=t[i]&&(n=hme._actionOneTwo(n,t[i]));return n}hme._actionOneTwo=function(e,t){var n=new hme;return n.initWithTwoActions(e,t),n};var fme=function(e){function t(){return e.apply(this,arguments)||this}f(t,e);var n=t.prototype;return n.update=function(){},n.reverse=function(){var e=new t(this._duration);return this._cloneDecoration(e),this._reverseEaseList(e),e},n.clone=function(){var e=new t;return this._cloneDecoration(e),e.initWithDuration(this._duration),e},t}(ame);function dme(e){return new fme(e)}var pme,mme,vme,gme,yme,xme,Sme,Eme,Tme,Cme,bme,Ame,wme,Ime,Pme,Rme,Dme,Ome,Nme,Mme,Lme,Fme,Bme,zme,Ume,kme,Gme,Hme,Vme,Wme,jme,qme,Xme,Yme,Kme,Qme,Jme,Zme,$me,eve,tve,nve,ive,rve,ove,ave,sve,cve,lve,uve,hve,_ve,fve,dve,pve,mve,vve,gve,yve,xve,Sve=function(e){function t(t){var n;return(n=e.call(this)||this)._other=null,t&&n.initWithAction(t),n}f(t,e);var n=t.prototype;return n.initWithAction=function(e){return e?e===this._other?(Y(1029),!1):!!ame.prototype.initWithDuration.call(this,e._duration)&&(this._other=e,!0):(Y(1028),!1)},n.clone=function(){var e=new t;return this._cloneDecoration(e),e.initWithAction(this._other.clone()),e},n.startWithTarget=function(e){ame.prototype.startWithTarget.call(this,e),this._other.startWithTarget(e)},n.update=function(e){e=this._computeEaseTime(e),this._other&&this._other.update(1-e)},n.reverse=function(){return this._other.clone()},n.stop=function(){this._other.stop(),Kpe.prototype.stop.call(this)},t}(ame),Eve=e("TweenAction",function(e){function t(t,n,i){var r;if((r=e.call(this)||this)._opts=void 0,r._props=void 0,r._originProps=void 0,null==i)i=Object.create(null);else if(function(e){var t=" [Tween:] ",n=" option is not support in v + "+A,i=e;i.delay&&F(t+"delay"+n),i.repeat&&F(t+"repeat"+n),i.repeatDelay&&F(t+"repeatDelay"+n),i.interpolation&&F(t+"interpolation"+n),i.onStop&&F(t+"onStop"+n)}(i),i.easing&&"string"==typeof i.easing&&(i.easing=function(e){var t=e.charAt(0);if(/[A-Z]/.test(t)){var n=(e=e.replace(t,t.toLowerCase())).split("-");if(2===n.length){var i=n[0];if("linear"===i)e="linear";else{var r=n[1];switch(i){case"quadratic":e="quad"+r;break;case"quartic":e="quart"+r;break;case"quintic":e="quint"+r;break;case"sinusoidal":e="sine"+r;break;case"exponential":e="expo"+r;break;case"circular":e="circ"+r;break;default:e=i+r}}}}return e}(i.easing)),i.progress||(i.progress=r.progress),i.easing&&"string"==typeof i.easing){var o=i.easing;i.easing=G_[o],i.easing||q(1031,o)}for(var a in r._opts=i,r._props=Object.create(null),n)if(n.hasOwnProperty(a)){var s=n[a];if("function"==typeof s&&(s=s()),null!=s&&"string"!=typeof s){var c=void 0,l=void 0;void 0!==s.value&&(s.easing||s.progress)&&("string"==typeof s.easing?(c=G_[s.easing])||q(1031,s.easing):c=s.easing,l=s.progress,s=s.value);var u=Object.create(null);u.value=s,u.easing=c,u.progress=l,r._props[a]=u}}return r._originProps=n,r.initWithDuration(t),r}f(t,e);var n=t.prototype;return n.clone=function(){var e=new t(this._duration,this._originProps,this._opts);return this._cloneDecoration(e),e},n.startWithTarget=function(e){ame.prototype.startWithTarget.call(this,e);var t=!!this._opts.relative,n=this._props;for(var i in n){var r=e[i];if(void 0!==r){var o=n[i],a=o.value;if("number"==typeof r)o.start=r,o.current=r,o.end=t?r+a:a;else if("object"==typeof r)for(var s in null==o.start&&(o.start={},o.current={},o.end={}),a)isNaN(r[s])||(o.start[s]=r[s],o.current[s]=r[s],o.end[s]=t?r[s]+a[s]:a[s])}}this._opts.onStart&&this._opts.onStart(this.target)},n.update=function(e){var t=this.target;if(t){var n=this._props,i=this._opts,r=e;i.easing&&(r=i.easing(e));var o=i.progress;for(var a in n){var s=n[a],c=s.easing?s.easing(e):r,l=s.progress?s.progress:o,u=s.start,h=s.end;if("number"==typeof u)s.current=l(u,h,s.current,c);else if("object"==typeof u)for(var _ in u)s.current[_]=l(u[_],h[_],s.current[_],c);t[a]=s.current}i.onUpdate&&i.onUpdate(this.target,e),1===e&&i.onComplete&&i.onComplete(this.target)}},n.progress=function(e,t,n,i){return e+(t-e)*i},t}(ame)),Tve=function(e){function t(t){var n;return(n=e.call(this)||this)._props=void 0,n._props={},void 0!==t&&n.init(t),n}f(t,e);var n=t.prototype;return n.init=function(e){for(var t in e)this._props[t]=e[t];return!0},n.update=function(){var e=this._props,t=this.target;for(var n in e)t[n]=e[n]},n.clone=function(){var e=new t;return e.init(this._props),e},t}(tme),Cve=e("Tween",function(){function e(e){this._actions=[],this._finalAction=null,this._target=null,this._tag=Kpe.TAG_INVALID,this._target=void 0===e?null:e}var t=e.prototype;return t.tag=function(e){return this._tag=e,this},t.then=function(e){return e instanceof Kpe?this._actions.push(e.clone()):this._actions.push(e._union()),this},t.target=function(e){return this._target=e,this},t.start=function(){return this._target?(this._finalAction&&eme.instance.ActionManager.removeAction(this._finalAction),this._finalAction=this._union(),this._finalAction.setTag(this._tag),eme.instance.ActionManager.addAction(this._finalAction,this._target,!1),this):(F("Please set target to tween first"),this)},t.stop=function(){return this._finalAction&&eme.instance.ActionManager.removeAction(this._finalAction),this},t.clone=function(e){var t=this._union();return bve(e).then(t.clone())},t.union=function(){var e=this._union();return this._actions.length=0,this._actions.push(e),this},t.to=function(e,t,n){(n=n||Object.create(null)).relative=!1;var i=new Eve(e,t,n);return this._actions.push(i),this},t.by=function(e,t,n){(n=n||Object.create(null)).relative=!0;var i=new Eve(e,t,n);return this._actions.push(i),this},t.set=function(e){var t=new Tve(e);return this._actions.push(t),this},t.delay=function(e){var t=dme(e);return this._actions.push(t),this},t.call=function(e){var t=function(e){return new ome(e,void 0,void 0)}(e);return this._actions.push(t),this},t.sequence=function(){var t=e._wrappedSequence.apply(e,arguments);return this._actions.push(t),this},t.parallel=function(){var t=e._wrappedParallel.apply(e,arguments);return this._actions.push(t),this},t.repeat=function(t,n){if(t===1/0)return this.repeatForever(n);var i,r=this._actions;return i=n instanceof e?n._union():r.pop(),r.push(function(e,t){return new lme(e,t)}(i,t)),this},t.repeatForever=function(t){var n,i=this._actions;return n=t instanceof e?t._union():i.pop(),i.push(function(e){return new ume(e)}(n)),this},t.reverseTime=function(t){var n,i=this._actions;return n=t instanceof e?t._union():i.pop(),i.push(function(e){return new Sve(e)}(n)),this},t.hide=function(){var e=new ime;return this._actions.push(e),this},t.show=function(){var e=new nme;return this._actions.push(e),this},t.removeSelf=function(){var e=new rme(!1);return this._actions.push(e),this},e.stopAll=function(){eme.instance.ActionManager.removeAllActions()},e.stopAllByTag=function(e,t){eme.instance.ActionManager.removeAllActionsByTag(e,t)},e.stopAllByTarget=function(e){eme.instance.ActionManager.removeAllActionsFromTarget(e)},t._union=function(){var e=this._actions;return 1===e.length?e[0]:cme(e)},t._destroy=function(){this.stop()},e._wrappedSequence=function(){var t=e._tmp_args;t.length=0;for(var n=arguments.length,i=0;i<n;i++){var r=t[i]=i<0||arguments.length<=i?void 0:arguments[i];r instanceof e&&(t[i]=r._union())}return cme.apply(cme,t)},e._wrappedParallel=function(){var t=e._tmp_args;t.length=0;for(var n=arguments.length,i=0;i<n;i++){var r=t[i]=i<0||arguments.length<=i?void 0:arguments[i];r instanceof e&&(t[i]=r._union())}return _me.apply(_me,t)},e}());function bve(e){return new Cve(e)}function Ave(e){return F("tweenUtil' is deprecated, please use 'tween' instead "),new Cve(e)}Cve._tmp_args=[],b.Tween=Cve,b.tween=bve,b.tweenUtil=Ave;var wve,Ive,Pve,Rve=new Qn;!function(e){e[e.NONE=0]="NONE",e[e.COLOR=1]="COLOR",e[e.SPRITE=2]="SPRITE",e[e.SCALE=3]="SCALE"}(wve||(wve={})),et(wve),function(e){e.NORMAL="normal",e.HOVER="hover",e.PRESSED="pressed",e.DISABLED="disabled"}(Ive||(Ive={})),function(e){e.CLICK="click"}(Pve||(Pve={}));var Dve=e("Button",(pme=dc("cc.Button"),mme=Oc(),vme=mc(110),gme=Ic(),yme=pc(zB),xme=Jc(jb),Sme=Vc(),Eme=Bc(),Tme=Vc(),Cme=Bc(),bme=Jc(wve),Ame=Vc(),wme=Bc(),Ime=Vc(),Pme=Bc(),Rme=Vc(),Dme=Bc(),Ome=Vc(),Nme=Bc(),Mme=Vc(),Lme=Bc(),Fme=Uc(),Bme=kc(),zme=Vc(),Ume=Bc(),kme=Vc(),Gme=Bc(),Hme=Jc(cF),Vme=Vc(),Wme=Bc(),jme=Jc(cF),qme=Vc(),Xme=Bc(),Yme=Jc(cF),Kme=Vc(),Qme=Bc(),Jme=Jc(cF),Zme=Vc(),$me=Bc(),eve=Jc([AL]),tve=Vc(),nve=Bc(),pme(ive=mme(ive=vme(ive=gme(ive=yme(ive=wc((xve=yve=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return E(t=e.call.apply(e,[this].concat(i))||this,"clickEvents",ove,y(t)),E(t,"_interactable",ave,y(t)),E(t,"_transition",sve,y(t)),E(t,"_normalColor",cve,y(t)),E(t,"_hoverColor",lve,y(t)),E(t,"_pressedColor",uve,y(t)),E(t,"_disabledColor",hve,y(t)),E(t,"_normalSprite",_ve,y(t)),E(t,"_hoverSprite",fve,y(t)),E(t,"_pressedSprite",dve,y(t)),E(t,"_disabledSprite",pve,y(t)),E(t,"_duration",mve,y(t)),E(t,"_zoomScale",vve,y(t)),E(t,"_target",gve,y(t)),t._pressed=!1,t._hovered=!1,t._fromColor=new Qn,t._toColor=new Qn,t._time=0,t._transitionFinished=!0,t._fromScale=new yn,t._toScale=new yn,t._originalScale=null,t._sprite=null,t._targetScale=new yn,t}f(t,e);var n=t.prototype;return n.__preload=function(){this.target||(this.target=this.node);var e=this.node.getComponent(nH);e&&(this._normalSprite=e.spriteFrame),this._applyTarget(),this._resetState()},n.onEnable=function(){this._registerNodeEvent()},n.onDisable=function(){this._resetState(),this._unregisterNodeEvent()},n.onDestroy=function(){this.target.isValid&&this._unregisterTargetEvent(this.target)},n.update=function(e){var t=this.target;if(!this._transitionFinished&&t&&(this._transition===wve.COLOR||this._transition===wve.SCALE)){this._time+=e;var n=1;if(this._duration>0&&(n=this._time/this._duration),n>=1&&(n=1),this._transition===wve.COLOR){var i=t._uiProps.uiComp;Qn.lerp(Rve,this._fromColor,this._toColor,n),i&&(i.color=Rve)}else this.transition===wve.SCALE&&(t.getScale(this._targetScale),this._targetScale.x=nn(this._fromScale.x,this._toScale.x,n),this._targetScale.y=nn(this._fromScale.y,this._toScale.y,n),t.setScale(this._targetScale));1===n&&(this._transitionFinished=!0)}},n._resizeNodeToTargetNode=function(){this.target&&this.target._uiProps.uiTransformComp},n._resetState=function(){this._pressed=!1,this._hovered=!1;var e=this.target;if(e){var t=this._transition;if(t===wve.COLOR&&this._interactable){var n=e.getComponent(EU);n&&(n.color=this._normalColor)}else t===wve.SCALE&&this._originalScale&&e.setScale(this._originalScale);this._transitionFinished=!0}},n._registerNodeEvent=function(){this.node.on(VT.TOUCH_START,this._onTouchBegan,this),this.node.on(VT.TOUCH_MOVE,this._onTouchMove,this),this.node.on(VT.TOUCH_END,this._onTouchEnded,this),this.node.on(VT.TOUCH_CANCEL,this._onTouchCancel,this),this.node.on(VT.MOUSE_ENTER,this._onMouseMoveIn,this),this.node.on(VT.MOUSE_LEAVE,this._onMouseMoveOut,this)},n._registerTargetEvent=function(e){e.on(VT.TRANSFORM_CHANGED,this._onTargetTransformChanged,this)},n._unregisterNodeEvent=function(){this.node.off(VT.TOUCH_START,this._onTouchBegan,this),this.node.off(VT.TOUCH_MOVE,this._onTouchMove,this),this.node.off(VT.TOUCH_END,this._onTouchEnded,this),this.node.off(VT.TOUCH_CANCEL,this._onTouchCancel,this),this.node.off(VT.MOUSE_ENTER,this._onMouseMoveIn,this),this.node.off(VT.MOUSE_LEAVE,this._onMouseMoveOut,this)},n._unregisterTargetEvent=function(e){e.off(VT.TRANSFORM_CHANGED)},n._getTargetSprite=function(e){var t=null;return e&&(t=e.getComponent(nH)),t},n._applyTarget=function(){this.target&&(this._sprite=this._getTargetSprite(this.target),this._originalScale||(this._originalScale=new yn),yn.copy(this._originalScale,this.target.getScale()),this._registerTargetEvent(this.target))},n._onTargetSpriteFrameChanged=function(e){this._transition===wve.SPRITE&&this._setCurrentStateSpriteFrame(e.spriteFrame)},n._setCurrentStateSpriteFrame=function(e){if(e)switch(this._getButtonState()){case Ive.NORMAL:this._normalSprite=e;break;case Ive.HOVER:this._hoverSprite=e;break;case Ive.PRESSED:this._pressedSprite=e;break;case Ive.DISABLED:this._disabledSprite=e}},n._onTargetColorChanged=function(e){this._transition===wve.COLOR&&this._setCurrentStateColor(e)},n._setCurrentStateColor=function(e){switch(this._getButtonState()){case Ive.NORMAL:this._normalColor=e;break;case Ive.HOVER:this._hoverColor=e;break;case Ive.PRESSED:this._pressedColor=e;break;case Ive.DISABLED:this._disabledColor=e}},n._onTargetTransformChanged=function(e){e&Zg.SCALE&&this._originalScale&&this._transition===wve.SCALE&&this._transitionFinished&&yn.copy(this._originalScale,this.target.getScale())},n._onTouchBegan=function(e){this._interactable&&this.enabledInHierarchy&&(this._pressed=!0,this._updateState(),e&&(e.propagationStopped=!0))},n._onTouchMove=function(e){if(this._interactable&&this.enabledInHierarchy&&this._pressed&&e){var t=e.touch;if(t){var n,i=this.node._uiProps.uiTransformComp.hitTest(t.getLocation());this._transition===wve.SCALE&&this.target&&this._originalScale?i?(yn.copy(this._fromScale,this._originalScale),yn.multiplyScalar(this._toScale,this._originalScale,this._zoomScale),this._transitionFinished=!1):(this._time=0,this._transitionFinished=!0,this.target.setScale(this._originalScale)):(n=i?Ive.PRESSED:Ive.NORMAL,this._applyTransition(n)),e&&(e.propagationStopped=!0)}}},n._onTouchEnded=function(e){this._interactable&&this.enabledInHierarchy&&(this._pressed&&(AL.emitEvents(this.clickEvents,e),this.node.emit(Pve.CLICK,this)),this._pressed=!1,this._updateState(),e&&(e.propagationStopped=!0))},n._onTouchCancel=function(){this._interactable&&this.enabledInHierarchy&&(this._pressed=!1,this._updateState())},n._onMouseMoveIn=function(){!this._pressed&&this.interactable&&this.enabledInHierarchy&&(this._transition!==wve.SPRITE||this._hoverSprite)&&(this._hovered||(this._hovered=!0,this._updateState()))},n._onMouseMoveOut=function(){this._hovered&&(this._hovered=!1,this._updateState())},n._updateState=function(){var e=this._getButtonState();this._applyTransition(e)},n._getButtonState=function(){var e=Ive.NORMAL;return this._interactable?this._pressed?e=Ive.PRESSED:this._hovered&&(e=Ive.HOVER):e=Ive.DISABLED,e.toString()},n._updateColorTransition=function(e){var t,n=this[e+"Color"],i=null===(t=this.target)||void 0===t?void 0:t.getComponent(EU);i&&(e===Ive.DISABLED?i.color=n:(this._fromColor=i.color.clone(),this._toColor=n,this._time=0,this._transitionFinished=!1))},n._updateSpriteTransition=function(e){var t=this[e+"Sprite"];this._sprite&&t&&(this._sprite.spriteFrame=t)},n._updateScaleTransition=function(e){this._interactable&&(e===Ive.PRESSED?this._zoomUp():this._zoomBack())},n._zoomUp=function(){this._originalScale&&(yn.copy(this._fromScale,this._originalScale),yn.multiplyScalar(this._toScale,this._originalScale,this._zoomScale),this._time=0,this._transitionFinished=!1)},n._zoomBack=function(){this.target&&this._originalScale&&(yn.copy(this._fromScale,this.target.getScale()),yn.copy(this._toScale,this._originalScale),this._time=0,this._transitionFinished=!1)},n._applyTransition=function(e){var t=this._transition;t===wve.COLOR?this._updateColorTransition(e):t===wve.SPRITE?this._updateSpriteTransition(e):t===wve.SCALE&&this._updateScaleTransition(e)},h(t,[{key:"target",get:function(){return this._target||this.node},set:function(e){this._target!==e&&(this._target&&this._unregisterTargetEvent(this._target),this._target=e,this._applyTarget())}},{key:"interactable",get:function(){return this._interactable},set:function(e){this._interactable!==e&&(this._interactable=e,this._updateState(),this._interactable||this._resetState())}},{key:"_resizeToTarget",set:function(e){e&&this._resizeNodeToTargetNode()}},{key:"transition",get:function(){return this._transition},set:function(e){this._transition!==e&&(this._transition===wve.COLOR?this._updateColorTransition(Ive.NORMAL):this._transition===wve.SPRITE&&this._updateSpriteTransition(Ive.NORMAL),this._transition=e,this._updateState())}},{key:"normalColor",get:function(){return this._normalColor},set:function(e){this._normalColor!==e&&(this._normalColor.set(e),this._updateState())}},{key:"pressedColor",get:function(){return this._pressedColor},set:function(e){this._pressedColor!==e&&this._pressedColor.set(e)}},{key:"hoverColor",get:function(){return this._hoverColor},set:function(e){this._hoverColor!==e&&this._hoverColor.set(e)}},{key:"disabledColor",get:function(){return this._disabledColor},set:function(e){this._disabledColor!==e&&(this._disabledColor.set(e),this._updateState())}},{key:"duration",get:function(){return this._duration},set:function(e){this._duration!==e&&(this._duration=e)}},{key:"zoomScale",get:function(){return this._zoomScale},set:function(e){this._zoomScale!==e&&(this._zoomScale=e)}},{key:"normalSprite",get:function(){return this._normalSprite},set:function(e){if(this._normalSprite!==e){this._normalSprite=e;var t=this.node.getComponent(nH);t&&(t.spriteFrame=e),this._updateState()}}},{key:"pressedSprite",get:function(){return this._pressedSprite},set:function(e){this._pressedSprite!==e&&(this._pressedSprite=e,this._updateState())}},{key:"hoverSprite",get:function(){return this._hoverSprite},set:function(e){this._hoverSprite!==e&&(this._hoverSprite=e,this._updateState())}},{key:"disabledSprite",get:function(){return this._disabledSprite},set:function(e){this._disabledSprite!==e&&(this._disabledSprite=e,this._updateState())}}]),t}(ku),yve.Transition=wve,yve.EventType=Pve,T((rve=xve).prototype,"target",[xme,Sme,Eme],Object.getOwnPropertyDescriptor(rve.prototype,"target"),rve.prototype),T(rve.prototype,"interactable",[Tme,Cme],Object.getOwnPropertyDescriptor(rve.prototype,"interactable"),rve.prototype),T(rve.prototype,"transition",[bme,Ame,wme],Object.getOwnPropertyDescriptor(rve.prototype,"transition"),rve.prototype),T(rve.prototype,"normalColor",[Ime,Pme],Object.getOwnPropertyDescriptor(rve.prototype,"normalColor"),rve.prototype),T(rve.prototype,"pressedColor",[Rme,Dme],Object.getOwnPropertyDescriptor(rve.prototype,"pressedColor"),rve.prototype),T(rve.prototype,"hoverColor",[Ome,Nme],Object.getOwnPropertyDescriptor(rve.prototype,"hoverColor"),rve.prototype),T(rve.prototype,"disabledColor",[Mme,Lme],Object.getOwnPropertyDescriptor(rve.prototype,"disabledColor"),rve.prototype),T(rve.prototype,"duration",[Fme,Bme,zme,Ume],Object.getOwnPropertyDescriptor(rve.prototype,"duration"),rve.prototype),T(rve.prototype,"zoomScale",[kme,Gme],Object.getOwnPropertyDescriptor(rve.prototype,"zoomScale"),rve.prototype),T(rve.prototype,"normalSprite",[Hme,Vme,Wme],Object.getOwnPropertyDescriptor(rve.prototype,"normalSprite"),rve.prototype),T(rve.prototype,"pressedSprite",[jme,qme,Xme],Object.getOwnPropertyDescriptor(rve.prototype,"pressedSprite"),rve.prototype),T(rve.prototype,"hoverSprite",[Yme,Kme,Qme],Object.getOwnPropertyDescriptor(rve.prototype,"hoverSprite"),rve.prototype),T(rve.prototype,"disabledSprite",[Jme,Zme,$me],Object.getOwnPropertyDescriptor(rve.prototype,"disabledSprite"),rve.prototype),ove=T(rve.prototype,"clickEvents",[eve,Ec,tve,nve],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),ave=T(rve.prototype,"_interactable",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),sve=T(rve.prototype,"_transition",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return wve.NONE}}),cve=T(rve.prototype,"_normalColor",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Qn.WHITE.clone()}}),lve=T(rve.prototype,"_hoverColor",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Qn(211,211,211,255)}}),uve=T(rve.prototype,"_pressedColor",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Qn.WHITE.clone()}}),hve=T(rve.prototype,"_disabledColor",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Qn(124,124,124,255)}}),_ve=T(rve.prototype,"_normalSprite",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),fve=T(rve.prototype,"_hoverSprite",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),dve=T(rve.prototype,"_pressedSprite",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),pve=T(rve.prototype,"_disabledSprite",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),mve=T(rve.prototype,"_duration",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),vve=T(rve.prototype,"_zoomScale",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1.2}}),gve=T(rve.prototype,"_target",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),ive=rve))||ive)||ive)||ive)||ive)||ive)||ive));b.Button=Dve;var Ove,Nve,Mve,Lve=function(){function e(){}return e.add=function(e){var t=this._tabIndexList;-1===t.indexOf(e)&&t.push(e)},e.remove=function(e){var t=this._tabIndexList,n=t.indexOf(e);-1!==n&&t.splice(n,1)},e.resort=function(){this._tabIndexList.sort((function(e,t){return e._delegate.tabIndex-t._delegate.tabIndex}))},e.next=function(e){var t=this._tabIndexList,n=t.indexOf(e);if(e.setFocus(!1),-1!==n){var i=t[n+1];i&&i._delegate.tabIndex>=0&&i.setFocus(!0)}},e}();Lve._tabIndexList=[],function(e){e[e.DEFAULT=0]="DEFAULT",e[e.DONE=1]="DONE",e[e.SEND=2]="SEND",e[e.SEARCH=3]="SEARCH",e[e.GO=4]="GO",e[e.NEXT=5]="NEXT"}(Ove||(Ove={})),Je(Ove),function(e){e[e.ANY=0]="ANY",e[e.EMAIL_ADDR=1]="EMAIL_ADDR",e[e.NUMERIC=2]="NUMERIC",e[e.PHONE_NUMBER=3]="PHONE_NUMBER",e[e.URL=4]="URL",e[e.DECIMAL=5]="DECIMAL",e[e.SINGLE_LINE=6]="SINGLE_LINE"}(Nve||(Nve={})),Je(Nve),function(e){e[e.PASSWORD=0]="PASSWORD",e[e.SENSITIVE=1]="SENSITIVE",e[e.INITIAL_CAPS_WORD=2]="INITIAL_CAPS_WORD",e[e.INITIAL_CAPS_SENTENCE=3]="INITIAL_CAPS_SENTENCE",e[e.INITIAL_CAPS_ALL_CHARACTERS=4]="INITIAL_CAPS_ALL_CHARACTERS",e[e.DEFAULT=5]="DEFAULT"}(Mve||(Mve={})),Je(Mve);var Fve,Bve,zve,Uve,kve,Gve,Hve,Vve,Wve,jve,qve,Xve,Yve,Kve,Qve,Jve,Zve,$ve,ege,tge,nge,ige,rge,oge,age,sge,cge,lge,uge,hge,_ge,fge,dge,pge,mge,vge,gge,yge,xge,Sge,Ege,Tge,Cge,bge,Age,wge,Ige,Pge,Rge,Dge,Oge,Nge,Mge,Lge,Fge,Bge,zge,Uge,kge,Gge,Hge,Vge=function(){function e(){this._editing=!1,this._delegate=null}var t=e.prototype;return t.init=function(){},t.onEnable=function(){},t.update=function(){},t.onDisable=function(){this._editing&&this.endEditing()},t.clear=function(){this._delegate=null},t.setTabIndex=function(){},t.setSize=function(){},t.setFocus=function(e){e?this.beginEditing():this.endEditing()},t.isFocused=function(){return this._editing},t.beginEditing=function(){},t.endEditing=function(){},e}(),Wge=new kn,jge=new kn,qge=new yn,Xge=null,Yge=0,Kge=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._delegate=null,t._inputMode=-1,t._inputFlag=-1,t._returnType=-1,t.__eventListeners={},t.__autoResize=!1,t.__orientationChanged=void 0,t._edTxt=null,t._isTextArea=!1,t._textLabelFont=null,t._textLabelFontSize=null,t._textLabelFontColor=null,t._textLabelAlign=null,t._placeholderLabelFont=null,t._placeholderLabelFontSize=null,t._placeholderLabelFontColor=null,t._placeholderLabelAlign=null,t._placeholderLineHeight=null,t._placeholderStyleSheet=null,t._domId="EditBoxId_"+ ++Yge,t}f(t,e);var n=t.prototype;return n.init=function(e){e&&(this._delegate=e,e.inputMode===Nve.ANY?this._createTextArea():this._createInput(),Lve.add(this),this.setTabIndex(e.tabIndex),this._initStyleSheet(),this._registerEventListeners(),this._addDomToGameContainer())},n.clear=function(){this._removeEventListeners(),this._removeDomFromGameContainer(),Lve.remove(this),Xge===this&&(Xge=null),this._delegate=null},n.update=function(){this._updateMatrix()},n.setTabIndex=function(e){this._edTxt.tabIndex=e,Lve.resort()},n.setSize=function(e,t){var n=this._edTxt;n&&(n.style.width=e+"px",n.style.height=t+"px")},n.beginEditing=function(){Xge&&Xge!==this&&Xge.setFocus(!1),this._editing=!0,Xge=this,this._delegate._editBoxEditingDidBegan(),this._showDom(),this._edTxt.focus()},n.endEditing=function(){this._edTxt.blur()},n._createInput=function(){this._isTextArea=!1,this._edTxt=document.createElement("input")},n._createTextArea=function(){this._isTextArea=!0,this._edTxt=document.createElement("textarea")},n._addDomToGameContainer=function(){b.GAME_VIEW&&this._edTxt?(b.gameView.container.appendChild(this._edTxt),b.gameView.head.appendChild(this._placeholderStyleSheet)):PO.container&&this._edTxt&&(PO.container.appendChild(this._edTxt),document.head.appendChild(this._placeholderStyleSheet))},n._removeDomFromGameContainer=function(){(b.GAME_VIEW?ut(b.gameView.container,this._edTxt):ut(PO.container,this._edTxt))&&this._edTxt&&(b.GAME_VIEW?b.gameView.container.removeChild(this._edTxt):PO.container.removeChild(this._edTxt)),(b.GAME_VIEW?ut(b.gameView.head,this._placeholderStyleSheet):ut(document.head,this._placeholderStyleSheet))&&(b.GAME_VIEW?b.gameView.head.removeChild(this._placeholderStyleSheet):document.head.removeChild(this._placeholderStyleSheet)),this._edTxt=null,this._placeholderStyleSheet=null},n._showDom=function(){this._updateMaxLength(),this._updateInputType(),this._updateStyleSheet(),this._edTxt&&this._delegate&&(this._edTxt.style.display="",this._delegate._hideLabels()),Qu.isMobile&&this._showDomOnMobile()},n._hideDom=function(){var e=this._edTxt;e&&this._delegate&&(e.style.display="none",this._delegate._showLabels()),Qu.isMobile&&this._hideDomOnMobile()},n._showDomOnMobile=function(){Qu.os!==Yl.ANDROID&&Qu.os!==Yl.OHOS||(Xu.handleResizeEvent=!1,this._adjustWindowScroll())},n._hideDomOnMobile=function(){Qu.os!==Yl.ANDROID&&Qu.os!==Yl.OHOS||(Xu.handleResizeEvent=!0),this._scrollBackWindow()},n._adjustWindowScroll=function(){var e=this;setTimeout((function(){window.scrollY<40&&e._edTxt.scrollIntoView({block:"start",inline:"nearest",behavior:"smooth"})}),400)},n._scrollBackWindow=function(){setTimeout((function(){Qu.browserType!==jl.WECHAT||Qu.os!==Yl.IOS?window.scrollTo(0,0):window.top&&window.top.scrollTo(0,0)}),400)},n._updateMatrix=function(){if(this._edTxt){var e=this._delegate.node,t=BO.getScaleX(),n=BO.getScaleY(),i=1,r=1;b.GAME_VIEW&&(i=b.gameView.canvas.width/b.game.canvas.width,r=b.gameView.canvas.height/b.game.canvas.height),t*=i,n*=r;var o=BO.getViewportRect(),a=Xu.devicePixelRatio;e.getWorldMatrix(Wge);var s=e._uiProps.uiTransformComp;if(s&&yn.set(qge,-s.anchorX*s.width,-s.anchorY*s.height,qge.z),kn.transform(Wge,Wge,qge),e._uiProps.uiTransformComp){var c=KO.root.batcher2D.getFirstRenderCamera(e);if(c){c.node.getWorldRT(jge);var l=jge.m12,u=jge.m13,h=tO.center;jge.m12=h.x-(jge.m00*l+jge.m04*u),jge.m13=h.y-(jge.m01*l+jge.m05*u),kn.multiply(jge,jge,Wge),t/=a,n/=a;var _=b.GAME_VIEW?b.gameView.container:PO.container,f=jge.m00*t,d=Wge.m01,p=Wge.m04,m=jge.m05*n,v=parseInt(_&&_.style.paddingLeft||"0");v+=o.x*i/a;var g=parseInt(_&&_.style.paddingBottom||"0");g+=o.y/a;var y="matrix("+f+","+-d+","+-p+","+m+","+(jge.m12*t+v)+","+-(jge.m13*n+g)+")";this._edTxt.style.transform=y,this._edTxt.style["-webkit-transform"]=y,this._edTxt.style["transform-origin"]="0px 100% 0px",this._edTxt.style["-webkit-transform-origin"]="0px 100% 0px"}}}},n._updateInputType=function(){var e=this._delegate,t=e.inputMode,n=e.inputFlag,i=e.returnType,r=this._edTxt;if(this._inputMode!==t||this._inputFlag!==n||this._returnType!==i){if(this._inputMode=t,this._inputFlag=n,this._returnType=i,this._isTextArea){var o="none";return n===Mve.INITIAL_CAPS_ALL_CHARACTERS?o="uppercase":n===Mve.INITIAL_CAPS_WORD&&(o="capitalize"),void(r.style.textTransform=o)}if(r=r,n===Mve.PASSWORD)return r.type="password",void(r.style.textTransform="none");var a=r.type;t===Nve.EMAIL_ADDR?a="email":t===Nve.NUMERIC||t===Nve.DECIMAL?a="number":t===Nve.PHONE_NUMBER?(a="number",r.pattern="[0-9]*",r.addEventListener("wheel",(function(){return!1}))):t===Nve.URL?a="url":(a="text",i===Ove.SEARCH&&(a="search")),r.type=a;var s="none";n===Mve.INITIAL_CAPS_ALL_CHARACTERS?s="uppercase":n===Mve.INITIAL_CAPS_WORD&&(s="capitalize"),r.style.textTransform=s}},n._updateMaxLength=function(){var e=this._delegate.maxLength;e<0&&(e=65535),this._edTxt.maxLength=e},n._initStyleSheet=function(){if(this._edTxt){var e=this._edTxt;e.style.color="#000000",e.style.border="0px",e.style.background="transparent",e.style.width="100%",e.style.height="100%",e.style.outline="medium",e.style.padding="0",e.style.textTransform="none",e.style.display="none",e.style.position="absolute",e.style.bottom="0px",e.style.left="2px",e.className="cocosEditBox",e.style.fontFamily="Arial",e.id=this._domId,this._isTextArea?(e.style.resize="none",e.style.overflowY="scroll"):((e=e).type="text",e.style["-moz-appearance"]="textfield"),this._placeholderStyleSheet=document.createElement("style")}},n._updateStyleSheet=function(){var e=this._delegate,t=this._edTxt;t&&e&&(t.value=e.string,this._updateTextLabel(e.textLabel))},n._updateTextLabel=function(e){if(e){var t=e.font;t=!t||t instanceof PF?e.fontFamily:t._fontFamily;var n=e.fontSize*e.node.scale.y;if((this._textLabelFont!==t||this._textLabelFontSize!==n||this._textLabelFontColor!==e.fontColor||this._textLabelAlign!==e.horizontalAlign)&&(this._textLabelFont=t,this._textLabelFontSize=n,this._textLabelFontColor=e.fontColor,this._textLabelAlign=e.horizontalAlign,this._edTxt)){var i=this._edTxt;switch(i.style.fontSize=n+"px",i.style.color=e.color.toCSS(),i.style.fontFamily=t,e.horizontalAlign){case AU.HorizontalAlign.LEFT:i.style.textAlign="left";break;case AU.HorizontalAlign.CENTER:i.style.textAlign="center";break;case AU.HorizontalAlign.RIGHT:i.style.textAlign="right"}}}},n._updatePlaceholderLabel=function(e){if(e){var t=e.font;t=!t||t instanceof PF?e.fontFamily:e.font._fontFamily;var n=e.fontSize*e.node.scale.y;if(this._placeholderLabelFont!==t||this._placeholderLabelFontSize!==n||this._placeholderLabelFontColor!==e.fontColor||this._placeholderLabelAlign!==e.horizontalAlign||this._placeholderLineHeight!==e.fontSize){this._placeholderLabelFont=t,this._placeholderLabelFontSize=n,this._placeholderLabelFontColor=e.fontColor,this._placeholderLabelAlign=e.horizontalAlign,this._placeholderLineHeight=e.fontSize;var i=this._placeholderStyleSheet,r=e.color.toCSS(),o=e.fontSize,a="";switch(e.horizontalAlign){case AU.HorizontalAlign.LEFT:a="left";break;case AU.HorizontalAlign.CENTER:a="center";break;case AU.HorizontalAlign.RIGHT:a="right"}i.innerHTML="#"+this._domId+"::-webkit-input-placeholder{text-transform: initial;-family: "+t+";font-size: "+n+"px;color: "+r+";line-height: "+o+"px;text-align: "+a+";}#"+this._domId+"::-moz-placeholder{text-transform: initial;-family: "+t+";font-size: "+n+"px;color: "+r+";line-height: "+o+"px;text-align: "+a+";}#"+this._domId+"::-ms-input-placeholder{text-transform: initial;-family: "+t+";font-size: "+n+"px;color: "+r+";line-height: "+o+"px;text-align: "+a+";}",Qu.browserType===jl.EDGE&&(i.innerHTML+="#"+this._domId+"::-ms-clear{display: none;}")}}},n._registerEventListeners=function(){var e=this;if(this._edTxt){var t=this._edTxt,n=!1,i=this.__eventListeners;i.compositionStart=function(){n=!0},i.compositionEnd=function(){n=!1,e._delegate._editBoxTextChanged(t.value)},i.onInput=function(){if(!n){var i=e._delegate,r=i.maxLength;r>=0&&(t.value=t.value.slice(0,r)),i._editBoxTextChanged(t.value)}},i.onClick=function(){e._editing&&Qu.isMobile&&e._adjustWindowScroll()},i.onKeydown=function(n){n.keyCode===cO.ENTER?(n.propagationStopped=!0,e._delegate._editBoxEditingReturn(),e._isTextArea||t.blur()):n.keyCode===cO.TAB&&(n.propagationStopped=!0,n.preventDefault(),Lve.next(e))},i.onBlur=function(){Qu.isMobile&&n&&i.compositionEnd(),e._editing=!1,Xge=null,e._hideDom(),e._delegate._editBoxEditingDidEnded()},t.addEventListener("compositionstart",i.compositionStart),t.addEventListener("compositionend",i.compositionEnd),t.addEventListener("input",i.onInput),t.addEventListener("keydown",i.onKeydown),t.addEventListener("blur",i.onBlur),t.addEventListener("touchstart",i.onClick)}},n._removeEventListeners=function(){if(this._edTxt){var e=this._edTxt,t=this.__eventListeners;e.removeEventListener("compositionstart",t.compositionStart),e.removeEventListener("compositionend",t.compositionEnd),e.removeEventListener("input",t.onInput),e.removeEventListener("keydown",t.onKeydown),e.removeEventListener("blur",t.onBlur),e.removeEventListener("touchstart",t.onClick),t.compositionStart=null,t.compositionEnd=null,t.onInput=null,t.onKeydown=null,t.onBlur=null,t.onClick=null}},t}(Vge);!function(e){e.EDITING_DID_BEGAN="editing-did-began",e.EDITING_DID_ENDED="editing-did-ended",e.TEXT_CHANGED="text-changed",e.EDITING_RETURN="editing-return"}(Hge||(Hge={}));var Qge,Jge,Zge,$ge,eye,tye,nye,iye,rye,oye,aye,sye,cye,lye,uye,hye,_ye,fye,dye,pye,mye,vye,gye,yye,xye,Sye,Eye,Tye,Cye,bye,Aye,wye,Iye,Pye,Rye,Dye,Oye,Nye,Mye,Lye,Fye,Bye,zye,Uye,kye,Gye,Hye,Vye,Wye,jye,qye,Xye,Yye,Kye,Qye,Jye,Zye,$ye,exe,txe,nxe,ixe=e("EditBox",(Fve=dc("cc.EditBox"),Bve=Oc(),zve=mc(110),Uve=Ic(),kve=pc(zB),Gve=Vc(),Hve=Bc(),Vve=Vc(),Wve=Bc(),jve=Jc(AU),qve=Vc(),Xve=Bc(),Yve=Jc(AU),Kve=Vc(),Qve=Bc(),Jve=Jc(cF),Zve=Vc(),$ve=Bc(),ege=Jc(Mve),tge=Vc(),nge=Bc(),ige=Jc(Nve),rge=Vc(),oge=Bc(),age=Jc(Ove),sge=Vc(),cge=Bc(),lge=Vc(),uge=Bc(),hge=Vc(),_ge=Bc(),fge=Jc([AL]),dge=Vc(),pge=Bc(),mge=Jc([AL]),vge=Vc(),gge=Bc(),yge=Jc([AL]),xge=Vc(),Sge=Bc(),Ege=Jc([AL]),Tge=Vc(),Cge=Bc(),Fve(bge=Bve(bge=zve(bge=Uve(bge=kve(bge=wc((Gge=kge=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return E(t=e.call.apply(e,[this].concat(i))||this,"editingDidBegan",wge,y(t)),E(t,"textChanged",Ige,y(t)),E(t,"editingDidEnded",Pge,y(t)),E(t,"editingReturn",Rge,y(t)),t._impl=null,t._background=null,E(t,"_textLabel",Dge,y(t)),E(t,"_placeholderLabel",Oge,y(t)),E(t,"_returnType",Nge,y(t)),E(t,"_string",Mge,y(t)),E(t,"_tabIndex",Lge,y(t)),E(t,"_backgroundImage",Fge,y(t)),E(t,"_inputFlag",Bge,y(t)),E(t,"_inputMode",zge,y(t)),E(t,"_maxLength",Uge,y(t)),t._isLabelVisible=!1,t}f(t,e);var n=t.prototype;return n.__preload=function(){this._init()},n.onEnable=function(){this._registerEvent(),this._ensureBackgroundSprite(),this._impl&&this._impl.onEnable()},n.update=function(){this._impl&&this._impl.update()},n.onDisable=function(){this._unregisterEvent(),this._unregisterBackgroundEvent(),this._impl&&this._impl.onDisable()},n.onDestroy=function(){this._impl&&this._impl.clear()},n.setFocus=function(){this._impl&&this._impl.setFocus(!0)},n.focus=function(){this._impl&&this._impl.setFocus(!0)},n.blur=function(){this._impl&&this._impl.setFocus(!1)},n.isFocused=function(){return!!this._impl&&this._impl.isFocused()},n._editBoxEditingDidBegan=function(){AL.emitEvents(this.editingDidBegan,this),this.node.emit(Hge.EDITING_DID_BEGAN,this)},n._editBoxEditingDidEnded=function(){AL.emitEvents(this.editingDidEnded,this),this.node.emit(Hge.EDITING_DID_ENDED,this)},n._editBoxTextChanged=function(e){e=this._updateLabelStringStyle(e,!0),this.string=e,AL.emitEvents(this.textChanged,e,this),this.node.emit(Hge.TEXT_CHANGED,this)},n._editBoxEditingReturn=function(){AL.emitEvents(this.editingReturn,this),this.node.emit(Hge.EDITING_RETURN,this)},n._showLabels=function(){this._isLabelVisible=!0,this._updateLabels()},n._hideLabels=function(){this._isLabelVisible=!1,this._textLabel&&(this._textLabel.node.active=!1),this._placeholderLabel&&(this._placeholderLabel.node.active=!1)},n._onTouchBegan=function(e){e.propagationStopped=!0},n._onTouchCancel=function(e){e.propagationStopped=!0},n._onTouchEnded=function(e){this._impl&&this._impl.beginEditing(),e.propagationStopped=!0},n._init=function(){this._updatePlaceholderLabel(),this._updateTextLabel(),this._isLabelVisible=!0,this.node.on(VT.SIZE_CHANGED,this._resizeChildNodes,this),(this._impl=new t._EditBoxImpl).init(this),this._updateString(this._string),this._syncSize()},n._ensureBackgroundSprite=function(){if(!this._background){var e=this.node.getComponent(nH);e||(e=this.node.addComponent(nH)),e!==this._background&&(e.type=nH.Type.SLICED,e.spriteFrame=this._backgroundImage,this._background=e,this._registerBackgroundEvent())}},n._updateTextLabel=function(){var e=this._textLabel;if(!e){var t=this.node.getChildByName("TEXT_LABEL");t||((t=new jb("TEXT_LABEL")).layer=this.node.layer),(e=t.getComponent(AU))||(e=t.addComponent(AU)),t.parent=this.node,this._textLabel=e}this._textLabel.node._uiProps.uiTransformComp.setAnchorPoint(0,1),e.overflow=AU.Overflow.CLAMP,this._inputMode===Nve.ANY?(e.verticalAlign=yU.TOP,e.enableWrapText=!0):e.enableWrapText=!1,e.string=this._updateLabelStringStyle(this._string)},n._updatePlaceholderLabel=function(){var e=this._placeholderLabel;if(!e){var t=this.node.getChildByName("PLACEHOLDER_LABEL");t||((t=new jb("PLACEHOLDER_LABEL")).layer=this.node.layer),(e=t.getComponent(AU))||(e=t.addComponent(AU)),t.parent=this.node,this._placeholderLabel=e}this._placeholderLabel.node._uiProps.uiTransformComp.setAnchorPoint(0,1),this._inputMode===Nve.ANY?e.enableWrapText=!0:e.enableWrapText=!1,e.string=this.placeholder},n._syncSize=function(){var e=this.node._uiProps.uiTransformComp,t=e.contentSize;if(this._background){var n=this._background.node._uiProps.uiTransformComp;n.anchorPoint=e.anchorPoint,n.setContentSize(t)}this._updateLabelPosition(t),this._impl&&this._impl.setSize(t.width,t.height)},n._updateLabels=function(){if(this._isLabelVisible){var e=this._string;this._textLabel&&(this._textLabel.node.active=""!==e),this._placeholderLabel&&(this._placeholderLabel.node.active=""===e)}},n._updateString=function(e){var t=this._textLabel;if(t){var n=e;n&&(n=this._updateLabelStringStyle(n)),t.string=n,this._updateLabels()}},n._updateLabelStringStyle=function(e,t){void 0===t&&(t=!1);var n,i=this._inputFlag;if(t||i!==Mve.PASSWORD)i===Mve.INITIAL_CAPS_ALL_CHARACTERS?e=e.toUpperCase():i===Mve.INITIAL_CAPS_WORD?e=e.replace(/(?:^|\s)\S/g,(function(e){return e.toUpperCase()})):i===Mve.INITIAL_CAPS_SENTENCE&&(e=(n=e).charAt(0).toUpperCase()+n.slice(1));else{for(var r="",o=e.length,a=0;a<o;++a)r+="";e=r}return e},n._registerEvent=function(){this.node.on(VT.TOUCH_START,this._onTouchBegan,this),this.node.on(VT.TOUCH_END,this._onTouchEnded,this)},n._unregisterEvent=function(){this.node.off(VT.TOUCH_START,this._onTouchBegan,this),this.node.off(VT.TOUCH_END,this._onTouchEnded,this)},n._onBackgroundSpriteFrameChanged=function(){this._background&&(this.backgroundImage=this._background.spriteFrame)},n._registerBackgroundEvent=function(){var e=this._background&&this._background.node;null==e||e.on(nH.EventType.SPRITE_FRAME_CHANGED,this._onBackgroundSpriteFrameChanged,this)},n._unregisterBackgroundEvent=function(){var e=this._background&&this._background.node;null==e||e.off(nH.EventType.SPRITE_FRAME_CHANGED,this._onBackgroundSpriteFrameChanged,this)},n._updateLabelPosition=function(e){var t=this.node._uiProps.uiTransformComp,n=-t.anchorX*t.width,i=-t.anchorY*t.height,r=this._placeholderLabel,o=this._textLabel;o&&(o.node._uiProps.uiTransformComp.setContentSize(e.width-2,e.height),o.node.setPosition(n+2,i+e.height,o.node.position.z),this._inputMode===Nve.ANY&&(o.verticalAlign=yU.TOP),o.enableWrapText=this._inputMode===Nve.ANY),r&&(r.node._uiProps.uiTransformComp.setContentSize(e.width-2,e.height),r.lineHeight=e.height,r.node.setPosition(n+2,i+e.height,r.node.position.z),r.enableWrapText=this._inputMode===Nve.ANY)},n._resizeChildNodes=function(){var e=this.node._uiProps.uiTransformComp,t=this._textLabel&&this._textLabel.node;t&&(t.setPosition(-e.width/2,e.height/2,t.position.z),t._uiProps.uiTransformComp.setContentSize(e.contentSize));var n=this._placeholderLabel&&this._placeholderLabel.node;n&&(n.setPosition(-e.width/2,e.height/2,n.position.z),n._uiProps.uiTransformComp.setContentSize(e.contentSize));var i=this._background&&this._background.node;i&&i._uiProps.uiTransformComp.setContentSize(e.contentSize),this._syncSize()},h(t,[{key:"string",get:function(){return this._string},set:function(e){this._maxLength>=0&&e.length>=this._maxLength&&(e=e.slice(0,this._maxLength)),this._string!==e&&(this._string=e,this._updateString(e))}},{key:"placeholder",get:function(){return this._placeholderLabel?this._placeholderLabel.string:""},set:function(e){this._placeholderLabel&&(this._placeholderLabel.string=e)}},{key:"textLabel",get:function(){return this._textLabel},set:function(e){this._textLabel!==e&&(this._textLabel=e,this._textLabel&&(this._updateTextLabel(),this._updateLabels()))}},{key:"placeholderLabel",get:function(){return this._placeholderLabel},set:function(e){this._placeholderLabel!==e&&(this._placeholderLabel=e,this._placeholderLabel&&(this._updatePlaceholderLabel(),this._updateLabels()))}},{key:"backgroundImage",get:function(){return this._backgroundImage},set:function(e){this._backgroundImage!==e&&(this._backgroundImage=e,this._ensureBackgroundSprite(),this._background.spriteFrame=e)}},{key:"inputFlag",get:function(){return this._inputFlag},set:function(e){this._inputFlag!==e&&(this._inputFlag=e,this._updateString(this._string))}},{key:"inputMode",get:function(){return this._inputMode},set:function(e){this._inputMode!==e&&(this._inputMode=e,this._updateTextLabel(),this._updatePlaceholderLabel())}},{key:"returnType",get:function(){return this._returnType},set:function(e){this._returnType=e}},{key:"maxLength",get:function(){return this._maxLength},set:function(e){this._maxLength=e}},{key:"tabIndex",get:function(){return this._tabIndex},set:function(e){this._tabIndex!==e&&(this._tabIndex=e,this._impl&&this._impl.setTabIndex(e))}}]),t}(ku),kge._EditBoxImpl=Vge,kge.KeyboardReturnType=Ove,kge.InputFlag=Mve,kge.InputMode=Nve,kge.EventType=Hge,T((Age=Gge).prototype,"string",[Gve,Hve],Object.getOwnPropertyDescriptor(Age.prototype,"string"),Age.prototype),T(Age.prototype,"placeholder",[Vve,Wve],Object.getOwnPropertyDescriptor(Age.prototype,"placeholder"),Age.prototype),T(Age.prototype,"textLabel",[jve,qve,Xve],Object.getOwnPropertyDescriptor(Age.prototype,"textLabel"),Age.prototype),T(Age.prototype,"placeholderLabel",[Yve,Kve,Qve],Object.getOwnPropertyDescriptor(Age.prototype,"placeholderLabel"),Age.prototype),T(Age.prototype,"backgroundImage",[Jve,Zve,$ve],Object.getOwnPropertyDescriptor(Age.prototype,"backgroundImage"),Age.prototype),T(Age.prototype,"inputFlag",[ege,tge,nge],Object.getOwnPropertyDescriptor(Age.prototype,"inputFlag"),Age.prototype),T(Age.prototype,"inputMode",[ige,rge,oge],Object.getOwnPropertyDescriptor(Age.prototype,"inputMode"),Age.prototype),T(Age.prototype,"returnType",[age,sge,cge],Object.getOwnPropertyDescriptor(Age.prototype,"returnType"),Age.prototype),T(Age.prototype,"maxLength",[lge,uge],Object.getOwnPropertyDescriptor(Age.prototype,"maxLength"),Age.prototype),T(Age.prototype,"tabIndex",[hge,_ge],Object.getOwnPropertyDescriptor(Age.prototype,"tabIndex"),Age.prototype),wge=T(Age.prototype,"editingDidBegan",[fge,Ec,dge,pge],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Ige=T(Age.prototype,"textChanged",[mge,Ec,vge,gge],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Pge=T(Age.prototype,"editingDidEnded",[yge,Ec,xge,Sge],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Rge=T(Age.prototype,"editingReturn",[Ege,Ec,Tge,Cge],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Dge=T(Age.prototype,"_textLabel",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Oge=T(Age.prototype,"_placeholderLabel",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Nge=T(Age.prototype,"_returnType",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ove.DEFAULT}}),Mge=T(Age.prototype,"_string",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Lge=T(Age.prototype,"_tabIndex",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Fge=T(Age.prototype,"_backgroundImage",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Bge=T(Age.prototype,"_inputFlag",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Mve.DEFAULT}}),zge=T(Age.prototype,"_inputMode",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Nve.ANY}}),Uge=T(Age.prototype,"_maxLength",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 20}}),bge=Age))||bge)||bge)||bge)||bge)||bge)||bge));"object"==typeof window&&"object"==typeof document&&(ixe._EditBoxImpl=Kge),b.internal.EditBox=ixe,function(e){e[e.NONE=0]="NONE",e[e.HORIZONTAL=1]="HORIZONTAL",e[e.VERTICAL=2]="VERTICAL",e[e.GRID=3]="GRID"}(Jye||(Jye={})),et(Jye),function(e){e[e.NONE=0]="NONE",e[e.CONTAINER=1]="CONTAINER",e[e.CHILDREN=2]="CHILDREN"}(Zye||(Zye={})),et(Zye),function(e){e[e.HORIZONTAL=0]="HORIZONTAL",e[e.VERTICAL=1]="VERTICAL"}($ye||($ye={})),et($ye),function(e){e[e.BOTTOM_TO_TOP=0]="BOTTOM_TO_TOP",e[e.TOP_TO_BOTTOM=1]="TOP_TO_BOTTOM"}(exe||(exe={})),et(exe),function(e){e[e.LEFT_TO_RIGHT=0]="LEFT_TO_RIGHT",e[e.RIGHT_TO_LEFT=1]="RIGHT_TO_LEFT"}(txe||(txe={})),et(txe),function(e){e[e.NONE=0]="NONE",e[e.FIXED_ROW=1]="FIXED_ROW",e[e.FIXED_COL=2]="FIXED_COL"}(nxe||(nxe={})),et(nxe);var rxe,oxe,axe,sxe,cxe,lxe,uxe,hxe,_xe,fxe,dxe,pxe,mxe,vxe,gxe,yxe,xxe,Sxe,Exe,Txe,Cxe,bxe,Axe,wxe=new yn,Ixe=e("Layout",(Qge=dc("cc.Layout"),Jge=Oc(),Zge=mc(110),$ge=Ic(),eye=pc(zB),tye=Mc(),nye=Bc(),iye=Mc(),rye=Bc(),oye=Jc(Jye),aye=Vc(),sye=Bc(),cye=Jc(Zye),lye=Mc(),uye=Bc(),hye=Mc(),_ye=Bc(),fye=Jc($ye),dye=Bc(),pye=Bc(),mye=Bc(),vye=Bc(),gye=Bc(),yye=Bc(),xye=Bc(),Sye=Jc(exe),Eye=Bc(),Tye=Jc(txe),Cye=Bc(),bye=Jc(nxe),Aye=Mc(),wye=Bc(),Iye=Mc(),Pye=Bc(),Rye=Bc(),Qge(Dye=Jge(Dye=Zge(Dye=$ge(Dye=eye(Dye=wc((Qye=Kye=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return E(t=e.call.apply(e,[this].concat(i))||this,"_resizeMode",Nye,y(t)),E(t,"_layoutType",Mye,y(t)),E(t,"_cellSize",Lye,y(t)),E(t,"_startAxis",Fye,y(t)),E(t,"_paddingLeft",Bye,y(t)),E(t,"_paddingRight",zye,y(t)),E(t,"_paddingTop",Uye,y(t)),E(t,"_paddingBottom",kye,y(t)),E(t,"_spacingX",Gye,y(t)),E(t,"_spacingY",Hye,y(t)),E(t,"_verticalDirection",Vye,y(t)),E(t,"_horizontalDirection",Wye,y(t)),E(t,"_constraint",jye,y(t)),E(t,"_constraintNum",qye,y(t)),E(t,"_affectedByScale",Xye,y(t)),E(t,"_isAlign",Yye,y(t)),t._layoutSize=new jn(300,200),t._layoutDirty=!0,t._childrenDirty=!1,t._usefulLayoutObj=[],t._init=!1,t}f(t,e);var n=t.prototype;return n.updateLayout=function(e){void 0===e&&(e=!1),(this._layoutDirty||e)&&this.node.children.length>0&&(this._doLayout(),this._layoutDirty=!1)},n.onEnable=function(){this._addEventListeners();var e=this.node._uiProps.uiTransformComp;e.contentSize.equals(jn.ZERO)&&e.setContentSize(this._layoutSize),this._childrenChanged()},n.onDisable=function(){this._usefulLayoutObj.length=0,this._removeEventListeners()},n._checkUsefulObj=function(){this._usefulLayoutObj.length=0;for(var e=this.node.children,t=0;t<e.length;++t){var n=e[t],i=n._uiProps.uiTransformComp;n.activeInHierarchy&&i&&this._usefulLayoutObj.push(i)}},n._addEventListeners=function(){KO.on(YO.EVENT_AFTER_UPDATE,this.updateLayout,this),this.node.on(VT.SIZE_CHANGED,this._resized,this),this.node.on(VT.ANCHOR_CHANGED,this._doLayoutDirty,this),this.node.on(VT.CHILD_ADDED,this._childAdded,this),this.node.on(VT.CHILD_REMOVED,this._childRemoved,this),this.node.on(VT.SIBLING_ORDER_CHANGED,this._childrenChanged,this),this.node.on("childrenSiblingOrderChanged",this.updateLayout,this),this._addChildrenEventListeners()},n._removeEventListeners=function(){KO.off(YO.EVENT_AFTER_UPDATE,this.updateLayout,this),this.node.off(VT.SIZE_CHANGED,this._resized,this),this.node.off(VT.ANCHOR_CHANGED,this._doLayoutDirty,this),this.node.off(VT.CHILD_ADDED,this._childAdded,this),this.node.off(VT.CHILD_REMOVED,this._childRemoved,this),this.node.off(VT.SIBLING_ORDER_CHANGED,this._childrenChanged,this),this.node.off("childrenSiblingOrderChanged",this.updateLayout,this),this._removeChildrenEventListeners()},n._addChildrenEventListeners=function(){for(var e=this.node.children,t=0;t<e.length;++t){var n=e[t];n.on(VT.SIZE_CHANGED,this._doLayoutDirty,this),n.on(VT.TRANSFORM_CHANGED,this._transformDirty,this),n.on(VT.ANCHOR_CHANGED,this._doLayoutDirty,this),n.on(VT.ACTIVE_IN_HIERARCHY_CHANGED,this._childrenChanged,this)}},n._removeChildrenEventListeners=function(){for(var e=this.node.children,t=0;t<e.length;++t){var n=e[t];n.off(VT.SIZE_CHANGED,this._doLayoutDirty,this),n.off(VT.TRANSFORM_CHANGED,this._transformDirty,this),n.off(VT.ANCHOR_CHANGED,this._doLayoutDirty,this),n.off(VT.ACTIVE_IN_HIERARCHY_CHANGED,this._childrenChanged,this)}},n._childAdded=function(e){e.on(VT.SIZE_CHANGED,this._doLayoutDirty,this),e.on(VT.TRANSFORM_CHANGED,this._transformDirty,this),e.on(VT.ANCHOR_CHANGED,this._doLayoutDirty,this),e.on(VT.ACTIVE_IN_HIERARCHY_CHANGED,this._childrenChanged,this),this._childrenChanged()},n._childRemoved=function(e){e.off(VT.SIZE_CHANGED,this._doLayoutDirty,this),e.off(VT.TRANSFORM_CHANGED,this._transformDirty,this),e.off(VT.ANCHOR_CHANGED,this._doLayoutDirty,this),e.off(VT.ACTIVE_IN_HIERARCHY_CHANGED,this._childrenChanged,this),this._childrenChanged()},n._resized=function(){this._layoutSize.set(this.node._uiProps.uiTransformComp.contentSize),this._doLayoutDirty()},n._doLayoutHorizontally=function(e,t,n,i){var r=this.node._uiProps.uiTransformComp.anchorPoint,o=this._getFixedBreakingNum(),a=1,s=this._paddingLeft;this._horizontalDirection===txe.RIGHT_TO_LEFT&&(a=-1,s=this._paddingRight);var c=(this._horizontalDirection-r.x)*e+a*s,l=c-a*this._spacingX,u=0,h=0,_=0,f=0,d=!1,p=this._usefulLayoutObj.length,m=this._cellSize.width,v=this._getPaddingH();this._layoutType!==Jye.GRID&&this._resizeMode===Zye.CHILDREN&&(m=(e-v-(p-1)*this._spacingX)/p);for(var g=this._usefulLayoutObj,y=0;y<g.length;++y){var x=g[y],S=x.node,E=S.scale,T=this._getUsedScaleValue(E.x),C=this._getUsedScaleValue(E.y);this._resizeMode===Zye.CHILDREN&&(x.width=m/T,this._layoutType===Jye.GRID&&(x.height=this._cellSize.height/C));var b=Math.abs(this._horizontalDirection-x.anchorX),A=x.width*T,w=x.height*C;w>_&&(f=Math.max(_,f),h=_||w,_=w),l+=a*(b*A+this._spacingX);var I=a*(1-b)*A;if(t){if(o>0)(d=y/o>0&&y%o==0)&&(h=_>w?_:h);else if(A>e-v)l>c+a*b*A&&(d=!0);else{var P=(1-this._horizontalDirection-r.x)*e,R=l+I+a*(a>0?this._paddingRight:this._paddingLeft);d=Math.abs(R)>Math.abs(P)}d&&(l=c+a*b*A,w!==_&&(h=_),u+=h+this._spacingY,h=_=w)}var D=n(S,x,u);i&&S.setPosition(l,D),l+=I}return h=Math.max(h,_),Math.max(f,u+h)+this._getPaddingV()},n._doLayoutVertically=function(e,t,n,i){var r=this.node._uiProps.uiTransformComp.anchorPoint,o=this._getFixedBreakingNum(),a=1,s=this._paddingBottom;this._verticalDirection===exe.TOP_TO_BOTTOM&&(a=-1,s=this._paddingTop);var c=(this._verticalDirection-r.y)*e+a*s,l=c-a*this._spacingY,u=0,h=0,_=0,f=0,d=!1,p=this._usefulLayoutObj.length,m=this._cellSize.height,v=this._getPaddingV();this._layoutType!==Jye.GRID&&this._resizeMode===Zye.CHILDREN&&(m=(e-v-(p-1)*this._spacingY)/p);for(var g=this._usefulLayoutObj,y=0;y<g.length;++y){var x=g[y],S=x.node,E=S.scale,T=this._getUsedScaleValue(E.x),C=this._getUsedScaleValue(E.y);this._resizeMode===Zye.CHILDREN&&(x.height=m/C,this._layoutType===Jye.GRID&&(x.width=this._cellSize.width/T));var b=Math.abs(this._verticalDirection-x.anchorY),A=x.width*T,w=x.height*C;A>u&&(h=Math.max(u,h),_=u||A,u=A),l+=a*(b*w+this._spacingY);var I=a*(1-b)*w;if(t){if(o>0)(d=y/o>0&&y%o==0)&&(_=u>w?u:_);else if(w>e-v)l>c+a*b*w&&(d=!0);else{var P=(1-this._verticalDirection-r.y)*e,R=l+I+a*(a>0?this._paddingTop:this._paddingBottom);d=Math.abs(R)>Math.abs(P)}d&&(l=c+a*b*w,A!==u&&(_=u),f+=_+this._spacingX,_=u=A)}var D=n(S,x,f);i&&(S.getPosition(wxe),S.setPosition(D,l,wxe.z)),l+=I}return _=Math.max(_,u),Math.max(h,f+_)+this._getPaddingH()},n._doLayoutGridAxisHorizontal=function(e,t){var n=this,i=t.width,r=1,o=-e.y*t.height,a=this._paddingBottom;this._verticalDirection===exe.TOP_TO_BOTTOM&&(r=-1,o=(1-e.y)*t.height,a=this._paddingTop);var s=function(e,t,i){return o+r*(i+(1-t.anchorY)*t.height*n._getUsedScaleValue(e.scale.y)+a)},c=0;this._resizeMode===Zye.CONTAINER&&(c=this._doLayoutHorizontally(i,!0,s,!1),o=-e.y*c,this._verticalDirection===exe.TOP_TO_BOTTOM&&(r=-1,o=(1-e.y)*c)),this._doLayoutHorizontally(i,!0,s,!0),this._resizeMode===Zye.CONTAINER&&this.node._uiProps.uiTransformComp.setContentSize(i,c)},n._doLayoutGridAxisVertical=function(e,t){var n=this,i=t.height,r=1,o=-e.x*t.width,a=this._paddingLeft;this._horizontalDirection===txe.RIGHT_TO_LEFT&&(r=-1,o=(1-e.x)*t.width,a=this._paddingRight);var s=function(e,t,i){return o+r*(i+(1-t.anchorX)*t.width*n._getUsedScaleValue(e.scale.x)+a)},c=0;this._resizeMode===Zye.CONTAINER&&(c=this._doLayoutVertically(i,!0,s,!1),o=-e.x*c,this._horizontalDirection===txe.RIGHT_TO_LEFT&&(r=-1,o=(1-e.x)*c)),this._doLayoutVertically(i,!0,s,!0),this._resizeMode===Zye.CONTAINER&&this.node._uiProps.uiTransformComp.setContentSize(c,i)},n._doLayoutGrid=function(){var e=this.node._uiProps.uiTransformComp,t=e.anchorPoint,n=e.contentSize;this.startAxis===$ye.HORIZONTAL?this._doLayoutGridAxisHorizontal(t,n):this.startAxis===$ye.VERTICAL&&this._doLayoutGridAxisVertical(t,n)},n._getHorizontalBaseWidth=function(){var e=this._usefulLayoutObj,t=0,n=e.length;if(this._resizeMode===Zye.CONTAINER){for(var i=0;i<e.length;++i){var r=e[i],o=r.node.scale;t+=r.width*this._getUsedScaleValue(o.x)}t+=(n-1)*this._spacingX+this._getPaddingH()}else t=this.node._uiProps.uiTransformComp.width;return t},n._getVerticalBaseHeight=function(){var e=this._usefulLayoutObj,t=0,n=e.length;if(this._resizeMode===Zye.CONTAINER){for(var i=0;i<e.length;++i){var r=e[i],o=r.node.scale;t+=r.height*this._getUsedScaleValue(o.y)}t+=(n-1)*this._spacingY+this._getPaddingV()}else t=this.node._uiProps.uiTransformComp.height;return t},n._doLayout=function(){var e=this;if(this._init&&!this._childrenDirty||(this._checkUsefulObj(),this._init=!0,this._childrenDirty=!1),this._layoutType===Jye.HORIZONTAL){var t=this._getHorizontalBaseWidth();this._doLayoutHorizontally(t,!1,(function(t){return(e._isAlign?yn.ZERO:t.position).y}),!0),this.node._uiProps.uiTransformComp.width=t}else if(this._layoutType===Jye.VERTICAL){var n=this._getVerticalBaseHeight();this._doLayoutVertically(n,!1,(function(t){return(e._isAlign?yn.ZERO:t.position).x}),!0),this.node._uiProps.uiTransformComp.height=n}else this._layoutType===Jye.GRID&&this._doLayoutGrid()},n._getUsedScaleValue=function(e){return this._affectedByScale?Math.abs(e):1},n._transformDirty=function(e){e&Zg.SCALE&&e&Zg.POSITION&&this._affectedByScale&&this._doLayoutDirty()},n._doLayoutDirty=function(){this._layoutDirty=!0},n._childrenChanged=function(){this._childrenDirty=!0,this._doLayoutDirty()},n._getPaddingH=function(){return this._paddingLeft+this._paddingRight},n._getPaddingV=function(){return this._paddingTop+this._paddingBottom},n._getFixedBreakingNum=function(){if(this._layoutType!==Jye.GRID||this._constraint===nxe.NONE||this._constraintNum<=0)return 0;var e=this._constraint===nxe.FIXED_ROW?Math.ceil(this._usefulLayoutObj.length/this._constraintNum):this._constraintNum;return this._startAxis===$ye.VERTICAL&&(e=this._constraint===nxe.FIXED_COL?Math.ceil(this._usefulLayoutObj.length/this._constraintNum):this._constraintNum),e},h(t,[{key:"alignHorizontal",get:function(){return this._isAlign},set:function(e){this._layoutType===Jye.HORIZONTAL&&(this._isAlign=e,this._doLayoutDirty())}},{key:"alignVertical",get:function(){return this._isAlign},set:function(e){this._layoutType===Jye.VERTICAL&&(this._isAlign=e,this._doLayoutDirty())}},{key:"type",get:function(){return this._layoutType},set:function(e){this._layoutType=e,this._doLayoutDirty()}},{key:"resizeMode",get:function(){return this._resizeMode},set:function(e){this._layoutType!==Jye.NONE&&(this._resizeMode=e,this._doLayoutDirty())}},{key:"cellSize",get:function(){return this._cellSize},set:function(e){this._cellSize!==e&&(this._cellSize.set(e),this._doLayoutDirty())}},{key:"startAxis",get:function(){return this._startAxis},set:function(e){this._startAxis!==e&&(this._startAxis=e,this._doLayoutDirty())}},{key:"paddingLeft",get:function(){return this._paddingLeft},set:function(e){this._paddingLeft!==e&&(this._paddingLeft=e,this._doLayoutDirty())}},{key:"paddingRight",get:function(){return this._paddingRight},set:function(e){this._paddingRight!==e&&(this._paddingRight=e,this._doLayoutDirty())}},{key:"paddingTop",get:function(){return this._paddingTop},set:function(e){this._paddingTop!==e&&(this._paddingTop=e,this._doLayoutDirty())}},{key:"paddingBottom",get:function(){return this._paddingBottom},set:function(e){this._paddingBottom!==e&&(this._paddingBottom=e,this._doLayoutDirty())}},{key:"spacingX",get:function(){return this._spacingX},set:function(e){this._spacingX!==e&&(this._spacingX=e,this._doLayoutDirty())}},{key:"spacingY",get:function(){return this._spacingY},set:function(e){this._spacingY!==e&&(this._spacingY=e,this._doLayoutDirty())}},{key:"verticalDirection",get:function(){return this._verticalDirection},set:function(e){this._verticalDirection!==e&&(this._verticalDirection=e,this._doLayoutDirty())}},{key:"horizontalDirection",get:function(){return this._horizontalDirection},set:function(e){this._horizontalDirection!==e&&(this._horizontalDirection=e,this._doLayoutDirty())}},{key:"padding",get:function(){return this._paddingLeft},set:function(e){this.paddingLeft===e&&this._paddingRight===e&&this._paddingTop===e&&this._paddingBottom===e||(this._paddingLeft=this._paddingRight=this._paddingTop=this._paddingBottom=e,this._doLayoutDirty())}},{key:"constraint",get:function(){return this._constraint},set:function(e){this._layoutType!==Jye.NONE&&this._constraint!==e&&(this._constraint=e,this._doLayoutDirty())}},{key:"constraintNum",get:function(){return this._constraintNum},set:function(e){this._constraint!==nxe.NONE&&this._constraintNum!==e&&(e<=0&&F("Limit values to be greater than 0"),this._constraintNum=e,this._doLayoutDirty())}},{key:"affectedByScale",get:function(){return this._affectedByScale},set:function(e){this._affectedByScale=e,this._doLayoutDirty()}}]),t}(ku),Kye.Type=Jye,Kye.VerticalDirection=exe,Kye.HorizontalDirection=txe,Kye.ResizeMode=Zye,Kye.AxisDirection=$ye,Kye.Constraint=nxe,T((Oye=Qye).prototype,"alignHorizontal",[tye,nye],Object.getOwnPropertyDescriptor(Oye.prototype,"alignHorizontal"),Oye.prototype),T(Oye.prototype,"alignVertical",[iye,rye],Object.getOwnPropertyDescriptor(Oye.prototype,"alignVertical"),Oye.prototype),T(Oye.prototype,"type",[oye,aye,sye],Object.getOwnPropertyDescriptor(Oye.prototype,"type"),Oye.prototype),T(Oye.prototype,"resizeMode",[cye,lye,uye],Object.getOwnPropertyDescriptor(Oye.prototype,"resizeMode"),Oye.prototype),T(Oye.prototype,"cellSize",[hye,_ye],Object.getOwnPropertyDescriptor(Oye.prototype,"cellSize"),Oye.prototype),T(Oye.prototype,"startAxis",[fye,dye],Object.getOwnPropertyDescriptor(Oye.prototype,"startAxis"),Oye.prototype),T(Oye.prototype,"paddingLeft",[pye],Object.getOwnPropertyDescriptor(Oye.prototype,"paddingLeft"),Oye.prototype),T(Oye.prototype,"paddingRight",[mye],Object.getOwnPropertyDescriptor(Oye.prototype,"paddingRight"),Oye.prototype),T(Oye.prototype,"paddingTop",[vye],Object.getOwnPropertyDescriptor(Oye.prototype,"paddingTop"),Oye.prototype),T(Oye.prototype,"paddingBottom",[gye],Object.getOwnPropertyDescriptor(Oye.prototype,"paddingBottom"),Oye.prototype),T(Oye.prototype,"spacingX",[yye],Object.getOwnPropertyDescriptor(Oye.prototype,"spacingX"),Oye.prototype),T(Oye.prototype,"spacingY",[xye],Object.getOwnPropertyDescriptor(Oye.prototype,"spacingY"),Oye.prototype),T(Oye.prototype,"verticalDirection",[Sye,Eye],Object.getOwnPropertyDescriptor(Oye.prototype,"verticalDirection"),Oye.prototype),T(Oye.prototype,"horizontalDirection",[Tye,Cye],Object.getOwnPropertyDescriptor(Oye.prototype,"horizontalDirection"),Oye.prototype),T(Oye.prototype,"constraint",[bye,Aye,wye],Object.getOwnPropertyDescriptor(Oye.prototype,"constraint"),Oye.prototype),T(Oye.prototype,"constraintNum",[Iye,Pye],Object.getOwnPropertyDescriptor(Oye.prototype,"constraintNum"),Oye.prototype),T(Oye.prototype,"affectedByScale",[Rye],Object.getOwnPropertyDescriptor(Oye.prototype,"affectedByScale"),Oye.prototype),Nye=T(Oye.prototype,"_resizeMode",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Zye.NONE}}),Mye=T(Oye.prototype,"_layoutType",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Jye.NONE}}),Lye=T(Oye.prototype,"_cellSize",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new jn(40,40)}}),Fye=T(Oye.prototype,"_startAxis",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return $ye.HORIZONTAL}}),Bye=T(Oye.prototype,"_paddingLeft",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),zye=T(Oye.prototype,"_paddingRight",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Uye=T(Oye.prototype,"_paddingTop",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),kye=T(Oye.prototype,"_paddingBottom",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Gye=T(Oye.prototype,"_spacingX",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Hye=T(Oye.prototype,"_spacingY",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Vye=T(Oye.prototype,"_verticalDirection",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return exe.TOP_TO_BOTTOM}}),Wye=T(Oye.prototype,"_horizontalDirection",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return txe.LEFT_TO_RIGHT}}),jye=T(Oye.prototype,"_constraint",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return nxe.NONE}}),qye=T(Oye.prototype,"_constraintNum",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 2}}),Xye=T(Oye.prototype,"_affectedByScale",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Yye=T(Oye.prototype,"_isAlign",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Dye=Oye))||Dye)||Dye)||Dye)||Dye)||Dye)||Dye));b.Layout=Ixe,function(e){e[e.HORIZONTAL=0]="HORIZONTAL",e[e.VERTICAL=1]="VERTICAL",e[e.FILLED=2]="FILLED"}(Axe||(Axe={})),Je(Axe);var Pxe,Rxe,Dxe,Oxe,Nxe,Mxe,Lxe,Fxe,Bxe,zxe,Uxe,kxe,Gxe,Hxe,Vxe,Wxe,jxe,qxe,Xxe,Yxe,Kxe,Qxe,Jxe,Zxe,$xe=e("ProgressBar",(rxe=dc("cc.ProgressBar"),oxe=Oc(),axe=mc(110),sxe=Ic(),cxe=pc(zB),lxe=Jc(nH),uxe=Bc(),hxe=Jc(Axe),_xe=Bc(),fxe=Bc(),dxe=zc(),pxe=Bc(),mxe=Bc(),rxe(vxe=oxe(vxe=axe(vxe=sxe(vxe=cxe((bxe=Cxe=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return E(t=e.call.apply(e,[this].concat(i))||this,"_barSprite",yxe,y(t)),E(t,"_mode",xxe,y(t)),E(t,"_totalLength",Sxe,y(t)),E(t,"_progress",Exe,y(t)),E(t,"_reverse",Txe,y(t)),t}f(t,e);var n=t.prototype;return n._initBarSprite=function(){if(this._barSprite){var e=this._barSprite.node;if(!e)return;var t=this.node._uiProps.uiTransformComp,n=t.contentSize,i=t.anchorPoint,r=e._uiProps.uiTransformComp.contentSize;if(this._barSprite.fillType===nH.FillType.RADIAL&&(this._mode=Axe.FILLED),this._mode===Axe.HORIZONTAL?this.totalLength=r.width:this._mode===Axe.VERTICAL?this.totalLength=r.height:this.totalLength=this._barSprite.fillRange,e.parent===this.node){var o=-n.width*i.x;e.setPosition(o,0,0)}}},n._updateBarStatus=function(){if(this._barSprite){var e=this._barSprite.node;if(!e)return;var t=e._uiProps.uiTransformComp,n=t.anchorPoint,i=t.contentSize,r=e.getPosition(),o=new Tn(0,.5),a=tn(this._progress),s=this._totalLength*a,c=i,l=0,u=0;switch(this._mode){case Axe.HORIZONTAL:this._reverse&&(o=new Tn(1,.5)),c=new jn(s,i.height),l=this._totalLength,u=i.height;break;case Axe.VERTICAL:o=this._reverse?new Tn(.5,1):new Tn(.5,0),c=new jn(i.width,s),l=i.width,u=this._totalLength}if(this._mode===Axe.FILLED)this._barSprite.type!==nH.Type.FILLED?F("ProgressBar FILLED mode only works when barSprite's Type is FILLED!"):(this._reverse&&(s*=-1),this._barSprite.fillRange=s);else if(this._barSprite.type!==nH.Type.FILLED){var h=o.x-n.x,_=o.y-n.y,f=new yn(l*h,u*_,0);e.setPosition(r.x+f.x,r.y+f.y,r.z),t.setAnchorPoint(o),t.setContentSize(c)}else F("ProgressBar non-FILLED mode only works when barSprite's Type is non-FILLED!")}},h(t,[{key:"barSprite",get:function(){return this._barSprite},set:function(e){this._barSprite!==e&&(this._barSprite=e,this._initBarSprite())}},{key:"mode",get:function(){return this._mode},set:function(e){if(this._mode!==e&&(this._mode=e,this._barSprite)){var t=this._barSprite.node;if(!t)return;var n=t._uiProps.uiTransformComp.contentSize;this._mode===Axe.HORIZONTAL?this.totalLength=n.width:this._mode===Axe.VERTICAL?this.totalLength=n.height:this._mode===Axe.FILLED&&(this.totalLength=this._barSprite.fillRange)}}},{key:"totalLength",get:function(){return this._totalLength},set:function(e){this._mode===Axe.FILLED&&(e=tn(e)),this._totalLength!==e&&(this._totalLength=e,this._updateBarStatus())}},{key:"progress",get:function(){return this._progress},set:function(e){this._progress!==e&&(this._progress=e,this._updateBarStatus())}},{key:"reverse",get:function(){return this._reverse},set:function(e){this._reverse!==e&&(this._reverse=e,this._barSprite&&(this._barSprite.fillStart=1-this._barSprite.fillStart),this._updateBarStatus())}}]),t}(ku),Cxe.Mode=Axe,T((gxe=bxe).prototype,"barSprite",[lxe,uxe],Object.getOwnPropertyDescriptor(gxe.prototype,"barSprite"),gxe.prototype),T(gxe.prototype,"mode",[hxe,_xe],Object.getOwnPropertyDescriptor(gxe.prototype,"mode"),gxe.prototype),T(gxe.prototype,"totalLength",[fxe],Object.getOwnPropertyDescriptor(gxe.prototype,"totalLength"),gxe.prototype),T(gxe.prototype,"progress",[dxe,Hc,pxe],Object.getOwnPropertyDescriptor(gxe.prototype,"progress"),gxe.prototype),T(gxe.prototype,"reverse",[mxe],Object.getOwnPropertyDescriptor(gxe.prototype,"reverse"),gxe.prototype),yxe=T(gxe.prototype,"_barSprite",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),xxe=T(gxe.prototype,"_mode",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Axe.HORIZONTAL}}),Sxe=T(gxe.prototype,"_totalLength",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Exe=T(gxe.prototype,"_progress",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),Txe=T(gxe.prototype,"_reverse",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),vxe=gxe))||vxe)||vxe)||vxe)||vxe)||vxe));b.ProgressBar=$xe;var eSe,tSe=new yn,nSe=new yn,iSe=new yn,rSe=new Tn,oSe=new Qn,aSe=new Tn;!function(e){e[e.HORIZONTAL=0]="HORIZONTAL",e[e.VERTICAL=1]="VERTICAL"}(eSe||(eSe={})),et(eSe);var sSe,cSe=e("ScrollBar",(Pxe=dc("cc.ScrollBar"),Rxe=Oc(),Dxe=mc(110),Oxe=Ic(),Nxe=pc(zB),Mxe=Jc(nH),Lxe=Vc(),Fxe=Bc(),Bxe=Jc(eSe),zxe=Vc(),Uxe=Bc(),kxe=Vc(),Gxe=Bc(),Hxe=Vc(),Vxe=Bc(),Pxe(Wxe=Rxe(Wxe=Dxe(Wxe=Oxe(Wxe=Nxe((Zxe=Jxe=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return E(t=e.call.apply(e,[this].concat(i))||this,"_scrollView",qxe,y(t)),E(t,"_handle",Xxe,y(t)),E(t,"_direction",Yxe,y(t)),E(t,"_enableAutoHide",Kxe,y(t)),E(t,"_autoHideTime",Qxe,y(t)),t._touching=!1,t._opacity=255,t._autoHideRemainingTime=0,t}f(t,e);var n=t.prototype;return n.hide=function(){this._autoHideRemainingTime=0,this._setOpacity(0)},n.show=function(){this._autoHideRemainingTime=this._autoHideTime,this._setOpacity(this._opacity)},n.onScroll=function(e){if(this._scrollView){var t=this._scrollView.content;if(t){var n=t._uiProps.uiTransformComp.contentSize,i=this._scrollView.node._uiProps.uiTransformComp.contentSize,r=this.node._uiProps.uiTransformComp.contentSize;if(!this._conditionalDisableScrollBar(n,i)){this._enableAutoHide&&(this._autoHideRemainingTime=this._autoHideTime,this._setOpacity(this._opacity));var o=0,a=0,s=0,c=0,l=0,u=aSe;u.set(0,0),this._direction===eSe.HORIZONTAL?(o=n.width,a=i.width,l=r.width,s=e.x,this._convertToScrollViewSpace(u,t),c=-u.x):this._direction===eSe.VERTICAL&&(o=n.height,a=i.height,l=r.height,s=e.y,this._convertToScrollViewSpace(u,t),c=-u.y);var h=this._calculateLength(o,a,l,s),_=aSe;this._calculatePosition(_,o,a,l,c,s,h),this._updateLength(h),this._updateHandlerPosition(_)}}}},n.setScrollView=function(e){this._scrollView=e},n.onTouchBegan=function(){this._enableAutoHide&&(this._touching=!0)},n.onTouchEnded=function(){if(this._enableAutoHide&&(this._touching=!1,!(this._autoHideTime<=0))){if(this._scrollView){var e=this._scrollView.content;if(e){var t=e._uiProps.uiTransformComp.contentSize,n=this._scrollView.node._uiProps.uiTransformComp.contentSize;if(this._conditionalDisableScrollBar(t,n))return}}this._autoHideRemainingTime=this._autoHideTime}},n.onEnable=function(){var e=this.node.getComponent(nH);e&&(this._opacity=e.color.a)},n.start=function(){this._enableAutoHide&&this._setOpacity(0)},n.update=function(e){this._processAutoHide(e)},n._convertToScrollViewSpace=function(e,t){var n=this._scrollView&&this._scrollView.node._uiProps.uiTransformComp,i=t._uiProps.uiTransformComp;if(n&&i){tSe.set(-i.anchorX*i.width,-i.anchorY*i.height,0),i.convertToWorldSpaceAR(tSe,nSe);var r=n.convertToNodeSpaceAR(nSe);r.x+=n.anchorX*n.width,r.y+=n.anchorY*n.height,e.set(r.x,r.y)}else e.set(Tn.ZERO)},n._setOpacity=function(e){if(this._handle){var t=this.node.getComponent(nH);t&&(oSe.set(t.color),oSe.a=e,t.color=oSe),(t=this._handle.getComponent(nH))&&(oSe.set(t.color),oSe.a=e,t.color=oSe)}},n._updateHandlerPosition=function(e){if(this._handle){var t=iSe;this._fixupHandlerPosition(t),this._handle.node.setPosition(e.x+t.x,e.y+t.y,t.z)}},n._fixupHandlerPosition=function(e){var t=this.node._uiProps.uiTransformComp,n=t.contentSize,i=t.anchorPoint,r=this.handle.node._uiProps.uiTransformComp.contentSize,o=this.handle.node.parent;yn.set(tSe,-n.width*i.x,-n.height*i.y,0);var a=this.node._uiProps.uiTransformComp.convertToWorldSpaceAR(tSe,nSe),s=e;s.set(0,0,0),o._uiProps.uiTransformComp.convertToNodeSpaceAR(a,s),this.direction===eSe.HORIZONTAL?s.set(s.x,s.y+(n.height-r.height)/2,s.z):this.direction===eSe.VERTICAL&&s.set(s.x+(n.width-r.width)/2,s.y,s.z),this.handle.node.setPosition(s)},n._conditionalDisableScrollBar=function(e,t){return e.width<=t.width&&this._direction===eSe.HORIZONTAL||e.height<=t.height&&this._direction===eSe.VERTICAL},n._calculateLength=function(e,t,n,i){var r=e;return i&&(r+=20*(i>0?i:-i)),n*(t/r)},n._calculatePosition=function(e,t,n,i,r,o,a){var s=t-n;o&&(s+=Math.abs(o));var c=0;s&&(c=tn(c=r/s));var l=(i-a)*c;this._direction===eSe.VERTICAL?e.set(0,l):e.set(l,0)},n._updateLength=function(e){if(this._handle){var t=this._handle.node._uiProps.uiTransformComp,n=t.contentSize,i=t.anchorPoint;i.x===rSe.x&&i.y===rSe.y||t.setAnchorPoint(rSe),this._direction===eSe.HORIZONTAL?t.setContentSize(e,n.height):t.setContentSize(n.width,e)}},n._processAutoHide=function(e){if(this._enableAutoHide&&!(this._autoHideRemainingTime<=0)&&!this._touching&&(this._autoHideRemainingTime-=e,this._autoHideRemainingTime<=this._autoHideTime)){this._autoHideRemainingTime=Math.max(0,this._autoHideRemainingTime);var t=this._opacity*(this._autoHideRemainingTime/this._autoHideTime);this._setOpacity(t)}},h(t,[{key:"handle",get:function(){return this._handle},set:function(e){this._handle!==e&&(this._handle=e,this.onScroll(Tn.ZERO))}},{key:"direction",get:function(){return this._direction},set:function(e){this._direction!==e&&(this._direction=e,this.onScroll(Tn.ZERO))}},{key:"enableAutoHide",get:function(){return this._enableAutoHide},set:function(e){this._enableAutoHide!==e&&(this._enableAutoHide=e,this._enableAutoHide&&this._setOpacity(0))}},{key:"autoHideTime",get:function(){return this._autoHideTime},set:function(e){this._autoHideTime!==e&&(this._autoHideTime=e)}}]),t}(ku),Jxe.Direction=eSe,T((jxe=Zxe).prototype,"handle",[Mxe,Lxe,Fxe],Object.getOwnPropertyDescriptor(jxe.prototype,"handle"),jxe.prototype),T(jxe.prototype,"direction",[Bxe,zxe,Uxe],Object.getOwnPropertyDescriptor(jxe.prototype,"direction"),jxe.prototype),T(jxe.prototype,"enableAutoHide",[kxe,Gxe],Object.getOwnPropertyDescriptor(jxe.prototype,"enableAutoHide"),jxe.prototype),T(jxe.prototype,"autoHideTime",[Hxe,Vxe],Object.getOwnPropertyDescriptor(jxe.prototype,"autoHideTime"),jxe.prototype),qxe=T(jxe.prototype,"_scrollView",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Xxe=T(jxe.prototype,"_handle",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Yxe=T(jxe.prototype,"_direction",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return eSe.HORIZONTAL}}),Kxe=T(jxe.prototype,"_enableAutoHide",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Qxe=T(jxe.prototype,"_autoHideTime",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Wxe=jxe))||Wxe)||Wxe)||Wxe)||Wxe)||Wxe));b.ScrollBar=cSe;var lSe,uSe,hSe,_Se,fSe,dSe,pSe,mSe,vSe,gSe,ySe,xSe,SSe,ESe,TSe,CSe,bSe,ASe,wSe,ISe,PSe,RSe,DSe,OSe,NSe,MSe,LSe,FSe,BSe,zSe,USe,kSe,GSe,HSe,VSe,WSe,jSe,qSe,XSe,YSe,KSe,QSe,JSe,ZSe,$Se,eEe,tEe,nEe,iEe=e("ViewGroup",dc("cc.ViewGroup")(sSe=mc(110)(sSe=function(e){function t(){return e.apply(this,arguments)||this}return f(t,e),t}(ku))||sSe)||sSe);b.ViewGroup=iEe;var rEe,oEe=1e-4,aEe=new yn,sEe=new yn,cEe=new Tn,lEe=new Tn,uEe=function(){return(new Date).getMilliseconds()},hEe={"scroll-to-top":0,"scroll-to-bottom":1,"scroll-to-left":2,"scroll-to-right":3,scrolling:4,"bounce-bottom":6,"bounce-left":7,"bounce-right":8,"bounce-top":5,"scroll-ended":9,"touch-up":10,"scroll-ended-with-threshold":11,"scroll-began":12};!function(e){e.SCROLL_TO_TOP="scroll-to-top",e.SCROLL_TO_BOTTOM="scroll-to-bottom",e.SCROLL_TO_LEFT="scroll-to-left",e.SCROLL_TO_RIGHT="scroll-to-right",e.SCROLL_BEGAN="scroll-began",e.SCROLL_ENDED="scroll-ended",e.BOUNCE_TOP="bounce-top",e.BOUNCE_BOTTOM="bounce-bottom",e.BOUNCE_LEFT="bounce-left",e.BOUNCE_RIGHT="bounce-right",e.SCROLLING="scrolling",e.SCROLL_ENG_WITH_THRESHOLD="scroll-ended-with-threshold",e.TOUCH_UP="touch-up"}(rEe||(rEe={}));var _Ee,fEe,dEe,pEe,mEe,vEe,gEe,yEe,xEe,SEe,EEe,TEe,CEe,bEe,AEe,wEe,IEe,PEe,REe,DEe,OEe,NEe=e("ScrollView",(lSe=dc("cc.ScrollView"),uSe=Oc(),hSe=mc(110),_Se=Ic(),fSe=pc(zB),dSe=zc(),pSe=Vc(),mSe=Bc(),vSe=zc(),gSe=Vc(),ySe=Bc(),xSe=Vc(),SSe=Bc(),ESe=Vc(),TSe=Bc(),CSe=Jc(jb),bSe=Vc(),ASe=Bc(),wSe=Vc(),ISe=Bc(),PSe=Jc(cSe),RSe=Vc(),DSe=Bc(),OSe=Vc(),NSe=Bc(),MSe=Jc(cSe),LSe=Vc(),FSe=Bc(),BSe=Vc(),zSe=Bc(),USe=Jc([AL]),kSe=Vc(),GSe=Bc(),lSe(HSe=uSe(HSe=hSe(HSe=_Se(HSe=fSe((nEe=tEe=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return E(t=e.call.apply(e,[this].concat(i))||this,"bounceDuration",WSe,y(t)),E(t,"brake",jSe,y(t)),E(t,"elastic",qSe,y(t)),E(t,"inertia",XSe,y(t)),E(t,"horizontal",YSe,y(t)),E(t,"vertical",KSe,y(t)),E(t,"cancelInnerEvents",QSe,y(t)),E(t,"scrollEvents",JSe,y(t)),t._autoScrolling=!1,t._scrolling=!1,E(t,"_content",ZSe,y(t)),E(t,"_horizontalScrollBar",$Se,y(t)),E(t,"_verticalScrollBar",eEe,y(t)),t._topBoundary=0,t._bottomBoundary=0,t._leftBoundary=0,t._rightBoundary=0,t._touchMoveDisplacements=[],t._touchMoveTimeDeltas=[],t._touchMovePreviousTimestamp=0,t._touchMoved=!1,t._autoScrollAttenuate=!1,t._autoScrollStartPosition=new yn,t._autoScrollTargetDelta=new yn,t._autoScrollTotalTime=0,t._autoScrollAccumulatedTime=0,t._autoScrollCurrentlyOutOfBoundary=!1,t._autoScrollBraking=!1,t._autoScrollBrakingStartPosition=new yn,t._outOfBoundaryAmount=new yn,t._outOfBoundaryAmountDirty=!0,t._stopMouseWheel=!1,t._mouseWheelEventElapsedTime=0,t._isScrollEndedWithThresholdEventFired=!1,t._scrollEventEmitMask=0,t._isBouncing=!1,t._contentPos=new yn,t._deltaPos=new yn,t}f(t,e);var n=t.prototype;return n.scrollToBottom=function(e,t){void 0===t&&(t=!0);var n=this._calculateMovePercentDelta({anchor:new Tn(0,0),applyToHorizontal:!1,applyToVertical:!0});e?this._startAutoScroll(n,e,!1!==t):this._moveContent(n,!0)},n.scrollToTop=function(e,t){void 0===t&&(t=!0);var n=this._calculateMovePercentDelta({anchor:new Tn(0,1),applyToHorizontal:!1,applyToVertical:!0});e?this._startAutoScroll(n,e,!1!==t):this._moveContent(n)},n.scrollToLeft=function(e,t){void 0===t&&(t=!0);var n=this._calculateMovePercentDelta({anchor:new Tn(0,0),applyToHorizontal:!0,applyToVertical:!1});e?this._startAutoScroll(n,e,!1!==t):this._moveContent(n)},n.scrollToRight=function(e,t){void 0===t&&(t=!0);var n=this._calculateMovePercentDelta({anchor:new Tn(1,0),applyToHorizontal:!0,applyToVertical:!1});e?this._startAutoScroll(n,e,!1!==t):this._moveContent(n)},n.scrollToTopLeft=function(e,t){void 0===t&&(t=!0);var n=this._calculateMovePercentDelta({anchor:new Tn(0,1),applyToHorizontal:!0,applyToVertical:!0});e?this._startAutoScroll(n,e,!1!==t):this._moveContent(n)},n.scrollToTopRight=function(e,t){void 0===t&&(t=!0);var n=this._calculateMovePercentDelta({anchor:new Tn(1,1),applyToHorizontal:!0,applyToVertical:!0});e?this._startAutoScroll(n,e,!1!==t):this._moveContent(n)},n.scrollToBottomLeft=function(e,t){void 0===t&&(t=!0);var n=this._calculateMovePercentDelta({anchor:new Tn(0,0),applyToHorizontal:!0,applyToVertical:!0});e?this._startAutoScroll(n,e,!1!==t):this._moveContent(n)},n.scrollToBottomRight=function(e,t){void 0===t&&(t=!0);var n=this._calculateMovePercentDelta({anchor:new Tn(1,0),applyToHorizontal:!0,applyToVertical:!0});e?this._startAutoScroll(n,e,!1!==t):this._moveContent(n)},n.scrollToOffset=function(e,t,n){void 0===n&&(n=!0);var i=this.getMaxScrollOffset(),r=new Tn(0,0);0===i.x?r.x=0:r.x=e.x/i.x,0===i.y?r.y=1:r.y=(i.y-e.y)/i.y,this.scrollTo(r,t,n)},n.getScrollOffset=function(){var e=this._getContentTopBoundary()-this._topBoundary,t=this._getContentLeftBoundary()-this._leftBoundary;return new Tn(t,e)},n.getMaxScrollOffset=function(){if(!this._content||!this.view)return Tn.ZERO;var e=this._content._uiProps.uiTransformComp.contentSize,t=e.width-this.view.width,n=e.height-this.view.height;return new Tn(t=t>=0?t:0,n=n>=0?n:0)},n.scrollToPercentHorizontal=function(e,t,n){var i=this._calculateMovePercentDelta({anchor:new Tn(e,0),applyToHorizontal:!0,applyToVertical:!1});t?this._startAutoScroll(i,t,!1!==n):this._moveContent(i)},n.scrollTo=function(e,t,n){var i=this._calculateMovePercentDelta({anchor:new Tn(e),applyToHorizontal:!0,applyToVertical:!0});t?this._startAutoScroll(i,t,n):this._moveContent(i)},n.scrollToPercentVertical=function(e,t,n){var i=this._calculateMovePercentDelta({anchor:new Tn(0,e),applyToHorizontal:!1,applyToVertical:!0});t?this._startAutoScroll(i,t,n):this._moveContent(i)},n.stopAutoScroll=function(){this._autoScrolling=!1,this._autoScrollAccumulatedTime=this._autoScrollTotalTime},n.setContentPosition=function(e){this._setContentPosition(e)},n._setContentPosition=function(e){if(this._content){var t=this._getContentPosition();Math.abs(e.x-t.x)<oEe&&Math.abs(e.y-t.y)<oEe||(this._content.setPosition(e),this._outOfBoundaryAmountDirty=!0)}},n.getContentPosition=function(){return this._getContentPosition()},n._getContentPosition=function(){return this._content?(this._contentPos.set(this._content.position),this._contentPos):yn.ZERO.clone()},n.isScrolling=function(){return this._scrolling},n.isAutoScrolling=function(){return this._autoScrolling},n.getScrollEndedEventTiming=function(){return oEe},n.start=function(){this._calculateBoundary(),this._content&&KO.once(YO.EVENT_BEFORE_DRAW,this._adjustContentOutOfBoundary,this)},n.onEnable=function(){this._registerEvent(),this._content&&(this._content.on(VT.SIZE_CHANGED,this._calculateBoundary,this),this._content.on(VT.TRANSFORM_CHANGED,this._scaleChanged,this),this.view&&(this.view.node.on(VT.TRANSFORM_CHANGED,this._scaleChanged,this),this.view.node.on(VT.SIZE_CHANGED,this._calculateBoundary,this))),this._calculateBoundary(),this._updateScrollBarState()},n.update=function(e){this._autoScrolling&&this._processAutoScrolling(e)},n.onDisable=function(){this._unregisterEvent(),this._content&&(this._content.off(VT.SIZE_CHANGED,this._calculateBoundary,this),this._content.off(VT.TRANSFORM_CHANGED,this._scaleChanged,this),this.view&&(this.view.node.off(VT.TRANSFORM_CHANGED,this._scaleChanged,this),this.view.node.off(VT.SIZE_CHANGED,this._calculateBoundary,this))),this._hideScrollBar(),this.stopAutoScroll()},n._registerEvent=function(){this.node.on(VT.TOUCH_START,this._onTouchBegan,this,!0),this.node.on(VT.TOUCH_MOVE,this._onTouchMoved,this,!0),this.node.on(VT.TOUCH_END,this._onTouchEnded,this,!0),this.node.on(VT.TOUCH_CANCEL,this._onTouchCancelled,this,!0),this.node.on(VT.MOUSE_WHEEL,this._onMouseWheel,this,!0)},n._unregisterEvent=function(){this.node.off(VT.TOUCH_START,this._onTouchBegan,this,!0),this.node.off(VT.TOUCH_MOVE,this._onTouchMoved,this,!0),this.node.off(VT.TOUCH_END,this._onTouchEnded,this,!0),this.node.off(VT.TOUCH_CANCEL,this._onTouchCancelled,this,!0),this.node.off(VT.MOUSE_WHEEL,this._onMouseWheel,this,!0)},n._onMouseWheel=function(e,t){if(this.enabledInHierarchy&&!this._hasNestedViewGroup(e,t)){var n=new yn,i=e.getScrollY();this.vertical?n.set(0,-.1*i,0):this.horizontal&&n.set(-.1*i,0,0),this._mouseWheelEventElapsedTime=0,this._processDeltaMove(n),this._stopMouseWheel||(this._handlePressLogic(),this.schedule(this._checkMouseWheel,1/60,NaN,0),this._stopMouseWheel=!0),this._stopPropagationIfTargetIsMe(e)}},n._onTouchBegan=function(e,t){this.enabledInHierarchy&&this._content&&(this._hasNestedViewGroup(e,t)||(this._handlePressLogic(),this._touchMoved=!1,this._stopPropagationIfTargetIsMe(e)))},n._onTouchMoved=function(e,t){if(this.enabledInHierarchy&&this._content&&!this._hasNestedViewGroup(e,t)){var n=e.touch;if(this._handleMoveLogic(n),this.cancelInnerEvents){var i=n.getUILocation(cEe);if(i.subtract(n.getUIStartLocation(lEe)),i.length()>7&&!this._touchMoved&&e.target!==this.node){var r=new sO(e.getTouches(),e.bubbles,kA.TOUCH_CANCEL);r.touch=e.touch,r.simulate=!0,e.target.dispatchEvent(r),this._touchMoved=!0}this._stopPropagationIfTargetIsMe(e)}}},n._onTouchEnded=function(e,t){if(this.enabledInHierarchy&&this._content&&e&&!this._hasNestedViewGroup(e,t)){this._dispatchEvent(rEe.TOUCH_UP);var n=e.touch;this._handleReleaseLogic(n),this._touchMoved?e.propagationStopped=!0:this._stopPropagationIfTargetIsMe(e)}},n._onTouchCancelled=function(e,t){if(this.enabledInHierarchy&&this._content&&!this._hasNestedViewGroup(e,t)){if(e&&!e.simulate){var n=e.touch;this._handleReleaseLogic(n)}this._stopPropagationIfTargetIsMe(e)}},n._calculateBoundary=function(){if(this._content&&this.view){var e=this._content.getComponent(Ixe);e&&e.enabledInHierarchy&&e.updateLayout();var t=this.view,n=t.width*t.anchorX,i=t.height*t.anchorY;this._leftBoundary=-n,this._bottomBoundary=-i,this._rightBoundary=this._leftBoundary+t.width,this._topBoundary=this._bottomBoundary+t.height,this._moveContentToTopLeft(t.contentSize)}},n._hasNestedViewGroup=function(e,t){if(!e||e.eventPhase!==nO.CAPTURING_PHASE)return!1;if(t)for(var n,i=S(t);!(n=i()).done;){var r=n.value;if(this.node===r)return!(!e.target||!e.target.getComponent(iEe));if(r.getComponent(iEe))return!0}return!1},n._startInertiaScroll=function(e){var t=new yn(e);t.multiplyScalar(.7),this._startAttenuatingAutoScroll(t,e)},n._calculateAttenuatedFactor=function(e){return this.brake<=0?1-this.brake:(1-this.brake)*(1/(1+14e-6*e+e*e*8e-9))},n._startAttenuatingAutoScroll=function(e,t){var n=e.clone();if(n.normalize(),this._content&&this.view){var i=this._content._uiProps.uiTransformComp.contentSize,r=this.view.contentSize,o=i.width-r.width,a=i.height-r.height,s=this._calculateAttenuatedFactor(o),c=this._calculateAttenuatedFactor(a);n.x=n.x*o*(1-this.brake)*s,n.y=n.y*a*c*(1-this.brake),n.z=0}var l=e.length(),u=n.length()/l;if(n.add(e),this.brake>0&&u>7){u=Math.sqrt(u);var h=e.clone();h.multiplyScalar(u),n.set(h),n.add(e)}var _=this._calculateAutoScrollTimeByInitialSpeed(t.length());this.brake>0&&u>3&&(_*=u=3),0===this.brake&&u>1&&(_*=u),this._startAutoScroll(n,_,!0)},n._calculateAutoScrollTimeByInitialSpeed=function(e){return Math.sqrt(Math.sqrt(e/5))},n._startAutoScroll=function(e,t,n){void 0===n&&(n=!1);var i=this._flattenVectorByDirection(e);this._autoScrolling=!0,this._autoScrollTargetDelta=i,this._autoScrollAttenuate=n,yn.copy(this._autoScrollStartPosition,this._getContentPosition()),this._autoScrollTotalTime=t,this._autoScrollAccumulatedTime=0,this._autoScrollBraking=!1,this._isScrollEndedWithThresholdEventFired=!1,this._autoScrollBrakingStartPosition.set(0,0,0),this._getHowMuchOutOfBoundary().equals(yn.ZERO,oEe)||(this._autoScrollCurrentlyOutOfBoundary=!0)},n._calculateTouchMoveVelocity=function(){var e=new yn,t=0;if((t=this._touchMoveTimeDeltas.reduce((function(e,t){return e+t}),t))<=0||t>=.5)e.set(yn.ZERO);else{var n=new yn;n=this._touchMoveDisplacements.reduce((function(e,t){return e.add(t),e}),n),e.set(n.x*(1-this.brake)/t,n.y*(1-this.brake)/t,n.z)}return e},n._flattenVectorByDirection=function(e){var t=e;return t.x=this.horizontal?t.x:0,t.y=this.vertical?t.y:0,t},n._moveContent=function(e,t){var n=this._flattenVectorByDirection(e);aEe.set(this._getContentPosition()),aEe.add(n),aEe.set(Math.round(1e4*aEe.x)*oEe,Math.round(1e4*aEe.y)*oEe,aEe.z),this._setContentPosition(aEe);var i=this._getHowMuchOutOfBoundary();cEe.set(i.x,i.y),this._updateScrollBar(cEe),this.elastic&&t&&this._startBounceBackIfNeeded()},n._getContentLeftBoundary=function(){if(!this._content)return-1;var e=this._getContentPosition(),t=this._content._uiProps.uiTransformComp;return e.x-t.anchorX*t.width},n._getContentRightBoundary=function(){if(!this._content)return-1;var e=this._content._uiProps.uiTransformComp;return this._getContentLeftBoundary()+e.width},n._getContentTopBoundary=function(){if(!this._content)return-1;var e=this._content._uiProps.uiTransformComp;return this._getContentBottomBoundary()+e.height},n._getContentBottomBoundary=function(){if(!this._content)return-1;var e=this._getContentPosition(),t=this._content._uiProps.uiTransformComp;return e.y-t.anchorY*t.height},n._getHowMuchOutOfBoundary=function(e){if((e=e||new yn).equals(yn.ZERO,oEe)&&!this._outOfBoundaryAmountDirty)return this._outOfBoundaryAmount;var t=new yn,n=this._getContentLeftBoundary(),i=this._getContentRightBoundary();n+e.x>this._leftBoundary?t.x=this._leftBoundary-(n+e.x):i+e.x<this._rightBoundary&&(t.x=this._rightBoundary-(i+e.x));var r=this._getContentTopBoundary(),o=this._getContentBottomBoundary();return r+e.y<this._topBoundary?t.y=this._topBoundary-(r+e.y):o+e.y>this._bottomBoundary&&(t.y=this._bottomBoundary-(o+e.y)),e.equals(yn.ZERO,oEe)&&(this._outOfBoundaryAmount=t,this._outOfBoundaryAmountDirty=!1),this._clampDelta(t),t},n._updateScrollBar=function(e){this._horizontalScrollBar&&this._horizontalScrollBar.onScroll(e),this.verticalScrollBar&&this.verticalScrollBar.onScroll(e)},n._onScrollBarTouchBegan=function(){this._horizontalScrollBar&&this._horizontalScrollBar.onTouchBegan(),this.verticalScrollBar&&this.verticalScrollBar.onTouchBegan()},n._onScrollBarTouchEnded=function(){this._horizontalScrollBar&&this._horizontalScrollBar.onTouchEnded(),this.verticalScrollBar&&this.verticalScrollBar.onTouchEnded()},n._dispatchEvent=function(e){if(e===rEe.SCROLL_ENDED)this._scrollEventEmitMask=0;else if(e===rEe.SCROLL_TO_TOP||e===rEe.SCROLL_TO_BOTTOM||e===rEe.SCROLL_TO_LEFT||e===rEe.SCROLL_TO_RIGHT){var t=1<<hEe[e];if(this._scrollEventEmitMask&t)return;this._scrollEventEmitMask|=t}AL.emitEvents(this.scrollEvents,this,hEe[e]),this.node.emit(e,this)},n._adjustContentOutOfBoundary=function(){if(this._content&&(this._outOfBoundaryAmountDirty=!0,this._isOutOfBoundary())){var e=this._getHowMuchOutOfBoundary();aEe.set(this._getContentPosition()),aEe.add(e),this._content.setPosition(aEe),this._updateScrollBar(Tn.ZERO)}},n._hideScrollBar=function(){this._horizontalScrollBar&&this._horizontalScrollBar.hide(),this._verticalScrollBar&&this._verticalScrollBar.hide()},n._updateScrollBarState=function(){if(this._content&&this.view){var e=this.view,t=this._content._uiProps.uiTransformComp;this.verticalScrollBar&&(t.height<e.height?this.verticalScrollBar.hide():this.verticalScrollBar.show()),this.horizontalScrollBar&&(t.width<e.width?this.horizontalScrollBar.hide():this.horizontalScrollBar.show())}},n._stopPropagationIfTargetIsMe=function(e){e.eventPhase===nO.AT_TARGET&&e.target===this.node&&(e.propagationStopped=!0)},n._processDeltaMove=function(e){this._scrollChildren(e),this._gatherTouchMove(e)},n._handleMoveLogic=function(e){this._getLocalAxisAlignDelta(this._deltaPos,e),this._processDeltaMove(this._deltaPos)},n._handleReleaseLogic=function(e){this._getLocalAxisAlignDelta(this._deltaPos,e),this._gatherTouchMove(this._deltaPos),this._processInertiaScroll(),this._scrolling&&(this._scrolling=!1,this._autoScrolling||this._dispatchEvent(rEe.SCROLL_ENDED))},n._getLocalAxisAlignDelta=function(e,t){var n=this.node._uiProps.uiTransformComp,i=new yn;n&&(t.getUILocation(cEe),t.getUIPreviousLocation(lEe),aEe.set(cEe.x,cEe.y,0),sEe.set(lEe.x,lEe.y,0),n.convertToNodeSpaceAR(aEe,aEe),n.convertToNodeSpaceAR(sEe,sEe),yn.subtract(i,aEe,sEe)),e.set(i)},n._scrollChildren=function(e){this._clampDelta(e);var t,n=e;this.elastic&&(t=this._getHowMuchOutOfBoundary(),n.x*=0===t.x?1:.5,n.y*=0===t.y?1:.5),this.elastic||(t=this._getHowMuchOutOfBoundary(n),n.add(t));var i="",r="";if(this._content){var o=this._content._uiProps.uiTransformComp,a=o.anchorX,s=o.anchorY,c=o.width,l=o.height,u=this._content.position||yn.ZERO;this.vertical&&(n.y>0?u.y-s*l+n.y>=this._bottomBoundary&&(i=rEe.SCROLL_TO_BOTTOM):n.y<0&&u.y-s*l+l+n.y<=this._topBoundary&&(i=rEe.SCROLL_TO_TOP)),this.horizontal&&(n.x<0?u.x-a*c+c+n.x<=this._rightBoundary&&(r=rEe.SCROLL_TO_RIGHT):n.x>0&&u.x-a*c+n.x>=this._leftBoundary&&(r=rEe.SCROLL_TO_LEFT))}this._moveContent(n,!1),(this.horizontal&&0!==n.x||this.vertical&&0!==n.y)&&(this._scrolling||(this._scrolling=!0,this._dispatchEvent(rEe.SCROLL_BEGAN)),this._dispatchEvent(rEe.SCROLLING)),""!==i&&this._dispatchEvent(i),""!==r&&this._dispatchEvent(r)},n._handlePressLogic=function(){this._autoScrolling&&this._dispatchEvent(rEe.SCROLL_ENDED),this._autoScrolling=!1,this._isBouncing=!1,this._touchMovePreviousTimestamp=uEe(),this._touchMoveDisplacements.length=0,this._touchMoveTimeDeltas.length=0,this._onScrollBarTouchBegan()},n._clampDelta=function(e){if(this._content&&this.view){var t=this.view.contentSize,n=this._content._uiProps.uiTransformComp;n.width<t.width&&(e.x=0),n.height<t.height&&(e.y=0)}},n._gatherTouchMove=function(e){var t=e.clone();for(this._clampDelta(t);this._touchMoveDisplacements.length>=5;)this._touchMoveDisplacements.shift(),this._touchMoveTimeDeltas.shift();this._touchMoveDisplacements.push(t);var n=uEe();this._touchMoveTimeDeltas.push((n-this._touchMovePreviousTimestamp)/1e3),this._touchMovePreviousTimestamp=n},n._startBounceBackIfNeeded=function(){if(!this.elastic)return!1;var e=this._getHowMuchOutOfBoundary();if(this._clampDelta(e),e.equals(yn.ZERO,oEe))return!1;var t=Math.max(this.bounceDuration,0);return this._startAutoScroll(e,t,!0),this._isBouncing||(e.y>0&&this._dispatchEvent(rEe.BOUNCE_TOP),e.y<0&&this._dispatchEvent(rEe.BOUNCE_BOTTOM),e.x>0&&this._dispatchEvent(rEe.BOUNCE_RIGHT),e.x<0&&this._dispatchEvent(rEe.BOUNCE_LEFT),this._isBouncing=!0),!0},n._processInertiaScroll=function(){if(!this._startBounceBackIfNeeded()&&this.inertia){var e=this._calculateTouchMoveVelocity();!e.equals(aEe,oEe)&&this.brake<1&&this._startInertiaScroll(e)}this._onScrollBarTouchEnded()},n._isOutOfBoundary=function(){return!this._getHowMuchOutOfBoundary().equals(yn.ZERO,oEe)},n._isNecessaryAutoScrollBrake=function(){if(this._autoScrollBraking)return!0;if(this._isOutOfBoundary()){if(!this._autoScrollCurrentlyOutOfBoundary)return this._autoScrollCurrentlyOutOfBoundary=!0,this._autoScrollBraking=!0,yn.copy(this._autoScrollBrakingStartPosition,this._getContentPosition()),!0}else this._autoScrollCurrentlyOutOfBoundary=!1;return!1},n._processAutoScrolling=function(e){var t=this._isNecessaryAutoScrollBrake(),n=t?.05:1;this._autoScrollAccumulatedTime+=e*(1/n);var i,r=Math.min(1,this._autoScrollAccumulatedTime/this._autoScrollTotalTime);this._autoScrollAttenuate&&(i=r,r=(i-=1)*i*i*i*i+1);var o=this._autoScrollTargetDelta.clone();o.multiplyScalar(r);var a=this._autoScrollStartPosition.clone();a.add(o);var s=Math.abs(r-1)<=oEe;if(Math.abs(r-1)<=this.getScrollEndedEventTiming()&&!this._isScrollEndedWithThresholdEventFired&&(this._dispatchEvent(rEe.SCROLL_ENG_WITH_THRESHOLD),this._isScrollEndedWithThresholdEventFired=!0),this.elastic){var c=a.clone();c.subtract(this._autoScrollBrakingStartPosition),t&&c.multiplyScalar(n),a.set(this._autoScrollBrakingStartPosition),a.add(c)}else{var l=a.clone();l.subtract(this.getContentPosition());var u=this._getHowMuchOutOfBoundary(l);u.equals(yn.ZERO,oEe)||(a.add(u),s=!0)}s&&(this._autoScrolling=!1);var h=a.clone();h.subtract(this._getContentPosition()),this._clampDelta(h),this._moveContent(h,s),this._dispatchEvent(rEe.SCROLLING),this._autoScrolling||(this._isBouncing=!1,this._scrolling=!1,this._dispatchEvent(rEe.SCROLL_ENDED))},n._checkMouseWheel=function(e){if(!this._getHowMuchOutOfBoundary().equals(yn.ZERO,oEe))return this._processInertiaScroll(),this.unschedule(this._checkMouseWheel),this._dispatchEvent(rEe.SCROLL_ENDED),void(this._stopMouseWheel=!1);this._mouseWheelEventElapsedTime+=e,this._mouseWheelEventElapsedTime>.1&&(this._onScrollBarTouchEnded(),this.unschedule(this._checkMouseWheel),this._dispatchEvent(rEe.SCROLL_ENDED),this._stopMouseWheel=!1)},n._calculateMovePercentDelta=function(e){var t=e.anchor,n=e.applyToHorizontal,i=e.applyToVertical;this._calculateBoundary(),t.clampf(Tn.ZERO,Tn.ONE);var r=this._getContentBottomBoundary()-this._bottomBoundary;r=-r;var o=this._getContentLeftBoundary()-this._leftBoundary;o=-o;var a=new yn;if(this._content&&this.view){var s=0,c=this._content._uiProps.uiTransformComp.contentSize,l=this.view.contentSize;n&&(s=c.width-l.width,a.x=o-s*t.x),i&&(s=c.height-l.height,a.y=r-s*t.y)}return a},n._moveContentToTopLeft=function(e){var t=this._getContentBottomBoundary()-this._bottomBoundary;t=-t;var n=new yn,i=0,r=this._getContentLeftBoundary()-this._leftBoundary;if(r=-r,this._content){var o=this._content._uiProps.uiTransformComp.contentSize;o.height<e.height&&(i=o.height-e.height,n.y=t-i),o.width<e.width&&(i=o.width-e.width,n.x=r)}this._updateScrollBarState(),this._moveContent(n),this._adjustContentOutOfBoundary()},n._scaleChanged=function(e){e===Zg.SCALE&&this._calculateBoundary()},h(t,[{key:"content",get:function(){return this._content},set:function(e){if(this._content!==e){var t=e&&e.parent&&e.parent._uiProps.uiTransformComp;!e||e&&t?(this._content=e,this._calculateBoundary()):W(4302)}}},{key:"horizontalScrollBar",get:function(){return this._horizontalScrollBar},set:function(e){this._horizontalScrollBar!==e&&(this._horizontalScrollBar=e,this._horizontalScrollBar&&(this._horizontalScrollBar.setScrollView(this),this._updateScrollBar(Tn.ZERO)))}},{key:"verticalScrollBar",get:function(){return this._verticalScrollBar},set:function(e){this._verticalScrollBar!==e&&(this._verticalScrollBar=e,this._verticalScrollBar&&(this._verticalScrollBar.setScrollView(this),this._updateScrollBar(Tn.ZERO)))}},{key:"view",get:function(){var e=this._content&&this._content.parent;return e?e._uiProps.uiTransformComp:null}}]),t}(iEe),tEe.EventType=rEe,WSe=T((VSe=nEe).prototype,"bounceDuration",[Ec,dSe,pSe,mSe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),jSe=T(VSe.prototype,"brake",[Ec,vSe,gSe,ySe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.5}}),qSe=T(VSe.prototype,"elastic",[Ec,xSe,SSe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),XSe=T(VSe.prototype,"inertia",[Ec,ESe,TSe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),T(VSe.prototype,"content",[CSe,bSe,ASe],Object.getOwnPropertyDescriptor(VSe.prototype,"content"),VSe.prototype),YSe=T(VSe.prototype,"horizontal",[Ec,wSe,ISe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),T(VSe.prototype,"horizontalScrollBar",[PSe,RSe,DSe],Object.getOwnPropertyDescriptor(VSe.prototype,"horizontalScrollBar"),VSe.prototype),KSe=T(VSe.prototype,"vertical",[Ec,OSe,NSe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),T(VSe.prototype,"verticalScrollBar",[MSe,LSe,FSe],Object.getOwnPropertyDescriptor(VSe.prototype,"verticalScrollBar"),VSe.prototype),QSe=T(VSe.prototype,"cancelInnerEvents",[Ec,BSe,zSe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),JSe=T(VSe.prototype,"scrollEvents",[USe,Ec,kSe,GSe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),ZSe=T(VSe.prototype,"_content",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),$Se=T(VSe.prototype,"_horizontalScrollBar",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),eEe=T(VSe.prototype,"_verticalScrollBar",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),HSe=VSe))||HSe)||HSe)||HSe)||HSe)||HSe));b.ScrollView=NEe;var MEe,LEe=new yn;!function(e){e[e.Horizontal=0]="Horizontal",e[e.Vertical=1]="Vertical"}(MEe||(MEe={})),et(MEe);var FEe,BEe,zEe,UEe,kEe,GEe,HEe,VEe,WEe,jEe,qEe,XEe,YEe,KEe,QEe,JEe,ZEe,$Ee,eTe,tTe,nTe=e("Slider",(_Ee=dc("cc.Slider"),fEe=Oc(),dEe=mc(110),pEe=Ic(),mEe=pc(zB),vEe=Jc(nH),gEe=Bc(),yEe=Jc(MEe),xEe=Bc(),SEe=zc(),EEe=Bc(),TEe=Jc([AL]),CEe=Bc(),_Ee(bEe=fEe(bEe=dEe(bEe=pEe(bEe=mEe((OEe=DEe=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return E(t=e.call.apply(e,[this].concat(i))||this,"slideEvents",wEe,y(t)),E(t,"_handle",IEe,y(t)),E(t,"_direction",PEe,y(t)),E(t,"_progress",REe,y(t)),t._offset=new yn,t._dragging=!1,t._touchHandle=!1,t._handleLocalPos=new yn,t._touchPos=new yn,t}f(t,e);var n=t.prototype;return n.__preload=function(){this._updateHandlePosition()},n.onEnable=function(){this._updateHandlePosition(),this.node.on(VT.TOUCH_START,this._onTouchBegan,this),this.node.on(VT.TOUCH_MOVE,this._onTouchMoved,this),this.node.on(VT.TOUCH_END,this._onTouchEnded,this),this.node.on(VT.TOUCH_CANCEL,this._onTouchCancelled,this),this._handle&&this._handle.isValid&&(this._handle.node.on(VT.TOUCH_START,this._onHandleDragStart,this),this._handle.node.on(VT.TOUCH_MOVE,this._onTouchMoved,this),this._handle.node.on(VT.TOUCH_END,this._onTouchEnded,this))},n.onDisable=function(){this.node.off(VT.TOUCH_START,this._onTouchBegan,this),this.node.off(VT.TOUCH_MOVE,this._onTouchMoved,this),this.node.off(VT.TOUCH_END,this._onTouchEnded,this),this.node.off(VT.TOUCH_CANCEL,this._onTouchCancelled,this),this._handle&&this._handle.isValid&&(this._handle.node.off(VT.TOUCH_START,this._onHandleDragStart,this),this._handle.node.off(VT.TOUCH_MOVE,this._onTouchMoved,this),this._handle.node.off(VT.TOUCH_END,this._onTouchEnded,this))},n._onHandleDragStart=function(e){if(e&&this._handle&&this._handle.node._uiProps.uiTransformComp){this._dragging=!0,this._touchHandle=!0;var t=e.touch.getUILocation();yn.set(this._touchPos,t.x,t.y,0),this._handle.node._uiProps.uiTransformComp.convertToNodeSpaceAR(this._touchPos,this._offset),e.propagationStopped=!0}},n._onTouchBegan=function(e){this._handle&&e&&(this._dragging=!0,this._touchHandle||this._handleSliderLogic(e.touch),e.propagationStopped=!0)},n._onTouchMoved=function(e){this._dragging&&e&&(this._handleSliderLogic(e.touch),e.propagationStopped=!0)},n._onTouchEnded=function(e){this._dragging=!1,this._touchHandle=!1,this._offset=new yn,e&&(e.propagationStopped=!0)},n._onTouchCancelled=function(e){this._dragging=!1,e&&(e.propagationStopped=!0)},n._handleSliderLogic=function(e){this._updateProgress(e),this._emitSlideEvent()},n._emitSlideEvent=function(){AL.emitEvents(this.slideEvents,this),this.node.emit("slide",this)},n._updateProgress=function(e){if(this._handle&&e){var t=e.getUILocation();yn.set(this._touchPos,t.x,t.y,0);var n=this.node._uiProps.uiTransformComp,i=n.convertToNodeSpaceAR(this._touchPos,LEe);this.direction===MEe.Horizontal?this.progress=tn(.5+(i.x-this._offset.x)/n.width):this.progress=tn(.5+(i.y-this._offset.y)/n.height)}},n._updateHandlePosition=function(){if(this._handle){this._handleLocalPos.set(this._handle.node.getPosition());var e=this.node._uiProps.uiTransformComp;this._direction===MEe.Horizontal?this._handleLocalPos.x=-e.width*e.anchorX+this.progress*e.width:this._handleLocalPos.y=-e.height*e.anchorY+this.progress*e.height,this._handle.node.setPosition(this._handleLocalPos)}},n._changeLayout=function(){var e=this.node._uiProps.uiTransformComp,t=e.contentSize;if(e.setContentSize(t.height,t.width),this._handle){var n=this._handle.node.position;this._direction===MEe.Horizontal?this._handle.node.setPosition(n.x,0,n.z):this._handle.node.setPosition(0,n.y,n.z),this._updateHandlePosition()}},h(t,[{key:"handle",get:function(){return this._handle},set:function(e){this._handle!==e&&(this._handle=e)}},{key:"direction",get:function(){return this._direction},set:function(e){this._direction!==e&&(this._direction=e,this._changeLayout())}},{key:"progress",get:function(){return this._progress},set:function(e){this._progress!==e&&(this._progress=e,this._updateHandlePosition())}}]),t}(ku),DEe.Direction=MEe,T((AEe=OEe).prototype,"handle",[vEe,gEe],Object.getOwnPropertyDescriptor(AEe.prototype,"handle"),AEe.prototype),T(AEe.prototype,"direction",[yEe,xEe],Object.getOwnPropertyDescriptor(AEe.prototype,"direction"),AEe.prototype),T(AEe.prototype,"progress",[Hc,SEe,EEe],Object.getOwnPropertyDescriptor(AEe.prototype,"progress"),AEe.prototype),wEe=T(AEe.prototype,"slideEvents",[TEe,Ec,CEe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),IEe=T(AEe.prototype,"_handle",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),PEe=T(AEe.prototype,"_direction",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return MEe.Horizontal}}),REe=T(AEe.prototype,"_progress",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),bEe=AEe))||bEe)||bEe)||bEe)||bEe)||bEe));function iTe(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return Object.assign.apply(Object,[{}].concat(t))}b.Slider=nTe,function(e){e.TOGGLE="toggle"}(tTe||(tTe={}));var rTe,oTe,aTe,sTe,cTe,lTe,uTe,hTe,_Te,fTe,dTe,pTe,mTe=e("Toggle",(FEe=dc("cc.Toggle"),BEe=Oc(),zEe=mc(110),UEe=Ic(),kEe=pc(zB),GEe=Vc(),HEe=Bc(),VEe=Jc(nH),WEe=Vc(),jEe=Bc(),qEe=Jc([AL]),XEe=Bc(),FEe(YEe=BEe(YEe=zEe(YEe=UEe(YEe=kEe((eTe=$Ee=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return E(t=e.call.apply(e,[this].concat(i))||this,"checkEvents",QEe,y(t)),E(t,"_isChecked",JEe,y(t)),E(t,"_checkMark",ZEe,y(t)),t}f(t,e);var n=t.prototype;return n._internalToggle=function(){this.isChecked=!this.isChecked},n._set=function(e,t){if(void 0===t&&(t=!0),this._isChecked!=e){this._isChecked=e;var n=this._toggleContainer;n&&n.enabled&&this.enabled&&(e||!n.anyTogglesChecked()&&!n.allowSwitchOff)&&(this._isChecked=!0,n.notifyToggleCheck(this,t)),this.playEffect(),t&&this._emitToggleEvents()}},n.playEffect=function(){this._checkMark&&(this._checkMark.node.active=this._isChecked)},n.setIsCheckedWithoutNotify=function(e){this._set(e,!1)},n.onEnable=function(){e.prototype.onEnable.call(this),this.playEffect(),this.node.on(t.EventType.CLICK,this._internalToggle,this)},n.onDisable=function(){e.prototype.onDisable.call(this),this.node.off(t.EventType.CLICK,this._internalToggle,this)},n.OnDestroy=function(){var e=this._toggleContainer;e&&e.ensureValidState()},n._emitToggleEvents=function(){this.node.emit(t.EventType.TOGGLE,this),this.checkEvents&&AL.emitEvents(this.checkEvents,this)},h(t,[{key:"isChecked",get:function(){return this._isChecked},set:function(e){this._set(e)}},{key:"checkMark",get:function(){return this._checkMark},set:function(e){this._checkMark!==e&&(this._checkMark=e)}},{key:"_resizeToTarget",set:function(e){e&&this._resizeNodeToTargetNode()}},{key:"_toggleContainer",get:function(){var e=this.node.parent;return b.Node.isNode(e)?e.getComponent("cc.ToggleContainer"):null}}]),t}(Dve),$Ee.EventType=iTe(tTe,Pve),T((KEe=eTe).prototype,"isChecked",[GEe,HEe],Object.getOwnPropertyDescriptor(KEe.prototype,"isChecked"),KEe.prototype),T(KEe.prototype,"checkMark",[VEe,WEe,jEe],Object.getOwnPropertyDescriptor(KEe.prototype,"checkMark"),KEe.prototype),QEe=T(KEe.prototype,"checkEvents",[qEe,Ec,XEe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),JEe=T(KEe.prototype,"_isChecked",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),ZEe=T(KEe.prototype,"_checkMark",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),YEe=KEe))||YEe)||YEe)||YEe)||YEe)||YEe));b.Toggle=mTe;var vTe,gTe,yTe,xTe,STe,ETe,TTe,CTe,bTe,ATe,wTe,ITe,PTe,RTe,DTe,OTe,NTe,MTe,LTe,FTe,BTe,zTe,UTe,kTe,GTe,HTe,VTe,WTe,jTe,qTe,XTe,YTe,KTe,QTe,JTe,ZTe,$Te,eCe,tCe,nCe,iCe,rCe,oCe,aCe,sCe,cCe=e("ToggleContainer",(rTe=dc("cc.ToggleContainer"),oTe=Oc(),aTe=mc(110),sTe=Ic(),cTe=Bc(),lTe=Jc([AL]),uTe=Bc(),rTe(hTe=oTe(hTe=aTe(hTe=sTe(hTe=wc((pTe=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return E(t=e.call.apply(e,[this].concat(i))||this,"_allowSwitchOff",fTe,y(t)),E(t,"checkEvents",dTe,y(t)),t}f(t,e);var n=t.prototype;return n.onEnable=function(){this.ensureValidState(),this.node.on(VT.CHILD_ADDED,this.ensureValidState,this),this.node.on(VT.CHILD_REMOVED,this.ensureValidState,this)},n.onDisable=function(){this.node.off(VT.CHILD_ADDED,this.ensureValidState,this),this.node.off(VT.CHILD_REMOVED,this.ensureValidState,this)},n.activeToggles=function(){return this.toggleItems.filter((function(e){return e.isChecked}))},n.anyTogglesChecked=function(){return!!this.toggleItems.find((function(e){return e.isChecked}))},n.notifyToggleCheck=function(e,t){if(void 0===t&&(t=!0),this.enabledInHierarchy){for(var n=0;n<this.toggleItems.length;n++){var i=this.toggleItems[n];i!==e&&(t?i.isChecked=!1:i.setIsCheckedWithoutNotify(!1))}this.checkEvents&&b.Component.EventHandler.emitEvents(this.checkEvents,e)}},n.ensureValidState=function(){var e=this.toggleItems;if(!this._allowSwitchOff&&!this.anyTogglesChecked()&&0!==e.length){var t=e[0];t.isChecked=!0,this.notifyToggleCheck(t)}var n=this.activeToggles();if(n.length>1)for(var i=n[0],r=0;r<n.length;++r){var o=n[r];o!==i&&(o.isChecked=!1)}},h(t,[{key:"allowSwitchOff",get:function(){return this._allowSwitchOff},set:function(e){this._allowSwitchOff=e}},{key:"toggleItems",get:function(){return this.node.children.map((function(e){var t=e.getComponent("cc.Toggle");return t&&t.enabled?t:null})).filter(Boolean)}}]),t}(ku),fTe=T((_Te=pTe).prototype,"_allowSwitchOff",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),T(_Te.prototype,"allowSwitchOff",[cTe],Object.getOwnPropertyDescriptor(_Te.prototype,"allowSwitchOff"),_Te.prototype),dTe=T(_Te.prototype,"checkEvents",[lTe,Ec,uTe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),hTe=_Te))||hTe)||hTe)||hTe)||hTe)||hTe));b.ToggleContainer=cCe;var lCe,uCe,hCe=new Tn;function _Ce(e){return e instanceof XP?tO:e._uiProps.uiTransformComp?e._uiProps.uiTransformComp.contentSize:jn.ZERO}function fCe(e,t,n,i){e.parent?hCe.set(e.parent.getScale().x,e.parent.getScale().y):hCe.set(0,0);for(var r=hCe.x,o=hCe.y,a=0,s=0,c=e.parent;;){if(!c)return n.x=n.y=0,void(i.x=i.y=1);var l=c.getPosition();if(a+=l.x,s+=l.y,(c=c.parent)===t)break;c?hCe.set(c.getScale().x,c.getScale().y):hCe.set(0,0);var u=hCe.x,h=hCe.y;a*=u,s*=h,r*=u,o*=h}i.x=0!==r?1/r:1,i.y=0!==o?1/o:1,n.x=-a,n.y=-s}!function(e){e[e.ONCE=0]="ONCE",e[e.ALWAYS=1]="ALWAYS",e[e.ON_WINDOW_RESIZE=2]="ON_WINDOW_RESIZE"}(lCe||(lCe={})),et(lCe),function(e){e[e.TOP=1]="TOP",e[e.MID=2]="MID",e[e.BOT=4]="BOT",e[e.LEFT=8]="LEFT",e[e.CENTER=16]="CENTER",e[e.RIGHT=32]="RIGHT",e[e.HORIZONTAL=56]="HORIZONTAL",e[e.VERTICAL=7]="VERTICAL"}(uCe||(uCe={}));var dCe,pCe,mCe,vCe,gCe,yCe,xCe,SCe,ECe,TCe,CCe,bCe,ACe,wCe,ICe,PCe,RCe,DCe,OCe,NCe=uCe.TOP|uCe.BOT,MCe=uCe.LEFT|uCe.RIGHT,LCe=e("Widget",(vTe=dc("cc.Widget"),gTe=Oc(),yTe=mc(110),xTe=Ic(),STe=pc(zB),ETe=Jc(jb),TTe=Bc(),CTe=Bc(),bTe=Bc(),ATe=Bc(),wTe=Bc(),ITe=Bc(),PTe=Bc(),RTe=Mc(),DTe=Mc(),OTe=Bc(),NTe=Bc(),MTe=Bc(),LTe=Bc(),FTe=Bc(),BTe=Bc(),zTe=Jc(lCe),UTe=Bc(),vTe(kTe=gTe(kTe=yTe(kTe=xTe(kTe=STe(kTe=wc((sCe=aCe=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._lastPos=new yn,t._lastSize=new jn,t._dirty=!0,t._hadAlignOnce=!1,E(t,"_alignFlags",HTe,y(t)),E(t,"_target",VTe,y(t)),E(t,"_left",WTe,y(t)),E(t,"_right",jTe,y(t)),E(t,"_top",qTe,y(t)),E(t,"_bottom",XTe,y(t)),E(t,"_horizontalCenter",YTe,y(t)),E(t,"_verticalCenter",KTe,y(t)),E(t,"_isAbsLeft",QTe,y(t)),E(t,"_isAbsRight",JTe,y(t)),E(t,"_isAbsTop",ZTe,y(t)),E(t,"_isAbsBottom",$Te,y(t)),E(t,"_isAbsHorizontalCenter",eCe,y(t)),E(t,"_isAbsVerticalCenter",tCe,y(t)),E(t,"_originalWidth",nCe,y(t)),E(t,"_originalHeight",iCe,y(t)),E(t,"_alignMode",rCe,y(t)),E(t,"_lockFlags",oCe,y(t)),t}f(t,e);var n=t.prototype;return n.updateAlignment=function(){b._widgetManager.updateAlignment(this.node)},n._validateTargetInDEV=function(){},n.setDirty=function(){this._recursiveDirty()},n.onEnable=function(){this.node.getPosition(this._lastPos),this._lastSize.set(this.node._uiProps.uiTransformComp.contentSize),b._widgetManager.add(this),this._hadAlignOnce=!1,this._registerEvent(),this._registerTargetEvents()},n.onDisable=function(){b._widgetManager.remove(this),this._unregisterEvent(),this._unregisterTargetEvents()},n.onDestroy=function(){this._removeParentEvent()},n._adjustWidgetToAllowMovingInEditor=function(){},n._adjustWidgetToAllowResizingInEditor=function(){},n._adjustWidgetToAnchorChanged=function(){this.setDirty()},n._adjustTargetToParentChanged=function(e){e&&this._unregisterOldParentEvents(e),this.node.getParent()&&this._registerTargetEvents(),this._setDirtyByMode()},n._registerEvent=function(){this.node.on(VT.TRANSFORM_CHANGED,this._setDirtyByMode,this),this.node.on(VT.SIZE_CHANGED,this._setDirtyByMode,this),this.node.on(VT.ANCHOR_CHANGED,this._adjustWidgetToAnchorChanged,this),this.node.on(VT.PARENT_CHANGED,this._adjustTargetToParentChanged,this)},n._unregisterEvent=function(){this.node.off(VT.TRANSFORM_CHANGED,this._setDirtyByMode,this),this.node.off(VT.SIZE_CHANGED,this._setDirtyByMode,this),this.node.off(VT.ANCHOR_CHANGED,this._adjustWidgetToAnchorChanged,this)},n._removeParentEvent=function(){this.node.off(VT.PARENT_CHANGED,this._adjustTargetToParentChanged,this)},n._autoChangedValue=function(e,t){if((this._alignFlags&e)>0){var n=this.node.parent&&this.node.parent._uiProps,i=n&&n.uiTransformComp,r=i?i.contentSize:tO;this.isAlignLeft&&e===uCe.LEFT?this._left=t?this._left*r.width:this._left/r.width:this.isAlignRight&&e===uCe.RIGHT?this._right=t?this._right*r.width:this._right/r.width:this.isAlignHorizontalCenter&&e===uCe.CENTER?this._horizontalCenter=t?this._horizontalCenter*r.width:this._horizontalCenter/r.width:this.isAlignTop&&e===uCe.TOP?this._top=t?this._top*r.height:this._top/r.height:this.isAlignBottom&&e===uCe.BOT?this._bottom=t?this._bottom*r.height:this._bottom/r.height:this.isAbsoluteVerticalCenter&&e===uCe.MID&&(this._verticalCenter=this._verticalCenter/r.height),this._recursiveDirty()}},n._registerTargetEvents=function(){var e=this._target||this.node.parent;e&&e.getComponent(zB)&&(e.on(VT.TRANSFORM_CHANGED,this._setDirtyByMode,this),e.on(VT.SIZE_CHANGED,this._setDirtyByMode,this),e.on(VT.ANCHOR_CHANGED,this._setDirtyByMode,this))},n._unregisterTargetEvents=function(){var e=this._target||this.node.parent;e&&(e.off(VT.TRANSFORM_CHANGED,this._setDirtyByMode,this),e.off(VT.SIZE_CHANGED,this._setDirtyByMode,this),e.off(VT.ANCHOR_CHANGED,this._setDirtyByMode,this))},n._unregisterOldParentEvents=function(e){var t=this._target||e;t&&(t.off(VT.TRANSFORM_CHANGED,this._setDirtyByMode,this),t.off(VT.SIZE_CHANGED,this._setDirtyByMode,this))},n._setDirtyByMode=function(){this.alignMode===lCe.ALWAYS&&this._recursiveDirty()},n._setAlign=function(e,t){if(t!==(this._alignFlags&e)>0){var n=(e&MCe)>0,i=this.node._uiProps.uiTransformComp;t?(this._alignFlags|=e,n?(this.isAlignHorizontalCenter=!1,this.isStretchWidth&&(this._originalWidth=i.width)):(this.isAlignVerticalCenter=!1,this.isStretchHeight&&(this._originalHeight=i.height))):(n?this.isStretchWidth&&(i.width=this._originalWidth):this.isStretchHeight&&(i.height=this._originalHeight),this._alignFlags&=~e)}},n._recursiveDirty=function(){this._dirty||(this._dirty=!0)},h(t,[{key:"target",get:function(){return this._target},set:function(e){this._target!==e&&(this._unregisterTargetEvents(),this._target=e,this._registerTargetEvents(),this._validateTargetInDEV(),this._recursiveDirty())}},{key:"isAlignTop",get:function(){return(this._alignFlags&uCe.TOP)>0},set:function(e){this._setAlign(uCe.TOP,e),this._recursiveDirty()}},{key:"isAlignBottom",get:function(){return(this._alignFlags&uCe.BOT)>0},set:function(e){this._setAlign(uCe.BOT,e),this._recursiveDirty()}},{key:"isAlignLeft",get:function(){return(this._alignFlags&uCe.LEFT)>0},set:function(e){this._setAlign(uCe.LEFT,e),this._recursiveDirty()}},{key:"isAlignRight",get:function(){return(this._alignFlags&uCe.RIGHT)>0},set:function(e){this._setAlign(uCe.RIGHT,e),this._recursiveDirty()}},{key:"isAlignVerticalCenter",get:function(){return(this._alignFlags&uCe.MID)>0},set:function(e){e?(this.isAlignTop=!1,this.isAlignBottom=!1,this._alignFlags|=uCe.MID):this._alignFlags&=~uCe.MID,this._recursiveDirty()}},{key:"isAlignHorizontalCenter",get:function(){return(this._alignFlags&uCe.CENTER)>0},set:function(e){e?(this.isAlignLeft=!1,this.isAlignRight=!1,this._alignFlags|=uCe.CENTER):this._alignFlags&=~uCe.CENTER,this._recursiveDirty()}},{key:"isStretchWidth",get:function(){return(this._alignFlags&MCe)===MCe}},{key:"isStretchHeight",get:function(){return(this._alignFlags&NCe)===NCe}},{key:"top",get:function(){return this._top},set:function(e){this._top=e,this._recursiveDirty()}},{key:"editorTop",get:function(){return this._isAbsTop?this._top:100*this._top},set:function(e){this._top=this._isAbsTop?e:e/100,this._recursiveDirty()}},{key:"bottom",get:function(){return this._bottom},set:function(e){this._bottom=e,this._recursiveDirty()}},{key:"editorBottom",get:function(){return this._isAbsBottom?this._bottom:100*this._bottom},set:function(e){this._bottom=this._isAbsBottom?e:e/100,this._recursiveDirty()}},{key:"left",get:function(){return this._left},set:function(e){this._left=e,this._recursiveDirty()}},{key:"editorLeft",get:function(){return this._isAbsLeft?this._left:100*this._left},set:function(e){this._left=this._isAbsLeft?e:e/100,this._recursiveDirty()}},{key:"right",get:function(){return this._right},set:function(e){this._right=e,this._recursiveDirty()}},{key:"editorRight",get:function(){return this._isAbsRight?this._right:100*this._right},set:function(e){this._right=this._isAbsRight?e:e/100,this._recursiveDirty()}},{key:"horizontalCenter",get:function(){return this._horizontalCenter},set:function(e){this._horizontalCenter=e,this._recursiveDirty()}},{key:"editorHorizontalCenter",get:function(){return this._isAbsHorizontalCenter?this._horizontalCenter:100*this._horizontalCenter},set:function(e){this._horizontalCenter=this._isAbsHorizontalCenter?e:e/100,this._recursiveDirty()}},{key:"verticalCenter",get:function(){return this._verticalCenter},set:function(e){this._verticalCenter=e,this._recursiveDirty()}},{key:"editorVerticalCenter",get:function(){return this._isAbsVerticalCenter?this._verticalCenter:100*this._verticalCenter},set:function(e){this._verticalCenter=this._isAbsVerticalCenter?e:e/100,this._recursiveDirty()}},{key:"isAbsoluteTop",get:function(){return this._isAbsTop},set:function(e){this._isAbsTop!==e&&(this._isAbsTop=e,this._autoChangedValue(uCe.TOP,this._isAbsTop))}},{key:"isAbsoluteBottom",get:function(){return this._isAbsBottom},set:function(e){this._isAbsBottom!==e&&(this._isAbsBottom=e,this._autoChangedValue(uCe.BOT,this._isAbsBottom))}},{key:"isAbsoluteLeft",get:function(){return this._isAbsLeft},set:function(e){this._isAbsLeft!==e&&(this._isAbsLeft=e,this._autoChangedValue(uCe.LEFT,this._isAbsLeft))}},{key:"isAbsoluteRight",get:function(){return this._isAbsRight},set:function(e){this._isAbsRight!==e&&(this._isAbsRight=e,this._autoChangedValue(uCe.RIGHT,this._isAbsRight))}},{key:"isAbsoluteHorizontalCenter",get:function(){return this._isAbsHorizontalCenter},set:function(e){this._isAbsHorizontalCenter!==e&&(this._isAbsHorizontalCenter=e,this._autoChangedValue(uCe.CENTER,this._isAbsHorizontalCenter))}},{key:"isAbsoluteVerticalCenter",get:function(){return this._isAbsVerticalCenter},set:function(e){this._isAbsVerticalCenter!==e&&(this._isAbsVerticalCenter=e,this._autoChangedValue(uCe.MID,this._isAbsVerticalCenter))}},{key:"alignMode",get:function(){return this._alignMode},set:function(e){this._alignMode=e,this._recursiveDirty()}},{key:"alignFlags",get:function(){return this._alignFlags},set:function(e){this._alignFlags!==e&&(this._alignFlags=e,this._recursiveDirty())}}]),t}(ku),aCe.AlignMode=lCe,T((GTe=sCe).prototype,"target",[ETe,TTe],Object.getOwnPropertyDescriptor(GTe.prototype,"target"),GTe.prototype),T(GTe.prototype,"isAlignTop",[CTe],Object.getOwnPropertyDescriptor(GTe.prototype,"isAlignTop"),GTe.prototype),T(GTe.prototype,"isAlignBottom",[bTe],Object.getOwnPropertyDescriptor(GTe.prototype,"isAlignBottom"),GTe.prototype),T(GTe.prototype,"isAlignLeft",[ATe],Object.getOwnPropertyDescriptor(GTe.prototype,"isAlignLeft"),GTe.prototype),T(GTe.prototype,"isAlignRight",[wTe],Object.getOwnPropertyDescriptor(GTe.prototype,"isAlignRight"),GTe.prototype),T(GTe.prototype,"isAlignVerticalCenter",[ITe],Object.getOwnPropertyDescriptor(GTe.prototype,"isAlignVerticalCenter"),GTe.prototype),T(GTe.prototype,"isAlignHorizontalCenter",[PTe],Object.getOwnPropertyDescriptor(GTe.prototype,"isAlignHorizontalCenter"),GTe.prototype),T(GTe.prototype,"isStretchWidth",[RTe],Object.getOwnPropertyDescriptor(GTe.prototype,"isStretchWidth"),GTe.prototype),T(GTe.prototype,"isStretchHeight",[DTe],Object.getOwnPropertyDescriptor(GTe.prototype,"isStretchHeight"),GTe.prototype),T(GTe.prototype,"top",[OTe],Object.getOwnPropertyDescriptor(GTe.prototype,"top"),GTe.prototype),T(GTe.prototype,"editorTop",[Nc],Object.getOwnPropertyDescriptor(GTe.prototype,"editorTop"),GTe.prototype),T(GTe.prototype,"bottom",[NTe],Object.getOwnPropertyDescriptor(GTe.prototype,"bottom"),GTe.prototype),T(GTe.prototype,"editorBottom",[Nc],Object.getOwnPropertyDescriptor(GTe.prototype,"editorBottom"),GTe.prototype),T(GTe.prototype,"left",[MTe],Object.getOwnPropertyDescriptor(GTe.prototype,"left"),GTe.prototype),T(GTe.prototype,"editorLeft",[Nc],Object.getOwnPropertyDescriptor(GTe.prototype,"editorLeft"),GTe.prototype),T(GTe.prototype,"right",[LTe],Object.getOwnPropertyDescriptor(GTe.prototype,"right"),GTe.prototype),T(GTe.prototype,"editorRight",[Nc],Object.getOwnPropertyDescriptor(GTe.prototype,"editorRight"),GTe.prototype),T(GTe.prototype,"horizontalCenter",[FTe],Object.getOwnPropertyDescriptor(GTe.prototype,"horizontalCenter"),GTe.prototype),T(GTe.prototype,"editorHorizontalCenter",[Nc],Object.getOwnPropertyDescriptor(GTe.prototype,"editorHorizontalCenter"),GTe.prototype),T(GTe.prototype,"verticalCenter",[BTe],Object.getOwnPropertyDescriptor(GTe.prototype,"verticalCenter"),GTe.prototype),T(GTe.prototype,"editorVerticalCenter",[Nc],Object.getOwnPropertyDescriptor(GTe.prototype,"editorVerticalCenter"),GTe.prototype),T(GTe.prototype,"isAbsoluteTop",[Nc],Object.getOwnPropertyDescriptor(GTe.prototype,"isAbsoluteTop"),GTe.prototype),T(GTe.prototype,"isAbsoluteBottom",[Nc],Object.getOwnPropertyDescriptor(GTe.prototype,"isAbsoluteBottom"),GTe.prototype),T(GTe.prototype,"isAbsoluteLeft",[Nc],Object.getOwnPropertyDescriptor(GTe.prototype,"isAbsoluteLeft"),GTe.prototype),T(GTe.prototype,"isAbsoluteRight",[Nc],Object.getOwnPropertyDescriptor(GTe.prototype,"isAbsoluteRight"),GTe.prototype),T(GTe.prototype,"isAbsoluteHorizontalCenter",[Nc],Object.getOwnPropertyDescriptor(GTe.prototype,"isAbsoluteHorizontalCenter"),GTe.prototype),T(GTe.prototype,"isAbsoluteVerticalCenter",[Nc],Object.getOwnPropertyDescriptor(GTe.prototype,"isAbsoluteVerticalCenter"),GTe.prototype),T(GTe.prototype,"alignMode",[zTe,UTe],Object.getOwnPropertyDescriptor(GTe.prototype,"alignMode"),GTe.prototype),T(GTe.prototype,"alignFlags",[Nc],Object.getOwnPropertyDescriptor(GTe.prototype,"alignFlags"),GTe.prototype),HTe=T(GTe.prototype,"_alignFlags",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),VTe=T(GTe.prototype,"_target",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),WTe=T(GTe.prototype,"_left",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),jTe=T(GTe.prototype,"_right",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),qTe=T(GTe.prototype,"_top",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),XTe=T(GTe.prototype,"_bottom",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),YTe=T(GTe.prototype,"_horizontalCenter",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),KTe=T(GTe.prototype,"_verticalCenter",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),QTe=T(GTe.prototype,"_isAbsLeft",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),JTe=T(GTe.prototype,"_isAbsRight",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),ZTe=T(GTe.prototype,"_isAbsTop",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),$Te=T(GTe.prototype,"_isAbsBottom",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),eCe=T(GTe.prototype,"_isAbsHorizontalCenter",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),tCe=T(GTe.prototype,"_isAbsVerticalCenter",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),nCe=T(GTe.prototype,"_originalWidth",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),iCe=T(GTe.prototype,"_originalHeight",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),rCe=T(GTe.prototype,"_alignMode",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return lCe.ON_WINDOW_RESIZE}}),oCe=T(GTe.prototype,"_lockFlags",[Ec,Cc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),kTe=GTe))||kTe)||kTe)||kTe)||kTe)||kTe)||kTe));b.internal.computeInverseTransForTarget=fCe,b.internal.getReadonlyNodeSize=_Ce,b.Widget=LCe;var FCe,BCe=new Qn;!function(e){e[e.HORIZONTAL=0]="HORIZONTAL",e[e.VERTICAL=1]="VERTICAL"}(FCe||(FCe={})),et(FCe);var zCe,UCe,kCe,GCe,HCe,VCe,WCe,jCe,qCe,XCe,YCe,KCe,QCe,JCe,ZCe,$Ce,ebe,tbe,nbe,ibe,rbe,obe,abe,sbe,cbe,lbe,ube,hbe,_be,fbe,dbe,pbe,mbe,vbe,gbe,ybe,xbe,Sbe,Ebe,Tbe,Cbe,bbe,Abe,wbe=e("PageViewIndicator",(dCe=dc("cc.PageViewIndicator"),pCe=Oc(),mCe=mc(110),vCe=Ic(),gCe=Jc(cF),yCe=Bc(),xCe=Jc(FCe),SCe=Bc(),ECe=Jc(jn),TCe=Bc(),CCe=Bc(),dCe(bCe=pCe(bCe=mCe(bCe=vCe((OCe=DCe=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return E(t=e.call.apply(e,[this].concat(i))||this,"spacing",wCe,y(t)),E(t,"_spriteFrame",ICe,y(t)),E(t,"_direction",PCe,y(t)),E(t,"_cellSize",RCe,y(t)),t._layout=null,t._pageView=null,t._indicators=[],t}f(t,e);var n=t.prototype;return n.onLoad=function(){this._updateLayout()},n.setPageView=function(e){this._pageView=e,this._refresh()},n._updateLayout=function(){this._layout=this.getComponent(Ixe),this._layout||(this._layout=this.addComponent(Ixe));var e=this._layout;this.direction===FCe.HORIZONTAL?(e.type=Ixe.Type.HORIZONTAL,e.spacingX=this.spacing):this.direction===FCe.VERTICAL&&(e.type=Ixe.Type.VERTICAL,e.spacingY=this.spacing),e.resizeMode=Ixe.ResizeMode.CONTAINER},n._createIndicator=function(){var e=new jb;e.layer=this.node.layer;var t=e.addComponent(nH);return t.spriteFrame=this.spriteFrame,t.sizeMode=nH.SizeMode.CUSTOM,e.parent=this.node,e._uiProps.uiTransformComp.setContentSize(this._cellSize),e},n._changedState=function(){var e=this._indicators;if(0!==e.length&&this._pageView){var t=this._pageView.curPageIdx;if(!(t>=e.length)){for(var n=0;n<e.length;++n){var i=e[n];if(i._uiProps.uiComp){var r=i._uiProps.uiComp;BCe.set(r.color),BCe.a=127.5,r.color=BCe}}if(e[t]._uiProps.uiComp){var o=e[t]._uiProps.uiComp;BCe.set(o.color),BCe.a=255,o.color=BCe}}}},n._refresh=function(){if(this._pageView){var e=this._indicators,t=this._pageView.getPages();if(t.length!==e.length){var n=0;if(t.length>e.length)for(n=0;n<t.length;++n)e[n]||(e[n]=this._createIndicator());else for(n=e.length-t.length;n>0;--n){var i=e[n-1];this.node.removeChild(i),e.splice(n-1,1)}this._layout&&this._layout.enabledInHierarchy&&this._layout.updateLayout(),this._changedState()}}},h(t,[{key:"spriteFrame",get:function(){return this._spriteFrame},set:function(e){this._spriteFrame!==e&&(this._spriteFrame=e)}},{key:"direction",get:function(){return this._direction},set:function(e){this._direction!==e&&(this._direction=e)}},{key:"cellSize",get:function(){return this._cellSize},set:function(e){this._cellSize!==e&&(this._cellSize=e)}}]),t}(ku),DCe.Direction=FCe,T((ACe=OCe).prototype,"spriteFrame",[gCe,yCe],Object.getOwnPropertyDescriptor(ACe.prototype,"spriteFrame"),ACe.prototype),T(ACe.prototype,"direction",[xCe,SCe],Object.getOwnPropertyDescriptor(ACe.prototype,"direction"),ACe.prototype),T(ACe.prototype,"cellSize",[ECe,TCe],Object.getOwnPropertyDescriptor(ACe.prototype,"cellSize"),ACe.prototype),wCe=T(ACe.prototype,"spacing",[Ec,CCe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),ICe=T(ACe.prototype,"_spriteFrame",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),PCe=T(ACe.prototype,"_direction",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return FCe.HORIZONTAL}}),RCe=T(ACe.prototype,"_cellSize",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new jn(20,20)}}),bCe=ACe))||bCe)||bCe)||bCe)||bCe));b.PageViewIndicator=wbe;var Ibe,Pbe,Rbe,Dbe=new Tn;!function(e){e[e.Unified=0]="Unified",e[e.Free=1]="Free"}(Ibe||(Ibe={})),et(Ibe),function(e){e[e.Horizontal=0]="Horizontal",e[e.Vertical=1]="Vertical"}(Pbe||(Pbe={})),et(Pbe),function(e){e.PAGE_TURNING="page-turning"}(Rbe||(Rbe={}));var Obe=e("PageView",(zCe=dc("cc.PageView"),UCe=Oc(),kCe=mc(110),GCe=Ic(),HCe=Jc(Ibe),VCe=Bc(),WCe=Jc(Pbe),jCe=Bc(),qCe=zc(),XCe=Bc(),YCe=zc(),KCe=Bc(),QCe=Jc(wbe),JCe=Bc(),ZCe=Bc(),$Ce=Jc(cSe),ebe=Mc(),tbe=Jc(cSe),nbe=Mc(),ibe=Mc(),rbe=Mc(),obe=Mc(),abe=Jc([AL]),sbe=Mc(),cbe=Bc(),lbe=Jc([AL]),ube=Bc(),zCe(hbe=UCe(hbe=kCe(hbe=GCe((Abe=bbe=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return E(t=e.call.apply(e,[this].concat(i))||this,"autoPageTurningThreshold",fbe,y(t)),E(t,"horizontal",dbe,y(t)),E(t,"vertical",pbe,y(t)),E(t,"cancelInnerEvents",mbe,y(t)),E(t,"scrollEvents",vbe,y(t)),E(t,"pageTurningSpeed",gbe,y(t)),E(t,"pageEvents",ybe,y(t)),E(t,"_sizeMode",xbe,y(t)),E(t,"_direction",Sbe,y(t)),E(t,"_scrollThreshold",Ebe,y(t)),E(t,"_pageTurningEventTiming",Tbe,y(t)),E(t,"_indicator",Cbe,y(t)),t._curPageIdx=0,t._lastPageIdx=0,t._pages=[],t._initContentPos=new yn,t._scrollCenterOffsetX=[],t._scrollCenterOffsetY=[],t._touchBeganPosition=new Tn,t._touchEndPosition=new Tn,t}f(t,e);var n=t.prototype;return n.onEnable=function(){e.prototype.onEnable.call(this),this.node.on(VT.SIZE_CHANGED,this._updateAllPagesSize,this),this.node.on(t.EventType.SCROLL_ENG_WITH_THRESHOLD,this._dispatchPageTurningEvent,this)},n.onDisable=function(){e.prototype.onDisable.call(this),this.node.off(VT.SIZE_CHANGED,this._updateAllPagesSize,this),this.node.off(t.EventType.SCROLL_ENG_WITH_THRESHOLD,this._dispatchPageTurningEvent,this)},n.onLoad=function(){this._initPages(),this.indicator&&this.indicator.setPageView(this)},n.getCurrentPageIndex=function(){return this._curPageIdx},n.setCurrentPageIndex=function(e){this.scrollToPage(e,1)},n.getPages=function(){return this._pages},n.addPage=function(e){e&&-1===this._pages.indexOf(e)&&this.content&&(e._uiProps.uiTransformComp?(this.content.addChild(e),this._pages.push(e),this._updatePageView()):W(4301))},n.insertPage=function(e,t){if(!(t<0)&&e&&-1===this._pages.indexOf(e)&&this.content)if(t>=this._pages.length)this.addPage(e);else{if(!e._uiProps.uiTransformComp)return void W(4301);this._pages.splice(t,0,e),this.content.insertChild(e,t),this._updatePageView()}},n.removePage=function(e){if(e&&this.content){var t=this._pages.indexOf(e);-1!==t?this.removePageAtIndex(t):q(4300,e.name)}},n.removePageAtIndex=function(e){var t=this._pages;if(!(e<0||e>=t.length)){var n=t[e];n&&this.content&&(this.content.removeChild(n),t.splice(e,1),this._updatePageView())}},n.removeAllPages=function(){if(this.content){for(var e=this._pages,t=0,n=e.length;t<n;t++)this.content.removeChild(e[t]);this._pages.length=0,this._updatePageView()}},n.scrollToPage=function(e,t){void 0===t&&(t=.3),e<0||e>=this._pages.length||(this._curPageIdx=e,this.scrollToOffset(this._moveOffsetValue(e),t,!0),this.indicator&&this.indicator._changedState())},n.getScrollEndedEventTiming=function(){return this.pageTurningEventTiming},n._updatePageView=function(){if(this.content){var e=this.content.getComponent(Ixe);e&&e.enabled&&e.updateLayout();var t=this._pages.length;this._curPageIdx>=t&&(this._curPageIdx=0===t?0:t-1,this._lastPageIdx=this._curPageIdx);for(var n=this._initContentPos,i=0;i<t;++i){var r=this._pages[i].position;this.direction===Pbe.Horizontal?this._scrollCenterOffsetX[i]=Math.abs(n.x+r.x):this._scrollCenterOffsetY[i]=Math.abs(n.y+r.y)}this.indicator&&this.indicator._refresh()}},n._updateAllPagesSize=function(){var e=this.view;if(this.content&&e&&this._sizeMode===Ibe.Unified)for(var t=this._pages,n=e.contentSize,i=0,r=t.length;i<r;i++)t[i]._uiProps.uiTransformComp.setContentSize(n)},n._handleReleaseLogic=function(){this._autoScrollToPage(),this._scrolling&&(this._scrolling=!1,this._autoScrolling||this._dispatchEvent(t.EventType.SCROLL_ENDED))},n._onTouchBegan=function(t,n){t.touch.getUILocation(Dbe),Tn.set(this._touchBeganPosition,Dbe.x,Dbe.y),e.prototype._onTouchBegan.call(this,t,n)},n._onTouchMoved=function(t,n){e.prototype._onTouchMoved.call(this,t,n)},n._onTouchEnded=function(t,n){t.touch.getUILocation(Dbe),Tn.set(this._touchEndPosition,Dbe.x,Dbe.y),e.prototype._onTouchEnded.call(this,t,n)},n._onTouchCancelled=function(t,n){t.touch.getUILocation(Dbe),Tn.set(this._touchEndPosition,Dbe.x,Dbe.y),e.prototype._onTouchCancelled.call(this,t,n)},n._onMouseWheel=function(){},n._syncScrollDirection=function(){this.horizontal=this.direction===Pbe.Horizontal,this.vertical=this.direction===Pbe.Vertical},n._syncSizeMode=function(){var e=this.view;if(this.content&&e){var t=this.content.getComponent(Ixe);if(t){if(this._sizeMode===Ibe.Free&&this._pages.length>0){var n=this._pages[0]._uiProps.uiTransformComp,i=this._pages[this._pages.length-1]._uiProps.uiTransformComp;this.direction===Pbe.Horizontal?(t.paddingLeft=(e.width-n.width)/2,t.paddingRight=(e.width-i.width)/2):this.direction===Pbe.Vertical&&(t.paddingTop=(e.height-n.height)/2,t.paddingBottom=(e.height-i.height)/2)}t.updateLayout()}}},n._initPages=function(){if(this.content){this._initContentPos=this.content.position;for(var e=this.content.children,t=0;t<e.length;++t){var n=e[t];this._pages.indexOf(n)>=0||this._pages.push(n)}this._syncScrollDirection(),this._syncSizeMode(),this._updatePageView()}},n._dispatchPageTurningEvent=function(){this._lastPageIdx!==this._curPageIdx&&(this._lastPageIdx=this._curPageIdx,AL.emitEvents(this.pageEvents,this,Rbe.PAGE_TURNING),this.node.emit(Rbe.PAGE_TURNING,this))},n._isQuicklyScrollable=function(e){if(this.direction===Pbe.Horizontal){if(Math.abs(e.x)>this.autoPageTurningThreshold)return!0}else if(this.direction===Pbe.Vertical&&Math.abs(e.y)>this.autoPageTurningThreshold)return!0;return!1},n._moveOffsetValue=function(e){var t=new Tn;if(this._sizeMode===Ibe.Free)this.direction===Pbe.Horizontal?t.x=this._scrollCenterOffsetX[e]:this.direction===Pbe.Vertical&&(t.y=this._scrollCenterOffsetY[e]);else{var n=this.view;if(!n)return t;this.direction===Pbe.Horizontal?t.x=e*n.width:this.direction===Pbe.Vertical&&(t.y=e*n.height)}return t},n._getDragDirection=function(e){return this._direction===Pbe.Horizontal?0===e.x?0:e.x>0?1:-1:0===e.y?0:e.y<0?1:-1},n._isScrollable=function(e,t,n){if(this._sizeMode===Ibe.Free){var i=0,r=0;if(this.direction===Pbe.Horizontal)return i=this._scrollCenterOffsetX[t],r=this._scrollCenterOffsetX[n],Math.abs(e.x)>=Math.abs(i-r)*this.scrollThreshold;if(this.direction===Pbe.Vertical)return i=this._scrollCenterOffsetY[t],r=this._scrollCenterOffsetY[n],Math.abs(e.y)>=Math.abs(i-r)*this.scrollThreshold}else{var o=this.view;if(!o)return!1;if(this.direction===Pbe.Horizontal)return Math.abs(e.x)>=o.width*this.scrollThreshold;if(this.direction===Pbe.Vertical)return Math.abs(e.y)>=o.height*this.scrollThreshold}return!1},n._autoScrollToPage=function(){if(this._startBounceBackIfNeeded()){var e=this._getHowMuchOutOfBoundary();this._clampDelta(e),(e.x>0||e.y<0)&&(this._curPageIdx=0===this._pages.length?0:this._pages.length-1),(e.x<0||e.y>0)&&(this._curPageIdx=0),this.indicator&&this.indicator._changedState()}else{var t=new Tn;Tn.subtract(t,this._touchBeganPosition,this._touchEndPosition);var n=this._curPageIdx,i=n+this._getDragDirection(t),r=this.pageTurningSpeed*Math.abs(n-i);if(i<this._pages.length){if(this._isScrollable(t,n,i))return void this.scrollToPage(i,r);var o=this._calculateTouchMoveVelocity();if(this._isQuicklyScrollable(o))return void this.scrollToPage(i,r)}this.scrollToPage(n,r)}},h(t,[{key:"sizeMode",get:function(){return this._sizeMode},set:function(e){this._sizeMode!==e&&(this._sizeMode=e,this._syncSizeMode())}},{key:"direction",get:function(){return this._direction},set:function(e){this._direction!==e&&(this._direction=e,this._syncScrollDirection())}},{key:"scrollThreshold",get:function(){return this._scrollThreshold},set:function(e){this._scrollThreshold!==e&&(this._scrollThreshold=e)}},{key:"pageTurningEventTiming",get:function(){return this._pageTurningEventTiming},set:function(e){this._pageTurningEventTiming!==e&&(this._pageTurningEventTiming=e)}},{key:"indicator",get:function(){return this._indicator},set:function(e){this._indicator!==e&&(this._indicator=e,this.indicator&&this.indicator.setPageView(this))}},{key:"curPageIdx",get:function(){return this._curPageIdx}},{key:"verticalScrollBar",get:function(){return e.prototype.verticalScrollBar},set:function(e){this.verticalScrollBar=e}},{key:"horizontalScrollBar",get:function(){return e.prototype.horizontalScrollBar},set:function(e){this.horizontalScrollBar=e}}]),t}(NEe),bbe.SizeMode=Ibe,bbe.Direction=Pbe,bbe.EventType=iTe(Rbe,rEe),T((_be=Abe).prototype,"sizeMode",[HCe,VCe],Object.getOwnPropertyDescriptor(_be.prototype,"sizeMode"),_be.prototype),T(_be.prototype,"direction",[WCe,jCe],Object.getOwnPropertyDescriptor(_be.prototype,"direction"),_be.prototype),T(_be.prototype,"scrollThreshold",[Hc,qCe,XCe],Object.getOwnPropertyDescriptor(_be.prototype,"scrollThreshold"),_be.prototype),T(_be.prototype,"pageTurningEventTiming",[Hc,YCe,KCe],Object.getOwnPropertyDescriptor(_be.prototype,"pageTurningEventTiming"),_be.prototype),T(_be.prototype,"indicator",[QCe,JCe],Object.getOwnPropertyDescriptor(_be.prototype,"indicator"),_be.prototype),fbe=T(_be.prototype,"autoPageTurningThreshold",[Ec,ZCe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 100}}),T(_be.prototype,"verticalScrollBar",[$Ce,$c,ebe],Object.getOwnPropertyDescriptor(_be.prototype,"verticalScrollBar"),_be.prototype),T(_be.prototype,"horizontalScrollBar",[tbe,$c,nbe],Object.getOwnPropertyDescriptor(_be.prototype,"horizontalScrollBar"),_be.prototype),dbe=T(_be.prototype,"horizontal",[$c,Ec,ibe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),pbe=T(_be.prototype,"vertical",[$c,Ec,rbe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),mbe=T(_be.prototype,"cancelInnerEvents",[$c,Ec,obe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),vbe=T(_be.prototype,"scrollEvents",[abe,Ec,$c,sbe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),gbe=T(_be.prototype,"pageTurningSpeed",[Ec,Nc,cbe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.3}}),ybe=T(_be.prototype,"pageEvents",[lbe,Ec,ube],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),xbe=T(_be.prototype,"_sizeMode",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ibe.Unified}}),Sbe=T(_be.prototype,"_direction",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Pbe.Horizontal}}),Ebe=T(_be.prototype,"_scrollThreshold",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.5}}),Tbe=T(_be.prototype,"_pageTurningEventTiming",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),Cbe=T(_be.prototype,"_indicator",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),hbe=_be))||hbe)||hbe)||hbe)||hbe));b.PageView=Obe;var Nbe=new yn,Mbe=new Tn,Lbe=new Tn,Fbe=new Tn(1,1),Bbe=new Tn,zbe=new Tn;function Ube(e,t){if(!t._hadAlignOnce){t.alignMode===lCe.ONCE&&(t._hadAlignOnce=!0);var n,i=t.target,r=Lbe,o=Fbe;i?fCe(e,n=i,r,o):n=e.parent;var a=_Ce(n),s=n instanceof XP||!n.getComponent(zB),c=s?Mbe:n.getComponent(zB).anchorPoint,l=s;e.getPosition(Nbe);var u=e._uiProps.uiTransformComp,h=Nbe.x,_=Nbe.y,f=u.anchorPoint,d=e.getScale();if(t.alignFlags&uCe.HORIZONTAL){var p=0,m=0,v=a.width;l?(p=tO.left.x,m=tO.right.x):m=(p=-c.x*v)+v,p+=t.isAbsoluteLeft?t.left:t.left*v,m-=t.isAbsoluteRight?t.right:t.right*v,i&&(p+=r.x,p*=o.x,m+=r.x,m*=o.x);var g=0,y=f.x,x=d.x;if(x<0&&(y=1-y,x=-x),t.isStretchWidth)g=m-p,0!==x&&(u.width=g/x),h=p+y*g;else if(g=u.width*x,t.isAlignHorizontalCenter){var S=t.isAbsoluteHorizontalCenter?t.horizontalCenter:t.horizontalCenter*v,E=(.5-c.x)*a.width;i&&(S*=o.x,E+=r.x,E*=o.x),h=E+(y-.5)*g+S}else h=t.isAlignLeft?p+y*g:m+(y-1)*g;t._lastSize.width=g}if(t.alignFlags&uCe.VERTICAL){var T=0,C=0,b=a.height;l?(C=tO.bottom.y,T=tO.top.y):T=(C=-c.y*b)+b,C+=t.isAbsoluteBottom?t.bottom:t.bottom*b,T-=t.isAbsoluteTop?t.top:t.top*b,i&&(C+=r.y,C*=o.y,T+=r.y,T*=o.y);var A=0,w=f.y,I=d.y;if(I<0&&(w=1-w,I=-I),t.isStretchHeight)A=T-C,0!==I&&(u.height=A/I),_=C+w*A;else if(A=u.height*I,t.isAlignVerticalCenter){var P=t.isAbsoluteVerticalCenter?t.verticalCenter:t.verticalCenter*b,R=(.5-c.y)*a.height;i&&(P*=o.y,R+=r.y,R*=o.y),_=R+(w-.5)*A+P}else _=t.isAlignBottom?C+w*A:T+(w-1)*A;t._lastSize.height=A}e.setPosition(h,_,Nbe.z),yn.set(t._lastPos,h,_,Nbe.z)}}function kbe(e){var t=e.getComponent(LCe);if(t&&t.enabled){if(!b.isValid(e,!0))return;Vbe.push(t)}for(var n,i=S(e.children);!(n=i()).done;){var r=n.value;r.active&&kbe(r)}}function Gbe(){var e=KO.getScene();if(e){Wbe.isAligning=!0,Wbe._nodesOrderDirty&&(Vbe.length=0,kbe(e),Wbe._nodesOrderDirty=!1);var t=null,n=Wbe._activeWidgetsIterator;for(n.i=0;n.i<Vbe.length;++n.i)(t=Vbe[n.i])._dirty&&(Ube(t.node,t),t._dirty=!1);Wbe.isAligning=!1}}var Hbe,Vbe=[],Wbe=e("widgetManager",b._widgetManager={isAligning:!1,_nodesOrderDirty:!1,_activeWidgetsIterator:new Ye.MutableForwardIterator(Vbe),animationState:null,init:function(){KO.on(YO.EVENT_AFTER_SCENE_LAUNCH,Gbe),KO.on(YO.EVENT_AFTER_UPDATE,Gbe),OO.instance.on("design-resolution-changed",this.onResized,this);var e=this.onResized.bind(this);OO.instance.on("canvas-resize",e),Xu.on("orientation-change",e)},add:function(){this._nodesOrderDirty=!0},remove:function(e){this._activeWidgetsIterator.remove(e)},onResized:function(){var e=KO.getScene();e&&this.refreshWidgetOnResized(e)},refreshWidgetOnResized:function(e){var t=jb.isNode(e)&&e.getComponent(LCe);t&&t.enabled&&(t.alignMode===lCe.ON_WINDOW_RESIZE||t.alignMode===lCe.ALWAYS)&&t.setDirty();for(var n,i=S(e.children);!(n=i()).done;){var r=n.value;this.refreshWidgetOnResized(r)}},updateOffsetsToStayPut:function(e,t){function n(e,t){return Math.abs(e-t)>1e-10?t:e}var i=e.node,r=i.parent;if(r){var o=Bbe;o.set(0,0);var a=zbe;if(a.set(1,1),e.target&&fCe(i,r=e.target,o,a),!t)return;var s=r._uiProps&&r._uiProps.uiTransformComp,c=s?s.anchorPoint:Mbe,l=i._uiProps.uiTransformComp,u=_Ce(r),h=l.anchorPoint,_=i.getPosition(),f=uCe,d=i.getScale(),p=0;if(t&f.LEFT){var m=-c.x*u.width;m+=o.x,m*=a.x,p=_.x-h.x*l.width*Math.abs(d.x)-m,e.isAbsoluteLeft||(p/=u.width),p/=a.x,e.left=n(e.left,p)}if(t&f.RIGHT){var v=(1-c.x)*u.width;v+=o.x,p=(v*=a.x)-(_.x+(1-h.x)*l.width*Math.abs(d.x)),e.isAbsoluteRight||(p/=u.width),p/=a.x,e.right=n(e.right,p)}if(t&f.TOP){var g=(1-c.y)*u.height;g+=o.y,p=(g*=a.y)-(_.y+(1-h.y)*l.height*Math.abs(d.y)),e.isAbsoluteTop||(p/=u.height),p/=a.y,e.top=n(e.top,p)}if(t&f.BOT){var y=-c.y*u.height;y+=o.y,y*=a.y,p=_.y-h.y*l.height*Math.abs(d.y)-y,e.isAbsoluteBottom||(p/=u.height),p/=a.y,e.bottom=n(e.bottom,p)}}},updateAlignment:function e(t){var n=t.parent;n&&jb.isNode(n)&&e(n);var i=t.getComponent(LCe);i&&n&&Ube(t,i)},AlignMode:lCe,AlignFlags:uCe});KO.on(YO.EVENT_INIT,(function(){Wbe.init()}));var jbe,qbe,Xbe,Ybe,Kbe,Qbe,Jbe,Zbe,$be,eAe,tAe,nAe,iAe,rAe,oAe,aAe,sAe,cAe,lAe,uAe=e("SafeArea",dc("cc.SafeArea")(Hbe=Oc()(Hbe=mc(110)(Hbe=wc(Hbe=Ic()(Hbe=pc(LCe)(Hbe=function(e){function t(){return e.apply(this,arguments)||this}f(t,e);var n=t.prototype;return n.onEnable=function(){this.updateArea(),Xu.on("window-resize",this.updateArea,this),Xu.on("orientation-change",this.updateArea,this)},n.onDisable=function(){Xu.off("window-resize",this.updateArea,this),Xu.off("orientation-change",this.updateArea,this)},n.updateArea=function(){var e=this.node.getComponent(LCe),t=this.node.getComponent(zB);if(e&&t){e.updateAlignment();var n=this.node.position.clone(),i=t.anchorPoint.clone();e.isAlignTop=e.isAlignBottom=e.isAlignLeft=e.isAlignRight=!0;var r=BO.getVisibleSize(),o=r.width,a=r.height,s=Qu.getSafeAreaRect();e.top=a-s.y-s.height,e.bottom=s.y,e.left=s.x,e.right=o-s.x-s.width,e.updateAlignment();var c=this.node.position.clone(),l=i.x-(c.x-n.x)/t.width,u=i.y-(c.y-n.y)/t.height;t.setAnchorPoint(l,u),Wbe.add(e)}},t}(ku))||Hbe)||Hbe)||Hbe)||Hbe)||Hbe)||Hbe);b.SafeArea=uAe,e("UICoordinateTracker",(jbe=dc("cc.UICoordinateTracker"),qbe=Oc(),Xbe=Ic(),Ybe=mc(110),Kbe=Jc(jb),Qbe=Bc(),Jbe=Jc(VL),Zbe=Bc(),$be=Bc(),eAe=Bc(),tAe=Jc([AL]),nAe=Bc(),jbe(iAe=qbe(iAe=Xbe(iAe=Ybe((T((rAe=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return E(t=e.call.apply(e,[this].concat(i))||this,"syncEvents",oAe,y(t)),E(t,"_target",aAe,y(t)),E(t,"_camera",sAe,y(t)),E(t,"_useScale",cAe,y(t)),E(t,"_distance",lAe,y(t)),t._transformPos=new yn,t._viewPos=new yn,t._canMove=!0,t._lastWPos=new yn,t._lastCameraPos=new yn,t}f(t,e);var n=t.prototype;return n.onEnable=function(){this._checkCanMove()},n.update=function(){var e=this.node.worldPosition,t=this._camera;if(this._canMove&&t&&t.camera&&(!this._lastWPos.equals(e)||!this._lastCameraPos.equals(t.node.worldPosition))&&(this._lastWPos.set(e),this._lastCameraPos.set(t.node.worldPosition),t.camera.update(),t.convertToUINode(e,this._target,this._transformPos),this._useScale&&yn.transformMat4(this._viewPos,this.node.worldPosition,t.camera.matView),this.syncEvents.length>0)){var n=this._distance/Math.abs(this._viewPos.z);AL.emitEvents(this.syncEvents,this._transformPos,n)}},n._checkCanMove=function(){this._canMove=!(!this._camera||!this._target)},h(t,[{key:"target",get:function(){return this._target},set:function(e){this._target!==e&&(this._target=e,this._checkCanMove())}},{key:"camera",get:function(){return this._camera},set:function(e){this._camera!==e&&(this._camera=e,this._checkCanMove())}},{key:"useScale",get:function(){return this._useScale},set:function(e){this._useScale!==e&&(this._useScale=e)}},{key:"distance",get:function(){return this._distance},set:function(e){this._distance!==e&&(this._distance=e)}}]),t}(ku)).prototype,"target",[Kbe,Qbe],Object.getOwnPropertyDescriptor(rAe.prototype,"target"),rAe.prototype),T(rAe.prototype,"camera",[Jbe,Zbe],Object.getOwnPropertyDescriptor(rAe.prototype,"camera"),rAe.prototype),T(rAe.prototype,"useScale",[$be],Object.getOwnPropertyDescriptor(rAe.prototype,"useScale"),rAe.prototype),T(rAe.prototype,"distance",[eAe],Object.getOwnPropertyDescriptor(rAe.prototype,"distance"),rAe.prototype),oAe=T(rAe.prototype,"syncEvents",[tAe,Ec,nAe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),aAe=T(rAe.prototype,"_target",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),sAe=T(rAe.prototype,"_camera",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),cAe=T(rAe.prototype,"_useScale",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),lAe=T(rAe.prototype,"_distance",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),iAe=rAe))||iAe)||iAe)||iAe)||iAe));var hAe,_Ae=[VT.TOUCH_START,VT.TOUCH_END,VT.TOUCH_MOVE,VT.MOUSE_DOWN,VT.MOUSE_MOVE,VT.MOUSE_UP,VT.MOUSE_ENTER,VT.MOUSE_LEAVE,VT.MOUSE_WHEEL];function fAe(e){e.propagationStopped=!0}e("BlockInputEvents",dc("cc.BlockInputEvents")(hAe=Oc()(hAe=Ic()(hAe=function(e){function t(){return e.apply(this,arguments)||this}f(t,e);var n=t.prototype;return n.onEnable=function(){for(var e=0;e<_Ae.length;e++)this.node.on(_Ae[e],fAe,this)},n.onDisable=function(){for(var e=0;e<_Ae.length;e++)this.node.off(_Ae[e],fAe,this)},t}(ku))||hAe)||hAe)||hAe);var dAe,pAe,mAe,vAe,gAe,yAe,xAe,SAe,EAe,TAe,CAe,bAe=e("SubContextView",(dAe=dc("cc.SubContextView"),pAe=Oc(),mAe=mc(110),vAe=pc(zB),gAe=Ic(),yAe=Bc(),xAe=Bc(),dAe(SAe=pAe(SAe=mAe(SAe=vAe(SAe=gAe((T((EAe=function(e){function t(){var t;return E(t=e.call(this)||this,"_fps",TAe,y(t)),t._sprite=void 0,t._imageAsset=void 0,t._texture=void 0,t._updatedTime=0,t._updateInterval=0,t._openDataContext=void 0,t._content=void 0,E(t,"_designResolutionSize",CAe,y(t)),t._content=new jb("content"),t._content.hideFlags|=ol.Flags.DontSave|ol.Flags.HideInHierarchy,t._sprite=null,t._imageAsset=new Cm,t._openDataContext=null,t._updatedTime=performance.now(),t._texture=new Xm,t}f(t,e);var n=t.prototype;return n.onLoad=function(){KL.getOpenDataContext?(this._updateInterval=1e3/this._fps,this._openDataContext=KL.getOpenDataContext(),this._initSharedCanvas(),this._initContentNode(),this._updateSubContextView(),this._updateContentLayer()):this.enabled=!1},n.onEnable=function(){this._registerNodeEvent()},n.onDisable=function(){this._unregisterNodeEvent()},n._initSharedCanvas=function(){if(this._openDataContext){var e=this._openDataContext.canvas,t=this._designResolutionSize.width,n=this._designResolutionSize.height;e.width=t,e.height=n}},n._initContentNode=function(){if(this._openDataContext){var e=this._openDataContext.canvas,t=this._imageAsset;if(t.reset(e),this._texture.image=t,this._texture.create(e.width,e.height),this._sprite=this._content.getComponent(nH),this._sprite||(this._sprite=this._content.addComponent(nH)),this._sprite.spriteFrame)this._sprite.spriteFrame.texture=this._texture;else{var n=new cF;n.texture=this._texture,this._sprite.spriteFrame=n}this._content.parent=this.node}},n._updateSubContextView=function(){if(this._openDataContext){var e=this.node.getComponent(zB),t=this._content.getComponent(zB),n=e.width/t.width,i=e.height/t.height,r=n>i?i:n;t.width*=r,t.height*=r;var o=BO.getViewportRect(),a=t.getBoundingBoxToWorld(),s=BO.getVisibleSize(),c=Xu.devicePixelRatio,l=(o.width*(a.x/s.width)+o.x)/c,u=(o.height*(a.y/s.height)+o.y)/c,h=o.width*(a.width/s.width)/c,_=o.height*(a.height/s.height)/c;this._openDataContext.postMessage({fromEngine:!0,type:"engine",event:"viewport",x:l,y:u,width:h,height:_})}},n._updateSubContextTexture=function(){var e=this._imageAsset;if(e&&this._openDataContext&&!(e.width<=0||e.height<=0)){var t=this._openDataContext.canvas;e.reset(t),(t.width>e.width||t.height>e.height)&&this._texture.create(t.width,t.height),this._texture.uploadData(t)}},n._registerNodeEvent=function(){this.node.on(VT.TRANSFORM_CHANGED,this._updateSubContextView,this),this.node.on(VT.SIZE_CHANGED,this._updateSubContextView,this),this.node.on(VT.LAYER_CHANGED,this._updateContentLayer,this)},n._unregisterNodeEvent=function(){this.node.off(VT.TRANSFORM_CHANGED,this._updateSubContextView,this),this.node.off(VT.SIZE_CHANGED,this._updateSubContextView,this),this.node.off(VT.LAYER_CHANGED,this._updateContentLayer,this)},n._updateContentLayer=function(){this._content.layer=this.node.layer},n.update=function(e){void 0===e?this._updateSubContextTexture():performance.now()-this._updatedTime>=this._updateInterval&&(this._updatedTime+=this._updateInterval,this._updateSubContextTexture())},n.onDestroy=function(){this._content.destroy(),this._texture.destroy(),this._sprite&&this._sprite.destroy(),this._imageAsset.destroy(),this._openDataContext=null},h(t,[{key:"designResolutionSize",get:function(){return this._designResolutionSize},set:function(){}},{key:"fps",get:function(){return this._fps},set:function(e){this._fps!==e&&(this._fps=e,this._updateInterval=1e3/e)}}]),t}(ku)).prototype,"designResolutionSize",[yAe],Object.getOwnPropertyDescriptor(EAe.prototype,"designResolutionSize"),EAe.prototype),T(EAe.prototype,"fps",[xAe],Object.getOwnPropertyDescriptor(EAe.prototype,"fps"),EAe.prototype),TAe=T(EAe.prototype,"_fps",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 60}}),CAe=T(EAe.prototype,"_designResolutionSize",[Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new jn(640,960)}}),SAe=EAe))||SAe)||SAe)||SAe)||SAe)||SAe));b.SubContextView=bAe}}}));
