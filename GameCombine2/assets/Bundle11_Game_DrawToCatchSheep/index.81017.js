window.__require=function t(e,i,o){function n(r,c){if(!i[r]){if(!e[r]){var h=r.split("/");if(h=h[h.length-1],!e[h]){var a="function"==typeof __require&&__require;if(!c&&a)return a(h,!0);if(s)return s(h,!0);throw new Error("Cannot find module '"+r+"'")}r=h}var p=i[r]={exports:{}};e[r][0].call(p.exports,function(t){return n(e[r][1][t]||t)},p,p.exports,t,e,i,o)}return i[r].exports}for(var s="function"==typeof __require&&__require,r=0;r<o.length;r++)n(o[r]);return n}({DrawToCatchSheep_Game:[function(t,e,i){"use strict";cc._RF.push(e,"871cdHvF+RAPKgGeCqbWdu+","DrawToCatchSheep_Game");var o,n=this&&this.__extends||(o=function(t,e){return(o=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i])})(t,e)},function(t,e){function i(){this.constructor=t}o(t,e),t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)}),s=this&&this.__decorate||function(t,e,i,o){var n,s=arguments.length,r=s<3?e:null===o?o=Object.getOwnPropertyDescriptor(e,i):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(t,e,i,o);else for(var c=t.length-1;c>=0;c--)(n=t[c])&&(r=(s<3?n(r):s>3?n(e,i,r):n(e,i))||r);return s>3&&r&&Object.defineProperty(e,i,r),r};Object.defineProperty(i,"__esModule",{value:!0});var r=t("../../Bundle1_Loading/Scripts/Config/EnumTypes"),c=t("../../Bundle1_Loading/Scripts/Mgr/AssetMgr"),h=t("../../Bundle1_Loading/Scripts/Mgr/EventMgr"),a=t("../../Bundle1_Loading/Scripts/Mgr/SoundMgr"),p=t("../../Bundle1_Loading/Scripts/Mgr/StorageMgr"),l=t("../../Bundle1_Loading/Scripts/Tool/Tool"),u=t("../../Bundle2_Res/Scripts/ResPanelOpen"),d=t("../../Bundle2_Res/Scripts/ResPrefabBorn"),g=cc._decorator,_=g.ccclass,y=g.property,v=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.graphics=null,e.startRig=null,e.endRope=null,e.Mask=null,e.ground=null,e.countDown=null,e.level=null,e.role=null,e.finger=null,e.body=null,e.sheep=null,e.obj=null,e.drawToCatchSheepMaxLevel=100,e._physicsMgr=cc.director.getPhysicsManager(),e._curLevel=1,e._totalLevel=100,e._lineLength=30,e._countDown=10,e._points=[],e._curLevelTips=[],e._ropeArr=[],e._sheepArr=[],e._objArr=[],e._canTouch=!1,e._heightDelta=0,e.isRight=!1,e.isEnd=!1,e.eps=1e-5,e.PI=Math.acos(-1),e}var i;return n(e,t),i=e,e.prototype.onLoad=function(){h.EventMgr.on(r.EventType.Game_Retry_Event,this.restart,this),h.EventMgr.on(r.EventType.Game_NextLevel_Event,this.nextLevel,this),h.EventMgr.on(r.EventType.Game_PassLevel_Event,this.passLevel,this),h.EventMgr.on(r.EventType.Game_ShowTips_Event,this.onBtnTips,this),h.EventMgr.on(r.EventType.Game_PowerLess_Event,this.showPowerLessUI,this),this._physicsMgr.enabled=!1,this._physicsMgr.enabled=!0;var t=cc.find("Canvas");this._heightDelta=t.height-1334,this.graphics.node.on(cc.Node.EventType.TOUCH_START,this.onTouchStart,this),this.graphics.node.on(cc.Node.EventType.TOUCH_MOVE,this.onTouchMove,this),this.graphics.node.on(cc.Node.EventType.TOUCH_END,this.onTouchEnd,this)},e.prototype.showPowerLessUI=function(){u.default.show_Game_PowerLess_Panel(cc.find("Canvas"))},e.prototype.start=function(){var t=p.default.instance.storageData.drawCatachSheepData;this._curLevel=t.maxLevel,p.default.instance.usePower(),this.initData(t.maxLevel)},e.prototype.nextLevel=function(){p.default.instance.usePower(),this.initData(this._curLevel)},e.prototype.addLevel=function(){p.default.instance.addLevel(r.GameNames.drawCatchSheep),this._curLevel=p.default.instance.storageData.drawCatachSheepData.maxLevel},e.prototype.restart=function(){this.isEnd||this.initData(this._curLevel)},e.prototype.onBtnTips=function(){this.isEnd||this.showTips()},e.prototype.passLevel=function(){this.isEnd||(p.default.instance.usePower(),this.addLevel(),this.initData(this._curLevel))},e.prototype.resetRightAndWrong=function(){this.wrong&&this.wrong.isValid&&this.wrong.destroy(),this.right&&this.right.isValid&&this.right.destroy(),this.isRight=!1},e.prototype.initData=function(t){var e=this;this.resetRightAndWrong(),this.isEnd=!1,this.level.string="\u7b2c"+t+"\u5173",this.onReset(),this.showFinger(!1),t>this.drawToCatchSheepMaxLevel&&(t=l.Tool.randomInt(1,this.drawToCatchSheepMaxLevel));var o=t;i.loadRes("Level/level"+o,cc.JsonAsset,function(t,i){if(!t)for(var o=0;o<i.json.data.length;o++){var n=i.json.data[o],s=null;switch(n.type){case 0:s=cc.instantiate(e.obj),e._objArr.push(s);break;case 1:s=cc.instantiate(e.sheep),e._sheepArr.push(s)}s.parent=e.ground,s.setPosition(30*n.line+s.width/2,30*n.row)}}),i.loadRes("Tips/Level"+o,cc.JsonAsset,function(t,i){if(t)console.log(t,"error");else{for(var o=0;o<i.json.length;o++){var n=i.json[o];e._curLevelTips.push(new cc.Vec2(n.x,n.y))}1==e._curLevel&&(e.showTips(),e.showFinger())}})},e.prototype.onReset=function(){this.unschedule(this.updateForce),this.unschedule(this.updateCountDown),this.startRig.linearVelocity=new cc.Vec2(0,0),this.endRope.getComponent(cc.RigidBody).linearVelocity=new cc.Vec2(0,0),this.role.playAnimation("People_Idle",0),this._canTouch=!0,this._countDown=10,this.countDown.node.active=!1,this.countDown.string=""+this._countDown,this.startRig.node.setPosition(-8,35),this.endRope.node.setPosition(8,35),this.graphics.node.destroyAllChildren(),this.ground.destroyAllChildren(),this._points=[],this._ropeArr=[],this._sheepArr=[],this._objArr=[],this._curLevelTips=[],this.graphics.clear()},e.prototype.onTouchStart=function(t){var e=t.getLocation();e.y-=this._heightDelta/2,e.y>=1050||!this._canTouch||(1==this._curLevel&&this.showFinger(!1),this.graphics.clear(),this.graphics.strokeColor=new cc.Color(0,0,0,255),this.graphics.moveTo(e.x,e.y),this.pushInPoints(e))},e.prototype.onTouchMove=function(t){if(!(this._points.length<=0)&&this._canTouch){var e=t.getLocation();e.y-=this._heightDelta/2,e.sub(this._points[this._points.length-1]).mag()>=this._lineLength&&this.checkRay(this._points[this._points.length-1].clone(),e.clone())&&(this.graphics.lineTo(e.x,e.y),this.graphics.stroke(),this.pushInPoints(e))}},e.prototype.onTouchEnd=function(){this._points.length<=1||!this._canTouch||(this.graphics.clear(),this.createPoint(),this.createRope(),this.shrinkRope())},e.prototype.createPoint=function(){for(var t=this.getVec2InMask(this.startRig.node),e=this._points[0].sub(new cc.Vec2(t.x,t.y)),i=e.negate(),o=e.mag(),n=Math.floor(o/this._lineLength),s=1;s<=n;s++)this.unshiftInPoints(new cc.Vec2(this._points[0].x+i.x/n,this._points[0].y+i.y/n));var r=this.getVec2InMask(this.endRope.node),c=this._points[this._points.length-1].sub(new cc.Vec2(r.x,r.y)),h=c.negate(),a=c.mag(),p=Math.floor(a/this._lineLength);for(s=1;s<=p;s++)this.pushInPoints(new cc.Vec2(this._points[this._points.length-1].x+h.x/p,this._points[this._points.length-1].y+h.y/p))},e.prototype.createRope=function(){for(var t=0;t<this._points.length;t++){var e=cc.instantiate(this.body);this.graphics.node.addChild(e),e.setPosition(this._points[t].x,this._points[t].y,0);var i=e.getComponent(cc.RevoluteJoint);i.connectedBody=0==t?this.startRig:this.graphics.node.children[this.graphics.node.childrenCount-2].getComponent(cc.RigidBody),i.anchor.x=-16,i.connectedAnchor.x=16,this._ropeArr.push(i)}this.endRope.connectedBody=this.graphics.node.children[this.graphics.node.childrenCount-1].getComponent(cc.RigidBody),this.endRope.apply()},e.prototype.shrinkRope=function(){this.startRig.applyForceToCenter(new cc.Vec2(0,2e4),!0),this.endRope.node.getComponent(cc.RigidBody).applyForceToCenter(new cc.Vec2(0,2e4),!0);var t=this.ground.convertToWorldSpaceAR(this.ground.children[0].position);new cc.Vec2(t.x,t.y),this.role.playAnimation("People_Work",0),this._canTouch=!1,this._countDown=this.checkIsWin()?10:5,this.countDown.string=""+this._countDown,this.countDown.node.active=!0,this.schedule(this.updateForce),this.schedule(this.updateCountDown,1)},e.prototype.updateForce=function(){var t=1500*cc.director.getDeltaTime()/.016;this.startRig.applyForceToCenter(new cc.Vec2(0,t),!0),this.endRope.node.getComponent(cc.RigidBody).applyForceToCenter(new cc.Vec2(0,t),!0);for(var e=0;e<this.graphics.node.childrenCount;e++){var i=this.graphics.node.children[e];i.y>=1e3?i.opacity=0:i.opacity=255}},e.prototype.updateCountDown=function(){var t=this;this._countDown--,this.countDown.string=""+this._countDown,this._countDown<=0&&(this.isEnd=!0,this.unschedule(this.updateCountDown),this.unschedule(this.updateForce),this.startRig.linearVelocity=new cc.Vec2(0,0),this.endRope.getComponent(cc.RigidBody).linearVelocity=new cc.Vec2(0,0),this.checkIsWin()?(this.role.playAnimation("People_Happy",0),this.addLevel(),a.default.instance.PlaySound(r.SoundType.Win),this.isRight||(this.isRight=!0,d.default.gameOverFxCreate(!0,cc.find("Canvas"))),this.scheduleOnce(function(){a.default.instance.PlaySound(r.SoundType.Win),t.right&&t.right.isValid&&t.right.destroy(),u.default.show_Result_Success_Panel(cc.find("Canvas"))},1.5)):(this.role.playAnimation("People_Angry",0),a.default.instance.PlaySound(r.SoundType.Lose),this.wrong&&this.wrong.isValid||d.default.gameOverFxCreate(!1,cc.find("Canvas")),this.scheduleOnce(function(){t.initData(t._curLevel)},1.5)))},e.prototype.checkIsWin=function(){for(var t=!0,e=0;e<this._sheepArr.length;e++){var i=this._sheepArr[e],o=i.parent.convertToWorldSpaceAR(i.position);this.inPolygon(o)?i.children[0].getComponent(dragonBones.ArmatureDisplay).playAnimation("Sheep_Walk",0):(i.children[0].color=new cc.Color(255,90,90,255),t=!1)}var n=!0;for(e=0;e<this._objArr.length;e++){var s=this._objArr[e];o=s.parent.convertToWorldSpaceAR(s.position),this.inPolygon(o)&&(s.color=new cc.Color(255,90,90,255),n=!1)}return t&&n},e.prototype.pushInPoints=function(t){t.x=Number(t.x.toFixed(2)),t.y=Number(t.y.toFixed(2)),this._points.push(t)},e.prototype.unshiftInPoints=function(t){t.x=Number(t.x.toFixed(2)),t.y=Number(t.y.toFixed(2)),this._points.unshift(t)},e.prototype.getVec2InMask=function(t){var e=t.parent.convertToWorldSpaceAR(t.position),i=this.Mask.convertToNodeSpaceAR(e);return new cc.Vec2(i.x,i.y)},e.prototype.checkRay=function(t,e){return t.y+=this._heightDelta/2,e.y+=this._heightDelta/2,0==this._physicsMgr.rayCast(t,e,cc.RayCastType.All).length},e.prototype.dcmp=function(t){return Math.abs(t)<this.eps?0:t<0?-1:1},e.prototype.onSegment=function(t,e,i){return this.dcmp(0==(e-t^i-t)&&this.dcmp((e-t)*(i-t))<=0)},e.prototype.inPolygon=function(t){for(var e,i,o=!1,n=0;n<this._ropeArr.length;n++)if(n<=this._ropeArr.length-2){if(e=new cc.Vec2(this._ropeArr[n].node.x,this._ropeArr[n].node.y+this._heightDelta/2),i=new cc.Vec2(this._ropeArr[n+1].node.x,this._ropeArr[n+1].node.y+this._heightDelta/2),this.onSegment(t,e,i))return!0;this.dcmp(e.y-t.y)>0!=this.dcmp(i.y-t.y)>0&&this.dcmp(t.x-(t.y-e.y)*(e.x-i.x)/(e.y-i.y)-e.x)<0&&(o=!o)}return o},e.prototype.showTips=function(){if(this._curLevelTips.length>0&&this._canTouch){this.graphics.strokeColor=new cc.Color(255,0,0,255);for(var t=0;t<this._curLevelTips.length;t++){var e=this._curLevelTips[t];0==t?this.graphics.moveTo(e.x,e.y):this.graphics.lineTo(e.x,e.y)}this.graphics.stroke()}},e.prototype.showFinger=function(t){void 0===t&&(t=!0),t?this._curLevelTips.length>0&&(this.finger.setPosition(this._curLevelTips[0].x,this._curLevelTips[0].y,0),this.runFinger()):cc.Tween.stopAllByTarget(this.finger),this.finger.active=t},e.prototype.runFinger=function(t,e){var i=this;if(void 0===t&&(t=1),void 0===e&&(e=.02),t==this._curLevelTips.length-1)return this.finger.setPosition(this._curLevelTips[0].x,this._curLevelTips[0].y,0),void this.runFinger(1,.02);var o=this._curLevelTips[t].sub(this._curLevelTips[t+1]).mag()/this._lineLength*.02;cc.tween(this.finger).to(e,{position:new cc.Vec3(this._curLevelTips[t].x,this._curLevelTips[t].y,0)}).call(function(){i.runFinger(t+1,o)}).start()},e.loadRes=function(t,e,i){c.default.loadDrawToCatchSheepRes(t,e,i)},e.prototype.update=function(){},s([y(cc.Graphics)],e.prototype,"graphics",void 0),s([y(cc.RigidBody)],e.prototype,"startRig",void 0),s([y(cc.RevoluteJoint)],e.prototype,"endRope",void 0),s([y(cc.Node)],e.prototype,"Mask",void 0),s([y(cc.Node)],e.prototype,"ground",void 0),s([y(cc.Label)],e.prototype,"countDown",void 0),s([y(cc.Label)],e.prototype,"level",void 0),s([y(dragonBones.ArmatureDisplay)],e.prototype,"role",void 0),s([y(cc.Node)],e.prototype,"finger",void 0),s([y(cc.Prefab)],e.prototype,"body",void 0),s([y(cc.Prefab)],e.prototype,"sheep",void 0),s([y(cc.Prefab)],e.prototype,"obj",void 0),i=s([_],e)}(cc.Component);i.default=v,cc._RF.pop()},{"../../Bundle1_Loading/Scripts/Config/EnumTypes":void 0,"../../Bundle1_Loading/Scripts/Mgr/AssetMgr":void 0,"../../Bundle1_Loading/Scripts/Mgr/EventMgr":void 0,"../../Bundle1_Loading/Scripts/Mgr/SoundMgr":void 0,"../../Bundle1_Loading/Scripts/Mgr/StorageMgr":void 0,"../../Bundle1_Loading/Scripts/Tool/Tool":void 0,"../../Bundle2_Res/Scripts/ResPanelOpen":void 0,"../../Bundle2_Res/Scripts/ResPrefabBorn":void 0}]},{},["DrawToCatchSheep_Game"]);